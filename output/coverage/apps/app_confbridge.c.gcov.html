<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Asterisk GIT-16-9767e98486 - apps/app_confbridge.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">apps</a> - app_confbridge.c<span style="font-size: 80%;"> (source / <a href="app_confbridge.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Asterisk GIT-16-9767e98486</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">995</td>
            <td class="headerCovTableEntry">1868</td>
            <td class="headerCovTableEntryLo">53.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-07-22 22:16:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">108</td>
            <td class="headerCovTableEntry">134</td>
            <td class="headerCovTableEntryMed">80.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Asterisk -- An open source telephony toolkit.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Copyright (C) 2007-2008, Digium, Inc.
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * Joshua Colp &lt;jcolp@digium.com&gt;
<span class="lineNum">       7 </span>            :  * David Vossel &lt;dvossel@digium.com&gt;
<span class="lineNum">       8 </span>            :  *
<span class="lineNum">       9 </span>            :  * See http://www.asterisk.org for more information about
<span class="lineNum">      10 </span>            :  * the Asterisk project. Please do not directly contact
<span class="lineNum">      11 </span>            :  * any of the maintainers of this project for assistance;
<span class="lineNum">      12 </span>            :  * the project provides a web site, mailing lists and IRC
<span class="lineNum">      13 </span>            :  * channels for your use.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  * This program is free software, distributed under the terms of
<span class="lineNum">      16 </span>            :  * the GNU General Public License Version 2. See the LICENSE file
<span class="lineNum">      17 </span>            :  * at the top of the source tree.
<span class="lineNum">      18 </span>            :  */
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : /*! \file
<span class="lineNum">      21 </span>            :  *
<span class="lineNum">      22 </span>            :  * \brief Conference Bridge application
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  * \author\verbatim Joshua Colp &lt;jcolp@digium.com&gt; \endverbatim
<span class="lineNum">      25 </span>            :  * \author\verbatim David Vossel &lt;dvossel@digium.com&gt; \endverbatim
<span class="lineNum">      26 </span>            :  *
<span class="lineNum">      27 </span>            :  * This is a conference bridge application utilizing the bridging core.
<span class="lineNum">      28 </span>            :  * \ingroup applications
<span class="lineNum">      29 </span>            :  */
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : /*! \li \ref app_confbridge.c uses the configuration file \ref confbridge.conf
<span class="lineNum">      32 </span>            :  * \addtogroup configuration_file Configuration Files
<span class="lineNum">      33 </span>            :  */
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : /*!
<span class="lineNum">      36 </span>            :  * \page confbridge.conf confbridge.conf
<span class="lineNum">      37 </span>            :  * \verbinclude confbridge.conf.sample
<span class="lineNum">      38 </span>            :  */
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : /*** MODULEINFO
<span class="lineNum">      41 </span>            :         &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      42 </span>            :  ***/
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : #include &quot;asterisk.h&quot;
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      48 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      49 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      50 </span>            : #include &lt;signal.h&gt;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : #include &quot;asterisk/cli.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;asterisk/file.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;asterisk/channel.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;asterisk/pbx.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;asterisk/pbx.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;asterisk/module.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;asterisk/lock.h&quot;
<span class="lineNum">      59 </span>            : #include &quot;asterisk/bridge.h&quot;
<span class="lineNum">      60 </span>            : #include &quot;asterisk/musiconhold.h&quot;
<span class="lineNum">      61 </span>            : #include &quot;asterisk/say.h&quot;
<span class="lineNum">      62 </span>            : #include &quot;asterisk/audiohook.h&quot;
<span class="lineNum">      63 </span>            : #include &quot;asterisk/astobj2.h&quot;
<span class="lineNum">      64 </span>            : #include &quot;confbridge/include/confbridge.h&quot;
<span class="lineNum">      65 </span>            : #include &quot;asterisk/paths.h&quot;
<span class="lineNum">      66 </span>            : #include &quot;asterisk/manager.h&quot;
<span class="lineNum">      67 </span>            : #include &quot;asterisk/test.h&quot;
<span class="lineNum">      68 </span>            : #include &quot;asterisk/stasis.h&quot;
<span class="lineNum">      69 </span>            : #include &quot;asterisk/stasis_bridges.h&quot;
<span class="lineNum">      70 </span>            : #include &quot;asterisk/stasis_channels.h&quot;
<span class="lineNum">      71 </span>            : #include &quot;asterisk/json.h&quot;
<span class="lineNum">      72 </span>            : #include &quot;asterisk/format_cache.h&quot;
<span class="lineNum">      73 </span>            : #include &quot;asterisk/taskprocessor.h&quot;
<span class="lineNum">      74 </span>            : #include &quot;asterisk/stream.h&quot;
<span class="lineNum">      75 </span>            : #include &quot;asterisk/message.h&quot;
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : /*** DOCUMENTATION
<span class="lineNum">      78 </span>            :         &lt;application name=&quot;ConfBridge&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">      79 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">      80 </span>            :                         Conference bridge application.
<span class="lineNum">      81 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">      82 </span>            :                 &lt;syntax&gt;
<span class="lineNum">      83 </span>            :                         &lt;parameter name=&quot;conference&quot; required=&quot;true&quot;&gt;
<span class="lineNum">      84 </span>            :                                 &lt;para&gt;Name of the conference bridge.  You are not limited to just
<span class="lineNum">      85 </span>            :                                 numbers.&lt;/para&gt;
<span class="lineNum">      86 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">      87 </span>            :                         &lt;parameter name=&quot;bridge_profile&quot;&gt;
<span class="lineNum">      88 </span>            :                                 &lt;para&gt;The bridge profile name from confbridge.conf.  When left blank,
<span class="lineNum">      89 </span>            :                                 a dynamically built bridge profile created by the CONFBRIDGE dialplan
<span class="lineNum">      90 </span>            :                                 function is searched for on the channel and used.  If no dynamic
<span class="lineNum">      91 </span>            :                                 profile is present, the 'default_bridge' profile found in
<span class="lineNum">      92 </span>            :                                 confbridge.conf is used. &lt;/para&gt;
<span class="lineNum">      93 </span>            :                                 &lt;para&gt;It is important to note that while user profiles may be unique
<span class="lineNum">      94 </span>            :                                 for each participant, mixing bridge profiles on a single conference
<span class="lineNum">      95 </span>            :                                 is _NOT_ recommended and will produce undefined results.&lt;/para&gt;
<span class="lineNum">      96 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">      97 </span>            :                         &lt;parameter name=&quot;user_profile&quot;&gt;
<span class="lineNum">      98 </span>            :                                 &lt;para&gt;The user profile name from confbridge.conf.  When left blank,
<span class="lineNum">      99 </span>            :                                 a dynamically built user profile created by the CONFBRIDGE dialplan
<span class="lineNum">     100 </span>            :                                 function is searched for on the channel and used.  If no dynamic
<span class="lineNum">     101 </span>            :                                 profile is present, the 'default_user' profile found in
<span class="lineNum">     102 </span>            :                                 confbridge.conf is used.&lt;/para&gt;
<span class="lineNum">     103 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     104 </span>            :                         &lt;parameter name=&quot;menu&quot;&gt;
<span class="lineNum">     105 </span>            :                                 &lt;para&gt;The name of the DTMF menu in confbridge.conf to be applied to
<span class="lineNum">     106 </span>            :                                 this channel.  When left blank, a dynamically built menu profile
<span class="lineNum">     107 </span>            :                                 created by the CONFBRIDGE dialplan function is searched for on
<span class="lineNum">     108 </span>            :                                 the channel and used. If no dynamic profile is present, the
<span class="lineNum">     109 </span>            :                                 'default_menu' profile found in confbridge.conf is used.&lt;/para&gt;
<span class="lineNum">     110 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     111 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     112 </span>            :                 &lt;description&gt;
<span class="lineNum">     113 </span>            :                         &lt;para&gt;Enters the user into a specified conference bridge.  The user can
<span class="lineNum">     114 </span>            :                         exit the conference by hangup or DTMF menu option.&lt;/para&gt;
<span class="lineNum">     115 </span>            :                         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;
<span class="lineNum">     116 </span>            :                         &lt;variablelist&gt;
<span class="lineNum">     117 </span>            :                                 &lt;variable name=&quot;CONFBRIDGE_RESULT&quot;&gt;
<span class="lineNum">     118 </span>            :                                         &lt;value name=&quot;FAILED&quot;&gt;The channel encountered an error and could not enter the conference.&lt;/value&gt;
<span class="lineNum">     119 </span>            :                                         &lt;value name=&quot;HANGUP&quot;&gt;The channel exited the conference by hanging up.&lt;/value&gt;
<span class="lineNum">     120 </span>            :                                         &lt;value name=&quot;KICKED&quot;&gt;The channel was kicked from the conference.&lt;/value&gt;
<span class="lineNum">     121 </span>            :                                         &lt;value name=&quot;ENDMARKED&quot;&gt;The channel left the conference as a result of the last marked user leaving.&lt;/value&gt;
<span class="lineNum">     122 </span>            :                                         &lt;value name=&quot;DTMF&quot;&gt;The channel pressed a DTMF sequence to exit the conference.&lt;/value&gt;
<span class="lineNum">     123 </span>            :                                         &lt;value name=&quot;TIMEOUT&quot;&gt;The channel reached its configured timeout.&lt;/value&gt;
<span class="lineNum">     124 </span>            :                                 &lt;/variable&gt;
<span class="lineNum">     125 </span>            :                         &lt;/variablelist&gt;
<span class="lineNum">     126 </span>            :                 &lt;/description&gt;
<span class="lineNum">     127 </span>            :                 &lt;see-also&gt;
<span class="lineNum">     128 </span>            :                         &lt;ref type=&quot;application&quot;&gt;ConfBridge&lt;/ref&gt;
<span class="lineNum">     129 </span>            :                         &lt;ref type=&quot;function&quot;&gt;CONFBRIDGE&lt;/ref&gt;
<span class="lineNum">     130 </span>            :                         &lt;ref type=&quot;function&quot;&gt;CONFBRIDGE_INFO&lt;/ref&gt;
<span class="lineNum">     131 </span>            :                 &lt;/see-also&gt;
<span class="lineNum">     132 </span>            :         &lt;/application&gt;
<span class="lineNum">     133 </span>            :         &lt;function name=&quot;CONFBRIDGE&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     134 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     135 </span>            :                         Set a custom dynamic bridge, user, or menu profile on a channel for the
<span class="lineNum">     136 </span>            :                         ConfBridge application using the same options available in confbridge.conf.
<span class="lineNum">     137 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     138 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     139 </span>            :                         &lt;parameter name=&quot;type&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     140 </span>            :                                 &lt;para&gt;To what type of conference profile the option applies.&lt;/para&gt;
<span class="lineNum">     141 </span>            :                                 &lt;enumlist&gt;
<span class="lineNum">     142 </span>            :                                         &lt;enum name=&quot;bridge&quot;&gt;&lt;/enum&gt;
<span class="lineNum">     143 </span>            :                                         &lt;enum name=&quot;menu&quot;&gt;&lt;/enum&gt;
<span class="lineNum">     144 </span>            :                                         &lt;enum name=&quot;user&quot;&gt;&lt;/enum&gt;
<span class="lineNum">     145 </span>            :                                 &lt;/enumlist&gt;
<span class="lineNum">     146 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     147 </span>            :                         &lt;parameter name=&quot;option&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     148 </span>            :                                 &lt;para&gt;Option refers to a &lt;filename&gt;confbridge.conf&lt;/filename&gt; option
<span class="lineNum">     149 </span>            :                                 that is being set dynamically on this channel, or &lt;literal&gt;clear&lt;/literal&gt;
<span class="lineNum">     150 </span>            :                                 to remove already applied profile options from the channel.&lt;/para&gt;
<span class="lineNum">     151 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     152 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     153 </span>            :                 &lt;description&gt;
<span class="lineNum">     154 </span>            :                         &lt;para&gt;A custom profile uses the default profile type settings defined in
<span class="lineNum">     155 </span>            :                         &lt;filename&gt;confbridge.conf&lt;/filename&gt; as defaults if the profile template
<span class="lineNum">     156 </span>            :                         is not explicitly specified first.&lt;/para&gt;
<span class="lineNum">     157 </span>            :                         &lt;para&gt;For &lt;literal&gt;bridge&lt;/literal&gt; profiles the default template is &lt;literal&gt;default_bridge&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     158 </span>            :                         &lt;para&gt;For &lt;literal&gt;menu&lt;/literal&gt; profiles the default template is &lt;literal&gt;default_menu&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     159 </span>            :                         &lt;para&gt;For &lt;literal&gt;user&lt;/literal&gt; profiles the default template is &lt;literal&gt;default_user&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     160 </span>            :                         &lt;para&gt;---- Example 1 ----&lt;/para&gt;
<span class="lineNum">     161 </span>            :                         &lt;para&gt;In this example the custom user profile set on the channel will
<span class="lineNum">     162 </span>            :                         automatically be used by the ConfBridge application.&lt;/para&gt;
<span class="lineNum">     163 </span>            :                         &lt;para&gt;exten =&gt; 1,1,Answer()&lt;/para&gt;
<span class="lineNum">     164 </span>            :                         &lt;para&gt;; In this example the effect of the following line is&lt;/para&gt;
<span class="lineNum">     165 </span>            :                         &lt;para&gt;; implied:&lt;/para&gt;
<span class="lineNum">     166 </span>            :                         &lt;para&gt;; same =&gt; n,Set(CONFBRIDGE(user,template)=default_user)&lt;/para&gt;
<span class="lineNum">     167 </span>            :                         &lt;para&gt;same =&gt; n,Set(CONFBRIDGE(user,announce_join_leave)=yes)&lt;/para&gt;
<span class="lineNum">     168 </span>            :                         &lt;para&gt;same =&gt; n,Set(CONFBRIDGE(user,startmuted)=yes)&lt;/para&gt;
<span class="lineNum">     169 </span>            :                         &lt;para&gt;same =&gt; n,ConfBridge(1) &lt;/para&gt;
<span class="lineNum">     170 </span>            :                         &lt;para&gt;---- Example 2 ----&lt;/para&gt;
<span class="lineNum">     171 </span>            :                         &lt;para&gt;This example shows how to use a predefined user profile in
<span class="lineNum">     172 </span>            :                         &lt;filename&gt;confbridge.conf&lt;/filename&gt; as a template for a dynamic profile.
<span class="lineNum">     173 </span>            :                         Here we make an admin/marked user out of the &lt;literal&gt;my_user&lt;/literal&gt;
<span class="lineNum">     174 </span>            :                         profile that you define in &lt;filename&gt;confbridge.conf&lt;/filename&gt;.&lt;/para&gt;
<span class="lineNum">     175 </span>            :                         &lt;para&gt;exten =&gt; 1,1,Answer()&lt;/para&gt;
<span class="lineNum">     176 </span>            :                         &lt;para&gt;same =&gt; n,Set(CONFBRIDGE(user,template)=my_user)&lt;/para&gt;
<span class="lineNum">     177 </span>            :                         &lt;para&gt;same =&gt; n,Set(CONFBRIDGE(user,admin)=yes)&lt;/para&gt;
<span class="lineNum">     178 </span>            :                         &lt;para&gt;same =&gt; n,Set(CONFBRIDGE(user,marked)=yes)&lt;/para&gt;
<span class="lineNum">     179 </span>            :                         &lt;para&gt;same =&gt; n,ConfBridge(1)&lt;/para&gt;
<span class="lineNum">     180 </span>            :                 &lt;/description&gt;
<span class="lineNum">     181 </span>            :         &lt;/function&gt;
<span class="lineNum">     182 </span>            :         &lt;function name=&quot;CONFBRIDGE_INFO&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     183 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     184 </span>            :                         Get information about a ConfBridge conference.
<span class="lineNum">     185 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     186 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     187 </span>            :                         &lt;parameter name=&quot;type&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     188 </span>            :                                 &lt;para&gt;What conference information is requested.&lt;/para&gt;
<span class="lineNum">     189 </span>            :                                 &lt;enumlist&gt;
<span class="lineNum">     190 </span>            :                                         &lt;enum name=&quot;admins&quot;&gt;
<span class="lineNum">     191 </span>            :                                                 &lt;para&gt;Get the number of admin users in the conference.&lt;/para&gt;
<span class="lineNum">     192 </span>            :                                         &lt;/enum&gt;
<span class="lineNum">     193 </span>            :                                         &lt;enum name=&quot;locked&quot;&gt;
<span class="lineNum">     194 </span>            :                                                 &lt;para&gt;Determine if the conference is locked. (0 or 1)&lt;/para&gt;
<span class="lineNum">     195 </span>            :                                         &lt;/enum&gt;
<span class="lineNum">     196 </span>            :                                         &lt;enum name=&quot;marked&quot;&gt;
<span class="lineNum">     197 </span>            :                                                 &lt;para&gt;Get the number of marked users in the conference.&lt;/para&gt;
<span class="lineNum">     198 </span>            :                                         &lt;/enum&gt;
<span class="lineNum">     199 </span>            :                                         &lt;enum name=&quot;muted&quot;&gt;
<span class="lineNum">     200 </span>            :                                                 &lt;para&gt;Determine if the conference is muted. (0 or 1)&lt;/para&gt;
<span class="lineNum">     201 </span>            :                                         &lt;/enum&gt;
<span class="lineNum">     202 </span>            :                                         &lt;enum name=&quot;parties&quot;&gt;
<span class="lineNum">     203 </span>            :                                                 &lt;para&gt;Get the number of users in the conference.&lt;/para&gt;
<span class="lineNum">     204 </span>            :                                         &lt;/enum&gt;
<span class="lineNum">     205 </span>            :                                 &lt;/enumlist&gt;
<span class="lineNum">     206 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     207 </span>            :                         &lt;parameter name=&quot;conf&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     208 </span>            :                                 &lt;para&gt;The name of the conference being referenced.&lt;/para&gt;
<span class="lineNum">     209 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     210 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     211 </span>            :                 &lt;description&gt;
<span class="lineNum">     212 </span>            :                         &lt;para&gt;This function returns a non-negative integer for valid conference
<span class="lineNum">     213 </span>            :                         names and an empty string for invalid conference names.&lt;/para&gt;
<span class="lineNum">     214 </span>            :                 &lt;/description&gt;
<span class="lineNum">     215 </span>            :         &lt;/function&gt;
<span class="lineNum">     216 </span>            :         &lt;manager name=&quot;ConfbridgeList&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     217 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     218 </span>            :                         List participants in a conference.
<span class="lineNum">     219 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     220 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     221 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     222 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     223 </span>            :                                 &lt;para&gt;Conference number.&lt;/para&gt;
<span class="lineNum">     224 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     225 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     226 </span>            :                 &lt;description&gt;
<span class="lineNum">     227 </span>            :                         &lt;para&gt;Lists all users in a particular ConfBridge conference.
<span class="lineNum">     228 </span>            :                         ConfbridgeList will follow as separate events, followed by a final event called
<span class="lineNum">     229 </span>            :                         ConfbridgeListComplete.&lt;/para&gt;
<span class="lineNum">     230 </span>            :                 &lt;/description&gt;
<span class="lineNum">     231 </span>            :         &lt;/manager&gt;
<span class="lineNum">     232 </span>            :         &lt;managerEvent language=&quot;en_US&quot; name=&quot;ConfbridgeList&quot;&gt;
<span class="lineNum">     233 </span>            :                 &lt;managerEventInstance class=&quot;EVENT_FLAG_REPORTING&quot;&gt;
<span class="lineNum">     234 </span>            :                         &lt;synopsis&gt;Raised as part of the ConfbridgeList action response list.&lt;/synopsis&gt;
<span class="lineNum">     235 </span>            :                         &lt;syntax&gt;
<span class="lineNum">     236 </span>            :                                 &lt;parameter name=&quot;Conference&quot;&gt;
<span class="lineNum">     237 </span>            :                                         &lt;para&gt;The name of the Confbridge conference.&lt;/para&gt;
<span class="lineNum">     238 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     239 </span>            :                                 &lt;parameter name=&quot;Admin&quot;&gt;
<span class="lineNum">     240 </span>            :                                         &lt;para&gt;Identifies this user as an admin user.&lt;/para&gt;
<span class="lineNum">     241 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     242 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     243 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     244 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     245 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     246 </span>            :                                 &lt;parameter name=&quot;MarkedUser&quot;&gt;
<span class="lineNum">     247 </span>            :                                         &lt;para&gt;Identifies this user as a marked user.&lt;/para&gt;
<span class="lineNum">     248 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     249 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     250 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     251 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     252 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     253 </span>            :                                 &lt;parameter name=&quot;WaitMarked&quot;&gt;
<span class="lineNum">     254 </span>            :                                         &lt;para&gt;Must this user wait for a marked user to join?&lt;/para&gt;
<span class="lineNum">     255 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     256 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     257 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     258 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     259 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     260 </span>            :                                 &lt;parameter name=&quot;EndMarked&quot;&gt;
<span class="lineNum">     261 </span>            :                                         &lt;para&gt;Does this user get kicked after the last marked user leaves?&lt;/para&gt;
<span class="lineNum">     262 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     263 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     264 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     265 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     266 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     267 </span>            :                                 &lt;parameter name=&quot;Waiting&quot;&gt;
<span class="lineNum">     268 </span>            :                                         &lt;para&gt;Is this user waiting for a marked user to join?&lt;/para&gt;
<span class="lineNum">     269 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     270 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     271 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     272 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     273 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     274 </span>            :                                 &lt;parameter name=&quot;Muted&quot;&gt;
<span class="lineNum">     275 </span>            :                                         &lt;para&gt;The current mute status.&lt;/para&gt;
<span class="lineNum">     276 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     277 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     278 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     279 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     280 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     281 </span>            :                                 &lt;parameter name=&quot;Talking&quot;&gt;
<span class="lineNum">     282 </span>            :                                         &lt;para&gt;Is this user talking?&lt;/para&gt;
<span class="lineNum">     283 </span>            :                                         &lt;enumlist&gt;
<span class="lineNum">     284 </span>            :                                                 &lt;enum name=&quot;Yes&quot;/&gt;
<span class="lineNum">     285 </span>            :                                                 &lt;enum name=&quot;No&quot;/&gt;
<span class="lineNum">     286 </span>            :                                         &lt;/enumlist&gt;
<span class="lineNum">     287 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     288 </span>            :                                 &lt;parameter name=&quot;AnsweredTime&quot;&gt;
<span class="lineNum">     289 </span>            :                                         &lt;para&gt;The number of seconds the channel has been up.&lt;/para&gt;
<span class="lineNum">     290 </span>            :                                 &lt;/parameter&gt;
<span class="lineNum">     291 </span>            :                                 &lt;channel_snapshot/&gt;
<span class="lineNum">     292 </span>            :                         &lt;/syntax&gt;
<span class="lineNum">     293 </span>            :                 &lt;/managerEventInstance&gt;
<span class="lineNum">     294 </span>            :         &lt;/managerEvent&gt;
<span class="lineNum">     295 </span>            :         &lt;manager name=&quot;ConfbridgeListRooms&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     296 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     297 </span>            :                         List active conferences.
<span class="lineNum">     298 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     299 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     300 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     301 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     302 </span>            :                 &lt;description&gt;
<span class="lineNum">     303 </span>            :                         &lt;para&gt;Lists data about all active conferences.
<span class="lineNum">     304 </span>            :                                 ConfbridgeListRooms will follow as separate events, followed by a final event called
<span class="lineNum">     305 </span>            :                                 ConfbridgeListRoomsComplete.&lt;/para&gt;
<span class="lineNum">     306 </span>            :                 &lt;/description&gt;
<span class="lineNum">     307 </span>            :         &lt;/manager&gt;
<span class="lineNum">     308 </span>            :         &lt;manager name=&quot;ConfbridgeMute&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     309 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     310 </span>            :                         Mute a Confbridge user.
<span class="lineNum">     311 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     312 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     313 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     314 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     315 </span>            :                         &lt;parameter name=&quot;Channel&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     316 </span>            :                                 &lt;para&gt;If this parameter is not a complete channel name, the first channel with this prefix will be used.&lt;/para&gt;
<span class="lineNum">     317 </span>            :                                 &lt;para&gt;If this parameter is &quot;all&quot;, all channels will be muted.&lt;/para&gt;
<span class="lineNum">     318 </span>            :                                 &lt;para&gt;If this parameter is &quot;participants&quot;, all non-admin channels will be muted.&lt;/para&gt;
<span class="lineNum">     319 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     320 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     321 </span>            :                 &lt;description&gt;
<span class="lineNum">     322 </span>            :                 &lt;/description&gt;
<span class="lineNum">     323 </span>            :         &lt;/manager&gt;
<span class="lineNum">     324 </span>            :         &lt;manager name=&quot;ConfbridgeUnmute&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     325 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     326 </span>            :                         Unmute a Confbridge user.
<span class="lineNum">     327 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     328 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     329 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     330 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     331 </span>            :                         &lt;parameter name=&quot;Channel&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     332 </span>            :                                 &lt;para&gt;If this parameter is not a complete channel name, the first channel with this prefix will be used.&lt;/para&gt;
<span class="lineNum">     333 </span>            :                                 &lt;para&gt;If this parameter is &quot;all&quot;, all channels will be unmuted.&lt;/para&gt;
<span class="lineNum">     334 </span>            :                                 &lt;para&gt;If this parameter is &quot;participants&quot;, all non-admin channels will be unmuted.&lt;/para&gt;
<span class="lineNum">     335 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     336 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     337 </span>            :                 &lt;description&gt;
<span class="lineNum">     338 </span>            :                 &lt;/description&gt;
<span class="lineNum">     339 </span>            :         &lt;/manager&gt;
<span class="lineNum">     340 </span>            :         &lt;manager name=&quot;ConfbridgeKick&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     341 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     342 </span>            :                         Kick a Confbridge user.
<span class="lineNum">     343 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     344 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     345 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     346 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     347 </span>            :                         &lt;parameter name=&quot;Channel&quot; required=&quot;true&quot; &gt;
<span class="lineNum">     348 </span>            :                                 &lt;para&gt;If this parameter is &quot;all&quot;, all channels will be kicked from the conference.&lt;/para&gt;
<span class="lineNum">     349 </span>            :                                 &lt;para&gt;If this parameter is &quot;participants&quot;, all non-admin channels will be kicked from the conference.&lt;/para&gt;
<span class="lineNum">     350 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     351 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     352 </span>            :                 &lt;description&gt;
<span class="lineNum">     353 </span>            :                 &lt;/description&gt;
<span class="lineNum">     354 </span>            :         &lt;/manager&gt;
<span class="lineNum">     355 </span>            :         &lt;manager name=&quot;ConfbridgeLock&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     356 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     357 </span>            :                         Lock a Confbridge conference.
<span class="lineNum">     358 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     359 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     360 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     361 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     362 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     363 </span>            :                 &lt;description&gt;
<span class="lineNum">     364 </span>            :                 &lt;/description&gt;
<span class="lineNum">     365 </span>            :         &lt;/manager&gt;
<span class="lineNum">     366 </span>            :         &lt;manager name=&quot;ConfbridgeUnlock&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     367 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     368 </span>            :                         Unlock a Confbridge conference.
<span class="lineNum">     369 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     370 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     371 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     372 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     373 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     374 </span>            :                 &lt;description&gt;
<span class="lineNum">     375 </span>            :                 &lt;/description&gt;
<span class="lineNum">     376 </span>            :         &lt;/manager&gt;
<span class="lineNum">     377 </span>            :         &lt;manager name=&quot;ConfbridgeStartRecord&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     378 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     379 </span>            :                         Start recording a Confbridge conference.
<span class="lineNum">     380 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     381 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     382 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     383 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     384 </span>            :                         &lt;parameter name=&quot;RecordFile&quot; required=&quot;false&quot; /&gt;
<span class="lineNum">     385 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     386 </span>            :                 &lt;description&gt;
<span class="lineNum">     387 </span>            :                         &lt;para&gt;Start recording a conference. If recording is already present an error will be returned. If RecordFile is not provided, the default record file specified in the conference's bridge profile will be used, if that is not present either a file will automatically be generated in the monitor directory.&lt;/para&gt;
<span class="lineNum">     388 </span>            :                 &lt;/description&gt;
<span class="lineNum">     389 </span>            :         &lt;/manager&gt;
<span class="lineNum">     390 </span>            :         &lt;manager name=&quot;ConfbridgeStopRecord&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     391 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     392 </span>            :                         Stop recording a Confbridge conference.
<span class="lineNum">     393 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     394 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     395 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     396 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     397 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     398 </span>            :                 &lt;description&gt;
<span class="lineNum">     399 </span>            :                 &lt;/description&gt;
<span class="lineNum">     400 </span>            :         &lt;/manager&gt;
<span class="lineNum">     401 </span>            :         &lt;manager name=&quot;ConfbridgeSetSingleVideoSrc&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     402 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     403 </span>            :                         Set a conference user as the single video source distributed to all other participants.
<span class="lineNum">     404 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     405 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     406 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     407 </span>            :                         &lt;parameter name=&quot;Conference&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     408 </span>            :                         &lt;parameter name=&quot;Channel&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     409 </span>            :                                 &lt;para&gt;If this parameter is not a complete channel name, the first channel with this prefix will be used.&lt;/para&gt;
<span class="lineNum">     410 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     411 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     412 </span>            :                 &lt;description&gt;
<span class="lineNum">     413 </span>            :                 &lt;/description&gt;
<span class="lineNum">     414 </span>            :         &lt;/manager&gt;
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            : ***/
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span>            : /*!
<span class="lineNum">     419 </span>            :  * \par Playing back a file to a channel in a conference
<span class="lineNum">     420 </span>            :  * You might notice in this application that while playing a sound file
<span class="lineNum">     421 </span>            :  * to a channel the actual conference bridge lock is not held. This is done so
<span class="lineNum">     422 </span>            :  * that other channels are not blocked from interacting with the conference bridge.
<span class="lineNum">     423 </span>            :  * Unfortunately because of this it is possible for things to change after the sound file
<span class="lineNum">     424 </span>            :  * is done being played. Data must therefore be checked after reacquiring the conference
<span class="lineNum">     425 </span>            :  * bridge lock if it is important.
<span class="lineNum">     426 </span>            :  */
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span>            : static const char app[] = &quot;ConfBridge&quot;;
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            : /*! Number of buckets our conference bridges container can have */
<span class="lineNum">     431 </span>            : #define CONFERENCE_BRIDGE_BUCKETS 53
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : /*! Initial recording filename space. */
<span class="lineNum">     434 </span>            : #define RECORD_FILENAME_INITIAL_SPACE   128
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            : /*! \brief Container to hold all conference bridges in progress */
<span class="lineNum">     437 </span>            : struct ao2_container *conference_bridges;
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span>            : static void leave_conference(struct confbridge_user *user);
<span class="lineNum">     440 </span>            : static int play_sound_number(struct confbridge_conference *conference, int say_number);
<span class="lineNum">     441 </span>            : static int execute_menu_entry(struct confbridge_conference *conference,
<span class="lineNum">     442 </span>            :         struct confbridge_user *user,
<span class="lineNum">     443 </span>            :         struct ast_bridge_channel *bridge_channel,
<span class="lineNum">     444 </span>            :         struct conf_menu_entry *menu_entry,
<span class="lineNum">     445 </span>            :         struct conf_menu *menu);
<a name="446"><span class="lineNum">     446 </span>            : </a>
<span class="lineNum">     447 </span>            : /*! \brief Hashing function used for conference bridges container */
<span class="lineNum">     448 </span><span class="lineCov">        384 : static int conference_bridge_hash_cb(const void *obj, const int flags)</span>
<span class="lineNum">     449 </span>            : {
<span class="lineNum">     450 </span><span class="lineCov">        384 :         const struct confbridge_conference *conference = obj;</span>
<span class="lineNum">     451 </span><span class="lineCov">        384 :         const char *name = obj;</span>
<span class="lineNum">     452 </span>            :         int hash;
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineCov">        384 :         switch (flags &amp; (OBJ_POINTER | OBJ_KEY | OBJ_PARTIAL_KEY)) {</span>
<span class="lineNum">     455 </span><span class="lineCov">         78 :         default:</span>
<span class="lineNum">     456 </span>            :         case OBJ_POINTER:
<span class="lineNum">     457 </span><span class="lineCov">         78 :                 name = conference-&gt;name;</span>
<span class="lineNum">     458 </span>            :                 /* Fall through */
<span class="lineNum">     459 </span><span class="lineCov">        384 :         case OBJ_KEY:</span>
<span class="lineNum">     460 </span><span class="lineCov">        384 :                 hash = ast_str_case_hash(name);</span>
<span class="lineNum">     461 </span><span class="lineCov">        384 :                 break;</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :         case OBJ_PARTIAL_KEY:</span>
<span class="lineNum">     463 </span>            :                 /* Should never happen in hash callback. */
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                 ast_assert(0);</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 hash = 0;</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     467 </span>            :         }
<span class="lineNum">     468 </span><span class="lineCov">        384 :         return hash;</span>
<span class="lineNum">     469 </span>            : }
<a name="470"><span class="lineNum">     470 </span>            : </a>
<span class="lineNum">     471 </span>            : /*! \brief Comparison function used for conference bridges container */
<span class="lineNum">     472 </span><span class="lineCov">        267 : static int conference_bridge_cmp_cb(void *obj, void *arg, int flags)</span>
<span class="lineNum">     473 </span>            : {
<span class="lineNum">     474 </span><span class="lineCov">        267 :         const struct confbridge_conference *left = obj;</span>
<span class="lineNum">     475 </span><span class="lineCov">        267 :         const struct confbridge_conference *right = arg;</span>
<span class="lineNum">     476 </span><span class="lineCov">        267 :         const char *right_name = arg;</span>
<span class="lineNum">     477 </span>            :         int cmp;
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineCov">        267 :         switch (flags &amp; (OBJ_POINTER | OBJ_KEY | OBJ_PARTIAL_KEY)) {</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">     481 </span>            :         case OBJ_POINTER:
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                 right_name = right-&gt;name;</span>
<span class="lineNum">     483 </span>            :                 /* Fall through */
<span class="lineNum">     484 </span><span class="lineCov">        267 :         case OBJ_KEY:</span>
<span class="lineNum">     485 </span><span class="lineCov">        267 :                 cmp = strcasecmp(left-&gt;name, right_name);</span>
<span class="lineNum">     486 </span><span class="lineCov">        267 :                 break;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         case OBJ_PARTIAL_KEY:</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                 cmp = strncasecmp(left-&gt;name, right_name, strlen(right_name));</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     490 </span>            :         }
<span class="lineNum">     491 </span><span class="lineCov">        267 :         return cmp ? 0 : CMP_MATCH;</span>
<a name="492"><span class="lineNum">     492 </span>            : }</a>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">        210 : const char *conf_get_sound(enum conf_sounds sound, struct bridge_profile_sounds *custom_sounds)</span>
<span class="lineNum">     495 </span>            : {
<span class="lineNum">     496 </span><span class="lineCov">        210 :         switch (sound) {</span>
<span class="lineNum">     497 </span><span class="lineCov">          2 :         case CONF_SOUND_HAS_JOINED:</span>
<span class="lineNum">     498 </span><span class="lineCov">          2 :                 return S_OR(custom_sounds-&gt;hasjoin, &quot;conf-hasjoin&quot;);</span>
<span class="lineNum">     499 </span><span class="lineCov">          2 :         case CONF_SOUND_HAS_LEFT:</span>
<span class="lineNum">     500 </span><span class="lineCov">          2 :                 return S_OR(custom_sounds-&gt;hasleft, &quot;conf-hasleft&quot;);</span>
<span class="lineNum">     501 </span><span class="lineCov">          8 :         case CONF_SOUND_KICKED:</span>
<span class="lineNum">     502 </span><span class="lineCov">          8 :                 return S_OR(custom_sounds-&gt;kicked, &quot;conf-kicked&quot;);</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :         case CONF_SOUND_MUTED:</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;muted, &quot;conf-muted&quot;);</span>
<span class="lineNum">     505 </span><span class="lineCov">          1 :         case CONF_SOUND_UNMUTED:</span>
<span class="lineNum">     506 </span><span class="lineCov">          1 :                 return S_OR(custom_sounds-&gt;unmuted, &quot;conf-unmuted&quot;);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :         case CONF_SOUND_BINAURAL_ON:</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;binauralon, &quot;confbridge-binaural-on&quot;);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :         case CONF_SOUND_BINAURAL_OFF:</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;binauraloff, &quot;confbridge-binaural-off&quot;);</span>
<span class="lineNum">     511 </span><span class="lineCov">          4 :         case CONF_SOUND_ONLY_ONE:</span>
<span class="lineNum">     512 </span><span class="lineCov">          4 :                 return S_OR(custom_sounds-&gt;onlyone, &quot;conf-onlyone&quot;);</span>
<span class="lineNum">     513 </span><span class="lineCov">          4 :         case CONF_SOUND_THERE_ARE:</span>
<span class="lineNum">     514 </span><span class="lineCov">          4 :                 return S_OR(custom_sounds-&gt;thereare, &quot;conf-thereare&quot;);</span>
<span class="lineNum">     515 </span><span class="lineCov">          4 :         case CONF_SOUND_OTHER_IN_PARTY:</span>
<span class="lineNum">     516 </span><span class="lineCov">          4 :                 return S_OR(custom_sounds-&gt;otherinparty, &quot;conf-otherinparty&quot;);</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :         case CONF_SOUND_PLACE_IN_CONF:</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;placeintoconf, &quot;conf-placeintoconf&quot;);</span>
<span class="lineNum">     519 </span><span class="lineCov">         14 :         case CONF_SOUND_WAIT_FOR_LEADER:</span>
<span class="lineNum">     520 </span><span class="lineCov">         14 :                 return S_OR(custom_sounds-&gt;waitforleader, &quot;conf-waitforleader&quot;);</span>
<span class="lineNum">     521 </span><span class="lineCov">         12 :         case CONF_SOUND_LEADER_HAS_LEFT:</span>
<span class="lineNum">     522 </span><span class="lineCov">         12 :                 return S_OR(custom_sounds-&gt;leaderhasleft, &quot;conf-leaderhasleft&quot;);</span>
<span class="lineNum">     523 </span><span class="lineCov">          2 :         case CONF_SOUND_GET_PIN:</span>
<span class="lineNum">     524 </span><span class="lineCov">          2 :                 return S_OR(custom_sounds-&gt;getpin, &quot;conf-getpin&quot;);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         case CONF_SOUND_INVALID_PIN:</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;invalidpin, &quot;conf-invalidpin&quot;);</span>
<span class="lineNum">     527 </span><span class="lineCov">         18 :         case CONF_SOUND_ONLY_PERSON:</span>
<span class="lineNum">     528 </span><span class="lineCov">         18 :                 return S_OR(custom_sounds-&gt;onlyperson, &quot;conf-onlyperson&quot;);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         case CONF_SOUND_LOCKED:</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;locked, &quot;conf-locked&quot;);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :         case CONF_SOUND_LOCKED_NOW:</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;lockednow, &quot;conf-lockednow&quot;);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         case CONF_SOUND_UNLOCKED_NOW:</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;unlockednow, &quot;conf-unlockednow&quot;);</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :         case CONF_SOUND_ERROR_MENU:</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;errormenu, &quot;conf-errormenu&quot;);</span>
<span class="lineNum">     537 </span><span class="lineCov">         66 :         case CONF_SOUND_JOIN:</span>
<span class="lineNum">     538 </span><span class="lineCov">         66 :                 return S_OR(custom_sounds-&gt;join, &quot;confbridge-join&quot;);</span>
<span class="lineNum">     539 </span><span class="lineCov">         66 :         case CONF_SOUND_LEAVE:</span>
<span class="lineNum">     540 </span><span class="lineCov">         66 :                 return S_OR(custom_sounds-&gt;leave, &quot;confbridge-leave&quot;);</span>
<span class="lineNum">     541 </span><span class="lineCov">          1 :         case CONF_SOUND_PARTICIPANTS_MUTED:</span>
<span class="lineNum">     542 </span><span class="lineCov">          1 :                 return S_OR(custom_sounds-&gt;participantsmuted, &quot;conf-now-muted&quot;);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         case CONF_SOUND_PARTICIPANTS_UNMUTED:</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 return S_OR(custom_sounds-&gt;participantsunmuted, &quot;conf-now-unmuted&quot;);</span>
<span class="lineNum">     545 </span><span class="lineCov">          6 :         case CONF_SOUND_BEGIN:</span>
<span class="lineNum">     546 </span><span class="lineCov">          6 :                 return S_OR(custom_sounds-&gt;begin, &quot;confbridge-conf-begin&quot;);</span>
<span class="lineNum">     547 </span>            :         }
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         return &quot;&quot;;</span>
<span class="lineNum">     550 </span>            : }
<a name="551"><span class="lineNum">     551 </span>            : </a>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span><span class="lineCov">        255 : static void send_conf_stasis(struct confbridge_conference *conference, struct ast_channel *chan,</span>
<a name="554"><span class="lineNum">     554 </span>            :         struct stasis_message_type *type, struct ast_json *extras, int channel_topic)</a>
<a name="555"><span class="lineNum">     555 </span>            : {</a>
<span class="lineNum">     556 </span><span class="lineCov">        510 :         RAII_VAR(struct stasis_message *, msg, NULL, ao2_cleanup);</span>
<span class="lineNum">     557 </span><span class="lineCov">        510 :         RAII_VAR(struct ast_json *, json_object, NULL, ast_json_unref);</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineCov">        510 :         json_object = ast_json_pack(&quot;{s: s}&quot;,</span>
<span class="lineNum">     560 </span><span class="lineCov">        255 :                 &quot;conference&quot;, conference-&gt;name);</span>
<span class="lineNum">     561 </span><span class="lineCov">        255 :         if (!json_object) {</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     563 </span>            :         }
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineCov">        255 :         if (extras) {</span>
<span class="lineNum">     566 </span><span class="lineCov">        171 :                 ast_json_object_update(json_object, extras);</span>
<span class="lineNum">     567 </span>            :         }
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineCov">        255 :         ast_bridge_lock(conference-&gt;bridge);</span>
<span class="lineNum">     570 </span><span class="lineCov">        255 :         msg = ast_bridge_blob_create(type,</span>
<span class="lineNum">     571 </span>            :                 conference-&gt;bridge,
<span class="lineNum">     572 </span>            :                 chan,
<span class="lineNum">     573 </span>            :                 json_object);
<span class="lineNum">     574 </span><span class="lineCov">        255 :         ast_bridge_unlock(conference-&gt;bridge);</span>
<span class="lineNum">     575 </span><span class="lineCov">        255 :         if (!msg) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     577 </span>            :         }
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineCov">        255 :         if (channel_topic) {</span>
<span class="lineNum">     580 </span><span class="lineCov">          1 :                 stasis_publish(ast_channel_topic(chan), msg);</span>
<span class="lineNum">     581 </span>            :         } else {
<span class="lineNum">     582 </span><span class="lineCov">        254 :                 stasis_publish(ast_bridge_topic(conference-&gt;bridge), msg);</span>
<span class="lineNum">     583 </span>            :         }
<a name="584"><span class="lineNum">     584 </span>            : }</a>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineCov">         39 : static void send_conf_start_event(struct confbridge_conference *conference)</span>
<span class="lineNum">     587 </span>            : {
<span class="lineNum">     588 </span><span class="lineCov">         39 :         send_conf_stasis(conference, NULL, confbridge_start_type(), NULL, 0);</span>
<a name="589"><span class="lineNum">     589 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span><span class="lineCov">         39 : static void send_conf_end_event(struct confbridge_conference *conference)</span>
<span class="lineNum">     592 </span>            : {
<span class="lineNum">     593 </span><span class="lineCov">         39 :         send_conf_stasis(conference, NULL, confbridge_end_type(), NULL, 0);</span>
<a name="594"><span class="lineNum">     594 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span><span class="lineCov">         82 : static void send_join_event(struct confbridge_user *user, struct confbridge_conference *conference)</span>
<span class="lineNum">     597 </span>            : {
<span class="lineNum">     598 </span>            :         struct ast_json *json_object;
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineCov">        164 :         json_object = ast_json_pack(&quot;{s: b, s: b}&quot;,</span>
<span class="lineNum">     601 </span><span class="lineCov">         82 :                 &quot;admin&quot;, ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN),</span>
<span class="lineNum">     602 </span><span class="lineCov">         82 :                 &quot;muted&quot;, user-&gt;muted);</span>
<span class="lineNum">     603 </span><span class="lineCov">         82 :         if (!json_object) {</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     605 </span>            :         }
<span class="lineNum">     606 </span><span class="lineCov">         82 :         send_conf_stasis(conference, user-&gt;chan, confbridge_join_type(), json_object, 0);</span>
<span class="lineNum">     607 </span><span class="lineCov">         82 :         ast_json_unref(json_object);</span>
<a name="608"><span class="lineNum">     608 </span>            : }</a>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineCov">         82 : static void send_leave_event(struct confbridge_user *user, struct confbridge_conference *conference)</span>
<span class="lineNum">     611 </span>            : {
<span class="lineNum">     612 </span>            :         struct ast_json *json_object;
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">         82 :         json_object = ast_json_pack(&quot;{s: b}&quot;,</span>
<span class="lineNum">     615 </span><span class="lineCov">         82 :                 &quot;admin&quot;, ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)</span>
<span class="lineNum">     616 </span>            :         );
<span class="lineNum">     617 </span><span class="lineCov">         82 :         if (!json_object) {</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     619 </span>            :         }
<span class="lineNum">     620 </span><span class="lineCov">         82 :         send_conf_stasis(conference, user-&gt;chan, confbridge_leave_type(), json_object, 0);</span>
<span class="lineNum">     621 </span><span class="lineCov">         82 :         ast_json_unref(json_object);</span>
<a name="622"><span class="lineNum">     622 </span>            : }</a>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">          3 : static void send_start_record_event(struct confbridge_conference *conference)</span>
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span><span class="lineCov">          3 :         send_conf_stasis(conference, NULL, confbridge_start_record_type(), NULL, 0);</span>
<a name="627"><span class="lineNum">     627 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineCov">          3 : static void send_stop_record_event(struct confbridge_conference *conference)</span>
<span class="lineNum">     630 </span>            : {
<span class="lineNum">     631 </span><span class="lineCov">          3 :         send_conf_stasis(conference, NULL, confbridge_stop_record_type(), NULL, 0);</span>
<a name="632"><span class="lineNum">     632 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineNoCov">          0 : static void send_mute_event(struct confbridge_user *user, struct confbridge_conference *conference)</span>
<span class="lineNum">     635 </span>            : {
<span class="lineNum">     636 </span>            :         struct ast_json *json_object;
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :         json_object = ast_json_pack(&quot;{s: b}&quot;,</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :                 &quot;admin&quot;, ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)</span>
<span class="lineNum">     640 </span>            :         );
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         if (!json_object) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     643 </span>            :         }
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         send_conf_stasis(conference, user-&gt;chan, confbridge_mute_type(), json_object, 1);</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         ast_json_unref(json_object);</span>
<a name="646"><span class="lineNum">     646 </span>            : }</a>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineCov">          1 : static void send_unmute_event(struct confbridge_user *user, struct confbridge_conference *conference)</span>
<span class="lineNum">     649 </span>            : {
<span class="lineNum">     650 </span>            :         struct ast_json *json_object;
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">          1 :         json_object = ast_json_pack(&quot;{s: b}&quot;,</span>
<span class="lineNum">     653 </span><span class="lineCov">          1 :                 &quot;admin&quot;, ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)</span>
<span class="lineNum">     654 </span>            :         );
<span class="lineNum">     655 </span><span class="lineCov">          1 :         if (!json_object) {</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     657 </span>            :         }
<span class="lineNum">     658 </span><span class="lineCov">          1 :         send_conf_stasis(conference, user-&gt;chan, confbridge_unmute_type(), json_object, 1);</span>
<span class="lineNum">     659 </span><span class="lineCov">          1 :         ast_json_unref(json_object);</span>
<a name="660"><span class="lineNum">     660 </span>            : }</a>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineCov">          3 : static void set_rec_filename(struct confbridge_conference *conference, struct ast_str **filename, int is_new)</span>
<span class="lineNum">     663 </span>            : {
<span class="lineNum">     664 </span><span class="lineCov">          3 :         char *rec_file = conference-&gt;b_profile.rec_file;</span>
<span class="lineNum">     665 </span>            :         char *ext;
<span class="lineNum">     666 </span>            :         time_t now;
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineCov">          3 :         if (ast_str_strlen(*filename)</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                 &amp;&amp; ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_RECORD_FILE_APPEND)</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                 &amp;&amp; !is_new) {</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     672 </span>            :         }
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span><span class="lineCov">          3 :         time(&amp;now);</span>
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span><span class="lineCov">          3 :         ast_str_reset(*filename);</span>
<span class="lineNum">     677 </span><span class="lineCov">          3 :         if (ast_strlen_zero(rec_file)) {</span>
<span class="lineNum">     678 </span><span class="lineCov">          1 :                 ast_str_set(filename, 0, &quot;confbridge-%s-%u.wav&quot;, conference-&gt;name,</span>
<span class="lineNum">     679 </span>            :                         (unsigned int) now);
<span class="lineNum">     680 </span><span class="lineCov">          2 :         } else if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_RECORD_FILE_TIMESTAMP)) {</span>
<span class="lineNum">     681 </span>            :                 /* insert time before file extension */
<span class="lineNum">     682 </span><span class="lineCov">          2 :                 ext = strrchr(rec_file, '.');</span>
<span class="lineNum">     683 </span><span class="lineCov">          2 :                 if (ext) {</span>
<span class="lineNum">     684 </span><span class="lineCov">          2 :                         ast_str_set_substr(filename, 0, rec_file, ext - rec_file);</span>
<span class="lineNum">     685 </span><span class="lineCov">          2 :                         ast_str_append(filename, 0, &quot;-%u%s&quot;, (unsigned int) now, ext);</span>
<span class="lineNum">     686 </span>            :                 } else {
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                         ast_str_set(filename, 0, &quot;%s-%u&quot;, rec_file, (unsigned int) now);</span>
<span class="lineNum">     688 </span>            :                 }
<span class="lineNum">     689 </span>            :         } else {
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                 ast_str_set(filename, 0, &quot;%s&quot;, rec_file);</span>
<span class="lineNum">     691 </span>            :         }
<span class="lineNum">     692 </span><span class="lineCov">          3 :         ast_str_append(filename, 0, &quot;,%s%s,%s&quot;,</span>
<span class="lineNum">     693 </span><span class="lineCov">          3 :                 ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_RECORD_FILE_APPEND) ? &quot;a&quot; : &quot;&quot;,</span>
<span class="lineNum">     694 </span><span class="lineCov">          3 :                 conference-&gt;b_profile.rec_options,</span>
<span class="lineNum">     695 </span><span class="lineCov">          3 :                 conference-&gt;b_profile.rec_command);</span>
<a name="696"><span class="lineNum">     696 </span>            : }</a>
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">          3 : static int is_new_rec_file(const char *rec_file, struct ast_str **orig_rec_file)</span>
<span class="lineNum">     699 </span>            : {
<span class="lineNum">     700 </span><span class="lineCov">          3 :         if (!ast_strlen_zero(rec_file)) {</span>
<span class="lineNum">     701 </span><span class="lineCov">          2 :                 if (!*orig_rec_file) {</span>
<span class="lineNum">     702 </span><span class="lineCov">          2 :                         *orig_rec_file = ast_str_create(RECORD_FILENAME_INITIAL_SPACE);</span>
<span class="lineNum">     703 </span>            :                 }
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">          2 :                 if (*orig_rec_file</span>
<span class="lineNum">     706 </span><span class="lineCov">          2 :                         &amp;&amp; strcmp(ast_str_buffer(*orig_rec_file), rec_file)) {</span>
<span class="lineNum">     707 </span><span class="lineCov">          2 :                         ast_str_set(orig_rec_file, 0, &quot;%s&quot;, rec_file);</span>
<span class="lineNum">     708 </span><span class="lineCov">          2 :                         return 1;</span>
<span class="lineNum">     709 </span>            :                 }
<span class="lineNum">     710 </span>            :         }
<span class="lineNum">     711 </span><span class="lineCov">          1 :         return 0;</span>
<a name="712"><span class="lineNum">     712 </span>            : }</a>
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineCov">        171 : struct confbridge_conference *conf_find_bridge(const char *conference_name)</span>
<span class="lineNum">     715 </span>            : {
<span class="lineNum">     716 </span><span class="lineCov">        171 :         return ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">     717 </span>            : }
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span>            : /*!
<span class="lineNum">     720 </span>            :  * \internal
<span class="lineNum">     721 </span>            :  * \brief Returns whether or not conference is being recorded.
<span class="lineNum">     722 </span>            :  *
<span class="lineNum">     723 </span>            :  * \param conference The bridge to check for recording
<span class="lineNum">     724 </span>            :  *
<span class="lineNum">     725 </span>            :  * \note Must be called with the conference locked
<span class="lineNum">     726 </span>            :  *
<span class="lineNum">     727 </span>            :  * \retval 1, conference is recording.
<a name="728"><span class="lineNum">     728 </span>            :  * \retval 0, conference is NOT recording.</a>
<span class="lineNum">     729 </span>            :  */
<span class="lineNum">     730 </span><span class="lineCov">         42 : static int conf_is_recording(struct confbridge_conference *conference)</span>
<span class="lineNum">     731 </span>            : {
<span class="lineNum">     732 </span><span class="lineCov">         42 :         return conference-&gt;record_chan != NULL;</span>
<span class="lineNum">     733 </span>            : }
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span>            : /*!
<span class="lineNum">     736 </span>            :  * \internal
<span class="lineNum">     737 </span>            :  * \brief Stop recording a conference bridge
<span class="lineNum">     738 </span>            :  *
<span class="lineNum">     739 </span>            :  * \param conference The conference bridge on which to stop the recording
<span class="lineNum">     740 </span>            :  *
<span class="lineNum">     741 </span>            :  * \note Must be called with the conference locked
<span class="lineNum">     742 </span>            :  *
<span class="lineNum">     743 </span>            :  * \retval -1 Failure
<a name="744"><span class="lineNum">     744 </span>            :  * \retval 0 Success</a>
<span class="lineNum">     745 </span>            :  */
<span class="lineNum">     746 </span><span class="lineCov">         39 : static int conf_stop_record(struct confbridge_conference *conference)</span>
<span class="lineNum">     747 </span>            : {
<span class="lineNum">     748 </span>            :         struct ast_channel *chan;
<span class="lineNum">     749 </span><span class="lineCov">         39 :         struct ast_frame f = { AST_FRAME_CONTROL, .subclass.integer = AST_CONTROL_HANGUP };</span>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineCov">         39 :         if (!conf_is_recording(conference)) {</span>
<span class="lineNum">     752 </span><span class="lineCov">         36 :                 return -1;</span>
<span class="lineNum">     753 </span>            :         }
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span>            :         /* Remove the recording channel from the conference bridge. */
<span class="lineNum">     756 </span><span class="lineCov">          3 :         chan = conference-&gt;record_chan;</span>
<span class="lineNum">     757 </span><span class="lineCov">          3 :         conference-&gt;record_chan = NULL;</span>
<span class="lineNum">     758 </span><span class="lineCov">          3 :         ast_queue_frame(chan, &amp;f);</span>
<span class="lineNum">     759 </span><span class="lineCov">          3 :         ast_channel_unref(chan);</span>
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineCov">          3 :         ast_test_suite_event_notify(&quot;CONF_STOP_RECORD&quot;, &quot;Message: stopped conference recording channel\r\nConference: %s&quot;, conference-&gt;b_profile.name);</span>
<span class="lineNum">     762 </span><span class="lineCov">          3 :         send_stop_record_event(conference);</span>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">          3 :         return 0;</span>
<span class="lineNum">     765 </span>            : }
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            : /*!
<span class="lineNum">     768 </span>            :  * \internal
<span class="lineNum">     769 </span>            :  * \brief Start recording the conference
<span class="lineNum">     770 </span>            :  *
<span class="lineNum">     771 </span>            :  * \param conference The conference bridge to start recording
<span class="lineNum">     772 </span>            :  *
<span class="lineNum">     773 </span>            :  * \note Must be called with the conference locked
<span class="lineNum">     774 </span>            :  *
<span class="lineNum">     775 </span>            :  * \retval 0 success
<a name="776"><span class="lineNum">     776 </span>            :  * \retval non-zero failure</a>
<span class="lineNum">     777 </span>            :  */
<span class="lineNum">     778 </span><span class="lineCov">          3 : static int conf_start_record(struct confbridge_conference *conference)</span>
<span class="lineNum">     779 </span>            : {
<span class="lineNum">     780 </span>            :         struct ast_app *mixmonapp;
<span class="lineNum">     781 </span>            :         struct ast_channel *chan;
<span class="lineNum">     782 </span>            :         struct ast_format_cap *cap;
<span class="lineNum">     783 </span>            :         struct ast_bridge_features *features;
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">          3 :         if (conf_is_recording(conference)) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     787 </span>            :         }
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineCov">          3 :         mixmonapp = pbx_findapp(&quot;MixMonitor&quot;);</span>
<span class="lineNum">     790 </span><span class="lineCov">          3 :         if (!mixmonapp) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Cannot record ConfBridge, MixMonitor app is not installed\n&quot;);</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     793 </span>            :         }
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineCov">          3 :         features = ast_bridge_features_new();</span>
<span class="lineNum">     796 </span><span class="lineCov">          3 :         if (!features) {</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     798 </span>            :         }
<span class="lineNum">     799 </span><span class="lineCov">          3 :         ast_set_flag(&amp;features-&gt;feature_flags, AST_BRIDGE_CHANNEL_FLAG_IMMOVABLE);</span>
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineCov">          3 :         cap = ast_format_cap_alloc(AST_FORMAT_CAP_FLAG_DEFAULT);</span>
<span class="lineNum">     802 </span><span class="lineCov">          3 :         if (!cap) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                 ast_bridge_features_destroy(features);</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     805 </span>            :         }
<span class="lineNum">     806 </span><span class="lineCov">          3 :         ast_format_cap_append(cap, ast_format_slin, 0);</span>
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :         /* Create the recording channel. */
<span class="lineNum">     809 </span><span class="lineCov">          3 :         chan = ast_request(&quot;CBRec&quot;, cap, NULL, NULL, conference-&gt;name, NULL);</span>
<span class="lineNum">     810 </span><span class="lineCov">          3 :         ao2_ref(cap, -1);</span>
<span class="lineNum">     811 </span><span class="lineCov">          3 :         if (!chan) {</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                 ast_bridge_features_destroy(features);</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     814 </span>            :         }
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span>            :         /* Start recording. */
<span class="lineNum">     817 </span><span class="lineCov">          3 :         set_rec_filename(conference, &amp;conference-&gt;record_filename,</span>
<span class="lineNum">     818 </span><span class="lineCov">          3 :                 is_new_rec_file(conference-&gt;b_profile.rec_file, &amp;conference-&gt;orig_rec_file));</span>
<span class="lineNum">     819 </span><span class="lineCov">          3 :         ast_answer(chan);</span>
<span class="lineNum">     820 </span><span class="lineCov">          3 :         pbx_exec(chan, mixmonapp, ast_str_buffer(conference-&gt;record_filename));</span>
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span>            :         /* Put the channel into the conference bridge. */
<span class="lineNum">     823 </span><span class="lineCov">          3 :         ast_channel_ref(chan);</span>
<span class="lineNum">     824 </span><span class="lineCov">          3 :         conference-&gt;record_chan = chan;</span>
<span class="lineNum">     825 </span><span class="lineCov">          3 :         if (ast_bridge_impart(conference-&gt;bridge, chan, NULL, features,</span>
<span class="lineNum">     826 </span>            :                 AST_BRIDGE_IMPART_CHAN_INDEPENDENT)) {
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                 ast_hangup(chan);</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                 ast_channel_unref(chan);</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                 conference-&gt;record_chan = NULL;</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     831 </span>            :         }
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span><span class="lineCov">          3 :         ast_test_suite_event_notify(&quot;CONF_START_RECORD&quot;, &quot;Message: started conference recording channel\r\nConference: %s&quot;, conference-&gt;b_profile.name);</span>
<span class="lineNum">     834 </span><span class="lineCov">          3 :         send_start_record_event(conference);</span>
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span><span class="lineCov">          3 :         return 0;</span>
<span class="lineNum">     837 </span>            : }
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span>            : /* \brief Playback the given filename and monitor for any dtmf interrupts.
<span class="lineNum">     840 </span>            :  *
<span class="lineNum">     841 </span>            :  * This function is used to playback sound files on a given channel and optionally
<span class="lineNum">     842 </span>            :  * allow dtmf interrupts to occur.
<span class="lineNum">     843 </span>            :  *
<span class="lineNum">     844 </span>            :  * If the optional bridge_channel parameter is given then sound file playback
<span class="lineNum">     845 </span>            :  * is played on that channel and dtmf interruptions are allowed. However, if
<span class="lineNum">     846 </span>            :  * bridge_channel is not set then the channel parameter is expected to be set
<span class="lineNum">     847 </span>            :  * instead and non interruptible playback is played on that channel.
<span class="lineNum">     848 </span>            :  *
<span class="lineNum">     849 </span>            :  * \param bridge_channel Bridge channel to play file on
<span class="lineNum">     850 </span>            :  * \param channel Optional channel to play file on if bridge_channel not given
<span class="lineNum">     851 </span>            :  * \param filename The file name to playback
<span class="lineNum">     852 </span>            :  *
<a name="853"><span class="lineNum">     853 </span>            :  * \retval -1 failure during playback, 0 on file was fully played, 1 on dtmf interrupt.</a>
<span class="lineNum">     854 </span>            :  */
<span class="lineNum">     855 </span><span class="lineCov">          3 : static int play_file(struct ast_bridge_channel *bridge_channel, struct ast_channel *channel,</span>
<span class="lineNum">     856 </span>            :                      const char *filename)
<span class="lineNum">     857 </span>            : {
<span class="lineNum">     858 </span>            :         struct ast_channel *chan;
<span class="lineNum">     859 </span>            :         const char *stop_digits;
<span class="lineNum">     860 </span>            :         int digit;
<span class="lineNum">     861 </span>            : 
<span class="lineNum">     862 </span><span class="lineCov">          3 :         if (bridge_channel) {</span>
<span class="lineNum">     863 </span><span class="lineCov">          1 :                 chan = bridge_channel-&gt;chan;</span>
<span class="lineNum">     864 </span><span class="lineCov">          1 :                 stop_digits = AST_DIGIT_ANY;</span>
<span class="lineNum">     865 </span>            :         } else {
<span class="lineNum">     866 </span><span class="lineCov">          2 :                 chan = channel;</span>
<span class="lineNum">     867 </span><span class="lineCov">          2 :                 stop_digits = AST_DIGIT_NONE;</span>
<span class="lineNum">     868 </span>            :         }
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineCov">          3 :         digit = ast_stream_and_wait(chan, filename, stop_digits);</span>
<span class="lineNum">     871 </span><span class="lineCov">          3 :         if (digit &lt; 0) {</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Failed to playback file '%s' to channel\n&quot;, filename);</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     874 </span>            :         }
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span><span class="lineCov">          3 :         if (digit &gt; 0) {</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :                 ast_stopstream(bridge_channel-&gt;chan);</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :                 ast_bridge_channel_feature_digit_add(bridge_channel, digit);</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     880 </span>            :         }
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineCov">          3 :         return 0;</span>
<span class="lineNum">     883 </span>            : }
<span class="lineNum">     884 </span>            : 
<span class="lineNum">     885 </span>            : /*!
<span class="lineNum">     886 </span>            :  * \internal
<span class="lineNum">     887 </span>            :  * \brief Complain if the given sound file does not exist.
<span class="lineNum">     888 </span>            :  *
<span class="lineNum">     889 </span>            :  * \param filename Sound file to check if exists.
<span class="lineNum">     890 </span>            :  *
<a name="891"><span class="lineNum">     891 </span>            :  * \retval non-zero if the file exists.</a>
<span class="lineNum">     892 </span>            :  */
<span class="lineNum">     893 </span><span class="lineCov">        169 : static int sound_file_exists(const char *filename)</span>
<span class="lineNum">     894 </span>            : {
<span class="lineNum">     895 </span><span class="lineCov">        169 :         if (ast_fileexists(filename, NULL, NULL)) {</span>
<span class="lineNum">     896 </span><span class="lineCov">        169 :                 return -1;</span>
<span class="lineNum">     897 </span>            :         }
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :         ast_log(LOG_WARNING, &quot;File %s does not exist in any format\n&quot;, filename);</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     900 </span>            : }
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span>            : /*!
<span class="lineNum">     903 </span>            :  * \brief Announce number of users in the conference bridge to the caller
<span class="lineNum">     904 </span>            :  *
<span class="lineNum">     905 </span>            :  * \param conference Conference bridge to peek at
<span class="lineNum">     906 </span>            :  * \param user Optional Caller
<span class="lineNum">     907 </span>            :  * \param bridge_channel The bridged channel involved
<span class="lineNum">     908 </span>            :  *
<span class="lineNum">     909 </span>            :  * \note if caller is NULL, the announcment will be sent to all participants in the conference.
<a name="910"><span class="lineNum">     910 </span>            :  * \return Returns 0 on success, -1 if the user hung up</a>
<span class="lineNum">     911 </span>            :  */
<span class="lineNum">     912 </span><span class="lineCov">          4 : static int announce_user_count(struct confbridge_conference *conference, struct confbridge_user *user,</span>
<span class="lineNum">     913 </span>            :                                struct ast_bridge_channel *bridge_channel)
<span class="lineNum">     914 </span>            : {
<span class="lineNum">     915 </span><span class="lineCov">          4 :         const char *other_in_party = conf_get_sound(CONF_SOUND_OTHER_IN_PARTY, conference-&gt;b_profile.sounds);</span>
<span class="lineNum">     916 </span><span class="lineCov">          4 :         const char *only_one = conf_get_sound(CONF_SOUND_ONLY_ONE, conference-&gt;b_profile.sounds);</span>
<span class="lineNum">     917 </span><span class="lineCov">          4 :         const char *there_are = conf_get_sound(CONF_SOUND_THERE_ARE, conference-&gt;b_profile.sounds);</span>
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span><span class="lineCov">          4 :         if (conference-&gt;activeusers &lt;= 1) {</span>
<span class="lineNum">     920 </span>            :                 /* Awww we are the only person in the conference bridge OR we only have waitmarked users */
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     922 </span><span class="lineCov">          4 :         } else if (conference-&gt;activeusers == 2) {</span>
<span class="lineNum">     923 </span><span class="lineCov">          1 :                 if (user) {</span>
<span class="lineNum">     924 </span>            :                         /* Eep, there is one other person */
<span class="lineNum">     925 </span><span class="lineCov">          1 :                         if (play_file(bridge_channel, user-&gt;chan, only_one) &lt; 0) {</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">     927 </span>            :                         }
<span class="lineNum">     928 </span>            :                 } else {
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :                         play_sound_file(conference, only_one);</span>
<span class="lineNum">     930 </span>            :                 }
<span class="lineNum">     931 </span>            :         } else {
<span class="lineNum">     932 </span>            :                 /* Alas multiple others in here */
<span class="lineNum">     933 </span><span class="lineCov">          3 :                 if (user) {</span>
<span class="lineNum">     934 </span><span class="lineCov">          1 :                         if (ast_stream_and_wait(user-&gt;chan,</span>
<span class="lineNum">     935 </span>            :                                 there_are,
<span class="lineNum">     936 </span>            :                                 &quot;&quot;)) {
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">     938 </span>            :                         }
<span class="lineNum">     939 </span><span class="lineCov">          1 :                         if (ast_say_number(user-&gt;chan, conference-&gt;activeusers - 1, &quot;&quot;, ast_channel_language(user-&gt;chan), NULL)) {</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">     941 </span>            :                         }
<span class="lineNum">     942 </span><span class="lineCov">          1 :                         if (play_file(bridge_channel, user-&gt;chan, other_in_party) &lt; 0) {</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">     944 </span>            :                         }
<span class="lineNum">     945 </span><span class="lineCov">          2 :                 } else if (sound_file_exists(there_are) &amp;&amp; sound_file_exists(other_in_party)) {</span>
<span class="lineNum">     946 </span><span class="lineCov">          2 :                         play_sound_file(conference, there_are);</span>
<span class="lineNum">     947 </span><span class="lineCov">          2 :                         play_sound_number(conference, conference-&gt;activeusers - 1);</span>
<span class="lineNum">     948 </span><span class="lineCov">          2 :                         play_sound_file(conference, other_in_party);</span>
<span class="lineNum">     949 </span>            :                 }
<span class="lineNum">     950 </span>            :         }
<span class="lineNum">     951 </span><span class="lineCov">          4 :         return 0;</span>
<span class="lineNum">     952 </span>            : }
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span>            : /*!
<span class="lineNum">     955 </span>            :  * \brief Play back an audio file to a channel
<span class="lineNum">     956 </span>            :  *
<span class="lineNum">     957 </span>            :  * \param user User to play audio prompt to
<span class="lineNum">     958 </span>            :  * \param filename Prompt to play
<span class="lineNum">     959 </span>            :  *
<span class="lineNum">     960 </span>            :  * \return Returns 0 on success, -1 if the user hung up
<span class="lineNum">     961 </span>            :  * \note Generally this should be called when the conference is unlocked to avoid blocking
<span class="lineNum">     962 </span>            :  * the entire conference while the sound is played. But don't unlock the conference bridge
<a name="963"><span class="lineNum">     963 </span>            :  * in the middle of a state transition.</a>
<span class="lineNum">     964 </span>            :  */
<span class="lineNum">     965 </span><span class="lineCov">         32 : static int play_prompt_to_user(struct confbridge_user *user, const char *filename)</span>
<span class="lineNum">     966 </span>            : {
<span class="lineNum">     967 </span><span class="lineCov">         32 :         return ast_stream_and_wait(user-&gt;chan, filename, &quot;&quot;);</span>
<a name="968"><span class="lineNum">     968 </span>            : }</a>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineCov">         82 : static void handle_video_on_join(struct confbridge_conference *conference, struct ast_channel *chan, int marked)</span>
<span class="lineNum">     971 </span>            : {
<span class="lineNum">     972 </span>            :         /* Right now, only marked users are automatically set as the single src of video.*/
<span class="lineNum">     973 </span><span class="lineCov">         82 :         if (!marked) {</span>
<span class="lineNum">     974 </span><span class="lineCov">         55 :                 return;</span>
<span class="lineNum">     975 </span>            :         }
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineCov">         27 :         if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_FIRST_MARKED)) {</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :                 int set = 1;</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                 struct confbridge_user *user = NULL;</span>
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                 ao2_lock(conference);</span>
<span class="lineNum">     982 </span>            :                 /* see if anyone is already the video src */
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                         if (user-&gt;chan == chan) {</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     986 </span>            :                         }
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :                         if (ast_bridge_is_video_src(conference-&gt;bridge, user-&gt;chan)) {</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                                 set = 0;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     990 </span>            :                         }
<span class="lineNum">     991 </span>            :                 }
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                 if (set) {</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                         ast_bridge_set_single_src_video_mode(conference-&gt;bridge, chan);</span>
<span class="lineNum">     995 </span>            :                 }
<span class="lineNum">     996 </span><span class="lineCov">         27 :         } else if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_LAST_MARKED)) {</span>
<span class="lineNum">     997 </span>            :                 /* we joined and are video capable, we override anyone else that may have already been the video feed */
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :                 ast_bridge_set_single_src_video_mode(conference-&gt;bridge, chan);</span>
<span class="lineNum">     999 </span>            :         }
<a name="1000"><span class="lineNum">    1000 </span>            : }</a>
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span><span class="lineCov">         81 : static void handle_video_on_exit(struct confbridge_conference *conference, struct ast_channel *chan)</span>
<span class="lineNum">    1003 </span>            : {
<span class="lineNum">    1004 </span><span class="lineCov">         81 :         struct confbridge_user *user = NULL;</span>
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span>            :         /* if this isn't a video source, nothing to update */
<span class="lineNum">    1007 </span><span class="lineCov">         81 :         if (!ast_bridge_is_video_src(conference-&gt;bridge, chan)) {</span>
<span class="lineNum">    1008 </span><span class="lineCov">         81 :                 return;</span>
<span class="lineNum">    1009 </span>            :         }
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :         ast_bridge_remove_video_src(conference-&gt;bridge, chan);</span>
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span>            :         /* If in follow talker mode, make sure to restore this mode on the
<span class="lineNum">    1014 </span>            :          * bridge when a source is removed.  It is possible this channel was
<span class="lineNum">    1015 </span>            :          * only set temporarily as a video source by an AMI or DTMF action. */
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :         if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_FOLLOW_TALKER)) {</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                 ast_bridge_set_talker_src_video_mode(conference-&gt;bridge);</span>
<span class="lineNum">    1018 </span>            :         }
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span>            :         /* if the video_mode isn't set to automatically pick the video source, do nothing on exit. */
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :         if (!ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_FIRST_MARKED) &amp;&amp;</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :                 !ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_LAST_MARKED)) {</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1024 </span>            :         }
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span>            :         /* Make the next available marked user the video src.  */
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :                 if (user-&gt;chan == chan) {</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1031 </span>            :                 }
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                 if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)) {</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                         ast_bridge_set_single_src_video_mode(conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1035 </span>            :                 }
<span class="lineNum">    1036 </span>            :         }
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    1038 </span>            : }
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span>            : struct hangup_data
<span class="lineNum">    1041 </span>            : {
<span class="lineNum">    1042 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    1043 </span>            :         ast_mutex_t lock;
<span class="lineNum">    1044 </span>            :         ast_cond_t cond;
<span class="lineNum">    1045 </span>            :         int hungup;
<span class="lineNum">    1046 </span>            : };
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span>            : /*!
<span class="lineNum">    1049 </span>            :  * \brief Hang up the announcer channel
<span class="lineNum">    1050 </span>            :  *
<span class="lineNum">    1051 </span>            :  * This hangs up the announcer channel in the conference. This
<span class="lineNum">    1052 </span>            :  * runs in the playback queue taskprocessor since we do not want
<span class="lineNum">    1053 </span>            :  * to hang up the channel while it's trying to play an announcement.
<span class="lineNum">    1054 </span>            :  *
<span class="lineNum">    1055 </span>            :  * This task is performed synchronously, so there is no need to
<span class="lineNum">    1056 </span>            :  * perform any cleanup on the passed-in data.
<span class="lineNum">    1057 </span>            :  *
<span class="lineNum">    1058 </span>            :  * \param data A hangup_data structure
<a name="1059"><span class="lineNum">    1059 </span>            :  * \return 0</a>
<span class="lineNum">    1060 </span>            :  */
<span class="lineNum">    1061 </span><span class="lineCov">         39 : static int hangup_playback(void *data)</span>
<span class="lineNum">    1062 </span>            : {
<span class="lineNum">    1063 </span><span class="lineCov">         39 :         struct hangup_data *hangup = data;</span>
<span class="lineNum">    1064 </span>            : 
<span class="lineNum">    1065 </span><span class="lineCov">         39 :         ast_autoservice_stop(hangup-&gt;conference-&gt;playback_chan);</span>
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span><span class="lineCov">         39 :         ast_hangup(hangup-&gt;conference-&gt;playback_chan);</span>
<span class="lineNum">    1068 </span><span class="lineCov">         39 :         hangup-&gt;conference-&gt;playback_chan = NULL;</span>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineCov">         39 :         ast_mutex_lock(&amp;hangup-&gt;lock);</span>
<span class="lineNum">    1071 </span><span class="lineCov">         39 :         hangup-&gt;hungup = 1;</span>
<span class="lineNum">    1072 </span><span class="lineCov">         39 :         ast_cond_signal(&amp;hangup-&gt;cond);</span>
<span class="lineNum">    1073 </span><span class="lineCov">         39 :         ast_mutex_unlock(&amp;hangup-&gt;lock);</span>
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span><span class="lineCov">         39 :         return 0;</span>
<a name="1076"><span class="lineNum">    1076 </span>            : }</a>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">         39 : static void hangup_data_init(struct hangup_data *hangup, struct confbridge_conference *conference)</span>
<span class="lineNum">    1079 </span>            : {
<span class="lineNum">    1080 </span><span class="lineCov">         39 :         ast_mutex_init(&amp;hangup-&gt;lock);</span>
<span class="lineNum">    1081 </span><span class="lineCov">         39 :         ast_cond_init(&amp;hangup-&gt;cond, NULL);</span>
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span><span class="lineCov">         39 :         hangup-&gt;conference = conference;</span>
<span class="lineNum">    1084 </span><span class="lineCov">         39 :         hangup-&gt;hungup = 0;</span>
<a name="1085"><span class="lineNum">    1085 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span><span class="lineCov">         39 : static void hangup_data_destroy(struct hangup_data *hangup)</span>
<span class="lineNum">    1088 </span>            : {
<span class="lineNum">    1089 </span><span class="lineCov">         39 :         ast_mutex_destroy(&amp;hangup-&gt;lock);</span>
<span class="lineNum">    1090 </span><span class="lineCov">         39 :         ast_cond_destroy(&amp;hangup-&gt;cond);</span>
<span class="lineNum">    1091 </span><span class="lineCov">         39 : }</span>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span>            : /*!
<span class="lineNum">    1094 </span>            :  * \brief Destroy a conference bridge
<span class="lineNum">    1095 </span>            :  *
<span class="lineNum">    1096 </span>            :  * \param obj The conference bridge object
<span class="lineNum">    1097 </span>            :  *
<a name="1098"><span class="lineNum">    1098 </span>            :  * \return Returns nothing</a>
<span class="lineNum">    1099 </span>            :  */
<span class="lineNum">    1100 </span><span class="lineCov">         39 : static void destroy_conference_bridge(void *obj)</span>
<span class="lineNum">    1101 </span>            : {
<span class="lineNum">    1102 </span><span class="lineCov">         39 :         struct confbridge_conference *conference = obj;</span>
<span class="lineNum">    1103 </span>            : 
<span class="lineNum">    1104 </span><span class="lineCov">         39 :         ast_debug(1, &quot;Destroying conference bridge '%s'\n&quot;, conference-&gt;name);</span>
<span class="lineNum">    1105 </span>            : 
<span class="lineNum">    1106 </span><span class="lineCov">         39 :         if (conference-&gt;playback_chan) {</span>
<span class="lineNum">    1107 </span><span class="lineCov">         39 :                 if (conference-&gt;playback_queue) {</span>
<span class="lineNum">    1108 </span>            :                         struct hangup_data hangup;
<span class="lineNum">    1109 </span><span class="lineCov">         39 :                         hangup_data_init(&amp;hangup, conference);</span>
<span class="lineNum">    1110 </span><span class="lineCov">         39 :                         ast_taskprocessor_push(conference-&gt;playback_queue, hangup_playback, &amp;hangup);</span>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineCov">         39 :                         ast_mutex_lock(&amp;hangup.lock);</span>
<span class="lineNum">    1113 </span><span class="lineCov">         78 :                         while (!hangup.hungup) {</span>
<span class="lineNum">    1114 </span><span class="lineCov">         39 :                                 ast_cond_wait(&amp;hangup.cond, &amp;hangup.lock);</span>
<span class="lineNum">    1115 </span>            :                         }
<span class="lineNum">    1116 </span><span class="lineCov">         39 :                         ast_mutex_unlock(&amp;hangup.lock);</span>
<span class="lineNum">    1117 </span><span class="lineCov">         39 :                         hangup_data_destroy(&amp;hangup);</span>
<span class="lineNum">    1118 </span>            :                 } else {
<span class="lineNum">    1119 </span>            :                         /* Playback queue is not yet allocated. Just hang up the channel straight */
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                         ast_hangup(conference-&gt;playback_chan);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :                         conference-&gt;playback_chan = NULL;</span>
<span class="lineNum">    1122 </span>            :                 }
<span class="lineNum">    1123 </span>            :         }
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span>            :         /* Destroying a conference bridge is simple, all we have to do is destroy the bridging object */
<span class="lineNum">    1126 </span><span class="lineCov">         39 :         if (conference-&gt;bridge) {</span>
<span class="lineNum">    1127 </span><span class="lineCov">         39 :                 ast_bridge_destroy(conference-&gt;bridge, 0);</span>
<span class="lineNum">    1128 </span><span class="lineCov">         39 :                 conference-&gt;bridge = NULL;</span>
<span class="lineNum">    1129 </span>            :         }
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span><span class="lineCov">         39 :         ast_channel_cleanup(conference-&gt;record_chan);</span>
<span class="lineNum">    1132 </span><span class="lineCov">         39 :         ast_free(conference-&gt;orig_rec_file);</span>
<span class="lineNum">    1133 </span><span class="lineCov">         39 :         ast_free(conference-&gt;record_filename);</span>
<span class="lineNum">    1134 </span>            : 
<span class="lineNum">    1135 </span><span class="lineCov">         39 :         conf_bridge_profile_destroy(&amp;conference-&gt;b_profile);</span>
<span class="lineNum">    1136 </span><span class="lineCov">         39 :         ast_taskprocessor_unreference(conference-&gt;playback_queue);</span>
<span class="lineNum">    1137 </span><span class="lineCov">         39 : }</span>
<span class="lineNum">    1138 </span>            : 
<span class="lineNum">    1139 </span>            : /*! \brief Call the proper join event handler for the user for the conference bridge's current state
<span class="lineNum">    1140 </span>            :  * \internal
<span class="lineNum">    1141 </span>            :  * \param user The conference bridge user that is joining
<span class="lineNum">    1142 </span>            :  * \retval 0 success
<a name="1143"><span class="lineNum">    1143 </span>            :  * \retval -1 failure</a>
<span class="lineNum">    1144 </span>            :  */
<span class="lineNum">    1145 </span><span class="lineCov">         82 : static int handle_conf_user_join(struct confbridge_user *user)</span>
<span class="lineNum">    1146 </span>            : {
<span class="lineNum">    1147 </span>            :         conference_event_fn handler;
<span class="lineNum">    1148 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)) {</span>
<span class="lineNum">    1149 </span><span class="lineCov">         27 :                 handler = user-&gt;conference-&gt;state-&gt;join_marked;</span>
<span class="lineNum">    1150 </span><span class="lineCov">         55 :         } else if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_WAITMARKED)) {</span>
<span class="lineNum">    1151 </span><span class="lineCov">         17 :                 handler = user-&gt;conference-&gt;state-&gt;join_waitmarked;</span>
<span class="lineNum">    1152 </span>            :         } else {
<span class="lineNum">    1153 </span><span class="lineCov">         38 :                 handler = user-&gt;conference-&gt;state-&gt;join_unmarked;</span>
<span class="lineNum">    1154 </span>            :         }
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span><span class="lineCov">         82 :         ast_assert(handler != NULL);</span>
<span class="lineNum">    1157 </span>            : 
<span class="lineNum">    1158 </span><span class="lineCov">         82 :         if (!handler) {</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :                 conf_invalid_event_fn(user);</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1161 </span>            :         }
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span><span class="lineCov">         82 :         handler(user);</span>
<span class="lineNum">    1164 </span>            : 
<span class="lineNum">    1165 </span><span class="lineCov">         82 :         return 0;</span>
<span class="lineNum">    1166 </span>            : }
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span>            : /*! \brief Call the proper leave event handler for the user for the conference bridge's current state
<span class="lineNum">    1169 </span>            :  * \internal
<span class="lineNum">    1170 </span>            :  * \param user The conference bridge user that is leaving
<span class="lineNum">    1171 </span>            :  * \retval 0 success
<a name="1172"><span class="lineNum">    1172 </span>            :  * \retval -1 failure</a>
<span class="lineNum">    1173 </span>            :  */
<span class="lineNum">    1174 </span><span class="lineCov">         82 : static int handle_conf_user_leave(struct confbridge_user *user)</span>
<span class="lineNum">    1175 </span>            : {
<span class="lineNum">    1176 </span>            :         conference_event_fn handler;
<span class="lineNum">    1177 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)) {</span>
<span class="lineNum">    1178 </span><span class="lineCov">         27 :                 handler = user-&gt;conference-&gt;state-&gt;leave_marked;</span>
<span class="lineNum">    1179 </span><span class="lineCov">         55 :         } else if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_WAITMARKED)) {</span>
<span class="lineNum">    1180 </span><span class="lineCov">         17 :                 handler = user-&gt;conference-&gt;state-&gt;leave_waitmarked;</span>
<span class="lineNum">    1181 </span>            :         } else {
<span class="lineNum">    1182 </span><span class="lineCov">         38 :                 handler = user-&gt;conference-&gt;state-&gt;leave_unmarked;</span>
<span class="lineNum">    1183 </span>            :         }
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span><span class="lineCov">         82 :         ast_assert(handler != NULL);</span>
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span><span class="lineCov">         82 :         if (!handler) {</span>
<span class="lineNum">    1188 </span>            :                 /* This should never happen. If it does, though, it is bad. The user will not have been removed
<span class="lineNum">    1189 </span>            :                  * from the appropriate list, so counts will be off and stuff. The conference won't be torn down, etc.
<span class="lineNum">    1190 </span>            :                  * Shouldn't happen, though. */
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                 conf_invalid_event_fn(user);</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1193 </span>            :         }
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineCov">         82 :         handler(user);</span>
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineCov">         82 :         return 0;</span>
<a name="1198"><span class="lineNum">    1198 </span>            : }</a>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineCov">        145 : void conf_update_user_mute(struct confbridge_user *user)</span>
<span class="lineNum">    1201 </span>            : {
<span class="lineNum">    1202 </span>            :         int mute_user;
<span class="lineNum">    1203 </span>            :         int mute_system;
<span class="lineNum">    1204 </span>            :         int mute_effective;
<span class="lineNum">    1205 </span>            : 
<span class="lineNum">    1206 </span>            :         /* User level mute request. */
<span class="lineNum">    1207 </span><span class="lineCov">        145 :         mute_user = user-&gt;muted;</span>
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span>            :         /* System level mute request. */
<span class="lineNum">    1210 </span><span class="lineCov">        290 :         mute_system = user-&gt;playing_moh</span>
<span class="lineNum">    1211 </span>            :                 /*
<span class="lineNum">    1212 </span>            :                  * Do not allow waitmarked users to talk to anyone unless there
<span class="lineNum">    1213 </span>            :                  * is a marked user present.
<span class="lineNum">    1214 </span>            :                  */
<span class="lineNum">    1215 </span><span class="lineCov">        195 :                 || (!user-&gt;conference-&gt;markedusers</span>
<span class="lineNum">    1216 </span><span class="lineCov">         50 :                         &amp;&amp; ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_WAITMARKED));</span>
<span class="lineNum">    1217 </span>            : 
<span class="lineNum">    1218 </span><span class="lineCov">        145 :         mute_effective = mute_user || mute_system;</span>
<span class="lineNum">    1219 </span>            : 
<span class="lineNum">    1220 </span><span class="lineCov">        145 :         ast_debug(1, &quot;User %s is %s: user:%d system:%d.\n&quot;,</span>
<span class="lineNum">    1221 </span>            :                 ast_channel_name(user-&gt;chan), mute_effective ? &quot;muted&quot; : &quot;unmuted&quot;,
<span class="lineNum">    1222 </span>            :                 mute_user, mute_system);
<span class="lineNum">    1223 </span><span class="lineCov">        145 :         user-&gt;features.mute = mute_effective;</span>
<span class="lineNum">    1224 </span><span class="lineCov">        145 :         ast_test_suite_event_notify(&quot;CONF_MUTE_UPDATE&quot;,</span>
<span class="lineNum">    1225 </span>            :                 &quot;Mode: %s\r\n&quot;
<span class="lineNum">    1226 </span>            :                 &quot;Conference: %s\r\n&quot;
<span class="lineNum">    1227 </span>            :                 &quot;Channel: %s&quot;,
<span class="lineNum">    1228 </span>            :                 mute_effective ? &quot;muted&quot; : &quot;unmuted&quot;,
<span class="lineNum">    1229 </span>            :                 user-&gt;conference-&gt;b_profile.name,
<span class="lineNum">    1230 </span>            :                 ast_channel_name(user-&gt;chan));
<span class="lineNum">    1231 </span><span class="lineCov">        145 : }</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            : /*
<span class="lineNum">    1234 </span>            :  * \internal
<a name="1235"><span class="lineNum">    1235 </span>            :  * \brief Mute/unmute a single user.</a>
<span class="lineNum">    1236 </span>            :  */
<span class="lineNum">    1237 </span><span class="lineCov">          1 : static void generic_mute_unmute_user(struct confbridge_conference *conference, struct confbridge_user *user, int mute)</span>
<span class="lineNum">    1238 </span>            : {
<span class="lineNum">    1239 </span>            :         /* Set user level mute request. */
<span class="lineNum">    1240 </span><span class="lineCov">          1 :         user-&gt;muted = mute ? 1 : 0;</span>
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span><span class="lineCov">          1 :         conf_update_user_mute(user);</span>
<span class="lineNum">    1243 </span><span class="lineCov">          1 :         ast_test_suite_event_notify(&quot;CONF_MUTE&quot;,</span>
<span class="lineNum">    1244 </span>            :                 &quot;Message: participant %s %s\r\n&quot;
<span class="lineNum">    1245 </span>            :                 &quot;Conference: %s\r\n&quot;
<span class="lineNum">    1246 </span>            :                 &quot;Channel: %s&quot;,
<span class="lineNum">    1247 </span>            :                 ast_channel_name(user-&gt;chan),
<span class="lineNum">    1248 </span>            :                 mute ? &quot;muted&quot; : &quot;unmuted&quot;,
<span class="lineNum">    1249 </span>            :                 conference-&gt;b_profile.name,
<span class="lineNum">    1250 </span>            :                 ast_channel_name(user-&gt;chan));
<span class="lineNum">    1251 </span><span class="lineCov">          1 :         if (mute) {</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                 send_mute_event(user, conference);</span>
<span class="lineNum">    1253 </span>            :         } else {
<span class="lineNum">    1254 </span><span class="lineCov">          1 :                 send_unmute_event(user, conference);</span>
<span class="lineNum">    1255 </span>            :         }
<a name="1256"><span class="lineNum">    1256 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineCov">         29 : void conf_moh_stop(struct confbridge_user *user)</span>
<span class="lineNum">    1259 </span>            : {
<span class="lineNum">    1260 </span><span class="lineCov">         29 :         user-&gt;playing_moh = 0;</span>
<span class="lineNum">    1261 </span><span class="lineCov">         29 :         if (!user-&gt;suspended_moh) {</span>
<span class="lineNum">    1262 </span>            :                 int in_bridge;
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span>            :                 /*
<span class="lineNum">    1265 </span>            :                  * Locking the ast_bridge here is the only way to hold off the
<span class="lineNum">    1266 </span>            :                  * call to ast_bridge_join() in confbridge_exec() from
<span class="lineNum">    1267 </span>            :                  * interfering with the bridge and MOH operations here.
<span class="lineNum">    1268 </span>            :                  */
<span class="lineNum">    1269 </span><span class="lineCov">         29 :                 ast_bridge_lock(user-&gt;conference-&gt;bridge);</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span>            :                 /*
<span class="lineNum">    1272 </span>            :                  * Temporarily suspend the user from the bridge so we have
<span class="lineNum">    1273 </span>            :                  * control to stop MOH if needed.
<span class="lineNum">    1274 </span>            :                  */
<span class="lineNum">    1275 </span><span class="lineCov">         29 :                 in_bridge = !ast_bridge_suspend(user-&gt;conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    1276 </span><span class="lineCov">         29 :                 ast_moh_stop(user-&gt;chan);</span>
<span class="lineNum">    1277 </span><span class="lineCov">         29 :                 if (in_bridge) {</span>
<span class="lineNum">    1278 </span><span class="lineCov">         11 :                         ast_bridge_unsuspend(user-&gt;conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    1279 </span>            :                 }
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span><span class="lineCov">         29 :                 ast_bridge_unlock(user-&gt;conference-&gt;bridge);</span>
<span class="lineNum">    1282 </span>            :         }
<a name="1283"><span class="lineNum">    1283 </span><span class="lineCov">         29 : }</span></a>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span><span class="lineCov">         29 : void conf_moh_start(struct confbridge_user *user)</span>
<span class="lineNum">    1286 </span>            : {
<span class="lineNum">    1287 </span><span class="lineCov">         29 :         user-&gt;playing_moh = 1;</span>
<span class="lineNum">    1288 </span><span class="lineCov">         29 :         if (!user-&gt;suspended_moh) {</span>
<span class="lineNum">    1289 </span>            :                 int in_bridge;
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span>            :                 /*
<span class="lineNum">    1292 </span>            :                  * Locking the ast_bridge here is the only way to hold off the
<span class="lineNum">    1293 </span>            :                  * call to ast_bridge_join() in confbridge_exec() from
<span class="lineNum">    1294 </span>            :                  * interfering with the bridge and MOH operations here.
<span class="lineNum">    1295 </span>            :                  */
<span class="lineNum">    1296 </span><span class="lineCov">         10 :                 ast_bridge_lock(user-&gt;conference-&gt;bridge);</span>
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span>            :                 /*
<span class="lineNum">    1299 </span>            :                  * Temporarily suspend the user from the bridge so we have
<span class="lineNum">    1300 </span>            :                  * control to start MOH if needed.
<span class="lineNum">    1301 </span>            :                  */
<span class="lineNum">    1302 </span><span class="lineCov">         10 :                 in_bridge = !ast_bridge_suspend(user-&gt;conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    1303 </span><span class="lineCov">         10 :                 ast_moh_start(user-&gt;chan, user-&gt;u_profile.moh_class, NULL);</span>
<span class="lineNum">    1304 </span><span class="lineCov">         10 :                 if (in_bridge) {</span>
<span class="lineNum">    1305 </span><span class="lineCov">          9 :                         ast_bridge_unsuspend(user-&gt;conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    1306 </span>            :                 }
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span><span class="lineCov">         10 :                 ast_bridge_unlock(user-&gt;conference-&gt;bridge);</span>
<span class="lineNum">    1309 </span>            :         }
<span class="lineNum">    1310 </span><span class="lineCov">         29 : }</span>
<span class="lineNum">    1311 </span>            : 
<span class="lineNum">    1312 </span>            : /*!
<span class="lineNum">    1313 </span>            :  * \internal
<span class="lineNum">    1314 </span>            :  * \brief Unsuspend MOH for the conference user.
<span class="lineNum">    1315 </span>            :  *
<span class="lineNum">    1316 </span>            :  * \param user Conference user to unsuspend MOH on.
<span class="lineNum">    1317 </span>            :  *
<a name="1318"><span class="lineNum">    1318 </span>            :  * \return Nothing</a>
<span class="lineNum">    1319 </span>            :  */
<span class="lineNum">    1320 </span><span class="lineCov">         96 : static void conf_moh_unsuspend(struct confbridge_user *user)</span>
<span class="lineNum">    1321 </span>            : {
<span class="lineNum">    1322 </span><span class="lineCov">         96 :         ao2_lock(user-&gt;conference);</span>
<span class="lineNum">    1323 </span><span class="lineCov">         96 :         if (--user-&gt;suspended_moh == 0 &amp;&amp; user-&gt;playing_moh) {</span>
<span class="lineNum">    1324 </span><span class="lineCov">         19 :                 ast_moh_start(user-&gt;chan, user-&gt;u_profile.moh_class, NULL);</span>
<span class="lineNum">    1325 </span>            :         }
<span class="lineNum">    1326 </span><span class="lineCov">         96 :         ao2_unlock(user-&gt;conference);</span>
<span class="lineNum">    1327 </span><span class="lineCov">         96 : }</span>
<span class="lineNum">    1328 </span>            : 
<span class="lineNum">    1329 </span>            : /*!
<span class="lineNum">    1330 </span>            :  * \internal
<span class="lineNum">    1331 </span>            :  * \brief Suspend MOH for the conference user.
<span class="lineNum">    1332 </span>            :  *
<span class="lineNum">    1333 </span>            :  * \param user Conference user to suspend MOH on.
<span class="lineNum">    1334 </span>            :  *
<a name="1335"><span class="lineNum">    1335 </span>            :  * \return Nothing</a>
<span class="lineNum">    1336 </span>            :  */
<span class="lineNum">    1337 </span><span class="lineCov">         14 : static void conf_moh_suspend(struct confbridge_user *user)</span>
<span class="lineNum">    1338 </span>            : {
<span class="lineNum">    1339 </span><span class="lineCov">         14 :         ao2_lock(user-&gt;conference);</span>
<span class="lineNum">    1340 </span><span class="lineCov">         14 :         if (user-&gt;suspended_moh++ == 0 &amp;&amp; user-&gt;playing_moh) {</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                 ast_moh_stop(user-&gt;chan);</span>
<span class="lineNum">    1342 </span>            :         }
<span class="lineNum">    1343 </span><span class="lineCov">         14 :         ao2_unlock(user-&gt;conference);</span>
<a name="1344"><span class="lineNum">    1344 </span><span class="lineCov">         14 : }</span></a>
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span><span class="lineCov">         14 : int conf_handle_inactive_waitmarked(struct confbridge_user *user)</span>
<span class="lineNum">    1347 </span>            : {
<span class="lineNum">    1348 </span>            :         /* If we have not been quieted play back that they are waiting for the leader */
<span class="lineNum">    1349 </span><span class="lineCov">         28 :         if (!ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_QUIET) &amp;&amp; play_prompt_to_user(user,</span>
<span class="lineNum">    1350 </span><span class="lineCov">         14 :                         conf_get_sound(CONF_SOUND_WAIT_FOR_LEADER, user-&gt;conference-&gt;b_profile.sounds))) {</span>
<span class="lineNum">    1351 </span>            :                 /* user hungup while the sound was playing */
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1353 </span>            :         }
<span class="lineNum">    1354 </span><span class="lineCov">         14 :         return 0;</span>
<a name="1355"><span class="lineNum">    1355 </span>            : }</a>
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span><span class="lineCov">         27 : int conf_handle_only_unmarked(struct confbridge_user *user)</span>
<span class="lineNum">    1358 </span>            : {
<span class="lineNum">    1359 </span>            :         /* If audio prompts have not been quieted or this prompt quieted play it on out */
<span class="lineNum">    1360 </span><span class="lineCov">         27 :         if (!ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_QUIET | USER_OPT_NOONLYPERSON)) {</span>
<span class="lineNum">    1361 </span><span class="lineCov">         18 :                 if (play_prompt_to_user(user,</span>
<span class="lineNum">    1362 </span><span class="lineCov">         18 :                         conf_get_sound(CONF_SOUND_ONLY_PERSON, user-&gt;conference-&gt;b_profile.sounds))) {</span>
<span class="lineNum">    1363 </span>            :                         /* user hungup while the sound was playing */
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    1365 </span>            :                 }
<span class="lineNum">    1366 </span>            :         }
<span class="lineNum">    1367 </span><span class="lineCov">         27 :         return 0;</span>
<a name="1368"><span class="lineNum">    1368 </span>            : }</a>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineCov">         47 : int conf_add_post_join_action(struct confbridge_user *user, int (*func)(struct confbridge_user *user))</span>
<span class="lineNum">    1371 </span>            : {
<span class="lineNum">    1372 </span>            :         struct post_join_action *action;
<span class="lineNum">    1373 </span><span class="lineCov">         47 :         if (!(action = ast_calloc(1, sizeof(*action)))) {</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1375 </span>            :         }
<span class="lineNum">    1376 </span><span class="lineCov">         47 :         action-&gt;func = func;</span>
<span class="lineNum">    1377 </span><span class="lineCov">         47 :         AST_LIST_INSERT_TAIL(&amp;user-&gt;post_join_list, action, list);</span>
<span class="lineNum">    1378 </span><span class="lineCov">         47 :         return 0;</span>
<span class="lineNum">    1379 </span>            : }
<a name="1380"><span class="lineNum">    1380 </span>            : </a>
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span><span class="lineCov">         39 : void conf_handle_first_join(struct confbridge_conference *conference)</span>
<span class="lineNum">    1383 </span>            : {
<span class="lineNum">    1384 </span><span class="lineCov">         39 :         ast_devstate_changed(AST_DEVICE_INUSE, AST_DEVSTATE_CACHABLE, &quot;confbridge:%s&quot;, conference-&gt;name);</span>
<a name="1385"><span class="lineNum">    1385 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">    1386 </span>            : 
<span class="lineNum">    1387 </span><span class="lineCov">         24 : void conf_handle_second_active(struct confbridge_conference *conference)</span>
<span class="lineNum">    1388 </span>            : {
<span class="lineNum">    1389 </span>            :         /* If we are the second participant we may need to stop music on hold on the first */
<span class="lineNum">    1390 </span><span class="lineCov">         24 :         struct confbridge_user *first_user = AST_LIST_FIRST(&amp;conference-&gt;active_list);</span>
<span class="lineNum">    1391 </span>            : 
<span class="lineNum">    1392 </span><span class="lineCov">         24 :         if (ast_test_flag(&amp;first_user-&gt;u_profile, USER_OPT_MUSICONHOLD)) {</span>
<span class="lineNum">    1393 </span><span class="lineCov">          6 :                 conf_moh_stop(first_user);</span>
<span class="lineNum">    1394 </span>            :         }
<span class="lineNum">    1395 </span><span class="lineCov">         24 :         conf_update_user_mute(first_user);</span>
<a name="1396"><span class="lineNum">    1396 </span><span class="lineCov">         24 : }</span></a>
<span class="lineNum">    1397 </span>            : 
<span class="lineNum">    1398 </span><span class="lineCov">         39 : void conf_ended(struct confbridge_conference *conference)</span>
<span class="lineNum">    1399 </span>            : {
<span class="lineNum">    1400 </span><span class="lineCov">         39 :         struct pbx_find_info q = { .stacklen = 0 };</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :         /* Called with a reference to conference */
<span class="lineNum">    1403 </span><span class="lineCov">         39 :         ao2_unlink(conference_bridges, conference);</span>
<span class="lineNum">    1404 </span><span class="lineCov">         39 :         send_conf_end_event(conference);</span>
<span class="lineNum">    1405 </span><span class="lineCov">         40 :         if (!ast_strlen_zero(conference-&gt;b_profile.regcontext) &amp;&amp;</span>
<span class="lineNum">    1406 </span><span class="lineCov">          1 :                         pbx_find_extension(NULL, NULL, &amp;q, conference-&gt;b_profile.regcontext,</span>
<span class="lineNum">    1407 </span><span class="lineCov">          1 :                                 conference-&gt;name, 1, NULL, &quot;&quot;, E_MATCH)) {</span>
<span class="lineNum">    1408 </span><span class="lineCov">          1 :                 ast_context_remove_extension(conference-&gt;b_profile.regcontext,</span>
<span class="lineNum">    1409 </span><span class="lineCov">          1 :                                 conference-&gt;name, 1, NULL);</span>
<span class="lineNum">    1410 </span>            :         }
<span class="lineNum">    1411 </span><span class="lineCov">         39 :         ao2_lock(conference);</span>
<span class="lineNum">    1412 </span><span class="lineCov">         39 :         conf_stop_record(conference);</span>
<span class="lineNum">    1413 </span><span class="lineCov">         39 :         ao2_unlock(conference);</span>
<span class="lineNum">    1414 </span><span class="lineCov">         39 : }</span>
<span class="lineNum">    1415 </span>            : 
<span class="lineNum">    1416 </span>            : /*!
<span class="lineNum">    1417 </span>            :  * \internal
<span class="lineNum">    1418 </span>            :  * \brief Allocate playback channel for a conference.
<a name="1419"><span class="lineNum">    1419 </span>            :  * \pre expects conference to be locked before calling this function</a>
<span class="lineNum">    1420 </span>            :  */
<span class="lineNum">    1421 </span><span class="lineCov">         39 : static int alloc_playback_chan(struct confbridge_conference *conference)</span>
<span class="lineNum">    1422 </span>            : {
<span class="lineNum">    1423 </span>            :         struct ast_format_cap *cap;
<span class="lineNum">    1424 </span>            :         char taskprocessor_name[AST_TASKPROCESSOR_MAX_NAME + 1];
<span class="lineNum">    1425 </span>            : 
<span class="lineNum">    1426 </span><span class="lineCov">         39 :         cap = ast_format_cap_alloc(AST_FORMAT_CAP_FLAG_DEFAULT);</span>
<span class="lineNum">    1427 </span><span class="lineCov">         39 :         if (!cap) {</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1429 </span>            :         }
<span class="lineNum">    1430 </span><span class="lineCov">         39 :         ast_format_cap_append(cap, ast_format_slin, 0);</span>
<span class="lineNum">    1431 </span><span class="lineCov">         78 :         conference-&gt;playback_chan = ast_request(&quot;CBAnn&quot;, cap, NULL, NULL,</span>
<span class="lineNum">    1432 </span><span class="lineCov">         39 :                 conference-&gt;name, NULL);</span>
<span class="lineNum">    1433 </span><span class="lineCov">         39 :         ao2_ref(cap, -1);</span>
<span class="lineNum">    1434 </span><span class="lineCov">         39 :         if (!conference-&gt;playback_chan) {</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1436 </span>            :         }
<span class="lineNum">    1437 </span>            : 
<span class="lineNum">    1438 </span>            :         /* To make sure playback_chan has the same language as the bridge */
<span class="lineNum">    1439 </span><span class="lineCov">         39 :         ast_channel_lock(conference-&gt;playback_chan);</span>
<span class="lineNum">    1440 </span><span class="lineCov">         39 :         ast_channel_language_set(conference-&gt;playback_chan, conference-&gt;b_profile.language);</span>
<span class="lineNum">    1441 </span><span class="lineCov">         39 :         ast_channel_unlock(conference-&gt;playback_chan);</span>
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span><span class="lineCov">         39 :         ast_debug(1, &quot;Created announcer channel '%s' to conference bridge '%s'\n&quot;,</span>
<span class="lineNum">    1444 </span>            :                 ast_channel_name(conference-&gt;playback_chan), conference-&gt;name);
<span class="lineNum">    1445 </span>            : 
<span class="lineNum">    1446 </span><span class="lineCov">         39 :         ast_taskprocessor_build_name(taskprocessor_name, sizeof(taskprocessor_name),</span>
<span class="lineNum">    1447 </span><span class="lineCov">         39 :                 &quot;Confbridge/%s&quot;, conference-&gt;name);</span>
<span class="lineNum">    1448 </span><span class="lineCov">         39 :         conference-&gt;playback_queue = ast_taskprocessor_get(taskprocessor_name, TPS_REF_DEFAULT);</span>
<span class="lineNum">    1449 </span><span class="lineCov">         39 :         if (!conference-&gt;playback_queue) {</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                 ast_hangup(conference-&gt;playback_chan);</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                 conference-&gt;playback_chan = NULL;</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1453 </span>            :         }
<span class="lineNum">    1454 </span><span class="lineCov">         39 :         return 0;</span>
<span class="lineNum">    1455 </span>            : }
<span class="lineNum">    1456 </span>            : 
<span class="lineNum">    1457 </span>            : /*!
<span class="lineNum">    1458 </span>            :  * \brief Push the announcer channel into the bridge
<span class="lineNum">    1459 </span>            :  *
<span class="lineNum">    1460 </span>            :  * \param conference Conference bridge to push the announcer to
<span class="lineNum">    1461 </span>            :  * \retval 0 Success
<a name="1462"><span class="lineNum">    1462 </span>            :  * \retval -1 Failed to push the channel to the bridge</a>
<span class="lineNum">    1463 </span>            :  */
<span class="lineNum">    1464 </span><span class="lineCov">         39 : static int push_announcer(struct confbridge_conference *conference)</span>
<span class="lineNum">    1465 </span>            : {
<span class="lineNum">    1466 </span><span class="lineCov">         39 :         if (conf_announce_channel_push(conference-&gt;playback_chan)) {</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                 ast_hangup(conference-&gt;playback_chan);</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                 conference-&gt;playback_chan = NULL;</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1470 </span>            :         }
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineCov">         39 :         ast_autoservice_start(conference-&gt;playback_chan);</span>
<span class="lineNum">    1473 </span><span class="lineCov">         39 :         return 0;</span>
<span class="lineNum">    1474 </span>            : }
<span class="lineNum">    1475 </span>            : 
<span class="lineNum">    1476 </span>            : /*!
<span class="lineNum">    1477 </span>            :  * \brief Join a conference bridge
<span class="lineNum">    1478 </span>            :  *
<span class="lineNum">    1479 </span>            :  * \param conference_name The conference name
<span class="lineNum">    1480 </span>            :  * \param user Conference bridge user structure
<span class="lineNum">    1481 </span>            :  *
<a name="1482"><span class="lineNum">    1482 </span>            :  * \return A pointer to the conference bridge struct, or NULL if the conference room wasn't found.</a>
<span class="lineNum">    1483 </span>            :  */
<span class="lineNum">    1484 </span><span class="lineCov">         82 : static struct confbridge_conference *join_conference_bridge(const char *conference_name, struct confbridge_user *user)</span>
<span class="lineNum">    1485 </span>            : {
<span class="lineNum">    1486 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    1487 </span>            :         struct post_join_action *action;
<span class="lineNum">    1488 </span><span class="lineCov">         82 :         int max_members_reached = 0;</span>
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span>            :         /* We explictly lock the conference bridges container ourselves so that other callers can not create duplicate conferences at the same */
<span class="lineNum">    1491 </span><span class="lineCov">         82 :         ao2_lock(conference_bridges);</span>
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span><span class="lineCov">         82 :         ast_debug(1, &quot;Trying to find conference bridge '%s'\n&quot;, conference_name);</span>
<span class="lineNum">    1494 </span>            : 
<span class="lineNum">    1495 </span>            :         /* Attempt to find an existing conference bridge */
<span class="lineNum">    1496 </span><span class="lineCov">         82 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    1497 </span><span class="lineCov">         82 :         if (conference &amp;&amp; conference-&gt;b_profile.max_members) {</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :                 max_members_reached = conference-&gt;b_profile.max_members &gt; conference-&gt;activeusers ? 0 : 1;</span>
<span class="lineNum">    1499 </span>            :         }
<span class="lineNum">    1500 </span>            : 
<span class="lineNum">    1501 </span>            :         /* When finding a conference bridge that already exists make sure that it is not locked, and if so that we are not an admin */
<span class="lineNum">    1502 </span><span class="lineCov">         82 :         if (conference &amp;&amp; (max_members_reached || conference-&gt;locked) &amp;&amp; !ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)) {</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :                 ast_debug(1, &quot;Conference '%s' is locked and caller is not an admin\n&quot;, conference_name);</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :                 ast_stream_and_wait(user-&gt;chan,</span>
<span class="lineNum">    1506 </span>            :                         conf_get_sound(CONF_SOUND_LOCKED, conference-&gt;b_profile.sounds),
<span class="lineNum">    1507 </span>            :                         &quot;&quot;);
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1510 </span>            :         }
<span class="lineNum">    1511 </span>            : 
<span class="lineNum">    1512 </span>            :         /* If no conference bridge was found see if we can create one */
<span class="lineNum">    1513 </span><span class="lineCov">         82 :         if (!conference) {</span>
<span class="lineNum">    1514 </span>            :                 /* Try to allocate memory for a new conference bridge, if we fail... this won't end well. */
<span class="lineNum">    1515 </span><span class="lineCov">         39 :                 if (!(conference = ao2_alloc(sizeof(*conference), destroy_conference_bridge))) {</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Conference '%s' could not be created.\n&quot;, conference_name);</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1519 </span>            :                 }
<span class="lineNum">    1520 </span>            : 
<span class="lineNum">    1521 </span>            :                 /* Setup for the record channel */
<span class="lineNum">    1522 </span><span class="lineCov">         39 :                 conference-&gt;record_filename = ast_str_create(RECORD_FILENAME_INITIAL_SPACE);</span>
<span class="lineNum">    1523 </span><span class="lineCov">         39 :                 if (!conference-&gt;record_filename) {</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1527 </span>            :                 }
<span class="lineNum">    1528 </span>            : 
<span class="lineNum">    1529 </span>            :                 /* Setup conference bridge parameters */
<span class="lineNum">    1530 </span><span class="lineCov">         39 :                 ast_copy_string(conference-&gt;name, conference_name, sizeof(conference-&gt;name));</span>
<span class="lineNum">    1531 </span><span class="lineCov">         39 :                 conf_bridge_profile_copy(&amp;conference-&gt;b_profile, &amp;user-&gt;b_profile);</span>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span>            :                 /* Create an actual bridge that will do the audio mixing */
<span class="lineNum">    1534 </span><span class="lineCov">         39 :                 conference-&gt;bridge = ast_bridge_base_new(AST_BRIDGE_CAPABILITY_MULTIMIX,</span>
<span class="lineNum">    1535 </span>            :                         AST_BRIDGE_FLAG_MASQUERADE_ONLY | AST_BRIDGE_FLAG_TRANSFER_BRIDGE_ONLY,
<span class="lineNum">    1536 </span>            :                         app, conference_name, NULL);
<span class="lineNum">    1537 </span><span class="lineCov">         39 :                 if (!conference-&gt;bridge) {</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Conference '%s' mixing bridge could not be created.\n&quot;, conference_name);</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1542 </span>            :                 }
<span class="lineNum">    1543 </span>            : 
<span class="lineNum">    1544 </span>            :                 /* Set the internal sample rate on the bridge from the bridge profile */
<span class="lineNum">    1545 </span><span class="lineCov">         39 :                 ast_bridge_set_internal_sample_rate(conference-&gt;bridge, conference-&gt;b_profile.internal_sample_rate);</span>
<span class="lineNum">    1546 </span>            :                 /* Set the internal mixing interval on the bridge from the bridge profile */
<span class="lineNum">    1547 </span><span class="lineCov">         39 :                 ast_bridge_set_mixing_interval(conference-&gt;bridge, conference-&gt;b_profile.mix_interval);</span>
<span class="lineNum">    1548 </span><span class="lineCov">         39 :                 ast_bridge_set_binaural_active(conference-&gt;bridge, ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_BINAURAL_ACTIVE));</span>
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineCov">         39 :                 if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_FOLLOW_TALKER)) {</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                         ast_bridge_set_talker_src_video_mode(conference-&gt;bridge);</span>
<span class="lineNum">    1552 </span><span class="lineCov">         39 :                 } else if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_SFU)) {</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                         ast_bridge_set_sfu_video_mode(conference-&gt;bridge);</span>
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :                         ast_bridge_set_video_update_discard(conference-&gt;bridge, conference-&gt;b_profile.video_update_discard);</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                         ast_bridge_set_remb_send_interval(conference-&gt;bridge, conference-&gt;b_profile.remb_send_interval);</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :                         if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_REMB_BEHAVIOR_AVERAGE)) {</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :                                 ast_brige_set_remb_behavior(conference-&gt;bridge, AST_BRIDGE_VIDEO_SFU_REMB_AVERAGE);</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                         } else if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_REMB_BEHAVIOR_LOWEST)) {</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :                                 ast_brige_set_remb_behavior(conference-&gt;bridge, AST_BRIDGE_VIDEO_SFU_REMB_LOWEST);</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :                         } else if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_REMB_BEHAVIOR_HIGHEST)) {</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :                                 ast_brige_set_remb_behavior(conference-&gt;bridge, AST_BRIDGE_VIDEO_SFU_REMB_HIGHEST);</span>
<span class="lineNum">    1562 </span>            :                         }
<span class="lineNum">    1563 </span>            :                 }
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span>            :                 /* Link it into the conference bridges container */
<span class="lineNum">    1566 </span><span class="lineCov">         39 :                 if (!ao2_link(conference_bridges, conference)) {</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR,</span>
<span class="lineNum">    1570 </span>            :                                 &quot;Conference '%s' could not be added to the conferences list.\n&quot;, conference_name);
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1572 </span>            :                 }
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span>            :                 /* Set the initial state to EMPTY */
<span class="lineNum">    1575 </span><span class="lineCov">         39 :                 conference-&gt;state = CONF_STATE_EMPTY;</span>
<span class="lineNum">    1576 </span>            : 
<span class="lineNum">    1577 </span><span class="lineCov">         39 :                 if (alloc_playback_chan(conference)) {</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :                         ao2_unlink(conference_bridges, conference);</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Could not allocate announcer channel for conference '%s'\n&quot;, conference_name);</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1583 </span>            :                 }
<span class="lineNum">    1584 </span>            : 
<span class="lineNum">    1585 </span><span class="lineCov">         39 :                 if (push_announcer(conference)) {</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                         ao2_unlink(conference_bridges, conference);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Could not add announcer channel for conference '%s' bridge\n&quot;, conference_name);</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1591 </span>            :                 }
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span><span class="lineCov">         39 :                 if (ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_RECORD_CONFERENCE)) {</span>
<span class="lineNum">    1594 </span><span class="lineCov">          3 :                         ao2_lock(conference);</span>
<span class="lineNum">    1595 </span><span class="lineCov">          3 :                         conf_start_record(conference);</span>
<span class="lineNum">    1596 </span><span class="lineCov">          3 :                         ao2_unlock(conference);</span>
<span class="lineNum">    1597 </span>            :                 }
<span class="lineNum">    1598 </span>            : 
<span class="lineNum">    1599 </span><span class="lineCov">         39 :                 send_conf_start_event(conference);</span>
<span class="lineNum">    1600 </span>            : 
<span class="lineNum">    1601 </span><span class="lineCov">         39 :                 if (!ast_strlen_zero(conference-&gt;b_profile.regcontext)) {</span>
<span class="lineNum">    1602 </span><span class="lineCov">          1 :                         if (!ast_exists_extension(NULL, conference-&gt;b_profile.regcontext, conference-&gt;name, 1, NULL)) {</span>
<span class="lineNum">    1603 </span><span class="lineCov">          1 :                                 ast_add_extension(conference-&gt;b_profile.regcontext, 1, conference-&gt;name, 1, NULL, NULL, &quot;Noop&quot;, NULL, NULL, &quot;ConfBridge&quot;);</span>
<span class="lineNum">    1604 </span>            :                         }
<span class="lineNum">    1605 </span>            :                 }
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span><span class="lineCov">         39 :                 ast_debug(1, &quot;Created conference '%s' and linked to container.\n&quot;, conference_name);</span>
<span class="lineNum">    1608 </span>            :         }
<span class="lineNum">    1609 </span>            : 
<span class="lineNum">    1610 </span><span class="lineCov">         82 :         ao2_unlock(conference_bridges);</span>
<span class="lineNum">    1611 </span>            : 
<span class="lineNum">    1612 </span>            :         /* Setup conference bridge user parameters */
<span class="lineNum">    1613 </span><span class="lineCov">         82 :         user-&gt;conference = conference;</span>
<span class="lineNum">    1614 </span>            : 
<span class="lineNum">    1615 </span><span class="lineCov">         82 :         ao2_lock(conference);</span>
<span class="lineNum">    1616 </span>            : 
<span class="lineNum">    1617 </span>            :         /* Determine if the new user should join the conference muted. */
<span class="lineNum">    1618 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_STARTMUTED)</span>
<span class="lineNum">    1619 </span><span class="lineCov">         72 :                 || (!ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN) &amp;&amp; conference-&gt;muted)) {</span>
<span class="lineNum">    1620 </span>            :                 /* Set user level mute request. */
<span class="lineNum">    1621 </span><span class="lineCov">         11 :                 user-&gt;muted = 1;</span>
<span class="lineNum">    1622 </span>            :         }
<span class="lineNum">    1623 </span>            : 
<span class="lineNum">    1624 </span>            :         /*
<span class="lineNum">    1625 </span>            :          * Suspend any MOH until the user actually joins the bridge of
<span class="lineNum">    1626 </span>            :          * the conference.  This way any pre-join file playback does not
<span class="lineNum">    1627 </span>            :          * need to worry about MOH.
<span class="lineNum">    1628 </span>            :          */
<span class="lineNum">    1629 </span><span class="lineCov">         82 :         user-&gt;suspended_moh = 1;</span>
<span class="lineNum">    1630 </span>            : 
<span class="lineNum">    1631 </span><span class="lineCov">         82 :         if (handle_conf_user_join(user)) {</span>
<span class="lineNum">    1632 </span>            :                 /* Invalid event, nothing was done, so we don't want to process a leave. */
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :                 user-&gt;conference = NULL;</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1637 </span>            :         }
<span class="lineNum">    1638 </span>            : 
<span class="lineNum">    1639 </span><span class="lineCov">         82 :         if (ast_check_hangup(user-&gt;chan)) {</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :                 leave_conference(user);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1643 </span>            :         }
<span class="lineNum">    1644 </span>            : 
<span class="lineNum">    1645 </span><span class="lineCov">         82 :         ao2_unlock(conference);</span>
<span class="lineNum">    1646 </span>            : 
<span class="lineNum">    1647 </span>            :         /* If an announcement is to be played play it */
<span class="lineNum">    1648 </span><span class="lineCov">         82 :         if (!ast_strlen_zero(user-&gt;u_profile.announcement)) {</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :                 if (play_prompt_to_user(user,</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :                         user-&gt;u_profile.announcement)) {</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :                         leave_conference(user);</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1653 </span>            :                 }
<span class="lineNum">    1654 </span>            :         }
<span class="lineNum">    1655 </span>            : 
<span class="lineNum">    1656 </span>            :         /* Announce number of users if need be */
<span class="lineNum">    1657 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ANNOUNCEUSERCOUNT)) {</span>
<span class="lineNum">    1658 </span><span class="lineCov">          2 :                 if (announce_user_count(conference, user, NULL)) {</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :                         leave_conference(user);</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1661 </span>            :                 }
<span class="lineNum">    1662 </span>            :         }
<span class="lineNum">    1663 </span>            : 
<span class="lineNum">    1664 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ANNOUNCEUSERCOUNTALL) &amp;&amp;</span>
<span class="lineNum">    1665 </span><span class="lineCov">          2 :                 (conference-&gt;activeusers &gt; user-&gt;u_profile.announce_user_count_all_after)) {</span>
<span class="lineNum">    1666 </span>            :                 int user_count_res;
<span class="lineNum">    1667 </span>            : 
<span class="lineNum">    1668 </span>            :                 /*
<span class="lineNum">    1669 </span>            :                  * We have to autoservice the new user because he has not quite
<span class="lineNum">    1670 </span>            :                  * joined the conference yet.
<span class="lineNum">    1671 </span>            :                  */
<span class="lineNum">    1672 </span><span class="lineCov">          2 :                 ast_autoservice_start(user-&gt;chan);</span>
<span class="lineNum">    1673 </span><span class="lineCov">          2 :                 user_count_res = announce_user_count(conference, NULL, NULL);</span>
<span class="lineNum">    1674 </span><span class="lineCov">          2 :                 ast_autoservice_stop(user-&gt;chan);</span>
<span class="lineNum">    1675 </span><span class="lineCov">          2 :                 if (user_count_res) {</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :                         leave_conference(user);</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1678 </span>            :                 }
<span class="lineNum">    1679 </span>            :         }
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span>            :         /* Handle post-join actions */
<span class="lineNum">    1682 </span><span class="lineCov">        129 :         while ((action = AST_LIST_REMOVE_HEAD(&amp;user-&gt;post_join_list, list))) {</span>
<span class="lineNum">    1683 </span><span class="lineCov">         47 :                 action-&gt;func(user);</span>
<span class="lineNum">    1684 </span><span class="lineCov">         47 :                 ast_free(action);</span>
<span class="lineNum">    1685 </span>            :         }
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span><span class="lineCov">         82 :         return conference;</span>
<span class="lineNum">    1688 </span>            : }
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span>            : /*!
<span class="lineNum">    1691 </span>            :  * \brief Leave a conference
<span class="lineNum">    1692 </span>            :  *
<a name="1693"><span class="lineNum">    1693 </span>            :  * \param user The conference user</a>
<span class="lineNum">    1694 </span>            :  */
<span class="lineNum">    1695 </span><span class="lineCov">         82 : static void leave_conference(struct confbridge_user *user)</span>
<span class="lineNum">    1696 </span>            : {
<span class="lineNum">    1697 </span>            :         struct post_join_action *action;
<span class="lineNum">    1698 </span>            : 
<span class="lineNum">    1699 </span><span class="lineCov">         82 :         ao2_lock(user-&gt;conference);</span>
<span class="lineNum">    1700 </span><span class="lineCov">         82 :         handle_conf_user_leave(user);</span>
<span class="lineNum">    1701 </span><span class="lineCov">         82 :         ao2_unlock(user-&gt;conference);</span>
<span class="lineNum">    1702 </span>            : 
<span class="lineNum">    1703 </span>            :         /* Discard any post-join actions */
<span class="lineNum">    1704 </span><span class="lineCov">         82 :         while ((action = AST_LIST_REMOVE_HEAD(&amp;user-&gt;post_join_list, list))) {</span>
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :                 ast_free(action);</span>
<span class="lineNum">    1706 </span>            :         }
<span class="lineNum">    1707 </span>            : 
<span class="lineNum">    1708 </span>            :         /* Done mucking with the conference, huzzah */
<span class="lineNum">    1709 </span><span class="lineCov">         82 :         ao2_ref(user-&gt;conference, -1);</span>
<span class="lineNum">    1710 </span><span class="lineCov">         82 :         user-&gt;conference = NULL;</span>
<a name="1711"><span class="lineNum">    1711 </span><span class="lineCov">         82 : }</span></a>
<span class="lineNum">    1712 </span>            : 
<span class="lineNum">    1713 </span><span class="lineCov">        165 : static void playback_common(struct confbridge_conference *conference, const char *filename, int say_number)</span>
<span class="lineNum">    1714 </span>            : {
<span class="lineNum">    1715 </span>            :         /* Don't try to play if the playback channel has been hung up */
<span class="lineNum">    1716 </span><span class="lineCov">        165 :         if (!conference-&gt;playback_chan) {</span>
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1718 </span>            :         }
<span class="lineNum">    1719 </span>            : 
<span class="lineNum">    1720 </span><span class="lineCov">        165 :         ast_autoservice_stop(conference-&gt;playback_chan);</span>
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span>            :         /* The channel is all under our control, in goes the prompt */
<span class="lineNum">    1723 </span><span class="lineCov">        165 :         if (!ast_strlen_zero(filename)) {</span>
<span class="lineNum">    1724 </span><span class="lineCov">        163 :                 ast_stream_and_wait(conference-&gt;playback_chan, filename, &quot;&quot;);</span>
<span class="lineNum">    1725 </span><span class="lineCov">          2 :         } else if (say_number &gt;= 0) {</span>
<span class="lineNum">    1726 </span><span class="lineCov">          2 :                 ast_say_number(conference-&gt;playback_chan, say_number, &quot;&quot;,</span>
<span class="lineNum">    1727 </span><span class="lineCov">          2 :                         ast_channel_language(conference-&gt;playback_chan), NULL);</span>
<span class="lineNum">    1728 </span>            :         }
<span class="lineNum">    1729 </span>            : 
<span class="lineNum">    1730 </span><span class="lineCov">        165 :         ast_autoservice_start(conference-&gt;playback_chan);</span>
<span class="lineNum">    1731 </span>            : }
<span class="lineNum">    1732 </span>            : 
<span class="lineNum">    1733 </span>            : struct playback_task_data {
<span class="lineNum">    1734 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    1735 </span>            :         const char *filename;
<span class="lineNum">    1736 </span>            :         int say_number;
<span class="lineNum">    1737 </span>            :         int playback_finished;
<span class="lineNum">    1738 </span>            :         ast_mutex_t lock;
<span class="lineNum">    1739 </span>            :         ast_cond_t cond;
<span class="lineNum">    1740 </span>            : };
<span class="lineNum">    1741 </span>            : 
<span class="lineNum">    1742 </span>            : /*!
<span class="lineNum">    1743 </span>            :  * \brief Play an announcement into a confbridge
<span class="lineNum">    1744 </span>            :  *
<span class="lineNum">    1745 </span>            :  * This runs in the playback queue taskprocessor. This ensures that
<span class="lineNum">    1746 </span>            :  * all playbacks are handled in sequence and do not play over top one
<span class="lineNum">    1747 </span>            :  * another.
<span class="lineNum">    1748 </span>            :  *
<span class="lineNum">    1749 </span>            :  * This task runs synchronously so there is no need for performing any
<span class="lineNum">    1750 </span>            :  * sort of cleanup on the input parameter.
<span class="lineNum">    1751 </span>            :  *
<span class="lineNum">    1752 </span>            :  * \param data A playback_task_data
<a name="1753"><span class="lineNum">    1753 </span>            :  * \return 0</a>
<span class="lineNum">    1754 </span>            :  */
<span class="lineNum">    1755 </span><span class="lineCov">         16 : static int playback_task(void *data)</span>
<span class="lineNum">    1756 </span>            : {
<span class="lineNum">    1757 </span><span class="lineCov">         16 :         struct playback_task_data *ptd = data;</span>
<span class="lineNum">    1758 </span>            : 
<span class="lineNum">    1759 </span><span class="lineCov">         16 :         playback_common(ptd-&gt;conference, ptd-&gt;filename, ptd-&gt;say_number);</span>
<span class="lineNum">    1760 </span>            : 
<span class="lineNum">    1761 </span><span class="lineCov">         16 :         ast_mutex_lock(&amp;ptd-&gt;lock);</span>
<span class="lineNum">    1762 </span><span class="lineCov">         16 :         ptd-&gt;playback_finished = 1;</span>
<span class="lineNum">    1763 </span><span class="lineCov">         16 :         ast_cond_signal(&amp;ptd-&gt;cond);</span>
<span class="lineNum">    1764 </span><span class="lineCov">         16 :         ast_mutex_unlock(&amp;ptd-&gt;lock);</span>
<span class="lineNum">    1765 </span>            : 
<span class="lineNum">    1766 </span><span class="lineCov">         16 :         return 0;</span>
<a name="1767"><span class="lineNum">    1767 </span>            : }</a>
<span class="lineNum">    1768 </span>            : 
<span class="lineNum">    1769 </span><span class="lineCov">         16 : static void playback_task_data_init(struct playback_task_data *ptd, struct confbridge_conference *conference,</span>
<span class="lineNum">    1770 </span>            :                 const char *filename, int say_number)
<span class="lineNum">    1771 </span>            : {
<span class="lineNum">    1772 </span><span class="lineCov">         16 :         ast_mutex_init(&amp;ptd-&gt;lock);</span>
<span class="lineNum">    1773 </span><span class="lineCov">         16 :         ast_cond_init(&amp;ptd-&gt;cond, NULL);</span>
<span class="lineNum">    1774 </span>            : 
<span class="lineNum">    1775 </span><span class="lineCov">         16 :         ptd-&gt;filename = filename;</span>
<span class="lineNum">    1776 </span><span class="lineCov">         16 :         ptd-&gt;say_number = say_number;</span>
<span class="lineNum">    1777 </span><span class="lineCov">         16 :         ptd-&gt;conference = conference;</span>
<span class="lineNum">    1778 </span><span class="lineCov">         16 :         ptd-&gt;playback_finished = 0;</span>
<a name="1779"><span class="lineNum">    1779 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">    1780 </span>            : 
<span class="lineNum">    1781 </span><span class="lineCov">         16 : static void playback_task_data_destroy(struct playback_task_data *ptd)</span>
<span class="lineNum">    1782 </span>            : {
<span class="lineNum">    1783 </span><span class="lineCov">         16 :         ast_mutex_destroy(&amp;ptd-&gt;lock);</span>
<span class="lineNum">    1784 </span><span class="lineCov">         16 :         ast_cond_destroy(&amp;ptd-&gt;cond);</span>
<a name="1785"><span class="lineNum">    1785 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">    1786 </span>            : 
<span class="lineNum">    1787 </span><span class="lineCov">         16 : static int play_sound_helper(struct confbridge_conference *conference, const char *filename, int say_number)</span>
<span class="lineNum">    1788 </span>            : {
<span class="lineNum">    1789 </span>            :         struct playback_task_data ptd;
<span class="lineNum">    1790 </span>            : 
<span class="lineNum">    1791 </span>            :         /* Do not waste resources trying to play files that do not exist */
<span class="lineNum">    1792 </span><span class="lineCov">         16 :         if (ast_strlen_zero(filename)) {</span>
<span class="lineNum">    1793 </span><span class="lineCov">          2 :                 if (say_number &lt; 0) {</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">    1795 </span>            :                 }
<span class="lineNum">    1796 </span><span class="lineCov">         14 :         } else if (!sound_file_exists(filename)) {</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    1798 </span>            :         }
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span><span class="lineCov">         16 :         playback_task_data_init(&amp;ptd, conference, filename, say_number);</span>
<span class="lineNum">    1801 </span><span class="lineCov">         16 :         if (ast_taskprocessor_push(conference-&gt;playback_queue, playback_task, &amp;ptd)) {</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(filename)) {</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Unable to play file '%s' to conference %s\n&quot;,</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :                                 filename, conference-&gt;name);</span>
<span class="lineNum">    1805 </span>            :                 } else {
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Unable to say number '%d' to conference %s\n&quot;,</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :                                 say_number, conference-&gt;name);</span>
<span class="lineNum">    1808 </span>            :                 }
<span class="lineNum">    1809 </span><span class="lineNoCov">          0 :                 playback_task_data_destroy(&amp;ptd);</span>
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1811 </span>            :         }
<span class="lineNum">    1812 </span>            : 
<span class="lineNum">    1813 </span>            :         /* Wait for the playback to complete */
<span class="lineNum">    1814 </span><span class="lineCov">         16 :         ast_mutex_lock(&amp;ptd.lock);</span>
<span class="lineNum">    1815 </span><span class="lineCov">         32 :         while (!ptd.playback_finished) {</span>
<span class="lineNum">    1816 </span><span class="lineCov">         16 :                 ast_cond_wait(&amp;ptd.cond, &amp;ptd.lock);</span>
<span class="lineNum">    1817 </span>            :         }
<span class="lineNum">    1818 </span><span class="lineCov">         16 :         ast_mutex_unlock(&amp;ptd.lock);</span>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span><span class="lineCov">         16 :         playback_task_data_destroy(&amp;ptd);</span>
<span class="lineNum">    1821 </span>            : 
<span class="lineNum">    1822 </span><span class="lineCov">         16 :         return 0;</span>
<a name="1823"><span class="lineNum">    1823 </span>            : }</a>
<span class="lineNum">    1824 </span>            : 
<span class="lineNum">    1825 </span><span class="lineCov">         14 : int play_sound_file(struct confbridge_conference *conference, const char *filename)</span>
<span class="lineNum">    1826 </span>            : {
<span class="lineNum">    1827 </span><span class="lineCov">         14 :         return play_sound_helper(conference, filename, -1);</span>
<span class="lineNum">    1828 </span>            : }
<span class="lineNum">    1829 </span>            : 
<span class="lineNum">    1830 </span>            : struct async_playback_task_data {
<span class="lineNum">    1831 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    1832 </span>            :         int say_number;
<span class="lineNum">    1833 </span>            :         struct ast_channel *initiator;
<span class="lineNum">    1834 </span>            :         char filename[0];
<span class="lineNum">    1835 </span>            : };
<span class="lineNum">    1836 </span>            : 
<span class="lineNum">    1837 </span>            : struct async_datastore_data {
<span class="lineNum">    1838 </span>            :         ast_mutex_t lock;
<span class="lineNum">    1839 </span>            :         ast_cond_t cond;
<span class="lineNum">    1840 </span>            :         int wait;
<a name="1841"><span class="lineNum">    1841 </span>            : };</a>
<span class="lineNum">    1842 </span>            : 
<span class="lineNum">    1843 </span><span class="lineCov">         66 : static void async_datastore_data_destroy(void *data)</span>
<span class="lineNum">    1844 </span>            : {
<span class="lineNum">    1845 </span><span class="lineCov">         66 :         struct async_datastore_data *add = data;</span>
<span class="lineNum">    1846 </span>            : 
<span class="lineNum">    1847 </span><span class="lineCov">         66 :         ast_mutex_destroy(&amp;add-&gt;lock);</span>
<span class="lineNum">    1848 </span><span class="lineCov">         66 :         ast_cond_destroy(&amp;add-&gt;cond);</span>
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineCov">         66 :         ast_free(add);</span>
<span class="lineNum">    1851 </span><span class="lineCov">         66 : }</span>
<span class="lineNum">    1852 </span>            : 
<span class="lineNum">    1853 </span>            : /*!
<span class="lineNum">    1854 </span>            :  * \brief Datastore used for timing of async announcement playback
<span class="lineNum">    1855 </span>            :  *
<span class="lineNum">    1856 </span>            :  * Announcements that are played to the entire conference can be played
<span class="lineNum">    1857 </span>            :  * asynchronously (i.e. The channel that queues the playback does not wait
<span class="lineNum">    1858 </span>            :  * for the playback to complete before continuing)
<span class="lineNum">    1859 </span>            :  *
<span class="lineNum">    1860 </span>            :  * The thing about async announcements is that the channel that queues the
<span class="lineNum">    1861 </span>            :  * announcement is either not in the bridge or is in some other way &quot;occupied&quot;
<span class="lineNum">    1862 </span>            :  * at the time the announcement is queued. Because of that, the initiator of
<span class="lineNum">    1863 </span>            :  * the announcement may enter after the announcement has already started,
<span class="lineNum">    1864 </span>            :  * resulting in the sound being &quot;clipped&quot;.
<span class="lineNum">    1865 </span>            :  *
<span class="lineNum">    1866 </span>            :  * This datastore makes it so that the channel that queues the async announcement
<span class="lineNum">    1867 </span>            :  * can say &quot;I'm ready now&quot;. This way the announcement does not start until the
<span class="lineNum">    1868 </span>            :  * initiator of the announcement is ready to hear the sound.
<span class="lineNum">    1869 </span>            :  */
<span class="lineNum">    1870 </span>            : static struct ast_datastore_info async_datastore_info = {
<span class="lineNum">    1871 </span>            :         .type = &quot;Confbridge async playback&quot;,
<span class="lineNum">    1872 </span>            :         .destroy = async_datastore_data_destroy,
<a name="1873"><span class="lineNum">    1873 </span>            : };</a>
<span class="lineNum">    1874 </span>            : 
<span class="lineNum">    1875 </span><span class="lineCov">         66 : static struct async_datastore_data *async_datastore_data_alloc(void)</span>
<span class="lineNum">    1876 </span>            : {
<span class="lineNum">    1877 </span>            :         struct async_datastore_data *add;
<span class="lineNum">    1878 </span>            : 
<span class="lineNum">    1879 </span><span class="lineCov">         66 :         add = ast_malloc(sizeof(*add));</span>
<span class="lineNum">    1880 </span><span class="lineCov">         66 :         if (!add) {</span>
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1882 </span>            :         }
<span class="lineNum">    1883 </span>            : 
<span class="lineNum">    1884 </span><span class="lineCov">         66 :         ast_mutex_init(&amp;add-&gt;lock);</span>
<span class="lineNum">    1885 </span><span class="lineCov">         66 :         ast_cond_init(&amp;add-&gt;cond, NULL);</span>
<span class="lineNum">    1886 </span><span class="lineCov">         66 :         add-&gt;wait = 1;</span>
<span class="lineNum">    1887 </span>            : 
<span class="lineNum">    1888 </span><span class="lineCov">         66 :         return add;</span>
<span class="lineNum">    1889 </span>            : }
<span class="lineNum">    1890 </span>            : 
<span class="lineNum">    1891 </span>            : /*!
<span class="lineNum">    1892 </span>            :  * \brief Prepare the async playback datastore
<span class="lineNum">    1893 </span>            :  *
<span class="lineNum">    1894 </span>            :  * This is done prior to queuing an async announcement. If the
<span class="lineNum">    1895 </span>            :  * datastore has not yet been created, it is allocated and initialized.
<span class="lineNum">    1896 </span>            :  * If it already exists, we set it to be in &quot;waiting&quot; mode.
<span class="lineNum">    1897 </span>            :  *
<span class="lineNum">    1898 </span>            :  * \param initiator The channel that is queuing the async playback
<span class="lineNum">    1899 </span>            :  * \retval 0 Success
<a name="1900"><span class="lineNum">    1900 </span>            :  * \retval -1 Failure :(</a>
<span class="lineNum">    1901 </span>            :  */
<span class="lineNum">    1902 </span><span class="lineCov">         67 : static int setup_async_playback_datastore(struct ast_channel *initiator)</span>
<span class="lineNum">    1903 </span>            : {
<span class="lineNum">    1904 </span>            :         struct ast_datastore *async_datastore;
<span class="lineNum">    1905 </span>            : 
<span class="lineNum">    1906 </span><span class="lineCov">         67 :         async_datastore = ast_channel_datastore_find(initiator, &amp;async_datastore_info, NULL);</span>
<span class="lineNum">    1907 </span><span class="lineCov">         67 :         if (async_datastore) {</span>
<span class="lineNum">    1908 </span>            :                 struct async_datastore_data *add;
<span class="lineNum">    1909 </span>            : 
<span class="lineNum">    1910 </span><span class="lineCov">          1 :                 add = async_datastore-&gt;data;</span>
<span class="lineNum">    1911 </span><span class="lineCov">          1 :                 add-&gt;wait = 1;</span>
<span class="lineNum">    1912 </span>            : 
<span class="lineNum">    1913 </span><span class="lineCov">          1 :                 return 0;</span>
<span class="lineNum">    1914 </span>            :         }
<span class="lineNum">    1915 </span>            : 
<span class="lineNum">    1916 </span><span class="lineCov">         66 :         async_datastore = ast_datastore_alloc(&amp;async_datastore_info, NULL);</span>
<span class="lineNum">    1917 </span><span class="lineCov">         66 :         if (!async_datastore) {</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1919 </span>            :         }
<span class="lineNum">    1920 </span>            : 
<span class="lineNum">    1921 </span><span class="lineCov">         66 :         async_datastore-&gt;data = async_datastore_data_alloc();</span>
<span class="lineNum">    1922 </span><span class="lineCov">         66 :         if (!async_datastore-&gt;data) {</span>
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :                 ast_datastore_free(async_datastore);</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1925 </span>            :         }
<span class="lineNum">    1926 </span>            : 
<span class="lineNum">    1927 </span><span class="lineCov">         66 :         ast_channel_datastore_add(initiator, async_datastore);</span>
<span class="lineNum">    1928 </span><span class="lineCov">         66 :         return 0;</span>
<a name="1929"><span class="lineNum">    1929 </span>            : }</a>
<span class="lineNum">    1930 </span>            : 
<span class="lineNum">    1931 </span><span class="lineCov">        149 : static struct async_playback_task_data *async_playback_task_data_alloc(</span>
<span class="lineNum">    1932 </span>            :         struct confbridge_conference *conference, const char *filename, int say_number,
<span class="lineNum">    1933 </span>            :         struct ast_channel *initiator)
<span class="lineNum">    1934 </span>            : {
<span class="lineNum">    1935 </span>            :         struct async_playback_task_data *aptd;
<span class="lineNum">    1936 </span>            : 
<span class="lineNum">    1937 </span><span class="lineCov">        149 :         aptd = ast_malloc(sizeof(*aptd) + strlen(filename) + 1);</span>
<span class="lineNum">    1938 </span><span class="lineCov">        149 :         if (!aptd) {</span>
<span class="lineNum">    1939 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1940 </span>            :         }
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span>            :         /* Safe */
<span class="lineNum">    1943 </span><span class="lineCov">        149 :         strcpy(aptd-&gt;filename, filename);</span>
<span class="lineNum">    1944 </span><span class="lineCov">        149 :         aptd-&gt;say_number = say_number;</span>
<span class="lineNum">    1945 </span>            : 
<span class="lineNum">    1946 </span>            :         /* You may think that we need to bump the conference refcount since we are pushing
<span class="lineNum">    1947 </span>            :          * this task to the taskprocessor.
<span class="lineNum">    1948 </span>            :          *
<span class="lineNum">    1949 </span>            :          * In this case, that actually causes a problem. The destructor for the conference
<span class="lineNum">    1950 </span>            :          * pushes a hangup task into the taskprocessor and waits for it to complete before
<span class="lineNum">    1951 </span>            :          * continuing. If the destructor gets called from a taskprocessor task, we're
<span class="lineNum">    1952 </span>            :          * deadlocked.
<span class="lineNum">    1953 </span>            :          *
<span class="lineNum">    1954 </span>            :          * So is there a risk of the conference being freed out from under us? No. Since
<span class="lineNum">    1955 </span>            :          * the destructor pushes a task into the taskprocessor and waits for it to complete,
<span class="lineNum">    1956 </span>            :          * the destructor cannot free the conference out from under us. No further tasks
<span class="lineNum">    1957 </span>            :          * can be queued onto the taskprocessor after the hangup since no channels are referencing
<span class="lineNum">    1958 </span>            :          * the conference at that point any more.
<span class="lineNum">    1959 </span>            :          */
<span class="lineNum">    1960 </span><span class="lineCov">        149 :         aptd-&gt;conference = conference;</span>
<span class="lineNum">    1961 </span>            : 
<span class="lineNum">    1962 </span><span class="lineCov">        149 :         aptd-&gt;initiator = initiator;</span>
<span class="lineNum">    1963 </span><span class="lineCov">        149 :         if (initiator) {</span>
<span class="lineNum">    1964 </span><span class="lineCov">         67 :                 ast_channel_ref(initiator);</span>
<span class="lineNum">    1965 </span><span class="lineCov">         67 :                 ast_channel_lock(aptd-&gt;initiator);</span>
<span class="lineNum">    1966 </span>            :                 /* We don't really care if this fails. If the datastore fails to get set up
<span class="lineNum">    1967 </span>            :                  * we'll still play the announcement. It's possible that the sound will be
<span class="lineNum">    1968 </span>            :                  * clipped for the initiator, but that's not the end of the world.
<span class="lineNum">    1969 </span>            :                  */
<span class="lineNum">    1970 </span><span class="lineCov">         67 :                 setup_async_playback_datastore(aptd-&gt;initiator);</span>
<span class="lineNum">    1971 </span><span class="lineCov">         67 :                 ast_channel_unlock(aptd-&gt;initiator);</span>
<span class="lineNum">    1972 </span>            :         }
<span class="lineNum">    1973 </span>            : 
<span class="lineNum">    1974 </span><span class="lineCov">        149 :         return aptd;</span>
<a name="1975"><span class="lineNum">    1975 </span>            : }</a>
<span class="lineNum">    1976 </span>            : 
<span class="lineNum">    1977 </span><span class="lineCov">        149 : static void async_playback_task_data_destroy(struct async_playback_task_data *aptd)</span>
<span class="lineNum">    1978 </span>            : {
<span class="lineNum">    1979 </span><span class="lineCov">        149 :         ast_channel_cleanup(aptd-&gt;initiator);</span>
<span class="lineNum">    1980 </span><span class="lineCov">        149 :         ast_free(aptd);</span>
<span class="lineNum">    1981 </span><span class="lineCov">        149 : }</span>
<span class="lineNum">    1982 </span>            : 
<span class="lineNum">    1983 </span>            : /*!
<span class="lineNum">    1984 </span>            :  * \brief Wait for the initiator of an async playback to be ready
<span class="lineNum">    1985 </span>            :  *
<span class="lineNum">    1986 </span>            :  * See the description on the async_datastore_info structure for more
<span class="lineNum">    1987 </span>            :  * information about what this is about.
<span class="lineNum">    1988 </span>            :  *
<a name="1989"><span class="lineNum">    1989 </span>            :  * \param initiator The channel that queued the async announcement</a>
<span class="lineNum">    1990 </span>            :  */
<span class="lineNum">    1991 </span><span class="lineCov">         67 : static void wait_for_initiator(struct ast_channel *initiator)</span>
<span class="lineNum">    1992 </span>            : {
<span class="lineNum">    1993 </span>            :         struct ast_datastore *async_datastore;
<span class="lineNum">    1994 </span>            :         struct async_datastore_data *add;
<span class="lineNum">    1995 </span>            : 
<span class="lineNum">    1996 </span><span class="lineCov">         67 :         ast_channel_lock(initiator);</span>
<span class="lineNum">    1997 </span><span class="lineCov">         67 :         async_datastore = ast_channel_datastore_find(initiator, &amp;async_datastore_info, NULL);</span>
<span class="lineNum">    1998 </span><span class="lineCov">         67 :         ast_channel_unlock(initiator);</span>
<span class="lineNum">    1999 </span>            : 
<span class="lineNum">    2000 </span><span class="lineCov">         67 :         if (!async_datastore) {</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    2002 </span>            :         }
<span class="lineNum">    2003 </span>            : 
<span class="lineNum">    2004 </span><span class="lineCov">         67 :         add = async_datastore-&gt;data;</span>
<span class="lineNum">    2005 </span>            : 
<span class="lineNum">    2006 </span><span class="lineCov">         67 :         ast_mutex_lock(&amp;add-&gt;lock);</span>
<span class="lineNum">    2007 </span><span class="lineCov">        126 :         while (add-&gt;wait) {</span>
<span class="lineNum">    2008 </span><span class="lineCov">         59 :                 ast_cond_wait(&amp;add-&gt;cond, &amp;add-&gt;lock);</span>
<span class="lineNum">    2009 </span>            :         }
<span class="lineNum">    2010 </span><span class="lineCov">         67 :         ast_mutex_unlock(&amp;add-&gt;lock);</span>
<span class="lineNum">    2011 </span>            : }
<span class="lineNum">    2012 </span>            : 
<span class="lineNum">    2013 </span>            : /*!
<span class="lineNum">    2014 </span>            :  * \brief Play an announcement into a confbridge asynchronously
<span class="lineNum">    2015 </span>            :  *
<span class="lineNum">    2016 </span>            :  * This runs in the playback queue taskprocessor. This ensures that
<span class="lineNum">    2017 </span>            :  * all playbacks are handled in sequence and do not play over top one
<span class="lineNum">    2018 </span>            :  * another.
<span class="lineNum">    2019 </span>            :  *
<span class="lineNum">    2020 </span>            :  * \param data An async_playback_task_data
<a name="2021"><span class="lineNum">    2021 </span>            :  * \return 0</a>
<span class="lineNum">    2022 </span>            :  */
<span class="lineNum">    2023 </span><span class="lineCov">        149 : static int async_playback_task(void *data)</span>
<span class="lineNum">    2024 </span>            : {
<span class="lineNum">    2025 </span><span class="lineCov">        149 :         struct async_playback_task_data *aptd = data;</span>
<span class="lineNum">    2026 </span>            : 
<span class="lineNum">    2027 </span>            :         /* Wait for the initiator to get back in the bridge or be hung up */
<span class="lineNum">    2028 </span><span class="lineCov">        149 :         if (aptd-&gt;initiator) {</span>
<span class="lineNum">    2029 </span><span class="lineCov">         67 :                 wait_for_initiator(aptd-&gt;initiator);</span>
<span class="lineNum">    2030 </span>            :         }
<span class="lineNum">    2031 </span>            : 
<span class="lineNum">    2032 </span><span class="lineCov">        149 :         playback_common(aptd-&gt;conference, aptd-&gt;filename, aptd-&gt;say_number);</span>
<span class="lineNum">    2033 </span>            : 
<span class="lineNum">    2034 </span><span class="lineCov">        149 :         async_playback_task_data_destroy(aptd);</span>
<span class="lineNum">    2035 </span><span class="lineCov">        149 :         return 0;</span>
<a name="2036"><span class="lineNum">    2036 </span>            : }</a>
<span class="lineNum">    2037 </span>            : 
<span class="lineNum">    2038 </span><span class="lineCov">        149 : static int async_play_sound_helper(struct confbridge_conference *conference,</span>
<span class="lineNum">    2039 </span>            :         const char *filename, int say_number, struct ast_channel *initiator)
<span class="lineNum">    2040 </span>            : {
<span class="lineNum">    2041 </span>            :         struct async_playback_task_data *aptd;
<span class="lineNum">    2042 </span>            : 
<span class="lineNum">    2043 </span>            :         /* Do not waste resources trying to play files that do not exist */
<span class="lineNum">    2044 </span><span class="lineCov">        149 :         if (ast_strlen_zero(filename)) {</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :                 if (say_number &lt; 0) {</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">    2047 </span>            :                 }
<span class="lineNum">    2048 </span><span class="lineCov">        149 :         } else if (!sound_file_exists(filename)) {</span>
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2050 </span>            :         }
<span class="lineNum">    2051 </span>            : 
<span class="lineNum">    2052 </span><span class="lineCov">        149 :         aptd = async_playback_task_data_alloc(conference, filename, say_number, initiator);</span>
<span class="lineNum">    2053 </span><span class="lineCov">        149 :         if (!aptd) {</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2055 </span>            :         }
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span><span class="lineCov">        149 :         if (ast_taskprocessor_push(conference-&gt;playback_queue, async_playback_task, aptd)) {</span>
<span class="lineNum">    2058 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(filename)) {</span>
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Unable to play file '%s' to conference '%s'\n&quot;,</span>
<span class="lineNum">    2060 </span><span class="lineNoCov">          0 :                                 filename, conference-&gt;name);</span>
<span class="lineNum">    2061 </span>            :                 } else {
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Unable to say number '%d' to conference '%s'\n&quot;,</span>
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :                                 say_number, conference-&gt;name);</span>
<span class="lineNum">    2064 </span>            :                 }
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :                 async_playback_task_data_destroy(aptd);</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2067 </span>            :         }
<span class="lineNum">    2068 </span>            : 
<span class="lineNum">    2069 </span><span class="lineCov">        149 :         return 0;</span>
<a name="2070"><span class="lineNum">    2070 </span>            : }</a>
<span class="lineNum">    2071 </span>            : 
<span class="lineNum">    2072 </span><span class="lineCov">        149 : int async_play_sound_file(struct confbridge_conference *conference,</span>
<span class="lineNum">    2073 </span>            :         const char *filename, struct ast_channel *initiator)
<span class="lineNum">    2074 </span>            : {
<span class="lineNum">    2075 </span><span class="lineCov">        149 :         return async_play_sound_helper(conference, filename, -1, initiator);</span>
<a name="2076"><span class="lineNum">    2076 </span>            : }</a>
<span class="lineNum">    2077 </span>            : 
<span class="lineNum">    2078 </span><span class="lineCov">        178 : void async_play_sound_ready(struct ast_channel *chan)</span>
<span class="lineNum">    2079 </span>            : {
<span class="lineNum">    2080 </span>            :         struct ast_datastore *async_datastore;
<span class="lineNum">    2081 </span>            :         struct async_datastore_data *add;
<span class="lineNum">    2082 </span>            : 
<span class="lineNum">    2083 </span><span class="lineCov">        178 :         ast_channel_lock(chan);</span>
<span class="lineNum">    2084 </span><span class="lineCov">        178 :         async_datastore = ast_channel_datastore_find(chan, &amp;async_datastore_info, NULL);</span>
<span class="lineNum">    2085 </span><span class="lineCov">        178 :         ast_channel_unlock(chan);</span>
<span class="lineNum">    2086 </span><span class="lineCov">        178 :         if (!async_datastore) {</span>
<span class="lineNum">    2087 </span><span class="lineCov">         32 :                 return;</span>
<span class="lineNum">    2088 </span>            :         }
<span class="lineNum">    2089 </span>            : 
<span class="lineNum">    2090 </span><span class="lineCov">        146 :         add = async_datastore-&gt;data;</span>
<span class="lineNum">    2091 </span>            : 
<span class="lineNum">    2092 </span><span class="lineCov">        146 :         ast_mutex_lock(&amp;add-&gt;lock);</span>
<span class="lineNum">    2093 </span><span class="lineCov">        146 :         add-&gt;wait = 0;</span>
<span class="lineNum">    2094 </span><span class="lineCov">        146 :         ast_cond_signal(&amp;add-&gt;cond);</span>
<span class="lineNum">    2095 </span><span class="lineCov">        146 :         ast_mutex_unlock(&amp;add-&gt;lock);</span>
<span class="lineNum">    2096 </span>            : }
<span class="lineNum">    2097 </span>            : 
<span class="lineNum">    2098 </span>            : /*!
<span class="lineNum">    2099 </span>            :  * \brief Play number into the conference bridge
<span class="lineNum">    2100 </span>            :  *
<span class="lineNum">    2101 </span>            :  * \param conference The conference bridge to say the number into
<span class="lineNum">    2102 </span>            :  * \param say_number number to say
<span class="lineNum">    2103 </span>            :  *
<span class="lineNum">    2104 </span>            :  * \retval 0 success
<a name="2105"><span class="lineNum">    2105 </span>            :  * \retval -1 failure</a>
<span class="lineNum">    2106 </span>            :  */
<span class="lineNum">    2107 </span><span class="lineCov">          2 : static int play_sound_number(struct confbridge_conference *conference, int say_number)</span>
<span class="lineNum">    2108 </span>            : {
<span class="lineNum">    2109 </span><span class="lineCov">          2 :         return play_sound_helper(conference, NULL, say_number);</span>
<a name="2110"><span class="lineNum">    2110 </span>            : }</a>
<span class="lineNum">    2111 </span>            : 
<span class="lineNum">    2112 </span><span class="lineCov">          6 : static int conf_handle_talker_cb(struct ast_bridge_channel *bridge_channel, void *hook_pvt, int talking)</span>
<a name="2113"><span class="lineNum">    2113 </span>            : {</a>
<span class="lineNum">    2114 </span><span class="lineCov">          6 :         struct confbridge_user *user = hook_pvt;</span>
<span class="lineNum">    2115 </span><span class="lineCov">         12 :         RAII_VAR(struct confbridge_conference *, conference, NULL, ao2_cleanup);</span>
<span class="lineNum">    2116 </span>            :         struct ast_json *talking_extras;
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span><span class="lineCov">          6 :         conference = ao2_find(conference_bridges, user-&gt;conference-&gt;name, OBJ_KEY);</span>
<span class="lineNum">    2119 </span><span class="lineCov">          6 :         if (!conference) {</span>
<span class="lineNum">    2120 </span>            :                 /* Remove the hook since the conference does not exist. */
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2122 </span>            :         }
<span class="lineNum">    2123 </span>            : 
<span class="lineNum">    2124 </span><span class="lineCov">          6 :         ao2_lock(conference);</span>
<span class="lineNum">    2125 </span><span class="lineCov">          6 :         user-&gt;talking = talking;</span>
<span class="lineNum">    2126 </span><span class="lineCov">          6 :         ao2_unlock(conference);</span>
<span class="lineNum">    2127 </span>            : 
<span class="lineNum">    2128 </span><span class="lineCov">          6 :         talking_extras = ast_json_pack(&quot;{s: s, s: b}&quot;,</span>
<span class="lineNum">    2129 </span>            :                 &quot;talking_status&quot;, talking ? &quot;on&quot; : &quot;off&quot;,
<span class="lineNum">    2130 </span><span class="lineCov">          6 :                 &quot;admin&quot;, ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN));</span>
<span class="lineNum">    2131 </span><span class="lineCov">          6 :         if (!talking_extras) {</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2133 </span>            :         }
<span class="lineNum">    2134 </span>            : 
<span class="lineNum">    2135 </span><span class="lineCov">          6 :         send_conf_stasis(conference, bridge_channel-&gt;chan, confbridge_talking_type(), talking_extras, 0);</span>
<span class="lineNum">    2136 </span><span class="lineCov">          6 :         ast_json_unref(talking_extras);</span>
<span class="lineNum">    2137 </span><span class="lineCov">          6 :         return 0;</span>
<a name="2138"><span class="lineNum">    2138 </span>            : }</a>
<span class="lineNum">    2139 </span>            : 
<span class="lineNum">    2140 </span><span class="lineCov">          2 : static int conf_get_pin(struct ast_channel *chan, struct confbridge_user *user)</span>
<span class="lineNum">    2141 </span>            : {
<span class="lineNum">    2142 </span><span class="lineCov">          2 :         char pin_guess[MAX_PIN+1] = { 0, };</span>
<span class="lineNum">    2143 </span><span class="lineCov">          2 :         const char *pin = user-&gt;u_profile.pin;</span>
<span class="lineNum">    2144 </span><span class="lineCov">          2 :         char *tmp = pin_guess;</span>
<span class="lineNum">    2145 </span>            :         int i, res;
<span class="lineNum">    2146 </span><span class="lineCov">          2 :         unsigned int len = MAX_PIN;</span>
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span>            :         /*
<span class="lineNum">    2149 </span>            :          * NOTE: We have not joined a conference yet so we have to use
<span class="lineNum">    2150 </span>            :          * the bridge profile requested by the user.
<span class="lineNum">    2151 </span>            :          */
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :         /* give them three tries to get the pin right */
<span class="lineNum">    2154 </span><span class="lineCov">          2 :         for (i = 0; i &lt; 3; i++) {</span>
<span class="lineNum">    2155 </span><span class="lineCov">          2 :                 if (ast_app_getdata(chan,</span>
<span class="lineNum">    2156 </span>            :                         conf_get_sound(CONF_SOUND_GET_PIN, user-&gt;b_profile.sounds),
<span class="lineNum">    2157 </span>            :                         tmp, len, 0) &gt;= 0) {
<span class="lineNum">    2158 </span><span class="lineCov">          2 :                         if (!strcasecmp(pin, pin_guess)) {</span>
<span class="lineNum">    2159 </span><span class="lineCov">          2 :                                 return 0;</span>
<span class="lineNum">    2160 </span>            :                         }
<span class="lineNum">    2161 </span>            :                 }
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :                 ast_streamfile(chan,</span>
<span class="lineNum">    2163 </span>            :                         conf_get_sound(CONF_SOUND_INVALID_PIN, user-&gt;b_profile.sounds),
<span class="lineNum">    2164 </span>            :                         ast_channel_language(chan));
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :                 res = ast_waitstream(chan, AST_DIGIT_ANY);</span>
<span class="lineNum">    2166 </span><span class="lineNoCov">          0 :                 if (res &gt; 0) {</span>
<span class="lineNum">    2167 </span>            :                         /* Account for digit already read during ivalid pin playback
<span class="lineNum">    2168 </span>            :                          * resetting pin buf. */
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :                         pin_guess[0] = res;</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :                         pin_guess[1] = '\0';</span>
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 :                         tmp = pin_guess + 1;</span>
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :                         len = MAX_PIN - 1;</span>
<span class="lineNum">    2173 </span>            :                 } else {
<span class="lineNum">    2174 </span>            :                         /* reset pin buf as empty buffer. */
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :                         tmp = pin_guess;</span>
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 :                         len = MAX_PIN;</span>
<span class="lineNum">    2177 </span>            :                 }
<span class="lineNum">    2178 </span>            :         }
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :         return -1;</span>
<a name="2180"><span class="lineNum">    2180 </span>            : }</a>
<span class="lineNum">    2181 </span>            : 
<span class="lineNum">    2182 </span><span class="lineCov">          2 : static int user_timeout(struct ast_bridge_channel *bridge_channel, void *ignore)</span>
<span class="lineNum">    2183 </span>            : {
<span class="lineNum">    2184 </span><span class="lineCov">          2 :         ast_bridge_channel_leave_bridge(bridge_channel, BRIDGE_CHANNEL_STATE_END, 0);</span>
<span class="lineNum">    2185 </span><span class="lineCov">          2 :         pbx_builtin_setvar_helper(bridge_channel-&gt;chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;TIMEOUT&quot;);</span>
<span class="lineNum">    2186 </span><span class="lineCov">          2 :         return -1;</span>
<a name="2187"><span class="lineNum">    2187 </span>            : }</a>
<span class="lineNum">    2188 </span>            : 
<span class="lineNum">    2189 </span><span class="lineCov">          2 : static int conf_rec_name(struct confbridge_user *user, const char *conf_name)</span>
<span class="lineNum">    2190 </span>            : {
<span class="lineNum">    2191 </span>            :         char destdir[PATH_MAX];
<span class="lineNum">    2192 </span>            :         int res;
<span class="lineNum">    2193 </span><span class="lineCov">          2 :         int duration = 20;</span>
<span class="lineNum">    2194 </span>            : 
<span class="lineNum">    2195 </span><span class="lineCov">          2 :         snprintf(destdir, sizeof(destdir), &quot;%s/confbridge&quot;, ast_config_AST_SPOOL_DIR);</span>
<span class="lineNum">    2196 </span>            : 
<span class="lineNum">    2197 </span><span class="lineCov">          2 :         if (ast_mkdir(destdir, 0777) != 0) {</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;mkdir '%s' failed: %s\n&quot;, destdir, strerror(errno));</span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2200 </span>            :         }
<span class="lineNum">    2201 </span><span class="lineCov">          4 :         snprintf(user-&gt;name_rec_location, sizeof(user-&gt;name_rec_location),</span>
<span class="lineNum">    2202 </span>            :                  &quot;%s/confbridge-name-%s-%s&quot;, destdir,
<span class="lineNum">    2203 </span><span class="lineCov">          2 :                  conf_name, ast_channel_uniqueid(user-&gt;chan));</span>
<span class="lineNum">    2204 </span>            : 
<span class="lineNum">    2205 </span><span class="lineCov">          2 :         if (!(ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ANNOUNCE_JOIN_LEAVE_REVIEW))) {</span>
<span class="lineNum">    2206 </span><span class="lineCov">          2 :                 res = ast_play_and_record(user-&gt;chan,</span>
<span class="lineNum">    2207 </span>            :                         &quot;vm-rec-name&quot;,
<span class="lineNum">    2208 </span><span class="lineCov">          2 :                         user-&gt;name_rec_location,</span>
<span class="lineNum">    2209 </span>            :                         10,
<span class="lineNum">    2210 </span>            :                         &quot;sln&quot;,
<span class="lineNum">    2211 </span>            :                         &amp;duration,
<span class="lineNum">    2212 </span>            :                         NULL,
<span class="lineNum">    2213 </span>            :                         ast_dsp_get_threshold_from_settings(THRESHOLD_SILENCE),
<span class="lineNum">    2214 </span>            :                         0,
<span class="lineNum">    2215 </span>            :                         NULL);
<span class="lineNum">    2216 </span>            :         } else {
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :                 res = ast_record_review(user-&gt;chan,</span>
<span class="lineNum">    2218 </span>            :                         &quot;vm-rec-name&quot;,
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :                         user-&gt;name_rec_location,</span>
<span class="lineNum">    2220 </span>            :                         10,
<span class="lineNum">    2221 </span>            :                         &quot;sln&quot;,
<span class="lineNum">    2222 </span>            :                         &amp;duration,
<span class="lineNum">    2223 </span>            :                         NULL);
<span class="lineNum">    2224 </span>            :         }
<span class="lineNum">    2225 </span>            : 
<span class="lineNum">    2226 </span><span class="lineCov">          2 :         if (res == -1) {</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :                 ast_filedelete(user-&gt;name_rec_location, NULL);</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :                 user-&gt;name_rec_location[0] = '\0';</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2230 </span>            :         }
<span class="lineNum">    2231 </span><span class="lineCov">          2 :         return 0;</span>
<span class="lineNum">    2232 </span>            : }
<span class="lineNum">    2233 </span>            : 
<span class="lineNum">    2234 </span>            : struct async_delete_name_rec_task_data {
<span class="lineNum">    2235 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    2236 </span>            :         char filename[0];
<a name="2237"><span class="lineNum">    2237 </span>            : };</a>
<span class="lineNum">    2238 </span>            : 
<span class="lineNum">    2239 </span><span class="lineCov">          2 : static struct async_delete_name_rec_task_data *async_delete_name_rec_task_data_alloc(</span>
<span class="lineNum">    2240 </span>            :         struct confbridge_conference *conference, const char *filename)
<span class="lineNum">    2241 </span>            : {
<span class="lineNum">    2242 </span>            :         struct async_delete_name_rec_task_data *atd;
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span><span class="lineCov">          2 :         atd = ast_malloc(sizeof(*atd) + strlen(filename) + 1);</span>
<span class="lineNum">    2245 </span><span class="lineCov">          2 :         if (!atd) {</span>
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2247 </span>            :         }
<span class="lineNum">    2248 </span>            : 
<span class="lineNum">    2249 </span>            :         /* Safe */
<span class="lineNum">    2250 </span><span class="lineCov">          2 :         strcpy(atd-&gt;filename, filename);</span>
<span class="lineNum">    2251 </span><span class="lineCov">          2 :         atd-&gt;conference = conference;</span>
<span class="lineNum">    2252 </span>            : 
<span class="lineNum">    2253 </span><span class="lineCov">          2 :         return atd;</span>
<a name="2254"><span class="lineNum">    2254 </span>            : }</a>
<span class="lineNum">    2255 </span>            : 
<span class="lineNum">    2256 </span><span class="lineCov">          2 : static void async_delete_name_rec_task_data_destroy(struct async_delete_name_rec_task_data *atd)</span>
<span class="lineNum">    2257 </span>            : {
<span class="lineNum">    2258 </span><span class="lineCov">          2 :         ast_free(atd);</span>
<span class="lineNum">    2259 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    2260 </span>            : 
<span class="lineNum">    2261 </span>            : /*!
<span class="lineNum">    2262 </span>            :  * \brief Delete user's name file asynchronously
<span class="lineNum">    2263 </span>            :  *
<span class="lineNum">    2264 </span>            :  * This runs in the playback queue taskprocessor. This ensures that
<span class="lineNum">    2265 </span>            :  * sound file is removed after playback is finished and not before.
<span class="lineNum">    2266 </span>            :  *
<span class="lineNum">    2267 </span>            :  * \param data An async_delete_name_rec_task_data
<a name="2268"><span class="lineNum">    2268 </span>            :  * \return 0</a>
<span class="lineNum">    2269 </span>            :  */
<span class="lineNum">    2270 </span><span class="lineCov">          2 : static int async_delete_name_rec_task(void *data)</span>
<span class="lineNum">    2271 </span>            : {
<span class="lineNum">    2272 </span><span class="lineCov">          2 :         struct async_delete_name_rec_task_data *atd = data;</span>
<span class="lineNum">    2273 </span>            : 
<span class="lineNum">    2274 </span><span class="lineCov">          2 :         ast_filedelete(atd-&gt;filename, NULL);</span>
<span class="lineNum">    2275 </span><span class="lineCov">          2 :         ast_log(LOG_DEBUG, &quot;Conference '%s' removed user name file '%s'\n&quot;,</span>
<span class="lineNum">    2276 </span><span class="lineCov">          2 :                 atd-&gt;conference-&gt;name, atd-&gt;filename);</span>
<span class="lineNum">    2277 </span>            : 
<span class="lineNum">    2278 </span><span class="lineCov">          2 :         async_delete_name_rec_task_data_destroy(atd);</span>
<span class="lineNum">    2279 </span><span class="lineCov">          2 :         return 0;</span>
<a name="2280"><span class="lineNum">    2280 </span>            : }</a>
<span class="lineNum">    2281 </span>            : 
<span class="lineNum">    2282 </span><span class="lineCov">          2 : static int async_delete_name_rec(struct confbridge_conference *conference,</span>
<span class="lineNum">    2283 </span>            :         const char *filename)
<span class="lineNum">    2284 </span>            : {
<span class="lineNum">    2285 </span>            :         struct async_delete_name_rec_task_data *atd;
<span class="lineNum">    2286 </span>            : 
<span class="lineNum">    2287 </span><span class="lineCov">          2 :         if (ast_strlen_zero(filename)) {</span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2289 </span><span class="lineCov">          2 :         } else if (!sound_file_exists(filename)) {</span>
<span class="lineNum">    2290 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2291 </span>            :         }
<span class="lineNum">    2292 </span>            : 
<span class="lineNum">    2293 </span><span class="lineCov">          2 :         atd = async_delete_name_rec_task_data_alloc(conference, filename);</span>
<span class="lineNum">    2294 </span><span class="lineCov">          2 :         if (!atd) {</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2296 </span>            :         }
<span class="lineNum">    2297 </span>            : 
<span class="lineNum">    2298 </span><span class="lineCov">          2 :         if (ast_taskprocessor_push(conference-&gt;playback_queue, async_delete_name_rec_task, atd)) {</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Conference '%s' was unable to remove user name file '%s'\n&quot;,</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :                         conference-&gt;name, filename);</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :                 async_delete_name_rec_task_data_destroy(atd);</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2303 </span>            :         }
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span><span class="lineCov">          2 :         return 0;</span>
<a name="2306"><span class="lineNum">    2306 </span>            : }</a>
<span class="lineNum">    2307 </span>            : 
<span class="lineNum">    2308 </span><span class="lineCov">         82 : static int join_callback(struct ast_bridge_channel *bridge_channel, void *ignore)</span>
<span class="lineNum">    2309 </span>            : {
<span class="lineNum">    2310 </span><span class="lineCov">         82 :         async_play_sound_ready(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2311 </span><span class="lineCov">         82 :         return 0;</span>
<span class="lineNum">    2312 </span>            : }
<a name="2313"><span class="lineNum">    2313 </span>            : </a>
<span class="lineNum">    2314 </span>            : /*! \brief The ConfBridge application */
<span class="lineNum">    2315 </span><span class="lineCov">         83 : static int confbridge_exec(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">    2316 </span>            : {
<span class="lineNum">    2317 </span><span class="lineCov">         83 :         int res = 0, volume_adjustments[2];</span>
<span class="lineNum">    2318 </span><span class="lineCov">         83 :         int quiet = 0;</span>
<span class="lineNum">    2319 </span><span class="lineCov">         83 :         int async_delete_task_pushed = 0;</span>
<span class="lineNum">    2320 </span>            :         char *parse;
<span class="lineNum">    2321 </span><span class="lineCov">         83 :         const char *b_profile_name = NULL;</span>
<span class="lineNum">    2322 </span><span class="lineCov">         83 :         const char *u_profile_name = NULL;</span>
<span class="lineNum">    2323 </span><span class="lineCov">         83 :         const char *menu_profile_name = NULL;</span>
<span class="lineNum">    2324 </span><span class="lineCov">         83 :         struct confbridge_conference *conference = NULL;</span>
<span class="lineNum">    2325 </span><span class="lineCov">         83 :         struct confbridge_user user = {</span>
<span class="lineNum">    2326 </span>            :                 .chan = chan,
<span class="lineNum">    2327 </span>            :                 .tech_args.talking_threshold = DEFAULT_TALKING_THRESHOLD,
<span class="lineNum">    2328 </span>            :                 .tech_args.silence_threshold = DEFAULT_SILENCE_THRESHOLD,
<span class="lineNum">    2329 </span>            :                 .tech_args.drop_silence = 0,
<span class="lineNum">    2330 </span>            :         };
<span class="lineNum">    2331 </span><span class="lineCov">         83 :         AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">    2332 </span>            :                 AST_APP_ARG(conf_name);
<span class="lineNum">    2333 </span>            :                 AST_APP_ARG(b_profile_name);
<span class="lineNum">    2334 </span>            :                 AST_APP_ARG(u_profile_name);
<span class="lineNum">    2335 </span>            :                 AST_APP_ARG(menu_profile_name);
<span class="lineNum">    2336 </span>            :         );
<span class="lineNum">    2337 </span>            : 
<span class="lineNum">    2338 </span><span class="lineCov">         83 :         if (ast_channel_state(chan) != AST_STATE_UP) {</span>
<span class="lineNum">    2339 </span><span class="lineCov">         66 :                 ast_answer(chan);</span>
<span class="lineNum">    2340 </span>            :         }
<span class="lineNum">    2341 </span>            : 
<span class="lineNum">    2342 </span><span class="lineCov">         83 :         if (ast_bridge_features_init(&amp;user.features)) {</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2346 </span>            :         }
<span class="lineNum">    2347 </span>            : 
<span class="lineNum">    2348 </span>            :         /* We need to make a copy of the input string if we are going to modify it! */
<span class="lineNum">    2349 </span><span class="lineCov">         83 :         parse = ast_strdupa(data);</span>
<span class="lineNum">    2350 </span>            : 
<span class="lineNum">    2351 </span><span class="lineCov">         83 :         AST_STANDARD_APP_ARGS(args, parse);</span>
<span class="lineNum">    2352 </span>            : 
<span class="lineNum">    2353 </span><span class="lineCov">         83 :         if (ast_strlen_zero(args.conf_name)) {</span>
<span class="lineNum">    2354 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2355 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;%s requires an argument (conference name[,options])\n&quot;, app);</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2357 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2358 </span>            :         }
<span class="lineNum">    2359 </span>            : 
<span class="lineNum">    2360 </span><span class="lineCov">         83 :         if (strlen(args.conf_name) &gt;= MAX_CONF_NAME) {</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;%s does not accept conference names longer than %d\n&quot;, app, MAX_CONF_NAME - 1);</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2364 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2365 </span>            :         }
<span class="lineNum">    2366 </span>            : 
<span class="lineNum">    2367 </span>            :         /* bridge profile name */
<span class="lineNum">    2368 </span><span class="lineCov">         83 :         if (args.argc &gt; 1 &amp;&amp; !ast_strlen_zero(args.b_profile_name)) {</span>
<span class="lineNum">    2369 </span><span class="lineCov">          2 :                 b_profile_name = args.b_profile_name;</span>
<span class="lineNum">    2370 </span>            :         }
<span class="lineNum">    2371 </span><span class="lineCov">         83 :         if (!conf_find_bridge_profile(chan, b_profile_name, &amp;user.b_profile)) {</span>
<span class="lineNum">    2372 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Conference bridge profile %s does not exist\n&quot;, b_profile_name ?</span>
<span class="lineNum">    2374 </span>            :                         b_profile_name : DEFAULT_BRIDGE_PROFILE);
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2376 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2377 </span>            :         }
<span class="lineNum">    2378 </span>            : 
<span class="lineNum">    2379 </span>            :         /* user profile name */
<span class="lineNum">    2380 </span><span class="lineCov">         83 :         if (args.argc &gt; 2 &amp;&amp; !ast_strlen_zero(args.u_profile_name)) {</span>
<span class="lineNum">    2381 </span><span class="lineCov">         53 :                 u_profile_name = args.u_profile_name;</span>
<span class="lineNum">    2382 </span>            :         }
<span class="lineNum">    2383 </span><span class="lineCov">         83 :         if (!conf_find_user_profile(chan, u_profile_name, &amp;user.u_profile)) {</span>
<span class="lineNum">    2384 </span><span class="lineCov">          1 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2385 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Conference user profile %s does not exist\n&quot;, u_profile_name ?</span>
<span class="lineNum">    2386 </span>            :                         u_profile_name : DEFAULT_USER_PROFILE);
<span class="lineNum">    2387 </span><span class="lineCov">          1 :                 res = -1;</span>
<span class="lineNum">    2388 </span><span class="lineCov">          1 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2389 </span>            :         }
<span class="lineNum">    2390 </span>            : 
<span class="lineNum">    2391 </span><span class="lineCov">         82 :         quiet = ast_test_flag(&amp;user.u_profile, USER_OPT_QUIET);</span>
<span class="lineNum">    2392 </span>            : 
<span class="lineNum">    2393 </span>            :         /* ask for a PIN immediately after finding user profile.  This has to be
<span class="lineNum">    2394 </span>            :          * prompted for requardless of quiet setting. */
<span class="lineNum">    2395 </span><span class="lineCov">         82 :         if (!ast_strlen_zero(user.u_profile.pin)) {</span>
<span class="lineNum">    2396 </span><span class="lineCov">          2 :                 if (conf_get_pin(chan, &amp;user)) {</span>
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :                         res = -1; /* invalid PIN */</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :                         goto confbridge_cleanup;</span>
<span class="lineNum">    2400 </span>            :                 }
<span class="lineNum">    2401 </span>            :         }
<span class="lineNum">    2402 </span>            : 
<span class="lineNum">    2403 </span>            :         /* See if we need them to record a intro name */
<span class="lineNum">    2404 </span><span class="lineCov">         82 :         if (!quiet &amp;&amp;</span>
<span class="lineNum">    2405 </span><span class="lineCov">         66 :                 (ast_test_flag(&amp;user.u_profile, USER_OPT_ANNOUNCE_JOIN_LEAVE) ||</span>
<span class="lineNum">    2406 </span><span class="lineCov">         64 :                 (ast_test_flag(&amp;user.u_profile, USER_OPT_ANNOUNCE_JOIN_LEAVE_REVIEW)))) {</span>
<span class="lineNum">    2407 </span><span class="lineCov">          2 :                 if (conf_rec_name(&amp;user, args.conf_name)) {</span>
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :                         res = -1; /* Hangup during name recording */</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :                         goto confbridge_cleanup;</span>
<span class="lineNum">    2411 </span>            :                 }
<span class="lineNum">    2412 </span>            :         }
<span class="lineNum">    2413 </span>            : 
<span class="lineNum">    2414 </span>            :         /* menu name */
<span class="lineNum">    2415 </span><span class="lineCov">         82 :         if (args.argc &gt; 3 &amp;&amp; !ast_strlen_zero(args.menu_profile_name)) {</span>
<span class="lineNum">    2416 </span><span class="lineCov">          6 :                 menu_profile_name = args.menu_profile_name;</span>
<span class="lineNum">    2417 </span>            :         }
<span class="lineNum">    2418 </span>            : 
<span class="lineNum">    2419 </span><span class="lineCov">         82 :         if (conf_set_menu_to_user(chan, &amp;user, menu_profile_name)) {</span>
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Conference menu profile %s does not exist\n&quot;, menu_profile_name ?</span>
<span class="lineNum">    2422 </span>            :                         menu_profile_name : DEFAULT_MENU_PROFILE);
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2425 </span>            :         }
<span class="lineNum">    2426 </span>            : 
<span class="lineNum">    2427 </span>            :         /* Set if DTMF should pass through for this user or not */
<span class="lineNum">    2428 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user.u_profile, USER_OPT_DTMF_PASS)) {</span>
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :                 user.features.dtmf_passthrough = 1;</span>
<span class="lineNum">    2430 </span>            :         } else {
<span class="lineNum">    2431 </span><span class="lineCov">         82 :                 user.features.dtmf_passthrough = 0;</span>
<span class="lineNum">    2432 </span>            :         }
<span class="lineNum">    2433 </span>            : 
<span class="lineNum">    2434 </span>            :         /* Set dsp threshold values if present */
<span class="lineNum">    2435 </span><span class="lineCov">         82 :         if (user.u_profile.talking_threshold) {</span>
<span class="lineNum">    2436 </span><span class="lineCov">         82 :                 user.tech_args.talking_threshold = user.u_profile.talking_threshold;</span>
<span class="lineNum">    2437 </span>            :         }
<span class="lineNum">    2438 </span><span class="lineCov">         82 :         if (user.u_profile.silence_threshold) {</span>
<span class="lineNum">    2439 </span><span class="lineCov">         82 :                 user.tech_args.silence_threshold = user.u_profile.silence_threshold;</span>
<span class="lineNum">    2440 </span>            :         }
<span class="lineNum">    2441 </span>            : 
<span class="lineNum">    2442 </span>            :         /* Set a talker indicate call back if talking detection is requested */
<span class="lineNum">    2443 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user.u_profile, USER_OPT_TALKER_DETECT)) {</span>
<span class="lineNum">    2444 </span><span class="lineCov">          2 :                 if (ast_bridge_talk_detector_hook(&amp;user.features, conf_handle_talker_cb,</span>
<span class="lineNum">    2445 </span>            :                         &amp;user, NULL, AST_BRIDGE_HOOK_REMOVE_ON_PULL)) {
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :                         res = -1;</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :                         goto confbridge_cleanup;</span>
<span class="lineNum">    2449 </span>            :                 }
<span class="lineNum">    2450 </span>            :         }
<span class="lineNum">    2451 </span>            : 
<span class="lineNum">    2452 </span>            :         /* Look for a conference bridge matching the provided name */
<span class="lineNum">    2453 </span><span class="lineCov">         82 :         if (!(conference = join_conference_bridge(args.conf_name, &amp;user))) {</span>
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    2456 </span><span class="lineNoCov">          0 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2457 </span>            :         }
<span class="lineNum">    2458 </span>            : 
<span class="lineNum">    2459 </span>            :         /* Keep a copy of volume adjustments so we can restore them later if need be */
<span class="lineNum">    2460 </span><span class="lineCov">         82 :         volume_adjustments[0] = ast_audiohook_volume_get(chan, AST_AUDIOHOOK_DIRECTION_READ);</span>
<span class="lineNum">    2461 </span><span class="lineCov">         82 :         volume_adjustments[1] = ast_audiohook_volume_get(chan, AST_AUDIOHOOK_DIRECTION_WRITE);</span>
<span class="lineNum">    2462 </span>            : 
<span class="lineNum">    2463 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user.u_profile, USER_OPT_DROP_SILENCE)) {</span>
<span class="lineNum">    2464 </span><span class="lineCov">          1 :                 user.tech_args.drop_silence = 1;</span>
<span class="lineNum">    2465 </span>            :         }
<span class="lineNum">    2466 </span>            : 
<span class="lineNum">    2467 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user.u_profile, USER_OPT_JITTERBUFFER)) {</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :                 ast_func_write(chan, &quot;JITTERBUFFER(adaptive)&quot;, &quot;default&quot;);</span>
<span class="lineNum">    2469 </span>            :         }
<span class="lineNum">    2470 </span>            : 
<span class="lineNum">    2471 </span><span class="lineCov">         82 :         if (ast_test_flag(&amp;user.u_profile, USER_OPT_DENOISE)) {</span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :                 ast_func_write(chan, &quot;DENOISE(rx)&quot;, &quot;on&quot;);</span>
<span class="lineNum">    2473 </span>            :         }
<span class="lineNum">    2474 </span>            : 
<span class="lineNum">    2475 </span>            :         /* if this user has a intro, play it before entering */
<span class="lineNum">    2476 </span><span class="lineCov">         82 :         if (!ast_strlen_zero(user.name_rec_location)) {</span>
<span class="lineNum">    2477 </span><span class="lineCov">          2 :                 ast_autoservice_start(chan);</span>
<span class="lineNum">    2478 </span><span class="lineCov">          2 :                 play_sound_file(conference, user.name_rec_location);</span>
<span class="lineNum">    2479 </span><span class="lineCov">          2 :                 play_sound_file(conference,</span>
<span class="lineNum">    2480 </span>            :                         conf_get_sound(CONF_SOUND_HAS_JOINED, conference-&gt;b_profile.sounds));
<span class="lineNum">    2481 </span><span class="lineCov">          2 :                 ast_autoservice_stop(chan);</span>
<span class="lineNum">    2482 </span>            :         }
<span class="lineNum">    2483 </span>            : 
<span class="lineNum">    2484 </span>            :         /* Play the Join sound to both the conference and the user entering. */
<span class="lineNum">    2485 </span><span class="lineCov">         82 :         if (!quiet) {</span>
<span class="lineNum">    2486 </span><span class="lineCov">         66 :                 const char *join_sound = conf_get_sound(CONF_SOUND_JOIN, conference-&gt;b_profile.sounds);</span>
<span class="lineNum">    2487 </span>            : 
<span class="lineNum">    2488 </span><span class="lineCov">         66 :                 if (strcmp(conference-&gt;b_profile.language, ast_channel_language(chan))) {</span>
<span class="lineNum">    2489 </span><span class="lineNoCov">          0 :                         ast_stream_and_wait(chan, join_sound, &quot;&quot;);</span>
<span class="lineNum">    2490 </span><span class="lineNoCov">          0 :                         ast_autoservice_start(chan);</span>
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :                         play_sound_file(conference, join_sound);</span>
<span class="lineNum">    2492 </span><span class="lineNoCov">          0 :                         ast_autoservice_stop(chan);</span>
<span class="lineNum">    2493 </span>            :                 } else {
<span class="lineNum">    2494 </span><span class="lineCov">         66 :                         async_play_sound_file(conference, join_sound, chan);</span>
<span class="lineNum">    2495 </span>            :                 }
<span class="lineNum">    2496 </span>            :         }
<span class="lineNum">    2497 </span>            : 
<span class="lineNum">    2498 </span><span class="lineCov">         82 :         if (user.u_profile.timeout) {</span>
<span class="lineNum">    2499 </span><span class="lineCov">          2 :                 ast_bridge_interval_hook(&amp;user.features,</span>
<span class="lineNum">    2500 </span>            :                         0,
<span class="lineNum">    2501 </span><span class="lineCov">          2 :                         user.u_profile.timeout * 1000,</span>
<span class="lineNum">    2502 </span>            :                         user_timeout,
<span class="lineNum">    2503 </span>            :                         NULL,
<span class="lineNum">    2504 </span>            :                         NULL,
<span class="lineNum">    2505 </span>            :                         AST_BRIDGE_HOOK_REMOVE_ON_PULL);
<span class="lineNum">    2506 </span>            :         }
<span class="lineNum">    2507 </span>            : 
<span class="lineNum">    2508 </span>            :         /* See if we need to automatically set this user as a video source or not */
<span class="lineNum">    2509 </span><span class="lineCov">         82 :         handle_video_on_join(conference, user.chan, ast_test_flag(&amp;user.u_profile, USER_OPT_MARKEDUSER));</span>
<span class="lineNum">    2510 </span>            : 
<span class="lineNum">    2511 </span><span class="lineCov">         82 :         conf_moh_unsuspend(&amp;user);</span>
<span class="lineNum">    2512 </span>            : 
<span class="lineNum">    2513 </span>            :         /* Join our conference bridge for real */
<span class="lineNum">    2514 </span><span class="lineCov">         82 :         send_join_event(&amp;user, conference);</span>
<span class="lineNum">    2515 </span>            : 
<span class="lineNum">    2516 </span><span class="lineCov">         82 :         if (ast_bridge_join_hook(&amp;user.features, join_callback, NULL, NULL, 0)) {</span>
<span class="lineNum">    2517 </span><span class="lineNoCov">          0 :                 async_play_sound_ready(user.chan);</span>
<span class="lineNum">    2518 </span>            :         }
<span class="lineNum">    2519 </span>            : 
<span class="lineNum">    2520 </span><span class="lineCov">         82 :         ast_bridge_join(conference-&gt;bridge,</span>
<span class="lineNum">    2521 </span>            :                 chan,
<span class="lineNum">    2522 </span>            :                 NULL,
<span class="lineNum">    2523 </span>            :                 &amp;user.features,
<span class="lineNum">    2524 </span>            :                 &amp;user.tech_args,
<span class="lineNum">    2525 </span>            :                 0);
<span class="lineNum">    2526 </span>            : 
<span class="lineNum">    2527 </span>            :         /* This is a catch-all in case joining the bridge failed or for some reason
<span class="lineNum">    2528 </span>            :          * an async announcement got queued up and hasn't been told to play yet
<span class="lineNum">    2529 </span>            :          */
<span class="lineNum">    2530 </span><span class="lineCov">         82 :         async_play_sound_ready(chan);</span>
<span class="lineNum">    2531 </span>            : 
<span class="lineNum">    2532 </span><span class="lineCov">         82 :         if (!user.kicked &amp;&amp; ast_check_hangup(chan)) {</span>
<span class="lineNum">    2533 </span><span class="lineCov">         60 :                 pbx_builtin_setvar_helper(chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;HANGUP&quot;);</span>
<span class="lineNum">    2534 </span>            :         }
<span class="lineNum">    2535 </span>            : 
<span class="lineNum">    2536 </span><span class="lineCov">         82 :         send_leave_event(&amp;user, conference);</span>
<span class="lineNum">    2537 </span>            : 
<span class="lineNum">    2538 </span>            :         /* if we're shutting down, don't attempt to do further processing */
<span class="lineNum">    2539 </span><span class="lineCov">         82 :         if (ast_shutting_down()) {</span>
<span class="lineNum">    2540 </span>            :                 /*
<span class="lineNum">    2541 </span>            :                  * Not taking any new calls at this time.  We cannot create
<span class="lineNum">    2542 </span>            :                  * the announcer channel if this is the first channel into
<span class="lineNum">    2543 </span>            :                  * the conference and we certainly cannot create any
<span class="lineNum">    2544 </span>            :                  * recording channel.
<span class="lineNum">    2545 </span>            :                  */
<span class="lineNum">    2546 </span><span class="lineCov">          1 :                 leave_conference(&amp;user);</span>
<span class="lineNum">    2547 </span><span class="lineCov">          1 :                 conference = NULL;</span>
<span class="lineNum">    2548 </span><span class="lineCov">          1 :                 goto confbridge_cleanup;</span>
<span class="lineNum">    2549 </span>            :         }
<span class="lineNum">    2550 </span>            : 
<span class="lineNum">    2551 </span>            :         /* If this user was a video source, we need to clean up and possibly pick a new source. */
<span class="lineNum">    2552 </span><span class="lineCov">         81 :         handle_video_on_exit(conference, user.chan);</span>
<span class="lineNum">    2553 </span>            : 
<span class="lineNum">    2554 </span>            :         /* if this user has a intro, play it when leaving */
<span class="lineNum">    2555 </span><span class="lineCov">         81 :         if (!quiet &amp;&amp; !ast_strlen_zero(user.name_rec_location)) {</span>
<span class="lineNum">    2556 </span><span class="lineCov">          2 :                 async_play_sound_file(conference, user.name_rec_location, NULL);</span>
<span class="lineNum">    2557 </span><span class="lineCov">          2 :                 async_play_sound_file(conference,</span>
<span class="lineNum">    2558 </span>            :                         conf_get_sound(CONF_SOUND_HAS_LEFT, conference-&gt;b_profile.sounds), NULL);
<span class="lineNum">    2559 </span><span class="lineCov">          2 :                 async_delete_name_rec(conference, user.name_rec_location);</span>
<span class="lineNum">    2560 </span><span class="lineCov">          2 :                 async_delete_task_pushed = 1;</span>
<span class="lineNum">    2561 </span>            :         }
<span class="lineNum">    2562 </span>            : 
<span class="lineNum">    2563 </span>            :         /* play the leave sound */
<span class="lineNum">    2564 </span><span class="lineCov">         81 :         if (!quiet) {</span>
<span class="lineNum">    2565 </span><span class="lineCov">         66 :                 const char *leave_sound = conf_get_sound(CONF_SOUND_LEAVE, conference-&gt;b_profile.sounds);</span>
<span class="lineNum">    2566 </span><span class="lineCov">         66 :                 async_play_sound_file(conference, leave_sound, NULL);</span>
<span class="lineNum">    2567 </span>            :         }
<span class="lineNum">    2568 </span>            : 
<span class="lineNum">    2569 </span>            :         /* If the user was kicked from the conference play back the audio prompt for it */
<span class="lineNum">    2570 </span><span class="lineCov">         81 :         if (!quiet &amp;&amp; user.kicked) {</span>
<span class="lineNum">    2571 </span><span class="lineCov">          8 :                 res = ast_stream_and_wait(chan,</span>
<span class="lineNum">    2572 </span>            :                         conf_get_sound(CONF_SOUND_KICKED, conference-&gt;b_profile.sounds),
<span class="lineNum">    2573 </span>            :                         &quot;&quot;);
<span class="lineNum">    2574 </span>            :         }
<span class="lineNum">    2575 </span>            : 
<span class="lineNum">    2576 </span>            :         /* Easy as pie, depart this channel from the conference bridge */
<span class="lineNum">    2577 </span><span class="lineCov">         81 :         leave_conference(&amp;user);</span>
<span class="lineNum">    2578 </span><span class="lineCov">         81 :         conference = NULL;</span>
<span class="lineNum">    2579 </span>            : 
<span class="lineNum">    2580 </span>            :         /* Restore volume adjustments to previous values in case they were changed */
<span class="lineNum">    2581 </span><span class="lineCov">         81 :         if (volume_adjustments[0]) {</span>
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :                 ast_audiohook_volume_set(chan, AST_AUDIOHOOK_DIRECTION_READ, volume_adjustments[0]);</span>
<span class="lineNum">    2583 </span>            :         }
<span class="lineNum">    2584 </span><span class="lineCov">         81 :         if (volume_adjustments[1]) {</span>
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :                 ast_audiohook_volume_set(chan, AST_AUDIOHOOK_DIRECTION_WRITE, volume_adjustments[1]);</span>
<span class="lineNum">    2586 </span>            :         }
<span class="lineNum">    2587 </span>            : 
<span class="lineNum">    2588 </span><span class="lineCov">         81 : confbridge_cleanup:</span>
<span class="lineNum">    2589 </span><span class="lineCov">         83 :         if (!async_delete_task_pushed &amp;&amp; !ast_strlen_zero(user.name_rec_location)) {</span>
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :                 ast_filedelete(user.name_rec_location, NULL);</span>
<span class="lineNum">    2591 </span>            :         }
<span class="lineNum">    2592 </span><span class="lineCov">         83 :         ast_bridge_features_cleanup(&amp;user.features);</span>
<span class="lineNum">    2593 </span><span class="lineCov">         83 :         conf_bridge_profile_destroy(&amp;user.b_profile);</span>
<span class="lineNum">    2594 </span><span class="lineCov">         83 :         return res;</span>
<a name="2595"><span class="lineNum">    2595 </span>            : }</a>
<span class="lineNum">    2596 </span>            : 
<span class="lineNum">    2597 </span><span class="lineCov">          1 : static int action_toggle_mute(struct confbridge_conference *conference,</span>
<span class="lineNum">    2598 </span>            :                               struct confbridge_user *user,
<span class="lineNum">    2599 </span>            :                               struct ast_bridge_channel *bridge_channel)
<span class="lineNum">    2600 </span>            : {
<span class="lineNum">    2601 </span>            :         int mute;
<span class="lineNum">    2602 </span>            : 
<span class="lineNum">    2603 </span>            :         /* Toggle user level mute request. */
<span class="lineNum">    2604 </span><span class="lineCov">          1 :         mute = !user-&gt;muted;</span>
<span class="lineNum">    2605 </span><span class="lineCov">          1 :         generic_mute_unmute_user(conference, user, mute);</span>
<span class="lineNum">    2606 </span>            : 
<span class="lineNum">    2607 </span><span class="lineCov">          1 :         return play_file(bridge_channel, NULL,</span>
<span class="lineNum">    2608 </span>            :                 conf_get_sound(mute ? CONF_SOUND_MUTED : CONF_SOUND_UNMUTED,
<span class="lineNum">    2609 </span><span class="lineCov">          1 :                         conference-&gt;b_profile.sounds)) &lt; 0;</span>
<a name="2610"><span class="lineNum">    2610 </span>            : }</a>
<span class="lineNum">    2611 </span>            : 
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 : static int action_toggle_binaural(struct confbridge_conference *conference,</span>
<span class="lineNum">    2613 </span>            :                 struct confbridge_user *user,
<span class="lineNum">    2614 </span>            :                 struct ast_bridge_channel *bridge_channel)
<span class="lineNum">    2615 </span>            : {
<span class="lineNum">    2616 </span>            :         unsigned int binaural;
<span class="lineNum">    2617 </span><span class="lineNoCov">          0 :         ast_bridge_channel_lock_bridge(bridge_channel);</span>
<span class="lineNum">    2618 </span><span class="lineNoCov">          0 :         binaural = !bridge_channel-&gt;binaural_suspended;</span>
<span class="lineNum">    2619 </span><span class="lineNoCov">          0 :         bridge_channel-&gt;binaural_suspended = binaural;</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :         ast_bridge_unlock(bridge_channel-&gt;bridge);</span>
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :         return play_file(bridge_channel, NULL, (binaural ?</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :                                 conf_get_sound(CONF_SOUND_BINAURAL_OFF, user-&gt;b_profile.sounds) :</span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :                                 conf_get_sound(CONF_SOUND_BINAURAL_ON, user-&gt;b_profile.sounds))) &lt; 0;</span>
<a name="2624"><span class="lineNum">    2624 </span>            : }</a>
<span class="lineNum">    2625 </span>            : 
<span class="lineNum">    2626 </span><span class="lineCov">          1 : static int action_toggle_mute_participants(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    2627 </span>            : {
<span class="lineNum">    2628 </span><span class="lineCov">          1 :         struct confbridge_user *cur_user = NULL;</span>
<span class="lineNum">    2629 </span>            :         const char *sound_to_play;
<span class="lineNum">    2630 </span>            :         int mute;
<span class="lineNum">    2631 </span>            : 
<span class="lineNum">    2632 </span><span class="lineCov">          1 :         ao2_lock(conference);</span>
<span class="lineNum">    2633 </span>            : 
<span class="lineNum">    2634 </span>            :         /* Toggle bridge level mute request. */
<span class="lineNum">    2635 </span><span class="lineCov">          1 :         mute = !conference-&gt;muted;</span>
<span class="lineNum">    2636 </span><span class="lineCov">          1 :         conference-&gt;muted = mute;</span>
<span class="lineNum">    2637 </span>            : 
<span class="lineNum">    2638 </span><span class="lineCov">          3 :         AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, cur_user, list) {</span>
<span class="lineNum">    2639 </span><span class="lineCov">          2 :                 if (!ast_test_flag(&amp;cur_user-&gt;u_profile, USER_OPT_ADMIN)) {</span>
<span class="lineNum">    2640 </span>            :                         /* Set user level to bridge level mute request. */
<span class="lineNum">    2641 </span><span class="lineCov">          1 :                         cur_user-&gt;muted = mute;</span>
<span class="lineNum">    2642 </span><span class="lineCov">          1 :                         conf_update_user_mute(cur_user);</span>
<span class="lineNum">    2643 </span>            :                 }
<span class="lineNum">    2644 </span>            :         }
<span class="lineNum">    2645 </span>            : 
<span class="lineNum">    2646 </span><span class="lineCov">          1 :         ao2_unlock(conference);</span>
<span class="lineNum">    2647 </span>            : 
<span class="lineNum">    2648 </span><span class="lineCov">          1 :         sound_to_play = conf_get_sound(</span>
<span class="lineNum">    2649 </span>            :                 mute ? CONF_SOUND_PARTICIPANTS_MUTED : CONF_SOUND_PARTICIPANTS_UNMUTED,
<span class="lineNum">    2650 </span>            :                 conference-&gt;b_profile.sounds);
<span class="lineNum">    2651 </span>            : 
<span class="lineNum">    2652 </span><span class="lineCov">          1 :         if (strcmp(conference-&gt;b_profile.language, ast_channel_language(user-&gt;chan))) {</span>
<span class="lineNum">    2653 </span>            :                 /* The host needs to hear it seperately, as they don't get the audio from play_sound_helper */
<span class="lineNum">    2654 </span><span class="lineNoCov">          0 :                 ast_stream_and_wait(user-&gt;chan, sound_to_play, &quot;&quot;);</span>
<span class="lineNum">    2655 </span>            : 
<span class="lineNum">    2656 </span>            :                 /* Announce to the group that all participants are muted */
<span class="lineNum">    2657 </span><span class="lineNoCov">          0 :                 ast_autoservice_start(user-&gt;chan);</span>
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :                 play_sound_file(conference, sound_to_play);</span>
<span class="lineNum">    2659 </span><span class="lineNoCov">          0 :                 ast_autoservice_stop(user-&gt;chan);</span>
<span class="lineNum">    2660 </span>            :         } else {
<span class="lineNum">    2661 </span>            :                 /* Playing the sound asynchronously lets the sound be heard by everyone at once */
<span class="lineNum">    2662 </span><span class="lineCov">          1 :                 async_play_sound_file(conference, sound_to_play, user-&gt;chan);</span>
<span class="lineNum">    2663 </span>            :         }
<span class="lineNum">    2664 </span>            : 
<span class="lineNum">    2665 </span><span class="lineCov">          1 :         return 0;</span>
<a name="2666"><span class="lineNum">    2666 </span>            : }</a>
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span><span class="lineCov">          4 : static int action_playback(struct ast_bridge_channel *bridge_channel, const char *playback_file)</span>
<span class="lineNum">    2669 </span>            : {
<span class="lineNum">    2670 </span><span class="lineCov">          4 :         char *file_copy = ast_strdupa(playback_file);</span>
<span class="lineNum">    2671 </span><span class="lineCov">          4 :         char *file = NULL;</span>
<span class="lineNum">    2672 </span>            : 
<span class="lineNum">    2673 </span><span class="lineCov">          8 :         while ((file = strsep(&amp;file_copy, &quot;&amp;&quot;))) {</span>
<span class="lineNum">    2674 </span><span class="lineCov">          4 :                 if (ast_stream_and_wait(bridge_channel-&gt;chan, file, &quot;&quot;)) {</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Failed to playback file %s to channel\n&quot;, file);</span>
<span class="lineNum">    2676 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    2677 </span>            :                 }
<span class="lineNum">    2678 </span>            :         }
<span class="lineNum">    2679 </span><span class="lineCov">          4 :         return 0;</span>
<a name="2680"><span class="lineNum">    2680 </span>            : }</a>
<span class="lineNum">    2681 </span>            : 
<span class="lineNum">    2682 </span><span class="lineNoCov">          0 : static int action_playback_and_continue(struct confbridge_conference *conference,</span>
<span class="lineNum">    2683 </span>            :         struct confbridge_user *user,
<span class="lineNum">    2684 </span>            :         struct ast_bridge_channel *bridge_channel,
<span class="lineNum">    2685 </span>            :         struct conf_menu *menu,
<span class="lineNum">    2686 </span>            :         const char *playback_file,
<span class="lineNum">    2687 </span>            :         const char *cur_dtmf,
<span class="lineNum">    2688 </span>            :         int *stop_prompts)
<span class="lineNum">    2689 </span>            : {
<span class="lineNum">    2690 </span>            :         int i;
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :         int digit = 0;</span>
<span class="lineNum">    2692 </span>            :         char dtmf[MAXIMUM_DTMF_FEATURE_STRING];
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 :         struct conf_menu_entry new_menu_entry = { { 0, }, };</span>
<span class="lineNum">    2694 </span><span class="lineNoCov">          0 :         char *file_copy = ast_strdupa(playback_file);</span>
<span class="lineNum">    2695 </span><span class="lineNoCov">          0 :         char *file = NULL;</span>
<span class="lineNum">    2696 </span>            : 
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 :         while ((file = strsep(&amp;file_copy, &quot;&amp;&quot;))) {</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :                 if (ast_streamfile(bridge_channel-&gt;chan, file, ast_channel_language(bridge_channel-&gt;chan))) {</span>
<span class="lineNum">    2699 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Failed to playback file %s to channel\n&quot;, file);</span>
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    2701 </span>            :                 }
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span>            :                 /* now wait for more digits. */
<span class="lineNum">    2704 </span><span class="lineNoCov">          0 :                 if (!(digit = ast_waitstream(bridge_channel-&gt;chan, AST_DIGIT_ANY))) {</span>
<span class="lineNum">    2705 </span>            :                         /* streaming finished and no DTMF was entered */
<span class="lineNum">    2706 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2707 </span><span class="lineNoCov">          0 :                 } else if (digit == -1) {</span>
<span class="lineNum">    2708 </span>            :                         /* error */
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    2710 </span>            :                 } else {
<span class="lineNum">    2711 </span><span class="lineNoCov">          0 :                         break; /* dtmf was entered */</span>
<span class="lineNum">    2712 </span>            :                 }
<span class="lineNum">    2713 </span>            :         }
<span class="lineNum">    2714 </span><span class="lineNoCov">          0 :         if (!digit) {</span>
<span class="lineNum">    2715 </span>            :                 /* streaming finished on all files and no DTMF was entered */
<span class="lineNum">    2716 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2717 </span>            :         }
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :         ast_stopstream(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2719 </span>            : 
<span class="lineNum">    2720 </span>            :         /* If we get here, then DTMF has been entered, This means no
<span class="lineNum">    2721 </span>            :          * additional prompts should be played for this menu entry */
<span class="lineNum">    2722 </span><span class="lineNoCov">          0 :         *stop_prompts = 1;</span>
<span class="lineNum">    2723 </span>            : 
<span class="lineNum">    2724 </span>            :         /* If a digit was pressed during the payback, update
<span class="lineNum">    2725 </span>            :          * the dtmf string and look for a new menu entry in the
<span class="lineNum">    2726 </span>            :          * menu structure */
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 :         ast_copy_string(dtmf, cur_dtmf, sizeof(dtmf));</span>
<span class="lineNum">    2728 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; (MAXIMUM_DTMF_FEATURE_STRING - 1); i++) {</span>
<span class="lineNum">    2729 </span><span class="lineNoCov">          0 :                 dtmf[i] = cur_dtmf[i];</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :                 if (!dtmf[i]) {</span>
<span class="lineNum">    2731 </span><span class="lineNoCov">          0 :                         dtmf[i] = (char) digit;</span>
<span class="lineNum">    2732 </span><span class="lineNoCov">          0 :                         dtmf[i + 1] = '\0';</span>
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :                         i = -1;</span>
<span class="lineNum">    2734 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2735 </span>            :                 }
<span class="lineNum">    2736 </span>            :         }
<span class="lineNum">    2737 </span>            :         /* If i is not -1 then the new dtmf digit was _NOT_ added to the string.
<span class="lineNum">    2738 </span>            :          * If this is the case, no new DTMF sequence should be looked for. */
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :         if (i != -1) {</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2741 </span>            :         }
<span class="lineNum">    2742 </span>            : 
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :         if (conf_find_menu_entry_by_sequence(dtmf, menu, &amp;new_menu_entry)) {</span>
<span class="lineNum">    2744 </span><span class="lineNoCov">          0 :                 execute_menu_entry(conference,</span>
<span class="lineNum">    2745 </span>            :                         user,
<span class="lineNum">    2746 </span>            :                         bridge_channel,
<span class="lineNum">    2747 </span>            :                         &amp;new_menu_entry, menu);
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :                 conf_menu_entry_destroy(&amp;new_menu_entry);</span>
<span class="lineNum">    2749 </span>            :         }
<span class="lineNum">    2750 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="2751"><span class="lineNum">    2751 </span>            : }</a>
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span><span class="lineCov">          1 : static int action_kick_last(struct confbridge_conference *conference,</span>
<span class="lineNum">    2754 </span>            :         struct ast_bridge_channel *bridge_channel,
<span class="lineNum">    2755 </span>            :         struct confbridge_user *user)
<span class="lineNum">    2756 </span>            : {
<span class="lineNum">    2757 </span><span class="lineCov">          1 :         struct confbridge_user *last_user = NULL;</span>
<span class="lineNum">    2758 </span><span class="lineCov">          1 :         int isadmin = ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN);</span>
<span class="lineNum">    2759 </span>            : 
<span class="lineNum">    2760 </span><span class="lineCov">          1 :         if (!isadmin) {</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :                 play_file(bridge_channel, NULL,</span>
<span class="lineNum">    2762 </span>            :                         conf_get_sound(CONF_SOUND_ERROR_MENU, conference-&gt;b_profile.sounds));
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Only admin users can use the kick_last menu action. Channel %s of conf %s is not an admin.\n&quot;,</span>
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :                         ast_channel_name(bridge_channel-&gt;chan),</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :                         conference-&gt;name);</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2767 </span>            :         }
<span class="lineNum">    2768 </span>            : 
<span class="lineNum">    2769 </span><span class="lineCov">          1 :         ao2_lock(conference);</span>
<span class="lineNum">    2770 </span><span class="lineCov">          1 :         last_user = AST_LIST_LAST(&amp;conference-&gt;active_list);</span>
<span class="lineNum">    2771 </span><span class="lineCov">          1 :         if (!last_user) {</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    2774 </span>            :         }
<span class="lineNum">    2775 </span>            : 
<span class="lineNum">    2776 </span><span class="lineCov">          1 :         if (last_user == user || ast_test_flag(&amp;last_user-&gt;u_profile, USER_OPT_ADMIN)) {</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :                 play_file(bridge_channel, NULL,</span>
<span class="lineNum">    2779 </span>            :                         conf_get_sound(CONF_SOUND_ERROR_MENU, conference-&gt;b_profile.sounds));
<span class="lineNum">    2780 </span><span class="lineCov">          1 :         } else if (!last_user-&gt;kicked) {</span>
<span class="lineNum">    2781 </span><span class="lineCov">          1 :                 last_user-&gt;kicked = 1;</span>
<span class="lineNum">    2782 </span><span class="lineCov">          1 :                 pbx_builtin_setvar_helper(last_user-&gt;chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;KICKED&quot;);</span>
<span class="lineNum">    2783 </span><span class="lineCov">          1 :                 ast_bridge_remove(conference-&gt;bridge, last_user-&gt;chan);</span>
<span class="lineNum">    2784 </span><span class="lineCov">          1 :                 ao2_unlock(conference);</span>
<span class="lineNum">    2785 </span>            :         }
<span class="lineNum">    2786 </span>            : 
<span class="lineNum">    2787 </span><span class="lineCov">          1 :         return 0;</span>
<a name="2788"><span class="lineNum">    2788 </span>            : }</a>
<span class="lineNum">    2789 </span>            : 
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 : static int action_dialplan_exec(struct ast_bridge_channel *bridge_channel, struct conf_menu_action *menu_action)</span>
<span class="lineNum">    2791 </span>            : {
<span class="lineNum">    2792 </span>            :         struct ast_pbx_args args;
<span class="lineNum">    2793 </span>            :         struct ast_pbx *pbx;
<span class="lineNum">    2794 </span>            :         char *exten;
<span class="lineNum">    2795 </span>            :         char *context;
<span class="lineNum">    2796 </span>            :         int priority;
<span class="lineNum">    2797 </span>            :         int res;
<span class="lineNum">    2798 </span>            : 
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :         memset(&amp;args, 0, sizeof(args));</span>
<span class="lineNum">    2800 </span><span class="lineNoCov">          0 :         args.no_hangup_chan = 1;</span>
<span class="lineNum">    2801 </span>            : 
<span class="lineNum">    2802 </span><span class="lineNoCov">          0 :         ast_channel_lock(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2803 </span>            : 
<span class="lineNum">    2804 </span>            :         /*save off*/
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :         exten = ast_strdupa(ast_channel_exten(bridge_channel-&gt;chan));</span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :         context = ast_strdupa(ast_channel_context(bridge_channel-&gt;chan));</span>
<span class="lineNum">    2807 </span><span class="lineNoCov">          0 :         priority = ast_channel_priority(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :         pbx = ast_channel_pbx(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :         ast_channel_pbx_set(bridge_channel-&gt;chan, NULL);</span>
<span class="lineNum">    2810 </span>            : 
<span class="lineNum">    2811 </span>            :         /*set new*/
<span class="lineNum">    2812 </span><span class="lineNoCov">          0 :         ast_channel_exten_set(bridge_channel-&gt;chan, menu_action-&gt;data.dialplan_args.exten);</span>
<span class="lineNum">    2813 </span><span class="lineNoCov">          0 :         ast_channel_context_set(bridge_channel-&gt;chan, menu_action-&gt;data.dialplan_args.context);</span>
<span class="lineNum">    2814 </span><span class="lineNoCov">          0 :         ast_channel_priority_set(bridge_channel-&gt;chan, menu_action-&gt;data.dialplan_args.priority);</span>
<span class="lineNum">    2815 </span>            : 
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :         ast_channel_unlock(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2817 </span>            : 
<span class="lineNum">    2818 </span>            :         /*execute*/
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :         res = ast_pbx_run_args(bridge_channel-&gt;chan, &amp;args);</span>
<span class="lineNum">    2820 </span>            : 
<span class="lineNum">    2821 </span>            :         /*restore*/
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :         ast_channel_lock(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2823 </span>            : 
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :         ast_channel_exten_set(bridge_channel-&gt;chan, exten);</span>
<span class="lineNum">    2825 </span><span class="lineNoCov">          0 :         ast_channel_context_set(bridge_channel-&gt;chan, context);</span>
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :         ast_channel_priority_set(bridge_channel-&gt;chan, priority);</span>
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :         ast_channel_pbx_set(bridge_channel-&gt;chan, pbx);</span>
<span class="lineNum">    2828 </span>            : 
<span class="lineNum">    2829 </span><span class="lineNoCov">          0 :         ast_channel_unlock(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="2832"><span class="lineNum">    2832 </span>            : }</a>
<span class="lineNum">    2833 </span>            : 
<span class="lineNum">    2834 </span><span class="lineCov">         14 : static int execute_menu_entry(struct confbridge_conference *conference,</span>
<span class="lineNum">    2835 </span>            :         struct confbridge_user *user,
<span class="lineNum">    2836 </span>            :         struct ast_bridge_channel *bridge_channel,
<span class="lineNum">    2837 </span>            :         struct conf_menu_entry *menu_entry,
<span class="lineNum">    2838 </span>            :         struct conf_menu *menu)
<span class="lineNum">    2839 </span>            : {
<span class="lineNum">    2840 </span>            :         struct conf_menu_action *menu_action;
<span class="lineNum">    2841 </span><span class="lineCov">         14 :         int isadmin = ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN);</span>
<span class="lineNum">    2842 </span><span class="lineCov">         14 :         int stop_prompts = 0;</span>
<span class="lineNum">    2843 </span><span class="lineCov">         14 :         int res = 0;</span>
<span class="lineNum">    2844 </span>            : 
<span class="lineNum">    2845 </span><span class="lineCov">         28 :         AST_LIST_TRAVERSE(&amp;menu_entry-&gt;actions, menu_action, action) {</span>
<span class="lineNum">    2846 </span><span class="lineCov">         14 :                 switch (menu_action-&gt;id) {</span>
<span class="lineNum">    2847 </span><span class="lineCov">          1 :                 case MENU_ACTION_TOGGLE_MUTE:</span>
<span class="lineNum">    2848 </span><span class="lineCov">          1 :                         res |= action_toggle_mute(conference, user, bridge_channel);</span>
<span class="lineNum">    2849 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    2850 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_TOGGLE_BINAURAL:</span>
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :                         action_toggle_binaural(conference, user, bridge_channel);</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2853 </span><span class="lineCov">          1 :                 case MENU_ACTION_ADMIN_TOGGLE_MUTE_PARTICIPANTS:</span>
<span class="lineNum">    2854 </span><span class="lineCov">          1 :                         if (!isadmin) {</span>
<span class="lineNum">    2855 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2856 </span>            :                         }
<span class="lineNum">    2857 </span><span class="lineCov">          1 :                         action_toggle_mute_participants(conference, user);</span>
<span class="lineNum">    2858 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_PARTICIPANT_COUNT:</span>
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :                         announce_user_count(conference, user, bridge_channel);</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2862 </span><span class="lineCov">          4 :                 case MENU_ACTION_PLAYBACK:</span>
<span class="lineNum">    2863 </span><span class="lineCov">          4 :                         if (!stop_prompts) {</span>
<span class="lineNum">    2864 </span><span class="lineCov">          4 :                                 res |= action_playback(bridge_channel, menu_action-&gt;data.playback_file);</span>
<span class="lineNum">    2865 </span><span class="lineCov">          4 :                                 ast_test_suite_event_notify(&quot;CONF_MENU_PLAYBACK&quot;,</span>
<span class="lineNum">    2866 </span>            :                                         &quot;Message: %s\r\nChannel: %s&quot;,
<span class="lineNum">    2867 </span>            :                                         menu_action-&gt;data.playback_file, ast_channel_name(bridge_channel-&gt;chan));
<span class="lineNum">    2868 </span>            :                         }
<span class="lineNum">    2869 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_RESET_LISTENING:</span>
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_set(user-&gt;chan, AST_AUDIOHOOK_DIRECTION_WRITE, 0);</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_RESET_TALKING:</span>
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_set(user-&gt;chan, AST_AUDIOHOOK_DIRECTION_READ, 0);</span>
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_INCREASE_LISTENING:</span>
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_adjust(user-&gt;chan,</span>
<span class="lineNum">    2878 </span>            :                                 AST_AUDIOHOOK_DIRECTION_WRITE, 1);
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_DECREASE_LISTENING:</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_adjust(user-&gt;chan,</span>
<span class="lineNum">    2882 </span>            :                                 AST_AUDIOHOOK_DIRECTION_WRITE, -1);
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_INCREASE_TALKING:</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_adjust(user-&gt;chan,</span>
<span class="lineNum">    2886 </span>            :                                 AST_AUDIOHOOK_DIRECTION_READ, 1);
<span class="lineNum">    2887 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_DECREASE_TALKING:</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :                         ast_audiohook_volume_adjust(user-&gt;chan,</span>
<span class="lineNum">    2890 </span>            :                                 AST_AUDIOHOOK_DIRECTION_READ, -1);
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_PLAYBACK_AND_CONTINUE:</span>
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :                         if (!(stop_prompts)) {</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :                                 res |= action_playback_and_continue(conference,</span>
<span class="lineNum">    2895 </span>            :                                         user,
<span class="lineNum">    2896 </span>            :                                         bridge_channel,
<span class="lineNum">    2897 </span>            :                                         menu,
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :                                         menu_action-&gt;data.playback_file,</span>
<span class="lineNum">    2899 </span><span class="lineNoCov">          0 :                                         menu_entry-&gt;dtmf,</span>
<span class="lineNum">    2900 </span>            :                                         &amp;stop_prompts);
<span class="lineNum">    2901 </span>            :                         }
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2903 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_DIALPLAN_EXEC:</span>
<span class="lineNum">    2904 </span><span class="lineNoCov">          0 :                         res |= action_dialplan_exec(bridge_channel, menu_action);</span>
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2906 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_ADMIN_TOGGLE_LOCK:</span>
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :                         if (!isadmin) {</span>
<span class="lineNum">    2908 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    2909 </span>            :                         }
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :                         conference-&gt;locked = (!conference-&gt;locked ? 1 : 0);</span>
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :                         res |= play_file(bridge_channel, NULL,</span>
<span class="lineNum">    2912 </span>            :                                 conf_get_sound(
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :                                         conference-&gt;locked ? CONF_SOUND_LOCKED_NOW : CONF_SOUND_UNLOCKED_NOW,</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 :                                         conference-&gt;b_profile.sounds)) &lt; 0;</span>
<span class="lineNum">    2915 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2916 </span><span class="lineCov">          1 :                 case MENU_ACTION_ADMIN_KICK_LAST:</span>
<span class="lineNum">    2917 </span><span class="lineCov">          1 :                         res |= action_kick_last(conference, bridge_channel, user);</span>
<span class="lineNum">    2918 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    2919 </span><span class="lineCov">          7 :                 case MENU_ACTION_LEAVE:</span>
<span class="lineNum">    2920 </span><span class="lineCov">          7 :                         pbx_builtin_setvar_helper(bridge_channel-&gt;chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;DTMF&quot;);</span>
<span class="lineNum">    2921 </span><span class="lineCov">          7 :                         ao2_lock(conference);</span>
<span class="lineNum">    2922 </span><span class="lineCov">          7 :                         ast_bridge_remove(conference-&gt;bridge, bridge_channel-&gt;chan);</span>
<span class="lineNum">    2923 </span><span class="lineCov">          7 :                         ast_test_suite_event_notify(&quot;CONF_MENU_LEAVE&quot;,</span>
<span class="lineNum">    2924 </span>            :                                 &quot;Channel: %s&quot;,
<span class="lineNum">    2925 </span>            :                                 ast_channel_name(bridge_channel-&gt;chan));
<span class="lineNum">    2926 </span><span class="lineCov">          7 :                         ao2_unlock(conference);</span>
<span class="lineNum">    2927 </span><span class="lineCov">          7 :                         break;</span>
<span class="lineNum">    2928 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_NOOP:</span>
<span class="lineNum">    2929 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2930 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_SET_SINGLE_VIDEO_SRC:</span>
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :                         ao2_lock(conference);</span>
<span class="lineNum">    2932 </span><span class="lineNoCov">          0 :                         if (!ast_test_flag(&amp;conference-&gt;b_profile, BRIDGE_OPT_VIDEO_SRC_SFU)) {</span>
<span class="lineNum">    2933 </span><span class="lineNoCov">          0 :                                 ast_bridge_set_single_src_video_mode(conference-&gt;bridge, bridge_channel-&gt;chan);</span>
<span class="lineNum">    2934 </span>            :                         }
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :                         ao2_unlock(conference);</span>
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :                 case MENU_ACTION_RELEASE_SINGLE_VIDEO_SRC:</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">          0 :                         handle_video_on_exit(conference, bridge_channel-&gt;chan);</span>
<span class="lineNum">    2939 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2940 </span>            :                 }
<span class="lineNum">    2941 </span><span class="lineCov">         14 :         }</span>
<span class="lineNum">    2942 </span><span class="lineCov">         14 :         return res;</span>
<a name="2943"><span class="lineNum">    2943 </span>            : }</a>
<span class="lineNum">    2944 </span>            : 
<span class="lineNum">    2945 </span><span class="lineCov">         14 : int conf_handle_dtmf(struct ast_bridge_channel *bridge_channel,</span>
<span class="lineNum">    2946 </span>            :         struct confbridge_user *user,
<span class="lineNum">    2947 </span>            :         struct conf_menu_entry *menu_entry,
<span class="lineNum">    2948 </span>            :         struct conf_menu *menu)
<span class="lineNum">    2949 </span>            : {
<span class="lineNum">    2950 </span>            :         /* See if music on hold is playing */
<span class="lineNum">    2951 </span><span class="lineCov">         14 :         conf_moh_suspend(user);</span>
<span class="lineNum">    2952 </span>            : 
<span class="lineNum">    2953 </span>            :         /* execute the list of actions associated with this menu entry */
<span class="lineNum">    2954 </span><span class="lineCov">         14 :         execute_menu_entry(user-&gt;conference, user, bridge_channel, menu_entry, menu);</span>
<span class="lineNum">    2955 </span>            : 
<span class="lineNum">    2956 </span>            :         /* See if music on hold needs to be started back up again */
<span class="lineNum">    2957 </span><span class="lineCov">         14 :         conf_moh_unsuspend(user);</span>
<span class="lineNum">    2958 </span>            : 
<span class="lineNum">    2959 </span><span class="lineCov">         14 :         async_play_sound_ready(bridge_channel-&gt;chan);</span>
<span class="lineNum">    2960 </span>            : 
<span class="lineNum">    2961 </span><span class="lineCov">         14 :         return 0;</span>
<a name="2962"><span class="lineNum">    2962 </span>            : }</a>
<span class="lineNum">    2963 </span>            : 
<span class="lineNum">    2964 </span><span class="lineCov">          4 : static int kick_conference_participant(struct confbridge_conference *conference,</span>
<span class="lineNum">    2965 </span>            :         const char *channel)
<span class="lineNum">    2966 </span>            : {
<span class="lineNum">    2967 </span><span class="lineCov">          4 :         int res = -1;</span>
<span class="lineNum">    2968 </span>            :         int match;
<span class="lineNum">    2969 </span><span class="lineCov">          4 :         struct confbridge_user *user = NULL;</span>
<span class="lineNum">    2970 </span><span class="lineCov">          4 :         int all = !strcasecmp(&quot;all&quot;, channel);</span>
<a name="2971"><span class="lineNum">    2971 </span><span class="lineCov">          4 :         int participants = !strcasecmp(&quot;participants&quot;, channel);</span></a>
<span class="lineNum">    2972 </span>            : 
<span class="lineNum">    2973 </span><span class="lineCov">         12 :         SCOPED_AO2LOCK(bridge_lock, conference);</span>
<span class="lineNum">    2974 </span>            : 
<span class="lineNum">    2975 </span><span class="lineCov">         10 :         AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    2976 </span><span class="lineCov">         10 :                 if (user-&gt;kicked) {</span>
<span class="lineNum">    2977 </span><span class="lineCov">          6 :                         continue;</span>
<span class="lineNum">    2978 </span>            :                 }
<span class="lineNum">    2979 </span><span class="lineCov">          4 :                 match = !strcasecmp(channel, ast_channel_name(user-&gt;chan));</span>
<span class="lineNum">    2980 </span><span class="lineCov">          4 :                 if (match || all</span>
<span class="lineNum">    2981 </span><span class="lineNoCov">          0 :                                 || (participants &amp;&amp; !ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN))) {</span>
<span class="lineNum">    2982 </span><span class="lineCov">          4 :                         user-&gt;kicked = 1;</span>
<span class="lineNum">    2983 </span><span class="lineCov">          4 :                         pbx_builtin_setvar_helper(user-&gt;chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;KICKED&quot;);</span>
<span class="lineNum">    2984 </span><span class="lineCov">          4 :                         ast_bridge_remove(conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    2985 </span><span class="lineCov">          4 :                         res = 0;</span>
<span class="lineNum">    2986 </span><span class="lineCov">          4 :                         if (match) {</span>
<span class="lineNum">    2987 </span><span class="lineCov">          4 :                                 return res;</span>
<span class="lineNum">    2988 </span>            :                         }
<span class="lineNum">    2989 </span>            :                 }
<span class="lineNum">    2990 </span>            :         }
<span class="lineNum">    2991 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :                 if (user-&gt;kicked) {</span>
<span class="lineNum">    2993 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2994 </span>            :                 }
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :                 match = !strcasecmp(channel, ast_channel_name(user-&gt;chan));</span>
<span class="lineNum">    2996 </span><span class="lineNoCov">          0 :                 if (match || all</span>
<span class="lineNum">    2997 </span><span class="lineNoCov">          0 :                                 || (participants &amp;&amp; !ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN))) {</span>
<span class="lineNum">    2998 </span><span class="lineNoCov">          0 :                         user-&gt;kicked = 1;</span>
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(user-&gt;chan, &quot;CONFBRIDGE_RESULT&quot;, &quot;KICKED&quot;);</span>
<span class="lineNum">    3000 </span><span class="lineNoCov">          0 :                         ast_bridge_remove(conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    3001 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">    3002 </span><span class="lineNoCov">          0 :                         if (match) {</span>
<span class="lineNum">    3003 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">    3004 </span>            :                         }
<span class="lineNum">    3005 </span>            :                 }
<span class="lineNum">    3006 </span>            :         }
<span class="lineNum">    3007 </span>            : 
<span class="lineNum">    3008 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="3009"><span class="lineNum">    3009 </span>            : }</a>
<span class="lineNum">    3010 </span>            : 
<span class="lineNum">    3011 </span><span class="lineNoCov">          0 : static char *complete_confbridge_name(const char *line, const char *word, int pos, int state)</span>
<span class="lineNum">    3012 </span>            : {
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :         int which = 0;</span>
<span class="lineNum">    3014 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :         char *res = NULL;</span>
<span class="lineNum">    3016 </span><span class="lineNoCov">          0 :         int wordlen = strlen(word);</span>
<span class="lineNum">    3017 </span>            :         struct ao2_iterator iter;
<span class="lineNum">    3018 </span>            : 
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :         iter = ao2_iterator_init(conference_bridges, 0);</span>
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :         while ((conference = ao2_iterator_next(&amp;iter))) {</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :                 if (!strncasecmp(conference-&gt;name, word, wordlen) &amp;&amp; ++which &gt; state) {</span>
<span class="lineNum">    3022 </span><span class="lineNoCov">          0 :                         res = ast_strdup(conference-&gt;name);</span>
<span class="lineNum">    3023 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    3024 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    3025 </span>            :                 }
<span class="lineNum">    3026 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3027 </span>            :         }
<span class="lineNum">    3028 </span><span class="lineNoCov">          0 :         ao2_iterator_destroy(&amp;iter);</span>
<span class="lineNum">    3029 </span>            : 
<span class="lineNum">    3030 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="3031"><span class="lineNum">    3031 </span>            : }</a>
<span class="lineNum">    3032 </span>            : 
<span class="lineNum">    3033 </span><span class="lineNoCov">          0 : static char *complete_confbridge_participant(const char *conference_name, const char *line, const char *word, int pos, int state)</span>
<a name="3034"><span class="lineNum">    3034 </span>            : {</a>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :         int which = 0;</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :         RAII_VAR(struct confbridge_conference *, conference, NULL, ao2_cleanup);</span>
<span class="lineNum">    3037 </span>            :         struct confbridge_user *user;
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :         char *res = NULL;</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :         int wordlen = strlen(word);</span>
<span class="lineNum">    3040 </span>            : 
<span class="lineNum">    3041 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3042 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3043 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3044 </span>            :         }
<span class="lineNum">    3045 </span>            : 
<span class="lineNum">    3046 </span><span class="lineNoCov">          0 :         if (!strncasecmp(&quot;all&quot;, word, wordlen) &amp;&amp; ++which &gt; state) {</span>
<span class="lineNum">    3047 </span><span class="lineNoCov">          0 :                 return ast_strdup(&quot;all&quot;);</span>
<span class="lineNum">    3048 </span>            :         }
<span class="lineNum">    3049 </span>            : 
<span class="lineNum">    3050 </span><span class="lineNoCov">          0 :         if (!strncasecmp(&quot;participants&quot;, word, wordlen) &amp;&amp; ++which &gt; state) {</span>
<span class="lineNum">    3051 </span><span class="lineNoCov">          0 :                 return ast_strdup(&quot;participants&quot;);</span>
<span class="lineNum">    3052 </span>            :         }
<a name="3053"><span class="lineNum">    3053 </span>            : </a>
<span class="lineNum">    3054 </span>            :         {
<span class="lineNum">    3055 </span><span class="lineNoCov">          0 :                 SCOPED_AO2LOCK(bridge_lock, conference);</span>
<span class="lineNum">    3056 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :                         if (!strncasecmp(ast_channel_name(user-&gt;chan), word, wordlen) &amp;&amp; ++which &gt; state) {</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :                                 res = ast_strdup(ast_channel_name(user-&gt;chan));</span>
<span class="lineNum">    3059 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">    3060 </span>            :                         }
<span class="lineNum">    3061 </span>            :                 }
<span class="lineNum">    3062 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    3063 </span><span class="lineNoCov">          0 :                         if (!strncasecmp(ast_channel_name(user-&gt;chan), word, wordlen) &amp;&amp; ++which &gt; state) {</span>
<span class="lineNum">    3064 </span><span class="lineNoCov">          0 :                                 res = ast_strdup(ast_channel_name(user-&gt;chan));</span>
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">    3066 </span>            :                         }
<span class="lineNum">    3067 </span>            :                 }
<span class="lineNum">    3068 </span>            :         }
<span class="lineNum">    3069 </span>            : 
<span class="lineNum">    3070 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="3071"><span class="lineNum">    3071 </span>            : }</a>
<span class="lineNum">    3072 </span>            : 
<span class="lineNum">    3073 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_kick(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3074 </span>            : {
<span class="lineNum">    3075 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3076 </span>            :         int not_found;
<span class="lineNum">    3077 </span>            : 
<span class="lineNum">    3078 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3079 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3080 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge kick&quot;;</span>
<span class="lineNum">    3081 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3082 </span>            :                         &quot;Usage: confbridge kick &lt;conference&gt; &lt;channel&gt;\n&quot;
<span class="lineNum">    3083 </span>            :                         &quot;       Kicks a channel out of the conference bridge.\n&quot;
<span class="lineNum">    3084 </span>            :                         &quot;             (all to kick everyone, participants to kick non-admins).\n&quot;;
<span class="lineNum">    3085 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3087 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3088 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3089 </span>            :                 }
<span class="lineNum">    3090 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 3) {</span>
<span class="lineNum">    3091 </span><span class="lineNoCov">          0 :                         return complete_confbridge_participant(a-&gt;argv[2], a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3092 </span>            :                 }
<span class="lineNum">    3093 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3094 </span>            :         }
<span class="lineNum">    3095 </span>            : 
<span class="lineNum">    3096 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 4) {</span>
<span class="lineNum">    3097 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3098 </span>            :         }
<span class="lineNum">    3099 </span>            : 
<span class="lineNum">    3100 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, a-&gt;argv[2], OBJ_KEY);</span>
<span class="lineNum">    3101 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3102 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;No conference bridge named '%s' found!\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3103 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3104 </span>            :         }
<span class="lineNum">    3105 </span><span class="lineNoCov">          0 :         not_found = kick_conference_participant(conference, a-&gt;argv[3]);</span>
<span class="lineNum">    3106 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3107 </span><span class="lineNoCov">          0 :         if (not_found) {</span>
<span class="lineNum">    3108 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(&quot;all&quot;, a-&gt;argv[3]) || !strcasecmp(&quot;participants&quot;, a-&gt;argv[3])) {</span>
<span class="lineNum">    3109 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No participants found!\n&quot;);</span>
<span class="lineNum">    3110 </span>            :                 } else {
<span class="lineNum">    3111 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No participant named '%s' found!\n&quot;, a-&gt;argv[3]);</span>
<span class="lineNum">    3112 </span>            :                 }
<span class="lineNum">    3113 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3114 </span>            :         }
<span class="lineNum">    3115 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;Kicked '%s' out of conference '%s'\n&quot;, a-&gt;argv[3], a-&gt;argv[2]);</span>
<span class="lineNum">    3116 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3117"><span class="lineNum">    3117 </span>            : }</a>
<span class="lineNum">    3118 </span>            : 
<span class="lineNum">    3119 </span><span class="lineNoCov">          0 : static void handle_cli_confbridge_list_item(struct ast_cli_args *a, struct confbridge_user *user, int waiting)</span>
<span class="lineNum">    3120 </span>            : {
<span class="lineNum">    3121 </span>            :         char flag_str[6 + 1];/* Max flags + terminator */
<span class="lineNum">    3122 </span><span class="lineNoCov">          0 :         int pos = 0;</span>
<span class="lineNum">    3123 </span>            : 
<span class="lineNum">    3124 </span>            :         /* Build flags column string. */
<span class="lineNum">    3125 </span><span class="lineNoCov">          0 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)) {</span>
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'A';</span>
<span class="lineNum">    3127 </span>            :         }
<span class="lineNum">    3128 </span><span class="lineNoCov">          0 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)) {</span>
<span class="lineNum">    3129 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'M';</span>
<span class="lineNum">    3130 </span>            :         }
<span class="lineNum">    3131 </span><span class="lineNoCov">          0 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_WAITMARKED)) {</span>
<span class="lineNum">    3132 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'W';</span>
<span class="lineNum">    3133 </span>            :         }
<span class="lineNum">    3134 </span><span class="lineNoCov">          0 :         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ENDMARKED)) {</span>
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'E';</span>
<span class="lineNum">    3136 </span>            :         }
<span class="lineNum">    3137 </span><span class="lineNoCov">          0 :         if (user-&gt;muted) {</span>
<span class="lineNum">    3138 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'm';</span>
<span class="lineNum">    3139 </span>            :         }
<span class="lineNum">    3140 </span><span class="lineNoCov">          0 :         if (waiting) {</span>
<span class="lineNum">    3141 </span><span class="lineNoCov">          0 :                 flag_str[pos++] = 'w';</span>
<span class="lineNum">    3142 </span>            :         }
<span class="lineNum">    3143 </span><span class="lineNoCov">          0 :         flag_str[pos] = '\0';</span>
<span class="lineNum">    3144 </span>            : 
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;%-30s %-6s %-16s %-16s %-16s %s\n&quot;,</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :                 ast_channel_name(user-&gt;chan),</span>
<span class="lineNum">    3147 </span>            :                 flag_str,
<span class="lineNum">    3148 </span><span class="lineNoCov">          0 :                 user-&gt;u_profile.name,</span>
<span class="lineNum">    3149 </span><span class="lineNoCov">          0 :                 user-&gt;conference-&gt;b_profile.name,</span>
<span class="lineNum">    3150 </span><span class="lineNoCov">          0 :                 user-&gt;menu_name,</span>
<span class="lineNum">    3151 </span><span class="lineNoCov">          0 :                 S_COR(ast_channel_caller(user-&gt;chan)-&gt;id.number.valid,</span>
<span class="lineNum">    3152 </span>            :                         ast_channel_caller(user-&gt;chan)-&gt;id.number.str, &quot;&lt;unknown&gt;&quot;));
<a name="3153"><span class="lineNum">    3153 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3154 </span>            : 
<span class="lineNum">    3155 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_list(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3156 </span>            : {
<span class="lineNum">    3157 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3158 </span>            : 
<span class="lineNum">    3159 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3160 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3161 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge list&quot;;</span>
<span class="lineNum">    3162 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3163 </span>            :                         &quot;Usage: confbridge list [&lt;name&gt;]\n&quot;
<span class="lineNum">    3164 </span>            :                         &quot;       Lists all currently active conference bridges or a specific conference bridge.\n&quot;
<span class="lineNum">    3165 </span>            :                         &quot;\n&quot;
<span class="lineNum">    3166 </span>            :                         &quot;       When a conference bridge name is provided, flags may be shown for users. Below\n&quot;
<span class="lineNum">    3167 </span>            :                         &quot;       are the flags and what they represent.\n&quot;
<span class="lineNum">    3168 </span>            :                         &quot;\n&quot;
<span class="lineNum">    3169 </span>            :                         &quot;       Flags:\n&quot;
<span class="lineNum">    3170 </span>            :                         &quot;         A - The user is an admin\n&quot;
<span class="lineNum">    3171 </span>            :                         &quot;         M - The user is a marked user\n&quot;
<span class="lineNum">    3172 </span>            :                         &quot;         W - The user must wait for a marked user to join\n&quot;
<span class="lineNum">    3173 </span>            :                         &quot;         E - The user will be kicked after the last marked user leaves the conference\n&quot;
<span class="lineNum">    3174 </span>            :                         &quot;         m - The user is muted\n&quot;
<span class="lineNum">    3175 </span>            :                         &quot;         w - The user is waiting for a marked user to join\n&quot;;
<span class="lineNum">    3176 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3178 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3179 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3180 </span>            :                 }
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3182 </span>            :         }
<span class="lineNum">    3183 </span>            : 
<span class="lineNum">    3184 </span><span class="lineNoCov">          0 :         if (a-&gt;argc == 2) {</span>
<span class="lineNum">    3185 </span>            :                 struct ao2_iterator iter;
<span class="lineNum">    3186 </span>            : 
<span class="lineNum">    3187 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference Bridge Name           Users  Marked Locked Muted\n&quot;);</span>
<span class="lineNum">    3188 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;================================ ====== ====== ====== =====\n&quot;);</span>
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :                 iter = ao2_iterator_init(conference_bridges, 0);</span>
<span class="lineNum">    3190 </span><span class="lineNoCov">          0 :                 while ((conference = ao2_iterator_next(&amp;iter))) {</span>
<span class="lineNum">    3191 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;%-32s %6u %6u %-6s %s\n&quot;,</span>
<span class="lineNum">    3192 </span><span class="lineNoCov">          0 :                                 conference-&gt;name,</span>
<span class="lineNum">    3193 </span><span class="lineNoCov">          0 :                                 conference-&gt;activeusers + conference-&gt;waitingusers,</span>
<span class="lineNum">    3194 </span>            :                                 conference-&gt;markedusers,
<span class="lineNum">    3195 </span><span class="lineNoCov">          0 :                                 AST_CLI_YESNO(conference-&gt;locked),</span>
<span class="lineNum">    3196 </span><span class="lineNoCov">          0 :                                 AST_CLI_YESNO(conference-&gt;muted));</span>
<span class="lineNum">    3197 </span><span class="lineNoCov">          0 :                         ao2_ref(conference, -1);</span>
<span class="lineNum">    3198 </span>            :                 }
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :                 ao2_iterator_destroy(&amp;iter);</span>
<span class="lineNum">    3200 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3201 </span>            :         }
<span class="lineNum">    3202 </span>            : 
<span class="lineNum">    3203 </span><span class="lineNoCov">          0 :         if (a-&gt;argc == 3) {</span>
<span class="lineNum">    3204 </span>            :                 struct confbridge_user *user;
<span class="lineNum">    3205 </span>            : 
<span class="lineNum">    3206 </span><span class="lineNoCov">          0 :                 conference = ao2_find(conference_bridges, a-&gt;argv[2], OBJ_KEY);</span>
<span class="lineNum">    3207 </span><span class="lineNoCov">          0 :                 if (!conference) {</span>
<span class="lineNum">    3208 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No conference bridge named '%s' found!\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3209 </span><span class="lineNoCov">          0 :                         return CLI_SUCCESS;</span>
<span class="lineNum">    3210 </span>            :                 }
<span class="lineNum">    3211 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Channel                        Flags  User Profile     Bridge Profile   Menu             CallerID\n&quot;);</span>
<span class="lineNum">    3212 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;============================== ====== ================ ================ ================ ================\n&quot;);</span>
<span class="lineNum">    3213 </span><span class="lineNoCov">          0 :                 ao2_lock(conference);</span>
<span class="lineNum">    3214 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3215 </span><span class="lineNoCov">          0 :                         handle_cli_confbridge_list_item(a, user, 0);</span>
<span class="lineNum">    3216 </span>            :                 }
<span class="lineNum">    3217 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    3218 </span><span class="lineNoCov">          0 :                         handle_cli_confbridge_list_item(a, user, 1);</span>
<span class="lineNum">    3219 </span>            :                 }
<span class="lineNum">    3220 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3221 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3222 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3223 </span>            :         }
<span class="lineNum">    3224 </span>            : 
<span class="lineNum">    3225 </span><span class="lineNoCov">          0 :         return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3226 </span>            : }
<span class="lineNum">    3227 </span>            : 
<span class="lineNum">    3228 </span>            : /* \internal
<span class="lineNum">    3229 </span>            :  * \brief finds a conference by name and locks/unlocks.
<span class="lineNum">    3230 </span>            :  *
<span class="lineNum">    3231 </span>            :  * \retval 0 success
<a name="3232"><span class="lineNum">    3232 </span>            :  * \retval -1 conference not found</a>
<span class="lineNum">    3233 </span>            :  */
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 : static int generic_lock_unlock_helper(int lock, const char *conference_name)</span>
<span class="lineNum">    3235 </span>            : {
<span class="lineNum">    3236 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">    3238 </span>            : 
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3242 </span>            :         }
<span class="lineNum">    3243 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3244 </span><span class="lineNoCov">          0 :         conference-&gt;locked = lock;</span>
<span class="lineNum">    3245 </span><span class="lineNoCov">          0 :         ast_test_suite_event_notify(&quot;CONF_LOCK&quot;, &quot;Message: conference %s\r\nConference: %s&quot;, conference-&gt;locked ? &quot;locked&quot; : &quot;unlocked&quot;, conference-&gt;b_profile.name);</span>
<span class="lineNum">    3246 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3247 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3248 </span>            : 
<span class="lineNum">    3249 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    3250 </span>            : }
<span class="lineNum">    3251 </span>            : 
<span class="lineNum">    3252 </span>            : /* \internal
<span class="lineNum">    3253 </span>            :  * \brief finds a conference user by channel name and mutes/unmutes them.
<span class="lineNum">    3254 </span>            :  *
<span class="lineNum">    3255 </span>            :  * \retval 0 success
<span class="lineNum">    3256 </span>            :  * \retval -1 conference not found
<a name="3257"><span class="lineNum">    3257 </span>            :  * \retval -2 user not found</a>
<span class="lineNum">    3258 </span>            :  */
<span class="lineNum">    3259 </span><span class="lineNoCov">          0 : static int generic_mute_unmute_helper(int mute, const char *conference_name,</span>
<a name="3260"><span class="lineNum">    3260 </span>            :         const char *chan_name)</a>
<span class="lineNum">    3261 </span>            : {
<span class="lineNum">    3262 </span><span class="lineNoCov">          0 :         RAII_VAR(struct confbridge_conference *, conference, NULL, ao2_cleanup);</span>
<span class="lineNum">    3263 </span>            :         struct confbridge_user *user;
<span class="lineNum">    3264 </span><span class="lineNoCov">          0 :         int all = !strcasecmp(&quot;all&quot;, chan_name);</span>
<span class="lineNum">    3265 </span><span class="lineNoCov">          0 :         int participants = !strcasecmp(&quot;participants&quot;, chan_name);</span>
<span class="lineNum">    3266 </span><span class="lineNoCov">          0 :         int res = -2;</span>
<span class="lineNum">    3267 </span>            : 
<span class="lineNum">    3268 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3269 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3270 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3271 </span>            :         }
<a name="3272"><span class="lineNum">    3272 </span>            : </a>
<span class="lineNum">    3273 </span>            :         {
<span class="lineNum">    3274 </span><span class="lineNoCov">          0 :                 SCOPED_AO2LOCK(bridge_lock, conference);</span>
<span class="lineNum">    3275 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3276 </span><span class="lineNoCov">          0 :                         int match = !strncasecmp(chan_name, ast_channel_name(user-&gt;chan),</span>
<span class="lineNum">    3277 </span>            :                                 strlen(chan_name));
<span class="lineNum">    3278 </span><span class="lineNoCov">          0 :                         if (match || all</span>
<span class="lineNum">    3279 </span><span class="lineNoCov">          0 :                                 || (participants &amp;&amp; !ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN))) {</span>
<span class="lineNum">    3280 </span><span class="lineNoCov">          0 :                                 generic_mute_unmute_user(conference, user, mute);</span>
<span class="lineNum">    3281 </span><span class="lineNoCov">          0 :                                 res = 0;</span>
<span class="lineNum">    3282 </span><span class="lineNoCov">          0 :                                 if (match) {</span>
<span class="lineNum">    3283 </span><span class="lineNoCov">          0 :                                         return res;</span>
<span class="lineNum">    3284 </span>            :                                 }
<span class="lineNum">    3285 </span>            :                         }
<span class="lineNum">    3286 </span>            :                 }
<span class="lineNum">    3287 </span>            : 
<span class="lineNum">    3288 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    3289 </span><span class="lineNoCov">          0 :                         int match = !strncasecmp(chan_name, ast_channel_name(user-&gt;chan),</span>
<span class="lineNum">    3290 </span>            :                                 strlen(chan_name));
<span class="lineNum">    3291 </span><span class="lineNoCov">          0 :                         if (match || all</span>
<span class="lineNum">    3292 </span><span class="lineNoCov">          0 :                                 || (participants &amp;&amp; !ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN))) {</span>
<span class="lineNum">    3293 </span><span class="lineNoCov">          0 :                                 generic_mute_unmute_user(conference, user, mute);</span>
<span class="lineNum">    3294 </span><span class="lineNoCov">          0 :                                 res = 0;</span>
<span class="lineNum">    3295 </span><span class="lineNoCov">          0 :                                 if (match) {</span>
<span class="lineNum">    3296 </span><span class="lineNoCov">          0 :                                         return res;</span>
<span class="lineNum">    3297 </span>            :                                 }
<span class="lineNum">    3298 </span>            :                         }
<span class="lineNum">    3299 </span>            :                 }
<span class="lineNum">    3300 </span>            :         }
<span class="lineNum">    3301 </span>            : 
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="3303"><span class="lineNum">    3303 </span>            : }</a>
<span class="lineNum">    3304 </span>            : 
<span class="lineNum">    3305 </span><span class="lineNoCov">          0 : static int cli_mute_unmute_helper(int mute, struct ast_cli_args *a)</span>
<span class="lineNum">    3306 </span>            : {
<span class="lineNum">    3307 </span><span class="lineNoCov">          0 :         int res = generic_mute_unmute_helper(mute, a-&gt;argv[2], a-&gt;argv[3]);</span>
<span class="lineNum">    3308 </span>            : 
<span class="lineNum">    3309 </span><span class="lineNoCov">          0 :         if (res == -1) {</span>
<span class="lineNum">    3310 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;No conference bridge named '%s' found!\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3311 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3312 </span><span class="lineNoCov">          0 :         } else if (res == -2) {</span>
<span class="lineNum">    3313 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(&quot;all&quot;, a-&gt;argv[3]) || !strcasecmp(&quot;participants&quot;, a-&gt;argv[3])) {</span>
<span class="lineNum">    3314 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No participants found in conference %s\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3315 </span>            :                 } else {
<span class="lineNum">    3316 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No channel named '%s' found in conference %s\n&quot;, a-&gt;argv[3], a-&gt;argv[2]);</span>
<span class="lineNum">    3317 </span>            :                 }
<span class="lineNum">    3318 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3319 </span>            :         }
<span class="lineNum">    3320 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;%s %s from confbridge %s\n&quot;, mute ? &quot;Muting&quot; : &quot;Unmuting&quot;, a-&gt;argv[3], a-&gt;argv[2]);</span>
<span class="lineNum">    3321 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3322"><span class="lineNum">    3322 </span>            : }</a>
<span class="lineNum">    3323 </span>            : 
<span class="lineNum">    3324 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_mute(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3325 </span>            : {
<span class="lineNum">    3326 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3327 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3328 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge mute&quot;;</span>
<span class="lineNum">    3329 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3330 </span>            :                         &quot;Usage: confbridge mute &lt;conference&gt; &lt;channel&gt;\n&quot;
<span class="lineNum">    3331 </span>            :                         &quot;       Mute a channel in a conference.\n&quot;
<span class="lineNum">    3332 </span>            :                         &quot;              (all to mute everyone, participants to mute non-admins)\n&quot;
<span class="lineNum">    3333 </span>            :                         &quot;       If the specified channel is a prefix,\n&quot;
<span class="lineNum">    3334 </span>            :                         &quot;       the action will be taken on the first\n&quot;
<span class="lineNum">    3335 </span>            :                         &quot;       matching channel.\n&quot;;
<span class="lineNum">    3336 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3337 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3338 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3339 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3340 </span>            :                 }
<span class="lineNum">    3341 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 3) {</span>
<span class="lineNum">    3342 </span><span class="lineNoCov">          0 :                         return complete_confbridge_participant(a-&gt;argv[2], a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3343 </span>            :                 }
<span class="lineNum">    3344 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3345 </span>            :         }
<span class="lineNum">    3346 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 4) {</span>
<span class="lineNum">    3347 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3348 </span>            :         }
<span class="lineNum">    3349 </span>            : 
<span class="lineNum">    3350 </span><span class="lineNoCov">          0 :         cli_mute_unmute_helper(1, a);</span>
<span class="lineNum">    3351 </span>            : 
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3353"><span class="lineNum">    3353 </span>            : }</a>
<span class="lineNum">    3354 </span>            : 
<span class="lineNum">    3355 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_unmute(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3356 </span>            : {
<span class="lineNum">    3357 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3358 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3359 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge unmute&quot;;</span>
<span class="lineNum">    3360 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3361 </span>            :                         &quot;Usage: confbridge unmute &lt;conference&gt; &lt;channel&gt;\n&quot;
<span class="lineNum">    3362 </span>            :                         &quot;       Unmute a channel in a conference.\n&quot;
<span class="lineNum">    3363 </span>            :                         &quot;              (all to unmute everyone, participants to unmute non-admins)\n&quot;
<span class="lineNum">    3364 </span>            :                         &quot;       If the specified channel is a prefix,\n&quot;
<span class="lineNum">    3365 </span>            :                         &quot;       the action will be taken on the first\n&quot;
<span class="lineNum">    3366 </span>            :                         &quot;       matching channel.\n&quot;;
<span class="lineNum">    3367 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3368 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3370 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3371 </span>            :                 }
<span class="lineNum">    3372 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 3) {</span>
<span class="lineNum">    3373 </span><span class="lineNoCov">          0 :                         return complete_confbridge_participant(a-&gt;argv[2], a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3374 </span>            :                 }
<span class="lineNum">    3375 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3376 </span>            :         }
<span class="lineNum">    3377 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 4) {</span>
<span class="lineNum">    3378 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3379 </span>            :         }
<span class="lineNum">    3380 </span>            : 
<span class="lineNum">    3381 </span><span class="lineNoCov">          0 :         cli_mute_unmute_helper(0, a);</span>
<span class="lineNum">    3382 </span>            : 
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3384"><span class="lineNum">    3384 </span>            : }</a>
<span class="lineNum">    3385 </span>            : 
<span class="lineNum">    3386 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_lock(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3387 </span>            : {
<span class="lineNum">    3388 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3389 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3390 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge lock&quot;;</span>
<span class="lineNum">    3391 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3392 </span>            :                         &quot;Usage: confbridge lock &lt;conference&gt;\n&quot;
<span class="lineNum">    3393 </span>            :                         &quot;       Lock a conference. While locked, no new non-admins\n&quot;
<span class="lineNum">    3394 </span>            :                         &quot;       may join the conference.\n&quot;;
<span class="lineNum">    3395 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3396 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3397 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3398 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3399 </span>            :                 }
<span class="lineNum">    3400 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3401 </span>            :         }
<span class="lineNum">    3402 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 3) {</span>
<span class="lineNum">    3403 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3404 </span>            :         }
<span class="lineNum">    3405 </span><span class="lineNoCov">          0 :         if (generic_lock_unlock_helper(1, a-&gt;argv[2])) {</span>
<span class="lineNum">    3406 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference %s is not found\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3407 </span>            :         } else {
<span class="lineNum">    3408 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference %s is locked.\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3409 </span>            :         }
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3411"><span class="lineNum">    3411 </span>            : }</a>
<span class="lineNum">    3412 </span>            : 
<span class="lineNum">    3413 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_unlock(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3414 </span>            : {
<span class="lineNum">    3415 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3416 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3417 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge unlock&quot;;</span>
<span class="lineNum">    3418 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3419 </span>            :                         &quot;Usage: confbridge unlock &lt;conference&gt;\n&quot;
<span class="lineNum">    3420 </span>            :                         &quot;       Unlock a previously locked conference.\n&quot;;
<span class="lineNum">    3421 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3422 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3423 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 2) {</span>
<span class="lineNum">    3424 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3425 </span>            :                 }
<span class="lineNum">    3426 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3427 </span>            :         }
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 3) {</span>
<span class="lineNum">    3429 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3430 </span>            :         }
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :         if (generic_lock_unlock_helper(0, a-&gt;argv[2])) {</span>
<span class="lineNum">    3432 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference %s is not found\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3433 </span>            :         } else {
<span class="lineNum">    3434 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference %s is unlocked.\n&quot;, a-&gt;argv[2]);</span>
<span class="lineNum">    3435 </span>            :         }
<span class="lineNum">    3436 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3437"><span class="lineNum">    3437 </span>            : }</a>
<span class="lineNum">    3438 </span>            : 
<span class="lineNum">    3439 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_start_record(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3440 </span>            : {
<span class="lineNum">    3441 </span><span class="lineCov">       1117 :         const char *rec_file = NULL;</span>
<span class="lineNum">    3442 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3443 </span>            : 
<span class="lineNum">    3444 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3445 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3446 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge record start&quot;;</span>
<span class="lineNum">    3447 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3448 </span>            :                         &quot;Usage: confbridge record start &lt;conference&gt; &lt;file&gt;\n&quot;
<span class="lineNum">    3449 </span>            :                         &quot;       &lt;file&gt; is optional, Otherwise the bridge profile\n&quot;
<span class="lineNum">    3450 </span>            :                         &quot;       record file will be used.  If the bridge profile\n&quot;
<span class="lineNum">    3451 </span>            :                         &quot;       has no record file specified, a file will automatically\n&quot;
<span class="lineNum">    3452 </span>            :                         &quot;       be generated in the monitor directory\n&quot;;
<span class="lineNum">    3453 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3455 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 3) {</span>
<span class="lineNum">    3456 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3457 </span>            :                 }
<span class="lineNum">    3458 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3459 </span>            :         }
<span class="lineNum">    3460 </span><span class="lineNoCov">          0 :         if (a-&gt;argc &lt; 4) {</span>
<span class="lineNum">    3461 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3462 </span>            :         }
<span class="lineNum">    3463 </span><span class="lineNoCov">          0 :         if (a-&gt;argc == 5) {</span>
<span class="lineNum">    3464 </span><span class="lineNoCov">          0 :                 rec_file = a-&gt;argv[4];</span>
<span class="lineNum">    3465 </span>            :         }
<span class="lineNum">    3466 </span>            : 
<span class="lineNum">    3467 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, a-&gt;argv[3], OBJ_KEY);</span>
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference not found.\n&quot;);</span>
<span class="lineNum">    3470 </span><span class="lineNoCov">          0 :                 return CLI_FAILURE;</span>
<span class="lineNum">    3471 </span>            :         }
<span class="lineNum">    3472 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3473 </span><span class="lineNoCov">          0 :         if (conf_is_recording(conference)) {</span>
<span class="lineNum">    3474 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference is already being recorded.\n&quot;);</span>
<span class="lineNum">    3475 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3476 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3477 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3478 </span>            :         }
<span class="lineNum">    3479 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(rec_file)) {</span>
<span class="lineNum">    3480 </span><span class="lineNoCov">          0 :                 ast_copy_string(conference-&gt;b_profile.rec_file, rec_file, sizeof(conference-&gt;b_profile.rec_file));</span>
<span class="lineNum">    3481 </span>            :         }
<span class="lineNum">    3482 </span>            : 
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :         if (conf_start_record(conference)) {</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Could not start recording due to internal error.\n&quot;);</span>
<span class="lineNum">    3485 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3486 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3487 </span><span class="lineNoCov">          0 :                 return CLI_FAILURE;</span>
<span class="lineNum">    3488 </span>            :         }
<span class="lineNum">    3489 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3490 </span>            : 
<span class="lineNum">    3491 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;Recording started\n&quot;);</span>
<span class="lineNum">    3492 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3493 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="3494"><span class="lineNum">    3494 </span>            : }</a>
<span class="lineNum">    3495 </span>            : 
<span class="lineNum">    3496 </span><span class="lineCov">       1117 : static char *handle_cli_confbridge_stop_record(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">    3497 </span>            : {
<span class="lineNum">    3498 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3499 </span>            :         int ret;
<span class="lineNum">    3500 </span>            : 
<span class="lineNum">    3501 </span><span class="lineCov">       1117 :         switch (cmd) {</span>
<span class="lineNum">    3502 </span><span class="lineCov">       1117 :         case CLI_INIT:</span>
<span class="lineNum">    3503 </span><span class="lineCov">       1117 :                 e-&gt;command = &quot;confbridge record stop&quot;;</span>
<span class="lineNum">    3504 </span><span class="lineCov">       1117 :                 e-&gt;usage =</span>
<span class="lineNum">    3505 </span>            :                         &quot;Usage: confbridge record stop &lt;conference&gt;\n&quot;
<span class="lineNum">    3506 </span>            :                         &quot;       Stop a previously started recording.\n&quot;;
<span class="lineNum">    3507 </span><span class="lineCov">       1117 :                 return NULL;</span>
<span class="lineNum">    3508 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">    3509 </span><span class="lineNoCov">          0 :                 if (a-&gt;pos == 3) {</span>
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :                         return complete_confbridge_name(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">    3511 </span>            :                 }
<span class="lineNum">    3512 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3513 </span>            :         }
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 4) {</span>
<span class="lineNum">    3515 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">    3516 </span>            :         }
<span class="lineNum">    3517 </span>            : 
<span class="lineNum">    3518 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, a-&gt;argv[3], OBJ_KEY);</span>
<span class="lineNum">    3519 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3520 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;Conference not found.\n&quot;);</span>
<span class="lineNum">    3521 </span><span class="lineNoCov">          0 :                 return CLI_SUCCESS;</span>
<span class="lineNum">    3522 </span>            :         }
<span class="lineNum">    3523 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3524 </span><span class="lineNoCov">          0 :         ret = conf_stop_record(conference);</span>
<span class="lineNum">    3525 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3526 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;Recording %sstopped.\n&quot;, ret ? &quot;could not be &quot; : &quot;&quot;);</span>
<span class="lineNum">    3527 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3528 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<span class="lineNum">    3529 </span>            : }
<span class="lineNum">    3530 </span>            : 
<span class="lineNum">    3531 </span>            : static struct ast_cli_entry cli_confbridge[] = {
<span class="lineNum">    3532 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_list, &quot;List conference bridges and participants.&quot;),
<span class="lineNum">    3533 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_kick, &quot;Kick participants out of conference bridges.&quot;),
<span class="lineNum">    3534 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_mute, &quot;Mute participants.&quot;),
<span class="lineNum">    3535 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_unmute, &quot;Unmute participants.&quot;),
<span class="lineNum">    3536 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_lock, &quot;Lock a conference.&quot;),
<span class="lineNum">    3537 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_unlock, &quot;Unlock a conference.&quot;),
<span class="lineNum">    3538 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_start_record, &quot;Start recording a conference&quot;),
<span class="lineNum">    3539 </span>            :         AST_CLI_DEFINE(handle_cli_confbridge_stop_record, &quot;Stop recording a conference.&quot;),
<span class="lineNum">    3540 </span>            : };
<span class="lineNum">    3541 </span>            : static struct ast_custom_function confbridge_function = {
<span class="lineNum">    3542 </span>            :         .name = &quot;CONFBRIDGE&quot;,
<span class="lineNum">    3543 </span>            :         .write = func_confbridge_helper,
<span class="lineNum">    3544 </span>            : };
<span class="lineNum">    3545 </span>            : 
<span class="lineNum">    3546 </span>            : static int func_confbridge_info(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t len);
<span class="lineNum">    3547 </span>            : static struct ast_custom_function confbridge_info_function = {
<span class="lineNum">    3548 </span>            :         .name = &quot;CONFBRIDGE_INFO&quot;,
<span class="lineNum">    3549 </span>            :         .read = func_confbridge_info,
<a name="3550"><span class="lineNum">    3550 </span>            : };</a>
<span class="lineNum">    3551 </span>            : 
<span class="lineNum">    3552 </span><span class="lineCov">          4 : static int action_confbridgelist_item(struct mansession *s, const char *id_text, struct confbridge_conference *conference, struct confbridge_user *user, int waiting)</span>
<span class="lineNum">    3553 </span>            : {
<span class="lineNum">    3554 </span>            :         struct ast_channel_snapshot *snapshot;
<span class="lineNum">    3555 </span>            :         struct ast_str *snap_str;
<span class="lineNum">    3556 </span>            : 
<span class="lineNum">    3557 </span><span class="lineCov">          4 :         snapshot = ast_channel_snapshot_get_latest(ast_channel_uniqueid(user-&gt;chan));</span>
<span class="lineNum">    3558 </span><span class="lineCov">          4 :         if (!snapshot) {</span>
<span class="lineNum">    3559 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3560 </span>            :         }
<span class="lineNum">    3561 </span>            : 
<span class="lineNum">    3562 </span><span class="lineCov">          4 :         snap_str = ast_manager_build_channel_state_string(snapshot);</span>
<span class="lineNum">    3563 </span><span class="lineCov">          4 :         if (!snap_str) {</span>
<span class="lineNum">    3564 </span><span class="lineNoCov">          0 :                 ao2_ref(snapshot, -1);</span>
<span class="lineNum">    3565 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3566 </span>            :         }
<span class="lineNum">    3567 </span>            : 
<span class="lineNum">    3568 </span><span class="lineCov">         28 :         astman_append(s,</span>
<span class="lineNum">    3569 </span>            :                 &quot;Event: ConfbridgeList\r\n&quot;
<span class="lineNum">    3570 </span>            :                 &quot;%s&quot;
<span class="lineNum">    3571 </span>            :                 &quot;Conference: %s\r\n&quot;
<span class="lineNum">    3572 </span>            :                 &quot;Admin: %s\r\n&quot;
<span class="lineNum">    3573 </span>            :                 &quot;MarkedUser: %s\r\n&quot;
<span class="lineNum">    3574 </span>            :                 &quot;WaitMarked: %s\r\n&quot;
<span class="lineNum">    3575 </span>            :                 &quot;EndMarked: %s\r\n&quot;
<span class="lineNum">    3576 </span>            :                 &quot;Waiting: %s\r\n&quot;
<span class="lineNum">    3577 </span>            :                 &quot;Muted: %s\r\n&quot;
<span class="lineNum">    3578 </span>            :                 &quot;Talking: %s\r\n&quot;
<span class="lineNum">    3579 </span>            :                 &quot;AnsweredTime: %d\r\n&quot;
<span class="lineNum">    3580 </span>            :                 &quot;%s&quot;
<span class="lineNum">    3581 </span>            :                 &quot;\r\n&quot;,
<span class="lineNum">    3582 </span>            :                 id_text,
<span class="lineNum">    3583 </span><span class="lineCov">          4 :                 conference-&gt;name,</span>
<span class="lineNum">    3584 </span><span class="lineCov">          4 :                 AST_YESNO(ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)),</span>
<span class="lineNum">    3585 </span><span class="lineCov">          4 :                 AST_YESNO(ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)),</span>
<span class="lineNum">    3586 </span><span class="lineCov">          4 :                 AST_YESNO(ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_WAITMARKED)),</span>
<span class="lineNum">    3587 </span><span class="lineCov">          4 :                 AST_YESNO(ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ENDMARKED)),</span>
<span class="lineNum">    3588 </span>            :                 AST_YESNO(waiting),
<span class="lineNum">    3589 </span><span class="lineCov">          4 :                 AST_YESNO(user-&gt;muted),</span>
<span class="lineNum">    3590 </span><span class="lineCov">          4 :                 AST_YESNO(user-&gt;talking),</span>
<span class="lineNum">    3591 </span>            :                 ast_channel_get_up_time(user-&gt;chan),
<span class="lineNum">    3592 </span>            :                 ast_str_buffer(snap_str));
<span class="lineNum">    3593 </span>            : 
<span class="lineNum">    3594 </span><span class="lineCov">          4 :         ast_free(snap_str);</span>
<span class="lineNum">    3595 </span><span class="lineCov">          4 :         ao2_ref(snapshot, -1);</span>
<span class="lineNum">    3596 </span>            : 
<span class="lineNum">    3597 </span><span class="lineCov">          4 :         return 1;</span>
<a name="3598"><span class="lineNum">    3598 </span>            : }</a>
<span class="lineNum">    3599 </span>            : 
<span class="lineNum">    3600 </span><span class="lineCov">          4 : static int action_confbridgelist(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3601 </span>            : {
<span class="lineNum">    3602 </span><span class="lineCov">          4 :         const char *actionid = astman_get_header(m, &quot;ActionID&quot;);</span>
<span class="lineNum">    3603 </span><span class="lineCov">          4 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3604 </span>            :         struct confbridge_user *user;
<span class="lineNum">    3605 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3606 </span>            :         char id_text[80];
<span class="lineNum">    3607 </span><span class="lineCov">          4 :         int total = 0;</span>
<span class="lineNum">    3608 </span>            : 
<span class="lineNum">    3609 </span><span class="lineCov">          4 :         id_text[0] = '\0';</span>
<span class="lineNum">    3610 </span><span class="lineCov">          4 :         if (!ast_strlen_zero(actionid)) {</span>
<span class="lineNum">    3611 </span><span class="lineCov">          4 :                 snprintf(id_text, sizeof(id_text), &quot;ActionID: %s\r\n&quot;, actionid);</span>
<span class="lineNum">    3612 </span>            :         }
<span class="lineNum">    3613 </span><span class="lineCov">          4 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3614 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3615 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3616 </span>            :         }
<span class="lineNum">    3617 </span><span class="lineCov">          4 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3618 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3619 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3620 </span>            :         }
<span class="lineNum">    3621 </span><span class="lineCov">          4 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3622 </span><span class="lineCov">          4 :         if (!conference) {</span>
<span class="lineNum">    3623 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3624 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3625 </span>            :         }
<span class="lineNum">    3626 </span>            : 
<span class="lineNum">    3627 </span><span class="lineCov">          4 :         astman_send_listack(s, m, &quot;Confbridge user list will follow&quot;, &quot;start&quot;);</span>
<span class="lineNum">    3628 </span>            : 
<span class="lineNum">    3629 </span><span class="lineCov">          4 :         ao2_lock(conference);</span>
<span class="lineNum">    3630 </span><span class="lineCov">          8 :         AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3631 </span><span class="lineCov">          4 :                 total += action_confbridgelist_item(s, id_text, conference, user, 0);</span>
<span class="lineNum">    3632 </span>            :         }
<span class="lineNum">    3633 </span><span class="lineCov">          4 :         AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    3634 </span><span class="lineNoCov">          0 :                 total += action_confbridgelist_item(s, id_text, conference, user, 1);</span>
<span class="lineNum">    3635 </span>            :         }
<span class="lineNum">    3636 </span><span class="lineCov">          4 :         ao2_unlock(conference);</span>
<span class="lineNum">    3637 </span><span class="lineCov">          4 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3638 </span>            : 
<span class="lineNum">    3639 </span><span class="lineCov">          4 :         astman_send_list_complete_start(s, m, &quot;ConfbridgeListComplete&quot;, total);</span>
<span class="lineNum">    3640 </span><span class="lineCov">          4 :         astman_send_list_complete_end(s);</span>
<span class="lineNum">    3641 </span>            : 
<span class="lineNum">    3642 </span><span class="lineCov">          4 :         return 0;</span>
<a name="3643"><span class="lineNum">    3643 </span>            : }</a>
<span class="lineNum">    3644 </span>            : 
<span class="lineNum">    3645 </span><span class="lineNoCov">          0 : static int action_confbridgelistrooms(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3646 </span>            : {
<span class="lineNum">    3647 </span><span class="lineNoCov">          0 :         const char *actionid = astman_get_header(m, &quot;ActionID&quot;);</span>
<span class="lineNum">    3648 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3649 </span>            :         struct ao2_iterator iter;
<span class="lineNum">    3650 </span><span class="lineNoCov">          0 :         char id_text[512] = &quot;&quot;;</span>
<span class="lineNum">    3651 </span><span class="lineNoCov">          0 :         int totalitems = 0;</span>
<span class="lineNum">    3652 </span>            : 
<span class="lineNum">    3653 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(actionid)) {</span>
<span class="lineNum">    3654 </span><span class="lineNoCov">          0 :                 snprintf(id_text, sizeof(id_text), &quot;ActionID: %s\r\n&quot;, actionid);</span>
<span class="lineNum">    3655 </span>            :         }
<span class="lineNum">    3656 </span>            : 
<span class="lineNum">    3657 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3658 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3659 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3660 </span>            :         }
<span class="lineNum">    3661 </span>            : 
<span class="lineNum">    3662 </span><span class="lineNoCov">          0 :         astman_send_listack(s, m, &quot;Confbridge conferences will follow&quot;, &quot;start&quot;);</span>
<span class="lineNum">    3663 </span>            : 
<span class="lineNum">    3664 </span>            :         /* Traverse the conference list */
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 :         iter = ao2_iterator_init(conference_bridges, 0);</span>
<span class="lineNum">    3666 </span><span class="lineNoCov">          0 :         while ((conference = ao2_iterator_next(&amp;iter))) {</span>
<span class="lineNum">    3667 </span><span class="lineNoCov">          0 :                 totalitems++;</span>
<span class="lineNum">    3668 </span>            : 
<span class="lineNum">    3669 </span><span class="lineNoCov">          0 :                 ao2_lock(conference);</span>
<span class="lineNum">    3670 </span><span class="lineNoCov">          0 :                 astman_append(s,</span>
<span class="lineNum">    3671 </span>            :                 &quot;Event: ConfbridgeListRooms\r\n&quot;
<span class="lineNum">    3672 </span>            :                 &quot;%s&quot;
<span class="lineNum">    3673 </span>            :                 &quot;Conference: %s\r\n&quot;
<span class="lineNum">    3674 </span>            :                 &quot;Parties: %u\r\n&quot;
<span class="lineNum">    3675 </span>            :                 &quot;Marked: %u\r\n&quot;
<span class="lineNum">    3676 </span>            :                 &quot;Locked: %s\r\n&quot;
<span class="lineNum">    3677 </span>            :                 &quot;Muted: %s\r\n&quot;
<span class="lineNum">    3678 </span>            :                 &quot;\r\n&quot;,
<span class="lineNum">    3679 </span>            :                 id_text,
<span class="lineNum">    3680 </span><span class="lineNoCov">          0 :                 conference-&gt;name,</span>
<span class="lineNum">    3681 </span><span class="lineNoCov">          0 :                 conference-&gt;activeusers + conference-&gt;waitingusers,</span>
<span class="lineNum">    3682 </span>            :                 conference-&gt;markedusers,
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 :                 AST_YESNO(conference-&gt;locked),</span>
<span class="lineNum">    3684 </span><span class="lineNoCov">          0 :                 AST_YESNO(conference-&gt;muted));</span>
<span class="lineNum">    3685 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3686 </span>            : 
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3688 </span>            :         }
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :         ao2_iterator_destroy(&amp;iter);</span>
<span class="lineNum">    3690 </span>            : 
<span class="lineNum">    3691 </span>            :         /* Send final confirmation */
<span class="lineNum">    3692 </span><span class="lineNoCov">          0 :         astman_send_list_complete_start(s, m, &quot;ConfbridgeListRoomsComplete&quot;, totalitems);</span>
<span class="lineNum">    3693 </span><span class="lineNoCov">          0 :         astman_send_list_complete_end(s);</span>
<span class="lineNum">    3694 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3695"><span class="lineNum">    3695 </span>            : }</a>
<span class="lineNum">    3696 </span>            : 
<span class="lineNum">    3697 </span><span class="lineNoCov">          0 : static int action_mute_unmute_helper(struct mansession *s, const struct message *m, int mute)</span>
<span class="lineNum">    3698 </span>            : {
<span class="lineNum">    3699 </span><span class="lineNoCov">          0 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3700 </span><span class="lineNoCov">          0 :         const char *channel_name = astman_get_header(m, &quot;Channel&quot;);</span>
<span class="lineNum">    3701 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">    3702 </span>            : 
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3704 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3705 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3706 </span>            :         }
<span class="lineNum">    3707 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(channel_name)) {</span>
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No channel name provided.&quot;);</span>
<span class="lineNum">    3709 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3710 </span>            :         }
<span class="lineNum">    3711 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3712 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3714 </span>            :         }
<span class="lineNum">    3715 </span>            : 
<span class="lineNum">    3716 </span><span class="lineNoCov">          0 :         res = generic_mute_unmute_helper(mute, conference_name, channel_name);</span>
<span class="lineNum">    3717 </span>            : 
<span class="lineNum">    3718 </span><span class="lineNoCov">          0 :         if (res == -1) {</span>
<span class="lineNum">    3719 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3720 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3721 </span><span class="lineNoCov">          0 :         } else if (res == -2) {</span>
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Channel by that name found in Conference.&quot;);</span>
<span class="lineNum">    3723 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3724 </span>            :         }
<span class="lineNum">    3725 </span>            : 
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, mute ? &quot;User muted&quot; : &quot;User unmuted&quot;);</span>
<span class="lineNum">    3727 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3728"><span class="lineNum">    3728 </span>            : }</a>
<span class="lineNum">    3729 </span>            : 
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 : static int action_confbridgeunmute(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3731 </span>            : {
<a name="3732"><span class="lineNum">    3732 </span><span class="lineNoCov">          0 :         return action_mute_unmute_helper(s, m, 0);</span></a>
<span class="lineNum">    3733 </span>            : }
<span class="lineNum">    3734 </span><span class="lineNoCov">          0 : static int action_confbridgemute(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3735 </span>            : {
<span class="lineNum">    3736 </span><span class="lineNoCov">          0 :         return action_mute_unmute_helper(s, m, 1);</span>
<a name="3737"><span class="lineNum">    3737 </span>            : }</a>
<span class="lineNum">    3738 </span>            : 
<span class="lineNum">    3739 </span><span class="lineNoCov">          0 : static int action_lock_unlock_helper(struct mansession *s, const struct message *m, int lock)</span>
<span class="lineNum">    3740 </span>            : {
<span class="lineNum">    3741 </span><span class="lineNoCov">          0 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3742 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">    3743 </span>            : 
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3745 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3746 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3747 </span>            :         }
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3750 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3751 </span>            :         }
<span class="lineNum">    3752 </span><span class="lineNoCov">          0 :         if ((res = generic_lock_unlock_helper(lock, conference_name))) {</span>
<span class="lineNum">    3753 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3755 </span>            :         }
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, lock ? &quot;Conference locked&quot; : &quot;Conference unlocked&quot;);</span>
<a name="3757"><span class="lineNum">    3757 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<span class="lineNum">    3758 </span>            : }
<span class="lineNum">    3759 </span><span class="lineNoCov">          0 : static int action_confbridgeunlock(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3760 </span>            : {
<a name="3761"><span class="lineNum">    3761 </span><span class="lineNoCov">          0 :         return action_lock_unlock_helper(s, m, 0);</span></a>
<span class="lineNum">    3762 </span>            : }
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 : static int action_confbridgelock(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3764 </span>            : {
<span class="lineNum">    3765 </span><span class="lineNoCov">          0 :         return action_lock_unlock_helper(s, m, 1);</span>
<a name="3766"><span class="lineNum">    3766 </span>            : }</a>
<span class="lineNum">    3767 </span>            : 
<span class="lineNum">    3768 </span><span class="lineCov">          4 : static int action_confbridgekick(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3769 </span>            : {
<span class="lineNum">    3770 </span><span class="lineCov">          4 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3771 </span><span class="lineCov">          4 :         const char *channel = astman_get_header(m, &quot;Channel&quot;);</span>
<span class="lineNum">    3772 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3773 </span>            :         int found;
<span class="lineNum">    3774 </span>            : 
<span class="lineNum">    3775 </span><span class="lineCov">          4 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3776 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3777 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3778 </span>            :         }
<span class="lineNum">    3779 </span><span class="lineCov">          4 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3780 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3781 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3782 </span>            :         }
<span class="lineNum">    3783 </span>            : 
<span class="lineNum">    3784 </span><span class="lineCov">          4 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3785 </span><span class="lineCov">          4 :         if (!conference) {</span>
<span class="lineNum">    3786 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3787 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3788 </span>            :         }
<span class="lineNum">    3789 </span>            : 
<span class="lineNum">    3790 </span><span class="lineCov">          4 :         found = !kick_conference_participant(conference, channel);</span>
<span class="lineNum">    3791 </span><span class="lineCov">          4 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3792 </span>            : 
<span class="lineNum">    3793 </span><span class="lineCov">          4 :         if (found) {</span>
<span class="lineNum">    3794 </span><span class="lineCov">          4 :                 astman_send_ack(s, m, !strcmp(&quot;all&quot;, channel) ? &quot;All participants kicked&quot; : &quot;User kicked&quot;);</span>
<span class="lineNum">    3795 </span>            :         } else {
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Channel by that name found in Conference.&quot;);</span>
<span class="lineNum">    3797 </span>            :         }
<span class="lineNum">    3798 </span><span class="lineCov">          4 :         return 0;</span>
<a name="3799"><span class="lineNum">    3799 </span>            : }</a>
<span class="lineNum">    3800 </span>            : 
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 : static int action_confbridgestartrecord(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3802 </span>            : {
<span class="lineNum">    3803 </span><span class="lineNoCov">          0 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3804 </span><span class="lineNoCov">          0 :         const char *recordfile = astman_get_header(m, &quot;RecordFile&quot;);</span>
<span class="lineNum">    3805 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3806 </span>            : 
<span class="lineNum">    3807 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3808 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3809 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3810 </span>            :         }
<span class="lineNum">    3811 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3812 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3813 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3814 </span>            :         }
<span class="lineNum">    3815 </span>            : 
<span class="lineNum">    3816 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3817 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3818 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3819 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3820 </span>            :         }
<span class="lineNum">    3821 </span>            : 
<span class="lineNum">    3822 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3823 </span><span class="lineNoCov">          0 :         if (conf_is_recording(conference)) {</span>
<span class="lineNum">    3824 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;Conference is already being recorded.&quot;);</span>
<span class="lineNum">    3825 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3826 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3827 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3828 </span>            :         }
<span class="lineNum">    3829 </span>            : 
<span class="lineNum">    3830 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(recordfile)) {</span>
<span class="lineNum">    3831 </span><span class="lineNoCov">          0 :                 ast_copy_string(conference-&gt;b_profile.rec_file, recordfile, sizeof(conference-&gt;b_profile.rec_file));</span>
<span class="lineNum">    3832 </span>            :         }
<span class="lineNum">    3833 </span>            : 
<span class="lineNum">    3834 </span><span class="lineNoCov">          0 :         if (conf_start_record(conference)) {</span>
<span class="lineNum">    3835 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;Internal error starting conference recording.&quot;);</span>
<span class="lineNum">    3836 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3837 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3838 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3839 </span>            :         }
<span class="lineNum">    3840 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3841 </span>            : 
<span class="lineNum">    3842 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3843 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, &quot;Conference Recording Started.&quot;);</span>
<a name="3844"><span class="lineNum">    3844 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<span class="lineNum">    3845 </span>            : }
<span class="lineNum">    3846 </span><span class="lineNoCov">          0 : static int action_confbridgestoprecord(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3847 </span>            : {
<span class="lineNum">    3848 </span><span class="lineNoCov">          0 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3849 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3850 </span>            : 
<span class="lineNum">    3851 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3852 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3853 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3854 </span>            :         }
<span class="lineNum">    3855 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3857 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3858 </span>            :         }
<span class="lineNum">    3859 </span>            : 
<span class="lineNum">    3860 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3862 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3863 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3864 </span>            :         }
<span class="lineNum">    3865 </span>            : 
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :         if (conf_stop_record(conference)) {</span>
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 :                 ao2_unlock(conference);</span>
<span class="lineNum">    3869 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;Internal error while stopping recording.&quot;);</span>
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :                 ao2_ref(conference, -1);</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3872 </span>            :         }
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3874 </span>            : 
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, &quot;Conference Recording Stopped.&quot;);</span>
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3878"><span class="lineNum">    3878 </span>            : }</a>
<span class="lineNum">    3879 </span>            : 
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 : static int action_confbridgesetsinglevideosrc(struct mansession *s, const struct message *m)</span>
<span class="lineNum">    3881 </span>            : {
<span class="lineNum">    3882 </span><span class="lineNoCov">          0 :         const char *conference_name = astman_get_header(m, &quot;Conference&quot;);</span>
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :         const char *channel = astman_get_header(m, &quot;Channel&quot;);</span>
<span class="lineNum">    3884 </span>            :         struct confbridge_user *user;
<span class="lineNum">    3885 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3886 </span>            : 
<span class="lineNum">    3887 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(conference_name)) {</span>
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference name provided.&quot;);</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3890 </span>            :         }
<span class="lineNum">    3891 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(channel)) {</span>
<span class="lineNum">    3892 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No channel name provided.&quot;);</span>
<span class="lineNum">    3893 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3894 </span>            :         }
<span class="lineNum">    3895 </span><span class="lineNoCov">          0 :         if (!ao2_container_count(conference_bridges)) {</span>
<span class="lineNum">    3896 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No active conferences.&quot;);</span>
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3898 </span>            :         }
<span class="lineNum">    3899 </span>            : 
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, conference_name, OBJ_KEY);</span>
<span class="lineNum">    3901 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3902 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No Conference by that name found.&quot;);</span>
<span class="lineNum">    3903 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3904 </span>            :         }
<span class="lineNum">    3905 </span>            : 
<span class="lineNum">    3906 </span>            :         /* find channel and set as video src. */
<span class="lineNum">    3907 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3908 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :                 if (!strncmp(channel, ast_channel_name(user-&gt;chan), strlen(channel))) {</span>
<span class="lineNum">    3910 </span><span class="lineNoCov">          0 :                         ast_bridge_set_single_src_video_mode(conference-&gt;bridge, user-&gt;chan);</span>
<span class="lineNum">    3911 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    3912 </span>            :                 }
<span class="lineNum">    3913 </span>            :         }
<span class="lineNum">    3914 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3915 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3916 </span>            : 
<span class="lineNum">    3917 </span>            :         /* do not access user after conference unlock.  We are just
<span class="lineNum">    3918 </span>            :          * using this check to see if it was found or not */
<span class="lineNum">    3919 </span><span class="lineNoCov">          0 :         if (!user) {</span>
<span class="lineNum">    3920 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;No channel by that name found in conference.&quot;);</span>
<span class="lineNum">    3921 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3922 </span>            :         }
<span class="lineNum">    3923 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, &quot;Conference single video source set.&quot;);</span>
<span class="lineNum">    3924 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3925"><span class="lineNum">    3925 </span>            : }</a>
<span class="lineNum">    3926 </span>            : 
<span class="lineNum">    3927 </span><span class="lineNoCov">          0 : static int func_confbridge_info(struct ast_channel *chan, const char *cmd, char *data, char *buf, size_t len)</span>
<span class="lineNum">    3928 </span>            : {
<span class="lineNum">    3929 </span>            :         char *parse;
<span class="lineNum">    3930 </span>            :         struct confbridge_conference *conference;
<span class="lineNum">    3931 </span>            :         struct confbridge_user *user;
<span class="lineNum">    3932 </span><span class="lineNoCov">          0 :         int count = 0;</span>
<span class="lineNum">    3933 </span><span class="lineNoCov">          0 :         AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">    3934 </span>            :                 AST_APP_ARG(type);
<span class="lineNum">    3935 </span>            :                 AST_APP_ARG(confno);
<span class="lineNum">    3936 </span>            :         );
<span class="lineNum">    3937 </span>            : 
<span class="lineNum">    3938 </span>            :         /* parse all the required arguments and make sure they exist. */
<span class="lineNum">    3939 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(data)) {</span>
<span class="lineNum">    3940 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3941 </span>            :         }
<span class="lineNum">    3942 </span><span class="lineNoCov">          0 :         parse = ast_strdupa(data);</span>
<span class="lineNum">    3943 </span><span class="lineNoCov">          0 :         AST_STANDARD_APP_ARGS(args, parse);</span>
<span class="lineNum">    3944 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(args.confno) || ast_strlen_zero(args.type)) {</span>
<span class="lineNum">    3945 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3946 </span>            :         }
<span class="lineNum">    3947 </span><span class="lineNoCov">          0 :         conference = ao2_find(conference_bridges, args.confno, OBJ_KEY);</span>
<span class="lineNum">    3948 </span><span class="lineNoCov">          0 :         if (!conference) {</span>
<span class="lineNum">    3949 </span><span class="lineNoCov">          0 :                 snprintf(buf, len, &quot;0&quot;);</span>
<span class="lineNum">    3950 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3951 </span>            :         }
<span class="lineNum">    3952 </span>            : 
<span class="lineNum">    3953 </span>            :         /* get the correct count for the type requested */
<span class="lineNum">    3954 </span><span class="lineNoCov">          0 :         ao2_lock(conference);</span>
<span class="lineNum">    3955 </span><span class="lineNoCov">          0 :         if (!strcasecmp(args.type, &quot;parties&quot;)) {</span>
<span class="lineNum">    3956 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3957 </span><span class="lineNoCov">          0 :                         count++;</span>
<span class="lineNum">    3958 </span>            :                 }
<span class="lineNum">    3959 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;waiting_list, user, list) {</span>
<span class="lineNum">    3960 </span><span class="lineNoCov">          0 :                         count++;</span>
<span class="lineNum">    3961 </span>            :                 }
<span class="lineNum">    3962 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(args.type, &quot;admins&quot;)) {</span>
<span class="lineNum">    3963 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :                         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_ADMIN)) {</span>
<span class="lineNum">    3965 </span><span class="lineNoCov">          0 :                                 count++;</span>
<span class="lineNum">    3966 </span>            :                         }
<span class="lineNum">    3967 </span>            :                 }
<span class="lineNum">    3968 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(args.type, &quot;marked&quot;)) {</span>
<span class="lineNum">    3969 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;conference-&gt;active_list, user, list) {</span>
<span class="lineNum">    3970 </span><span class="lineNoCov">          0 :                         if (ast_test_flag(&amp;user-&gt;u_profile, USER_OPT_MARKEDUSER)) {</span>
<span class="lineNum">    3971 </span><span class="lineNoCov">          0 :                                 count++;</span>
<span class="lineNum">    3972 </span>            :                         }
<span class="lineNum">    3973 </span>            :                 }
<span class="lineNum">    3974 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(args.type, &quot;locked&quot;)) {</span>
<span class="lineNum">    3975 </span><span class="lineNoCov">          0 :                 count = conference-&gt;locked;</span>
<span class="lineNum">    3976 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(args.type, &quot;muted&quot;)) {</span>
<span class="lineNum">    3977 </span><span class="lineNoCov">          0 :                 count = conference-&gt;muted;</span>
<span class="lineNum">    3978 </span>            :         } else {
<span class="lineNum">    3979 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Invalid keyword '%s' passed to CONFBRIDGE_INFO.\n&quot;, args.type);</span>
<span class="lineNum">    3980 </span>            :         }
<span class="lineNum">    3981 </span><span class="lineNoCov">          0 :         snprintf(buf, len, &quot;%d&quot;, count);</span>
<span class="lineNum">    3982 </span><span class="lineNoCov">          0 :         ao2_unlock(conference);</span>
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 :         ao2_ref(conference, -1);</span>
<span class="lineNum">    3984 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="3985"><span class="lineNum">    3985 </span>            : }</a>
<span class="lineNum">    3986 </span>            : 
<span class="lineNum">    3987 </span><span class="lineCov">         41 : void conf_add_user_active(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    3988 </span>            : {
<span class="lineNum">    3989 </span><span class="lineCov">         41 :         AST_LIST_INSERT_TAIL(&amp;conference-&gt;active_list, user, list);</span>
<span class="lineNum">    3990 </span><span class="lineCov">         41 :         conference-&gt;activeusers++;</span>
<a name="3991"><span class="lineNum">    3991 </span><span class="lineCov">         41 : }</span></a>
<span class="lineNum">    3992 </span>            : 
<span class="lineNum">    3993 </span><span class="lineCov">         27 : void conf_add_user_marked(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    3994 </span>            : {
<span class="lineNum">    3995 </span><span class="lineCov">         27 :         AST_LIST_INSERT_TAIL(&amp;conference-&gt;active_list, user, list);</span>
<span class="lineNum">    3996 </span><span class="lineCov">         27 :         conference-&gt;activeusers++;</span>
<span class="lineNum">    3997 </span><span class="lineCov">         27 :         conference-&gt;markedusers++;</span>
<a name="3998"><span class="lineNum">    3998 </span><span class="lineCov">         27 : }</span></a>
<span class="lineNum">    3999 </span>            : 
<span class="lineNum">    4000 </span><span class="lineCov">         14 : void conf_add_user_waiting(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    4001 </span>            : {
<span class="lineNum">    4002 </span><span class="lineCov">         14 :         AST_LIST_INSERT_TAIL(&amp;conference-&gt;waiting_list, user, list);</span>
<span class="lineNum">    4003 </span><span class="lineCov">         14 :         conference-&gt;waitingusers++;</span>
<a name="4004"><span class="lineNum">    4004 </span><span class="lineCov">         14 : }</span></a>
<span class="lineNum">    4005 </span>            : 
<span class="lineNum">    4006 </span><span class="lineCov">         40 : void conf_remove_user_active(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    4007 </span>            : {
<span class="lineNum">    4008 </span><span class="lineCov">         41 :         AST_LIST_REMOVE(&amp;conference-&gt;active_list, user, list);</span>
<span class="lineNum">    4009 </span><span class="lineCov">         40 :         conference-&gt;activeusers--;</span>
<a name="4010"><span class="lineNum">    4010 </span><span class="lineCov">         40 : }</span></a>
<span class="lineNum">    4011 </span>            : 
<span class="lineNum">    4012 </span><span class="lineCov">         27 : void conf_remove_user_marked(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    4013 </span>            : {
<span class="lineNum">    4014 </span><span class="lineCov">         28 :         AST_LIST_REMOVE(&amp;conference-&gt;active_list, user, list);</span>
<span class="lineNum">    4015 </span><span class="lineCov">         27 :         conference-&gt;activeusers--;</span>
<span class="lineNum">    4016 </span><span class="lineCov">         27 :         conference-&gt;markedusers--;</span>
<a name="4017"><span class="lineNum">    4017 </span><span class="lineCov">         27 : }</span></a>
<span class="lineNum">    4018 </span>            : 
<span class="lineNum">    4019 </span><span class="lineCov">         58 : void conf_mute_only_active(struct confbridge_conference *conference)</span>
<span class="lineNum">    4020 </span>            : {
<span class="lineNum">    4021 </span><span class="lineCov">         58 :         struct confbridge_user *only_user = AST_LIST_FIRST(&amp;conference-&gt;active_list);</span>
<span class="lineNum">    4022 </span>            : 
<span class="lineNum">    4023 </span>            :         /* Turn on MOH if the single participant is set up for it */
<span class="lineNum">    4024 </span><span class="lineCov">         58 :         if (ast_test_flag(&amp;only_user-&gt;u_profile, USER_OPT_MUSICONHOLD)) {</span>
<span class="lineNum">    4025 </span><span class="lineCov">         15 :                 conf_moh_start(only_user);</span>
<span class="lineNum">    4026 </span>            :         }
<span class="lineNum">    4027 </span><span class="lineCov">         58 :         conf_update_user_mute(only_user);</span>
<a name="4028"><span class="lineNum">    4028 </span><span class="lineCov">         58 : }</span></a>
<span class="lineNum">    4029 </span>            : 
<span class="lineNum">    4030 </span><span class="lineCov">         15 : void conf_remove_user_waiting(struct confbridge_conference *conference, struct confbridge_user *user)</span>
<span class="lineNum">    4031 </span>            : {
<span class="lineNum">    4032 </span><span class="lineCov">         15 :         AST_LIST_REMOVE(&amp;conference-&gt;waiting_list, user, list);</span>
<span class="lineNum">    4033 </span><span class="lineCov">         15 :         conference-&gt;waitingusers--;</span>
<span class="lineNum">    4034 </span><span class="lineCov">         15 : }</span>
<span class="lineNum">    4035 </span>            : 
<span class="lineNum">    4036 </span>            : /*!
<span class="lineNum">    4037 </span>            :  * \internal
<span class="lineNum">    4038 </span>            :  * \brief Unregister a ConfBridge channel technology.
<span class="lineNum">    4039 </span>            :  * \since 12.0.0
<span class="lineNum">    4040 </span>            :  *
<span class="lineNum">    4041 </span>            :  * \param tech What to unregister.
<span class="lineNum">    4042 </span>            :  *
<a name="4043"><span class="lineNum">    4043 </span>            :  * \return Nothing</a>
<span class="lineNum">    4044 </span>            :  */
<span class="lineNum">    4045 </span><span class="lineCov">       2230 : static void unregister_channel_tech(struct ast_channel_tech *tech)</span>
<span class="lineNum">    4046 </span>            : {
<span class="lineNum">    4047 </span><span class="lineCov">       2230 :         ast_channel_unregister(tech);</span>
<span class="lineNum">    4048 </span><span class="lineCov">       2230 :         ao2_cleanup(tech-&gt;capabilities);</span>
<span class="lineNum">    4049 </span><span class="lineCov">       2230 : }</span>
<span class="lineNum">    4050 </span>            : 
<span class="lineNum">    4051 </span>            : /*!
<span class="lineNum">    4052 </span>            :  * \internal
<span class="lineNum">    4053 </span>            :  * \brief Register a ConfBridge channel technology.
<span class="lineNum">    4054 </span>            :  * \since 12.0.0
<span class="lineNum">    4055 </span>            :  *
<span class="lineNum">    4056 </span>            :  * \param tech What to register.
<span class="lineNum">    4057 </span>            :  *
<span class="lineNum">    4058 </span>            :  * \retval 0 on success.
<a name="4059"><span class="lineNum">    4059 </span>            :  * \retval -1 on error.</a>
<span class="lineNum">    4060 </span>            :  */
<span class="lineNum">    4061 </span><span class="lineCov">       2234 : static int register_channel_tech(struct ast_channel_tech *tech)</span>
<span class="lineNum">    4062 </span>            : {
<span class="lineNum">    4063 </span><span class="lineCov">       2234 :         tech-&gt;capabilities = ast_format_cap_alloc(AST_FORMAT_CAP_FLAG_DEFAULT);</span>
<span class="lineNum">    4064 </span><span class="lineCov">       2234 :         if (!tech-&gt;capabilities) {</span>
<span class="lineNum">    4065 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4066 </span>            :         }
<span class="lineNum">    4067 </span><span class="lineCov">       2234 :         ast_format_cap_append_by_type(tech-&gt;capabilities, AST_MEDIA_TYPE_UNKNOWN);</span>
<span class="lineNum">    4068 </span><span class="lineCov">       2234 :         if (ast_channel_register(tech)) {</span>
<span class="lineNum">    4069 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Unable to register channel technology %s(%s).\n&quot;,</span>
<span class="lineNum">    4070 </span>            :                         tech-&gt;type, tech-&gt;description);
<span class="lineNum">    4071 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4072 </span>            :         }
<span class="lineNum">    4073 </span><span class="lineCov">       2234 :         return 0;</span>
<span class="lineNum">    4074 </span>            : }
<a name="4075"><span class="lineNum">    4075 </span>            : </a>
<span class="lineNum">    4076 </span>            : /*! \brief Called when module is being unloaded */
<span class="lineNum">    4077 </span><span class="lineCov">       1115 : static int unload_module(void)</span>
<span class="lineNum">    4078 </span>            : {
<span class="lineNum">    4079 </span><span class="lineCov">       1115 :         ast_unregister_application(app);</span>
<span class="lineNum">    4080 </span>            : 
<span class="lineNum">    4081 </span><span class="lineCov">       1115 :         ast_custom_function_unregister(&amp;confbridge_function);</span>
<span class="lineNum">    4082 </span><span class="lineCov">       1115 :         ast_custom_function_unregister(&amp;confbridge_info_function);</span>
<span class="lineNum">    4083 </span>            : 
<span class="lineNum">    4084 </span><span class="lineCov">       1115 :         ast_cli_unregister_multiple(cli_confbridge, ARRAY_LEN(cli_confbridge));</span>
<span class="lineNum">    4085 </span>            : 
<span class="lineNum">    4086 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeList&quot;);</span>
<span class="lineNum">    4087 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeListRooms&quot;);</span>
<span class="lineNum">    4088 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeMute&quot;);</span>
<span class="lineNum">    4089 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeUnmute&quot;);</span>
<span class="lineNum">    4090 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeKick&quot;);</span>
<span class="lineNum">    4091 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeUnlock&quot;);</span>
<span class="lineNum">    4092 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeLock&quot;);</span>
<span class="lineNum">    4093 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeStartRecord&quot;);</span>
<span class="lineNum">    4094 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeStopRecord&quot;);</span>
<span class="lineNum">    4095 </span><span class="lineCov">       1115 :         ast_manager_unregister(&quot;ConfbridgeSetSingleVideoSrc&quot;);</span>
<span class="lineNum">    4096 </span>            : 
<span class="lineNum">    4097 </span>            :         /* Unsubscribe from stasis confbridge message type and clean it up. */
<span class="lineNum">    4098 </span><span class="lineCov">       1115 :         manager_confbridge_shutdown();</span>
<span class="lineNum">    4099 </span>            : 
<span class="lineNum">    4100 </span>            :         /* Get rid of the conference bridges container. Since we only allow dynamic ones none will be active. */
<span class="lineNum">    4101 </span><span class="lineCov">       1115 :         ao2_cleanup(conference_bridges);</span>
<span class="lineNum">    4102 </span><span class="lineCov">       1115 :         conference_bridges = NULL;</span>
<span class="lineNum">    4103 </span>            : 
<span class="lineNum">    4104 </span><span class="lineCov">       1115 :         conf_destroy_config();</span>
<span class="lineNum">    4105 </span>            : 
<span class="lineNum">    4106 </span><span class="lineCov">       1115 :         unregister_channel_tech(conf_announce_get_tech());</span>
<span class="lineNum">    4107 </span><span class="lineCov">       1115 :         unregister_channel_tech(conf_record_get_tech());</span>
<span class="lineNum">    4108 </span>            : 
<span class="lineNum">    4109 </span><span class="lineCov">       1115 :         return 0;</span>
<span class="lineNum">    4110 </span>            : }
<span class="lineNum">    4111 </span>            : 
<span class="lineNum">    4112 </span>            : /*!
<span class="lineNum">    4113 </span>            :  * \brief Load the module
<span class="lineNum">    4114 </span>            :  *
<span class="lineNum">    4115 </span>            :  * Module loading including tests for configuration or dependencies.
<span class="lineNum">    4116 </span>            :  * This function can return AST_MODULE_LOAD_FAILURE, AST_MODULE_LOAD_DECLINE,
<span class="lineNum">    4117 </span>            :  * or AST_MODULE_LOAD_SUCCESS. If a dependency or environment variable fails
<span class="lineNum">    4118 </span>            :  * tests return AST_MODULE_LOAD_FAILURE. If the module can not load the
<span class="lineNum">    4119 </span>            :  * configuration file or other non-critical problem return
<a name="4120"><span class="lineNum">    4120 </span>            :  * AST_MODULE_LOAD_DECLINE. On success return AST_MODULE_LOAD_SUCCESS.</a>
<span class="lineNum">    4121 </span>            :  */
<span class="lineNum">    4122 </span><span class="lineCov">       1117 : static int load_module(void)</span>
<span class="lineNum">    4123 </span>            : {
<span class="lineNum">    4124 </span><span class="lineCov">       1117 :         int res = 0;</span>
<span class="lineNum">    4125 </span>            : 
<span class="lineNum">    4126 </span><span class="lineCov">       1117 :         if (conf_load_config()) {</span>
<span class="lineNum">    4127 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Unable to load config. Not loading module.\n&quot;);</span>
<span class="lineNum">    4128 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">    4129 </span>            :         }
<span class="lineNum">    4130 </span>            : 
<span class="lineNum">    4131 </span><span class="lineCov">       1117 :         if (register_channel_tech(conf_record_get_tech())</span>
<span class="lineNum">    4132 </span><span class="lineCov">       1117 :                 || register_channel_tech(conf_announce_get_tech())) {</span>
<span class="lineNum">    4133 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">    4134 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">    4135 </span>            :         }
<span class="lineNum">    4136 </span>            : 
<span class="lineNum">    4137 </span>            :         /* Create a container to hold the conference bridges */
<span class="lineNum">    4138 </span><span class="lineCov">       1117 :         conference_bridges = ao2_container_alloc(CONFERENCE_BRIDGE_BUCKETS,</span>
<span class="lineNum">    4139 </span>            :                 conference_bridge_hash_cb, conference_bridge_cmp_cb);
<span class="lineNum">    4140 </span><span class="lineCov">       1117 :         if (!conference_bridges) {</span>
<span class="lineNum">    4141 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">    4142 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">    4143 </span>            :         }
<span class="lineNum">    4144 </span>            : 
<span class="lineNum">    4145 </span>            :         /* Setup manager stasis subscriptions */
<span class="lineNum">    4146 </span><span class="lineCov">       1117 :         res |= manager_confbridge_init();</span>
<span class="lineNum">    4147 </span>            : 
<span class="lineNum">    4148 </span><span class="lineCov">       1117 :         res |= ast_register_application_xml(app, confbridge_exec);</span>
<span class="lineNum">    4149 </span>            : 
<span class="lineNum">    4150 </span><span class="lineCov">       1117 :         res |= ast_custom_function_register_escalating(&amp;confbridge_function, AST_CFE_WRITE);</span>
<span class="lineNum">    4151 </span><span class="lineCov">       1117 :         res |= ast_custom_function_register(&amp;confbridge_info_function);</span>
<span class="lineNum">    4152 </span>            : 
<span class="lineNum">    4153 </span><span class="lineCov">       1117 :         res |= ast_cli_register_multiple(cli_confbridge, ARRAY_LEN(cli_confbridge));</span>
<span class="lineNum">    4154 </span>            : 
<span class="lineNum">    4155 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeList&quot;, EVENT_FLAG_REPORTING, action_confbridgelist);</span>
<span class="lineNum">    4156 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeListRooms&quot;, EVENT_FLAG_REPORTING, action_confbridgelistrooms);</span>
<span class="lineNum">    4157 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeMute&quot;, EVENT_FLAG_CALL, action_confbridgemute);</span>
<span class="lineNum">    4158 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeUnmute&quot;, EVENT_FLAG_CALL, action_confbridgeunmute);</span>
<span class="lineNum">    4159 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeKick&quot;, EVENT_FLAG_CALL, action_confbridgekick);</span>
<span class="lineNum">    4160 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeUnlock&quot;, EVENT_FLAG_CALL, action_confbridgeunlock);</span>
<span class="lineNum">    4161 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeLock&quot;, EVENT_FLAG_CALL, action_confbridgelock);</span>
<span class="lineNum">    4162 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeStartRecord&quot;, EVENT_FLAG_SYSTEM, action_confbridgestartrecord);</span>
<span class="lineNum">    4163 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeStopRecord&quot;, EVENT_FLAG_SYSTEM, action_confbridgestoprecord);</span>
<span class="lineNum">    4164 </span><span class="lineCov">       1117 :         res |= ast_manager_register_xml(&quot;ConfbridgeSetSingleVideoSrc&quot;, EVENT_FLAG_CALL, action_confbridgesetsinglevideosrc);</span>
<span class="lineNum">    4165 </span><span class="lineCov">       1117 :         if (res) {</span>
<span class="lineNum">    4166 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">    4167 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">    4168 </span>            :         }
<span class="lineNum">    4169 </span>            : 
<span class="lineNum">    4170 </span><span class="lineCov">       1117 :         return AST_MODULE_LOAD_SUCCESS;</span>
<a name="4171"><span class="lineNum">    4171 </span>            : }</a>
<span class="lineNum">    4172 </span>            : 
<span class="lineNum">    4173 </span><span class="lineNoCov">          0 : static int reload(void)</span>
<span class="lineNum">    4174 </span>            : {
<span class="lineNum">    4175 </span><span class="lineNoCov">          0 :         return conf_reload_config();</span>
<a name="4176"><span class="lineNum">    4176 </span>            : }</a>
<span class="lineNum">    4177 </span>            : 
<span class="lineNum">    4178 </span><span class="lineCov">      19073 : AST_MODULE_INFO(ASTERISK_GPL_KEY, AST_MODFLAG_LOAD_ORDER, &quot;Conference Bridge Application&quot;,</span>
<span class="lineNum">    4179 </span>            :         .support_level = AST_MODULE_SUPPORT_CORE,
<span class="lineNum">    4180 </span>            :         .load = load_module,
<span class="lineNum">    4181 </span>            :         .unload = unload_module,
<span class="lineNum">    4182 </span>            :         .reload = reload,
<span class="lineNum">    4183 </span>            :         .load_pri = AST_MODPRI_DEVSTATE_PROVIDER,
<span class="lineNum">    4184 </span>            :         .optional_modules = &quot;codec_speex,func_jitterbuffer&quot;,
<span class="lineNum">    4185 </span>            : );
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
