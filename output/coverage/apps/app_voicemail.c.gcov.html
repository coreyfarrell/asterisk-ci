<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Asterisk GIT-16-9767e98486 - apps/app_voicemail.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">apps</a> - app_voicemail.c<span style="font-size: 80%;"> (source / <a href="app_voicemail.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Asterisk GIT-16-9767e98486</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">3122</td>
            <td class="headerCovTableEntry">6540</td>
            <td class="headerCovTableEntryLo">47.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-07-22 22:16:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">133</td>
            <td class="headerCovTableEntry">209</td>
            <td class="headerCovTableEntryLo">63.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Asterisk -- An open source telephony toolkit.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Copyright (C) 1999 - 2006, Digium, Inc.
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * Mark Spencer &lt;markster@digium.com&gt;
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  * See http://www.asterisk.org for more information about
<span class="lineNum">       9 </span>            :  * the Asterisk project. Please do not directly contact
<span class="lineNum">      10 </span>            :  * any of the maintainers of this project for assistance;
<span class="lineNum">      11 </span>            :  * the project provides a web site, mailing lists and IRC
<span class="lineNum">      12 </span>            :  * channels for your use.
<span class="lineNum">      13 </span>            :  *
<span class="lineNum">      14 </span>            :  * This program is free software, distributed under the terms of
<span class="lineNum">      15 </span>            :  * the GNU General Public License Version 2. See the LICENSE file
<span class="lineNum">      16 </span>            :  * at the top of the source tree.
<span class="lineNum">      17 </span>            :  */
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : /*!
<span class="lineNum">      20 </span>            :  * \file
<span class="lineNum">      21 </span>            :  * \author Mark Spencer &lt;markster@digium.com&gt;
<span class="lineNum">      22 </span>            :  * \brief Comedian Mail - Voicemail System
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  * unixODBC (http://www.unixodbc.org/)
<span class="lineNum">      25 </span>            :  * A source distribution of University of Washington's IMAP c-client
<span class="lineNum">      26 </span>            :  *         (http://www.washington.edu/imap/)
<span class="lineNum">      27 </span>            :  *
<span class="lineNum">      28 </span>            :  * \par See also
<span class="lineNum">      29 </span>            :  * \arg \ref Config_vm
<span class="lineNum">      30 </span>            :  * \note For information about voicemail IMAP storage, https://wiki.asterisk.org/wiki/display/AST/IMAP+Voicemail+Storage
<span class="lineNum">      31 </span>            :  * \ingroup applications
<span class="lineNum">      32 </span>            :  * \todo This module requires res_adsi to load. This needs to be optional
<span class="lineNum">      33 </span>            :  * during compilation.
<span class="lineNum">      34 </span>            :  *
<span class="lineNum">      35 </span>            :  * \todo This file is now almost impossible to work with, due to all \#ifdefs.
<span class="lineNum">      36 </span>            :  *       Feels like the database code before realtime. Someone - please come up
<span class="lineNum">      37 </span>            :  *       with a plan to clean this up.
<span class="lineNum">      38 </span>            :  */
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : /*! \li \ref app_voicemail.c uses configuration file \ref voicemail.conf
<span class="lineNum">      41 </span>            :  * \addtogroup configuration_file Configuration Files
<span class="lineNum">      42 </span>            :  */
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : /*!
<span class="lineNum">      45 </span>            :  * \page voicemail.conf voicemail.conf
<span class="lineNum">      46 </span>            :  * \verbinclude voicemail.conf.sample
<span class="lineNum">      47 </span>            :  */
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : /*** MODULEINFO
<span class="lineNum">      50 </span>            :         &lt;defaultenabled&gt;yes&lt;/defaultenabled&gt;
<span class="lineNum">      51 </span>            :         &lt;use type=&quot;module&quot;&gt;res_adsi&lt;/use&gt;
<span class="lineNum">      52 </span>            :         &lt;use type=&quot;module&quot;&gt;res_smdi&lt;/use&gt;
<span class="lineNum">      53 </span>            :         &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      54 </span>            :  ***/
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : /*** MAKEOPTS
<span class="lineNum">      57 </span>            : &lt;category name=&quot;MENUSELECT_OPTS_app_voicemail&quot; displayname=&quot;Voicemail Build Options&quot; positive_output=&quot;yes&quot; touch_on_change=&quot;apps/app_voicemail.c apps/app_directory.c&quot;&gt;
<span class="lineNum">      58 </span>            :         &lt;member name=&quot;FILE_STORAGE&quot; displayname=&quot;Storage of Voicemail using filesystem&quot;&gt;
<span class="lineNum">      59 </span>            :                 &lt;conflict&gt;ODBC_STORAGE&lt;/conflict&gt;
<span class="lineNum">      60 </span>            :                 &lt;conflict&gt;IMAP_STORAGE&lt;/conflict&gt;
<span class="lineNum">      61 </span>            :                 &lt;defaultenabled&gt;yes&lt;/defaultenabled&gt;
<span class="lineNum">      62 </span>            :                 &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      63 </span>            :         &lt;/member&gt;
<span class="lineNum">      64 </span>            :         &lt;member name=&quot;ODBC_STORAGE&quot; displayname=&quot;Storage of Voicemail using ODBC&quot;&gt;
<span class="lineNum">      65 </span>            :                 &lt;depend&gt;generic_odbc&lt;/depend&gt;
<span class="lineNum">      66 </span>            :                 &lt;conflict&gt;IMAP_STORAGE&lt;/conflict&gt;
<span class="lineNum">      67 </span>            :                 &lt;conflict&gt;FILE_STORAGE&lt;/conflict&gt;
<span class="lineNum">      68 </span>            :                 &lt;defaultenabled&gt;no&lt;/defaultenabled&gt;
<span class="lineNum">      69 </span>            :                 &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      70 </span>            :         &lt;/member&gt;
<span class="lineNum">      71 </span>            :         &lt;member name=&quot;IMAP_STORAGE&quot; displayname=&quot;Storage of Voicemail using IMAP4&quot;&gt;
<span class="lineNum">      72 </span>            :                 &lt;depend&gt;imap_tk&lt;/depend&gt;
<span class="lineNum">      73 </span>            :                 &lt;conflict&gt;ODBC_STORAGE&lt;/conflict&gt;
<span class="lineNum">      74 </span>            :                 &lt;conflict&gt;FILE_STORAGE&lt;/conflict&gt;
<span class="lineNum">      75 </span>            :                 &lt;use type=&quot;external&quot;&gt;openssl&lt;/use&gt;
<span class="lineNum">      76 </span>            :                 &lt;defaultenabled&gt;no&lt;/defaultenabled&gt;
<span class="lineNum">      77 </span>            :                 &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      78 </span>            :         &lt;/member&gt;
<span class="lineNum">      79 </span>            : &lt;/category&gt;
<span class="lineNum">      80 </span>            : ***/
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : #include &quot;asterisk.h&quot;
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">      85 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      86 </span>            : #include &lt;signal.h&gt;
<span class="lineNum">      87 </span>            : #include &lt;pwd.h&gt;
<span class="lineNum">      88 </span>            : #ifdef USE_SYSTEM_IMAP
<span class="lineNum">      89 </span>            : #include &lt;imap/c-client.h&gt;
<span class="lineNum">      90 </span>            : #include &lt;imap/imap4r1.h&gt;
<span class="lineNum">      91 </span>            : #include &lt;imap/linkage.h&gt;
<span class="lineNum">      92 </span>            : #elif defined (USE_SYSTEM_CCLIENT)
<span class="lineNum">      93 </span>            : #include &lt;c-client/c-client.h&gt;
<span class="lineNum">      94 </span>            : #include &lt;c-client/imap4r1.h&gt;
<span class="lineNum">      95 </span>            : #include &lt;c-client/linkage.h&gt;
<span class="lineNum">      96 </span>            : #else
<span class="lineNum">      97 </span>            : #include &quot;c-client.h&quot;
<span class="lineNum">      98 </span>            : #include &quot;imap4r1.h&quot;
<span class="lineNum">      99 </span>            : #include &quot;linkage.h&quot;
<span class="lineNum">     100 </span>            : #endif
<span class="lineNum">     101 </span>            : #endif
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            : #include &quot;asterisk/paths.h&quot;   /* use ast_config_AST_SPOOL_DIR */
<span class="lineNum">     104 </span>            : #include &lt;sys/time.h&gt;
<span class="lineNum">     105 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">     106 </span>            : #include &lt;sys/mman.h&gt;
<span class="lineNum">     107 </span>            : #include &lt;time.h&gt;
<span class="lineNum">     108 </span>            : #include &lt;dirent.h&gt;
<span class="lineNum">     109 </span>            : #if defined(__FreeBSD__) || defined(__OpenBSD__)
<span class="lineNum">     110 </span>            : #include &lt;sys/wait.h&gt;
<span class="lineNum">     111 </span>            : #endif
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : #include &quot;asterisk/logger.h&quot;
<span class="lineNum">     114 </span>            : #include &quot;asterisk/lock.h&quot;
<span class="lineNum">     115 </span>            : #include &quot;asterisk/file.h&quot;
<span class="lineNum">     116 </span>            : #include &quot;asterisk/channel.h&quot;
<span class="lineNum">     117 </span>            : #include &quot;asterisk/pbx.h&quot;
<span class="lineNum">     118 </span>            : #include &quot;asterisk/config.h&quot;
<span class="lineNum">     119 </span>            : #include &quot;asterisk/say.h&quot;
<span class="lineNum">     120 </span>            : #include &quot;asterisk/module.h&quot;
<span class="lineNum">     121 </span>            : #include &quot;asterisk/adsi.h&quot;
<span class="lineNum">     122 </span>            : #include &quot;asterisk/app.h&quot;
<span class="lineNum">     123 </span>            : #include &quot;asterisk/manager.h&quot;
<span class="lineNum">     124 </span>            : #include &quot;asterisk/dsp.h&quot;
<span class="lineNum">     125 </span>            : #include &quot;asterisk/localtime.h&quot;
<span class="lineNum">     126 </span>            : #include &quot;asterisk/cli.h&quot;
<span class="lineNum">     127 </span>            : #include &quot;asterisk/utils.h&quot;
<span class="lineNum">     128 </span>            : #include &quot;asterisk/stringfields.h&quot;
<span class="lineNum">     129 </span>            : #include &quot;asterisk/strings.h&quot;
<span class="lineNum">     130 </span>            : #include &quot;asterisk/smdi.h&quot;
<span class="lineNum">     131 </span>            : #include &quot;asterisk/astobj2.h&quot;
<span class="lineNum">     132 </span>            : #include &quot;asterisk/taskprocessor.h&quot;
<span class="lineNum">     133 </span>            : #include &quot;asterisk/test.h&quot;
<span class="lineNum">     134 </span>            : #include &quot;asterisk/format_cache.h&quot;
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">     137 </span>            : #include &quot;asterisk/res_odbc.h&quot;
<span class="lineNum">     138 </span>            : #endif
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     141 </span>            : #include &quot;asterisk/threadstorage.h&quot;
<span class="lineNum">     142 </span>            : #endif
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            : /*** DOCUMENTATION
<span class="lineNum">     145 </span>            :         &lt;application name=&quot;VoiceMail&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     146 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     147 </span>            :                         Leave a Voicemail message.
<span class="lineNum">     148 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     149 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     150 </span>            :                         &lt;parameter name=&quot;mailboxs&quot; argsep=&quot;&amp;amp;&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     151 </span>            :                                 &lt;argument name=&quot;mailbox1&quot; argsep=&quot;@&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     152 </span>            :                                         &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     153 </span>            :                                         &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     154 </span>            :                                 &lt;/argument&gt;
<span class="lineNum">     155 </span>            :                                 &lt;argument name=&quot;mailbox2&quot; argsep=&quot;@&quot; multiple=&quot;true&quot;&gt;
<span class="lineNum">     156 </span>            :                                         &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     157 </span>            :                                         &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     158 </span>            :                                 &lt;/argument&gt;
<span class="lineNum">     159 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     160 </span>            :                         &lt;parameter name=&quot;options&quot;&gt;
<span class="lineNum">     161 </span>            :                                 &lt;optionlist&gt;
<span class="lineNum">     162 </span>            :                                         &lt;option name=&quot;b&quot;&gt;
<span class="lineNum">     163 </span>            :                                                 &lt;para&gt;Play the &lt;literal&gt;busy&lt;/literal&gt; greeting to the calling party.&lt;/para&gt;
<span class="lineNum">     164 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     165 </span>            :                                         &lt;option name=&quot;d&quot;&gt;
<span class="lineNum">     166 </span>            :                                                 &lt;argument name=&quot;c&quot; /&gt;
<span class="lineNum">     167 </span>            :                                                 &lt;para&gt;Accept digits for a new extension in context &lt;replaceable&gt;c&lt;/replaceable&gt;,
<span class="lineNum">     168 </span>            :                                                 if played during the greeting. Context defaults to the current context.&lt;/para&gt;
<span class="lineNum">     169 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     170 </span>            :                                         &lt;option name=&quot;g&quot;&gt;
<span class="lineNum">     171 </span>            :                                                 &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     172 </span>            :                                                 &lt;para&gt;Use the specified amount of gain when recording the voicemail
<span class="lineNum">     173 </span>            :                                                 message. The units are whole-number decibels (dB). Only works on supported
<span class="lineNum">     174 </span>            :                                                 technologies, which is DAHDI only.&lt;/para&gt;
<span class="lineNum">     175 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     176 </span>            :                                         &lt;option name=&quot;s&quot;&gt;
<span class="lineNum">     177 </span>            :                                                 &lt;para&gt;Skip the playback of instructions for leaving a message to the
<span class="lineNum">     178 </span>            :                                                 calling party.&lt;/para&gt;
<span class="lineNum">     179 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     180 </span>            :                                         &lt;option name=&quot;u&quot;&gt;
<span class="lineNum">     181 </span>            :                                                 &lt;para&gt;Play the &lt;literal&gt;unavailable&lt;/literal&gt; greeting.&lt;/para&gt;
<span class="lineNum">     182 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     183 </span>            :                                         &lt;option name=&quot;U&quot;&gt;
<span class="lineNum">     184 </span>            :                                                 &lt;para&gt;Mark message as &lt;literal&gt;URGENT&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     185 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     186 </span>            :                                         &lt;option name=&quot;P&quot;&gt;
<span class="lineNum">     187 </span>            :                                                 &lt;para&gt;Mark message as &lt;literal&gt;PRIORITY&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     188 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     189 </span>            :                                 &lt;/optionlist&gt;
<span class="lineNum">     190 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     191 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     192 </span>            :                 &lt;description&gt;
<span class="lineNum">     193 </span>            :                         &lt;para&gt;This application allows the calling party to leave a message for the specified
<span class="lineNum">     194 </span>            :                         list of mailboxes. When multiple mailboxes are specified, the greeting will be taken from
<span class="lineNum">     195 </span>            :                         the first mailbox specified. Dialplan execution will stop if the specified mailbox does not
<span class="lineNum">     196 </span>            :                         exist.&lt;/para&gt;
<span class="lineNum">     197 </span>            :                         &lt;para&gt;The Voicemail application will exit if any of the following DTMF digits are received:&lt;/para&gt;
<span class="lineNum">     198 </span>            :                         &lt;enumlist&gt;
<span class="lineNum">     199 </span>            :                                 &lt;enum name=&quot;0&quot;&gt;
<span class="lineNum">     200 </span>            :                                         &lt;para&gt;Jump to the &lt;literal&gt;o&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;
<span class="lineNum">     201 </span>            :                                 &lt;/enum&gt;
<span class="lineNum">     202 </span>            :                                 &lt;enum name=&quot;*&quot;&gt;
<span class="lineNum">     203 </span>            :                                         &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;
<span class="lineNum">     204 </span>            :                                 &lt;/enum&gt;
<span class="lineNum">     205 </span>            :                         &lt;/enumlist&gt;
<span class="lineNum">     206 </span>            :                         &lt;para&gt;This application will set the following channel variable upon completion:&lt;/para&gt;
<span class="lineNum">     207 </span>            :                         &lt;variablelist&gt;
<span class="lineNum">     208 </span>            :                                 &lt;variable name=&quot;VMSTATUS&quot;&gt;
<span class="lineNum">     209 </span>            :                                         &lt;para&gt;This indicates the status of the execution of the VoiceMail application.&lt;/para&gt;
<span class="lineNum">     210 </span>            :                                         &lt;value name=&quot;SUCCESS&quot; /&gt;
<span class="lineNum">     211 </span>            :                                         &lt;value name=&quot;USEREXIT&quot; /&gt;
<span class="lineNum">     212 </span>            :                                         &lt;value name=&quot;FAILED&quot; /&gt;
<span class="lineNum">     213 </span>            :                                 &lt;/variable&gt;
<span class="lineNum">     214 </span>            :                         &lt;/variablelist&gt;
<span class="lineNum">     215 </span>            :                 &lt;/description&gt;
<span class="lineNum">     216 </span>            :                 &lt;see-also&gt;
<span class="lineNum">     217 </span>            :                         &lt;ref type=&quot;application&quot;&gt;VoiceMailMain&lt;/ref&gt;
<span class="lineNum">     218 </span>            :                 &lt;/see-also&gt;
<span class="lineNum">     219 </span>            :         &lt;/application&gt;
<span class="lineNum">     220 </span>            :         &lt;application name=&quot;VoiceMailMain&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     221 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     222 </span>            :                         Check Voicemail messages.
<span class="lineNum">     223 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     224 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     225 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;
<span class="lineNum">     226 </span>            :                                 &lt;argument name=&quot;mailbox&quot; /&gt;
<span class="lineNum">     227 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     228 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     229 </span>            :                         &lt;parameter name=&quot;options&quot;&gt;
<span class="lineNum">     230 </span>            :                                 &lt;optionlist&gt;
<span class="lineNum">     231 </span>            :                                         &lt;option name=&quot;p&quot;&gt;
<span class="lineNum">     232 </span>            :                                                 &lt;para&gt;Consider the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; parameter as a prefix to
<span class="lineNum">     233 </span>            :                                                 the mailbox that is entered by the caller.&lt;/para&gt;
<span class="lineNum">     234 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     235 </span>            :                                         &lt;option name=&quot;g&quot;&gt;
<span class="lineNum">     236 </span>            :                                                 &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     237 </span>            :                                                 &lt;para&gt;Use the specified amount of gain when recording a voicemail message.
<span class="lineNum">     238 </span>            :                                                 The units are whole-number decibels (dB).&lt;/para&gt;
<span class="lineNum">     239 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     240 </span>            :                                         &lt;option name=&quot;s&quot;&gt;
<span class="lineNum">     241 </span>            :                                                 &lt;para&gt;Skip checking the passcode for the mailbox.&lt;/para&gt;
<span class="lineNum">     242 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     243 </span>            :                                         &lt;option name=&quot;a&quot;&gt;
<span class="lineNum">     244 </span>            :                                                 &lt;argument name=&quot;folder&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     245 </span>            :                                                 &lt;para&gt;Skip folder prompt and go directly to &lt;replaceable&gt;folder&lt;/replaceable&gt; specified.
<span class="lineNum">     246 </span>            :                                                 Defaults to &lt;literal&gt;INBOX&lt;/literal&gt; (or &lt;literal&gt;0&lt;/literal&gt;).&lt;/para&gt;
<span class="lineNum">     247 </span>            :                                                 &lt;enumlist&gt;
<span class="lineNum">     248 </span>            :                                                         &lt;enum name=&quot;0&quot;&gt;&lt;para&gt;INBOX&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     249 </span>            :                                                         &lt;enum name=&quot;1&quot;&gt;&lt;para&gt;Old&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     250 </span>            :                                                         &lt;enum name=&quot;2&quot;&gt;&lt;para&gt;Work&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     251 </span>            :                                                         &lt;enum name=&quot;3&quot;&gt;&lt;para&gt;Family&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     252 </span>            :                                                         &lt;enum name=&quot;4&quot;&gt;&lt;para&gt;Friends&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     253 </span>            :                                                         &lt;enum name=&quot;5&quot;&gt;&lt;para&gt;Cust1&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     254 </span>            :                                                         &lt;enum name=&quot;6&quot;&gt;&lt;para&gt;Cust2&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     255 </span>            :                                                         &lt;enum name=&quot;7&quot;&gt;&lt;para&gt;Cust3&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     256 </span>            :                                                         &lt;enum name=&quot;8&quot;&gt;&lt;para&gt;Cust4&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     257 </span>            :                                                         &lt;enum name=&quot;9&quot;&gt;&lt;para&gt;Cust5&lt;/para&gt;&lt;/enum&gt;
<span class="lineNum">     258 </span>            :                                                 &lt;/enumlist&gt;
<span class="lineNum">     259 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     260 </span>            :                                 &lt;/optionlist&gt;
<span class="lineNum">     261 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     262 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     263 </span>            :                 &lt;description&gt;
<span class="lineNum">     264 </span>            :                         &lt;para&gt;This application allows the calling party to check voicemail messages. A specific
<span class="lineNum">     265 </span>            :                         &lt;replaceable&gt;mailbox&lt;/replaceable&gt;, and optional corresponding &lt;replaceable&gt;context&lt;/replaceable&gt;,
<span class="lineNum">     266 </span>            :                         may be specified. If a &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is not provided, the calling party will
<span class="lineNum">     267 </span>            :                         be prompted to enter one. If a &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, the
<span class="lineNum">     268 </span>            :                         &lt;literal&gt;default&lt;/literal&gt; context will be used.&lt;/para&gt;
<span class="lineNum">     269 </span>            :                         &lt;para&gt;The VoiceMailMain application will exit if the following DTMF digit is entered as Mailbox
<span class="lineNum">     270 </span>            :                         or Password, and the extension exists:&lt;/para&gt;
<span class="lineNum">     271 </span>            :                         &lt;enumlist&gt;
<span class="lineNum">     272 </span>            :                                 &lt;enum name=&quot;*&quot;&gt;
<span class="lineNum">     273 </span>            :                                         &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;
<span class="lineNum">     274 </span>            :                                 &lt;/enum&gt;
<span class="lineNum">     275 </span>            :                         &lt;/enumlist&gt;
<span class="lineNum">     276 </span>            :                 &lt;/description&gt;
<span class="lineNum">     277 </span>            :                 &lt;see-also&gt;
<span class="lineNum">     278 </span>            :                         &lt;ref type=&quot;application&quot;&gt;VoiceMail&lt;/ref&gt;
<span class="lineNum">     279 </span>            :                 &lt;/see-also&gt;
<span class="lineNum">     280 </span>            :         &lt;/application&gt;
<span class="lineNum">     281 </span>            :         &lt;application name=&quot;MailboxExists&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     282 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     283 </span>            :                         Check to see if Voicemail mailbox exists.
<span class="lineNum">     284 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     285 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     286 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;
<span class="lineNum">     287 </span>            :                                 &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     288 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     289 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     290 </span>            :                         &lt;parameter name=&quot;options&quot;&gt;
<span class="lineNum">     291 </span>            :                                 &lt;para&gt;None options.&lt;/para&gt;
<span class="lineNum">     292 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     293 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     294 </span>            :                 &lt;description&gt;
<span class="lineNum">     295 </span>            :                         &lt;note&gt;&lt;para&gt;DEPRECATED. Use VM_INFO(mailbox[@context],exists) instead.&lt;/para&gt;&lt;/note&gt;
<span class="lineNum">     296 </span>            :                         &lt;para&gt;Check to see if the specified &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists. If no voicemail
<span class="lineNum">     297 </span>            :                         &lt;replaceable&gt;context&lt;/replaceable&gt; is specified, the &lt;literal&gt;default&lt;/literal&gt; context
<span class="lineNum">     298 </span>            :                         will be used.&lt;/para&gt;
<span class="lineNum">     299 </span>            :                         &lt;para&gt;This application will set the following channel variable upon completion:&lt;/para&gt;
<span class="lineNum">     300 </span>            :                         &lt;variablelist&gt;
<span class="lineNum">     301 </span>            :                                 &lt;variable name=&quot;VMBOXEXISTSSTATUS&quot;&gt;
<span class="lineNum">     302 </span>            :                                         &lt;para&gt;This will contain the status of the execution of the MailboxExists application.
<span class="lineNum">     303 </span>            :                                         Possible values include:&lt;/para&gt;
<span class="lineNum">     304 </span>            :                                         &lt;value name=&quot;SUCCESS&quot; /&gt;
<span class="lineNum">     305 </span>            :                                         &lt;value name=&quot;FAILED&quot; /&gt;
<span class="lineNum">     306 </span>            :                                 &lt;/variable&gt;
<span class="lineNum">     307 </span>            :                         &lt;/variablelist&gt;
<span class="lineNum">     308 </span>            :                 &lt;/description&gt;
<span class="lineNum">     309 </span>            :                 &lt;see-also&gt;
<span class="lineNum">     310 </span>            :                         &lt;ref type=&quot;function&quot;&gt;VM_INFO&lt;/ref&gt;
<span class="lineNum">     311 </span>            :                 &lt;/see-also&gt;
<span class="lineNum">     312 </span>            :         &lt;/application&gt;
<span class="lineNum">     313 </span>            :         &lt;application name=&quot;VMAuthenticate&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     314 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     315 </span>            :                         Authenticate with Voicemail passwords.
<span class="lineNum">     316 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     317 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     318 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;
<span class="lineNum">     319 </span>            :                                 &lt;argument name=&quot;mailbox&quot; /&gt;
<span class="lineNum">     320 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     321 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     322 </span>            :                         &lt;parameter name=&quot;options&quot;&gt;
<span class="lineNum">     323 </span>            :                                 &lt;optionlist&gt;
<span class="lineNum">     324 </span>            :                                         &lt;option name=&quot;s&quot;&gt;
<span class="lineNum">     325 </span>            :                                                 &lt;para&gt;Skip playing the initial prompts.&lt;/para&gt;
<span class="lineNum">     326 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     327 </span>            :                                 &lt;/optionlist&gt;
<span class="lineNum">     328 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     329 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     330 </span>            :                 &lt;description&gt;
<span class="lineNum">     331 </span>            :                         &lt;para&gt;This application behaves the same way as the Authenticate application, but the passwords
<span class="lineNum">     332 </span>            :                         are taken from &lt;filename&gt;voicemail.conf&lt;/filename&gt;. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is
<span class="lineNum">     333 </span>            :                         specified, only that mailbox's password will be considered valid. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt;
<span class="lineNum">     334 </span>            :                         is not specified, the channel variable &lt;variable&gt;AUTH_MAILBOX&lt;/variable&gt; will be set with the authenticated
<span class="lineNum">     335 </span>            :                         mailbox.&lt;/para&gt;
<span class="lineNum">     336 </span>            :                         &lt;para&gt;The VMAuthenticate application will exit if the following DTMF digit is entered as Mailbox
<span class="lineNum">     337 </span>            :                         or Password, and the extension exists:&lt;/para&gt;
<span class="lineNum">     338 </span>            :                         &lt;enumlist&gt;
<span class="lineNum">     339 </span>            :                                 &lt;enum name=&quot;*&quot;&gt;
<span class="lineNum">     340 </span>            :                                         &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;
<span class="lineNum">     341 </span>            :                                 &lt;/enum&gt;
<span class="lineNum">     342 </span>            :                         &lt;/enumlist&gt;
<span class="lineNum">     343 </span>            :                 &lt;/description&gt;
<span class="lineNum">     344 </span>            :         &lt;/application&gt;
<span class="lineNum">     345 </span>            :         &lt;application name=&quot;VoiceMailPlayMsg&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     346 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     347 </span>            :                         Play a single voice mail msg from a mailbox by msg id.
<span class="lineNum">     348 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     349 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     350 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;
<span class="lineNum">     351 </span>            :                                 &lt;argument name=&quot;mailbox&quot; /&gt;
<span class="lineNum">     352 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     353 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     354 </span>            :                         &lt;parameter name=&quot;msg_id&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     355 </span>            :                                 &lt;para&gt;The msg id of the msg to play back. &lt;/para&gt;
<span class="lineNum">     356 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     357 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     358 </span>            :                 &lt;description&gt;
<span class="lineNum">     359 </span>            :                         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;
<span class="lineNum">     360 </span>            :                         &lt;variablelist&gt;
<span class="lineNum">     361 </span>            :                                 &lt;variable name=&quot;VOICEMAIL_PLAYBACKSTATUS&quot;&gt;
<span class="lineNum">     362 </span>            :                                         &lt;para&gt;The status of the playback attempt as a text string.&lt;/para&gt;
<span class="lineNum">     363 </span>            :                                         &lt;value name=&quot;SUCCESS&quot;/&gt;
<span class="lineNum">     364 </span>            :                                         &lt;value name=&quot;FAILED&quot;/&gt;
<span class="lineNum">     365 </span>            :                                 &lt;/variable&gt;
<span class="lineNum">     366 </span>            :                         &lt;/variablelist&gt;
<span class="lineNum">     367 </span>            :                 &lt;/description&gt;
<span class="lineNum">     368 </span>            :         &lt;/application&gt;
<span class="lineNum">     369 </span>            :         &lt;application name=&quot;VMSayName&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     370 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     371 </span>            :                         Play the name of a voicemail user
<span class="lineNum">     372 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     373 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     374 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;
<span class="lineNum">     375 </span>            :                                 &lt;argument name=&quot;mailbox&quot; /&gt;
<span class="lineNum">     376 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     377 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     378 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     379 </span>            :                 &lt;description&gt;
<span class="lineNum">     380 </span>            :                         &lt;para&gt;This application will say the recorded name of the voicemail user specified as the
<span class="lineNum">     381 </span>            :                         argument to this application. If no context is provided, &lt;literal&gt;default&lt;/literal&gt; is assumed.&lt;/para&gt;
<span class="lineNum">     382 </span>            :                 &lt;/description&gt;
<span class="lineNum">     383 </span>            :         &lt;/application&gt;
<span class="lineNum">     384 </span>            :         &lt;function name=&quot;MAILBOX_EXISTS&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     385 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     386 </span>            :                         Tell if a mailbox is configured.
<span class="lineNum">     387 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     388 </span>            :                 &lt;syntax argsep=&quot;@&quot;&gt;
<span class="lineNum">     389 </span>            :                         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     390 </span>            :                         &lt;parameter name=&quot;context&quot; /&gt;
<span class="lineNum">     391 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     392 </span>            :                 &lt;description&gt;
<span class="lineNum">     393 </span>            :                         &lt;note&gt;&lt;para&gt;DEPRECATED. Use VM_INFO(mailbox[@context],exists) instead.&lt;/para&gt;&lt;/note&gt;
<span class="lineNum">     394 </span>            :                         &lt;para&gt;Returns a boolean of whether the corresponding &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists.
<span class="lineNum">     395 </span>            :                         If &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, defaults to the &lt;literal&gt;default&lt;/literal&gt;
<span class="lineNum">     396 </span>            :                         context.&lt;/para&gt;
<span class="lineNum">     397 </span>            :                 &lt;/description&gt;
<span class="lineNum">     398 </span>            :                 &lt;see-also&gt;
<span class="lineNum">     399 </span>            :                         &lt;ref type=&quot;function&quot;&gt;VM_INFO&lt;/ref&gt;
<span class="lineNum">     400 </span>            :                 &lt;/see-also&gt;
<span class="lineNum">     401 </span>            :         &lt;/function&gt;
<span class="lineNum">     402 </span>            :         &lt;function name=&quot;VM_INFO&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     403 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     404 </span>            :                         Returns the selected attribute from a mailbox.
<span class="lineNum">     405 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     406 </span>            :                 &lt;syntax argsep=&quot;,&quot;&gt;
<span class="lineNum">     407 </span>            :                         &lt;parameter name=&quot;mailbox&quot; argsep=&quot;@&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     408 </span>            :                                 &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;
<span class="lineNum">     409 </span>            :                                 &lt;argument name=&quot;context&quot; /&gt;
<span class="lineNum">     410 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     411 </span>            :                         &lt;parameter name=&quot;attribute&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     412 </span>            :                                 &lt;optionlist&gt;
<span class="lineNum">     413 </span>            :                                         &lt;option name=&quot;count&quot;&gt;
<span class="lineNum">     414 </span>            :                                                 &lt;para&gt;Count of messages in specified &lt;replaceable&gt;folder&lt;/replaceable&gt;.
<span class="lineNum">     415 </span>            :                                                 If &lt;replaceable&gt;folder&lt;/replaceable&gt; is not specified, defaults to &lt;literal&gt;INBOX&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     416 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     417 </span>            :                                         &lt;option name=&quot;email&quot;&gt;
<span class="lineNum">     418 </span>            :                                                 &lt;para&gt;E-mail address associated with the mailbox.&lt;/para&gt;
<span class="lineNum">     419 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     420 </span>            :                                         &lt;option name=&quot;exists&quot;&gt;
<span class="lineNum">     421 </span>            :                                                 &lt;para&gt;Returns a boolean of whether the corresponding &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists.&lt;/para&gt;
<span class="lineNum">     422 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     423 </span>            :                                         &lt;option name=&quot;fullname&quot;&gt;
<span class="lineNum">     424 </span>            :                                                 &lt;para&gt;Full name associated with the mailbox.&lt;/para&gt;
<span class="lineNum">     425 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     426 </span>            :                                         &lt;option name=&quot;language&quot;&gt;
<span class="lineNum">     427 </span>            :                                                 &lt;para&gt;Mailbox language if overridden, otherwise the language of the channel.&lt;/para&gt;
<span class="lineNum">     428 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     429 </span>            :                                         &lt;option name=&quot;locale&quot;&gt;
<span class="lineNum">     430 </span>            :                                                 &lt;para&gt;Mailbox locale if overridden, otherwise global locale.&lt;/para&gt;
<span class="lineNum">     431 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     432 </span>            :                                         &lt;option name=&quot;pager&quot;&gt;
<span class="lineNum">     433 </span>            :                                                 &lt;para&gt;Pager e-mail address associated with the mailbox.&lt;/para&gt;
<span class="lineNum">     434 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     435 </span>            :                                         &lt;option name=&quot;password&quot;&gt;
<span class="lineNum">     436 </span>            :                                                 &lt;para&gt;Mailbox access password.&lt;/para&gt;
<span class="lineNum">     437 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     438 </span>            :                                         &lt;option name=&quot;tz&quot;&gt;
<span class="lineNum">     439 </span>            :                                                 &lt;para&gt;Mailbox timezone if overridden, otherwise global timezone&lt;/para&gt;
<span class="lineNum">     440 </span>            :                                         &lt;/option&gt;
<span class="lineNum">     441 </span>            :                                 &lt;/optionlist&gt;
<span class="lineNum">     442 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     443 </span>            :                         &lt;parameter name=&quot;folder&quot; required=&quot;false&quot;&gt;
<span class="lineNum">     444 </span>            :                                 &lt;para&gt;If not specified, &lt;literal&gt;INBOX&lt;/literal&gt; is assumed.&lt;/para&gt;
<span class="lineNum">     445 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     446 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     447 </span>            :                 &lt;description&gt;
<span class="lineNum">     448 </span>            :                         &lt;para&gt;Returns the selected attribute from the specified &lt;replaceable&gt;mailbox&lt;/replaceable&gt;.
<span class="lineNum">     449 </span>            :                         If &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, defaults to the &lt;literal&gt;default&lt;/literal&gt;
<span class="lineNum">     450 </span>            :                         context. Where the &lt;replaceable&gt;folder&lt;/replaceable&gt; can be specified, common folders
<span class="lineNum">     451 </span>            :                         include &lt;literal&gt;INBOX&lt;/literal&gt;, &lt;literal&gt;Old&lt;/literal&gt;, &lt;literal&gt;Work&lt;/literal&gt;,
<span class="lineNum">     452 </span>            :                         &lt;literal&gt;Family&lt;/literal&gt; and &lt;literal&gt;Friends&lt;/literal&gt;.&lt;/para&gt;
<span class="lineNum">     453 </span>            :                 &lt;/description&gt;
<span class="lineNum">     454 </span>            :         &lt;/function&gt;
<span class="lineNum">     455 </span>            :         &lt;manager name=&quot;VoicemailUsersList&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     456 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     457 </span>            :                         List All Voicemail User Information.
<span class="lineNum">     458 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     459 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     460 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     461 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     462 </span>            :                 &lt;description&gt;
<span class="lineNum">     463 </span>            :                 &lt;/description&gt;
<span class="lineNum">     464 </span>            :         &lt;/manager&gt;
<span class="lineNum">     465 </span>            :         &lt;manager name=&quot;VoicemailUserStatus&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     466 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     467 </span>            :                         Show the status of given voicemail user's info.
<span class="lineNum">     468 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     469 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     470 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     471 </span>            :                         &lt;parameter name=&quot;Context&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     472 </span>            :                                 &lt;para&gt;The context you want to check.&lt;/para&gt;
<span class="lineNum">     473 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     474 </span>            :                         &lt;parameter name=&quot;Mailbox&quot; required=&quot;true&quot;&gt;
<span class="lineNum">     475 </span>            :                                 &lt;para&gt;The mailbox you want to check.&lt;/para&gt;
<span class="lineNum">     476 </span>            :                         &lt;/parameter&gt;
<span class="lineNum">     477 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     478 </span>            :                 &lt;description&gt;
<span class="lineNum">     479 </span>            :                         &lt;para&gt;Retrieves the status of the given voicemail user.&lt;/para&gt;
<span class="lineNum">     480 </span>            :                 &lt;/description&gt;
<span class="lineNum">     481 </span>            :         &lt;/manager&gt;
<span class="lineNum">     482 </span>            :         &lt;manager name=&quot;VoicemailRefresh&quot; language=&quot;en_US&quot;&gt;
<span class="lineNum">     483 </span>            :                 &lt;synopsis&gt;
<span class="lineNum">     484 </span>            :                         Tell Asterisk to poll mailboxes for a change
<span class="lineNum">     485 </span>            :                 &lt;/synopsis&gt;
<span class="lineNum">     486 </span>            :                 &lt;syntax&gt;
<span class="lineNum">     487 </span>            :                         &lt;xi:include xpointer=&quot;xpointer(/docs/manager[@name='Login']/syntax/parameter[@name='ActionID'])&quot; /&gt;
<span class="lineNum">     488 </span>            :                         &lt;parameter name=&quot;Context&quot; /&gt;
<span class="lineNum">     489 </span>            :                         &lt;parameter name=&quot;Mailbox&quot; /&gt;
<span class="lineNum">     490 </span>            :                 &lt;/syntax&gt;
<span class="lineNum">     491 </span>            :                 &lt;description&gt;
<span class="lineNum">     492 </span>            :                         &lt;para&gt;Normally, MWI indicators are only sent when Asterisk itself
<span class="lineNum">     493 </span>            :                         changes a mailbox.  With external programs that modify the content
<span class="lineNum">     494 </span>            :                         of a mailbox from outside the application, an option exists called
<span class="lineNum">     495 </span>            :                         &lt;literal&gt;pollmailboxes&lt;/literal&gt; that will cause voicemail to
<span class="lineNum">     496 </span>            :                         continually scan all mailboxes on a system for changes.  This can
<span class="lineNum">     497 </span>            :                         cause a large amount of load on a system.  This command allows
<span class="lineNum">     498 </span>            :                         external applications to signal when a particular mailbox has
<span class="lineNum">     499 </span>            :                         changed, thus permitting external applications to modify mailboxes
<span class="lineNum">     500 </span>            :                         and MWI to work without introducing considerable CPU load.&lt;/para&gt;
<span class="lineNum">     501 </span>            :                         &lt;para&gt;If &lt;replaceable&gt;Context&lt;/replaceable&gt; is not specified, all
<span class="lineNum">     502 </span>            :                         mailboxes on the system will be polled for changes.  If
<span class="lineNum">     503 </span>            :                         &lt;replaceable&gt;Context&lt;/replaceable&gt; is specified, but
<span class="lineNum">     504 </span>            :                         &lt;replaceable&gt;Mailbox&lt;/replaceable&gt; is omitted, then all mailboxes
<span class="lineNum">     505 </span>            :                         within &lt;replaceable&gt;Context&lt;/replaceable&gt; will be polled.
<span class="lineNum">     506 </span>            :                         Otherwise, only a single mailbox will be polled for changes.&lt;/para&gt;
<span class="lineNum">     507 </span>            :                 &lt;/description&gt;
<span class="lineNum">     508 </span>            :         &lt;/manager&gt;
<span class="lineNum">     509 </span>            :  ***/
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     512 </span>            : static char imapserver[48];
<span class="lineNum">     513 </span>            : static char imapport[8];
<span class="lineNum">     514 </span>            : static char imapflags[128];
<span class="lineNum">     515 </span>            : static char imapfolder[64];
<span class="lineNum">     516 </span>            : static char imapparentfolder[64] = &quot;\0&quot;;
<span class="lineNum">     517 </span>            : static char greetingfolder[64];
<span class="lineNum">     518 </span>            : static char authuser[32];
<span class="lineNum">     519 </span>            : static char authpassword[42];
<span class="lineNum">     520 </span>            : static int imapversion = 1;
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span>            : static int expungeonhangup = 1;
<span class="lineNum">     523 </span>            : static int imapgreetings = 0;
<span class="lineNum">     524 </span>            : static int imap_poll_logout = 0;
<span class="lineNum">     525 </span>            : static char delimiter = '\0';
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            : /* mail_open cannot be protected on a stream basis */
<span class="lineNum">     528 </span>            : ast_mutex_t mail_open_lock;
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : struct vm_state;
<span class="lineNum">     531 </span>            : struct ast_vm_user;
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span>            : AST_THREADSTORAGE(ts_vmstate);
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            : /* Forward declarations for IMAP */
<span class="lineNum">     536 </span>            : static int init_mailstream(struct vm_state *vms, int box);
<span class="lineNum">     537 </span>            : static void write_file(char *filename, char *buffer, unsigned long len);
<span class="lineNum">     538 </span>            : static char *get_header_by_tag(char *header, char *tag, char *buf, size_t len);
<span class="lineNum">     539 </span>            : static void vm_imap_delete(char *file, int msgnum, struct ast_vm_user *vmu);
<span class="lineNum">     540 </span>            : static char *get_user_by_mailbox(char *mailbox, char *buf, size_t len);
<span class="lineNum">     541 </span>            : static struct vm_state *get_vm_state_by_imapuser(const char *user, int interactive);
<span class="lineNum">     542 </span>            : static struct vm_state *get_vm_state_by_mailbox(const char *mailbox, const char *context, int interactive);
<span class="lineNum">     543 </span>            : static struct vm_state *create_vm_state_from_user(struct ast_vm_user *vmu);
<span class="lineNum">     544 </span>            : static void vmstate_insert(struct vm_state *vms);
<span class="lineNum">     545 </span>            : static void vmstate_delete(struct vm_state *vms);
<span class="lineNum">     546 </span>            : static void set_update(MAILSTREAM * stream);
<span class="lineNum">     547 </span>            : static void init_vm_state(struct vm_state *vms);
<span class="lineNum">     548 </span>            : static int save_body(BODY *body, struct vm_state *vms, char *section, char *format, int is_intro);
<span class="lineNum">     549 </span>            : static void get_mailbox_delimiter(struct vm_state *vms, MAILSTREAM *stream);
<span class="lineNum">     550 </span>            : static void mm_parsequota (MAILSTREAM *stream, unsigned char *msg, QUOTALIST *pquota);
<span class="lineNum">     551 </span>            : static void imap_mailbox_name(char *spec, size_t len, struct vm_state *vms, int box, int target);
<span class="lineNum">     552 </span>            : static int imap_store_file(const char *dir, const char *mailboxuser, const char *mailboxcontext, int msgnum, struct ast_channel *chan, struct ast_vm_user *vmu, char *fmt, int duration, struct vm_state *vms, const char *flag, const char *msg_id);
<span class="lineNum">     553 </span>            : static void vm_imap_update_msg_id(char *dir, int msgnum, const char *msg_id, struct ast_vm_user *vmu, struct ast_config *msg_cfg, int folder);
<span class="lineNum">     554 </span>            : static void update_messages_by_imapuser(const char *user, unsigned long number);
<span class="lineNum">     555 </span>            : static int vm_delete(char *file);
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span>            : static int imap_remove_file (char *dir, int msgnum);
<span class="lineNum">     558 </span>            : static int imap_retrieve_file (const char *dir, const int msgnum, const char *mailbox, const char *context);
<span class="lineNum">     559 </span>            : static int imap_delete_old_greeting (char *dir, struct vm_state *vms);
<span class="lineNum">     560 </span>            : static void check_quota(struct vm_state *vms, char *mailbox);
<span class="lineNum">     561 </span>            : static int open_mailbox(struct vm_state *vms, struct ast_vm_user *vmu, int box);
<span class="lineNum">     562 </span>            : static void imap_logout(const char *mailbox_id);
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span>            : struct vmstate {
<span class="lineNum">     565 </span>            :         struct vm_state *vms;
<span class="lineNum">     566 </span>            :         AST_LIST_ENTRY(vmstate) list;
<span class="lineNum">     567 </span>            : };
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            : static AST_LIST_HEAD_STATIC(vmstates, vmstate);
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span>            : #endif
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span>            : #define SMDI_MWI_WAIT_TIMEOUT 1000 /* 1 second */
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            : #define COMMAND_TIMEOUT 5000
<span class="lineNum">     576 </span>            : /* Don't modify these here; set your umask at runtime instead */
<span class="lineNum">     577 </span>            : #define VOICEMAIL_DIR_MODE      0777
<span class="lineNum">     578 </span>            : #define VOICEMAIL_FILE_MODE     0666
<span class="lineNum">     579 </span>            : #define CHUNKSIZE       65536
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            : #define VOICEMAIL_CONFIG &quot;voicemail.conf&quot;
<span class="lineNum">     582 </span>            : #define ASTERISK_USERNAME &quot;asterisk&quot;
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            : /* Define fast-forward, pause, restart, and reverse keys
<span class="lineNum">     585 </span>            :  * while listening to a voicemail message - these are
<span class="lineNum">     586 </span>            :  * strings, not characters */
<span class="lineNum">     587 </span>            : #define DEFAULT_LISTEN_CONTROL_FORWARD_KEY &quot;#&quot;
<span class="lineNum">     588 </span>            : #define DEFAULT_LISTEN_CONTROL_REVERSE_KEY &quot;*&quot;
<span class="lineNum">     589 </span>            : #define DEFAULT_LISTEN_CONTROL_PAUSE_KEY &quot;0&quot;
<span class="lineNum">     590 </span>            : #define DEFAULT_LISTEN_CONTROL_RESTART_KEY &quot;2&quot;
<span class="lineNum">     591 </span>            : #define DEFAULT_LISTEN_CONTROL_STOP_KEY &quot;13456789&quot;
<span class="lineNum">     592 </span>            : #define VALID_DTMF &quot;1234567890*#&quot; /* Yes ABCD are valid dtmf but what phones have those? */
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            : /* Default mail command to mail voicemail. Change it with the
<span class="lineNum">     595 </span>            :  * mailcmd= command in voicemail.conf */
<span class="lineNum">     596 </span>            : #define SENDMAIL &quot;/usr/sbin/sendmail -t&quot;
<span class="lineNum">     597 </span>            : 
<span class="lineNum">     598 </span>            : #define INTRO &quot;vm-intro&quot;
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            : #define MAX_MAIL_BODY_CONTENT_SIZE 134217728L // 128 Mbyte
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span>            : #define MAXMSG 100
<span class="lineNum">     603 </span>            : #define MAXMSGLIMIT 9999
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span>            : #define MINPASSWORD 0 /*!&lt; Default minimum mailbox password length */
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            : #define BASELINELEN 72
<span class="lineNum">     608 </span>            : #define BASEMAXINLINE 256
<span class="lineNum">     609 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     610 </span>            : #define ENDL &quot;\r\n&quot;
<span class="lineNum">     611 </span>            : #else
<span class="lineNum">     612 </span>            : #define ENDL &quot;\n&quot;
<span class="lineNum">     613 </span>            : #endif
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            : #define MAX_DATETIME_FORMAT     512
<span class="lineNum">     616 </span>            : #define MAX_NUM_CID_CONTEXTS 10
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span>            : #define VM_REVIEW        (1 &lt;&lt; 0)   /*!&lt; After recording, permit the caller to review the recording before saving */
<span class="lineNum">     619 </span>            : #define VM_OPERATOR      (1 &lt;&lt; 1)   /*!&lt; Allow 0 to be pressed to go to 'o' extension */
<span class="lineNum">     620 </span>            : #define VM_SAYCID        (1 &lt;&lt; 2)   /*!&lt; Repeat the CallerID info during envelope playback */
<span class="lineNum">     621 </span>            : #define VM_SVMAIL        (1 &lt;&lt; 3)   /*!&lt; Allow the user to compose a new VM from within VoicemailMain */
<span class="lineNum">     622 </span>            : #define VM_ENVELOPE      (1 &lt;&lt; 4)   /*!&lt; Play the envelope information (who-from, time received, etc.) */
<span class="lineNum">     623 </span>            : #define VM_SAYDURATION   (1 &lt;&lt; 5)   /*!&lt; Play the length of the message during envelope playback */
<span class="lineNum">     624 </span>            : #define VM_SKIPAFTERCMD  (1 &lt;&lt; 6)   /*!&lt; After deletion, assume caller wants to go to the next message */
<span class="lineNum">     625 </span>            : #define VM_FORCENAME     (1 &lt;&lt; 7)   /*!&lt; Have new users record their name */
<span class="lineNum">     626 </span>            : #define VM_FORCEGREET    (1 &lt;&lt; 8)   /*!&lt; Have new users record their greetings */
<span class="lineNum">     627 </span>            : #define VM_PBXSKIP       (1 &lt;&lt; 9)   /*!&lt; Skip the [PBX] preamble in the Subject line of emails */
<span class="lineNum">     628 </span>            : #define VM_DIRECFORWARD  (1 &lt;&lt; 10)  /*!&lt; Permit caller to use the Directory app for selecting to which mailbox to forward a VM */
<span class="lineNum">     629 </span>            : #define VM_ATTACH        (1 &lt;&lt; 11)  /*!&lt; Attach message to voicemail notifications? */
<span class="lineNum">     630 </span>            : #define VM_DELETE        (1 &lt;&lt; 12)  /*!&lt; Delete message after sending notification */
<span class="lineNum">     631 </span>            : #define VM_ALLOCED       (1 &lt;&lt; 13)  /*!&lt; Structure was malloc'ed, instead of placed in a return (usually static) buffer */
<span class="lineNum">     632 </span>            : #define VM_SEARCH        (1 &lt;&lt; 14)  /*!&lt; Search all contexts for a matching mailbox */
<span class="lineNum">     633 </span>            : #define VM_TEMPGREETWARN (1 &lt;&lt; 15)  /*!&lt; Remind user tempgreeting is set */
<span class="lineNum">     634 </span>            : #define VM_MOVEHEARD     (1 &lt;&lt; 16)  /*!&lt; Move a &quot;heard&quot; message to Old after listening to it */
<span class="lineNum">     635 </span>            : #define VM_MESSAGEWRAP   (1 &lt;&lt; 17)  /*!&lt; Wrap around from the last message to the first, and vice-versa */
<span class="lineNum">     636 </span>            : #define VM_FWDURGAUTO    (1 &lt;&lt; 18)  /*!&lt; Autoset of Urgent flag on forwarded Urgent messages set globally */
<span class="lineNum">     637 </span>            : #define ERROR_LOCK_PATH  -100
<span class="lineNum">     638 </span>            : #define ERROR_MAX_MSGS   -101
<span class="lineNum">     639 </span>            : #define OPERATOR_EXIT     300
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            : enum vm_box {
<span class="lineNum">     642 </span>            :         NEW_FOLDER =            0,
<span class="lineNum">     643 </span>            :         OLD_FOLDER =            1,
<span class="lineNum">     644 </span>            :         WORK_FOLDER =           2,
<span class="lineNum">     645 </span>            :         FAMILY_FOLDER =         3,
<span class="lineNum">     646 </span>            :         FRIENDS_FOLDER =        4,
<span class="lineNum">     647 </span>            :         GREETINGS_FOLDER =      -1
<span class="lineNum">     648 </span>            : };
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span>            : enum vm_option_flags {
<span class="lineNum">     651 </span>            :         OPT_SILENT =           (1 &lt;&lt; 0),
<span class="lineNum">     652 </span>            :         OPT_BUSY_GREETING =    (1 &lt;&lt; 1),
<span class="lineNum">     653 </span>            :         OPT_UNAVAIL_GREETING = (1 &lt;&lt; 2),
<span class="lineNum">     654 </span>            :         OPT_RECORDGAIN =       (1 &lt;&lt; 3),
<span class="lineNum">     655 </span>            :         OPT_PREPEND_MAILBOX =  (1 &lt;&lt; 4),
<span class="lineNum">     656 </span>            :         OPT_AUTOPLAY =         (1 &lt;&lt; 6),
<span class="lineNum">     657 </span>            :         OPT_DTMFEXIT =         (1 &lt;&lt; 7),
<span class="lineNum">     658 </span>            :         OPT_MESSAGE_Urgent =   (1 &lt;&lt; 8),
<span class="lineNum">     659 </span>            :         OPT_MESSAGE_PRIORITY = (1 &lt;&lt; 9)
<span class="lineNum">     660 </span>            : };
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span>            : enum vm_option_args {
<span class="lineNum">     663 </span>            :         OPT_ARG_RECORDGAIN = 0,
<span class="lineNum">     664 </span>            :         OPT_ARG_PLAYFOLDER = 1,
<span class="lineNum">     665 </span>            :         OPT_ARG_DTMFEXIT   = 2,
<span class="lineNum">     666 </span>            :         /* This *must* be the last value in this enum! */
<span class="lineNum">     667 </span>            :         OPT_ARG_ARRAY_SIZE = 3,
<span class="lineNum">     668 </span>            : };
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span>            : enum vm_passwordlocation {
<span class="lineNum">     671 </span>            :         OPT_PWLOC_VOICEMAILCONF = 0,
<span class="lineNum">     672 </span>            :         OPT_PWLOC_SPOOLDIR      = 1,
<span class="lineNum">     673 </span>            :         OPT_PWLOC_USERSCONF     = 2,
<span class="lineNum">     674 </span>            : };
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            : AST_APP_OPTIONS(vm_app_options, {
<span class="lineNum">     677 </span>            :         AST_APP_OPTION('s', OPT_SILENT),
<span class="lineNum">     678 </span>            :         AST_APP_OPTION('b', OPT_BUSY_GREETING),
<span class="lineNum">     679 </span>            :         AST_APP_OPTION('u', OPT_UNAVAIL_GREETING),
<span class="lineNum">     680 </span>            :         AST_APP_OPTION_ARG('g', OPT_RECORDGAIN, OPT_ARG_RECORDGAIN),
<span class="lineNum">     681 </span>            :         AST_APP_OPTION_ARG('d', OPT_DTMFEXIT, OPT_ARG_DTMFEXIT),
<span class="lineNum">     682 </span>            :         AST_APP_OPTION('p', OPT_PREPEND_MAILBOX),
<span class="lineNum">     683 </span>            :         AST_APP_OPTION_ARG('a', OPT_AUTOPLAY, OPT_ARG_PLAYFOLDER),
<span class="lineNum">     684 </span>            :         AST_APP_OPTION('U', OPT_MESSAGE_Urgent),
<span class="lineNum">     685 </span>            :         AST_APP_OPTION('P', OPT_MESSAGE_PRIORITY)
<span class="lineNum">     686 </span>            : });
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            : static const char * const mailbox_folders[] = {
<span class="lineNum">     689 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     690 </span>            :         imapfolder,
<span class="lineNum">     691 </span>            : #else
<span class="lineNum">     692 </span>            :         &quot;INBOX&quot;,
<span class="lineNum">     693 </span>            : #endif
<span class="lineNum">     694 </span>            :         &quot;Old&quot;,
<span class="lineNum">     695 </span>            :         &quot;Work&quot;,
<span class="lineNum">     696 </span>            :         &quot;Family&quot;,
<span class="lineNum">     697 </span>            :         &quot;Friends&quot;,
<span class="lineNum">     698 </span>            :         &quot;Cust1&quot;,
<span class="lineNum">     699 </span>            :         &quot;Cust2&quot;,
<span class="lineNum">     700 </span>            :         &quot;Cust3&quot;,
<span class="lineNum">     701 </span>            :         &quot;Cust4&quot;,
<span class="lineNum">     702 </span>            :         &quot;Cust5&quot;,
<span class="lineNum">     703 </span>            :         &quot;Deleted&quot;,
<span class="lineNum">     704 </span>            :         &quot;Urgent&quot;,
<span class="lineNum">     705 </span>            : };
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            : static int load_config(int reload);
<span class="lineNum">     708 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">     709 </span>            : static int load_config_from_memory(int reload, struct ast_config *cfg, struct ast_config *ucfg);
<span class="lineNum">     710 </span>            : #endif
<span class="lineNum">     711 </span>            : static int actual_load_config(int reload, struct ast_config *cfg, struct ast_config *ucfg);
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span>            : /*! \page vmlang Voicemail Language Syntaxes Supported
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :         \par Syntaxes supported, not really language codes.
<span class="lineNum">     716 </span>            :         \arg \b en    - English
<span class="lineNum">     717 </span>            :         \arg \b de    - German
<span class="lineNum">     718 </span>            :         \arg \b es    - Spanish
<span class="lineNum">     719 </span>            :         \arg \b fr    - French
<span class="lineNum">     720 </span>            :         \arg \b it    - Italian
<span class="lineNum">     721 </span>            :         \arg \b nl    - Dutch
<span class="lineNum">     722 </span>            :         \arg \b pt    - Portuguese
<span class="lineNum">     723 </span>            :         \arg \b pt_BR - Portuguese (Brazil)
<span class="lineNum">     724 </span>            :         \arg \b gr    - Greek
<span class="lineNum">     725 </span>            :         \arg \b no    - Norwegian
<span class="lineNum">     726 </span>            :         \arg \b se    - Swedish
<span class="lineNum">     727 </span>            :         \arg \b tw    - Chinese (Taiwan)
<span class="lineNum">     728 </span>            :         \arg \b ua - Ukrainian
<span class="lineNum">     729 </span>            : 
<span class="lineNum">     730 </span>            : German requires the following additional soundfile:
<span class="lineNum">     731 </span>            : \arg \b 1F      einE (feminine)
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span>            : Spanish requires the following additional soundfile:
<span class="lineNum">     734 </span>            : \arg \b 1M      un (masculine)
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span>            : Dutch, Portuguese &amp; Spanish require the following additional soundfiles:
<span class="lineNum">     737 </span>            : \arg \b vm-INBOXs       singular of 'new'
<span class="lineNum">     738 </span>            : \arg \b vm-Olds         singular of 'old/heard/read'
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span>            : NB these are plural:
<span class="lineNum">     741 </span>            : \arg \b vm-INBOX        nieuwe (nl)
<span class="lineNum">     742 </span>            : \arg \b vm-Old          oude (nl)
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span>            : Polish uses:
<span class="lineNum">     745 </span>            : \arg \b vm-new-a        'new', feminine singular accusative
<span class="lineNum">     746 </span>            : \arg \b vm-new-e        'new', feminine plural accusative
<span class="lineNum">     747 </span>            : \arg \b vm-new-ych      'new', feminine plural genitive
<span class="lineNum">     748 </span>            : \arg \b vm-old-a        'old', feminine singular accusative
<span class="lineNum">     749 </span>            : \arg \b vm-old-e        'old', feminine plural accusative
<span class="lineNum">     750 </span>            : \arg \b vm-old-ych      'old', feminine plural genitive
<span class="lineNum">     751 </span>            : \arg \b digits/1-a      'one', not always same as 'digits/1'
<span class="lineNum">     752 </span>            : \arg \b digits/2-ie     'two', not always same as 'digits/2'
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            : Swedish uses:
<span class="lineNum">     755 </span>            : \arg \b vm-nytt         singular of 'new'
<span class="lineNum">     756 </span>            : \arg \b vm-nya          plural of 'new'
<span class="lineNum">     757 </span>            : \arg \b vm-gammalt      singular of 'old'
<span class="lineNum">     758 </span>            : \arg \b vm-gamla        plural of 'old'
<span class="lineNum">     759 </span>            : \arg \b digits/ett      'one', not always same as 'digits/1'
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span>            : Norwegian uses:
<span class="lineNum">     762 </span>            : \arg \b vm-ny           singular of 'new'
<span class="lineNum">     763 </span>            : \arg \b vm-nye          plural of 'new'
<span class="lineNum">     764 </span>            : \arg \b vm-gammel       singular of 'old'
<span class="lineNum">     765 </span>            : \arg \b vm-gamle        plural of 'old'
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            : Dutch also uses:
<span class="lineNum">     768 </span>            : \arg \b nl-om           'at'?
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span>            : Spanish also uses:
<span class="lineNum">     771 </span>            : \arg \b vm-youhaveno
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span>            : Italian requires the following additional soundfile:
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            : For vm_intro_it:
<span class="lineNum">     776 </span>            : \arg \b vm-nuovo        new
<span class="lineNum">     777 </span>            : \arg \b vm-nuovi        new plural
<span class="lineNum">     778 </span>            : \arg \b vm-vecchio      old
<span class="lineNum">     779 </span>            : \arg \b vm-vecchi       old plural
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span>            : Japanese requires the following additional soundfile:
<span class="lineNum">     782 </span>            : \arg \b jp-arimasu          there is
<span class="lineNum">     783 </span>            : \arg \b jp-arimasen         there is not
<span class="lineNum">     784 </span>            : \arg \b jp-oshitekudasai    please press
<span class="lineNum">     785 </span>            : \arg \b jp-ni               article ni
<span class="lineNum">     786 </span>            : \arg \b jp-ga               article ga
<span class="lineNum">     787 </span>            : \arg \b jp-wa               article wa
<span class="lineNum">     788 </span>            : \arg \b jp-wo               article wo
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            : Chinese (Taiwan) requires the following additional soundfile:
<span class="lineNum">     791 </span>            : \arg \b vm-tong         A class-word for call (tong1)
<span class="lineNum">     792 </span>            : \arg \b vm-ri           A class-word for day (ri4)
<span class="lineNum">     793 </span>            : \arg \b vm-you          You (ni3)
<span class="lineNum">     794 </span>            : \arg \b vm-haveno   Have no (mei2 you3)
<span class="lineNum">     795 </span>            : \arg \b vm-have     Have (you3)
<span class="lineNum">     796 </span>            : \arg \b vm-listen   To listen (yao4 ting1)
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span>            : \note Don't use vm-INBOX or vm-Old, because they are the name of the INBOX and Old folders,
<span class="lineNum">     800 </span>            : spelled among others when you have to change folder. For the above reasons, vm-INBOX
<span class="lineNum">     801 </span>            : and vm-Old are spelled plural, to make them sound more as folder name than an adjective.
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span>            : */
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span>            : struct baseio {
<span class="lineNum">     806 </span>            :         int iocp;
<span class="lineNum">     807 </span>            :         int iolen;
<span class="lineNum">     808 </span>            :         int linelength;
<span class="lineNum">     809 </span>            :         int ateof;
<span class="lineNum">     810 </span>            :         unsigned char iobuf[BASEMAXINLINE];
<span class="lineNum">     811 </span>            : };
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            : /*! Structure for linked list of users
<span class="lineNum">     814 </span>            :  * Use ast_vm_user_destroy() to free one of these structures. */
<span class="lineNum">     815 </span>            : struct ast_vm_user {
<span class="lineNum">     816 </span>            :         char context[AST_MAX_CONTEXT];   /*!&lt; Voicemail context */
<span class="lineNum">     817 </span>            :         char mailbox[AST_MAX_EXTENSION]; /*!&lt; Mailbox id, unique within vm context */
<span class="lineNum">     818 </span>            :         char password[80];               /*!&lt; Secret pin code, numbers only */
<span class="lineNum">     819 </span>            :         char fullname[80];               /*!&lt; Full name, for directory app */
<span class="lineNum">     820 </span>            :         char *email;                     /*!&lt; E-mail address */
<span class="lineNum">     821 </span>            :         char *emailsubject;              /*!&lt; E-mail subject */
<span class="lineNum">     822 </span>            :         char *emailbody;                 /*!&lt; E-mail body */
<span class="lineNum">     823 </span>            :         char pager[80];                  /*!&lt; E-mail address to pager (no attachment) */
<span class="lineNum">     824 </span>            :         char serveremail[80];            /*!&lt; From: Mail address */
<span class="lineNum">     825 </span>            :         char fromstring[100];            /*!&lt; From: Username */
<span class="lineNum">     826 </span>            :         char language[MAX_LANGUAGE];     /*!&lt; Config: Language setting */
<span class="lineNum">     827 </span>            :         char zonetag[80];                /*!&lt; Time zone */
<span class="lineNum">     828 </span>            :         char locale[20];                 /*!&lt; The locale (for presentation of date/time) */
<span class="lineNum">     829 </span>            :         char callback[80];
<span class="lineNum">     830 </span>            :         char dialout[80];
<span class="lineNum">     831 </span>            :         char uniqueid[80];               /*!&lt; Unique integer identifier */
<span class="lineNum">     832 </span>            :         char exit[80];
<span class="lineNum">     833 </span>            :         char attachfmt[20];              /*!&lt; Attachment format */
<span class="lineNum">     834 </span>            :         unsigned int flags;              /*!&lt; VM_ flags */
<span class="lineNum">     835 </span>            :         int saydurationm;
<span class="lineNum">     836 </span>            :         int minsecs;                     /*!&lt; Minimum number of seconds per message for this mailbox */
<span class="lineNum">     837 </span>            :         int maxmsg;                      /*!&lt; Maximum number of msgs per folder for this mailbox */
<span class="lineNum">     838 </span>            :         int maxdeletedmsg;               /*!&lt; Maximum number of deleted msgs saved for this mailbox */
<span class="lineNum">     839 </span>            :         int maxsecs;                     /*!&lt; Maximum number of seconds per message for this mailbox */
<span class="lineNum">     840 </span>            :         int passwordlocation;            /*!&lt; Storage location of the password */
<span class="lineNum">     841 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     842 </span>            :         char imapserver[48];             /*!&lt; IMAP server address */
<span class="lineNum">     843 </span>            :         char imapport[8];                /*!&lt; IMAP server port */
<span class="lineNum">     844 </span>            :         char imapflags[128];             /*!&lt; IMAP optional flags */
<span class="lineNum">     845 </span>            :         char imapuser[80];               /*!&lt; IMAP server login */
<span class="lineNum">     846 </span>            :         char imappassword[80];           /*!&lt; IMAP server password if authpassword not defined */
<span class="lineNum">     847 </span>            :         char imapfolder[64];             /*!&lt; IMAP voicemail folder */
<span class="lineNum">     848 </span>            :         char imapvmshareid[80];          /*!&lt; Shared mailbox ID to use rather than the dialed one */
<span class="lineNum">     849 </span>            :         int imapversion;                 /*!&lt; If configuration changes, use the new values */
<span class="lineNum">     850 </span>            : #endif
<span class="lineNum">     851 </span>            :         double volgain;                  /*!&lt; Volume gain for voicemails sent via email */
<span class="lineNum">     852 </span>            :         AST_LIST_ENTRY(ast_vm_user) list;
<span class="lineNum">     853 </span>            : };
<span class="lineNum">     854 </span>            : 
<span class="lineNum">     855 </span>            : /*! Voicemail time zones */
<span class="lineNum">     856 </span>            : struct vm_zone {
<span class="lineNum">     857 </span>            :         AST_LIST_ENTRY(vm_zone) list;
<span class="lineNum">     858 </span>            :         char name[80];
<span class="lineNum">     859 </span>            :         char timezone[80];
<span class="lineNum">     860 </span>            :         char msg_format[512];
<span class="lineNum">     861 </span>            : };
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span>            : #define VMSTATE_MAX_MSG_ARRAY 256
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span>            : /*! Voicemail mailbox state */
<span class="lineNum">     866 </span>            : struct vm_state {
<span class="lineNum">     867 </span>            :         char curbox[80];
<span class="lineNum">     868 </span>            :         char username[80];
<span class="lineNum">     869 </span>            :         char context[80];
<span class="lineNum">     870 </span>            :         char curdir[PATH_MAX];
<span class="lineNum">     871 </span>            :         char vmbox[PATH_MAX];
<span class="lineNum">     872 </span>            :         char fn[PATH_MAX];
<span class="lineNum">     873 </span>            :         char intro[PATH_MAX];
<span class="lineNum">     874 </span>            :         int *deleted;
<span class="lineNum">     875 </span>            :         int *heard;
<span class="lineNum">     876 </span>            :         int dh_arraysize; /* used for deleted / heard allocation */
<span class="lineNum">     877 </span>            :         int curmsg;
<span class="lineNum">     878 </span>            :         int lastmsg;
<span class="lineNum">     879 </span>            :         int newmessages;
<span class="lineNum">     880 </span>            :         int oldmessages;
<span class="lineNum">     881 </span>            :         int urgentmessages;
<span class="lineNum">     882 </span>            :         int starting;
<span class="lineNum">     883 </span>            :         int repeats;
<span class="lineNum">     884 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     885 </span>            :         ast_mutex_t lock;
<span class="lineNum">     886 </span>            :         int updated;                         /*!&lt; decremented on each mail check until 1 -allows delay */
<span class="lineNum">     887 </span>            :         long *msgArray;
<span class="lineNum">     888 </span>            :         unsigned msg_array_max;
<span class="lineNum">     889 </span>            :         MAILSTREAM *mailstream;
<span class="lineNum">     890 </span>            :         int vmArrayIndex;
<span class="lineNum">     891 </span>            :         char imapuser[80];                   /*!&lt; IMAP server login */
<span class="lineNum">     892 </span>            :         char imapfolder[64];                 /*!&lt; IMAP voicemail folder */
<span class="lineNum">     893 </span>            :         char imapserver[48];                 /*!&lt; IMAP server address */
<span class="lineNum">     894 </span>            :         char imapport[8];                    /*!&lt; IMAP server port */
<span class="lineNum">     895 </span>            :         char imapflags[128];                 /*!&lt; IMAP optional flags */
<span class="lineNum">     896 </span>            :         int imapversion;
<span class="lineNum">     897 </span>            :         int interactive;
<span class="lineNum">     898 </span>            :         char introfn[PATH_MAX];              /*!&lt; Name of prepended file */
<span class="lineNum">     899 </span>            :         unsigned int quota_limit;
<span class="lineNum">     900 </span>            :         unsigned int quota_usage;
<span class="lineNum">     901 </span>            :         struct vm_state *persist_vms;
<span class="lineNum">     902 </span>            : #endif
<span class="lineNum">     903 </span>            : };
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">     906 </span>            : static char odbc_database[80];
<span class="lineNum">     907 </span>            : static char odbc_table[80];
<span class="lineNum">     908 </span>            : #define RETRIEVE(a,b,c,d) retrieve_file(a,b)
<span class="lineNum">     909 </span>            : #define DISPOSE(a,b) remove_file(a,b)
<span class="lineNum">     910 </span>            : #define STORE(a,b,c,d,e,f,g,h,i,j,k) store_file(a,b,c,d)
<span class="lineNum">     911 </span>            : #define EXISTS(a,b,c,d) (message_exists(a,b))
<span class="lineNum">     912 </span>            : #define RENAME(a,b,c,d,e,f,g,h) (rename_file(a,b,c,d,e,f))
<span class="lineNum">     913 </span>            : #define COPY(a,b,c,d,e,f,g,h) (copy_file(a,b,c,d,e,f))
<span class="lineNum">     914 </span>            : #define DELETE(a,b,c,d) (delete_file(a,b))
<span class="lineNum">     915 </span>            : #define UPDATE_MSG_ID(a, b, c, d, e, f) (odbc_update_msg_id((a), (b), (c)))
<span class="lineNum">     916 </span>            : #else
<span class="lineNum">     917 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">     918 </span>            : #define DISPOSE(a,b) (imap_remove_file(a,b))
<span class="lineNum">     919 </span>            : #define STORE(a,b,c,d,e,f,g,h,i,j,k) (imap_store_file(a,b,c,d,e,f,g,h,i,j,k))
<span class="lineNum">     920 </span>            : #define RETRIEVE(a,b,c,d) imap_retrieve_file(a,b,c,d)
<span class="lineNum">     921 </span>            : #define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)
<span class="lineNum">     922 </span>            : #define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));
<span class="lineNum">     923 </span>            : #define COPY(a,b,c,d,e,f,g,h) (copy_file(g,h));
<span class="lineNum">     924 </span>            : #define DELETE(a,b,c,d) (vm_imap_delete(a,b,d))
<span class="lineNum">     925 </span>            : #define UPDATE_MSG_ID(a, b, c, d, e, f) (vm_imap_update_msg_id((a), (b), (c), (d), (e), (f)))
<span class="lineNum">     926 </span>            : #else
<span class="lineNum">     927 </span>            : #define RETRIEVE(a,b,c,d)
<span class="lineNum">     928 </span>            : #define DISPOSE(a,b)
<span class="lineNum">     929 </span>            : #define STORE(a,b,c,d,e,f,g,h,i,j,k)
<span class="lineNum">     930 </span>            : #define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)
<span class="lineNum">     931 </span>            : #define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));
<span class="lineNum">     932 </span>            : #define COPY(a,b,c,d,e,f,g,h) (copy_plain_file(g,h));
<span class="lineNum">     933 </span>            : #define DELETE(a,b,c,d) (vm_delete(c))
<span class="lineNum">     934 </span>            : #define UPDATE_MSG_ID(a, b, c, d, e, f)
<span class="lineNum">     935 </span>            : #endif
<span class="lineNum">     936 </span>            : #endif
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span>            : static char VM_SPOOL_DIR[PATH_MAX];
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span>            : static char ext_pass_cmd[128];
<span class="lineNum">     941 </span>            : static char ext_pass_check_cmd[128];
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span>            : static int my_umask;
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span>            : #define PWDCHANGE_INTERNAL (1 &lt;&lt; 1)
<span class="lineNum">     946 </span>            : #define PWDCHANGE_EXTERNAL (1 &lt;&lt; 2)
<span class="lineNum">     947 </span>            : static int pwdchange = PWDCHANGE_INTERNAL;
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">     950 </span>            : #define tdesc &quot;Comedian Mail (Voicemail System) with ODBC Storage&quot;
<span class="lineNum">     951 </span>            : #else
<span class="lineNum">     952 </span>            : # ifdef IMAP_STORAGE
<span class="lineNum">     953 </span>            : # define tdesc &quot;Comedian Mail (Voicemail System) with IMAP Storage&quot;
<span class="lineNum">     954 </span>            : # else
<span class="lineNum">     955 </span>            : # define tdesc &quot;Comedian Mail (Voicemail System)&quot;
<span class="lineNum">     956 </span>            : # endif
<span class="lineNum">     957 </span>            : #endif
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span>            : static char userscontext[AST_MAX_EXTENSION] = &quot;default&quot;;
<span class="lineNum">     960 </span>            : 
<span class="lineNum">     961 </span>            : static char *addesc = &quot;Comedian Mail&quot;;
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span>            : /* Leave a message */
<span class="lineNum">     964 </span>            : static char *app = &quot;VoiceMail&quot;;
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span>            : /* Check mail, control, etc */
<span class="lineNum">     967 </span>            : static char *app2 = &quot;VoiceMailMain&quot;;
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            : static char *app3 = &quot;MailboxExists&quot;;
<span class="lineNum">     970 </span>            : static char *app4 = &quot;VMAuthenticate&quot;;
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            : static char *playmsg_app = &quot;VoiceMailPlayMsg&quot;;
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            : static char *sayname_app = &quot;VMSayName&quot;;
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span>            : static AST_LIST_HEAD_STATIC(users, ast_vm_user);
<span class="lineNum">     977 </span>            : static AST_LIST_HEAD_STATIC(zones, vm_zone);
<span class="lineNum">     978 </span>            : static char zonetag[80];
<span class="lineNum">     979 </span>            : static char locale[20];
<span class="lineNum">     980 </span>            : static int maxsilence;
<span class="lineNum">     981 </span>            : static int maxmsg;
<span class="lineNum">     982 </span>            : static int maxdeletedmsg;
<span class="lineNum">     983 </span>            : static int silencethreshold = 128;
<span class="lineNum">     984 </span>            : static char serveremail[80];
<span class="lineNum">     985 </span>            : static char mailcmd[160];       /* Configurable mail cmd */
<span class="lineNum">     986 </span>            : static char externnotify[160];
<span class="lineNum">     987 </span>            : static struct ast_smdi_interface *smdi_iface = NULL;
<span class="lineNum">     988 </span>            : static char vmfmts[80];
<span class="lineNum">     989 </span>            : static double volgain;
<span class="lineNum">     990 </span>            : static int vmminsecs;
<span class="lineNum">     991 </span>            : static int vmmaxsecs;
<span class="lineNum">     992 </span>            : static int maxgreet;
<span class="lineNum">     993 </span>            : static int skipms;
<span class="lineNum">     994 </span>            : static int maxlogins;
<span class="lineNum">     995 </span>            : static int minpassword;
<span class="lineNum">     996 </span>            : static int passwordlocation;
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span>            : /*! Poll mailboxes for changes since there is something external to
<span class="lineNum">     999 </span>            :  *  app_voicemail that may change them. */
<span class="lineNum">    1000 </span>            : static unsigned int poll_mailboxes;
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span>            : /*! Polling frequency */
<span class="lineNum">    1003 </span>            : static unsigned int poll_freq;
<span class="lineNum">    1004 </span>            : /*! By default, poll every 30 seconds */
<span class="lineNum">    1005 </span>            : #define DEFAULT_POLL_FREQ 30
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span>            : AST_MUTEX_DEFINE_STATIC(poll_lock);
<span class="lineNum">    1008 </span>            : static ast_cond_t poll_cond = PTHREAD_COND_INITIALIZER;
<span class="lineNum">    1009 </span>            : static pthread_t poll_thread = AST_PTHREADT_NULL;
<span class="lineNum">    1010 </span>            : static unsigned char poll_thread_run;
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            : /*! Subscription to MWI event subscription changes */
<span class="lineNum">    1013 </span>            : static struct stasis_subscription *mwi_sub_sub;
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span>            : /*!
<span class="lineNum">    1016 </span>            :  * \brief An MWI subscription
<span class="lineNum">    1017 </span>            :  *
<span class="lineNum">    1018 </span>            :  * This is so we can keep track of which mailboxes are subscribed to.
<span class="lineNum">    1019 </span>            :  * This way, we know which mailboxes to poll when the pollmailboxes
<span class="lineNum">    1020 </span>            :  * option is being used.
<span class="lineNum">    1021 </span>            :  */
<span class="lineNum">    1022 </span>            : struct mwi_sub {
<span class="lineNum">    1023 </span>            :         AST_RWLIST_ENTRY(mwi_sub) entry;
<span class="lineNum">    1024 </span>            :         int old_urgent;
<span class="lineNum">    1025 </span>            :         int old_new;
<span class="lineNum">    1026 </span>            :         int old_old;
<span class="lineNum">    1027 </span>            :         char *uniqueid;
<span class="lineNum">    1028 </span>            :         char mailbox[0];
<span class="lineNum">    1029 </span>            : };
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span>            : struct mwi_sub_task {
<span class="lineNum">    1032 </span>            :         const char *mailbox;
<span class="lineNum">    1033 </span>            :         const char *context;
<span class="lineNum">    1034 </span>            :         const char *uniqueid;
<a name="1035"><span class="lineNum">    1035 </span>            : };</a>
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 : static void mwi_sub_task_dtor(struct mwi_sub_task *mwist)</span>
<span class="lineNum">    1038 </span>            : {
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :         ast_free((void *) mwist-&gt;mailbox);</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :         ast_free((void *) mwist-&gt;context);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :         ast_free((void *) mwist-&gt;uniqueid);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         ast_free(mwist);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span>            : static struct ast_taskprocessor *mwi_subscription_tps;
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span>            : static AST_RWLIST_HEAD_STATIC(mwi_subs, mwi_sub);
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span>            : /* custom audio control prompts for voicemail playback */
<span class="lineNum">    1050 </span>            : static char listen_control_forward_key[12];
<span class="lineNum">    1051 </span>            : static char listen_control_reverse_key[12];
<span class="lineNum">    1052 </span>            : static char listen_control_pause_key[12];
<span class="lineNum">    1053 </span>            : static char listen_control_restart_key[12];
<span class="lineNum">    1054 </span>            : static char listen_control_stop_key[12];
<span class="lineNum">    1055 </span>            : 
<span class="lineNum">    1056 </span>            : /* custom password sounds */
<span class="lineNum">    1057 </span>            : static char vm_login[80] = &quot;vm-login&quot;;
<span class="lineNum">    1058 </span>            : static char vm_newuser[80] = &quot;vm-newuser&quot;;
<span class="lineNum">    1059 </span>            : static char vm_password[80] = &quot;vm-password&quot;;
<span class="lineNum">    1060 </span>            : static char vm_newpassword[80] = &quot;vm-newpassword&quot;;
<span class="lineNum">    1061 </span>            : static char vm_passchanged[80] = &quot;vm-passchanged&quot;;
<span class="lineNum">    1062 </span>            : static char vm_reenterpassword[80] = &quot;vm-reenterpassword&quot;;
<span class="lineNum">    1063 </span>            : static char vm_mismatch[80] = &quot;vm-mismatch&quot;;
<span class="lineNum">    1064 </span>            : static char vm_invalid_password[80] = &quot;vm-invalid-password&quot;;
<span class="lineNum">    1065 </span>            : static char vm_pls_try_again[80] = &quot;vm-pls-try-again&quot;;
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span>            : /*
<span class="lineNum">    1068 </span>            :  * XXX If we have the time, motivation, etc. to fix up this prompt, one of the following would be appropriate:
<span class="lineNum">    1069 </span>            :  * 1. create a sound along the lines of &quot;Please try again.  When done, press the pound key&quot; which could be spliced
<span class="lineNum">    1070 </span>            :  * from existing sound clips.  This would require some programming changes in the area of vm_forward options and also
<span class="lineNum">    1071 </span>            :  * app.c's __ast_play_and_record function
<span class="lineNum">    1072 </span>            :  * 2. create a sound prompt saying &quot;Please try again.  When done recording, press any key to stop and send the prepended
<span class="lineNum">    1073 </span>            :  * message.&quot;  At the time of this comment, I think this would require new voice work to be commissioned.
<span class="lineNum">    1074 </span>            :  * 3. Something way different like providing instructions before a time out or a post-recording menu.  This would require
<span class="lineNum">    1075 </span>            :  * more effort than either of the other two.
<span class="lineNum">    1076 </span>            :  */
<span class="lineNum">    1077 </span>            : static char vm_prepend_timeout[80] = &quot;vm-then-pound&quot;;
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span>            : static struct ast_flags globalflags = {0};
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span>            : static int saydurationminfo;
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span>            : static char dialcontext[AST_MAX_CONTEXT] = &quot;&quot;;
<span class="lineNum">    1084 </span>            : static char callcontext[AST_MAX_CONTEXT] = &quot;&quot;;
<span class="lineNum">    1085 </span>            : static char exitcontext[AST_MAX_CONTEXT] = &quot;&quot;;
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span>            : static char cidinternalcontexts[MAX_NUM_CID_CONTEXTS][64];
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span>            : static char *emailbody = NULL;
<span class="lineNum">    1091 </span>            : static char *emailsubject = NULL;
<span class="lineNum">    1092 </span>            : static char *pagerbody = NULL;
<span class="lineNum">    1093 </span>            : static char *pagersubject = NULL;
<span class="lineNum">    1094 </span>            : static char fromstring[100];
<span class="lineNum">    1095 </span>            : static char pagerfromstring[100];
<span class="lineNum">    1096 </span>            : static char charset[32] = &quot;ISO-8859-1&quot;;
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span>            : static unsigned char adsifdn[4] = &quot;\x00\x00\x00\x0F&quot;;
<span class="lineNum">    1099 </span>            : static unsigned char adsisec[4] = &quot;\x9B\xDB\xF7\xAC&quot;;
<span class="lineNum">    1100 </span>            : static int adsiver = 1;
<span class="lineNum">    1101 </span>            : static char emaildateformat[32] = &quot;%A, %B %d, %Y at %r&quot;;
<span class="lineNum">    1102 </span>            : static char pagerdateformat[32] = &quot;%A, %B %d, %Y at %r&quot;;
<span class="lineNum">    1103 </span>            : 
<span class="lineNum">    1104 </span>            : /* Forward declarations - generic */
<span class="lineNum">    1105 </span>            : static int open_mailbox(struct vm_state *vms, struct ast_vm_user *vmu, int box);
<span class="lineNum">    1106 </span>            : static int close_mailbox(struct vm_state *vms, struct ast_vm_user *vmu);
<span class="lineNum">    1107 </span>            : static int advanced_options(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msg, int option, signed char record_gain);
<span class="lineNum">    1108 </span>            : static int dialout(struct ast_channel *chan, struct ast_vm_user *vmu, char *num, char *outgoing_context);
<span class="lineNum">    1109 </span>            : static int play_record_review(struct ast_channel *chan, char *playfile, char *recordfile, int maxtime,
<span class="lineNum">    1110 </span>            :                         char *fmt, int outsidecaller, struct ast_vm_user *vmu, int *duration, int *sound_duration, const char *unlockdir,
<span class="lineNum">    1111 </span>            :                         signed char record_gain, struct vm_state *vms, char *flag, const char *msg_id, int forwardintro);
<span class="lineNum">    1112 </span>            : static int vm_tempgreeting(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain);
<span class="lineNum">    1113 </span>            : static int vm_play_folder_name(struct ast_channel *chan, char *mbox);
<span class="lineNum">    1114 </span>            : static int notify_new_message(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msgnum, long duration, char *fmt, char *cidnum, char *cidname, const char *flag);
<span class="lineNum">    1115 </span>            : static void make_email_file(FILE *p, char *srcemail, struct ast_vm_user *vmu, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, char *attach, char *attach2, char *format, int duration, int attach_user_voicemail, struct ast_channel *chan, const char *category, int imap, const char *flag, const char *msg_id);
<span class="lineNum">    1116 </span>            : static void apply_options(struct ast_vm_user *vmu, const char *options);
<span class="lineNum">    1117 </span>            : static int add_email_attachment(FILE *p, struct ast_vm_user *vmu, char *format, char *attach, char *greeting_attachment, char *mailbox, char *bound, char *filename, int last, int msgnum);
<span class="lineNum">    1118 </span>            : static int is_valid_dtmf(const char *key);
<span class="lineNum">    1119 </span>            : static void read_password_from_file(const char *secretfn, char *password, int passwordlen);
<span class="lineNum">    1120 </span>            : static int write_password_to_file(const char *secretfn, const char *password);
<span class="lineNum">    1121 </span>            : static const char *substitute_escapes(const char *value);
<span class="lineNum">    1122 </span>            : static int message_range_and_existence_check(struct vm_state *vms, const char *msg_ids [], size_t num_msgs, int *msg_nums, struct ast_vm_user *vmu);
<span class="lineNum">    1123 </span>            : static void notify_new_state(struct ast_vm_user *vmu);
<span class="lineNum">    1124 </span>            : static int append_vmu_info_astman(struct mansession *s, struct ast_vm_user *vmu, const char* event_name, const char* actionid);
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span>            : 
<span class="lineNum">    1127 </span>            : /*!
<span class="lineNum">    1128 </span>            :  * Place a message in the indicated folder
<span class="lineNum">    1129 </span>            :  *
<span class="lineNum">    1130 </span>            :  * \param vmu Voicemail user
<span class="lineNum">    1131 </span>            :  * \param vms Current voicemail state for the user
<span class="lineNum">    1132 </span>            :  * \param msg The message number to save
<span class="lineNum">    1133 </span>            :  * \param box The folder into which the message should be saved
<span class="lineNum">    1134 </span>            :  * \param[out] newmsg The new message number of the saved message
<span class="lineNum">    1135 </span>            :  * \param move Tells whether to copy or to move the message
<span class="lineNum">    1136 </span>            :  *
<span class="lineNum">    1137 </span>            :  * \note the &quot;move&quot; parameter is only honored for IMAP voicemail presently
<span class="lineNum">    1138 </span>            :  * \retval 0 Success
<span class="lineNum">    1139 </span>            :  * \retval other Failure
<span class="lineNum">    1140 </span>            :  */
<span class="lineNum">    1141 </span>            : static int save_to_folder(struct ast_vm_user *vmu, struct vm_state *vms, int msg, int box, int *newmsg, int move);
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span>            : static struct ast_vm_mailbox_snapshot *vm_mailbox_snapshot_create(const char *mailbox, const char *context, const char *folder, int descending, enum ast_vm_snapshot_sort_val sort_val, int combine_INBOX_and_OLD);
<span class="lineNum">    1144 </span>            : static struct ast_vm_mailbox_snapshot *vm_mailbox_snapshot_destroy(struct ast_vm_mailbox_snapshot *mailbox_snapshot);
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span>            : static int vm_msg_forward(const char *from_mailbox, const char *from_context, const char *from_folder, const char *to_mailbox, const char *to_context, const char *to_folder, size_t num_msgs, const char *msg_ids[], int delete_old);
<span class="lineNum">    1147 </span>            : static int vm_msg_move(const char *mailbox, const char *context, size_t num_msgs, const char *oldfolder, const char *old_msg_ids[], const char *newfolder);
<span class="lineNum">    1148 </span>            : static int vm_msg_remove(const char *mailbox, const char *context, size_t num_msgs, const char *folder, const char *msgs[]);
<span class="lineNum">    1149 </span>            : static int vm_msg_play(struct ast_channel *chan, const char *mailbox, const char *context, const char *folder, const char *msg_num, ast_vm_msg_play_cb cb);
<span class="lineNum">    1150 </span>            : 
<span class="lineNum">    1151 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">    1152 </span>            : static int vm_test_destroy_user(const char *context, const char *mailbox);
<span class="lineNum">    1153 </span>            : static int vm_test_create_user(const char *context, const char *mailbox);
<span class="lineNum">    1154 </span>            : #endif
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span>            : /*!
<span class="lineNum">    1157 </span>            :  * \internal
<span class="lineNum">    1158 </span>            :  * \brief Parse the given mailbox_id into mailbox and context.
<span class="lineNum">    1159 </span>            :  * \since 12.0.0
<span class="lineNum">    1160 </span>            :  *
<span class="lineNum">    1161 </span>            :  * \param mailbox_id The mailbox@context string to separate.
<span class="lineNum">    1162 </span>            :  * \param mailbox Where the mailbox part will start.
<span class="lineNum">    1163 </span>            :  * \param context Where the context part will start.  (&quot;default&quot; if not present)
<span class="lineNum">    1164 </span>            :  *
<span class="lineNum">    1165 </span>            :  * \retval 0 on success.
<a name="1166"><span class="lineNum">    1166 </span>            :  * \retval -1 on error.</a>
<span class="lineNum">    1167 </span>            :  */
<span class="lineNum">    1168 </span><span class="lineCov">       2216 : static int separate_mailbox(char *mailbox_id, char **mailbox, char **context)</span>
<span class="lineNum">    1169 </span>            : {
<span class="lineNum">    1170 </span><span class="lineCov">       2216 :         if (ast_strlen_zero(mailbox_id) || !mailbox || !context) {</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1172 </span>            :         }
<span class="lineNum">    1173 </span><span class="lineCov">       2216 :         *context = mailbox_id;</span>
<span class="lineNum">    1174 </span><span class="lineCov">       2216 :         *mailbox = strsep(context, &quot;@&quot;);</span>
<span class="lineNum">    1175 </span><span class="lineCov">       2216 :         if (ast_strlen_zero(*mailbox)) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    1177 </span>            :         }
<span class="lineNum">    1178 </span><span class="lineCov">       2216 :         if (ast_strlen_zero(*context)) {</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                 *context = &quot;default&quot;;</span>
<span class="lineNum">    1180 </span>            :         }
<span class="lineNum">    1181 </span><span class="lineCov">       2216 :         return 0;</span>
<span class="lineNum">    1182 </span>            : }
<span class="lineNum">    1183 </span>            : 
<span class="lineNum">    1184 </span>            : struct ao2_container *inprocess_container;
<span class="lineNum">    1185 </span>            : 
<span class="lineNum">    1186 </span>            : struct inprocess {
<span class="lineNum">    1187 </span>            :         int count;
<span class="lineNum">    1188 </span>            :         char *context;
<span class="lineNum">    1189 </span>            :         char mailbox[0];
<a name="1190"><span class="lineNum">    1190 </span>            : };</a>
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span><span class="lineCov">         19 : static int inprocess_hash_fn(const void *obj, const int flags)</span>
<span class="lineNum">    1193 </span>            : {
<span class="lineNum">    1194 </span><span class="lineCov">         19 :         const struct inprocess *i = obj;</span>
<span class="lineNum">    1195 </span><span class="lineCov">         19 :         return atoi(i-&gt;mailbox);</span>
<a name="1196"><span class="lineNum">    1196 </span>            : }</a>
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span><span class="lineCov">         67 : static int inprocess_cmp_fn(void *obj, void *arg, int flags)</span>
<span class="lineNum">    1199 </span>            : {
<span class="lineNum">    1200 </span><span class="lineCov">         67 :         struct inprocess *i = obj, *j = arg;</span>
<span class="lineNum">    1201 </span><span class="lineCov">         67 :         if (strcmp(i-&gt;mailbox, j-&gt;mailbox)) {</span>
<span class="lineNum">    1202 </span><span class="lineCov">          4 :                 return 0;</span>
<span class="lineNum">    1203 </span>            :         }
<span class="lineNum">    1204 </span><span class="lineCov">         63 :         return !strcmp(i-&gt;context, j-&gt;context) ? CMP_MATCH : 0;</span>
<a name="1205"><span class="lineNum">    1205 </span>            : }</a>
<span class="lineNum">    1206 </span>            : 
<span class="lineNum">    1207 </span><span class="lineCov">         54 : static int inprocess_count(const char *context, const char *mailbox, int delta)</span>
<span class="lineNum">    1208 </span>            : {
<span class="lineNum">    1209 </span><span class="lineCov">         54 :         struct inprocess *i, *arg = ast_alloca(sizeof(*arg) + strlen(context) + strlen(mailbox) + 2);</span>
<span class="lineNum">    1210 </span><span class="lineCov">         54 :         arg-&gt;context = arg-&gt;mailbox + strlen(mailbox) + 1;</span>
<span class="lineNum">    1211 </span><span class="lineCov">         54 :         strcpy(arg-&gt;mailbox, mailbox); /* SAFE */</span>
<span class="lineNum">    1212 </span><span class="lineCov">         54 :         strcpy(arg-&gt;context, context); /* SAFE */</span>
<span class="lineNum">    1213 </span><span class="lineCov">         54 :         ao2_lock(inprocess_container);</span>
<span class="lineNum">    1214 </span><span class="lineCov">         54 :         if ((i = ao2_find(inprocess_container, arg, 0))) {</span>
<span class="lineNum">    1215 </span><span class="lineCov">         35 :                 int ret = ast_atomic_fetchadd_int(&amp;i-&gt;count, delta);</span>
<span class="lineNum">    1216 </span><span class="lineCov">         35 :                 ao2_unlock(inprocess_container);</span>
<span class="lineNum">    1217 </span><span class="lineCov">         35 :                 ao2_ref(i, -1);</span>
<span class="lineNum">    1218 </span><span class="lineCov">         35 :                 return ret;</span>
<span class="lineNum">    1219 </span>            :         }
<span class="lineNum">    1220 </span><span class="lineCov">         19 :         if (delta &lt; 0) {</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;BUG: ref count decrement on non-existing object???\n&quot;);</span>
<span class="lineNum">    1222 </span>            :         }
<span class="lineNum">    1223 </span><span class="lineCov">         19 :         if (!(i = ao2_alloc(sizeof(*i) + strlen(context) + strlen(mailbox) + 2, NULL))) {</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                 ao2_unlock(inprocess_container);</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    1226 </span>            :         }
<span class="lineNum">    1227 </span><span class="lineCov">         19 :         i-&gt;context = i-&gt;mailbox + strlen(mailbox) + 1;</span>
<span class="lineNum">    1228 </span><span class="lineCov">         19 :         strcpy(i-&gt;mailbox, mailbox); /* SAFE */</span>
<span class="lineNum">    1229 </span><span class="lineCov">         19 :         strcpy(i-&gt;context, context); /* SAFE */</span>
<span class="lineNum">    1230 </span><span class="lineCov">         19 :         i-&gt;count = delta;</span>
<span class="lineNum">    1231 </span><span class="lineCov">         19 :         ao2_link(inprocess_container, i);</span>
<span class="lineNum">    1232 </span><span class="lineCov">         19 :         ao2_unlock(inprocess_container);</span>
<span class="lineNum">    1233 </span><span class="lineCov">         19 :         ao2_ref(i, -1);</span>
<span class="lineNum">    1234 </span><span class="lineCov">         19 :         return 0;</span>
<span class="lineNum">    1235 </span>            : }
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span>            : #if !(defined(ODBC_STORAGE) || defined(IMAP_STORAGE))
<span class="lineNum">    1238 </span>            : static int __has_voicemail(const char *context, const char *mailbox, const char *folder, int shortcircuit);
<span class="lineNum">    1239 </span>            : #endif
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            : /*!
<span class="lineNum">    1242 </span>            :  * \brief Strips control and non 7-bit clean characters from input string.
<span class="lineNum">    1243 </span>            :  *
<span class="lineNum">    1244 </span>            :  * \note To map control and none 7-bit characters to a 7-bit clean characters
<a name="1245"><span class="lineNum">    1245 </span>            :  *  please use ast_str_encode_mine().</a>
<span class="lineNum">    1246 </span>            :  */
<span class="lineNum">    1247 </span><span class="lineCov">         14 : static char *strip_control_and_high(const char *input, char *buf, size_t buflen)</span>
<span class="lineNum">    1248 </span>            : {
<span class="lineNum">    1249 </span><span class="lineCov">         14 :         char *bufptr = buf;</span>
<span class="lineNum">    1250 </span><span class="lineCov">        126 :         for (; *input; input++) {</span>
<span class="lineNum">    1251 </span><span class="lineCov">        112 :                 if (*input &lt; 32) {</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1253 </span>            :                 }
<span class="lineNum">    1254 </span><span class="lineCov">        112 :                 *bufptr++ = *input;</span>
<span class="lineNum">    1255 </span><span class="lineCov">        112 :                 if (bufptr == buf + buflen - 1) {</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1257 </span>            :                 }
<span class="lineNum">    1258 </span>            :         }
<span class="lineNum">    1259 </span><span class="lineCov">         14 :         *bufptr = '\0';</span>
<span class="lineNum">    1260 </span><span class="lineCov">         14 :         return buf;</span>
<span class="lineNum">    1261 </span>            : }
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span>            : /*!
<span class="lineNum">    1265 </span>            :  * \brief Sets default voicemail system options to a voicemail user.
<span class="lineNum">    1266 </span>            :  *
<span class="lineNum">    1267 </span>            :  * This applies select global settings to a newly created (dynamic) instance of a voicemail user.
<span class="lineNum">    1268 </span>            :  * - all the globalflags
<span class="lineNum">    1269 </span>            :  * - the saydurationminfo
<span class="lineNum">    1270 </span>            :  * - the callcontext
<span class="lineNum">    1271 </span>            :  * - the dialcontext
<span class="lineNum">    1272 </span>            :  * - the exitcontext
<span class="lineNum">    1273 </span>            :  * - vmmaxsecs, vmmaxmsg, maxdeletedmsg
<span class="lineNum">    1274 </span>            :  * - volume gain.
<a name="1275"><span class="lineNum">    1275 </span>            :  * - emailsubject, emailbody set to NULL</a>
<span class="lineNum">    1276 </span>            :  */
<span class="lineNum">    1277 </span><span class="lineCov">       2180 : static void populate_defaults(struct ast_vm_user *vmu)</span>
<span class="lineNum">    1278 </span>            : {
<span class="lineNum">    1279 </span><span class="lineCov">       2180 :         ast_copy_flags(vmu, (&amp;globalflags), AST_FLAGS_ALL);</span>
<span class="lineNum">    1280 </span><span class="lineCov">       2180 :         vmu-&gt;passwordlocation = passwordlocation;</span>
<span class="lineNum">    1281 </span><span class="lineCov">       2180 :         if (saydurationminfo) {</span>
<span class="lineNum">    1282 </span><span class="lineCov">       2180 :                 vmu-&gt;saydurationm = saydurationminfo;</span>
<span class="lineNum">    1283 </span>            :         }
<span class="lineNum">    1284 </span><span class="lineCov">       2180 :         ast_copy_string(vmu-&gt;callback, callcontext, sizeof(vmu-&gt;callback));</span>
<span class="lineNum">    1285 </span><span class="lineCov">       2180 :         ast_copy_string(vmu-&gt;dialout, dialcontext, sizeof(vmu-&gt;dialout));</span>
<span class="lineNum">    1286 </span><span class="lineCov">       2180 :         ast_copy_string(vmu-&gt;exit, exitcontext, sizeof(vmu-&gt;exit));</span>
<span class="lineNum">    1287 </span><span class="lineCov">       2180 :         ast_copy_string(vmu-&gt;zonetag, zonetag, sizeof(vmu-&gt;zonetag));</span>
<span class="lineNum">    1288 </span><span class="lineCov">       2180 :         ast_copy_string(vmu-&gt;locale, locale, sizeof(vmu-&gt;locale));</span>
<span class="lineNum">    1289 </span><span class="lineCov">       2180 :         if (vmminsecs) {</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                 vmu-&gt;minsecs = vmminsecs;</span>
<span class="lineNum">    1291 </span>            :         }
<span class="lineNum">    1292 </span><span class="lineCov">       2180 :         if (vmmaxsecs) {</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :                 vmu-&gt;maxsecs = vmmaxsecs;</span>
<span class="lineNum">    1294 </span>            :         }
<span class="lineNum">    1295 </span><span class="lineCov">       2180 :         if (maxmsg) {</span>
<span class="lineNum">    1296 </span><span class="lineCov">       2180 :                 vmu-&gt;maxmsg = maxmsg;</span>
<span class="lineNum">    1297 </span>            :         }
<span class="lineNum">    1298 </span><span class="lineCov">       2180 :         if (maxdeletedmsg) {</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                 vmu-&gt;maxdeletedmsg = maxdeletedmsg;</span>
<span class="lineNum">    1300 </span>            :         }
<span class="lineNum">    1301 </span><span class="lineCov">       2180 :         vmu-&gt;volgain = volgain;</span>
<span class="lineNum">    1302 </span><span class="lineCov">       2180 :         ast_free(vmu-&gt;email);</span>
<span class="lineNum">    1303 </span><span class="lineCov">       2180 :         vmu-&gt;email = NULL;</span>
<span class="lineNum">    1304 </span><span class="lineCov">       2180 :         ast_free(vmu-&gt;emailsubject);</span>
<span class="lineNum">    1305 </span><span class="lineCov">       2180 :         vmu-&gt;emailsubject = NULL;</span>
<span class="lineNum">    1306 </span><span class="lineCov">       2180 :         ast_free(vmu-&gt;emailbody);</span>
<span class="lineNum">    1307 </span><span class="lineCov">       2180 :         vmu-&gt;emailbody = NULL;</span>
<span class="lineNum">    1308 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    1309 </span>            :         ast_copy_string(vmu-&gt;imapfolder, imapfolder, sizeof(vmu-&gt;imapfolder));
<span class="lineNum">    1310 </span>            :         ast_copy_string(vmu-&gt;imapserver, imapserver, sizeof(vmu-&gt;imapserver));
<span class="lineNum">    1311 </span>            :         ast_copy_string(vmu-&gt;imapport, imapport, sizeof(vmu-&gt;imapport));
<span class="lineNum">    1312 </span>            :         ast_copy_string(vmu-&gt;imapflags, imapflags, sizeof(vmu-&gt;imapflags));
<span class="lineNum">    1313 </span>            : #endif
<span class="lineNum">    1314 </span><span class="lineCov">       2180 : }</span>
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span>            : /*!
<span class="lineNum">    1317 </span>            :  * \brief Sets a specific property value.
<span class="lineNum">    1318 </span>            :  * \param vmu The voicemail user object to work with.
<span class="lineNum">    1319 </span>            :  * \param var The name of the property to be set.
<span class="lineNum">    1320 </span>            :  * \param value The value to be set to the property.
<span class="lineNum">    1321 </span>            :  *
<a name="1322"><span class="lineNum">    1322 </span>            :  * The property name must be one of the understood properties. See the source for details.</a>
<span class="lineNum">    1323 </span>            :  */
<span class="lineNum">    1324 </span><span class="lineCov">         34 : static void apply_option(struct ast_vm_user *vmu, const char *var, const char *value)</span>
<span class="lineNum">    1325 </span>            : {
<span class="lineNum">    1326 </span>            :         int x;
<span class="lineNum">    1327 </span><span class="lineCov">         34 :         if (!strcasecmp(var, &quot;attach&quot;)) {</span>
<span class="lineNum">    1328 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_ATTACH);</span>
<span class="lineNum">    1329 </span><span class="lineCov">         33 :         } else if (!strcasecmp(var, &quot;attachfmt&quot;)) {</span>
<span class="lineNum">    1330 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;attachfmt, value, sizeof(vmu-&gt;attachfmt));</span>
<span class="lineNum">    1331 </span><span class="lineCov">         32 :         } else if (!strcasecmp(var, &quot;serveremail&quot;)) {</span>
<span class="lineNum">    1332 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;serveremail, value, sizeof(vmu-&gt;serveremail));</span>
<span class="lineNum">    1333 </span><span class="lineCov">         31 :         } else if (!strcasecmp(var, &quot;fromstring&quot;)) {</span>
<span class="lineNum">    1334 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;fromstring, value, sizeof(vmu-&gt;fromstring));</span>
<span class="lineNum">    1335 </span><span class="lineCov">         30 :         } else if (!strcasecmp(var, &quot;emailbody&quot;)) {</span>
<span class="lineNum">    1336 </span><span class="lineCov">          1 :                 ast_free(vmu-&gt;emailbody);</span>
<span class="lineNum">    1337 </span><span class="lineCov">          1 :                 vmu-&gt;emailbody = ast_strdup(substitute_escapes(value));</span>
<span class="lineNum">    1338 </span><span class="lineCov">         29 :         } else if (!strcasecmp(var, &quot;emailsubject&quot;)) {</span>
<span class="lineNum">    1339 </span><span class="lineCov">          1 :                 ast_free(vmu-&gt;emailsubject);</span>
<span class="lineNum">    1340 </span><span class="lineCov">          1 :                 vmu-&gt;emailsubject = ast_strdup(substitute_escapes(value));</span>
<span class="lineNum">    1341 </span><span class="lineCov">         28 :         } else if (!strcasecmp(var, &quot;language&quot;)) {</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :                 ast_copy_string(vmu-&gt;language, value, sizeof(vmu-&gt;language));</span>
<span class="lineNum">    1343 </span><span class="lineCov">         28 :         } else if (!strcasecmp(var, &quot;tz&quot;)) {</span>
<span class="lineNum">    1344 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;zonetag, value, sizeof(vmu-&gt;zonetag));</span>
<span class="lineNum">    1345 </span><span class="lineCov">         27 :         } else if (!strcasecmp(var, &quot;locale&quot;)) {</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :                 ast_copy_string(vmu-&gt;locale, value, sizeof(vmu-&gt;locale));</span>
<span class="lineNum">    1347 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    1348 </span>            :         } else if (!strcasecmp(var, &quot;imapuser&quot;)) {
<span class="lineNum">    1349 </span>            :                 ast_copy_string(vmu-&gt;imapuser, value, sizeof(vmu-&gt;imapuser));
<span class="lineNum">    1350 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1351 </span>            :         } else if (!strcasecmp(var, &quot;imapserver&quot;)) {
<span class="lineNum">    1352 </span>            :                 ast_copy_string(vmu-&gt;imapserver, value, sizeof(vmu-&gt;imapserver));
<span class="lineNum">    1353 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1354 </span>            :         } else if (!strcasecmp(var, &quot;imapport&quot;)) {
<span class="lineNum">    1355 </span>            :                 ast_copy_string(vmu-&gt;imapport, value, sizeof(vmu-&gt;imapport));
<span class="lineNum">    1356 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1357 </span>            :         } else if (!strcasecmp(var, &quot;imapflags&quot;)) {
<span class="lineNum">    1358 </span>            :                 ast_copy_string(vmu-&gt;imapflags, value, sizeof(vmu-&gt;imapflags));
<span class="lineNum">    1359 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1360 </span>            :         } else if (!strcasecmp(var, &quot;imappassword&quot;) || !strcasecmp(var, &quot;imapsecret&quot;)) {
<span class="lineNum">    1361 </span>            :                 ast_copy_string(vmu-&gt;imappassword, value, sizeof(vmu-&gt;imappassword));
<span class="lineNum">    1362 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1363 </span>            :         } else if (!strcasecmp(var, &quot;imapfolder&quot;)) {
<span class="lineNum">    1364 </span>            :                 ast_copy_string(vmu-&gt;imapfolder, value, sizeof(vmu-&gt;imapfolder));
<span class="lineNum">    1365 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1366 </span>            :         } else if (!strcasecmp(var, &quot;imapvmshareid&quot;)) {
<span class="lineNum">    1367 </span>            :                 ast_copy_string(vmu-&gt;imapvmshareid, value, sizeof(vmu-&gt;imapvmshareid));
<span class="lineNum">    1368 </span>            :                 vmu-&gt;imapversion = imapversion;
<span class="lineNum">    1369 </span>            : #endif
<span class="lineNum">    1370 </span><span class="lineCov">         27 :         } else if (!strcasecmp(var, &quot;delete&quot;) || !strcasecmp(var, &quot;deletevoicemail&quot;)) {</span>
<span class="lineNum">    1371 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_DELETE);</span>
<span class="lineNum">    1372 </span><span class="lineCov">         26 :         } else if (!strcasecmp(var, &quot;saycid&quot;)){</span>
<span class="lineNum">    1373 </span><span class="lineCov">          2 :                 ast_set2_flag(vmu, ast_true(value), VM_SAYCID);</span>
<span class="lineNum">    1374 </span><span class="lineCov">         24 :         } else if (!strcasecmp(var, &quot;sendvoicemail&quot;)){</span>
<span class="lineNum">    1375 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_SVMAIL);</span>
<span class="lineNum">    1376 </span><span class="lineCov">         23 :         } else if (!strcasecmp(var, &quot;review&quot;)){</span>
<span class="lineNum">    1377 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_REVIEW);</span>
<span class="lineNum">    1378 </span><span class="lineCov">         22 :         } else if (!strcasecmp(var, &quot;tempgreetwarn&quot;)){</span>
<span class="lineNum">    1379 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_TEMPGREETWARN);</span>
<span class="lineNum">    1380 </span><span class="lineCov">         21 :         } else if (!strcasecmp(var, &quot;messagewrap&quot;)){</span>
<span class="lineNum">    1381 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_MESSAGEWRAP);</span>
<span class="lineNum">    1382 </span><span class="lineCov">         20 :         } else if (!strcasecmp(var, &quot;operator&quot;)) {</span>
<span class="lineNum">    1383 </span><span class="lineCov">          2 :                 ast_set2_flag(vmu, ast_true(value), VM_OPERATOR);</span>
<span class="lineNum">    1384 </span><span class="lineCov">         18 :         } else if (!strcasecmp(var, &quot;envelope&quot;)){</span>
<span class="lineNum">    1385 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_ENVELOPE);</span>
<span class="lineNum">    1386 </span><span class="lineCov">         17 :         } else if (!strcasecmp(var, &quot;moveheard&quot;)){</span>
<span class="lineNum">    1387 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_MOVEHEARD);</span>
<span class="lineNum">    1388 </span><span class="lineCov">         16 :         } else if (!strcasecmp(var, &quot;sayduration&quot;)){</span>
<span class="lineNum">    1389 </span><span class="lineCov">          2 :                 ast_set2_flag(vmu, ast_true(value), VM_SAYDURATION);</span>
<span class="lineNum">    1390 </span><span class="lineCov">         14 :         } else if (!strcasecmp(var, &quot;saydurationm&quot;)){</span>
<span class="lineNum">    1391 </span><span class="lineCov">          2 :                 if (sscanf(value, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">    1392 </span><span class="lineCov">          2 :                         vmu-&gt;saydurationm = x;</span>
<span class="lineNum">    1393 </span>            :                 } else {
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Invalid min duration for say duration\n&quot;);</span>
<span class="lineNum">    1395 </span>            :                 }
<span class="lineNum">    1396 </span><span class="lineCov">         12 :         } else if (!strcasecmp(var, &quot;forcename&quot;)){</span>
<span class="lineNum">    1397 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_FORCENAME);</span>
<span class="lineNum">    1398 </span><span class="lineCov">         11 :         } else if (!strcasecmp(var, &quot;forcegreetings&quot;)){</span>
<span class="lineNum">    1399 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_FORCEGREET);</span>
<span class="lineNum">    1400 </span><span class="lineCov">         10 :         } else if (!strcasecmp(var, &quot;callback&quot;)) {</span>
<span class="lineNum">    1401 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;callback, value, sizeof(vmu-&gt;callback));</span>
<span class="lineNum">    1402 </span><span class="lineCov">          9 :         } else if (!strcasecmp(var, &quot;dialout&quot;)) {</span>
<span class="lineNum">    1403 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;dialout, value, sizeof(vmu-&gt;dialout));</span>
<span class="lineNum">    1404 </span><span class="lineCov">          8 :         } else if (!strcasecmp(var, &quot;exitcontext&quot;)) {</span>
<span class="lineNum">    1405 </span><span class="lineCov">          2 :                 ast_copy_string(vmu-&gt;exit, value, sizeof(vmu-&gt;exit));</span>
<span class="lineNum">    1406 </span><span class="lineCov">          6 :         } else if (!strcasecmp(var, &quot;minsecs&quot;)) {</span>
<span class="lineNum">    1407 </span><span class="lineCov">          1 :                 if (sscanf(value, &quot;%30d&quot;, &amp;x) == 1 &amp;&amp; x &gt;= 0) {</span>
<span class="lineNum">    1408 </span><span class="lineCov">          1 :                         vmu-&gt;minsecs = x;</span>
<span class="lineNum">    1409 </span>            :                 } else {
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Invalid min message length of %s. Using global value %d\n&quot;, value, vmminsecs);</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                         vmu-&gt;minsecs = vmminsecs;</span>
<span class="lineNum">    1412 </span>            :                 }
<span class="lineNum">    1413 </span><span class="lineCov">          5 :         } else if (!strcasecmp(var, &quot;maxmessage&quot;) || !strcasecmp(var, &quot;maxsecs&quot;)) {</span>
<span class="lineNum">    1414 </span><span class="lineCov">          1 :                 vmu-&gt;maxsecs = atoi(value);</span>
<span class="lineNum">    1415 </span><span class="lineCov">          1 :                 if (vmu-&gt;maxsecs &lt;= 0) {</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Invalid max message length of %s. Using global value %d\n&quot;, value, vmmaxsecs);</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxsecs = vmmaxsecs;</span>
<span class="lineNum">    1418 </span>            :                 } else {
<span class="lineNum">    1419 </span><span class="lineCov">          1 :                         vmu-&gt;maxsecs = atoi(value);</span>
<span class="lineNum">    1420 </span>            :                 }
<span class="lineNum">    1421 </span><span class="lineCov">          1 :                 if (!strcasecmp(var, &quot;maxmessage&quot;))</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Option 'maxmessage' has been deprecated in favor of 'maxsecs'.  Please make that change in your voicemail config.\n&quot;);</span>
<span class="lineNum">    1423 </span><span class="lineCov">          4 :         } else if (!strcasecmp(var, &quot;maxmsg&quot;)) {</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                 vmu-&gt;maxmsg = atoi(value);</span>
<span class="lineNum">    1425 </span>            :                 /* Accept maxmsg=0 (Greetings only voicemail) */
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                 if (vmu-&gt;maxmsg &lt; 0) {</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Invalid number of messages per folder maxmsg=%s. Using default value %d\n&quot;, value, MAXMSG);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxmsg = MAXMSG;</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                 } else if (vmu-&gt;maxmsg &gt; MAXMSGLIMIT) {</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Maximum number of messages per folder is %d. Cannot accept value maxmsg=%s\n&quot;, MAXMSGLIMIT, value);</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxmsg = MAXMSGLIMIT;</span>
<span class="lineNum">    1432 </span>            :                 }
<span class="lineNum">    1433 </span><span class="lineCov">          4 :         } else if (!strcasecmp(var, &quot;nextaftercmd&quot;)) {</span>
<span class="lineNum">    1434 </span><span class="lineCov">          1 :                 ast_set2_flag(vmu, ast_true(value), VM_SKIPAFTERCMD);</span>
<span class="lineNum">    1435 </span><span class="lineCov">          3 :         } else if (!strcasecmp(var, &quot;backupdeleted&quot;)) {</span>
<span class="lineNum">    1436 </span><span class="lineCov">          1 :                 if (sscanf(value, &quot;%30d&quot;, &amp;x) == 1)</span>
<span class="lineNum">    1437 </span><span class="lineCov">          1 :                         vmu-&gt;maxdeletedmsg = x;</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :                 else if (ast_true(value))</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxdeletedmsg = MAXMSG;</span>
<span class="lineNum">    1440 </span>            :                 else
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxdeletedmsg = 0;</span>
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span><span class="lineCov">          1 :                 if (vmu-&gt;maxdeletedmsg &lt; 0) {</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Invalid number of deleted messages saved per mailbox backupdeleted=%s. Using default value %d\n&quot;, value, MAXMSG);</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxdeletedmsg = MAXMSG;</span>
<span class="lineNum">    1446 </span><span class="lineCov">          1 :                 } else if (vmu-&gt;maxdeletedmsg &gt; MAXMSGLIMIT) {</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Maximum number of deleted messages saved per mailbox is %d. Cannot accept value backupdeleted=%s\n&quot;, MAXMSGLIMIT, value);</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                         vmu-&gt;maxdeletedmsg = MAXMSGLIMIT;</span>
<span class="lineNum">    1449 </span>            :                 }
<span class="lineNum">    1450 </span><span class="lineCov">          2 :         } else if (!strcasecmp(var, &quot;volgain&quot;)) {</span>
<span class="lineNum">    1451 </span><span class="lineCov">          1 :                 sscanf(value, &quot;%30lf&quot;, &amp;vmu-&gt;volgain);</span>
<span class="lineNum">    1452 </span><span class="lineCov">          1 :         } else if (!strcasecmp(var, &quot;passwordlocation&quot;)) {</span>
<span class="lineNum">    1453 </span><span class="lineCov">          1 :                 if (!strcasecmp(value, &quot;spooldir&quot;)) {</span>
<span class="lineNum">    1454 </span><span class="lineCov">          1 :                         vmu-&gt;passwordlocation = OPT_PWLOC_SPOOLDIR;</span>
<span class="lineNum">    1455 </span>            :                 } else {
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                         vmu-&gt;passwordlocation = OPT_PWLOC_VOICEMAILCONF;</span>
<span class="lineNum">    1457 </span>            :                 }
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(var, &quot;options&quot;)) {</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                 apply_options(vmu, value);</span>
<span class="lineNum">    1460 </span>            :         }
<a name="1461"><span class="lineNum">    1461 </span><span class="lineCov">         34 : }</span></a>
<span class="lineNum">    1462 </span>            : 
<span class="lineNum">    1463 </span><span class="lineCov">          9 : static char *vm_check_password_shell(char *command, char *buf, size_t len)</span>
<span class="lineNum">    1464 </span>            : {
<span class="lineNum">    1465 </span><span class="lineCov">          9 :         int fds[2], pid = 0;</span>
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span><span class="lineCov">          9 :         memset(buf, 0, len);</span>
<span class="lineNum">    1468 </span>            : 
<span class="lineNum">    1469 </span><span class="lineCov">          9 :         if (pipe(fds)) {</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :                 snprintf(buf, len, &quot;FAILURE: Pipe failed: %s&quot;, strerror(errno));</span>
<span class="lineNum">    1471 </span>            :         } else {
<span class="lineNum">    1472 </span>            :                 /* good to go*/
<span class="lineNum">    1473 </span><span class="lineCov">          9 :                 pid = ast_safe_fork(0);</span>
<span class="lineNum">    1474 </span>            : 
<span class="lineNum">    1475 </span><span class="lineCov">          9 :                 if (pid &lt; 0) {</span>
<span class="lineNum">    1476 </span>            :                         /* ok maybe not */
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :                         close(fds[0]);</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                         close(fds[1]);</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :                         snprintf(buf, len, &quot;FAILURE: Fork failed&quot;);</span>
<span class="lineNum">    1480 </span><span class="lineCov">          9 :                 } else if (pid) {</span>
<span class="lineNum">    1481 </span>            :                         /* parent */
<span class="lineNum">    1482 </span><span class="lineCov">          6 :                         close(fds[1]);</span>
<span class="lineNum">    1483 </span><span class="lineCov">          6 :                         if (read(fds[0], buf, len) &lt; 0) {</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;read() failed: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">    1485 </span>            :                         }
<span class="lineNum">    1486 </span><span class="lineCov">          6 :                         close(fds[0]);</span>
<span class="lineNum">    1487 </span>            :                 } else {
<span class="lineNum">    1488 </span>            :                         /*  child */
<span class="lineNum">    1489 </span><span class="lineCov">          3 :                         AST_DECLARE_APP_ARGS(arg,</span>
<span class="lineNum">    1490 </span>            :                                 AST_APP_ARG(v)[20];
<span class="lineNum">    1491 </span>            :                         );
<span class="lineNum">    1492 </span><span class="lineCov">          3 :                         char *mycmd = ast_strdupa(command);</span>
<span class="lineNum">    1493 </span>            : 
<span class="lineNum">    1494 </span><span class="lineCov">          3 :                         close(fds[0]);</span>
<span class="lineNum">    1495 </span><span class="lineCov">          3 :                         dup2(fds[1], STDOUT_FILENO);</span>
<span class="lineNum">    1496 </span><span class="lineCov">          3 :                         close(fds[1]);</span>
<span class="lineNum">    1497 </span><span class="lineCov">          3 :                         ast_close_fds_above_n(STDOUT_FILENO);</span>
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineCov">          3 :                         AST_NONSTANDARD_APP_ARGS(arg, mycmd, ' ');</span>
<span class="lineNum">    1500 </span>            : 
<span class="lineNum">    1501 </span><span class="lineCov">          3 :                         execv(arg.v[0], arg.v);</span>
<span class="lineNum">    1502 </span><span class="lineCov">          3 :                         printf(&quot;FAILURE: %s&quot;, strerror(errno));</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                         _exit(0);</span>
<span class="lineNum">    1504 </span>            :                 }
<span class="lineNum">    1505 </span>            :         }
<span class="lineNum">    1506 </span><span class="lineCov">          6 :         return buf;</span>
<span class="lineNum">    1507 </span>            : }
<span class="lineNum">    1508 </span>            : 
<span class="lineNum">    1509 </span>            : /*!
<span class="lineNum">    1510 </span>            :  * \brief Check that password meets minimum required length
<span class="lineNum">    1511 </span>            :  * \param vmu The voicemail user to change the password for.
<span class="lineNum">    1512 </span>            :  * \param password The password string to check
<span class="lineNum">    1513 </span>            :  *
<a name="1514"><span class="lineNum">    1514 </span>            :  * \return zero on ok, 1 on not ok.</a>
<span class="lineNum">    1515 </span>            :  */
<span class="lineNum">    1516 </span><span class="lineCov">         12 : static int check_password(struct ast_vm_user *vmu, char *password)</span>
<span class="lineNum">    1517 </span>            : {
<span class="lineNum">    1518 </span>            :         /* check minimum length */
<span class="lineNum">    1519 </span><span class="lineCov">         12 :         if (strlen(password) &lt; minpassword)</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">    1521 </span>            :         /* check that password does not contain '*' character */
<span class="lineNum">    1522 </span><span class="lineCov">         12 :         if (!ast_strlen_zero(password) &amp;&amp; password[0] == '*')</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">    1524 </span><span class="lineCov">         12 :         if (!ast_strlen_zero(ext_pass_check_cmd)) {</span>
<span class="lineNum">    1525 </span>            :                 char cmd[255], buf[255];
<span class="lineNum">    1526 </span>            : 
<span class="lineNum">    1527 </span><span class="lineCov">          9 :                 ast_debug(1, &quot;Verify password policies for %s\n&quot;, password);</span>
<span class="lineNum">    1528 </span>            : 
<span class="lineNum">    1529 </span><span class="lineCov">          9 :                 snprintf(cmd, sizeof(cmd), &quot;%s %s %s %s %s&quot;, ext_pass_check_cmd, vmu-&gt;mailbox, vmu-&gt;context, vmu-&gt;password, password);</span>
<span class="lineNum">    1530 </span><span class="lineCov">          9 :                 if (vm_check_password_shell(cmd, buf, sizeof(buf))) {</span>
<span class="lineNum">    1531 </span><span class="lineCov">          6 :                         ast_debug(5, &quot;Result: %s\n&quot;, buf);</span>
<span class="lineNum">    1532 </span><span class="lineCov">          6 :                         if (!strncasecmp(buf, &quot;VALID&quot;, 5)) {</span>
<span class="lineNum">    1533 </span><span class="lineCov">          1 :                                 ast_debug(3, &quot;Passed password check: '%s'\n&quot;, buf);</span>
<span class="lineNum">    1534 </span><span class="lineCov">          6 :                                 return 0;</span>
<span class="lineNum">    1535 </span><span class="lineCov">          5 :                         } else if (!strncasecmp(buf, &quot;FAILURE&quot;, 7)) {</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Unable to execute password validation script: '%s'.\n&quot;, buf);</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                                 return 0;</span>
<span class="lineNum">    1538 </span>            :                         } else {
<span class="lineNum">    1539 </span><span class="lineCov">          5 :                                 ast_log(AST_LOG_NOTICE, &quot;Password doesn't match policies for user %s %s\n&quot;, vmu-&gt;mailbox, password);</span>
<span class="lineNum">    1540 </span><span class="lineCov">          5 :                                 return 1;</span>
<span class="lineNum">    1541 </span>            :                         }
<span class="lineNum">    1542 </span>            :                 }
<span class="lineNum">    1543 </span>            :         }
<span class="lineNum">    1544 </span><span class="lineCov">          3 :         return 0;</span>
<span class="lineNum">    1545 </span>            : }
<span class="lineNum">    1546 </span>            : 
<span class="lineNum">    1547 </span>            : /*!
<span class="lineNum">    1548 </span>            :  * \brief Performs a change of the voicemail passowrd in the realtime engine.
<span class="lineNum">    1549 </span>            :  * \param vmu The voicemail user to change the password for.
<span class="lineNum">    1550 </span>            :  * \param password The new value to be set to the password for this user.
<span class="lineNum">    1551 </span>            :  *
<span class="lineNum">    1552 </span>            :  * This only works if there is a realtime engine configured.
<span class="lineNum">    1553 </span>            :  * This is called from the (top level) vm_change_password.
<span class="lineNum">    1554 </span>            :  *
<a name="1555"><span class="lineNum">    1555 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    1556 </span>            :  */
<span class="lineNum">    1557 </span><span class="lineCov">          3 : static int change_password_realtime(struct ast_vm_user *vmu, const char *password)</span>
<span class="lineNum">    1558 </span>            : {
<span class="lineNum">    1559 </span><span class="lineCov">          3 :         int res = -1;</span>
<span class="lineNum">    1560 </span><span class="lineCov">          3 :         if (!strcmp(vmu-&gt;password, password)) {</span>
<span class="lineNum">    1561 </span>            :                 /* No change (but an update would return 0 rows updated, so we opt out here) */
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    1563 </span>            :         }
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span><span class="lineCov">          3 :         if (strlen(password) &gt; 10) {</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                 ast_realtime_require_field(&quot;voicemail&quot;, &quot;password&quot;, RQ_CHAR, strlen(password), SENTINEL);</span>
<span class="lineNum">    1567 </span>            :         }
<span class="lineNum">    1568 </span><span class="lineCov">          3 :         if (ast_update2_realtime(&quot;voicemail&quot;, &quot;context&quot;, vmu-&gt;context, &quot;mailbox&quot;, vmu-&gt;mailbox, SENTINEL, &quot;password&quot;, password, SENTINEL) &gt; 0) {</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                 ast_test_suite_event_notify(&quot;PASSWORDCHANGED&quot;, &quot;Message: realtime engine updated with new password\r\nPasswordSource: realtime&quot;);</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :                 ast_copy_string(vmu-&gt;password, password, sizeof(vmu-&gt;password));</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">    1572 </span>            :         }
<span class="lineNum">    1573 </span><span class="lineCov">          3 :         return res;</span>
<span class="lineNum">    1574 </span>            : }
<span class="lineNum">    1575 </span>            : 
<span class="lineNum">    1576 </span>            : /*!
<a name="1577"><span class="lineNum">    1577 </span>            :  * \brief Destructively Parse options and apply.</a>
<span class="lineNum">    1578 </span>            :  */
<span class="lineNum">    1579 </span><span class="lineCov">          3 : static void apply_options(struct ast_vm_user *vmu, const char *options)</span>
<span class="lineNum">    1580 </span>            : {
<span class="lineNum">    1581 </span>            :         char *stringp;
<span class="lineNum">    1582 </span>            :         char *s;
<span class="lineNum">    1583 </span>            :         char *var, *value;
<span class="lineNum">    1584 </span><span class="lineCov">          3 :         stringp = ast_strdupa(options);</span>
<span class="lineNum">    1585 </span><span class="lineCov">         37 :         while ((s = strsep(&amp;stringp, &quot;|&quot;))) {</span>
<span class="lineNum">    1586 </span><span class="lineCov">         34 :                 value = s;</span>
<span class="lineNum">    1587 </span><span class="lineCov">         34 :                 if ((var = strsep(&amp;value, &quot;=&quot;)) &amp;&amp; value) {</span>
<span class="lineNum">    1588 </span><span class="lineCov">         34 :                         apply_option(vmu, var, value);</span>
<span class="lineNum">    1589 </span>            :                 }
<span class="lineNum">    1590 </span>            :         }
<span class="lineNum">    1591 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span>            : /*!
<span class="lineNum">    1594 </span>            :  * \brief Loads the options specific to a voicemail user.
<span class="lineNum">    1595 </span>            :  *
<a name="1596"><span class="lineNum">    1596 </span>            :  * This is called when a vm_user structure is being set up, such as from load_options.</a>
<span class="lineNum">    1597 </span>            :  */
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 : static void apply_options_full(struct ast_vm_user *retval, struct ast_variable *var)</span>
<span class="lineNum">    1599 </span>            : {
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :         for (; var; var = var-&gt;next) {</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(var-&gt;name, &quot;vmsecret&quot;)) {</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                         ast_copy_string(retval-&gt;password, var-&gt;value, sizeof(retval-&gt;password));</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;secret&quot;) || !strcasecmp(var-&gt;name, &quot;password&quot;)) { /* don't overwrite vmsecret if it exists */</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :                         if (ast_strlen_zero(retval-&gt;password)) {</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(var-&gt;value) &amp;&amp; var-&gt;value[0] == '*') {</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :                                         ast_log(LOG_WARNING, &quot;Invalid password detected for mailbox %s.  The password&quot;</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :                                                 &quot;\n\tmust be reset in voicemail.conf.\n&quot;, retval-&gt;mailbox);</span>
<span class="lineNum">    1608 </span>            :                                 } else {
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :                                         ast_copy_string(retval-&gt;password, var-&gt;value, sizeof(retval-&gt;password));</span>
<span class="lineNum">    1610 </span>            :                                 }
<span class="lineNum">    1611 </span>            :                         }
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;uniqueid&quot;)) {</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :                         ast_copy_string(retval-&gt;uniqueid, var-&gt;value, sizeof(retval-&gt;uniqueid));</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;pager&quot;)) {</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :                         ast_copy_string(retval-&gt;pager, var-&gt;value, sizeof(retval-&gt;pager));</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;email&quot;)) {</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :                         ast_free(retval-&gt;email);</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :                         retval-&gt;email = ast_strdup(var-&gt;value);</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;fullname&quot;)) {</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :                         ast_copy_string(retval-&gt;fullname, var-&gt;value, sizeof(retval-&gt;fullname));</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;context&quot;)) {</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :                         ast_copy_string(retval-&gt;context, var-&gt;value, sizeof(retval-&gt;context));</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;emailsubject&quot;)) {</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                         ast_free(retval-&gt;emailsubject);</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :                         retval-&gt;emailsubject = ast_strdup(substitute_escapes(var-&gt;value));</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                 } else if (!strcasecmp(var-&gt;name, &quot;emailbody&quot;)) {</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :                         ast_free(retval-&gt;emailbody);</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :                         retval-&gt;emailbody = ast_strdup(substitute_escapes(var-&gt;value));</span>
<span class="lineNum">    1629 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    1630 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapuser&quot;)) {
<span class="lineNum">    1631 </span>            :                         ast_copy_string(retval-&gt;imapuser, var-&gt;value, sizeof(retval-&gt;imapuser));
<span class="lineNum">    1632 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1633 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapserver&quot;)) {
<span class="lineNum">    1634 </span>            :                         ast_copy_string(retval-&gt;imapserver, var-&gt;value, sizeof(retval-&gt;imapserver));
<span class="lineNum">    1635 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1636 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapport&quot;)) {
<span class="lineNum">    1637 </span>            :                         ast_copy_string(retval-&gt;imapport, var-&gt;value, sizeof(retval-&gt;imapport));
<span class="lineNum">    1638 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1639 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapflags&quot;)) {
<span class="lineNum">    1640 </span>            :                         ast_copy_string(retval-&gt;imapflags, var-&gt;value, sizeof(retval-&gt;imapflags));
<span class="lineNum">    1641 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1642 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imappassword&quot;) || !strcasecmp(var-&gt;name, &quot;imapsecret&quot;)) {
<span class="lineNum">    1643 </span>            :                         ast_copy_string(retval-&gt;imappassword, var-&gt;value, sizeof(retval-&gt;imappassword));
<span class="lineNum">    1644 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1645 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapfolder&quot;)) {
<span class="lineNum">    1646 </span>            :                         ast_copy_string(retval-&gt;imapfolder, var-&gt;value, sizeof(retval-&gt;imapfolder));
<span class="lineNum">    1647 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1648 </span>            :                 } else if (!strcasecmp(var-&gt;name, &quot;imapvmshareid&quot;)) {
<span class="lineNum">    1649 </span>            :                         ast_copy_string(retval-&gt;imapvmshareid, var-&gt;value, sizeof(retval-&gt;imapvmshareid));
<span class="lineNum">    1650 </span>            :                         retval-&gt;imapversion = imapversion;
<span class="lineNum">    1651 </span>            : #endif
<span class="lineNum">    1652 </span>            :                 } else
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :                         apply_option(retval, var-&gt;name, var-&gt;value);</span>
<span class="lineNum">    1654 </span>            :         }
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1656 </span>            : 
<span class="lineNum">    1657 </span>            : /*!
<span class="lineNum">    1658 </span>            :  * \brief Determines if a DTMF key entered is valid.
<span class="lineNum">    1659 </span>            :  * \param key The character to be compared. expects a single character. Though is capable of handling a string, this is internally copies using ast_strdupa.
<span class="lineNum">    1660 </span>            :  *
<span class="lineNum">    1661 </span>            :  * Tests the character entered against the set of valid DTMF characters.
<a name="1662"><span class="lineNum">    1662 </span>            :  * \return 1 if the character entered is a valid DTMF digit, 0 if the character is invalid.</a>
<span class="lineNum">    1663 </span>            :  */
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 : static int is_valid_dtmf(const char *key)</span>
<span class="lineNum">    1665 </span>            : {
<span class="lineNum">    1666 </span>            :         int i;
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :         char *local_key = ast_strdupa(key);</span>
<span class="lineNum">    1668 </span>            : 
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; strlen(key); ++i) {</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :                 if (!strchr(VALID_DTMF, *local_key)) {</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Invalid DTMF key \&quot;%c\&quot; used in voicemail configuration file\n&quot;, *local_key);</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">    1673 </span>            :                 }
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                 local_key++;</span>
<span class="lineNum">    1675 </span>            :         }
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    1677 </span>            : }
<span class="lineNum">    1678 </span>            : 
<span class="lineNum">    1679 </span>            : /*!
<span class="lineNum">    1680 </span>            :  * \brief Finds a voicemail user from the realtime engine.
<span class="lineNum">    1681 </span>            :  * \param ivm
<span class="lineNum">    1682 </span>            :  * \param context
<span class="lineNum">    1683 </span>            :  * \param mailbox
<span class="lineNum">    1684 </span>            :  *
<span class="lineNum">    1685 </span>            :  * This is called as a fall through case when the normal find_user() was not able to find a user. That is, the default it so look in the usual voicemail users file first.
<span class="lineNum">    1686 </span>            :  *
<a name="1687"><span class="lineNum">    1687 </span>            :  * \return The ast_vm_user structure for the user that was found.</a>
<span class="lineNum">    1688 </span>            :  */
<span class="lineNum">    1689 </span><span class="lineCov">         21 : static struct ast_vm_user *find_user_realtime(struct ast_vm_user *ivm, const char *context, const char *mailbox)</span>
<span class="lineNum">    1690 </span>            : {
<span class="lineNum">    1691 </span>            :         struct ast_variable *var;
<span class="lineNum">    1692 </span>            :         struct ast_vm_user *retval;
<span class="lineNum">    1693 </span>            : 
<span class="lineNum">    1694 </span><span class="lineCov">         21 :         if ((retval = (ivm ? ivm : ast_calloc(1, sizeof(*retval))))) {</span>
<span class="lineNum">    1695 </span><span class="lineCov">         21 :                 if (ivm) {</span>
<span class="lineNum">    1696 </span><span class="lineCov">         20 :                         memset(retval, 0, sizeof(*retval));</span>
<span class="lineNum">    1697 </span>            :                 }
<span class="lineNum">    1698 </span><span class="lineCov">         21 :                 populate_defaults(retval);</span>
<span class="lineNum">    1699 </span><span class="lineCov">         21 :                 if (!ivm) {</span>
<span class="lineNum">    1700 </span><span class="lineCov">          1 :                         ast_set_flag(retval, VM_ALLOCED);</span>
<span class="lineNum">    1701 </span>            :                 }
<span class="lineNum">    1702 </span><span class="lineCov">         21 :                 if (mailbox) {</span>
<span class="lineNum">    1703 </span><span class="lineCov">         21 :                         ast_copy_string(retval-&gt;mailbox, mailbox, sizeof(retval-&gt;mailbox));</span>
<span class="lineNum">    1704 </span>            :                 }
<span class="lineNum">    1705 </span><span class="lineCov">         21 :                 if (!context &amp;&amp; ast_test_flag((&amp;globalflags), VM_SEARCH)) {</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :                         var = ast_load_realtime(&quot;voicemail&quot;, &quot;mailbox&quot;, mailbox, SENTINEL);</span>
<span class="lineNum">    1707 </span>            :                 } else {
<span class="lineNum">    1708 </span><span class="lineCov">         21 :                         var = ast_load_realtime(&quot;voicemail&quot;, &quot;mailbox&quot;, mailbox, &quot;context&quot;, context, SENTINEL);</span>
<span class="lineNum">    1709 </span>            :                 }
<span class="lineNum">    1710 </span><span class="lineCov">         21 :                 if (var) {</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                         apply_options_full(retval, var);</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :                         ast_variables_destroy(var);</span>
<span class="lineNum">    1713 </span>            :                 } else {
<span class="lineNum">    1714 </span><span class="lineCov">         21 :                         if (!ivm)</span>
<span class="lineNum">    1715 </span><span class="lineCov">          1 :                                 ast_free(retval);</span>
<span class="lineNum">    1716 </span><span class="lineCov">         21 :                         retval = NULL;</span>
<span class="lineNum">    1717 </span>            :                 }
<span class="lineNum">    1718 </span>            :         }
<span class="lineNum">    1719 </span><span class="lineCov">         21 :         return retval;</span>
<span class="lineNum">    1720 </span>            : }
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span>            : /*!
<span class="lineNum">    1723 </span>            :  * \brief Finds a voicemail user from the users file or the realtime engine.
<span class="lineNum">    1724 </span>            :  * \param ivm
<span class="lineNum">    1725 </span>            :  * \param context
<span class="lineNum">    1726 </span>            :  * \param mailbox
<span class="lineNum">    1727 </span>            :  *
<a name="1728"><span class="lineNum">    1728 </span>            :  * \return The ast_vm_user structure for the user that was found.</a>
<span class="lineNum">    1729 </span>            :  */
<span class="lineNum">    1730 </span><span class="lineCov">        216 : static struct ast_vm_user *find_user(struct ast_vm_user *ivm, const char *context, const char *mailbox)</span>
<span class="lineNum">    1731 </span>            : {
<span class="lineNum">    1732 </span>            :         /* This function could be made to generate one from a database, too */
<span class="lineNum">    1733 </span><span class="lineCov">        216 :         struct ast_vm_user *vmu = NULL, *cur;</span>
<span class="lineNum">    1734 </span><span class="lineCov">        216 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">    1735 </span>            : 
<span class="lineNum">    1736 </span><span class="lineCov">        216 :         if (!context &amp;&amp; !ast_test_flag((&amp;globalflags), VM_SEARCH))</span>
<span class="lineNum">    1737 </span><span class="lineCov">         36 :                 context = &quot;default&quot;;</span>
<span class="lineNum">    1738 </span>            : 
<span class="lineNum">    1739 </span><span class="lineCov">        616 :         AST_LIST_TRAVERSE(&amp;users, cur, list) {</span>
<span class="lineNum">    1740 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    1741 </span>            :                 if (cur-&gt;imapversion != imapversion) {
<span class="lineNum">    1742 </span>            :                         continue;
<span class="lineNum">    1743 </span>            :                 }
<span class="lineNum">    1744 </span>            : #endif
<span class="lineNum">    1745 </span><span class="lineCov">        595 :                 if (ast_test_flag((&amp;globalflags), VM_SEARCH) &amp;&amp; !strcasecmp(mailbox, cur-&gt;mailbox))</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1747 </span><span class="lineCov">        595 :                 if (context &amp;&amp; (!strcasecmp(context, cur-&gt;context)) &amp;&amp; (!strcasecmp(mailbox, cur-&gt;mailbox)))</span>
<span class="lineNum">    1748 </span><span class="lineCov">        195 :                         break;</span>
<span class="lineNum">    1749 </span>            :         }
<span class="lineNum">    1750 </span><span class="lineCov">        216 :         if (cur) {</span>
<span class="lineNum">    1751 </span>            :                 /* Make a copy, so that on a reload, we have no race */
<span class="lineNum">    1752 </span><span class="lineCov">        195 :                 if ((vmu = (ivm ? ivm : ast_calloc(1, sizeof(*vmu))))) {</span>
<span class="lineNum">    1753 </span><span class="lineCov">        195 :                         ast_free(vmu-&gt;email);</span>
<span class="lineNum">    1754 </span><span class="lineCov">        195 :                         ast_free(vmu-&gt;emailbody);</span>
<span class="lineNum">    1755 </span><span class="lineCov">        195 :                         ast_free(vmu-&gt;emailsubject);</span>
<span class="lineNum">    1756 </span><span class="lineCov">        195 :                         *vmu = *cur;</span>
<span class="lineNum">    1757 </span><span class="lineCov">        195 :                         vmu-&gt;email = ast_strdup(cur-&gt;email);</span>
<span class="lineNum">    1758 </span><span class="lineCov">        195 :                         vmu-&gt;emailbody = ast_strdup(cur-&gt;emailbody);</span>
<span class="lineNum">    1759 </span><span class="lineCov">        195 :                         vmu-&gt;emailsubject = ast_strdup(cur-&gt;emailsubject);</span>
<span class="lineNum">    1760 </span><span class="lineCov">        195 :                         ast_set2_flag(vmu, !ivm, VM_ALLOCED);</span>
<span class="lineNum">    1761 </span><span class="lineCov">        195 :                         AST_LIST_NEXT(vmu, list) = NULL;</span>
<span class="lineNum">    1762 </span>            :                 }
<span class="lineNum">    1763 </span>            :         } else
<span class="lineNum">    1764 </span><span class="lineCov">         21 :                 vmu = find_user_realtime(ivm, context, mailbox);</span>
<span class="lineNum">    1765 </span><span class="lineCov">        216 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">    1766 </span><span class="lineCov">        216 :         return vmu;</span>
<span class="lineNum">    1767 </span>            : }
<span class="lineNum">    1768 </span>            : 
<span class="lineNum">    1769 </span>            : /*!
<span class="lineNum">    1770 </span>            :  * \brief Resets a user password to a specified password.
<span class="lineNum">    1771 </span>            :  * \param context
<span class="lineNum">    1772 </span>            :  * \param mailbox
<span class="lineNum">    1773 </span>            :  * \param newpass
<span class="lineNum">    1774 </span>            :  *
<span class="lineNum">    1775 </span>            :  * This does the actual change password work, called by the vm_change_password() function.
<span class="lineNum">    1776 </span>            :  *
<a name="1777"><span class="lineNum">    1777 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    1778 </span>            :  */
<span class="lineNum">    1779 </span><span class="lineCov">          4 : static int reset_user_pw(const char *context, const char *mailbox, const char *newpass)</span>
<span class="lineNum">    1780 </span>            : {
<span class="lineNum">    1781 </span>            :         /* This function could be made to generate one from a database, too */
<span class="lineNum">    1782 </span>            :         struct ast_vm_user *cur;
<span class="lineNum">    1783 </span><span class="lineCov">          4 :         int res = -1;</span>
<span class="lineNum">    1784 </span><span class="lineCov">          4 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">    1785 </span><span class="lineCov">          4 :         AST_LIST_TRAVERSE(&amp;users, cur, list) {</span>
<span class="lineNum">    1786 </span><span class="lineCov">          4 :                 if ((!context || !strcasecmp(context, cur-&gt;context)) &amp;&amp;</span>
<span class="lineNum">    1787 </span><span class="lineCov">          4 :                         (!strcasecmp(mailbox, cur-&gt;mailbox)))</span>
<span class="lineNum">    1788 </span><span class="lineCov">          4 :                                 break;</span>
<span class="lineNum">    1789 </span>            :         }
<span class="lineNum">    1790 </span><span class="lineCov">          4 :         if (cur) {</span>
<span class="lineNum">    1791 </span><span class="lineCov">          4 :                 ast_copy_string(cur-&gt;password, newpass, sizeof(cur-&gt;password));</span>
<span class="lineNum">    1792 </span><span class="lineCov">          4 :                 res = 0;</span>
<span class="lineNum">    1793 </span>            :         }
<span class="lineNum">    1794 </span><span class="lineCov">          4 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">    1795 </span><span class="lineCov">          4 :         return res;</span>
<span class="lineNum">    1796 </span>            : }
<span class="lineNum">    1797 </span>            : 
<span class="lineNum">    1798 </span>            : /*!
<a name="1799"><span class="lineNum">    1799 </span>            :  * \brief Check if configuration file is valid</a>
<span class="lineNum">    1800 </span>            :  */
<span class="lineNum">    1801 </span><span class="lineCov">         38 : static inline int valid_config(const struct ast_config *cfg)</span>
<span class="lineNum">    1802 </span>            : {
<span class="lineNum">    1803 </span><span class="lineCov">         38 :         return cfg &amp;&amp; cfg != CONFIG_STATUS_FILEINVALID;</span>
<span class="lineNum">    1804 </span>            : }
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span>            : /*!
<span class="lineNum">    1807 </span>            :  * \brief The handler for the change password option.
<span class="lineNum">    1808 </span>            :  * \param vmu The voicemail user to work with.
<span class="lineNum">    1809 </span>            :  * \param newpassword The new password (that has been gathered from the appropriate prompting).
<span class="lineNum">    1810 </span>            :  * This is called when a new user logs in for the first time and the option to force them to change their password is set.
<a name="1811"><span class="lineNum">    1811 </span>            :  * It is also called when the user wants to change their password from menu option '5' on the mailbox options menu.</a>
<span class="lineNum">    1812 </span>            :  */
<span class="lineNum">    1813 </span><span class="lineCov">          3 : static void vm_change_password(struct ast_vm_user *vmu, const char *newpassword)</span>
<span class="lineNum">    1814 </span>            : {
<span class="lineNum">    1815 </span><span class="lineCov">          3 :         struct ast_config   *cfg = NULL;</span>
<span class="lineNum">    1816 </span><span class="lineCov">          3 :         struct ast_variable *var = NULL;</span>
<span class="lineNum">    1817 </span><span class="lineCov">          3 :         struct ast_category *cat = NULL;</span>
<span class="lineNum">    1818 </span><span class="lineCov">          3 :         char *category = NULL, *value = NULL, *new = NULL;</span>
<span class="lineNum">    1819 </span><span class="lineCov">          3 :         const char *tmp = NULL;</span>
<span class="lineNum">    1820 </span><span class="lineCov">          3 :         struct ast_flags config_flags = { CONFIG_FLAG_WITHCOMMENTS };</span>
<span class="lineNum">    1821 </span><span class="lineCov">          3 :         char secretfn[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">    1822 </span><span class="lineCov">          3 :         int found = 0;</span>
<span class="lineNum">    1823 </span>            : 
<span class="lineNum">    1824 </span><span class="lineCov">          3 :         if (!change_password_realtime(vmu, newpassword))</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span>            :         /* check if we should store the secret in the spool directory next to the messages */
<span class="lineNum">    1828 </span><span class="lineCov">          3 :         switch (vmu-&gt;passwordlocation) {</span>
<span class="lineNum">    1829 </span><span class="lineCov">          1 :         case OPT_PWLOC_SPOOLDIR:</span>
<span class="lineNum">    1830 </span><span class="lineCov">          1 :                 snprintf(secretfn, sizeof(secretfn), &quot;%s%s/%s/secret.conf&quot;, VM_SPOOL_DIR, vmu-&gt;context, vmu-&gt;mailbox);</span>
<span class="lineNum">    1831 </span><span class="lineCov">          1 :                 if (write_password_to_file(secretfn, newpassword) == 0) {</span>
<span class="lineNum">    1832 </span><span class="lineCov">          1 :                         ast_test_suite_event_notify(&quot;PASSWORDCHANGED&quot;, &quot;Message: secret.conf updated with new password\r\nPasswordSource: secret.conf&quot;);</span>
<span class="lineNum">    1833 </span><span class="lineCov">          1 :                         ast_verb(4, &quot;Writing voicemail password to file %s succeeded\n&quot;, secretfn);</span>
<span class="lineNum">    1834 </span><span class="lineCov">          1 :                         reset_user_pw(vmu-&gt;context, vmu-&gt;mailbox, newpassword);</span>
<span class="lineNum">    1835 </span><span class="lineCov">          1 :                         ast_copy_string(vmu-&gt;password, newpassword, sizeof(vmu-&gt;password));</span>
<span class="lineNum">    1836 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    1837 </span>            :                 } else {
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :                         ast_verb(4, &quot;Writing voicemail password to file %s failed, falling back to config file\n&quot;, secretfn);</span>
<span class="lineNum">    1839 </span>            :                 }
<span class="lineNum">    1840 </span>            :                 /* Fall-through */
<span class="lineNum">    1841 </span>            :         case OPT_PWLOC_VOICEMAILCONF:
<span class="lineNum">    1842 </span><span class="lineCov">          2 :                 if ((cfg = ast_config_load(VOICEMAIL_CONFIG, config_flags)) &amp;&amp; valid_config(cfg)) {</span>
<span class="lineNum">    1843 </span><span class="lineCov">          8 :                         while ((category = ast_category_browse(cfg, category))) {</span>
<span class="lineNum">    1844 </span><span class="lineCov">          6 :                                 if (!strcasecmp(category, vmu-&gt;context)) {</span>
<span class="lineNum">    1845 </span><span class="lineCov">          2 :                                         if (!(tmp = ast_variable_retrieve(cfg, category, vmu-&gt;mailbox))) {</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :                                                 ast_log(AST_LOG_WARNING, &quot;We could not find the mailbox.\n&quot;);</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :                                                 break;</span>
<span class="lineNum">    1848 </span>            :                                         }
<span class="lineNum">    1849 </span><span class="lineCov">          2 :                                         value = strstr(tmp, &quot;,&quot;);</span>
<span class="lineNum">    1850 </span><span class="lineCov">          2 :                                         if (!value) {</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :                                                 new = ast_alloca(strlen(newpassword)+1);</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :                                                 sprintf(new, &quot;%s&quot;, newpassword);</span>
<span class="lineNum">    1853 </span>            :                                         } else {
<span class="lineNum">    1854 </span><span class="lineCov">          2 :                                                 new = ast_alloca((strlen(value) + strlen(newpassword) + 1));</span>
<span class="lineNum">    1855 </span><span class="lineCov">          2 :                                                 sprintf(new, &quot;%s%s&quot;, newpassword, value);</span>
<span class="lineNum">    1856 </span>            :                                         }
<span class="lineNum">    1857 </span><span class="lineCov">          2 :                                         if (!(cat = ast_category_get(cfg, category, NULL))) {</span>
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :                                                 ast_log(AST_LOG_WARNING, &quot;Failed to get category structure.\n&quot;);</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :                                                 break;</span>
<span class="lineNum">    1860 </span>            :                                         }
<span class="lineNum">    1861 </span><span class="lineCov">          2 :                                         ast_variable_update(cat, vmu-&gt;mailbox, new, NULL, 0);</span>
<span class="lineNum">    1862 </span><span class="lineCov">          2 :                                         found = 1;</span>
<span class="lineNum">    1863 </span>            :                                 }
<span class="lineNum">    1864 </span>            :                         }
<span class="lineNum">    1865 </span>            :                         /* save the results */
<span class="lineNum">    1866 </span><span class="lineCov">          2 :                         if (found) {</span>
<span class="lineNum">    1867 </span><span class="lineCov">          2 :                                 ast_test_suite_event_notify(&quot;PASSWORDCHANGED&quot;, &quot;Message: voicemail.conf updated with new password\r\nPasswordSource: voicemail.conf&quot;);</span>
<span class="lineNum">    1868 </span><span class="lineCov">          2 :                                 reset_user_pw(vmu-&gt;context, vmu-&gt;mailbox, newpassword);</span>
<span class="lineNum">    1869 </span><span class="lineCov">          2 :                                 ast_copy_string(vmu-&gt;password, newpassword, sizeof(vmu-&gt;password));</span>
<span class="lineNum">    1870 </span><span class="lineCov">          2 :                                 ast_config_text_file_save(VOICEMAIL_CONFIG, cfg, &quot;app_voicemail&quot;);</span>
<span class="lineNum">    1871 </span><span class="lineCov">          2 :                                 ast_config_destroy(cfg);</span>
<span class="lineNum">    1872 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">    1873 </span>            :                         }
<span class="lineNum">    1874 </span>            : 
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :                         ast_config_destroy(cfg);</span>
<span class="lineNum">    1876 </span>            :                 }
<span class="lineNum">    1877 </span>            :                 /* Fall-through */
<span class="lineNum">    1878 </span>            :         case OPT_PWLOC_USERSCONF:
<span class="lineNum">    1879 </span>            :                 /* check users.conf and update the password stored for the mailbox */
<span class="lineNum">    1880 </span>            :                 /* if no vmsecret entry exists create one. */
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :                 if ((cfg = ast_config_load(&quot;users.conf&quot;, config_flags)) &amp;&amp; valid_config(cfg)) {</span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :                         ast_debug(4, &quot;we are looking for %s\n&quot;, vmu-&gt;mailbox);</span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :                         for (category = ast_category_browse(cfg, NULL); category; category = ast_category_browse(cfg, category)) {</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :                                 ast_debug(4, &quot;users.conf: %s\n&quot;, category);</span>
<span class="lineNum">    1885 </span><span class="lineNoCov">          0 :                                 if (!strcasecmp(category, vmu-&gt;mailbox)) {</span>
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :                                         if (!ast_variable_retrieve(cfg, category, &quot;vmsecret&quot;)) {</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :                                                 ast_debug(3, &quot;looks like we need to make vmsecret!\n&quot;);</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :                                                 var = ast_variable_new(&quot;vmsecret&quot;, newpassword, &quot;&quot;);</span>
<span class="lineNum">    1889 </span>            :                                         } else {
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :                                                 var = NULL;</span>
<span class="lineNum">    1891 </span>            :                                         }
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :                                         new = ast_alloca(strlen(newpassword) + 1);</span>
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :                                         sprintf(new, &quot;%s&quot;, newpassword);</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :                                         if (!(cat = ast_category_get(cfg, category, NULL))) {</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :                                                 ast_debug(4, &quot;failed to get category!\n&quot;);</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :                                                 ast_free(var);</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :                                                 break;</span>
<span class="lineNum">    1898 </span>            :                                         }
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :                                         if (!var) {</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :                                                 ast_variable_update(cat, &quot;vmsecret&quot;, new, NULL, 0);</span>
<span class="lineNum">    1901 </span>            :                                         } else {
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :                                                 ast_variable_append(cat, var);</span>
<span class="lineNum">    1903 </span>            :                                         }
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :                                         found = 1;</span>
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1906 </span>            :                                 }
<span class="lineNum">    1907 </span>            :                         }
<span class="lineNum">    1908 </span>            :                         /* save the results and clean things up */
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :                         if (found) {</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :                                 ast_test_suite_event_notify(&quot;PASSWORDCHANGED&quot;, &quot;Message: users.conf updated with new password\r\nPasswordSource: users.conf&quot;);</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :                                 reset_user_pw(vmu-&gt;context, vmu-&gt;mailbox, newpassword);</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :                                 ast_copy_string(vmu-&gt;password, newpassword, sizeof(vmu-&gt;password));</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :                                 ast_config_text_file_save(&quot;users.conf&quot;, cfg, &quot;app_voicemail&quot;);</span>
<span class="lineNum">    1914 </span>            :                         }
<span class="lineNum">    1915 </span>            : 
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :                         ast_config_destroy(cfg);</span>
<span class="lineNum">    1917 </span>            :                 }
<span class="lineNum">    1918 </span>            :         }
<a name="1919"><span class="lineNum">    1919 </span>            : }</a>
<span class="lineNum">    1920 </span>            : 
<span class="lineNum">    1921 </span><span class="lineCov">          1 : static void vm_change_password_shell(struct ast_vm_user *vmu, char *newpassword)</span>
<span class="lineNum">    1922 </span>            : {
<span class="lineNum">    1923 </span>            :         char buf[255];
<span class="lineNum">    1924 </span><span class="lineCov">          1 :         snprintf(buf, sizeof(buf), &quot;%s %s %s %s&quot;, ext_pass_cmd, vmu-&gt;context, vmu-&gt;mailbox, newpassword);</span>
<span class="lineNum">    1925 </span><span class="lineCov">          1 :         ast_debug(1, &quot;External password: %s\n&quot;,buf);</span>
<span class="lineNum">    1926 </span><span class="lineCov">          1 :         if (!ast_safe_system(buf)) {</span>
<span class="lineNum">    1927 </span><span class="lineCov">          1 :                 ast_test_suite_event_notify(&quot;PASSWORDCHANGED&quot;, &quot;Message: external script updated with new password\r\nPasswordSource: external&quot;);</span>
<span class="lineNum">    1928 </span><span class="lineCov">          1 :                 ast_copy_string(vmu-&gt;password, newpassword, sizeof(vmu-&gt;password));</span>
<span class="lineNum">    1929 </span>            :                 /* Reset the password in memory, too */
<span class="lineNum">    1930 </span><span class="lineCov">          1 :                 reset_user_pw(vmu-&gt;context, vmu-&gt;mailbox, newpassword);</span>
<span class="lineNum">    1931 </span>            :         }
<span class="lineNum">    1932 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1933 </span>            : 
<span class="lineNum">    1934 </span>            : /*!
<span class="lineNum">    1935 </span>            :  * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.
<span class="lineNum">    1936 </span>            :  * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.
<span class="lineNum">    1937 </span>            :  * \param len The length of the path string that was written out.
<span class="lineNum">    1938 </span>            :  * \param context
<span class="lineNum">    1939 </span>            :  * \param ext
<span class="lineNum">    1940 </span>            :  * \param folder
<span class="lineNum">    1941 </span>            :  *
<span class="lineNum">    1942 </span>            :  * The path is constructed as
<span class="lineNum">    1943 </span>            :  *      VM_SPOOL_DIRcontext/ext/folder
<span class="lineNum">    1944 </span>            :  *
<a name="1945"><span class="lineNum">    1945 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    1946 </span>            :  */
<span class="lineNum">    1947 </span><span class="lineCov">        836 : static int make_dir(char *dest, int len, const char *context, const char *ext, const char *folder)</span>
<span class="lineNum">    1948 </span>            : {
<span class="lineNum">    1949 </span><span class="lineCov">        836 :         return snprintf(dest, len, &quot;%s%s/%s/%s&quot;, VM_SPOOL_DIR, context, ext, folder);</span>
<span class="lineNum">    1950 </span>            : }
<span class="lineNum">    1951 </span>            : 
<span class="lineNum">    1952 </span>            : /*!
<span class="lineNum">    1953 </span>            :  * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.
<span class="lineNum">    1954 </span>            :  * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.
<span class="lineNum">    1955 </span>            :  * \param len The length of the path string that was written out.
<span class="lineNum">    1956 </span>            :  * \param dir
<span class="lineNum">    1957 </span>            :  * \param num
<span class="lineNum">    1958 </span>            :  *
<span class="lineNum">    1959 </span>            :  * The path is constructed as
<span class="lineNum">    1960 </span>            :  *      VM_SPOOL_DIRcontext/ext/folder
<span class="lineNum">    1961 </span>            :  *
<a name="1962"><span class="lineNum">    1962 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    1963 </span>            :  */
<span class="lineNum">    1964 </span><span class="lineCov">        531 : static int make_file(char *dest, const int len, const char *dir, const int num)</span>
<span class="lineNum">    1965 </span>            : {
<span class="lineNum">    1966 </span><span class="lineCov">        531 :         return snprintf(dest, len, &quot;%s/msg%04d&quot;, dir, num);</span>
<span class="lineNum">    1967 </span>            : }
<a name="1968"><span class="lineNum">    1968 </span>            : </a>
<span class="lineNum">    1969 </span>            : /* same as mkstemp, but return a FILE * */
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 : static FILE *vm_mkftemp(char *template)</span>
<span class="lineNum">    1971 </span>            : {
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :         FILE *p = NULL;</span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :         int pfd = mkstemp(template);</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :         chmod(template, VOICEMAIL_FILE_MODE &amp; ~my_umask);</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :         if (pfd &gt; -1) {</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :                 p = fdopen(pfd, &quot;w+&quot;);</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :                 if (!p) {</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :                         close(pfd);</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :                         pfd = -1;</span>
<span class="lineNum">    1980 </span>            :                 }
<span class="lineNum">    1981 </span>            :         }
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :         return p;</span>
<span class="lineNum">    1983 </span>            : }
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span>            : /*! \brief basically mkdir -p $dest/$context/$ext/$folder
<span class="lineNum">    1986 </span>            :  * \param dest    String. base directory.
<span class="lineNum">    1987 </span>            :  * \param len     Length of dest.
<span class="lineNum">    1988 </span>            :  * \param context String. Ignored if is null or empty string.
<span class="lineNum">    1989 </span>            :  * \param ext     String. Ignored if is null or empty string.
<span class="lineNum">    1990 </span>            :  * \param folder  String. Ignored if is null or empty string.
<a name="1991"><span class="lineNum">    1991 </span>            :  * \return -1 on failure, 0 on success.</a>
<span class="lineNum">    1992 </span>            :  */
<span class="lineNum">    1993 </span><span class="lineCov">        793 : static int create_dirpath(char *dest, int len, const char *context, const char *ext, const char *folder)</span>
<span class="lineNum">    1994 </span>            : {
<span class="lineNum">    1995 </span><span class="lineCov">        793 :         mode_t  mode = VOICEMAIL_DIR_MODE;</span>
<span class="lineNum">    1996 </span>            :         int res;
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span><span class="lineCov">        793 :         make_dir(dest, len, context, ext, folder);</span>
<span class="lineNum">    1999 </span><span class="lineCov">        793 :         if ((res = ast_mkdir(dest, mode))) {</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;ast_mkdir '%s' failed: %s\n&quot;, dest, strerror(res));</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    2002 </span>            :         }
<span class="lineNum">    2003 </span><span class="lineCov">        793 :         return 0;</span>
<a name="2004"><span class="lineNum">    2004 </span>            : }</a>
<span class="lineNum">    2005 </span>            : 
<span class="lineNum">    2006 </span><span class="lineCov">        726 : static const char *mbox(struct ast_vm_user *vmu, int id)</span>
<span class="lineNum">    2007 </span>            : {
<span class="lineNum">    2008 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    2009 </span>            :         if (vmu &amp;&amp; id == 0) {
<span class="lineNum">    2010 </span>            :                 return vmu-&gt;imapfolder;
<span class="lineNum">    2011 </span>            :         }
<span class="lineNum">    2012 </span>            : #endif
<span class="lineNum">    2013 </span><span class="lineCov">        726 :         return (id &gt;= 0 &amp;&amp; id &lt; ARRAY_LEN(mailbox_folders)) ? mailbox_folders[id] : &quot;Unknown&quot;;</span>
<a name="2014"><span class="lineNum">    2014 </span>            : }</a>
<span class="lineNum">    2015 </span>            : 
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 : static const char *vm_index_to_foldername(int id)</span>
<span class="lineNum">    2017 </span>            : {
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :         return mbox(NULL, id);</span>
<span class="lineNum">    2019 </span>            : }
<a name="2020"><span class="lineNum">    2020 </span>            : </a>
<span class="lineNum">    2021 </span>            : 
<span class="lineNum">    2022 </span><span class="lineCov">        286 : static int get_folder_by_name(const char *name)</span>
<span class="lineNum">    2023 </span>            : {
<span class="lineNum">    2024 </span>            :         size_t i;
<span class="lineNum">    2025 </span>            : 
<span class="lineNum">    2026 </span><span class="lineCov">       1272 :         for (i = 0; i &lt; ARRAY_LEN(mailbox_folders); i++) {</span>
<span class="lineNum">    2027 </span><span class="lineCov">       1266 :                 if (strcasecmp(name, mailbox_folders[i]) == 0) {</span>
<span class="lineNum">    2028 </span><span class="lineCov">        280 :                         return i;</span>
<span class="lineNum">    2029 </span>            :                 }
<span class="lineNum">    2030 </span>            :         }
<span class="lineNum">    2031 </span>            : 
<span class="lineNum">    2032 </span><span class="lineCov">          6 :         return -1;</span>
<a name="2033"><span class="lineNum">    2033 </span>            : }</a>
<span class="lineNum">    2034 </span>            : 
<span class="lineNum">    2035 </span><span class="lineCov">       2318 : static void free_user(struct ast_vm_user *vmu)</span>
<span class="lineNum">    2036 </span>            : {
<span class="lineNum">    2037 </span><span class="lineCov">       2318 :         if (!vmu) {</span>
<span class="lineNum">    2038 </span><span class="lineCov">          4 :                 return;</span>
<span class="lineNum">    2039 </span>            :         }
<span class="lineNum">    2040 </span>            : 
<span class="lineNum">    2041 </span><span class="lineCov">       2314 :         ast_free(vmu-&gt;email);</span>
<span class="lineNum">    2042 </span><span class="lineCov">       2314 :         vmu-&gt;email = NULL;</span>
<span class="lineNum">    2043 </span><span class="lineCov">       2314 :         ast_free(vmu-&gt;emailbody);</span>
<span class="lineNum">    2044 </span><span class="lineCov">       2314 :         vmu-&gt;emailbody = NULL;</span>
<span class="lineNum">    2045 </span><span class="lineCov">       2314 :         ast_free(vmu-&gt;emailsubject);</span>
<span class="lineNum">    2046 </span><span class="lineCov">       2314 :         vmu-&gt;emailsubject = NULL;</span>
<span class="lineNum">    2047 </span>            : 
<span class="lineNum">    2048 </span><span class="lineCov">       2314 :         if (ast_test_flag(vmu, VM_ALLOCED)) {</span>
<span class="lineNum">    2049 </span><span class="lineCov">       2139 :                 ast_free(vmu);</span>
<span class="lineNum">    2050 </span>            :         }
<a name="2051"><span class="lineNum">    2051 </span>            : }</a>
<span class="lineNum">    2052 </span>            : 
<span class="lineNum">    2053 </span><span class="lineCov">        683 : static int vm_allocate_dh(struct vm_state *vms, struct ast_vm_user *vmu, int count_msg) {</span>
<span class="lineNum">    2054 </span>            : 
<span class="lineNum">    2055 </span><span class="lineCov">        683 :         int arraysize = (vmu-&gt;maxmsg &gt; count_msg ? vmu-&gt;maxmsg : count_msg);</span>
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span>            :         /* remove old allocation */
<span class="lineNum">    2058 </span><span class="lineCov">        683 :         if (vms-&gt;deleted) {</span>
<span class="lineNum">    2059 </span><span class="lineCov">         56 :                 ast_free(vms-&gt;deleted);</span>
<span class="lineNum">    2060 </span><span class="lineCov">         56 :                 vms-&gt;deleted = NULL;</span>
<span class="lineNum">    2061 </span>            :         }
<span class="lineNum">    2062 </span><span class="lineCov">        683 :         if (vms-&gt;heard) {</span>
<span class="lineNum">    2063 </span><span class="lineCov">         56 :                 ast_free(vms-&gt;heard);</span>
<span class="lineNum">    2064 </span><span class="lineCov">         56 :                 vms-&gt;heard = NULL;</span>
<span class="lineNum">    2065 </span>            :         }
<span class="lineNum">    2066 </span><span class="lineCov">        683 :         vms-&gt;dh_arraysize = 0;</span>
<span class="lineNum">    2067 </span>            : 
<span class="lineNum">    2068 </span><span class="lineCov">        683 :         if (arraysize &gt; 0) {</span>
<span class="lineNum">    2069 </span><span class="lineCov">        683 :                 if (!(vms-&gt;deleted = ast_calloc(arraysize, sizeof(int)))) {</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    2071 </span>            :                 }
<span class="lineNum">    2072 </span><span class="lineCov">        683 :                 if (!(vms-&gt;heard = ast_calloc(arraysize, sizeof(int)))) {</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :                         ast_free(vms-&gt;deleted);</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                         vms-&gt;deleted = NULL;</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    2076 </span>            :                 }
<span class="lineNum">    2077 </span><span class="lineCov">        683 :                 vms-&gt;dh_arraysize = arraysize;</span>
<span class="lineNum">    2078 </span>            :         }
<span class="lineNum">    2079 </span>            : 
<span class="lineNum">    2080 </span><span class="lineCov">        683 :         return 0;</span>
<span class="lineNum">    2081 </span>            : }
<span class="lineNum">    2082 </span>            : 
<span class="lineNum">    2083 </span>            : /* All IMAP-specific functions should go in this block. This
<span class="lineNum">    2084 </span>            :  * keeps them from being spread out all over the code */
<span class="lineNum">    2085 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    2086 </span>            : static void vm_imap_delete(char *file, int msgnum, struct ast_vm_user *vmu)
<span class="lineNum">    2087 </span>            : {
<span class="lineNum">    2088 </span>            :         char arg[10];
<span class="lineNum">    2089 </span>            :         struct vm_state *vms;
<span class="lineNum">    2090 </span>            :         unsigned long messageNum;
<span class="lineNum">    2091 </span>            : 
<span class="lineNum">    2092 </span>            :         /* If greetings aren't stored in IMAP, just delete the file */
<span class="lineNum">    2093 </span>            :         if (msgnum &lt; 0 &amp;&amp; !imapgreetings) {
<span class="lineNum">    2094 </span>            :                 ast_filedelete(file, NULL);
<span class="lineNum">    2095 </span>            :                 return;
<span class="lineNum">    2096 </span>            :         }
<span class="lineNum">    2097 </span>            : 
<span class="lineNum">    2098 </span>            :         if (!(vms = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 0))) {
<span class="lineNum">    2099 </span>            :                 ast_log(LOG_WARNING, &quot;Couldn't find a vm_state for mailbox %s. Unable to set \\DELETED flag for message %d\n&quot;, vmu-&gt;mailbox, msgnum);
<span class="lineNum">    2100 </span>            :                 return;
<span class="lineNum">    2101 </span>            :         }
<span class="lineNum">    2102 </span>            : 
<span class="lineNum">    2103 </span>            :         if (msgnum &lt; 0) {
<span class="lineNum">    2104 </span>            :                 imap_delete_old_greeting(file, vms);
<span class="lineNum">    2105 </span>            :                 return;
<span class="lineNum">    2106 </span>            :         }
<span class="lineNum">    2107 </span>            : 
<span class="lineNum">    2108 </span>            :         /* find real message number based on msgnum */
<span class="lineNum">    2109 </span>            :         /* this may be an index into vms-&gt;msgArray based on the msgnum. */
<span class="lineNum">    2110 </span>            :         messageNum = vms-&gt;msgArray[msgnum];
<span class="lineNum">    2111 </span>            :         if (messageNum == 0) {
<span class="lineNum">    2112 </span>            :                 ast_log(LOG_WARNING, &quot;msgnum %d, mailbox message %lu is zero.\n&quot;, msgnum, messageNum);
<span class="lineNum">    2113 </span>            :                 return;
<span class="lineNum">    2114 </span>            :         }
<span class="lineNum">    2115 </span>            :         ast_debug(3, &quot;deleting msgnum %d, which is mailbox message %lu\n&quot;, msgnum, messageNum);
<span class="lineNum">    2116 </span>            :         /* delete message */
<span class="lineNum">    2117 </span>            :         snprintf (arg, sizeof(arg), &quot;%lu&quot;, messageNum);
<span class="lineNum">    2118 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    2119 </span>            :         mail_setflag (vms-&gt;mailstream, arg, &quot;\\DELETED&quot;);
<span class="lineNum">    2120 </span>            :         mail_expunge(vms-&gt;mailstream);
<span class="lineNum">    2121 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    2122 </span>            : }
<span class="lineNum">    2123 </span>            : 
<span class="lineNum">    2124 </span>            : static void vm_imap_update_msg_id(char *dir, int msgnum, const char *msg_id, struct ast_vm_user *vmu, struct ast_config *msg_cfg, int folder)
<span class="lineNum">    2125 </span>            : {
<span class="lineNum">    2126 </span>            :         struct ast_channel *chan;
<span class="lineNum">    2127 </span>            :         char *cid;
<span class="lineNum">    2128 </span>            :         char *cid_name;
<span class="lineNum">    2129 </span>            :         char *cid_num;
<span class="lineNum">    2130 </span>            :         struct vm_state *vms;
<span class="lineNum">    2131 </span>            :         const char *duration_str;
<span class="lineNum">    2132 </span>            :         int duration = 0;
<span class="lineNum">    2133 </span>            : 
<span class="lineNum">    2134 </span>            :         /*
<span class="lineNum">    2135 </span>            :          * First, get things initially set up. If any of this fails, then
<span class="lineNum">    2136 </span>            :          * back out before doing anything substantial
<span class="lineNum">    2137 </span>            :          */
<span class="lineNum">    2138 </span>            :         vms = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 0);
<span class="lineNum">    2139 </span>            :         if (!vms) {
<span class="lineNum">    2140 </span>            :                 return;
<span class="lineNum">    2141 </span>            :         }
<span class="lineNum">    2142 </span>            : 
<span class="lineNum">    2143 </span>            :         if (open_mailbox(vms, vmu, folder)) {
<span class="lineNum">    2144 </span>            :                 return;
<span class="lineNum">    2145 </span>            :         }
<span class="lineNum">    2146 </span>            : 
<span class="lineNum">    2147 </span>            :         chan = ast_dummy_channel_alloc();
<span class="lineNum">    2148 </span>            :         if (!chan) {
<span class="lineNum">    2149 </span>            :                 close_mailbox(vms, vmu);
<span class="lineNum">    2150 </span>            :                 return;
<span class="lineNum">    2151 </span>            :         }
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :         /*
<span class="lineNum">    2154 </span>            :          * We need to make sure the new message we save has the same
<span class="lineNum">    2155 </span>            :          * callerid, flag, and duration as the original message
<span class="lineNum">    2156 </span>            :          */
<span class="lineNum">    2157 </span>            :         cid = ast_strdupa(ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;));
<span class="lineNum">    2158 </span>            : 
<span class="lineNum">    2159 </span>            :         if (!ast_strlen_zero(cid)) {
<span class="lineNum">    2160 </span>            :                 ast_callerid_parse(cid, &amp;cid_name, &amp;cid_num);
<span class="lineNum">    2161 </span>            :                 ast_party_caller_init(ast_channel_caller(chan));
<span class="lineNum">    2162 </span>            :                 if (!ast_strlen_zero(cid_name)) {
<span class="lineNum">    2163 </span>            :                         ast_channel_caller(chan)-&gt;id.name.valid = 1;
<span class="lineNum">    2164 </span>            :                         ast_channel_caller(chan)-&gt;id.name.str = ast_strdup(cid_name);
<span class="lineNum">    2165 </span>            :                 }
<span class="lineNum">    2166 </span>            :                 if (!ast_strlen_zero(cid_num)) {
<span class="lineNum">    2167 </span>            :                         ast_channel_caller(chan)-&gt;id.number.valid = 1;
<span class="lineNum">    2168 </span>            :                         ast_channel_caller(chan)-&gt;id.number.str = ast_strdup(cid_num);
<span class="lineNum">    2169 </span>            :                 }
<span class="lineNum">    2170 </span>            :         }
<span class="lineNum">    2171 </span>            : 
<span class="lineNum">    2172 </span>            :         duration_str = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;);
<span class="lineNum">    2173 </span>            : 
<span class="lineNum">    2174 </span>            :         if (!ast_strlen_zero(duration_str)) {
<span class="lineNum">    2175 </span>            :                 sscanf(duration_str, &quot;%30d&quot;, &amp;duration);
<span class="lineNum">    2176 </span>            :         }
<span class="lineNum">    2177 </span>            : 
<span class="lineNum">    2178 </span>            :         /*
<span class="lineNum">    2179 </span>            :          * IMAP messages cannot be altered once delivered. So we have to delete the
<span class="lineNum">    2180 </span>            :          * current message and then re-add it with the updated message ID.
<span class="lineNum">    2181 </span>            :          *
<span class="lineNum">    2182 </span>            :          * Furthermore, there currently is no atomic way to create a new message and to
<span class="lineNum">    2183 </span>            :          * store it in an arbitrary folder. So we have to save it to the INBOX and then
<span class="lineNum">    2184 </span>            :          * move to the appropriate folder.
<span class="lineNum">    2185 </span>            :          */
<span class="lineNum">    2186 </span>            :         if (!imap_store_file(dir, vmu-&gt;mailbox, vmu-&gt;context, msgnum, chan, vmu, vmfmts,
<span class="lineNum">    2187 </span>            :                         duration, vms, ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;flag&quot;), msg_id)) {
<span class="lineNum">    2188 </span>            :                 if (folder != NEW_FOLDER) {
<span class="lineNum">    2189 </span>            :                         save_to_folder(vmu, vms, msgnum, folder, NULL, 1);
<span class="lineNum">    2190 </span>            :                 }
<span class="lineNum">    2191 </span>            :                 vm_imap_delete(dir, msgnum, vmu);
<span class="lineNum">    2192 </span>            :         }
<span class="lineNum">    2193 </span>            :         close_mailbox(vms, vmu);
<span class="lineNum">    2194 </span>            :         ast_channel_unref(chan);
<span class="lineNum">    2195 </span>            : }
<span class="lineNum">    2196 </span>            : 
<span class="lineNum">    2197 </span>            : static int imap_retrieve_greeting(const char *dir, const int msgnum, struct ast_vm_user *vmu)
<span class="lineNum">    2198 </span>            : {
<span class="lineNum">    2199 </span>            :         struct vm_state *vms_p;
<span class="lineNum">    2200 </span>            :         char *file, *filename;
<span class="lineNum">    2201 </span>            :         char dest[PATH_MAX];
<span class="lineNum">    2202 </span>            :         char *attachment;
<span class="lineNum">    2203 </span>            :         int i;
<span class="lineNum">    2204 </span>            :         BODY *body;
<span class="lineNum">    2205 </span>            :         int ret = 0;
<span class="lineNum">    2206 </span>            :         int curr_mbox;
<span class="lineNum">    2207 </span>            : 
<span class="lineNum">    2208 </span>            :         /* This function is only used for retrieval of IMAP greetings
<span class="lineNum">    2209 </span>            :          * regular messages are not retrieved this way, nor are greetings
<span class="lineNum">    2210 </span>            :          * if they are stored locally*/
<span class="lineNum">    2211 </span>            :         if (msgnum &gt; -1 || !imapgreetings) {
<span class="lineNum">    2212 </span>            :                 return 0;
<span class="lineNum">    2213 </span>            :         } else {
<span class="lineNum">    2214 </span>            :                 file = strrchr(ast_strdupa(dir), '/');
<span class="lineNum">    2215 </span>            :                 if (file)
<span class="lineNum">    2216 </span>            :                         *file++ = '\0';
<span class="lineNum">    2217 </span>            :                 else {
<span class="lineNum">    2218 </span>            :                         ast_debug(1, &quot;Failed to procure file name from directory passed.\n&quot;);
<span class="lineNum">    2219 </span>            :                         return -1;
<span class="lineNum">    2220 </span>            :                 }
<span class="lineNum">    2221 </span>            :         }
<span class="lineNum">    2222 </span>            : 
<span class="lineNum">    2223 </span>            :         /* check if someone is accessing this box right now... */
<span class="lineNum">    2224 </span>            :         if (!(vms_p = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 1)) &amp;&amp;
<span class="lineNum">    2225 </span>            :                 !(vms_p = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 0))) {
<span class="lineNum">    2226 </span>            :                 /* Unlike when retrieving a message, it is reasonable not to be able to find a
<span class="lineNum">    2227 </span>            :                 * vm_state for a mailbox when trying to retrieve a greeting. Just create one,
<span class="lineNum">    2228 </span>            :                 * that's all we need to do.
<span class="lineNum">    2229 </span>            :                 */
<span class="lineNum">    2230 </span>            :                 if (!(vms_p = create_vm_state_from_user(vmu))) {
<span class="lineNum">    2231 </span>            :                         ast_log(LOG_NOTICE, &quot;Unable to create vm_state object!\n&quot;);
<span class="lineNum">    2232 </span>            :                         return -1;
<span class="lineNum">    2233 </span>            :                 }
<span class="lineNum">    2234 </span>            :         }
<span class="lineNum">    2235 </span>            : 
<span class="lineNum">    2236 </span>            :         /* Greetings will never have a prepended message */
<span class="lineNum">    2237 </span>            :         *vms_p-&gt;introfn = '\0';
<span class="lineNum">    2238 </span>            : 
<span class="lineNum">    2239 </span>            :         ast_mutex_lock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2240 </span>            : 
<span class="lineNum">    2241 </span>            :         /* get the current mailbox so that we can point the mailstream back to it later */
<span class="lineNum">    2242 </span>            :         curr_mbox = get_folder_by_name(vms_p-&gt;curbox);
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span>            :         if (init_mailstream(vms_p, GREETINGS_FOLDER) || !vms_p-&gt;mailstream) {
<span class="lineNum">    2245 </span>            :                 ast_log(AST_LOG_ERROR, &quot;IMAP mailstream is NULL or can't init_mailstream\n&quot;);
<span class="lineNum">    2246 </span>            :                 ast_mutex_unlock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2247 </span>            :                 return -1;
<span class="lineNum">    2248 </span>            :         }
<span class="lineNum">    2249 </span>            : 
<span class="lineNum">    2250 </span>            :         /*XXX Yuck, this could probably be done a lot better */
<span class="lineNum">    2251 </span>            :         for (i = 0; i &lt; vms_p-&gt;mailstream-&gt;nmsgs; i++) {
<span class="lineNum">    2252 </span>            :                 mail_fetchstructure(vms_p-&gt;mailstream, i + 1, &amp;body);
<span class="lineNum">    2253 </span>            :                 /* We have the body, now we extract the file name of the first attachment. */
<span class="lineNum">    2254 </span>            :                 if (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<span class="lineNum">    2255 </span>            :                         attachment = ast_strdupa(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<span class="lineNum">    2256 </span>            :                 } else {
<span class="lineNum">    2257 </span>            :                         ast_log(AST_LOG_ERROR, &quot;There is no file attached to this IMAP message.\n&quot;);
<span class="lineNum">    2258 </span>            :                         ret = -1;
<span class="lineNum">    2259 </span>            :                         break;
<span class="lineNum">    2260 </span>            :                 }
<span class="lineNum">    2261 </span>            :                 filename = strsep(&amp;attachment, &quot;.&quot;);
<span class="lineNum">    2262 </span>            :                 if (!strcmp(filename, file)) {
<span class="lineNum">    2263 </span>            :                         ast_copy_string(vms_p-&gt;fn, dir, sizeof(vms_p-&gt;fn));
<span class="lineNum">    2264 </span>            :                         vms_p-&gt;msgArray[vms_p-&gt;curmsg] = i + 1;
<span class="lineNum">    2265 </span>            :                         create_dirpath(dest, sizeof(dest), vmu-&gt;context, vms_p-&gt;username, &quot;&quot;);
<span class="lineNum">    2266 </span>            :                         save_body(body, vms_p, &quot;2&quot;, attachment, 0);
<span class="lineNum">    2267 </span>            :                         ret = 0;
<span class="lineNum">    2268 </span>            :                         break;
<span class="lineNum">    2269 </span>            :                 }
<span class="lineNum">    2270 </span>            :         }
<span class="lineNum">    2271 </span>            : 
<span class="lineNum">    2272 </span>            :         if (curr_mbox != -1) {
<span class="lineNum">    2273 </span>            :                 /* restore previous mbox stream */
<span class="lineNum">    2274 </span>            :                 if (init_mailstream(vms_p, curr_mbox) || !vms_p-&gt;mailstream) {
<span class="lineNum">    2275 </span>            :                         ast_log(AST_LOG_ERROR, &quot;IMAP mailstream is NULL or can't init_mailstream\n&quot;);
<span class="lineNum">    2276 </span>            :                         ret = -1;
<span class="lineNum">    2277 </span>            :                 }
<span class="lineNum">    2278 </span>            :         }
<span class="lineNum">    2279 </span>            :         ast_mutex_unlock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2280 </span>            :         return ret;
<span class="lineNum">    2281 </span>            : }
<span class="lineNum">    2282 </span>            : 
<span class="lineNum">    2283 </span>            : static int imap_retrieve_file(const char *dir, const int msgnum, const char *mailbox, const char *context)
<span class="lineNum">    2284 </span>            : {
<span class="lineNum">    2285 </span>            :         BODY *body;
<span class="lineNum">    2286 </span>            :         char *header_content;
<span class="lineNum">    2287 </span>            :         char *attachedfilefmt;
<span class="lineNum">    2288 </span>            :         char buf[80];
<span class="lineNum">    2289 </span>            :         struct vm_state *vms;
<span class="lineNum">    2290 </span>            :         char text_file[PATH_MAX];
<span class="lineNum">    2291 </span>            :         FILE *text_file_ptr;
<span class="lineNum">    2292 </span>            :         int res = 0;
<span class="lineNum">    2293 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">    2294 </span>            :         int curr_mbox;
<span class="lineNum">    2295 </span>            : 
<span class="lineNum">    2296 </span>            :         if (!(vmu = find_user(NULL, context, mailbox))) {
<span class="lineNum">    2297 </span>            :                 ast_log(LOG_WARNING, &quot;Couldn't find user with mailbox %s@%s\n&quot;, mailbox, context);
<span class="lineNum">    2298 </span>            :                 return -1;
<span class="lineNum">    2299 </span>            :         }
<span class="lineNum">    2300 </span>            : 
<span class="lineNum">    2301 </span>            :         if (msgnum &lt; 0) {
<span class="lineNum">    2302 </span>            :                 if (imapgreetings) {
<span class="lineNum">    2303 </span>            :                         res = imap_retrieve_greeting(dir, msgnum, vmu);
<span class="lineNum">    2304 </span>            :                         goto exit;
<span class="lineNum">    2305 </span>            :                 } else {
<span class="lineNum">    2306 </span>            :                         res = 0;
<span class="lineNum">    2307 </span>            :                         goto exit;
<span class="lineNum">    2308 </span>            :                 }
<span class="lineNum">    2309 </span>            :         }
<span class="lineNum">    2310 </span>            : 
<span class="lineNum">    2311 </span>            :         /* Before anything can happen, we need a vm_state so that we can
<span class="lineNum">    2312 </span>            :          * actually access the imap server through the vms-&gt;mailstream
<span class="lineNum">    2313 </span>            :          */
<span class="lineNum">    2314 </span>            :         if (!(vms = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;mailbox, vmu-&gt;context, 0))) {
<span class="lineNum">    2315 </span>            :                 /* This should not happen. If it does, then I guess we'd
<span class="lineNum">    2316 </span>            :                  * need to create the vm_state, extract which mailbox to
<span class="lineNum">    2317 </span>            :                  * open, and then set up the msgArray so that the correct
<span class="lineNum">    2318 </span>            :                  * IMAP message could be accessed. If I have seen correctly
<span class="lineNum">    2319 </span>            :                  * though, the vms should be obtainable from the vmstates list
<span class="lineNum">    2320 </span>            :                  * and should have its msgArray properly set up.
<span class="lineNum">    2321 </span>            :                  */
<span class="lineNum">    2322 </span>            :                 ast_log(LOG_ERROR, &quot;Couldn't find a vm_state for mailbox %s!!! Oh no!\n&quot;, vmu-&gt;mailbox);
<span class="lineNum">    2323 </span>            :                 res = -1;
<span class="lineNum">    2324 </span>            :                 goto exit;
<span class="lineNum">    2325 </span>            :         }
<span class="lineNum">    2326 </span>            : 
<span class="lineNum">    2327 </span>            :         /* Ensure we have the correct mailbox open and have a valid mailstream for it */
<span class="lineNum">    2328 </span>            :         curr_mbox = get_folder_by_name(vms-&gt;curbox);
<span class="lineNum">    2329 </span>            :         if (curr_mbox &lt; 0) {
<span class="lineNum">    2330 </span>            :                 ast_debug(3, &quot;Mailbox folder curbox not set, defaulting to Inbox\n&quot;);
<span class="lineNum">    2331 </span>            :                 curr_mbox = 0;
<span class="lineNum">    2332 </span>            :         }
<span class="lineNum">    2333 </span>            :         init_mailstream(vms, curr_mbox);
<span class="lineNum">    2334 </span>            :         if (!vms-&gt;mailstream) {
<span class="lineNum">    2335 </span>            :                 ast_log(AST_LOG_ERROR, &quot;IMAP mailstream for %s is NULL\n&quot;, vmu-&gt;mailbox);
<span class="lineNum">    2336 </span>            :                 res = -1;
<span class="lineNum">    2337 </span>            :                 goto exit;
<span class="lineNum">    2338 </span>            :         }
<span class="lineNum">    2339 </span>            : 
<span class="lineNum">    2340 </span>            :         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), dir, msgnum);
<span class="lineNum">    2341 </span>            :         snprintf(vms-&gt;introfn, sizeof(vms-&gt;introfn), &quot;%sintro&quot;, vms-&gt;fn);
<span class="lineNum">    2342 </span>            : 
<span class="lineNum">    2343 </span>            :         /* Don't try to retrieve a message from IMAP if it already is on the file system */
<span class="lineNum">    2344 </span>            :         if (ast_fileexists(vms-&gt;fn, NULL, NULL) &gt; 0) {
<span class="lineNum">    2345 </span>            :                 res = 0;
<span class="lineNum">    2346 </span>            :                 goto exit;
<span class="lineNum">    2347 </span>            :         }
<span class="lineNum">    2348 </span>            : 
<span class="lineNum">    2349 </span>            :         ast_debug(3, &quot;Before mail_fetchheaders, curmsg is: %d, imap messages is %lu\n&quot;, msgnum, vms-&gt;msgArray[msgnum]);
<span class="lineNum">    2350 </span>            :         if (vms-&gt;msgArray[msgnum] == 0) {
<span class="lineNum">    2351 </span>            :                 ast_log(LOG_WARNING, &quot;Trying to access unknown message\n&quot;);
<span class="lineNum">    2352 </span>            :                 res = -1;
<span class="lineNum">    2353 </span>            :                 goto exit;
<span class="lineNum">    2354 </span>            :         }
<span class="lineNum">    2355 </span>            : 
<span class="lineNum">    2356 </span>            :         /* This will only work for new messages... */
<span class="lineNum">    2357 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    2358 </span>            :         header_content = mail_fetchheader (vms-&gt;mailstream, vms-&gt;msgArray[msgnum]);
<span class="lineNum">    2359 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    2360 </span>            :         /* empty string means no valid header */
<span class="lineNum">    2361 </span>            :         if (ast_strlen_zero(header_content)) {
<span class="lineNum">    2362 </span>            :                 ast_log(LOG_ERROR, &quot;Could not fetch header for message number %ld\n&quot;, vms-&gt;msgArray[msgnum]);
<span class="lineNum">    2363 </span>            :                 res = -1;
<span class="lineNum">    2364 </span>            :                 goto exit;
<span class="lineNum">    2365 </span>            :         }
<span class="lineNum">    2366 </span>            : 
<span class="lineNum">    2367 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    2368 </span>            :         mail_fetchstructure(vms-&gt;mailstream, vms-&gt;msgArray[msgnum], &amp;body);
<span class="lineNum">    2369 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    2370 </span>            : 
<span class="lineNum">    2371 </span>            :         /* We have the body, now we extract the file name of the first attachment. */
<span class="lineNum">    2372 </span>            :         if (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<span class="lineNum">    2373 </span>            :                 attachedfilefmt = ast_strdupa(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<span class="lineNum">    2374 </span>            :         } else {
<span class="lineNum">    2375 </span>            :                 ast_log(LOG_ERROR, &quot;There is no file attached to this IMAP message.\n&quot;);
<span class="lineNum">    2376 </span>            :                 res = -1;
<span class="lineNum">    2377 </span>            :                 goto exit;
<span class="lineNum">    2378 </span>            :         }
<span class="lineNum">    2379 </span>            : 
<span class="lineNum">    2380 </span>            :         /* Find the format of the attached file */
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span>            :         strsep(&amp;attachedfilefmt, &quot;.&quot;);
<span class="lineNum">    2383 </span>            :         if (!attachedfilefmt) {
<span class="lineNum">    2384 </span>            :                 ast_log(LOG_ERROR, &quot;File format could not be obtained from IMAP message attachment\n&quot;);
<span class="lineNum">    2385 </span>            :                 res = -1;
<span class="lineNum">    2386 </span>            :                 goto exit;
<span class="lineNum">    2387 </span>            :         }
<span class="lineNum">    2388 </span>            : 
<span class="lineNum">    2389 </span>            :         save_body(body, vms, &quot;2&quot;, attachedfilefmt, 0);
<span class="lineNum">    2390 </span>            :         if (save_body(body, vms, &quot;3&quot;, attachedfilefmt, 1)) {
<span class="lineNum">    2391 </span>            :                 *vms-&gt;introfn = '\0';
<span class="lineNum">    2392 </span>            :         }
<span class="lineNum">    2393 </span>            : 
<span class="lineNum">    2394 </span>            :         /* Get info from headers!! */
<span class="lineNum">    2395 </span>            :         snprintf(text_file, sizeof(text_file), &quot;%s.%s&quot;, vms-&gt;fn, &quot;txt&quot;);
<span class="lineNum">    2396 </span>            : 
<span class="lineNum">    2397 </span>            :         if (!(text_file_ptr = fopen(text_file, &quot;w&quot;))) {
<span class="lineNum">    2398 </span>            :                 ast_log(LOG_ERROR, &quot;Unable to open/create file %s: %s\n&quot;, text_file, strerror(errno));
<span class="lineNum">    2399 </span>            :                 goto exit;
<span class="lineNum">    2400 </span>            :         }
<span class="lineNum">    2401 </span>            : 
<span class="lineNum">    2402 </span>            :         fprintf(text_file_ptr, &quot;%s\n&quot;, &quot;[message]&quot;);
<span class="lineNum">    2403 </span>            : 
<span class="lineNum">    2404 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Caller-ID-Name:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2405 </span>            :                 fprintf(text_file_ptr, &quot;callerid=\&quot;%s\&quot; &quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2406 </span>            :         }
<span class="lineNum">    2407 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Caller-ID-Num:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2408 </span>            :                 fprintf(text_file_ptr, &quot;&lt;%s&gt;\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2409 </span>            :         }
<span class="lineNum">    2410 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Context:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2411 </span>            :                 fprintf(text_file_ptr, &quot;context=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2412 </span>            :         }
<span class="lineNum">    2413 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Orig-time:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2414 </span>            :                 fprintf(text_file_ptr, &quot;origtime=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2415 </span>            :         }
<span class="lineNum">    2416 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Duration:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2417 </span>            :                 fprintf(text_file_ptr, &quot;duration=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2418 </span>            :         }
<span class="lineNum">    2419 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Category:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2420 </span>            :                 fprintf(text_file_ptr, &quot;category=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2421 </span>            :         }
<span class="lineNum">    2422 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Flag:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2423 </span>            :                 fprintf(text_file_ptr, &quot;flag=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2424 </span>            :         }
<span class="lineNum">    2425 </span>            :         if (get_header_by_tag(header_content, &quot;X-Asterisk-VM-Message-ID:&quot;, buf, sizeof(buf))) {
<span class="lineNum">    2426 </span>            :                 fprintf(text_file_ptr, &quot;msg_id=%s\n&quot;, S_OR(buf, &quot;&quot;));
<span class="lineNum">    2427 </span>            :         }
<span class="lineNum">    2428 </span>            :         fclose(text_file_ptr);
<span class="lineNum">    2429 </span>            : 
<span class="lineNum">    2430 </span>            : exit:
<span class="lineNum">    2431 </span>            :         free_user(vmu);
<span class="lineNum">    2432 </span>            :         return res;
<span class="lineNum">    2433 </span>            : }
<span class="lineNum">    2434 </span>            : 
<span class="lineNum">    2435 </span>            : static int folder_int(const char *folder)
<span class="lineNum">    2436 </span>            : {
<span class="lineNum">    2437 </span>            :         /*assume a NULL folder means INBOX*/
<span class="lineNum">    2438 </span>            :         if (!folder) {
<span class="lineNum">    2439 </span>            :                 return 0;
<span class="lineNum">    2440 </span>            :         }
<span class="lineNum">    2441 </span>            :         if (!strcasecmp(folder, imapfolder)) {
<span class="lineNum">    2442 </span>            :                 return 0;
<span class="lineNum">    2443 </span>            :         } else if (!strcasecmp(folder, &quot;Old&quot;)) {
<span class="lineNum">    2444 </span>            :                 return 1;
<span class="lineNum">    2445 </span>            :         } else if (!strcasecmp(folder, &quot;Work&quot;)) {
<span class="lineNum">    2446 </span>            :                 return 2;
<span class="lineNum">    2447 </span>            :         } else if (!strcasecmp(folder, &quot;Family&quot;)) {
<span class="lineNum">    2448 </span>            :                 return 3;
<span class="lineNum">    2449 </span>            :         } else if (!strcasecmp(folder, &quot;Friends&quot;)) {
<span class="lineNum">    2450 </span>            :                 return 4;
<span class="lineNum">    2451 </span>            :         } else if (!strcasecmp(folder, &quot;Cust1&quot;)) {
<span class="lineNum">    2452 </span>            :                 return 5;
<span class="lineNum">    2453 </span>            :         } else if (!strcasecmp(folder, &quot;Cust2&quot;)) {
<span class="lineNum">    2454 </span>            :                 return 6;
<span class="lineNum">    2455 </span>            :         } else if (!strcasecmp(folder, &quot;Cust3&quot;)) {
<span class="lineNum">    2456 </span>            :                 return 7;
<span class="lineNum">    2457 </span>            :         } else if (!strcasecmp(folder, &quot;Cust4&quot;)) {
<span class="lineNum">    2458 </span>            :                 return 8;
<span class="lineNum">    2459 </span>            :         } else if (!strcasecmp(folder, &quot;Cust5&quot;)) {
<span class="lineNum">    2460 </span>            :                 return 9;
<span class="lineNum">    2461 </span>            :         } else if (!strcasecmp(folder, &quot;Urgent&quot;)) {
<span class="lineNum">    2462 </span>            :                 return 11;
<span class="lineNum">    2463 </span>            :         } else { /*assume they meant INBOX if folder is not found otherwise*/
<span class="lineNum">    2464 </span>            :                 return 0;
<span class="lineNum">    2465 </span>            :         }
<span class="lineNum">    2466 </span>            : }
<span class="lineNum">    2467 </span>            : 
<span class="lineNum">    2468 </span>            : static int __messagecount(const char *context, const char *mailbox, const char *folder)
<span class="lineNum">    2469 </span>            : {
<span class="lineNum">    2470 </span>            :         SEARCHPGM *pgm;
<span class="lineNum">    2471 </span>            :         SEARCHHEADER *hdr;
<span class="lineNum">    2472 </span>            : 
<span class="lineNum">    2473 </span>            :         struct ast_vm_user *vmu, vmus;
<span class="lineNum">    2474 </span>            :         struct vm_state *vms_p;
<span class="lineNum">    2475 </span>            :         int ret = 0;
<span class="lineNum">    2476 </span>            :         int fold = folder_int(folder);
<span class="lineNum">    2477 </span>            :         int urgent = 0;
<span class="lineNum">    2478 </span>            : 
<span class="lineNum">    2479 </span>            :         /* If URGENT, then look at INBOX */
<span class="lineNum">    2480 </span>            :         if (fold == 11) {
<span class="lineNum">    2481 </span>            :                 fold = NEW_FOLDER;
<span class="lineNum">    2482 </span>            :                 urgent = 1;
<span class="lineNum">    2483 </span>            :         }
<span class="lineNum">    2484 </span>            : 
<span class="lineNum">    2485 </span>            :         if (ast_strlen_zero(mailbox))
<span class="lineNum">    2486 </span>            :                 return 0;
<span class="lineNum">    2487 </span>            : 
<span class="lineNum">    2488 </span>            :         /* We have to get the user before we can open the stream! */
<span class="lineNum">    2489 </span>            :         memset(&amp;vmus, 0, sizeof(vmus));
<span class="lineNum">    2490 </span>            :         vmu = find_user(&amp;vmus, context, mailbox);
<span class="lineNum">    2491 </span>            :         if (!vmu) {
<span class="lineNum">    2492 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Couldn't find mailbox %s in context %s\n&quot;, mailbox, context);
<span class="lineNum">    2493 </span>            :                 free_user(vmu);
<span class="lineNum">    2494 </span>            :                 return -1;
<span class="lineNum">    2495 </span>            :         } else {
<span class="lineNum">    2496 </span>            :                 /* No IMAP account available */
<span class="lineNum">    2497 </span>            :                 if (vmu-&gt;imapuser[0] == '\0') {
<span class="lineNum">    2498 </span>            :                         ast_log(AST_LOG_WARNING, &quot;IMAP user not set for mailbox %s\n&quot;, vmu-&gt;mailbox);
<span class="lineNum">    2499 </span>            :                         free_user(vmu);
<span class="lineNum">    2500 </span>            :                         return -1;
<span class="lineNum">    2501 </span>            :                 }
<span class="lineNum">    2502 </span>            :         }
<span class="lineNum">    2503 </span>            : 
<span class="lineNum">    2504 </span>            :         /* No IMAP account available */
<span class="lineNum">    2505 </span>            :         if (vmu-&gt;imapuser[0] == '\0') {
<span class="lineNum">    2506 </span>            :                 ast_log(AST_LOG_WARNING, &quot;IMAP user not set for mailbox %s\n&quot;, vmu-&gt;mailbox);
<span class="lineNum">    2507 </span>            :                 free_user(vmu);
<span class="lineNum">    2508 </span>            :                 return -1;
<span class="lineNum">    2509 </span>            :         }
<span class="lineNum">    2510 </span>            : 
<span class="lineNum">    2511 </span>            :         /* check if someone is accessing this box right now... */
<span class="lineNum">    2512 </span>            :         vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser, 1);
<span class="lineNum">    2513 </span>            :         if (!vms_p) {
<span class="lineNum">    2514 </span>            :                 vms_p = get_vm_state_by_mailbox(mailbox, context, 1);
<span class="lineNum">    2515 </span>            :         }
<span class="lineNum">    2516 </span>            :         if (vms_p) {
<span class="lineNum">    2517 </span>            :                 ast_debug(3, &quot;Returning before search - user is logged in\n&quot;);
<span class="lineNum">    2518 </span>            :                 if (fold == 0) { /* INBOX */
<span class="lineNum">    2519 </span>            :                         free_user(vmu);
<span class="lineNum">    2520 </span>            :                         return urgent ? vms_p-&gt;urgentmessages : vms_p-&gt;newmessages;
<span class="lineNum">    2521 </span>            :                 }
<span class="lineNum">    2522 </span>            :                 if (fold == 1) { /* Old messages */
<span class="lineNum">    2523 </span>            :                         free_user(vmu);
<span class="lineNum">    2524 </span>            :                         return vms_p-&gt;oldmessages;
<span class="lineNum">    2525 </span>            :                 }
<span class="lineNum">    2526 </span>            :         }
<span class="lineNum">    2527 </span>            : 
<span class="lineNum">    2528 </span>            :         /* add one if not there... */
<span class="lineNum">    2529 </span>            :         vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0);
<span class="lineNum">    2530 </span>            :         if (!vms_p) {
<span class="lineNum">    2531 </span>            :                 vms_p = get_vm_state_by_mailbox(mailbox, context, 0);
<span class="lineNum">    2532 </span>            :         }
<span class="lineNum">    2533 </span>            : 
<span class="lineNum">    2534 </span>            :         if (!vms_p) {
<span class="lineNum">    2535 </span>            :                 vms_p = create_vm_state_from_user(vmu);
<span class="lineNum">    2536 </span>            :         }
<span class="lineNum">    2537 </span>            :         ret = init_mailstream(vms_p, fold);
<span class="lineNum">    2538 </span>            :         if (!vms_p-&gt;mailstream) {
<span class="lineNum">    2539 </span>            :                 ast_log(AST_LOG_ERROR, &quot;Houston we have a problem - IMAP mailstream is NULL\n&quot;);
<span class="lineNum">    2540 </span>            :                 free_user(vmu);
<span class="lineNum">    2541 </span>            :                 return -1;
<span class="lineNum">    2542 </span>            :         }
<span class="lineNum">    2543 </span>            :         if (ret == 0) {
<span class="lineNum">    2544 </span>            :                 ast_mutex_lock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2545 </span>            :                 pgm = mail_newsearchpgm ();
<span class="lineNum">    2546 </span>            :                 hdr = mail_newsearchheader (&quot;X-Asterisk-VM-Extension&quot;, (char *)(!ast_strlen_zero(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));
<span class="lineNum">    2547 </span>            :                 hdr-&gt;next = mail_newsearchheader(&quot;X-Asterisk-VM-Context&quot;, (char *) S_OR(context, &quot;default&quot;));
<span class="lineNum">    2548 </span>            :                 pgm-&gt;header = hdr;
<span class="lineNum">    2549 </span>            :                 if (fold != OLD_FOLDER) {
<span class="lineNum">    2550 </span>            :                         pgm-&gt;unseen = 1;
<span class="lineNum">    2551 </span>            :                         pgm-&gt;seen = 0;
<span class="lineNum">    2552 </span>            :                 }
<span class="lineNum">    2553 </span>            :                 /* In the special case where fold is 1 (old messages) we have to do things a bit
<span class="lineNum">    2554 </span>            :                  * differently. Old messages are stored in the INBOX but are marked as &quot;seen&quot;
<span class="lineNum">    2555 </span>            :                  */
<span class="lineNum">    2556 </span>            :                 else {
<span class="lineNum">    2557 </span>            :                         pgm-&gt;unseen = 0;
<span class="lineNum">    2558 </span>            :                         pgm-&gt;seen = 1;
<span class="lineNum">    2559 </span>            :                 }
<span class="lineNum">    2560 </span>            :                 /* look for urgent messages */
<span class="lineNum">    2561 </span>            :                 if (fold == NEW_FOLDER) {
<span class="lineNum">    2562 </span>            :                         if (urgent) {
<span class="lineNum">    2563 </span>            :                                 pgm-&gt;flagged = 1;
<span class="lineNum">    2564 </span>            :                                 pgm-&gt;unflagged = 0;
<span class="lineNum">    2565 </span>            :                         } else {
<span class="lineNum">    2566 </span>            :                                 pgm-&gt;flagged = 0;
<span class="lineNum">    2567 </span>            :                                 pgm-&gt;unflagged = 1;
<span class="lineNum">    2568 </span>            :                         }
<span class="lineNum">    2569 </span>            :                 }
<span class="lineNum">    2570 </span>            :                 pgm-&gt;undeleted = 1;
<span class="lineNum">    2571 </span>            :                 pgm-&gt;deleted = 0;
<span class="lineNum">    2572 </span>            : 
<span class="lineNum">    2573 </span>            :                 vms_p-&gt;vmArrayIndex = 0;
<span class="lineNum">    2574 </span>            :                 mail_search_full (vms_p-&gt;mailstream, NULL, pgm, NIL);
<span class="lineNum">    2575 </span>            :                 if (fold == 0 &amp;&amp; urgent == 0)
<span class="lineNum">    2576 </span>            :                         vms_p-&gt;newmessages = vms_p-&gt;vmArrayIndex;
<span class="lineNum">    2577 </span>            :                 if (fold == 1)
<span class="lineNum">    2578 </span>            :                         vms_p-&gt;oldmessages = vms_p-&gt;vmArrayIndex;
<span class="lineNum">    2579 </span>            :                 if (fold == 0 &amp;&amp; urgent == 1)
<span class="lineNum">    2580 </span>            :                         vms_p-&gt;urgentmessages = vms_p-&gt;vmArrayIndex;
<span class="lineNum">    2581 </span>            :                 /*Freeing the searchpgm also frees the searchhdr*/
<span class="lineNum">    2582 </span>            :                 mail_free_searchpgm(&amp;pgm);
<span class="lineNum">    2583 </span>            :                 ast_mutex_unlock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2584 </span>            :                 free_user(vmu);
<span class="lineNum">    2585 </span>            :                 vms_p-&gt;updated = 0;
<span class="lineNum">    2586 </span>            :                 return vms_p-&gt;vmArrayIndex;
<span class="lineNum">    2587 </span>            :         } else {
<span class="lineNum">    2588 </span>            :                 ast_mutex_lock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2589 </span>            :                 mail_ping(vms_p-&gt;mailstream);
<span class="lineNum">    2590 </span>            :                 ast_mutex_unlock(&amp;vms_p-&gt;lock);
<span class="lineNum">    2591 </span>            :         }
<span class="lineNum">    2592 </span>            :         free_user(vmu);
<span class="lineNum">    2593 </span>            :         return 0;
<span class="lineNum">    2594 </span>            : }
<span class="lineNum">    2595 </span>            : 
<span class="lineNum">    2596 </span>            : static int imap_check_limits(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu, int msgnum)
<span class="lineNum">    2597 </span>            : {
<span class="lineNum">    2598 </span>            :         /* Check if mailbox is full */
<span class="lineNum">    2599 </span>            :         check_quota(vms, vmu-&gt;imapfolder);
<span class="lineNum">    2600 </span>            :         if (vms-&gt;quota_limit &amp;&amp; vms-&gt;quota_usage &gt;= vms-&gt;quota_limit) {
<span class="lineNum">    2601 </span>            :                 ast_debug(1, &quot;*** QUOTA EXCEEDED!! %u &gt;= %u\n&quot;, vms-&gt;quota_usage, vms-&gt;quota_limit);
<span class="lineNum">    2602 </span>            :                 if (chan) {
<span class="lineNum">    2603 </span>            :                         ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);
<span class="lineNum">    2604 </span>            :                 }
<span class="lineNum">    2605 </span>            :                 return -1;
<span class="lineNum">    2606 </span>            :         }
<span class="lineNum">    2607 </span>            : 
<span class="lineNum">    2608 </span>            :         /* Check if we have exceeded maxmsg */
<span class="lineNum">    2609 </span>            :         ast_debug(3, &quot;Checking message number quota: mailbox has %d messages, maximum is set to %d, current messages %d\n&quot;, msgnum, vmu-&gt;maxmsg, inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, 0));
<span class="lineNum">    2610 </span>            :         if (msgnum &gt;= vmu-&gt;maxmsg - inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, +1)) {
<span class="lineNum">    2611 </span>            :                 ast_log(LOG_WARNING, &quot;Unable to leave message since we will exceed the maximum number of messages allowed (%u &gt;= %u)\n&quot;, msgnum, vmu-&gt;maxmsg);
<span class="lineNum">    2612 </span>            :                 if (chan) {
<span class="lineNum">    2613 </span>            :                         ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);
<span class="lineNum">    2614 </span>            :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);
<span class="lineNum">    2615 </span>            :                 }
<span class="lineNum">    2616 </span>            :                 return -1;
<span class="lineNum">    2617 </span>            :         }
<span class="lineNum">    2618 </span>            : 
<span class="lineNum">    2619 </span>            :         return 0;
<span class="lineNum">    2620 </span>            : }
<span class="lineNum">    2621 </span>            : 
<span class="lineNum">    2622 </span>            : /*!
<span class="lineNum">    2623 </span>            :  * \brief Gets the number of messages that exist in a mailbox folder.
<span class="lineNum">    2624 </span>            :  * \param mailbox_id
<span class="lineNum">    2625 </span>            :  * \param folder
<span class="lineNum">    2626 </span>            :  *
<span class="lineNum">    2627 </span>            :  * This method is used when IMAP backend is used.
<span class="lineNum">    2628 </span>            :  * \return The number of messages in this mailbox folder (zero or more).
<span class="lineNum">    2629 </span>            :  */
<span class="lineNum">    2630 </span>            : static int messagecount(const char *mailbox_id, const char *folder)
<span class="lineNum">    2631 </span>            : {
<span class="lineNum">    2632 </span>            :         char *context;
<span class="lineNum">    2633 </span>            :         char *mailbox;
<span class="lineNum">    2634 </span>            : 
<span class="lineNum">    2635 </span>            :         if (ast_strlen_zero(mailbox_id)
<span class="lineNum">    2636 </span>            :                 || separate_mailbox(ast_strdupa(mailbox_id), &amp;mailbox, &amp;context)) {
<span class="lineNum">    2637 </span>            :                 return 0;
<span class="lineNum">    2638 </span>            :         }
<span class="lineNum">    2639 </span>            : 
<span class="lineNum">    2640 </span>            :         if (ast_strlen_zero(folder) || !strcmp(folder, &quot;INBOX&quot;)) {
<span class="lineNum">    2641 </span>            :                 return __messagecount(context, mailbox, &quot;INBOX&quot;) + __messagecount(context, mailbox, &quot;Urgent&quot;);
<span class="lineNum">    2642 </span>            :         } else {
<span class="lineNum">    2643 </span>            :                 return __messagecount(context, mailbox, folder);
<span class="lineNum">    2644 </span>            :         }
<span class="lineNum">    2645 </span>            : }
<span class="lineNum">    2646 </span>            : 
<span class="lineNum">    2647 </span>            : static int imap_store_file(const char *dir, const char *mailboxuser, const char *mailboxcontext, int msgnum, struct ast_channel *chan, struct ast_vm_user *vmu, char *fmt, int duration, struct vm_state *vms, const char *flag, const char *msg_id)
<span class="lineNum">    2648 </span>            : {
<span class="lineNum">    2649 </span>            :         char *myserveremail = serveremail;
<span class="lineNum">    2650 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    2651 </span>            :         char introfn[PATH_MAX];
<span class="lineNum">    2652 </span>            :         char mailbox[256];
<span class="lineNum">    2653 </span>            :         char *stringp;
<span class="lineNum">    2654 </span>            :         FILE *p = NULL;
<span class="lineNum">    2655 </span>            :         char tmp[80] = &quot;/tmp/astmail-XXXXXX&quot;;
<span class="lineNum">    2656 </span>            :         long len;
<span class="lineNum">    2657 </span>            :         void *buf;
<span class="lineNum">    2658 </span>            :         int tempcopy = 0;
<span class="lineNum">    2659 </span>            :         STRING str;
<span class="lineNum">    2660 </span>            :         int ret; /* for better error checking */
<span class="lineNum">    2661 </span>            :         char *imap_flags = NIL;
<span class="lineNum">    2662 </span>            :         int msgcount;
<span class="lineNum">    2663 </span>            :         int box = NEW_FOLDER;
<span class="lineNum">    2664 </span>            : 
<span class="lineNum">    2665 </span>            :         snprintf(mailbox, sizeof(mailbox), &quot;%s@%s&quot;, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">    2666 </span>            :         msgcount = messagecount(mailbox, &quot;INBOX&quot;) + messagecount(mailbox, &quot;Old&quot;);
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span>            :         /* Back out early if this is a greeting and we don't want to store greetings in IMAP */
<span class="lineNum">    2669 </span>            :         if (msgnum &lt; 0) {
<span class="lineNum">    2670 </span>            :                 if(!imapgreetings) {
<span class="lineNum">    2671 </span>            :                         return 0;
<span class="lineNum">    2672 </span>            :                 } else {
<span class="lineNum">    2673 </span>            :                         box = GREETINGS_FOLDER;
<span class="lineNum">    2674 </span>            :                 }
<span class="lineNum">    2675 </span>            :         }
<span class="lineNum">    2676 </span>            : 
<span class="lineNum">    2677 </span>            :         if (imap_check_limits(chan, vms, vmu, msgcount)) {
<span class="lineNum">    2678 </span>            :                 return -1;
<span class="lineNum">    2679 </span>            :         }
<span class="lineNum">    2680 </span>            : 
<span class="lineNum">    2681 </span>            :         /* Set urgent flag for IMAP message */
<span class="lineNum">    2682 </span>            :         if (!ast_strlen_zero(flag) &amp;&amp; !strcmp(flag, &quot;Urgent&quot;)) {
<span class="lineNum">    2683 </span>            :                 ast_debug(3, &quot;Setting message flag \\\\FLAGGED.\n&quot;);
<span class="lineNum">    2684 </span>            :                 imap_flags = &quot;\\FLAGGED&quot;;
<span class="lineNum">    2685 </span>            :         }
<span class="lineNum">    2686 </span>            : 
<span class="lineNum">    2687 </span>            :         /* Attach only the first format */
<span class="lineNum">    2688 </span>            :         fmt = ast_strdupa(fmt);
<span class="lineNum">    2689 </span>            :         stringp = fmt;
<span class="lineNum">    2690 </span>            :         strsep(&amp;stringp, &quot;|&quot;);
<span class="lineNum">    2691 </span>            : 
<span class="lineNum">    2692 </span>            :         if (!ast_strlen_zero(vmu-&gt;serveremail))
<span class="lineNum">    2693 </span>            :                 myserveremail = vmu-&gt;serveremail;
<span class="lineNum">    2694 </span>            : 
<span class="lineNum">    2695 </span>            :         if (msgnum &gt; -1)
<span class="lineNum">    2696 </span>            :                 make_file(fn, sizeof(fn), dir, msgnum);
<span class="lineNum">    2697 </span>            :         else
<span class="lineNum">    2698 </span>            :                 ast_copy_string (fn, dir, sizeof(fn));
<span class="lineNum">    2699 </span>            : 
<span class="lineNum">    2700 </span>            :         snprintf(introfn, sizeof(introfn), &quot;%sintro&quot;, fn);
<span class="lineNum">    2701 </span>            :         if (ast_fileexists(introfn, NULL, NULL) &lt;= 0) {
<span class="lineNum">    2702 </span>            :                 *introfn = '\0';
<span class="lineNum">    2703 </span>            :         }
<span class="lineNum">    2704 </span>            : 
<span class="lineNum">    2705 </span>            :         if (ast_strlen_zero(vmu-&gt;email)) {
<span class="lineNum">    2706 </span>            :                 /* We need the vmu-&gt;email to be set when we call make_email_file, but
<span class="lineNum">    2707 </span>            :                  * if we keep it set, a duplicate e-mail will be created. So at the end
<span class="lineNum">    2708 </span>            :                  * of this function, we will revert back to an empty string if tempcopy
<span class="lineNum">    2709 </span>            :                  * is 1.
<span class="lineNum">    2710 </span>            :                  */
<span class="lineNum">    2711 </span>            :                 vmu-&gt;email = ast_strdup(vmu-&gt;imapuser);
<span class="lineNum">    2712 </span>            :                 tempcopy = 1;
<span class="lineNum">    2713 </span>            :         }
<span class="lineNum">    2714 </span>            : 
<span class="lineNum">    2715 </span>            :         if (!strcmp(fmt, &quot;wav49&quot;))
<span class="lineNum">    2716 </span>            :                 fmt = &quot;WAV&quot;;
<span class="lineNum">    2717 </span>            :         ast_debug(3, &quot;Storing file '%s', format '%s'\n&quot;, fn, fmt);
<span class="lineNum">    2718 </span>            : 
<span class="lineNum">    2719 </span>            :         /* Make a temporary file instead of piping directly to sendmail, in case the mail
<span class="lineNum">    2720 </span>            :            command hangs. */
<span class="lineNum">    2721 </span>            :         if (!(p = vm_mkftemp(tmp))) {
<span class="lineNum">    2722 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Unable to store '%s' (can't create temporary file)\n&quot;, fn);
<span class="lineNum">    2723 </span>            :                 if (tempcopy) {
<span class="lineNum">    2724 </span>            :                         ast_free(vmu-&gt;email);
<span class="lineNum">    2725 </span>            :                         vmu-&gt;email = NULL;
<span class="lineNum">    2726 </span>            :                 }
<span class="lineNum">    2727 </span>            :                 return -1;
<span class="lineNum">    2728 </span>            :         }
<span class="lineNum">    2729 </span>            : 
<span class="lineNum">    2730 </span>            :         if (msgnum &lt; 0 &amp;&amp; imapgreetings) {
<span class="lineNum">    2731 </span>            :                 if ((ret = init_mailstream(vms, GREETINGS_FOLDER))) {
<span class="lineNum">    2732 </span>            :                         ast_log(AST_LOG_WARNING, &quot;Unable to open mailstream.\n&quot;);
<span class="lineNum">    2733 </span>            :                         return -1;
<span class="lineNum">    2734 </span>            :                 }
<span class="lineNum">    2735 </span>            :                 imap_delete_old_greeting(fn, vms);
<span class="lineNum">    2736 </span>            :         }
<span class="lineNum">    2737 </span>            : 
<span class="lineNum">    2738 </span>            :         make_email_file(p, myserveremail, vmu, msgnum, vmu-&gt;context, vmu-&gt;mailbox, &quot;INBOX&quot;,
<span class="lineNum">    2739 </span>            :                 chan ? S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL) : NULL,
<span class="lineNum">    2740 </span>            :                 chan ? S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL) : NULL,
<span class="lineNum">    2741 </span>            :                 fn, introfn, fmt, duration, 1, chan, NULL, 1, flag, msg_id);
<span class="lineNum">    2742 </span>            :         /* read mail file to memory */
<span class="lineNum">    2743 </span>            :         len = ftell(p);
<span class="lineNum">    2744 </span>            :         rewind(p);
<span class="lineNum">    2745 </span>            :         if (!(buf = ast_malloc(len + 1))) {
<span class="lineNum">    2746 </span>            :                 ast_log(AST_LOG_ERROR, &quot;Can't allocate %ld bytes to read message\n&quot;, len + 1);
<span class="lineNum">    2747 </span>            :                 fclose(p);
<span class="lineNum">    2748 </span>            :                 if (tempcopy)
<span class="lineNum">    2749 </span>            :                         *(vmu-&gt;email) = '\0';
<span class="lineNum">    2750 </span>            :                 return -1;
<span class="lineNum">    2751 </span>            :         }
<span class="lineNum">    2752 </span>            :         if (fread(buf, 1, len, p) != len) {
<span class="lineNum">    2753 </span>            :                 if (ferror(p)) {
<span class="lineNum">    2754 </span>            :                         ast_log(LOG_ERROR, &quot;Error while reading mail file: %s\n&quot;, tmp);
<span class="lineNum">    2755 </span>            :                         return -1;
<span class="lineNum">    2756 </span>            :                 }
<span class="lineNum">    2757 </span>            :         }
<span class="lineNum">    2758 </span>            :         ((char *) buf)[len] = '\0';
<span class="lineNum">    2759 </span>            :         INIT(&amp;str, mail_string, buf, len);
<span class="lineNum">    2760 </span>            :         ret = init_mailstream(vms, box);
<span class="lineNum">    2761 </span>            :         if (ret == 0) {
<span class="lineNum">    2762 </span>            :                 imap_mailbox_name(mailbox, sizeof(mailbox), vms, box, 1);
<span class="lineNum">    2763 </span>            :                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    2764 </span>            :                 if(!mail_append_full(vms-&gt;mailstream, mailbox, imap_flags, NIL, &amp;str))
<span class="lineNum">    2765 </span>            :                         ast_log(LOG_ERROR, &quot;Error while sending the message to %s\n&quot;, mailbox);
<span class="lineNum">    2766 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    2767 </span>            :                 fclose(p);
<span class="lineNum">    2768 </span>            :                 unlink(tmp);
<span class="lineNum">    2769 </span>            :                 ast_free(buf);
<span class="lineNum">    2770 </span>            :         } else {
<span class="lineNum">    2771 </span>            :                 ast_log(LOG_ERROR, &quot;Could not initialize mailstream for %s\n&quot;, mailbox);
<span class="lineNum">    2772 </span>            :                 fclose(p);
<span class="lineNum">    2773 </span>            :                 unlink(tmp);
<span class="lineNum">    2774 </span>            :                 ast_free(buf);
<span class="lineNum">    2775 </span>            :                 return -1;
<span class="lineNum">    2776 </span>            :         }
<span class="lineNum">    2777 </span>            :         ast_debug(3, &quot;%s stored\n&quot;, fn);
<span class="lineNum">    2778 </span>            : 
<span class="lineNum">    2779 </span>            :         if (tempcopy)
<span class="lineNum">    2780 </span>            :                 *(vmu-&gt;email) = '\0';
<span class="lineNum">    2781 </span>            :         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);
<span class="lineNum">    2782 </span>            :         return 0;
<span class="lineNum">    2783 </span>            : 
<span class="lineNum">    2784 </span>            : }
<span class="lineNum">    2785 </span>            : 
<span class="lineNum">    2786 </span>            : /*!
<span class="lineNum">    2787 </span>            :  * \brief Gets the number of messages that exist in the inbox folder.
<span class="lineNum">    2788 </span>            :  * \param mailbox_context
<span class="lineNum">    2789 </span>            :  * \param newmsgs The variable that is updated with the count of new messages within this inbox.
<span class="lineNum">    2790 </span>            :  * \param oldmsgs The variable that is updated with the count of old messages within this inbox.
<span class="lineNum">    2791 </span>            :  * \param urgentmsgs The variable that is updated with the count of urgent messages within this inbox.
<span class="lineNum">    2792 </span>            :  *
<span class="lineNum">    2793 </span>            :  * This method is used when IMAP backend is used.
<span class="lineNum">    2794 </span>            :  * Simultaneously determines the count of new,old, and urgent messages. The total messages would then be the sum of these three.
<span class="lineNum">    2795 </span>            :  *
<span class="lineNum">    2796 </span>            :  * \return zero on success, -1 on error.
<span class="lineNum">    2797 </span>            :  */
<span class="lineNum">    2798 </span>            : 
<span class="lineNum">    2799 </span>            : static int inboxcount2(const char *mailbox_context, int *urgentmsgs, int *newmsgs, int *oldmsgs)
<span class="lineNum">    2800 </span>            : {
<span class="lineNum">    2801 </span>            :         char tmp[PATH_MAX] = &quot;&quot;;
<span class="lineNum">    2802 </span>            :         char *mailboxnc;
<span class="lineNum">    2803 </span>            :         char *context;
<span class="lineNum">    2804 </span>            :         char *mb;
<span class="lineNum">    2805 </span>            :         char *cur;
<span class="lineNum">    2806 </span>            :         if (newmsgs)
<span class="lineNum">    2807 </span>            :                 *newmsgs = 0;
<span class="lineNum">    2808 </span>            :         if (oldmsgs)
<span class="lineNum">    2809 </span>            :                 *oldmsgs = 0;
<span class="lineNum">    2810 </span>            :         if (urgentmsgs)
<span class="lineNum">    2811 </span>            :                 *urgentmsgs = 0;
<span class="lineNum">    2812 </span>            : 
<span class="lineNum">    2813 </span>            :         ast_debug(3, &quot;Mailbox is set to %s\n&quot;, mailbox_context);
<span class="lineNum">    2814 </span>            :         /* If no mailbox, return immediately */
<span class="lineNum">    2815 </span>            :         if (ast_strlen_zero(mailbox_context))
<span class="lineNum">    2816 </span>            :                 return 0;
<span class="lineNum">    2817 </span>            : 
<span class="lineNum">    2818 </span>            :         ast_copy_string(tmp, mailbox_context, sizeof(tmp));
<span class="lineNum">    2819 </span>            :         context = strchr(tmp, '@');
<span class="lineNum">    2820 </span>            :         if (strchr(mailbox_context, ',')) {
<span class="lineNum">    2821 </span>            :                 int tmpnew, tmpold, tmpurgent;
<span class="lineNum">    2822 </span>            :                 ast_copy_string(tmp, mailbox_context, sizeof(tmp));
<span class="lineNum">    2823 </span>            :                 mb = tmp;
<span class="lineNum">    2824 </span>            :                 while ((cur = strsep(&amp;mb, &quot;, &quot;))) {
<span class="lineNum">    2825 </span>            :                         if (!ast_strlen_zero(cur)) {
<span class="lineNum">    2826 </span>            :                                 if (inboxcount2(cur, urgentmsgs ? &amp;tmpurgent : NULL, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL))
<span class="lineNum">    2827 </span>            :                                         return -1;
<span class="lineNum">    2828 </span>            :                                 else {
<span class="lineNum">    2829 </span>            :                                         if (newmsgs)
<span class="lineNum">    2830 </span>            :                                                 *newmsgs += tmpnew;
<span class="lineNum">    2831 </span>            :                                         if (oldmsgs)
<span class="lineNum">    2832 </span>            :                                                 *oldmsgs += tmpold;
<span class="lineNum">    2833 </span>            :                                         if (urgentmsgs)
<span class="lineNum">    2834 </span>            :                                                 *urgentmsgs += tmpurgent;
<span class="lineNum">    2835 </span>            :                                 }
<span class="lineNum">    2836 </span>            :                         }
<span class="lineNum">    2837 </span>            :                 }
<span class="lineNum">    2838 </span>            :                 return 0;
<span class="lineNum">    2839 </span>            :         }
<span class="lineNum">    2840 </span>            :         if (context) {
<span class="lineNum">    2841 </span>            :                 *context = '\0';
<span class="lineNum">    2842 </span>            :                 mailboxnc = tmp;
<span class="lineNum">    2843 </span>            :                 context++;
<span class="lineNum">    2844 </span>            :         } else {
<span class="lineNum">    2845 </span>            :                 context = &quot;default&quot;;
<span class="lineNum">    2846 </span>            :                 mailboxnc = (char *) mailbox_context;
<span class="lineNum">    2847 </span>            :         }
<span class="lineNum">    2848 </span>            : 
<span class="lineNum">    2849 </span>            :         if (newmsgs) {
<span class="lineNum">    2850 </span>            :                 struct ast_vm_user *vmu = find_user(NULL, context, mailboxnc);
<span class="lineNum">    2851 </span>            :                 if (!vmu) {
<span class="lineNum">    2852 </span>            :                         ast_log(AST_LOG_ERROR, &quot;Couldn't find mailbox %s in context %s\n&quot;, mailboxnc, context);
<span class="lineNum">    2853 </span>            :                         return -1;
<span class="lineNum">    2854 </span>            :                 }
<span class="lineNum">    2855 </span>            :                 if ((*newmsgs = __messagecount(context, mailboxnc, vmu-&gt;imapfolder)) &lt; 0) {
<span class="lineNum">    2856 </span>            :                         free_user(vmu);
<span class="lineNum">    2857 </span>            :                         return -1;
<span class="lineNum">    2858 </span>            :                 }
<span class="lineNum">    2859 </span>            :                 free_user(vmu);
<span class="lineNum">    2860 </span>            :         }
<span class="lineNum">    2861 </span>            :         if (oldmsgs) {
<span class="lineNum">    2862 </span>            :                 if ((*oldmsgs = __messagecount(context, mailboxnc, &quot;Old&quot;)) &lt; 0) {
<span class="lineNum">    2863 </span>            :                         return -1;
<span class="lineNum">    2864 </span>            :                 }
<span class="lineNum">    2865 </span>            :         }
<span class="lineNum">    2866 </span>            :         if (urgentmsgs) {
<span class="lineNum">    2867 </span>            :                 if ((*urgentmsgs = __messagecount(context, mailboxnc, &quot;Urgent&quot;)) &lt; 0) {
<span class="lineNum">    2868 </span>            :                         return -1;
<span class="lineNum">    2869 </span>            :                 }
<span class="lineNum">    2870 </span>            :         }
<span class="lineNum">    2871 </span>            :         return 0;
<span class="lineNum">    2872 </span>            : }
<span class="lineNum">    2873 </span>            : 
<span class="lineNum">    2874 </span>            : /**
<span class="lineNum">    2875 </span>            :  * \brief Determines if the given folder has messages.
<span class="lineNum">    2876 </span>            :  * \param mailbox The @ delimited string for user@context. If no context is found, uses 'default' for the context.
<span class="lineNum">    2877 </span>            :  * \param folder the folder to look in
<span class="lineNum">    2878 </span>            :  *
<span class="lineNum">    2879 </span>            :  * This function is used when the mailbox is stored in an IMAP back end.
<span class="lineNum">    2880 </span>            :  * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.
<span class="lineNum">    2881 </span>            :  * \return 1 if the folder has one or more messages. zero otherwise.
<span class="lineNum">    2882 </span>            :  */
<span class="lineNum">    2883 </span>            : 
<span class="lineNum">    2884 </span>            : static int has_voicemail(const char *mailbox, const char *folder)
<span class="lineNum">    2885 </span>            : {
<span class="lineNum">    2886 </span>            :         char tmp[256], *tmp2, *box, *context;
<span class="lineNum">    2887 </span>            :         ast_copy_string(tmp, mailbox, sizeof(tmp));
<span class="lineNum">    2888 </span>            :         tmp2 = tmp;
<span class="lineNum">    2889 </span>            :         if (strchr(tmp2, ',') || strchr(tmp2, '&amp;')) {
<span class="lineNum">    2890 </span>            :                 while ((box = strsep(&amp;tmp2, &quot;,&amp;&quot;))) {
<span class="lineNum">    2891 </span>            :                         if (!ast_strlen_zero(box)) {
<span class="lineNum">    2892 </span>            :                                 if (has_voicemail(box, folder)) {
<span class="lineNum">    2893 </span>            :                                         return 1;
<span class="lineNum">    2894 </span>            :                                 }
<span class="lineNum">    2895 </span>            :                         }
<span class="lineNum">    2896 </span>            :                 }
<span class="lineNum">    2897 </span>            :         }
<span class="lineNum">    2898 </span>            :         if ((context = strchr(tmp, '@'))) {
<span class="lineNum">    2899 </span>            :                 *context++ = '\0';
<span class="lineNum">    2900 </span>            :         } else {
<span class="lineNum">    2901 </span>            :                 context = &quot;default&quot;;
<span class="lineNum">    2902 </span>            :         }
<span class="lineNum">    2903 </span>            :         return __messagecount(context, tmp, folder) ? 1 : 0;
<span class="lineNum">    2904 </span>            : }
<span class="lineNum">    2905 </span>            : 
<span class="lineNum">    2906 </span>            : /*!
<span class="lineNum">    2907 </span>            :  * \brief Copies a message from one mailbox to another.
<span class="lineNum">    2908 </span>            :  * \param chan
<span class="lineNum">    2909 </span>            :  * \param vmu
<span class="lineNum">    2910 </span>            :  * \param imbox
<span class="lineNum">    2911 </span>            :  * \param msgnum
<span class="lineNum">    2912 </span>            :  * \param duration
<span class="lineNum">    2913 </span>            :  * \param recip
<span class="lineNum">    2914 </span>            :  * \param fmt
<span class="lineNum">    2915 </span>            :  * \param dir
<span class="lineNum">    2916 </span>            :  *
<span class="lineNum">    2917 </span>            :  * This works with IMAP storage based mailboxes.
<span class="lineNum">    2918 </span>            :  *
<span class="lineNum">    2919 </span>            :  * \return zero on success, -1 on error.
<span class="lineNum">    2920 </span>            :  */
<span class="lineNum">    2921 </span>            : static int copy_message(struct ast_channel *chan, struct ast_vm_user *vmu, int imbox, int msgnum, long duration, struct ast_vm_user *recip, char *fmt, char *dir, char *flag, const char *dest_folder)
<span class="lineNum">    2922 </span>            : {
<span class="lineNum">    2923 </span>            :         struct vm_state *sendvms = NULL;
<span class="lineNum">    2924 </span>            :         char messagestring[10]; /*I guess this could be a problem if someone has more than 999999999 messages...*/
<span class="lineNum">    2925 </span>            :         if (msgnum &gt;= recip-&gt;maxmsg) {
<span class="lineNum">    2926 </span>            :                 ast_log(LOG_WARNING, &quot;Unable to copy mail, mailbox %s is full\n&quot;, recip-&gt;mailbox);
<span class="lineNum">    2927 </span>            :                 return -1;
<span class="lineNum">    2928 </span>            :         }
<span class="lineNum">    2929 </span>            :         if (!(sendvms = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0))) {
<span class="lineNum">    2930 </span>            :                 ast_log(LOG_ERROR, &quot;Couldn't get vm_state for originator's mailbox!!\n&quot;);
<span class="lineNum">    2931 </span>            :                 return -1;
<span class="lineNum">    2932 </span>            :         }
<span class="lineNum">    2933 </span>            :         if (!get_vm_state_by_imapuser(recip-&gt;imapuser, 0)) {
<span class="lineNum">    2934 </span>            :                 ast_log(LOG_ERROR, &quot;Couldn't get vm_state for destination mailbox!\n&quot;);
<span class="lineNum">    2935 </span>            :                 return -1;
<span class="lineNum">    2936 </span>            :         }
<span class="lineNum">    2937 </span>            :         snprintf(messagestring, sizeof(messagestring), &quot;%ld&quot;, sendvms-&gt;msgArray[msgnum]);
<span class="lineNum">    2938 </span>            :         ast_mutex_lock(&amp;sendvms-&gt;lock);
<span class="lineNum">    2939 </span>            :         if ((mail_copy(sendvms-&gt;mailstream, messagestring, (char *) mbox(vmu, imbox)) == T)) {
<span class="lineNum">    2940 </span>            :                 ast_mutex_unlock(&amp;sendvms-&gt;lock);
<span class="lineNum">    2941 </span>            :                 return 0;
<span class="lineNum">    2942 </span>            :         }
<span class="lineNum">    2943 </span>            :         ast_mutex_unlock(&amp;sendvms-&gt;lock);
<span class="lineNum">    2944 </span>            :         ast_log(LOG_WARNING, &quot;Unable to copy message from mailbox %s to mailbox %s\n&quot;, vmu-&gt;mailbox, recip-&gt;mailbox);
<span class="lineNum">    2945 </span>            :         return -1;
<span class="lineNum">    2946 </span>            : }
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span>            : static void imap_mailbox_name(char *spec, size_t len, struct vm_state *vms, int box, int use_folder)
<span class="lineNum">    2949 </span>            : {
<span class="lineNum">    2950 </span>            :         char tmp[256], *t = tmp;
<span class="lineNum">    2951 </span>            :         size_t left = sizeof(tmp);
<span class="lineNum">    2952 </span>            : 
<span class="lineNum">    2953 </span>            :         if (box == OLD_FOLDER) {
<span class="lineNum">    2954 </span>            :                 ast_copy_string(vms-&gt;curbox, mbox(NULL, NEW_FOLDER), sizeof(vms-&gt;curbox));
<span class="lineNum">    2955 </span>            :         } else {
<span class="lineNum">    2956 </span>            :                 ast_copy_string(vms-&gt;curbox, mbox(NULL, box), sizeof(vms-&gt;curbox));
<span class="lineNum">    2957 </span>            :         }
<span class="lineNum">    2958 </span>            : 
<span class="lineNum">    2959 </span>            :         if (box == NEW_FOLDER) {
<span class="lineNum">    2960 </span>            :                 ast_copy_string(vms-&gt;vmbox, &quot;vm-INBOX&quot;, sizeof(vms-&gt;vmbox));
<span class="lineNum">    2961 </span>            :         } else {
<span class="lineNum">    2962 </span>            :                 snprintf(vms-&gt;vmbox, sizeof(vms-&gt;vmbox), &quot;vm-%s&quot;, mbox(NULL, box));
<span class="lineNum">    2963 </span>            :         }
<span class="lineNum">    2964 </span>            : 
<span class="lineNum">    2965 </span>            :         /* Build up server information */
<span class="lineNum">    2966 </span>            :         ast_build_string(&amp;t, &amp;left, &quot;{%s:%s/imap&quot;, S_OR(vms-&gt;imapserver, imapserver), S_OR(vms-&gt;imapport, imapport));
<span class="lineNum">    2967 </span>            : 
<span class="lineNum">    2968 </span>            :         /* Add authentication user if present */
<span class="lineNum">    2969 </span>            :         if (!ast_strlen_zero(authuser))
<span class="lineNum">    2970 </span>            :                 ast_build_string(&amp;t, &amp;left, &quot;/authuser=%s&quot;, authuser);
<span class="lineNum">    2971 </span>            : 
<span class="lineNum">    2972 </span>            :         /* Add flags if present */
<span class="lineNum">    2973 </span>            :         if (!ast_strlen_zero(imapflags) || !(ast_strlen_zero(vms-&gt;imapflags))) {
<span class="lineNum">    2974 </span>            :                 ast_build_string(&amp;t, &amp;left, &quot;/%s&quot;, S_OR(vms-&gt;imapflags, imapflags));
<span class="lineNum">    2975 </span>            :         }
<span class="lineNum">    2976 </span>            : 
<span class="lineNum">    2977 </span>            :         /* End with username */
<span class="lineNum">    2978 </span>            : #if 1
<span class="lineNum">    2979 </span>            :         ast_build_string(&amp;t, &amp;left, &quot;/user=%s}&quot;, vms-&gt;imapuser);
<span class="lineNum">    2980 </span>            : #else
<span class="lineNum">    2981 </span>            :         ast_build_string(&amp;t, &amp;left, &quot;/user=%s/novalidate-cert}&quot;, vms-&gt;imapuser);
<span class="lineNum">    2982 </span>            : #endif
<span class="lineNum">    2983 </span>            :         if (box == NEW_FOLDER || box == OLD_FOLDER)
<span class="lineNum">    2984 </span>            :                 snprintf(spec, len, &quot;%s%s&quot;, tmp, use_folder? vms-&gt;imapfolder: &quot;INBOX&quot;);
<span class="lineNum">    2985 </span>            :         else if (box == GREETINGS_FOLDER)
<span class="lineNum">    2986 </span>            :                 snprintf(spec, len, &quot;%s%s&quot;, tmp, greetingfolder);
<span class="lineNum">    2987 </span>            :         else {  /* Other folders such as Friends, Family, etc... */
<span class="lineNum">    2988 </span>            :                 if (!ast_strlen_zero(imapparentfolder)) {
<span class="lineNum">    2989 </span>            :                         /* imapparentfolder would typically be set to INBOX */
<span class="lineNum">    2990 </span>            :                         snprintf(spec, len, &quot;%s%s%c%s&quot;, tmp, imapparentfolder, delimiter, mbox(NULL, box));
<span class="lineNum">    2991 </span>            :                 } else {
<span class="lineNum">    2992 </span>            :                         snprintf(spec, len, &quot;%s%s&quot;, tmp, mbox(NULL, box));
<span class="lineNum">    2993 </span>            :                 }
<span class="lineNum">    2994 </span>            :         }
<span class="lineNum">    2995 </span>            : }
<span class="lineNum">    2996 </span>            : 
<span class="lineNum">    2997 </span>            : static int init_mailstream(struct vm_state *vms, int box)
<span class="lineNum">    2998 </span>            : {
<span class="lineNum">    2999 </span>            :         MAILSTREAM *stream = NIL;
<span class="lineNum">    3000 </span>            :         long debug;
<span class="lineNum">    3001 </span>            :         char tmp[256];
<span class="lineNum">    3002 </span>            : 
<span class="lineNum">    3003 </span>            :         if (!vms) {
<span class="lineNum">    3004 </span>            :                 ast_log(LOG_ERROR, &quot;vm_state is NULL!\n&quot;);
<span class="lineNum">    3005 </span>            :                 return -1;
<span class="lineNum">    3006 </span>            :         }
<span class="lineNum">    3007 </span>            :         ast_debug(3, &quot;vm_state user is:%s\n&quot;, vms-&gt;imapuser);
<span class="lineNum">    3008 </span>            :         if (vms-&gt;mailstream == NIL || !vms-&gt;mailstream) {
<span class="lineNum">    3009 </span>            :                 ast_debug(1, &quot;mailstream not set.\n&quot;);
<span class="lineNum">    3010 </span>            :         } else {
<span class="lineNum">    3011 </span>            :                 stream = vms-&gt;mailstream;
<span class="lineNum">    3012 </span>            :         }
<span class="lineNum">    3013 </span>            :         /* debug = T;  user wants protocol telemetry? */
<span class="lineNum">    3014 </span>            :         debug = NIL;  /* NO protocol telemetry? */
<span class="lineNum">    3015 </span>            : 
<span class="lineNum">    3016 </span>            :         if (delimiter == '\0') {                /* did not probe the server yet */
<span class="lineNum">    3017 </span>            :                 char *cp;
<span class="lineNum">    3018 </span>            : #ifdef USE_SYSTEM_IMAP
<span class="lineNum">    3019 </span>            : #include &lt;imap/linkage.c&gt;
<span class="lineNum">    3020 </span>            : #elif defined(USE_SYSTEM_CCLIENT)
<span class="lineNum">    3021 </span>            : #include &lt;c-client/linkage.c&gt;
<span class="lineNum">    3022 </span>            : #else
<span class="lineNum">    3023 </span>            : #include &quot;linkage.c&quot;
<span class="lineNum">    3024 </span>            : #endif
<span class="lineNum">    3025 </span>            :                 /* Connect to INBOX first to get folders delimiter */
<span class="lineNum">    3026 </span>            :                 imap_mailbox_name(tmp, sizeof(tmp), vms, 0, 1);
<span class="lineNum">    3027 </span>            :                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    3028 </span>            :                 ast_mutex_lock(&amp;mail_open_lock);
<span class="lineNum">    3029 </span>            :                 stream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);
<span class="lineNum">    3030 </span>            :                 ast_mutex_unlock(&amp;mail_open_lock);
<span class="lineNum">    3031 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3032 </span>            :                 if (stream == NIL) {
<span class="lineNum">    3033 </span>            :                         ast_log(LOG_ERROR, &quot;Can't connect to imap server %s\n&quot;, tmp);
<span class="lineNum">    3034 </span>            :                         return -1;
<span class="lineNum">    3035 </span>            :                 }
<span class="lineNum">    3036 </span>            :                 get_mailbox_delimiter(vms, stream);
<span class="lineNum">    3037 </span>            :                 /* update delimiter in imapfolder */
<span class="lineNum">    3038 </span>            :                 for (cp = vms-&gt;imapfolder; *cp; cp++)
<span class="lineNum">    3039 </span>            :                         if (*cp == '/')
<span class="lineNum">    3040 </span>            :                                 *cp = delimiter;
<span class="lineNum">    3041 </span>            :         }
<span class="lineNum">    3042 </span>            :         /* Now connect to the target folder */
<span class="lineNum">    3043 </span>            :         imap_mailbox_name(tmp, sizeof(tmp), vms, box, 1);
<span class="lineNum">    3044 </span>            :         ast_debug(3, &quot;Before mail_open, server: %s, box:%d\n&quot;, tmp, box);
<span class="lineNum">    3045 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    3046 </span>            :         ast_mutex_lock(&amp;mail_open_lock);
<span class="lineNum">    3047 </span>            :         vms-&gt;mailstream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);
<span class="lineNum">    3048 </span>            :         /* Create the folder if it dosn't exist */
<span class="lineNum">    3049 </span>            :         if (vms-&gt;mailstream &amp;&amp; !mail_status(vms-&gt;mailstream, tmp, SA_UIDNEXT)) {
<span class="lineNum">    3050 </span>            :                 mail_create(vms-&gt;mailstream, tmp);
<span class="lineNum">    3051 </span>            :         }
<span class="lineNum">    3052 </span>            :         ast_mutex_unlock(&amp;mail_open_lock);
<span class="lineNum">    3053 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3054 </span>            :         if (vms-&gt;mailstream == NIL) {
<span class="lineNum">    3055 </span>            :                 return -1;
<span class="lineNum">    3056 </span>            :         } else {
<span class="lineNum">    3057 </span>            :                 return 0;
<span class="lineNum">    3058 </span>            :         }
<span class="lineNum">    3059 </span>            : }
<span class="lineNum">    3060 </span>            : 
<span class="lineNum">    3061 </span>            : static int open_mailbox(struct vm_state *vms, struct ast_vm_user *vmu, int box)
<span class="lineNum">    3062 </span>            : {
<span class="lineNum">    3063 </span>            :         SEARCHPGM *pgm;
<span class="lineNum">    3064 </span>            :         SEARCHHEADER *hdr;
<span class="lineNum">    3065 </span>            :         int urgent = 0;
<span class="lineNum">    3066 </span>            : 
<span class="lineNum">    3067 </span>            :         /* If Urgent, then look at INBOX */
<span class="lineNum">    3068 </span>            :         if (box == 11) {
<span class="lineNum">    3069 </span>            :                 box = NEW_FOLDER;
<span class="lineNum">    3070 </span>            :                 urgent = 1;
<span class="lineNum">    3071 </span>            :         }
<span class="lineNum">    3072 </span>            : 
<span class="lineNum">    3073 </span>            :         ast_copy_string(vms-&gt;imapuser, vmu-&gt;imapuser, sizeof(vms-&gt;imapuser));
<span class="lineNum">    3074 </span>            :         ast_copy_string(vms-&gt;imapfolder, vmu-&gt;imapfolder, sizeof(vms-&gt;imapfolder));
<span class="lineNum">    3075 </span>            :         ast_copy_string(vms-&gt;imapserver, vmu-&gt;imapserver, sizeof(vms-&gt;imapserver));
<span class="lineNum">    3076 </span>            :         ast_copy_string(vms-&gt;imapport, vmu-&gt;imapport, sizeof(vms-&gt;imapport));
<span class="lineNum">    3077 </span>            :         ast_copy_string(vms-&gt;imapflags, vmu-&gt;imapflags, sizeof(vms-&gt;imapflags));
<span class="lineNum">    3078 </span>            :         vms-&gt;imapversion = vmu-&gt;imapversion;
<span class="lineNum">    3079 </span>            :         ast_debug(3, &quot;Before init_mailstream, user is %s\n&quot;, vmu-&gt;imapuser);
<span class="lineNum">    3080 </span>            : 
<span class="lineNum">    3081 </span>            :         if (init_mailstream(vms, box) || !vms-&gt;mailstream) {
<span class="lineNum">    3082 </span>            :                 ast_log(AST_LOG_ERROR, &quot;Could not initialize mailstream\n&quot;);
<span class="lineNum">    3083 </span>            :                 return -1;
<span class="lineNum">    3084 </span>            :         }
<span class="lineNum">    3085 </span>            : 
<span class="lineNum">    3086 </span>            :         create_dirpath(vms-&gt;curdir, sizeof(vms-&gt;curdir), vmu-&gt;context, vms-&gt;username, vms-&gt;curbox);
<span class="lineNum">    3087 </span>            : 
<span class="lineNum">    3088 </span>            :         /* Check Quota */
<span class="lineNum">    3089 </span>            :         if  (box == 0)  {
<span class="lineNum">    3090 </span>            :                 ast_debug(3, &quot;Mailbox name set to: %s, about to check quotas\n&quot;, mbox(vmu, box));
<span class="lineNum">    3091 </span>            :                 check_quota(vms, (char *) mbox(vmu, box));
<span class="lineNum">    3092 </span>            :         }
<span class="lineNum">    3093 </span>            : 
<span class="lineNum">    3094 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    3095 </span>            :         pgm = mail_newsearchpgm();
<span class="lineNum">    3096 </span>            : 
<span class="lineNum">    3097 </span>            :         /* Check IMAP folder for Asterisk messages only... */
<span class="lineNum">    3098 </span>            :         hdr = mail_newsearchheader(&quot;X-Asterisk-VM-Extension&quot;, (!ast_strlen_zero(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : vmu-&gt;mailbox));
<span class="lineNum">    3099 </span>            :         hdr-&gt;next = mail_newsearchheader(&quot;X-Asterisk-VM-Context&quot;, vmu-&gt;context);
<span class="lineNum">    3100 </span>            :         pgm-&gt;header = hdr;
<span class="lineNum">    3101 </span>            :         pgm-&gt;deleted = 0;
<span class="lineNum">    3102 </span>            :         pgm-&gt;undeleted = 1;
<span class="lineNum">    3103 </span>            : 
<span class="lineNum">    3104 </span>            :         /* if box = NEW_FOLDER, check for new, if box = OLD_FOLDER, check for read */
<span class="lineNum">    3105 </span>            :         if (box == NEW_FOLDER &amp;&amp; urgent == 1) {
<span class="lineNum">    3106 </span>            :                 pgm-&gt;unseen = 1;
<span class="lineNum">    3107 </span>            :                 pgm-&gt;seen = 0;
<span class="lineNum">    3108 </span>            :                 pgm-&gt;flagged = 1;
<span class="lineNum">    3109 </span>            :                 pgm-&gt;unflagged = 0;
<span class="lineNum">    3110 </span>            :         } else if (box == NEW_FOLDER &amp;&amp; urgent == 0) {
<span class="lineNum">    3111 </span>            :                 pgm-&gt;unseen = 1;
<span class="lineNum">    3112 </span>            :                 pgm-&gt;seen = 0;
<span class="lineNum">    3113 </span>            :                 pgm-&gt;flagged = 0;
<span class="lineNum">    3114 </span>            :                 pgm-&gt;unflagged = 1;
<span class="lineNum">    3115 </span>            :         } else if (box == OLD_FOLDER) {
<span class="lineNum">    3116 </span>            :                 pgm-&gt;seen = 1;
<span class="lineNum">    3117 </span>            :                 pgm-&gt;unseen = 0;
<span class="lineNum">    3118 </span>            :         }
<span class="lineNum">    3119 </span>            : 
<span class="lineNum">    3120 </span>            :         ast_debug(3, &quot;Before mail_search_full, user is %s\n&quot;, vmu-&gt;imapuser);
<span class="lineNum">    3121 </span>            : 
<span class="lineNum">    3122 </span>            :         vms-&gt;vmArrayIndex = 0;
<span class="lineNum">    3123 </span>            :         mail_search_full (vms-&gt;mailstream, NULL, pgm, NIL);
<span class="lineNum">    3124 </span>            :         vms-&gt;lastmsg = vms-&gt;vmArrayIndex - 1;
<span class="lineNum">    3125 </span>            :         mail_free_searchpgm(&amp;pgm);
<span class="lineNum">    3126 </span>            :         /* Since IMAP storage actually stores both old and new messages in the same IMAP folder,
<span class="lineNum">    3127 </span>            :          * ensure to allocate enough space to account for all of them. Warn if old messages
<span class="lineNum">    3128 </span>            :          * have not been checked first as that is required.
<span class="lineNum">    3129 </span>            :          */
<span class="lineNum">    3130 </span>            :         if (box == 0 &amp;&amp; !vms-&gt;dh_arraysize) {
<span class="lineNum">    3131 </span>            :                 ast_log(LOG_WARNING, &quot;The code expects the old messages to be checked first, fix the code.\n&quot;);
<span class="lineNum">    3132 </span>            :         }
<span class="lineNum">    3133 </span>            :         if (vm_allocate_dh(vms, vmu, box == 0 ? vms-&gt;vmArrayIndex + vms-&gt;oldmessages : vms-&gt;lastmsg)) {
<span class="lineNum">    3134 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3135 </span>            :                 return -1;
<span class="lineNum">    3136 </span>            :         }
<span class="lineNum">    3137 </span>            : 
<span class="lineNum">    3138 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3139 </span>            :         return 0;
<span class="lineNum">    3140 </span>            : }
<span class="lineNum">    3141 </span>            : 
<span class="lineNum">    3142 </span>            : static void write_file(char *filename, char *buffer, unsigned long len)
<span class="lineNum">    3143 </span>            : {
<span class="lineNum">    3144 </span>            :         FILE *output;
<span class="lineNum">    3145 </span>            : 
<span class="lineNum">    3146 </span>            :         if (!filename || !buffer) {
<span class="lineNum">    3147 </span>            :                 return;
<span class="lineNum">    3148 </span>            :         }
<span class="lineNum">    3149 </span>            : 
<span class="lineNum">    3150 </span>            :         if (!(output = fopen(filename, &quot;w&quot;))) {
<span class="lineNum">    3151 </span>            :                 ast_log(LOG_ERROR, &quot;Unable to open/create file %s: %s\n&quot;, filename, strerror(errno));
<span class="lineNum">    3152 </span>            :                 return;
<span class="lineNum">    3153 </span>            :         }
<span class="lineNum">    3154 </span>            : 
<span class="lineNum">    3155 </span>            :         if (fwrite(buffer, len, 1, output) != 1) {
<span class="lineNum">    3156 </span>            :                 if (ferror(output)) {
<span class="lineNum">    3157 </span>            :                         ast_log(LOG_ERROR, &quot;Short write while writing e-mail body: %s.\n&quot;, strerror(errno));
<span class="lineNum">    3158 </span>            :                 }
<span class="lineNum">    3159 </span>            :         }
<span class="lineNum">    3160 </span>            :         fclose (output);
<span class="lineNum">    3161 </span>            : }
<span class="lineNum">    3162 </span>            : 
<span class="lineNum">    3163 </span>            : static void update_messages_by_imapuser(const char *user, unsigned long number)
<span class="lineNum">    3164 </span>            : {
<span class="lineNum">    3165 </span>            :         struct vm_state *vms = get_vm_state_by_imapuser(user, 1);
<span class="lineNum">    3166 </span>            : 
<span class="lineNum">    3167 </span>            :         if (!vms &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0))) {
<span class="lineNum">    3168 </span>            :                 return;
<span class="lineNum">    3169 </span>            :         }
<span class="lineNum">    3170 </span>            : 
<span class="lineNum">    3171 </span>            :         ast_debug(3, &quot;saving mailbox message number %lu as message %d. Interactive set to %d\n&quot;, number, vms-&gt;vmArrayIndex, vms-&gt;interactive);
<span class="lineNum">    3172 </span>            : 
<span class="lineNum">    3173 </span>            :         /* Ensure we have room for the next message. */
<span class="lineNum">    3174 </span>            :         if (vms-&gt;vmArrayIndex &gt;= vms-&gt;msg_array_max) {
<span class="lineNum">    3175 </span>            :                 long *new_mem = ast_realloc(vms-&gt;msgArray, 2 * vms-&gt;msg_array_max * sizeof(long));
<span class="lineNum">    3176 </span>            :                 if (!new_mem) {
<span class="lineNum">    3177 </span>            :                         return;
<span class="lineNum">    3178 </span>            :                 }
<span class="lineNum">    3179 </span>            :                 vms-&gt;msgArray = new_mem;
<span class="lineNum">    3180 </span>            :                 vms-&gt;msg_array_max *= 2;
<span class="lineNum">    3181 </span>            :         }
<span class="lineNum">    3182 </span>            : 
<span class="lineNum">    3183 </span>            :         vms-&gt;msgArray[vms-&gt;vmArrayIndex++] = number;
<span class="lineNum">    3184 </span>            : }
<span class="lineNum">    3185 </span>            : 
<span class="lineNum">    3186 </span>            : void mm_searched(MAILSTREAM *stream, unsigned long number)
<span class="lineNum">    3187 </span>            : {
<span class="lineNum">    3188 </span>            :         char *mailbox = stream-&gt;mailbox, buf[1024] = &quot;&quot;, *user;
<span class="lineNum">    3189 </span>            : 
<span class="lineNum">    3190 </span>            :         if (!(user = get_user_by_mailbox(mailbox, buf, sizeof(buf))))
<span class="lineNum">    3191 </span>            :                 return;
<span class="lineNum">    3192 </span>            : 
<span class="lineNum">    3193 </span>            :         update_messages_by_imapuser(user, number);
<span class="lineNum">    3194 </span>            : }
<span class="lineNum">    3195 </span>            : 
<span class="lineNum">    3196 </span>            : static struct ast_vm_user *find_user_realtime_imapuser(const char *imapuser)
<span class="lineNum">    3197 </span>            : {
<span class="lineNum">    3198 </span>            :         struct ast_variable *var;
<span class="lineNum">    3199 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">    3200 </span>            : 
<span class="lineNum">    3201 </span>            :         vmu = ast_calloc(1, sizeof *vmu);
<span class="lineNum">    3202 </span>            :         if (!vmu)
<span class="lineNum">    3203 </span>            :                 return NULL;
<span class="lineNum">    3204 </span>            : 
<span class="lineNum">    3205 </span>            :         populate_defaults(vmu);
<span class="lineNum">    3206 </span>            :         ast_set_flag(vmu, VM_ALLOCED);
<span class="lineNum">    3207 </span>            : 
<span class="lineNum">    3208 </span>            :         var = ast_load_realtime(&quot;voicemail&quot;, &quot;imapuser&quot;, imapuser, NULL);
<span class="lineNum">    3209 </span>            :         if (var) {
<span class="lineNum">    3210 </span>            :                 apply_options_full(vmu, var);
<span class="lineNum">    3211 </span>            :                 ast_variables_destroy(var);
<span class="lineNum">    3212 </span>            :                 return vmu;
<span class="lineNum">    3213 </span>            :         } else {
<span class="lineNum">    3214 </span>            :                 ast_free(vmu);
<span class="lineNum">    3215 </span>            :                 return NULL;
<span class="lineNum">    3216 </span>            :         }
<span class="lineNum">    3217 </span>            : }
<span class="lineNum">    3218 </span>            : 
<span class="lineNum">    3219 </span>            : /* Interfaces to C-client */
<span class="lineNum">    3220 </span>            : 
<span class="lineNum">    3221 </span>            : void mm_exists(MAILSTREAM * stream, unsigned long number)
<span class="lineNum">    3222 </span>            : {
<span class="lineNum">    3223 </span>            :         /* mail_ping will callback here if new mail! */
<span class="lineNum">    3224 </span>            :         ast_debug(4, &quot;Entering EXISTS callback for message %ld\n&quot;, number);
<span class="lineNum">    3225 </span>            :         if (number == 0) return;
<span class="lineNum">    3226 </span>            :         set_update(stream);
<span class="lineNum">    3227 </span>            : }
<span class="lineNum">    3228 </span>            : 
<span class="lineNum">    3229 </span>            : 
<span class="lineNum">    3230 </span>            : void mm_expunged(MAILSTREAM * stream, unsigned long number)
<span class="lineNum">    3231 </span>            : {
<span class="lineNum">    3232 </span>            :         /* mail_ping will callback here if expunged mail! */
<span class="lineNum">    3233 </span>            :         ast_debug(4, &quot;Entering EXPUNGE callback for message %ld\n&quot;, number);
<span class="lineNum">    3234 </span>            :         if (number == 0) return;
<span class="lineNum">    3235 </span>            :         set_update(stream);
<span class="lineNum">    3236 </span>            : }
<span class="lineNum">    3237 </span>            : 
<span class="lineNum">    3238 </span>            : 
<span class="lineNum">    3239 </span>            : void mm_flags(MAILSTREAM * stream, unsigned long number)
<span class="lineNum">    3240 </span>            : {
<span class="lineNum">    3241 </span>            :         /* mail_ping will callback here if read mail! */
<span class="lineNum">    3242 </span>            :         ast_debug(4, &quot;Entering FLAGS callback for message %ld\n&quot;, number);
<span class="lineNum">    3243 </span>            :         if (number == 0) return;
<span class="lineNum">    3244 </span>            :         set_update(stream);
<span class="lineNum">    3245 </span>            : }
<span class="lineNum">    3246 </span>            : 
<span class="lineNum">    3247 </span>            : 
<span class="lineNum">    3248 </span>            : void mm_notify(MAILSTREAM * stream, char *string, long errflg)
<span class="lineNum">    3249 </span>            : {
<span class="lineNum">    3250 </span>            :         ast_debug(5, &quot;Entering NOTIFY callback, errflag is %ld, string is %s\n&quot;, errflg, string);
<span class="lineNum">    3251 </span>            :         mm_log (string, errflg);
<span class="lineNum">    3252 </span>            : }
<span class="lineNum">    3253 </span>            : 
<span class="lineNum">    3254 </span>            : 
<span class="lineNum">    3255 </span>            : void mm_list(MAILSTREAM * stream, int delim, char *mailbox, long attributes)
<span class="lineNum">    3256 </span>            : {
<span class="lineNum">    3257 </span>            :         if (delimiter == '\0') {
<span class="lineNum">    3258 </span>            :                 delimiter = delim;
<span class="lineNum">    3259 </span>            :         }
<span class="lineNum">    3260 </span>            : 
<span class="lineNum">    3261 </span>            :         ast_debug(5, &quot;Delimiter set to %c and mailbox %s\n&quot;, delim, mailbox);
<span class="lineNum">    3262 </span>            :         if (attributes &amp; LATT_NOINFERIORS)
<span class="lineNum">    3263 </span>            :                 ast_debug(5, &quot;no inferiors\n&quot;);
<span class="lineNum">    3264 </span>            :         if (attributes &amp; LATT_NOSELECT)
<span class="lineNum">    3265 </span>            :                 ast_debug(5, &quot;no select\n&quot;);
<span class="lineNum">    3266 </span>            :         if (attributes &amp; LATT_MARKED)
<span class="lineNum">    3267 </span>            :                 ast_debug(5, &quot;marked\n&quot;);
<span class="lineNum">    3268 </span>            :         if (attributes &amp; LATT_UNMARKED)
<span class="lineNum">    3269 </span>            :                 ast_debug(5, &quot;unmarked\n&quot;);
<span class="lineNum">    3270 </span>            : }
<span class="lineNum">    3271 </span>            : 
<span class="lineNum">    3272 </span>            : 
<span class="lineNum">    3273 </span>            : void mm_lsub(MAILSTREAM * stream, int delim, char *mailbox, long attributes)
<span class="lineNum">    3274 </span>            : {
<span class="lineNum">    3275 </span>            :         ast_debug(5, &quot;Delimiter set to %c and mailbox %s\n&quot;, delim, mailbox);
<span class="lineNum">    3276 </span>            :         if (attributes &amp; LATT_NOINFERIORS)
<span class="lineNum">    3277 </span>            :                 ast_debug(5, &quot;no inferiors\n&quot;);
<span class="lineNum">    3278 </span>            :         if (attributes &amp; LATT_NOSELECT)
<span class="lineNum">    3279 </span>            :                 ast_debug(5, &quot;no select\n&quot;);
<span class="lineNum">    3280 </span>            :         if (attributes &amp; LATT_MARKED)
<span class="lineNum">    3281 </span>            :                 ast_debug(5, &quot;marked\n&quot;);
<span class="lineNum">    3282 </span>            :         if (attributes &amp; LATT_UNMARKED)
<span class="lineNum">    3283 </span>            :                 ast_debug(5, &quot;unmarked\n&quot;);
<span class="lineNum">    3284 </span>            : }
<span class="lineNum">    3285 </span>            : 
<span class="lineNum">    3286 </span>            : 
<span class="lineNum">    3287 </span>            : void mm_status(MAILSTREAM * stream, char *mailbox, MAILSTATUS * status)
<span class="lineNum">    3288 </span>            : {
<span class="lineNum">    3289 </span>            :         struct ast_str *str;
<span class="lineNum">    3290 </span>            : 
<span class="lineNum">    3291 </span>            :         if (!DEBUG_ATLEAST(5) || !(str = ast_str_create(256))) {
<span class="lineNum">    3292 </span>            :             return;
<span class="lineNum">    3293 </span>            :         }
<span class="lineNum">    3294 </span>            : 
<span class="lineNum">    3295 </span>            :         ast_str_append(&amp;str, 0, &quot; Mailbox %s&quot;, mailbox);
<span class="lineNum">    3296 </span>            :         if (status-&gt;flags &amp; SA_MESSAGES) {
<span class="lineNum">    3297 </span>            :                 ast_str_append(&amp;str, 0, &quot;, %lu messages&quot;, status-&gt;messages);
<span class="lineNum">    3298 </span>            :         }
<span class="lineNum">    3299 </span>            :         if (status-&gt;flags &amp; SA_RECENT) {
<span class="lineNum">    3300 </span>            :                 ast_str_append(&amp;str, 0, &quot;, %lu recent&quot;, status-&gt;recent);
<span class="lineNum">    3301 </span>            :         }
<span class="lineNum">    3302 </span>            :         if (status-&gt;flags &amp; SA_UNSEEN) {
<span class="lineNum">    3303 </span>            :                 ast_str_append(&amp;str, 0, &quot;, %lu unseen&quot;, status-&gt;unseen);
<span class="lineNum">    3304 </span>            :         }
<span class="lineNum">    3305 </span>            :         if (status-&gt;flags &amp; SA_UIDVALIDITY) {
<span class="lineNum">    3306 </span>            :                 ast_str_append(&amp;str, 0, &quot;, %lu UID validity&quot;, status-&gt;uidvalidity);
<span class="lineNum">    3307 </span>            :         }
<span class="lineNum">    3308 </span>            :         if (status-&gt;flags &amp; SA_UIDNEXT) {
<span class="lineNum">    3309 </span>            :                 ast_str_append(&amp;str, 0, &quot;, %lu next UID&quot;, status-&gt;uidnext);
<span class="lineNum">    3310 </span>            :         }
<span class="lineNum">    3311 </span>            :         ast_log(LOG_DEBUG, &quot;%s\n&quot;, ast_str_buffer(str));
<span class="lineNum">    3312 </span>            : 
<span class="lineNum">    3313 </span>            :         ast_free(str);
<span class="lineNum">    3314 </span>            : }
<span class="lineNum">    3315 </span>            : 
<span class="lineNum">    3316 </span>            : 
<span class="lineNum">    3317 </span>            : void mm_log(char *string, long errflg)
<span class="lineNum">    3318 </span>            : {
<span class="lineNum">    3319 </span>            :         switch ((short) errflg) {
<span class="lineNum">    3320 </span>            :                 case NIL:
<span class="lineNum">    3321 </span>            :                         ast_debug(1, &quot;IMAP Info: %s\n&quot;, string);
<span class="lineNum">    3322 </span>            :                         break;
<span class="lineNum">    3323 </span>            :                 case PARSE:
<span class="lineNum">    3324 </span>            :                 case WARN:
<span class="lineNum">    3325 </span>            :                         ast_log(AST_LOG_WARNING, &quot;IMAP Warning: %s\n&quot;, string);
<span class="lineNum">    3326 </span>            :                         break;
<span class="lineNum">    3327 </span>            :                 case ERROR:
<span class="lineNum">    3328 </span>            :                         ast_log(AST_LOG_ERROR, &quot;IMAP Error: %s\n&quot;, string);
<span class="lineNum">    3329 </span>            :                         break;
<span class="lineNum">    3330 </span>            :         }
<span class="lineNum">    3331 </span>            : }
<span class="lineNum">    3332 </span>            : 
<span class="lineNum">    3333 </span>            : 
<span class="lineNum">    3334 </span>            : void mm_dlog(char *string)
<span class="lineNum">    3335 </span>            : {
<span class="lineNum">    3336 </span>            :         ast_log(AST_LOG_NOTICE, &quot;%s\n&quot;, string);
<span class="lineNum">    3337 </span>            : }
<span class="lineNum">    3338 </span>            : 
<span class="lineNum">    3339 </span>            : 
<span class="lineNum">    3340 </span>            : void mm_login(NETMBX * mb, char *user, char *pwd, long trial)
<span class="lineNum">    3341 </span>            : {
<span class="lineNum">    3342 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">    3343 </span>            : 
<span class="lineNum">    3344 </span>            :         ast_debug(4, &quot;Entering callback mm_login\n&quot;);
<span class="lineNum">    3345 </span>            : 
<span class="lineNum">    3346 </span>            :         ast_copy_string(user, mb-&gt;user, MAILTMPLEN);
<span class="lineNum">    3347 </span>            : 
<span class="lineNum">    3348 </span>            :         /* We should only do this when necessary */
<span class="lineNum">    3349 </span>            :         if (!ast_strlen_zero(authpassword)) {
<span class="lineNum">    3350 </span>            :                 ast_copy_string(pwd, authpassword, MAILTMPLEN);
<span class="lineNum">    3351 </span>            :         } else {
<span class="lineNum">    3352 </span>            :                 AST_LIST_TRAVERSE(&amp;users, vmu, list) {
<span class="lineNum">    3353 </span>            :                         if (!strcasecmp(mb-&gt;user, vmu-&gt;imapuser)) {
<span class="lineNum">    3354 </span>            :                                 ast_copy_string(pwd, vmu-&gt;imappassword, MAILTMPLEN);
<span class="lineNum">    3355 </span>            :                                 break;
<span class="lineNum">    3356 </span>            :                         }
<span class="lineNum">    3357 </span>            :                 }
<span class="lineNum">    3358 </span>            :                 if (!vmu) {
<span class="lineNum">    3359 </span>            :                         if ((vmu = find_user_realtime_imapuser(mb-&gt;user))) {
<span class="lineNum">    3360 </span>            :                                 ast_copy_string(pwd, vmu-&gt;imappassword, MAILTMPLEN);
<span class="lineNum">    3361 </span>            :                                 free_user(vmu);
<span class="lineNum">    3362 </span>            :                         }
<span class="lineNum">    3363 </span>            :                 }
<span class="lineNum">    3364 </span>            :         }
<span class="lineNum">    3365 </span>            : }
<span class="lineNum">    3366 </span>            : 
<span class="lineNum">    3367 </span>            : 
<span class="lineNum">    3368 </span>            : void mm_critical(MAILSTREAM * stream)
<span class="lineNum">    3369 </span>            : {
<span class="lineNum">    3370 </span>            : }
<span class="lineNum">    3371 </span>            : 
<span class="lineNum">    3372 </span>            : 
<span class="lineNum">    3373 </span>            : void mm_nocritical(MAILSTREAM * stream)
<span class="lineNum">    3374 </span>            : {
<span class="lineNum">    3375 </span>            : }
<span class="lineNum">    3376 </span>            : 
<span class="lineNum">    3377 </span>            : 
<span class="lineNum">    3378 </span>            : long mm_diskerror(MAILSTREAM * stream, long errcode, long serious)
<span class="lineNum">    3379 </span>            : {
<span class="lineNum">    3380 </span>            :         kill (getpid (), SIGSTOP);
<span class="lineNum">    3381 </span>            :         return NIL;
<span class="lineNum">    3382 </span>            : }
<span class="lineNum">    3383 </span>            : 
<span class="lineNum">    3384 </span>            : 
<span class="lineNum">    3385 </span>            : void mm_fatal(char *string)
<span class="lineNum">    3386 </span>            : {
<span class="lineNum">    3387 </span>            :         ast_log(AST_LOG_ERROR, &quot;IMAP access FATAL error: %s\n&quot;, string);
<span class="lineNum">    3388 </span>            : }
<span class="lineNum">    3389 </span>            : 
<span class="lineNum">    3390 </span>            : /* C-client callback to handle quota */
<span class="lineNum">    3391 </span>            : static void mm_parsequota(MAILSTREAM *stream, unsigned char *msg, QUOTALIST *pquota)
<span class="lineNum">    3392 </span>            : {
<span class="lineNum">    3393 </span>            :         struct vm_state *vms;
<span class="lineNum">    3394 </span>            :         char *mailbox = stream-&gt;mailbox, *user;
<span class="lineNum">    3395 </span>            :         char buf[1024] = &quot;&quot;;
<span class="lineNum">    3396 </span>            :         unsigned long usage = 0, limit = 0;
<span class="lineNum">    3397 </span>            : 
<span class="lineNum">    3398 </span>            :         while (pquota) {
<span class="lineNum">    3399 </span>            :                 usage = pquota-&gt;usage;
<span class="lineNum">    3400 </span>            :                 limit = pquota-&gt;limit;
<span class="lineNum">    3401 </span>            :                 pquota = pquota-&gt;next;
<span class="lineNum">    3402 </span>            :         }
<span class="lineNum">    3403 </span>            : 
<span class="lineNum">    3404 </span>            :         if (!(user = get_user_by_mailbox(mailbox, buf, sizeof(buf))) || (!(vms = get_vm_state_by_imapuser(user, 2)) &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0)))) {
<span class="lineNum">    3405 </span>            :                 ast_log(AST_LOG_ERROR, &quot;No state found.\n&quot;);
<span class="lineNum">    3406 </span>            :                 return;
<span class="lineNum">    3407 </span>            :         }
<span class="lineNum">    3408 </span>            : 
<span class="lineNum">    3409 </span>            :         ast_debug(3, &quot;User %s usage is %lu, limit is %lu\n&quot;, user, usage, limit);
<span class="lineNum">    3410 </span>            : 
<span class="lineNum">    3411 </span>            :         vms-&gt;quota_usage = usage;
<span class="lineNum">    3412 </span>            :         vms-&gt;quota_limit = limit;
<span class="lineNum">    3413 </span>            : }
<span class="lineNum">    3414 </span>            : 
<span class="lineNum">    3415 </span>            : static char *get_header_by_tag(char *header, char *tag, char *buf, size_t len)
<span class="lineNum">    3416 </span>            : {
<span class="lineNum">    3417 </span>            :         char *start, *eol_pnt;
<span class="lineNum">    3418 </span>            :         int taglen;
<span class="lineNum">    3419 </span>            : 
<span class="lineNum">    3420 </span>            :         if (ast_strlen_zero(header) || ast_strlen_zero(tag))
<span class="lineNum">    3421 </span>            :                 return NULL;
<span class="lineNum">    3422 </span>            : 
<span class="lineNum">    3423 </span>            :         taglen = strlen(tag) + 1;
<span class="lineNum">    3424 </span>            :         if (taglen &lt; 1)
<span class="lineNum">    3425 </span>            :                 return NULL;
<span class="lineNum">    3426 </span>            : 
<span class="lineNum">    3427 </span>            :         if (!(start = strcasestr(header, tag)))
<span class="lineNum">    3428 </span>            :                 return NULL;
<span class="lineNum">    3429 </span>            : 
<span class="lineNum">    3430 </span>            :         /* Since we can be called multiple times we should clear our buffer */
<span class="lineNum">    3431 </span>            :         memset(buf, 0, len);
<span class="lineNum">    3432 </span>            : 
<span class="lineNum">    3433 </span>            :         ast_copy_string(buf, start+taglen, len);
<span class="lineNum">    3434 </span>            :         if ((eol_pnt = strchr(buf,'\r')) || (eol_pnt = strchr(buf,'\n')))
<span class="lineNum">    3435 </span>            :                 *eol_pnt = '\0';
<span class="lineNum">    3436 </span>            :         return buf;
<span class="lineNum">    3437 </span>            : }
<span class="lineNum">    3438 </span>            : 
<span class="lineNum">    3439 </span>            : static char *get_user_by_mailbox(char *mailbox, char *buf, size_t len)
<span class="lineNum">    3440 </span>            : {
<span class="lineNum">    3441 </span>            :         char *start, *eol_pnt, *quote;
<span class="lineNum">    3442 </span>            : 
<span class="lineNum">    3443 </span>            :         if (ast_strlen_zero(mailbox))
<span class="lineNum">    3444 </span>            :                 return NULL;
<span class="lineNum">    3445 </span>            : 
<span class="lineNum">    3446 </span>            :         if (!(start = strstr(mailbox, &quot;/user=&quot;)))
<span class="lineNum">    3447 </span>            :                 return NULL;
<span class="lineNum">    3448 </span>            : 
<span class="lineNum">    3449 </span>            :         ast_copy_string(buf, start+6, len);
<span class="lineNum">    3450 </span>            : 
<span class="lineNum">    3451 </span>            :         if (!(quote = strchr(buf, '&quot;'))) {
<span class="lineNum">    3452 </span>            :                 if ((eol_pnt = strchr(buf, '/')) || (eol_pnt = strchr(buf, '}'))) {
<span class="lineNum">    3453 </span>            :                         *eol_pnt = '\0';
<span class="lineNum">    3454 </span>            :                 }
<span class="lineNum">    3455 </span>            :                 return buf;
<span class="lineNum">    3456 </span>            :         } else {
<span class="lineNum">    3457 </span>            :                 if ((eol_pnt = strchr(quote + 1, '&quot;'))) {
<span class="lineNum">    3458 </span>            :                         *eol_pnt = '\0';
<span class="lineNum">    3459 </span>            :                 }
<span class="lineNum">    3460 </span>            :                 return quote + 1;
<span class="lineNum">    3461 </span>            :         }
<span class="lineNum">    3462 </span>            : }
<span class="lineNum">    3463 </span>            : 
<span class="lineNum">    3464 </span>            : static struct vm_state *create_vm_state_from_user(struct ast_vm_user *vmu)
<span class="lineNum">    3465 </span>            : {
<span class="lineNum">    3466 </span>            :         struct vm_state *vms_p;
<span class="lineNum">    3467 </span>            : 
<span class="lineNum">    3468 </span>            :         pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<span class="lineNum">    3469 </span>            :         if ((vms_p = pthread_getspecific(ts_vmstate.key)) &amp;&amp; !strcmp(vms_p-&gt;imapuser, vmu-&gt;imapuser) &amp;&amp; !strcmp(vms_p-&gt;username, vmu-&gt;mailbox)) {
<span class="lineNum">    3470 </span>            :                 return vms_p;
<span class="lineNum">    3471 </span>            :         }
<span class="lineNum">    3472 </span>            :         ast_debug(5, &quot;Adding new vmstate for %s\n&quot;, vmu-&gt;imapuser);
<span class="lineNum">    3473 </span>            :         /* XXX: Is this correctly freed always? */
<span class="lineNum">    3474 </span>            :         if (!(vms_p = ast_calloc(1, sizeof(*vms_p))))
<span class="lineNum">    3475 </span>            :                 return NULL;
<span class="lineNum">    3476 </span>            :         ast_copy_string(vms_p-&gt;imapuser, vmu-&gt;imapuser, sizeof(vms_p-&gt;imapuser));
<span class="lineNum">    3477 </span>            :         ast_copy_string(vms_p-&gt;imapfolder, vmu-&gt;imapfolder, sizeof(vms_p-&gt;imapfolder));
<span class="lineNum">    3478 </span>            :         ast_copy_string(vms_p-&gt;imapserver, vmu-&gt;imapserver, sizeof(vms_p-&gt;imapserver));
<span class="lineNum">    3479 </span>            :         ast_copy_string(vms_p-&gt;imapport, vmu-&gt;imapport, sizeof(vms_p-&gt;imapport));
<span class="lineNum">    3480 </span>            :         ast_copy_string(vms_p-&gt;imapflags, vmu-&gt;imapflags, sizeof(vms_p-&gt;imapflags));
<span class="lineNum">    3481 </span>            :         ast_copy_string(vms_p-&gt;username, vmu-&gt;mailbox, sizeof(vms_p-&gt;username)); /* save for access from interactive entry point */
<span class="lineNum">    3482 </span>            :         ast_copy_string(vms_p-&gt;context, vmu-&gt;context, sizeof(vms_p-&gt;context));
<span class="lineNum">    3483 </span>            :         vms_p-&gt;mailstream = NIL; /* save for access from interactive entry point */
<span class="lineNum">    3484 </span>            :         vms_p-&gt;imapversion = vmu-&gt;imapversion;
<span class="lineNum">    3485 </span>            :         ast_debug(5, &quot;Copied %s to %s\n&quot;, vmu-&gt;imapuser, vms_p-&gt;imapuser);
<span class="lineNum">    3486 </span>            :         vms_p-&gt;updated = 1;
<span class="lineNum">    3487 </span>            :         /* set mailbox to INBOX! */
<span class="lineNum">    3488 </span>            :         ast_copy_string(vms_p-&gt;curbox, mbox(vmu, 0), sizeof(vms_p-&gt;curbox));
<span class="lineNum">    3489 </span>            :         init_vm_state(vms_p);
<span class="lineNum">    3490 </span>            :         vmstate_insert(vms_p);
<span class="lineNum">    3491 </span>            :         return vms_p;
<span class="lineNum">    3492 </span>            : }
<span class="lineNum">    3493 </span>            : 
<span class="lineNum">    3494 </span>            : static struct vm_state *get_vm_state_by_imapuser(const char *user, int interactive)
<span class="lineNum">    3495 </span>            : {
<span class="lineNum">    3496 </span>            :         struct vmstate *vlist = NULL;
<span class="lineNum">    3497 </span>            : 
<span class="lineNum">    3498 </span>            :         if (interactive) {
<span class="lineNum">    3499 </span>            :                 struct vm_state *vms;
<span class="lineNum">    3500 </span>            :                 pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<span class="lineNum">    3501 </span>            :                 if ((vms = pthread_getspecific(ts_vmstate.key)) &amp;&amp; !strcmp(vms-&gt;imapuser, user)) {
<span class="lineNum">    3502 </span>            :                         return vms;
<span class="lineNum">    3503 </span>            :                 }
<span class="lineNum">    3504 </span>            :         }
<span class="lineNum">    3505 </span>            : 
<span class="lineNum">    3506 </span>            :         AST_LIST_LOCK(&amp;vmstates);
<span class="lineNum">    3507 </span>            :         AST_LIST_TRAVERSE(&amp;vmstates, vlist, list) {
<span class="lineNum">    3508 </span>            :                 if (!vlist-&gt;vms) {
<span class="lineNum">    3509 </span>            :                         ast_debug(3, &quot;error: vms is NULL for %s\n&quot;, user);
<span class="lineNum">    3510 </span>            :                         continue;
<span class="lineNum">    3511 </span>            :                 }
<span class="lineNum">    3512 </span>            :                 if (vlist-&gt;vms-&gt;imapversion != imapversion) {
<span class="lineNum">    3513 </span>            :                         continue;
<span class="lineNum">    3514 </span>            :                 }
<span class="lineNum">    3515 </span>            : 
<span class="lineNum">    3516 </span>            :                 if (!strcmp(vlist-&gt;vms-&gt;imapuser, user) &amp;&amp; (interactive == 2 || vlist-&gt;vms-&gt;interactive == interactive)) {
<span class="lineNum">    3517 </span>            :                         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3518 </span>            :                         return vlist-&gt;vms;
<span class="lineNum">    3519 </span>            :                 }
<span class="lineNum">    3520 </span>            :         }
<span class="lineNum">    3521 </span>            :         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3522 </span>            : 
<span class="lineNum">    3523 </span>            :         ast_debug(3, &quot;%s not found in vmstates\n&quot;, user);
<span class="lineNum">    3524 </span>            : 
<span class="lineNum">    3525 </span>            :         return NULL;
<span class="lineNum">    3526 </span>            : }
<span class="lineNum">    3527 </span>            : 
<span class="lineNum">    3528 </span>            : static struct vm_state *get_vm_state_by_mailbox(const char *mailbox, const char *context, int interactive)
<span class="lineNum">    3529 </span>            : {
<span class="lineNum">    3530 </span>            : 
<span class="lineNum">    3531 </span>            :         struct vmstate *vlist = NULL;
<span class="lineNum">    3532 </span>            :         const char *local_context = S_OR(context, &quot;default&quot;);
<span class="lineNum">    3533 </span>            : 
<span class="lineNum">    3534 </span>            :         if (interactive) {
<span class="lineNum">    3535 </span>            :                 struct vm_state *vms;
<span class="lineNum">    3536 </span>            :                 pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<span class="lineNum">    3537 </span>            :                 if ((vms = pthread_getspecific(ts_vmstate.key)) &amp;&amp;
<span class="lineNum">    3538 </span>            :                     !strcmp(vms-&gt;username,mailbox) &amp;&amp; !strcmp(vms-&gt;context, local_context)) {
<span class="lineNum">    3539 </span>            :                         return vms;
<span class="lineNum">    3540 </span>            :                 }
<span class="lineNum">    3541 </span>            :         }
<span class="lineNum">    3542 </span>            : 
<span class="lineNum">    3543 </span>            :         AST_LIST_LOCK(&amp;vmstates);
<span class="lineNum">    3544 </span>            :         AST_LIST_TRAVERSE(&amp;vmstates, vlist, list) {
<span class="lineNum">    3545 </span>            :                 if (!vlist-&gt;vms) {
<span class="lineNum">    3546 </span>            :                         ast_debug(3, &quot;error: vms is NULL for %s\n&quot;, mailbox);
<span class="lineNum">    3547 </span>            :                         continue;
<span class="lineNum">    3548 </span>            :                 }
<span class="lineNum">    3549 </span>            :                 if (vlist-&gt;vms-&gt;imapversion != imapversion) {
<span class="lineNum">    3550 </span>            :                         continue;
<span class="lineNum">    3551 </span>            :                 }
<span class="lineNum">    3552 </span>            : 
<span class="lineNum">    3553 </span>            :                 ast_debug(3, &quot;comparing mailbox %s@%s (i=%d) to vmstate mailbox %s@%s (i=%d)\n&quot;, mailbox, local_context, interactive, vlist-&gt;vms-&gt;username, vlist-&gt;vms-&gt;context, vlist-&gt;vms-&gt;interactive);
<span class="lineNum">    3554 </span>            : 
<span class="lineNum">    3555 </span>            :                 if (!strcmp(vlist-&gt;vms-&gt;username, mailbox) &amp;&amp; !strcmp(vlist-&gt;vms-&gt;context, local_context) &amp;&amp; vlist-&gt;vms-&gt;interactive == interactive) {
<span class="lineNum">    3556 </span>            :                         ast_debug(3, &quot;Found it!\n&quot;);
<span class="lineNum">    3557 </span>            :                         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3558 </span>            :                         return vlist-&gt;vms;
<span class="lineNum">    3559 </span>            :                 }
<span class="lineNum">    3560 </span>            :         }
<span class="lineNum">    3561 </span>            :         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3562 </span>            : 
<span class="lineNum">    3563 </span>            :         ast_debug(3, &quot;%s not found in vmstates\n&quot;, mailbox);
<span class="lineNum">    3564 </span>            : 
<span class="lineNum">    3565 </span>            :         return NULL;
<span class="lineNum">    3566 </span>            : }
<span class="lineNum">    3567 </span>            : 
<span class="lineNum">    3568 </span>            : static void vmstate_insert(struct vm_state *vms)
<span class="lineNum">    3569 </span>            : {
<span class="lineNum">    3570 </span>            :         struct vmstate *v;
<span class="lineNum">    3571 </span>            :         struct vm_state *altvms;
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span>            :         /* If interactive, it probably already exists, and we should
<span class="lineNum">    3574 </span>            :            use the one we already have since it is more up to date.
<span class="lineNum">    3575 </span>            :            We can compare the username to find the duplicate */
<span class="lineNum">    3576 </span>            :         if (vms-&gt;interactive == 1) {
<span class="lineNum">    3577 </span>            :                 altvms = get_vm_state_by_mailbox(vms-&gt;username, vms-&gt;context, 0);
<span class="lineNum">    3578 </span>            :                 if (altvms) {
<span class="lineNum">    3579 </span>            :                         ast_debug(3, &quot;Duplicate mailbox %s, copying message info...\n&quot;, vms-&gt;username);
<span class="lineNum">    3580 </span>            :                         vms-&gt;newmessages = altvms-&gt;newmessages;
<span class="lineNum">    3581 </span>            :                         vms-&gt;oldmessages = altvms-&gt;oldmessages;
<span class="lineNum">    3582 </span>            :                         vms-&gt;vmArrayIndex = altvms-&gt;vmArrayIndex;
<span class="lineNum">    3583 </span>            :                         /* XXX: no msgArray copying? */
<span class="lineNum">    3584 </span>            :                         vms-&gt;lastmsg = altvms-&gt;lastmsg;
<span class="lineNum">    3585 </span>            :                         vms-&gt;curmsg = altvms-&gt;curmsg;
<span class="lineNum">    3586 </span>            :                         /* get a pointer to the persistent store */
<span class="lineNum">    3587 </span>            :                         vms-&gt;persist_vms = altvms;
<span class="lineNum">    3588 </span>            :                         /* Reuse the mailstream? */
<span class="lineNum">    3589 </span>            : #ifdef REALLY_FAST_EVEN_IF_IT_MEANS_RESOURCE_LEAKS
<span class="lineNum">    3590 </span>            :                         vms-&gt;mailstream = altvms-&gt;mailstream;
<span class="lineNum">    3591 </span>            : #else
<span class="lineNum">    3592 </span>            :                         vms-&gt;mailstream = NIL;
<span class="lineNum">    3593 </span>            : #endif
<span class="lineNum">    3594 </span>            :                 }
<span class="lineNum">    3595 </span>            :                 return;
<span class="lineNum">    3596 </span>            :         }
<span class="lineNum">    3597 </span>            : 
<span class="lineNum">    3598 </span>            :         if (!(v = ast_calloc(1, sizeof(*v))))
<span class="lineNum">    3599 </span>            :                 return;
<span class="lineNum">    3600 </span>            : 
<span class="lineNum">    3601 </span>            :         v-&gt;vms = vms;
<span class="lineNum">    3602 </span>            : 
<span class="lineNum">    3603 </span>            :         ast_debug(3, &quot;Inserting vm_state for user:%s, mailbox %s\n&quot;, vms-&gt;imapuser, vms-&gt;username);
<span class="lineNum">    3604 </span>            : 
<span class="lineNum">    3605 </span>            :         AST_LIST_LOCK(&amp;vmstates);
<span class="lineNum">    3606 </span>            :         AST_LIST_INSERT_TAIL(&amp;vmstates, v, list);
<span class="lineNum">    3607 </span>            :         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3608 </span>            : }
<span class="lineNum">    3609 </span>            : 
<span class="lineNum">    3610 </span>            : static void vmstate_delete(struct vm_state *vms)
<span class="lineNum">    3611 </span>            : {
<span class="lineNum">    3612 </span>            :         struct vmstate *vc = NULL;
<span class="lineNum">    3613 </span>            :         struct vm_state *altvms = NULL;
<span class="lineNum">    3614 </span>            : 
<span class="lineNum">    3615 </span>            :         /* If interactive, we should copy pertinent info
<span class="lineNum">    3616 </span>            :            back to the persistent state (to make update immediate) */
<span class="lineNum">    3617 </span>            :         if (vms-&gt;interactive == 1 &amp;&amp; (altvms = vms-&gt;persist_vms)) {
<span class="lineNum">    3618 </span>            :                 ast_debug(3, &quot;Duplicate mailbox %s, copying message info...\n&quot;, vms-&gt;username);
<span class="lineNum">    3619 </span>            :                 altvms-&gt;newmessages = vms-&gt;newmessages;
<span class="lineNum">    3620 </span>            :                 altvms-&gt;oldmessages = vms-&gt;oldmessages;
<span class="lineNum">    3621 </span>            :                 altvms-&gt;updated = 1;
<span class="lineNum">    3622 </span>            :                 vms-&gt;mailstream = mail_close(vms-&gt;mailstream);
<span class="lineNum">    3623 </span>            : 
<span class="lineNum">    3624 </span>            :                 /* Interactive states are not stored within the persistent list */
<span class="lineNum">    3625 </span>            :                 return;
<span class="lineNum">    3626 </span>            :         }
<span class="lineNum">    3627 </span>            : 
<span class="lineNum">    3628 </span>            :         ast_debug(3, &quot;Removing vm_state for user:%s, mailbox %s\n&quot;, vms-&gt;imapuser, vms-&gt;username);
<span class="lineNum">    3629 </span>            : 
<span class="lineNum">    3630 </span>            :         AST_LIST_LOCK(&amp;vmstates);
<span class="lineNum">    3631 </span>            :         AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;vmstates, vc, list) {
<span class="lineNum">    3632 </span>            :                 if (vc-&gt;vms == vms) {
<span class="lineNum">    3633 </span>            :                         AST_LIST_REMOVE_CURRENT(list);
<span class="lineNum">    3634 </span>            :                         break;
<span class="lineNum">    3635 </span>            :                 }
<span class="lineNum">    3636 </span>            :         }
<span class="lineNum">    3637 </span>            :         AST_LIST_TRAVERSE_SAFE_END
<span class="lineNum">    3638 </span>            :         AST_LIST_UNLOCK(&amp;vmstates);
<span class="lineNum">    3639 </span>            : 
<span class="lineNum">    3640 </span>            :         if (vc) {
<span class="lineNum">    3641 </span>            :                 ast_mutex_destroy(&amp;vc-&gt;vms-&gt;lock);
<span class="lineNum">    3642 </span>            :                 ast_free(vc-&gt;vms-&gt;msgArray);
<span class="lineNum">    3643 </span>            :                 vc-&gt;vms-&gt;msgArray = NULL;
<span class="lineNum">    3644 </span>            :                 vc-&gt;vms-&gt;msg_array_max = 0;
<span class="lineNum">    3645 </span>            :                 /* XXX: is no one supposed to free vms itself? */
<span class="lineNum">    3646 </span>            :                 ast_free(vc);
<span class="lineNum">    3647 </span>            :         } else {
<span class="lineNum">    3648 </span>            :                 ast_log(AST_LOG_ERROR, &quot;No vmstate found for user:%s, mailbox %s\n&quot;, vms-&gt;imapuser, vms-&gt;username);
<span class="lineNum">    3649 </span>            :         }
<span class="lineNum">    3650 </span>            : }
<span class="lineNum">    3651 </span>            : 
<span class="lineNum">    3652 </span>            : static void set_update(MAILSTREAM * stream)
<span class="lineNum">    3653 </span>            : {
<span class="lineNum">    3654 </span>            :         struct vm_state *vms;
<span class="lineNum">    3655 </span>            :         char *mailbox = stream-&gt;mailbox, *user;
<span class="lineNum">    3656 </span>            :         char buf[1024] = &quot;&quot;;
<span class="lineNum">    3657 </span>            : 
<span class="lineNum">    3658 </span>            :         if (!(user = get_user_by_mailbox(mailbox, buf, sizeof(buf))) || !(vms = get_vm_state_by_imapuser(user, 0))) {
<span class="lineNum">    3659 </span>            :                 if (user &amp;&amp; DEBUG_ATLEAST(3))
<span class="lineNum">    3660 </span>            :                         ast_log(AST_LOG_WARNING, &quot;User %s mailbox not found for update.\n&quot;, user);
<span class="lineNum">    3661 </span>            :                 return;
<span class="lineNum">    3662 </span>            :         }
<span class="lineNum">    3663 </span>            : 
<span class="lineNum">    3664 </span>            :         ast_debug(3, &quot;User %s mailbox set for update.\n&quot;, user);
<span class="lineNum">    3665 </span>            : 
<span class="lineNum">    3666 </span>            :         vms-&gt;updated = 1; /* Set updated flag since mailbox changed */
<span class="lineNum">    3667 </span>            : }
<span class="lineNum">    3668 </span>            : 
<span class="lineNum">    3669 </span>            : static void init_vm_state(struct vm_state *vms)
<span class="lineNum">    3670 </span>            : {
<span class="lineNum">    3671 </span>            :         vms-&gt;msg_array_max = VMSTATE_MAX_MSG_ARRAY;
<span class="lineNum">    3672 </span>            :         vms-&gt;msgArray = ast_calloc(vms-&gt;msg_array_max, sizeof(long));
<span class="lineNum">    3673 </span>            :         if (!vms-&gt;msgArray) {
<span class="lineNum">    3674 </span>            :                 /* Out of mem? This can't be good. */
<span class="lineNum">    3675 </span>            :                 vms-&gt;msg_array_max = 0;
<span class="lineNum">    3676 </span>            :         }
<span class="lineNum">    3677 </span>            :         vms-&gt;vmArrayIndex = 0;
<span class="lineNum">    3678 </span>            :         ast_mutex_init(&amp;vms-&gt;lock);
<span class="lineNum">    3679 </span>            : }
<span class="lineNum">    3680 </span>            : 
<span class="lineNum">    3681 </span>            : static int save_body(BODY *body, struct vm_state *vms, char *section, char *format, int is_intro)
<span class="lineNum">    3682 </span>            : {
<span class="lineNum">    3683 </span>            :         char *body_content;
<span class="lineNum">    3684 </span>            :         char *body_decoded;
<span class="lineNum">    3685 </span>            :         char *fn = is_intro ? vms-&gt;introfn : vms-&gt;fn;
<span class="lineNum">    3686 </span>            :         unsigned long len = 0;
<span class="lineNum">    3687 </span>            :         unsigned long newlen = 0;
<span class="lineNum">    3688 </span>            :         char filename[256];
<span class="lineNum">    3689 </span>            : 
<span class="lineNum">    3690 </span>            :         if (!body || body == NIL)
<span class="lineNum">    3691 </span>            :                 return -1;
<span class="lineNum">    3692 </span>            : 
<span class="lineNum">    3693 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    3694 </span>            :         body_content = mail_fetchbody(vms-&gt;mailstream, vms-&gt;msgArray[vms-&gt;curmsg], section, &amp;len);
<span class="lineNum">    3695 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3696 </span>            :         if (len &gt; MAX_MAIL_BODY_CONTENT_SIZE) {
<span class="lineNum">    3697 </span>            :                 ast_log(AST_LOG_ERROR,
<span class="lineNum">    3698 </span>            :                         &quot;Msgno %ld, section %s. The body's content size %ld is huge (max %ld). User:%s, mailbox %s\n&quot;,
<span class="lineNum">    3699 </span>            :                         vms-&gt;msgArray[vms-&gt;curmsg], section, len, MAX_MAIL_BODY_CONTENT_SIZE, vms-&gt;imapuser, vms-&gt;username);
<span class="lineNum">    3700 </span>            :                 return -1;
<span class="lineNum">    3701 </span>            :         }
<span class="lineNum">    3702 </span>            :         if (body_content != NIL &amp;&amp; len) {
<span class="lineNum">    3703 </span>            :                 snprintf(filename, sizeof(filename), &quot;%s.%s&quot;, fn, format);
<span class="lineNum">    3704 </span>            :                 /* ast_debug(1, body_content); */
<span class="lineNum">    3705 </span>            :                 body_decoded = rfc822_base64((unsigned char *) body_content, len, &amp;newlen);
<span class="lineNum">    3706 </span>            :                 /* If the body of the file is empty, return an error */
<span class="lineNum">    3707 </span>            :                 if (!newlen || !body_decoded) {
<span class="lineNum">    3708 </span>            :                         return -1;
<span class="lineNum">    3709 </span>            :                 }
<span class="lineNum">    3710 </span>            :                 write_file(filename, (char *) body_decoded, newlen);
<span class="lineNum">    3711 </span>            :         } else {
<span class="lineNum">    3712 </span>            :                 ast_debug(5, &quot;Body of message is NULL.\n&quot;);
<span class="lineNum">    3713 </span>            :                 return -1;
<span class="lineNum">    3714 </span>            :         }
<span class="lineNum">    3715 </span>            :         return 0;
<span class="lineNum">    3716 </span>            : }
<span class="lineNum">    3717 </span>            : 
<span class="lineNum">    3718 </span>            : /*!
<span class="lineNum">    3719 </span>            :  * \brief Get delimiter via mm_list callback
<span class="lineNum">    3720 </span>            :  * \param vms           The voicemail state object
<span class="lineNum">    3721 </span>            :  * \param stream
<span class="lineNum">    3722 </span>            :  *
<span class="lineNum">    3723 </span>            :  * Determines the delimiter character that is used by the underlying IMAP based mail store.
<span class="lineNum">    3724 </span>            :  */
<span class="lineNum">    3725 </span>            : /* MUTEX should already be held */
<span class="lineNum">    3726 </span>            : static void get_mailbox_delimiter(struct vm_state *vms, MAILSTREAM *stream) {
<span class="lineNum">    3727 </span>            :         char tmp[50];
<span class="lineNum">    3728 </span>            :         snprintf(tmp, sizeof(tmp), &quot;{%s}&quot;, S_OR(vms-&gt;imapserver, imapserver));
<span class="lineNum">    3729 </span>            :         mail_list(stream, tmp, &quot;*&quot;);
<span class="lineNum">    3730 </span>            : }
<span class="lineNum">    3731 </span>            : 
<span class="lineNum">    3732 </span>            : /*!
<span class="lineNum">    3733 </span>            :  * \brief Check Quota for user
<span class="lineNum">    3734 </span>            :  * \param vms a pointer to a vm_state struct, will use the mailstream property of this.
<span class="lineNum">    3735 </span>            :  * \param mailbox the mailbox to check the quota for.
<span class="lineNum">    3736 </span>            :  *
<span class="lineNum">    3737 </span>            :  * Calls imap_getquotaroot, which will populate its results into the vm_state vms input structure.
<span class="lineNum">    3738 </span>            :  */
<span class="lineNum">    3739 </span>            : static void check_quota(struct vm_state *vms, char *mailbox) {
<span class="lineNum">    3740 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    3741 </span>            :         mail_parameters(NULL, SET_QUOTA, (void *) mm_parsequota);
<span class="lineNum">    3742 </span>            :         ast_debug(3, &quot;Mailbox name set to: %s, about to check quotas\n&quot;, mailbox);
<span class="lineNum">    3743 </span>            :         if (vms &amp;&amp; vms-&gt;mailstream != NULL) {
<span class="lineNum">    3744 </span>            :                 imap_getquotaroot(vms-&gt;mailstream, mailbox);
<span class="lineNum">    3745 </span>            :         } else {
<span class="lineNum">    3746 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Mailstream not available for mailbox: %s\n&quot;, mailbox);
<span class="lineNum">    3747 </span>            :         }
<span class="lineNum">    3748 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    3749 </span>            : }
<span class="lineNum">    3750 </span>            : 
<span class="lineNum">    3751 </span>            : #endif /* IMAP_STORAGE */
<span class="lineNum">    3752 </span>            : 
<span class="lineNum">    3753 </span>            : /*! \brief Lock file path
<span class="lineNum">    3754 </span>            :  * only return failure if ast_lock_path returns 'timeout',
<a name="3755"><span class="lineNum">    3755 </span>            :  * not if the path does not exist or any other reason</a>
<span class="lineNum">    3756 </span>            :  */
<span class="lineNum">    3757 </span><span class="lineCov">       1510 : static int vm_lock_path(const char *path)</span>
<span class="lineNum">    3758 </span>            : {
<span class="lineNum">    3759 </span><span class="lineCov">       1510 :         switch (ast_lock_path(path)) {</span>
<span class="lineNum">    3760 </span><span class="lineNoCov">          0 :         case AST_LOCK_TIMEOUT:</span>
<span class="lineNum">    3761 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    3762 </span><span class="lineCov">       1510 :         default:</span>
<span class="lineNum">    3763 </span><span class="lineCov">       1510 :                 return 0;</span>
<span class="lineNum">    3764 </span>            :         }
<span class="lineNum">    3765 </span>            : }
<span class="lineNum">    3766 </span>            : 
<span class="lineNum">    3767 </span>            : #define MSG_ID_LEN 256
<span class="lineNum">    3768 </span>            : 
<span class="lineNum">    3769 </span>            : /* Used to attach a unique identifier to an msg_id */
<span class="lineNum">    3770 </span>            : static int msg_id_incrementor;
<span class="lineNum">    3771 </span>            : 
<span class="lineNum">    3772 </span>            : /*!
<span class="lineNum">    3773 </span>            :  * \brief Sets the destination string to a uniquely identifying msg_id string
<span class="lineNum">    3774 </span>            :  * \param dst pointer to a character buffer that should contain MSG_ID_LEN characters.
<span class="lineNum">    3775 </span>            :  */
<span class="lineNum">    3776 </span>            : static void generate_msg_id(char *dst);
<span class="lineNum">    3777 </span>            : 
<span class="lineNum">    3778 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">    3779 </span>            : struct generic_prepare_struct {
<span class="lineNum">    3780 </span>            :         char *sql;
<span class="lineNum">    3781 </span>            :         int argc;
<span class="lineNum">    3782 </span>            :         char **argv;
<span class="lineNum">    3783 </span>            : };
<span class="lineNum">    3784 </span>            : 
<span class="lineNum">    3785 </span>            : static SQLHSTMT generic_prepare(struct odbc_obj *obj, void *data)
<span class="lineNum">    3786 </span>            : {
<span class="lineNum">    3787 </span>            :         struct generic_prepare_struct *gps = data;
<span class="lineNum">    3788 </span>            :         int res, i;
<span class="lineNum">    3789 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    3790 </span>            : 
<span class="lineNum">    3791 </span>            :         res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;con, &amp;stmt);
<span class="lineNum">    3792 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3793 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Alloc Handle failed!\n&quot;);
<span class="lineNum">    3794 </span>            :                 return NULL;
<span class="lineNum">    3795 </span>            :         }
<span class="lineNum">    3796 </span>            :         res = SQLPrepare(stmt, (unsigned char *) gps-&gt;sql, SQL_NTS);
<span class="lineNum">    3797 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3798 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Prepare failed![%s]\n&quot;, gps-&gt;sql);
<span class="lineNum">    3799 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    3800 </span>            :                 return NULL;
<span class="lineNum">    3801 </span>            :         }
<span class="lineNum">    3802 </span>            :         for (i = 0; i &lt; gps-&gt;argc; i++)
<span class="lineNum">    3803 </span>            :                 SQLBindParameter(stmt, i + 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(gps-&gt;argv[i]), 0, gps-&gt;argv[i], 0, NULL);
<span class="lineNum">    3804 </span>            : 
<span class="lineNum">    3805 </span>            :         return stmt;
<span class="lineNum">    3806 </span>            : }
<span class="lineNum">    3807 </span>            : 
<span class="lineNum">    3808 </span>            : static void odbc_update_msg_id(char *dir, int msg_num, char *msg_id)
<span class="lineNum">    3809 </span>            : {
<span class="lineNum">    3810 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    3811 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    3812 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    3813 </span>            :         char msg_num_str[20];
<span class="lineNum">    3814 </span>            :         char *argv[] = { msg_id, dir, msg_num_str };
<span class="lineNum">    3815 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 3, .argv = argv };
<span class="lineNum">    3816 </span>            : 
<span class="lineNum">    3817 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    3818 </span>            :         if (!obj) {
<span class="lineNum">    3819 </span>            :                 ast_log(LOG_WARNING, &quot;Unable to update message ID for message %d in %s\n&quot;, msg_num, dir);
<span class="lineNum">    3820 </span>            :                 return;
<span class="lineNum">    3821 </span>            :         }
<span class="lineNum">    3822 </span>            : 
<span class="lineNum">    3823 </span>            :         snprintf(msg_num_str, sizeof(msg_num_str), &quot;%d&quot;, msg_num);
<span class="lineNum">    3824 </span>            :         snprintf(sql, sizeof(sql), &quot;UPDATE %s SET msg_id=? WHERE dir=? AND msgnum=?&quot;, odbc_table);
<span class="lineNum">    3825 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    3826 </span>            :         if (!stmt) {
<span class="lineNum">    3827 </span>            :                 ast_log(LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3828 </span>            :         } else {
<span class="lineNum">    3829 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    3830 </span>            :         }
<span class="lineNum">    3831 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    3832 </span>            :         return;
<span class="lineNum">    3833 </span>            : }
<span class="lineNum">    3834 </span>            : 
<span class="lineNum">    3835 </span>            : /*!
<span class="lineNum">    3836 </span>            :  * \brief Retrieves a file from an ODBC data store.
<span class="lineNum">    3837 </span>            :  * \param dir the path to the file to be retrieved.
<span class="lineNum">    3838 </span>            :  * \param msgnum the message number, such as within a mailbox folder.
<span class="lineNum">    3839 </span>            :  *
<span class="lineNum">    3840 </span>            :  * This method is used by the RETRIEVE macro when mailboxes are stored in an ODBC back end.
<span class="lineNum">    3841 </span>            :  * The purpose is to get the message from the database store to the local file system, so that the message may be played, or the information file may be read.
<span class="lineNum">    3842 </span>            :  *
<span class="lineNum">    3843 </span>            :  * The file is looked up by invoking a SQL on the odbc_table (default 'voicemessages') using the dir and msgnum input parameters.
<span class="lineNum">    3844 </span>            :  * The output is the message information file with the name msgnum and the extension .txt
<span class="lineNum">    3845 </span>            :  * and the message file with the extension of its format, in the directory with base file name of the msgnum.
<span class="lineNum">    3846 </span>            :  *
<span class="lineNum">    3847 </span>            :  * \return 0 on success, -1 on error.
<span class="lineNum">    3848 </span>            :  */
<span class="lineNum">    3849 </span>            : static int retrieve_file(char *dir, int msgnum)
<span class="lineNum">    3850 </span>            : {
<span class="lineNum">    3851 </span>            :         int x = 0;
<span class="lineNum">    3852 </span>            :         int res;
<span class="lineNum">    3853 </span>            :         int fd = -1;
<span class="lineNum">    3854 </span>            :         size_t fdlen = 0;
<span class="lineNum">    3855 </span>            :         void *fdm = MAP_FAILED;
<span class="lineNum">    3856 </span>            :         SQLSMALLINT colcount = 0;
<span class="lineNum">    3857 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    3858 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    3859 </span>            :         char fmt[80] = &quot;&quot;;
<span class="lineNum">    3860 </span>            :         char *c;
<span class="lineNum">    3861 </span>            :         char coltitle[256];
<span class="lineNum">    3862 </span>            :         SQLSMALLINT collen;
<span class="lineNum">    3863 </span>            :         SQLSMALLINT datatype;
<span class="lineNum">    3864 </span>            :         SQLSMALLINT decimaldigits;
<span class="lineNum">    3865 </span>            :         SQLSMALLINT nullable;
<span class="lineNum">    3866 </span>            :         SQLULEN colsize;
<span class="lineNum">    3867 </span>            :         SQLLEN colsize2;
<span class="lineNum">    3868 </span>            :         FILE *f = NULL;
<span class="lineNum">    3869 </span>            :         char rowdata[80];
<span class="lineNum">    3870 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    3871 </span>            :         char full_fn[PATH_MAX];
<span class="lineNum">    3872 </span>            :         char msgnums[80];
<span class="lineNum">    3873 </span>            :         char *argv[] = { dir, msgnums };
<span class="lineNum">    3874 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<span class="lineNum">    3875 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    3876 </span>            : 
<span class="lineNum">    3877 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    3878 </span>            :         if (!obj) {
<span class="lineNum">    3879 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    3880 </span>            :                 return -1;
<span class="lineNum">    3881 </span>            :         }
<span class="lineNum">    3882 </span>            : 
<span class="lineNum">    3883 </span>            :         ast_copy_string(fmt, vmfmts, sizeof(fmt));
<span class="lineNum">    3884 </span>            :         c = strchr(fmt, '|');
<span class="lineNum">    3885 </span>            :         if (c)
<span class="lineNum">    3886 </span>            :                 *c = '\0';
<span class="lineNum">    3887 </span>            :         if (!strcasecmp(fmt, &quot;wav49&quot;))
<span class="lineNum">    3888 </span>            :                 strcpy(fmt, &quot;WAV&quot;);
<span class="lineNum">    3889 </span>            : 
<span class="lineNum">    3890 </span>            :         snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, msgnum);
<span class="lineNum">    3891 </span>            :         if (msgnum &gt; -1)
<span class="lineNum">    3892 </span>            :                 make_file(fn, sizeof(fn), dir, msgnum);
<span class="lineNum">    3893 </span>            :         else
<span class="lineNum">    3894 </span>            :                 ast_copy_string(fn, dir, sizeof(fn));
<span class="lineNum">    3895 </span>            : 
<span class="lineNum">    3896 </span>            :         /* Create the information file */
<span class="lineNum">    3897 </span>            :         snprintf(full_fn, sizeof(full_fn), &quot;%s.txt&quot;, fn);
<span class="lineNum">    3898 </span>            : 
<span class="lineNum">    3899 </span>            :         if (!(f = fopen(full_fn, &quot;w+&quot;))) {
<span class="lineNum">    3900 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to open/create '%s'\n&quot;, full_fn);
<span class="lineNum">    3901 </span>            :                 goto bail;
<span class="lineNum">    3902 </span>            :         }
<span class="lineNum">    3903 </span>            : 
<span class="lineNum">    3904 </span>            :         snprintf(full_fn, sizeof(full_fn), &quot;%s.%s&quot;, fn, fmt);
<span class="lineNum">    3905 </span>            :         snprintf(sql, sizeof(sql), &quot;SELECT * FROM %s WHERE dir=? AND msgnum=?&quot;, odbc_table);
<span class="lineNum">    3906 </span>            : 
<span class="lineNum">    3907 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    3908 </span>            :         if (!stmt) {
<span class="lineNum">    3909 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3910 </span>            :                 goto bail;
<span class="lineNum">    3911 </span>            :         }
<span class="lineNum">    3912 </span>            : 
<span class="lineNum">    3913 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    3914 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3915 </span>            :                 if (res != SQL_NO_DATA) {
<span class="lineNum">    3916 </span>            :                         ast_log(AST_LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3917 </span>            :                 }
<span class="lineNum">    3918 </span>            :                 goto bail_with_handle;
<span class="lineNum">    3919 </span>            :         }
<span class="lineNum">    3920 </span>            : 
<span class="lineNum">    3921 </span>            :         fd = open(full_fn, O_RDWR | O_CREAT | O_TRUNC, VOICEMAIL_FILE_MODE);
<span class="lineNum">    3922 </span>            :         if (fd &lt; 0) {
<span class="lineNum">    3923 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to write '%s': %s\n&quot;, full_fn, strerror(errno));
<span class="lineNum">    3924 </span>            :                 goto bail_with_handle;
<span class="lineNum">    3925 </span>            :         }
<span class="lineNum">    3926 </span>            : 
<span class="lineNum">    3927 </span>            :         res = SQLNumResultCols(stmt, &amp;colcount);
<span class="lineNum">    3928 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3929 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Column Count error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3930 </span>            :                 goto bail_with_handle;
<span class="lineNum">    3931 </span>            :         }
<span class="lineNum">    3932 </span>            : 
<span class="lineNum">    3933 </span>            :         fprintf(f, &quot;[message]\n&quot;);
<span class="lineNum">    3934 </span>            :         for (x = 0; x &lt; colcount; x++) {
<span class="lineNum">    3935 </span>            :                 rowdata[0] = '\0';
<span class="lineNum">    3936 </span>            :                 colsize = 0;
<span class="lineNum">    3937 </span>            :                 collen = sizeof(coltitle);
<span class="lineNum">    3938 </span>            :                 res = SQLDescribeCol(stmt, x + 1, (unsigned char *) coltitle, sizeof(coltitle), &amp;collen,
<span class="lineNum">    3939 </span>            :                                                         &amp;datatype, &amp;colsize, &amp;decimaldigits, &amp;nullable);
<span class="lineNum">    3940 </span>            :                 if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3941 </span>            :                         ast_log(AST_LOG_WARNING, &quot;SQL Describe Column error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3942 </span>            :                         goto bail_with_handle;
<span class="lineNum">    3943 </span>            :                 }
<span class="lineNum">    3944 </span>            :                 if (!strcasecmp(coltitle, &quot;recording&quot;)) {
<span class="lineNum">    3945 </span>            :                         off_t offset;
<span class="lineNum">    3946 </span>            :                         res = SQLGetData(stmt, x + 1, SQL_BINARY, rowdata, 0, &amp;colsize2);
<span class="lineNum">    3947 </span>            :                         fdlen = colsize2;
<span class="lineNum">    3948 </span>            :                         if (fd &gt; -1) {
<span class="lineNum">    3949 </span>            :                                 char tmp[1] = &quot;&quot;;
<span class="lineNum">    3950 </span>            :                                 lseek(fd, fdlen - 1, SEEK_SET);
<span class="lineNum">    3951 </span>            :                                 if (write(fd, tmp, 1) != 1) {
<span class="lineNum">    3952 </span>            :                                         close(fd);
<span class="lineNum">    3953 </span>            :                                         fd = -1;
<span class="lineNum">    3954 </span>            :                                         continue;
<span class="lineNum">    3955 </span>            :                                 }
<span class="lineNum">    3956 </span>            :                                 /* Read out in small chunks */
<span class="lineNum">    3957 </span>            :                                 for (offset = 0; offset &lt; colsize2; offset += CHUNKSIZE) {
<span class="lineNum">    3958 </span>            :                                         if ((fdm = mmap(NULL, CHUNKSIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, offset)) == MAP_FAILED) {
<span class="lineNum">    3959 </span>            :                                                 ast_log(AST_LOG_WARNING, &quot;Could not mmap the output file: %s (%d)\n&quot;, strerror(errno), errno);
<span class="lineNum">    3960 </span>            :                                                 goto bail_with_handle;
<span class="lineNum">    3961 </span>            :                                         }
<span class="lineNum">    3962 </span>            :                                         res = SQLGetData(stmt, x + 1, SQL_BINARY, fdm, CHUNKSIZE, NULL);
<span class="lineNum">    3963 </span>            :                                         munmap(fdm, CHUNKSIZE);
<span class="lineNum">    3964 </span>            :                                         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3965 </span>            :                                                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    3966 </span>            :                                                 unlink(full_fn);
<span class="lineNum">    3967 </span>            :                                                 goto bail_with_handle;
<span class="lineNum">    3968 </span>            :                                         }
<span class="lineNum">    3969 </span>            :                                 }
<span class="lineNum">    3970 </span>            :                                 if (truncate(full_fn, fdlen) &lt; 0) {
<span class="lineNum">    3971 </span>            :                                         ast_log(LOG_WARNING, &quot;Unable to truncate '%s': %s\n&quot;, full_fn, strerror(errno));
<span class="lineNum">    3972 </span>            :                                 }
<span class="lineNum">    3973 </span>            :                         }
<span class="lineNum">    3974 </span>            :                 } else {
<span class="lineNum">    3975 </span>            :                         res = SQLGetData(stmt, x + 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    3976 </span>            :                         if (res == SQL_NULL_DATA &amp;&amp; !strcasecmp(coltitle, &quot;msg_id&quot;)) {
<span class="lineNum">    3977 </span>            :                                 char msg_id[MSG_ID_LEN];
<span class="lineNum">    3978 </span>            :                                 generate_msg_id(msg_id);
<span class="lineNum">    3979 </span>            :                                 snprintf(rowdata, sizeof(rowdata), &quot;%s&quot;, msg_id);
<span class="lineNum">    3980 </span>            :                                 odbc_update_msg_id(dir, msgnum, msg_id);
<span class="lineNum">    3981 </span>            :                         } else if (res == SQL_NULL_DATA &amp;&amp; !strcasecmp(coltitle, &quot;category&quot;)) {
<span class="lineNum">    3982 </span>            :                                 /* Ignore null column value for category */
<span class="lineNum">    3983 </span>            :                                 ast_debug(3, &quot;Ignoring null category column in ODBC voicemail retrieve_file.\n&quot;);
<span class="lineNum">    3984 </span>            :                                 continue;
<span class="lineNum">    3985 </span>            :                         } else if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    3986 </span>            :                                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error! coltitle=%s\n[%s]\n\n&quot;, coltitle, sql);
<span class="lineNum">    3987 </span>            :                                 goto bail_with_handle;
<span class="lineNum">    3988 </span>            :                         }
<span class="lineNum">    3989 </span>            :                         if (strcasecmp(coltitle, &quot;msgnum&quot;) &amp;&amp; strcasecmp(coltitle, &quot;dir&quot;)) {
<span class="lineNum">    3990 </span>            :                                 fprintf(f, &quot;%s=%s\n&quot;, coltitle, rowdata);
<span class="lineNum">    3991 </span>            :                         }
<span class="lineNum">    3992 </span>            :                 }
<span class="lineNum">    3993 </span>            :         }
<span class="lineNum">    3994 </span>            : 
<span class="lineNum">    3995 </span>            : bail_with_handle:
<span class="lineNum">    3996 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    3997 </span>            : 
<span class="lineNum">    3998 </span>            : bail:
<span class="lineNum">    3999 </span>            :         if (f)
<span class="lineNum">    4000 </span>            :                 fclose(f);
<span class="lineNum">    4001 </span>            :         if (fd &gt; -1)
<span class="lineNum">    4002 </span>            :                 close(fd);
<span class="lineNum">    4003 </span>            : 
<span class="lineNum">    4004 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4005 </span>            : 
<span class="lineNum">    4006 </span>            :         return x - 1;
<span class="lineNum">    4007 </span>            : }
<span class="lineNum">    4008 </span>            : 
<span class="lineNum">    4009 </span>            : /*!
<span class="lineNum">    4010 </span>            :  * \brief Determines the highest message number in use for a given user and mailbox folder.
<span class="lineNum">    4011 </span>            :  * \param vmu
<span class="lineNum">    4012 </span>            :  * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.
<span class="lineNum">    4013 </span>            :  *
<span class="lineNum">    4014 </span>            :  * This method is used when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4015 </span>            :  * Typical use to set the msgnum would be to take the value returned from this method and add one to it.
<span class="lineNum">    4016 </span>            :  *
<span class="lineNum">    4017 </span>            :  * \return the value of zero or greater to indicate the last message index in use, -1 to indicate none.
<span class="lineNum">    4018 </span>            : 
<span class="lineNum">    4019 </span>            :  */
<span class="lineNum">    4020 </span>            : static int last_message_index(struct ast_vm_user *vmu, char *dir)
<span class="lineNum">    4021 </span>            : {
<span class="lineNum">    4022 </span>            :         int x = -1;
<span class="lineNum">    4023 </span>            :         int res;
<span class="lineNum">    4024 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4025 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4026 </span>            :         char rowdata[20];
<span class="lineNum">    4027 </span>            :         char *argv[] = { dir };
<span class="lineNum">    4028 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 1, .argv = argv };
<span class="lineNum">    4029 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4030 </span>            : 
<span class="lineNum">    4031 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4032 </span>            :         if (!obj) {
<span class="lineNum">    4033 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4034 </span>            :                 return -1;
<span class="lineNum">    4035 </span>            :         }
<span class="lineNum">    4036 </span>            : 
<span class="lineNum">    4037 </span>            :         snprintf(sql, sizeof(sql), &quot;SELECT msgnum FROM %s WHERE dir=? order by msgnum desc&quot;, odbc_table);
<span class="lineNum">    4038 </span>            : 
<span class="lineNum">    4039 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4040 </span>            :         if (!stmt) {
<span class="lineNum">    4041 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4042 </span>            :                 goto bail;
<span class="lineNum">    4043 </span>            :         }
<span class="lineNum">    4044 </span>            : 
<span class="lineNum">    4045 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    4046 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4047 </span>            :                 if (res == SQL_NO_DATA) {
<span class="lineNum">    4048 </span>            :                         ast_log(AST_LOG_DEBUG, &quot;Directory '%s' has no messages and therefore no index was retrieved.\n&quot;, dir);
<span class="lineNum">    4049 </span>            :                 } else {
<span class="lineNum">    4050 </span>            :                         ast_log(AST_LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4051 </span>            :                 }
<span class="lineNum">    4052 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4053 </span>            :         }
<span class="lineNum">    4054 </span>            : 
<span class="lineNum">    4055 </span>            :         res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    4056 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4057 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4058 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4059 </span>            :         }
<span class="lineNum">    4060 </span>            : 
<span class="lineNum">    4061 </span>            :         if (sscanf(rowdata, &quot;%30d&quot;, &amp;x) != 1) {
<span class="lineNum">    4062 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to read message index!\n&quot;);
<span class="lineNum">    4063 </span>            :         }
<span class="lineNum">    4064 </span>            : 
<span class="lineNum">    4065 </span>            : bail_with_handle:
<span class="lineNum">    4066 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4067 </span>            : 
<span class="lineNum">    4068 </span>            : bail:
<span class="lineNum">    4069 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4070 </span>            : 
<span class="lineNum">    4071 </span>            :         return x;
<span class="lineNum">    4072 </span>            : }
<span class="lineNum">    4073 </span>            : 
<span class="lineNum">    4074 </span>            : /*!
<span class="lineNum">    4075 </span>            :  * \brief Determines if the specified message exists.
<span class="lineNum">    4076 </span>            :  * \param dir the folder the mailbox folder to look for messages.
<span class="lineNum">    4077 </span>            :  * \param msgnum the message index to query for.
<span class="lineNum">    4078 </span>            :  *
<span class="lineNum">    4079 </span>            :  * This method is used when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4080 </span>            :  *
<span class="lineNum">    4081 </span>            :  * \return greater than zero if the message exists, zero when the message does not exist or on error.
<span class="lineNum">    4082 </span>            :  */
<span class="lineNum">    4083 </span>            : static int message_exists(char *dir, int msgnum)
<span class="lineNum">    4084 </span>            : {
<span class="lineNum">    4085 </span>            :         int x = 0;
<span class="lineNum">    4086 </span>            :         int res;
<span class="lineNum">    4087 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4088 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4089 </span>            :         char rowdata[20];
<span class="lineNum">    4090 </span>            :         char msgnums[20];
<span class="lineNum">    4091 </span>            :         char *argv[] = { dir, msgnums };
<span class="lineNum">    4092 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<span class="lineNum">    4093 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4094 </span>            : 
<span class="lineNum">    4095 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4096 </span>            :         if (!obj) {
<span class="lineNum">    4097 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4098 </span>            :                 return 0;
<span class="lineNum">    4099 </span>            :         }
<span class="lineNum">    4100 </span>            : 
<span class="lineNum">    4101 </span>            :         snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, msgnum);
<span class="lineNum">    4102 </span>            :         snprintf(sql, sizeof(sql), &quot;SELECT COUNT(*) FROM %s WHERE dir=? AND msgnum=?&quot;, odbc_table);
<span class="lineNum">    4103 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4104 </span>            :         if (!stmt) {
<span class="lineNum">    4105 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4106 </span>            :                 goto bail;
<span class="lineNum">    4107 </span>            :         }
<span class="lineNum">    4108 </span>            : 
<span class="lineNum">    4109 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    4110 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4111 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4112 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4113 </span>            :         }
<span class="lineNum">    4114 </span>            : 
<span class="lineNum">    4115 </span>            :         res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    4116 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4117 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4118 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4119 </span>            :         }
<span class="lineNum">    4120 </span>            : 
<span class="lineNum">    4121 </span>            :         if (sscanf(rowdata, &quot;%30d&quot;, &amp;x) != 1) {
<span class="lineNum">    4122 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to read message count!\n&quot;);
<span class="lineNum">    4123 </span>            :         }
<span class="lineNum">    4124 </span>            : 
<span class="lineNum">    4125 </span>            : bail_with_handle:
<span class="lineNum">    4126 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4127 </span>            : 
<span class="lineNum">    4128 </span>            : bail:
<span class="lineNum">    4129 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4130 </span>            :         return x;
<span class="lineNum">    4131 </span>            : }
<span class="lineNum">    4132 </span>            : 
<span class="lineNum">    4133 </span>            : /*!
<span class="lineNum">    4134 </span>            :  * \brief returns the number of messages found.
<span class="lineNum">    4135 </span>            :  * \param vmu
<span class="lineNum">    4136 </span>            :  * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.
<span class="lineNum">    4137 </span>            :  *
<span class="lineNum">    4138 </span>            :  * This method is used when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4139 </span>            :  *
<span class="lineNum">    4140 </span>            :  * \return The count of messages being zero or more, less than zero on error.
<span class="lineNum">    4141 </span>            :  */
<span class="lineNum">    4142 </span>            : static int count_messages(struct ast_vm_user *vmu, char *dir)
<span class="lineNum">    4143 </span>            : {
<span class="lineNum">    4144 </span>            :         int x = -1;
<span class="lineNum">    4145 </span>            :         int res;
<span class="lineNum">    4146 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4147 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4148 </span>            :         char rowdata[20];
<span class="lineNum">    4149 </span>            :         char *argv[] = { dir };
<span class="lineNum">    4150 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 1, .argv = argv };
<span class="lineNum">    4151 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4152 </span>            : 
<span class="lineNum">    4153 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4154 </span>            :         if (!obj) {
<span class="lineNum">    4155 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4156 </span>            :                 return -1;
<span class="lineNum">    4157 </span>            :         }
<span class="lineNum">    4158 </span>            : 
<span class="lineNum">    4159 </span>            :         snprintf(sql, sizeof(sql), &quot;SELECT COUNT(*) FROM %s WHERE dir=?&quot;, odbc_table);
<span class="lineNum">    4160 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4161 </span>            :         if (!stmt) {
<span class="lineNum">    4162 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4163 </span>            :                 goto bail;
<span class="lineNum">    4164 </span>            :         }
<span class="lineNum">    4165 </span>            : 
<span class="lineNum">    4166 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    4167 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4168 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4169 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4170 </span>            :         }
<span class="lineNum">    4171 </span>            : 
<span class="lineNum">    4172 </span>            :         res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    4173 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4174 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4175 </span>            :                 goto bail_with_handle;
<span class="lineNum">    4176 </span>            :         }
<span class="lineNum">    4177 </span>            : 
<span class="lineNum">    4178 </span>            :         if (sscanf(rowdata, &quot;%30d&quot;, &amp;x) != 1) {
<span class="lineNum">    4179 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to read message count!\n&quot;);
<span class="lineNum">    4180 </span>            :         }
<span class="lineNum">    4181 </span>            : 
<span class="lineNum">    4182 </span>            : bail_with_handle:
<span class="lineNum">    4183 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4184 </span>            : 
<span class="lineNum">    4185 </span>            : bail:
<span class="lineNum">    4186 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4187 </span>            :         return x;
<span class="lineNum">    4188 </span>            : }
<span class="lineNum">    4189 </span>            : 
<span class="lineNum">    4190 </span>            : /*!
<span class="lineNum">    4191 </span>            :  * \brief Deletes a message from the mailbox folder.
<span class="lineNum">    4192 </span>            :  * \param sdir The mailbox folder to work in.
<span class="lineNum">    4193 </span>            :  * \param smsg The message index to be deleted.
<span class="lineNum">    4194 </span>            :  *
<span class="lineNum">    4195 </span>            :  * This method is used when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4196 </span>            :  * The specified message is directly deleted from the database 'voicemessages' table.
<span class="lineNum">    4197 </span>            :  *
<span class="lineNum">    4198 </span>            :  * \return the value greater than zero on success to indicate the number of messages, less than zero on error.
<span class="lineNum">    4199 </span>            :  */
<span class="lineNum">    4200 </span>            : static void delete_file(const char *sdir, int smsg)
<span class="lineNum">    4201 </span>            : {
<span class="lineNum">    4202 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4203 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4204 </span>            :         char msgnums[20];
<span class="lineNum">    4205 </span>            :         char *argv[] = { NULL, msgnums };
<span class="lineNum">    4206 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<span class="lineNum">    4207 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4208 </span>            : 
<span class="lineNum">    4209 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4210 </span>            :         if (!obj) {
<span class="lineNum">    4211 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4212 </span>            :                 return;
<span class="lineNum">    4213 </span>            :         }
<span class="lineNum">    4214 </span>            : 
<span class="lineNum">    4215 </span>            :         argv[0] = ast_strdupa(sdir);
<span class="lineNum">    4216 </span>            : 
<span class="lineNum">    4217 </span>            :         snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, smsg);
<span class="lineNum">    4218 </span>            :         snprintf(sql, sizeof(sql), &quot;DELETE FROM %s WHERE dir=? AND msgnum=?&quot;, odbc_table);
<span class="lineNum">    4219 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4220 </span>            :         if (!stmt) {
<span class="lineNum">    4221 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4222 </span>            :         } else {
<span class="lineNum">    4223 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4224 </span>            :         }
<span class="lineNum">    4225 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4226 </span>            : 
<span class="lineNum">    4227 </span>            :         return;
<span class="lineNum">    4228 </span>            : }
<span class="lineNum">    4229 </span>            : 
<span class="lineNum">    4230 </span>            : /*!
<span class="lineNum">    4231 </span>            :  * \brief Copies a voicemail from one mailbox to another.
<span class="lineNum">    4232 </span>            :  * \param sdir the folder for which to look for the message to be copied.
<span class="lineNum">    4233 </span>            :  * \param smsg the index of the message to be copied.
<span class="lineNum">    4234 </span>            :  * \param ddir the destination folder to copy the message into.
<span class="lineNum">    4235 </span>            :  * \param dmsg the index to be used for the copied message.
<span class="lineNum">    4236 </span>            :  * \param dmailboxuser The user who owns the mailbox tha contains the destination folder.
<span class="lineNum">    4237 </span>            :  * \param dmailboxcontext The context for the destination user.
<span class="lineNum">    4238 </span>            :  *
<span class="lineNum">    4239 </span>            :  * This method is used for the COPY macro when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4240 </span>            :  */
<span class="lineNum">    4241 </span>            : static void copy_file(char *sdir, int smsg, char *ddir, int dmsg, char *dmailboxuser, char *dmailboxcontext)
<span class="lineNum">    4242 </span>            : {
<span class="lineNum">    4243 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4244 </span>            :         char sql[512];
<span class="lineNum">    4245 </span>            :         char msgnums[20];
<span class="lineNum">    4246 </span>            :         char msgnumd[20];
<span class="lineNum">    4247 </span>            :         char msg_id[MSG_ID_LEN];
<span class="lineNum">    4248 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4249 </span>            :         char *argv[] = { ddir, msgnumd, msg_id, dmailboxuser, dmailboxcontext, sdir, msgnums };
<span class="lineNum">    4250 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 7, .argv = argv };
<span class="lineNum">    4251 </span>            : 
<span class="lineNum">    4252 </span>            :         generate_msg_id(msg_id);
<span class="lineNum">    4253 </span>            :         delete_file(ddir, dmsg);
<span class="lineNum">    4254 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4255 </span>            :         if (!obj) {
<span class="lineNum">    4256 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4257 </span>            :                 return;
<span class="lineNum">    4258 </span>            :         }
<span class="lineNum">    4259 </span>            : 
<span class="lineNum">    4260 </span>            :         snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, smsg);
<span class="lineNum">    4261 </span>            :         snprintf(msgnumd, sizeof(msgnumd), &quot;%d&quot;, dmsg);
<span class="lineNum">    4262 </span>            :         snprintf(sql, sizeof(sql), &quot;INSERT INTO %s (dir, msgnum, msg_id, context, macrocontext, callerid, origtime, duration, recording, flag, mailboxuser, mailboxcontext) SELECT ?,?,?,context,macrocontext,callerid,origtime,duration,recording,flag,?,? FROM %s WHERE dir=? AND msgnum=?&quot;, odbc_table, odbc_table);
<span class="lineNum">    4263 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4264 </span>            :         if (!stmt)
<span class="lineNum">    4265 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s] (You probably don't have MySQL 4.1 or later installed)\n\n&quot;, sql);
<span class="lineNum">    4266 </span>            :         else
<span class="lineNum">    4267 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4268 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4269 </span>            : 
<span class="lineNum">    4270 </span>            :         return;
<span class="lineNum">    4271 </span>            : }
<span class="lineNum">    4272 </span>            : 
<span class="lineNum">    4273 </span>            : struct insert_data {
<span class="lineNum">    4274 </span>            :         char *sql;
<span class="lineNum">    4275 </span>            :         const char *dir;
<span class="lineNum">    4276 </span>            :         const char *msgnums;
<span class="lineNum">    4277 </span>            :         void *data;
<span class="lineNum">    4278 </span>            :         SQLLEN datalen;
<span class="lineNum">    4279 </span>            :         SQLLEN indlen;
<span class="lineNum">    4280 </span>            :         const char *context;
<span class="lineNum">    4281 </span>            :         const char *macrocontext;
<span class="lineNum">    4282 </span>            :         const char *callerid;
<span class="lineNum">    4283 </span>            :         const char *origtime;
<span class="lineNum">    4284 </span>            :         const char *duration;
<span class="lineNum">    4285 </span>            :         const char *mailboxuser;
<span class="lineNum">    4286 </span>            :         const char *mailboxcontext;
<span class="lineNum">    4287 </span>            :         const char *category;
<span class="lineNum">    4288 </span>            :         const char *flag;
<span class="lineNum">    4289 </span>            :         const char *msg_id;
<span class="lineNum">    4290 </span>            : };
<span class="lineNum">    4291 </span>            : 
<span class="lineNum">    4292 </span>            : static SQLHSTMT insert_data_cb(struct odbc_obj *obj, void *vdata)
<span class="lineNum">    4293 </span>            : {
<span class="lineNum">    4294 </span>            :         struct insert_data *data = vdata;
<span class="lineNum">    4295 </span>            :         int res;
<span class="lineNum">    4296 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4297 </span>            : 
<span class="lineNum">    4298 </span>            :         res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;con, &amp;stmt);
<span class="lineNum">    4299 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4300 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Alloc Handle failed!\n&quot;);
<span class="lineNum">    4301 </span>            :                 return NULL;
<span class="lineNum">    4302 </span>            :         }
<span class="lineNum">    4303 </span>            : 
<span class="lineNum">    4304 </span>            :         SQLBindParameter(stmt, 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;dir), 0, (void *) data-&gt;dir, 0, NULL);
<span class="lineNum">    4305 </span>            :         SQLBindParameter(stmt, 2, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;msgnums), 0, (void *) data-&gt;msgnums, 0, NULL);
<span class="lineNum">    4306 </span>            :         SQLBindParameter(stmt, 3, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_LONGVARBINARY, data-&gt;datalen, 0, (void *) data-&gt;data, data-&gt;datalen, &amp;data-&gt;indlen);
<span class="lineNum">    4307 </span>            :         SQLBindParameter(stmt, 4, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;context), 0, (void *) data-&gt;context, 0, NULL);
<span class="lineNum">    4308 </span>            :         SQLBindParameter(stmt, 5, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;macrocontext), 0, (void *) data-&gt;macrocontext, 0, NULL);
<span class="lineNum">    4309 </span>            :         SQLBindParameter(stmt, 6, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;callerid), 0, (void *) data-&gt;callerid, 0, NULL);
<span class="lineNum">    4310 </span>            :         SQLBindParameter(stmt, 7, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;origtime), 0, (void *) data-&gt;origtime, 0, NULL);
<span class="lineNum">    4311 </span>            :         SQLBindParameter(stmt, 8, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;duration), 0, (void *) data-&gt;duration, 0, NULL);
<span class="lineNum">    4312 </span>            :         SQLBindParameter(stmt, 9, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxuser), 0, (void *) data-&gt;mailboxuser, 0, NULL);
<span class="lineNum">    4313 </span>            :         SQLBindParameter(stmt, 10, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxcontext), 0, (void *) data-&gt;mailboxcontext, 0, NULL);
<span class="lineNum">    4314 </span>            :         SQLBindParameter(stmt, 11, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;flag), 0, (void *) data-&gt;flag, 0, NULL);
<span class="lineNum">    4315 </span>            :         SQLBindParameter(stmt, 12, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;msg_id), 0, (void *) data-&gt;msg_id, 0, NULL);
<span class="lineNum">    4316 </span>            :         if (!ast_strlen_zero(data-&gt;category)) {
<span class="lineNum">    4317 </span>            :                 SQLBindParameter(stmt, 13, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;category), 0, (void *) data-&gt;category, 0, NULL);
<span class="lineNum">    4318 </span>            :         }
<span class="lineNum">    4319 </span>            :         res = SQLExecDirect(stmt, (unsigned char *) data-&gt;sql, SQL_NTS);
<span class="lineNum">    4320 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    4321 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Direct Execute failed!\n&quot;);
<span class="lineNum">    4322 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4323 </span>            :                 return NULL;
<span class="lineNum">    4324 </span>            :         }
<span class="lineNum">    4325 </span>            : 
<span class="lineNum">    4326 </span>            :         return stmt;
<span class="lineNum">    4327 </span>            : }
<span class="lineNum">    4328 </span>            : 
<span class="lineNum">    4329 </span>            : /*!
<span class="lineNum">    4330 </span>            :  * \brief Stores a voicemail into the database.
<span class="lineNum">    4331 </span>            :  * \param dir the folder the mailbox folder to store the message.
<span class="lineNum">    4332 </span>            :  * \param mailboxuser the user owning the mailbox folder.
<span class="lineNum">    4333 </span>            :  * \param mailboxcontext
<span class="lineNum">    4334 </span>            :  * \param msgnum the message index for the message to be stored.
<span class="lineNum">    4335 </span>            :  *
<span class="lineNum">    4336 </span>            :  * This method is used when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4337 </span>            :  * The message sound file and information file is looked up on the file system.
<span class="lineNum">    4338 </span>            :  * A SQL query is invoked to store the message into the (MySQL) database.
<span class="lineNum">    4339 </span>            :  *
<span class="lineNum">    4340 </span>            :  * \return the zero on success -1 on error.
<span class="lineNum">    4341 </span>            :  */
<span class="lineNum">    4342 </span>            : static int store_file(const char *dir, const char *mailboxuser, const char *mailboxcontext, int msgnum)
<span class="lineNum">    4343 </span>            : {
<span class="lineNum">    4344 </span>            :         int res = 0;
<span class="lineNum">    4345 </span>            :         int fd = -1;
<span class="lineNum">    4346 </span>            :         void *fdm = MAP_FAILED;
<span class="lineNum">    4347 </span>            :         off_t fdlen = -1;
<span class="lineNum">    4348 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4349 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4350 </span>            :         char msgnums[20];
<span class="lineNum">    4351 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    4352 </span>            :         char full_fn[PATH_MAX];
<span class="lineNum">    4353 </span>            :         char fmt[80]=&quot;&quot;;
<span class="lineNum">    4354 </span>            :         char *c;
<span class="lineNum">    4355 </span>            :         struct ast_config *cfg = NULL;
<span class="lineNum">    4356 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4357 </span>            :         struct insert_data idata = { .sql = sql, .msgnums = msgnums, .dir = dir, .mailboxuser = mailboxuser, .mailboxcontext = mailboxcontext,
<span class="lineNum">    4358 </span>            :                 .context = &quot;&quot;, .macrocontext = &quot;&quot;, .callerid = &quot;&quot;, .origtime = &quot;&quot;, .duration = &quot;&quot;, .category = &quot;&quot;, .flag = &quot;&quot;, .msg_id = &quot;&quot; };
<span class="lineNum">    4359 </span>            :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };
<span class="lineNum">    4360 </span>            : 
<span class="lineNum">    4361 </span>            :         delete_file(dir, msgnum);
<span class="lineNum">    4362 </span>            : 
<span class="lineNum">    4363 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4364 </span>            :         if (!obj) {
<span class="lineNum">    4365 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4366 </span>            :                 return -1;
<span class="lineNum">    4367 </span>            :         }
<span class="lineNum">    4368 </span>            : 
<span class="lineNum">    4369 </span>            :         do {
<span class="lineNum">    4370 </span>            :                 ast_copy_string(fmt, vmfmts, sizeof(fmt));
<span class="lineNum">    4371 </span>            :                 c = strchr(fmt, '|');
<span class="lineNum">    4372 </span>            :                 if (c)
<span class="lineNum">    4373 </span>            :                         *c = '\0';
<span class="lineNum">    4374 </span>            :                 if (!strcasecmp(fmt, &quot;wav49&quot;))
<span class="lineNum">    4375 </span>            :                         strcpy(fmt, &quot;WAV&quot;);
<span class="lineNum">    4376 </span>            :                 snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, msgnum);
<span class="lineNum">    4377 </span>            :                 if (msgnum &gt; -1)
<span class="lineNum">    4378 </span>            :                         make_file(fn, sizeof(fn), dir, msgnum);
<span class="lineNum">    4379 </span>            :                 else
<span class="lineNum">    4380 </span>            :                         ast_copy_string(fn, dir, sizeof(fn));
<span class="lineNum">    4381 </span>            :                 snprintf(full_fn, sizeof(full_fn), &quot;%s.txt&quot;, fn);
<span class="lineNum">    4382 </span>            :                 cfg = ast_config_load(full_fn, config_flags);
<span class="lineNum">    4383 </span>            :                 snprintf(full_fn, sizeof(full_fn), &quot;%s.%s&quot;, fn, fmt);
<span class="lineNum">    4384 </span>            :                 fd = open(full_fn, O_RDWR);
<span class="lineNum">    4385 </span>            :                 if (fd &lt; 0) {
<span class="lineNum">    4386 </span>            :                         ast_log(AST_LOG_WARNING, &quot;Open of sound file '%s' failed: %s\n&quot;, full_fn, strerror(errno));
<span class="lineNum">    4387 </span>            :                         res = -1;
<span class="lineNum">    4388 </span>            :                         break;
<span class="lineNum">    4389 </span>            :                 }
<span class="lineNum">    4390 </span>            :                 if (valid_config(cfg)) {
<span class="lineNum">    4391 </span>            :                         if (!(idata.context = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;context&quot;))) {
<span class="lineNum">    4392 </span>            :                                 idata.context = &quot;&quot;;
<span class="lineNum">    4393 </span>            :                         }
<span class="lineNum">    4394 </span>            :                         if (!(idata.macrocontext = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;macrocontext&quot;))) {
<span class="lineNum">    4395 </span>            :                                 idata.macrocontext = &quot;&quot;;
<span class="lineNum">    4396 </span>            :                         }
<span class="lineNum">    4397 </span>            :                         if (!(idata.callerid = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;callerid&quot;))) {
<span class="lineNum">    4398 </span>            :                                 idata.callerid = &quot;&quot;;
<span class="lineNum">    4399 </span>            :                         }
<span class="lineNum">    4400 </span>            :                         if (!(idata.origtime = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;origtime&quot;))) {
<span class="lineNum">    4401 </span>            :                                 idata.origtime = &quot;&quot;;
<span class="lineNum">    4402 </span>            :                         }
<span class="lineNum">    4403 </span>            :                         if (!(idata.duration = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;duration&quot;))) {
<span class="lineNum">    4404 </span>            :                                 idata.duration = &quot;&quot;;
<span class="lineNum">    4405 </span>            :                         }
<span class="lineNum">    4406 </span>            :                         if (!(idata.category = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;category&quot;))) {
<span class="lineNum">    4407 </span>            :                                 idata.category = &quot;&quot;;
<span class="lineNum">    4408 </span>            :                         }
<span class="lineNum">    4409 </span>            :                         if (!(idata.flag = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;flag&quot;))) {
<span class="lineNum">    4410 </span>            :                                 idata.flag = &quot;&quot;;
<span class="lineNum">    4411 </span>            :                         }
<span class="lineNum">    4412 </span>            :                         if (!(idata.msg_id = ast_variable_retrieve(cfg, &quot;message&quot;, &quot;msg_id&quot;))) {
<span class="lineNum">    4413 </span>            :                                 idata.msg_id = &quot;&quot;;
<span class="lineNum">    4414 </span>            :                         }
<span class="lineNum">    4415 </span>            :                 }
<span class="lineNum">    4416 </span>            :                 fdlen = lseek(fd, 0, SEEK_END);
<span class="lineNum">    4417 </span>            :                 if (fdlen &lt; 0 || lseek(fd, 0, SEEK_SET) &lt; 0) {
<span class="lineNum">    4418 </span>            :                         ast_log(AST_LOG_WARNING, &quot;Failed to process sound file '%s': %s\n&quot;, full_fn, strerror(errno));
<span class="lineNum">    4419 </span>            :                         res = -1;
<span class="lineNum">    4420 </span>            :                         break;
<span class="lineNum">    4421 </span>            :                 }
<span class="lineNum">    4422 </span>            :                 fdm = mmap(NULL, fdlen, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
<span class="lineNum">    4423 </span>            :                 if (fdm == MAP_FAILED) {
<span class="lineNum">    4424 </span>            :                         ast_log(AST_LOG_WARNING, &quot;Memory map failed for sound file '%s'!\n&quot;, full_fn);
<span class="lineNum">    4425 </span>            :                         res = -1;
<span class="lineNum">    4426 </span>            :                         break;
<span class="lineNum">    4427 </span>            :                 }
<span class="lineNum">    4428 </span>            :                 idata.data = fdm;
<span class="lineNum">    4429 </span>            :                 idata.datalen = idata.indlen = fdlen;
<span class="lineNum">    4430 </span>            : 
<span class="lineNum">    4431 </span>            :                 if (!ast_strlen_zero(idata.category))
<span class="lineNum">    4432 </span>            :                         snprintf(sql, sizeof(sql), &quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag,msg_id,category) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;, odbc_table);
<span class="lineNum">    4433 </span>            :                 else
<span class="lineNum">    4434 </span>            :                         snprintf(sql, sizeof(sql), &quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag,msg_id) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)&quot;, odbc_table);
<span class="lineNum">    4435 </span>            : 
<span class="lineNum">    4436 </span>            :                 if (ast_strlen_zero(idata.origtime)) {
<span class="lineNum">    4437 </span>            :                         idata.origtime = &quot;0&quot;;
<span class="lineNum">    4438 </span>            :                 }
<span class="lineNum">    4439 </span>            : 
<span class="lineNum">    4440 </span>            :                 if (ast_strlen_zero(idata.duration)) {
<span class="lineNum">    4441 </span>            :                         idata.duration = &quot;0&quot;;
<span class="lineNum">    4442 </span>            :                 }
<span class="lineNum">    4443 </span>            : 
<span class="lineNum">    4444 </span>            :                 if ((stmt = ast_odbc_direct_execute(obj, insert_data_cb, &amp;idata))) {
<span class="lineNum">    4445 </span>            :                         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4446 </span>            :                 } else {
<span class="lineNum">    4447 </span>            :                         ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4448 </span>            :                         res = -1;
<span class="lineNum">    4449 </span>            :                 }
<span class="lineNum">    4450 </span>            :         } while (0);
<span class="lineNum">    4451 </span>            : 
<span class="lineNum">    4452 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4453 </span>            : 
<span class="lineNum">    4454 </span>            :         if (valid_config(cfg))
<span class="lineNum">    4455 </span>            :                 ast_config_destroy(cfg);
<span class="lineNum">    4456 </span>            :         if (fdm != MAP_FAILED)
<span class="lineNum">    4457 </span>            :                 munmap(fdm, fdlen);
<span class="lineNum">    4458 </span>            :         if (fd &gt; -1)
<span class="lineNum">    4459 </span>            :                 close(fd);
<span class="lineNum">    4460 </span>            :         return res;
<span class="lineNum">    4461 </span>            : }
<span class="lineNum">    4462 </span>            : 
<span class="lineNum">    4463 </span>            : /*!
<span class="lineNum">    4464 </span>            :  * \brief Renames a message in a mailbox folder.
<span class="lineNum">    4465 </span>            :  * \param sdir The folder of the message to be renamed.
<span class="lineNum">    4466 </span>            :  * \param smsg The index of the message to be renamed.
<span class="lineNum">    4467 </span>            :  * \param mailboxuser The user to become the owner of the message after it is renamed. Usually this will be the same as the original owner.
<span class="lineNum">    4468 </span>            :  * \param mailboxcontext The context to be set for the message. Usually this will be the same as the original context.
<span class="lineNum">    4469 </span>            :  * \param ddir The destination folder for the message to be renamed into
<span class="lineNum">    4470 </span>            :  * \param dmsg The destination message for the message to be renamed.
<span class="lineNum">    4471 </span>            :  *
<span class="lineNum">    4472 </span>            :  * This method is used by the RENAME macro when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4473 </span>            :  * The is usually used to resequence the messages in the mailbox, such as to delete messag index 0, it would be called successively to slide all the other messages down one index.
<span class="lineNum">    4474 </span>            :  * But in theory, because the SQL query performs an update on (dir, msgnum, mailboxuser, mailboxcontext) in the database, it should be possible to have the message relocated to another mailbox or context as well.
<span class="lineNum">    4475 </span>            :  */
<span class="lineNum">    4476 </span>            : static void rename_file(char *sdir, int smsg, char *mailboxuser, char *mailboxcontext, char *ddir, int dmsg)
<span class="lineNum">    4477 </span>            : {
<span class="lineNum">    4478 </span>            :         SQLHSTMT stmt;
<span class="lineNum">    4479 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    4480 </span>            :         char msgnums[20];
<span class="lineNum">    4481 </span>            :         char msgnumd[20];
<span class="lineNum">    4482 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    4483 </span>            :         char *argv[] = { ddir, msgnumd, mailboxuser, mailboxcontext, sdir, msgnums };
<span class="lineNum">    4484 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 6, .argv = argv };
<span class="lineNum">    4485 </span>            : 
<span class="lineNum">    4486 </span>            :         delete_file(ddir, dmsg);
<span class="lineNum">    4487 </span>            : 
<span class="lineNum">    4488 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    4489 </span>            :         if (!obj) {
<span class="lineNum">    4490 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    4491 </span>            :                 return;
<span class="lineNum">    4492 </span>            :         }
<span class="lineNum">    4493 </span>            : 
<span class="lineNum">    4494 </span>            :         snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, smsg);
<span class="lineNum">    4495 </span>            :         snprintf(msgnumd, sizeof(msgnumd), &quot;%d&quot;, dmsg);
<span class="lineNum">    4496 </span>            :         snprintf(sql, sizeof(sql), &quot;UPDATE %s SET dir=?, msgnum=?, mailboxuser=?, mailboxcontext=? WHERE dir=? AND msgnum=?&quot;, odbc_table);
<span class="lineNum">    4497 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    4498 </span>            :         if (!stmt)
<span class="lineNum">    4499 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    4500 </span>            :         else
<span class="lineNum">    4501 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    4502 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    4503 </span>            :         return;
<span class="lineNum">    4504 </span>            : }
<span class="lineNum">    4505 </span>            : 
<span class="lineNum">    4506 </span>            : /*!
<span class="lineNum">    4507 </span>            :  * \brief Removes a voicemail message file.
<span class="lineNum">    4508 </span>            :  * \param dir the path to the message file.
<span class="lineNum">    4509 </span>            :  * \param msgnum the unique number for the message within the mailbox.
<span class="lineNum">    4510 </span>            :  *
<span class="lineNum">    4511 </span>            :  * Removes the message content file and the information file.
<span class="lineNum">    4512 </span>            :  * This method is used by the DISPOSE macro when mailboxes are stored in an ODBC back end.
<span class="lineNum">    4513 </span>            :  * Typical use is to clean up after a RETRIEVE operation.
<span class="lineNum">    4514 </span>            :  * Note that this does not remove the message from the mailbox folders, to do that we would use delete_file().
<span class="lineNum">    4515 </span>            :  * \return zero on success, -1 on error.
<span class="lineNum">    4516 </span>            :  */
<span class="lineNum">    4517 </span>            : static int remove_file(char *dir, int msgnum)
<span class="lineNum">    4518 </span>            : {
<span class="lineNum">    4519 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    4520 </span>            :         char full_fn[PATH_MAX];
<span class="lineNum">    4521 </span>            :         char msgnums[80];
<span class="lineNum">    4522 </span>            : 
<span class="lineNum">    4523 </span>            :         if (msgnum &gt; -1) {
<span class="lineNum">    4524 </span>            :                 snprintf(msgnums, sizeof(msgnums), &quot;%d&quot;, msgnum);
<span class="lineNum">    4525 </span>            :                 make_file(fn, sizeof(fn), dir, msgnum);
<span class="lineNum">    4526 </span>            :         } else
<span class="lineNum">    4527 </span>            :                 ast_copy_string(fn, dir, sizeof(fn));
<span class="lineNum">    4528 </span>            :         ast_filedelete(fn, NULL);
<span class="lineNum">    4529 </span>            :         snprintf(full_fn, sizeof(full_fn), &quot;%s.txt&quot;, fn);
<span class="lineNum">    4530 </span>            :         unlink(full_fn);
<span class="lineNum">    4531 </span>            :         return 0;
<span class="lineNum">    4532 </span>            : }
<span class="lineNum">    4533 </span>            : #else
<span class="lineNum">    4534 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    4535 </span>            : /*!
<span class="lineNum">    4536 </span>            :  * \brief Find all .txt files - even if they are not in sequence from 0000.
<span class="lineNum">    4537 </span>            :  * \param vmu
<span class="lineNum">    4538 </span>            :  * \param dir
<span class="lineNum">    4539 </span>            :  *
<span class="lineNum">    4540 </span>            :  * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).
<span class="lineNum">    4541 </span>            :  *
<a name="4542"><span class="lineNum">    4542 </span>            :  * \return the count of messages, zero or more.</a>
<span class="lineNum">    4543 </span>            :  */
<span class="lineNum">    4544 </span><span class="lineCov">        694 : static int count_messages(struct ast_vm_user *vmu, char *dir)</span>
<span class="lineNum">    4545 </span>            : {
<span class="lineNum">    4546 </span>            : 
<span class="lineNum">    4547 </span><span class="lineCov">        694 :         int vmcount = 0;</span>
<span class="lineNum">    4548 </span><span class="lineCov">        694 :         DIR *vmdir = NULL;</span>
<span class="lineNum">    4549 </span><span class="lineCov">        694 :         struct dirent *vment = NULL;</span>
<span class="lineNum">    4550 </span>            : 
<span class="lineNum">    4551 </span><span class="lineCov">        694 :         if (vm_lock_path(dir))</span>
<span class="lineNum">    4552 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    4553 </span>            : 
<span class="lineNum">    4554 </span><span class="lineCov">        694 :         if ((vmdir = opendir(dir))) {</span>
<span class="lineNum">    4555 </span><span class="lineCov">       3134 :                 while ((vment = readdir(vmdir))) {</span>
<span class="lineNum">    4556 </span><span class="lineCov">       2440 :                         if (strlen(vment-&gt;d_name) &gt; 7 &amp;&amp; !strncmp(vment-&gt;d_name + 7, &quot;.txt&quot;, 4)) {</span>
<span class="lineNum">    4557 </span><span class="lineCov">        146 :                                 vmcount++;</span>
<span class="lineNum">    4558 </span>            :                         }
<span class="lineNum">    4559 </span>            :                 }
<span class="lineNum">    4560 </span><span class="lineCov">        694 :                 closedir(vmdir);</span>
<span class="lineNum">    4561 </span>            :         }
<span class="lineNum">    4562 </span><span class="lineCov">        694 :         ast_unlock_path(dir);</span>
<span class="lineNum">    4563 </span>            : 
<span class="lineNum">    4564 </span><span class="lineCov">        694 :         return vmcount;</span>
<span class="lineNum">    4565 </span>            : }
<span class="lineNum">    4566 </span>            : 
<span class="lineNum">    4567 </span>            : /*!
<span class="lineNum">    4568 </span>            :  * \brief Renames a message in a mailbox folder.
<span class="lineNum">    4569 </span>            :  * \param sfn The path to the mailbox information and data file to be renamed.
<span class="lineNum">    4570 </span>            :  * \param dfn The path for where the message data and information files will be renamed to.
<span class="lineNum">    4571 </span>            :  *
<a name="4572"><span class="lineNum">    4572 </span>            :  * This method is used by the RENAME macro when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</a>
<span class="lineNum">    4573 </span>            :  */
<span class="lineNum">    4574 </span><span class="lineCov">         11 : static void rename_file(char *sfn, char *dfn)</span>
<span class="lineNum">    4575 </span>            : {
<span class="lineNum">    4576 </span>            :         char stxt[PATH_MAX];
<span class="lineNum">    4577 </span>            :         char dtxt[PATH_MAX];
<span class="lineNum">    4578 </span><span class="lineCov">         11 :         ast_filerename(sfn, dfn, NULL);</span>
<span class="lineNum">    4579 </span><span class="lineCov">         11 :         snprintf(stxt, sizeof(stxt), &quot;%s.txt&quot;, sfn);</span>
<span class="lineNum">    4580 </span><span class="lineCov">         11 :         snprintf(dtxt, sizeof(dtxt), &quot;%s.txt&quot;, dfn);</span>
<span class="lineNum">    4581 </span><span class="lineCov">         11 :         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    4582 </span><span class="lineNoCov">          0 :                 ast_update_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, sfn, &quot;filename&quot;, dfn, SENTINEL);</span>
<span class="lineNum">    4583 </span>            :         }
<span class="lineNum">    4584 </span><span class="lineCov">         11 :         rename(stxt, dtxt);</span>
<span class="lineNum">    4585 </span><span class="lineCov">         11 : }</span>
<span class="lineNum">    4586 </span>            : 
<span class="lineNum">    4587 </span>            : /*!
<span class="lineNum">    4588 </span>            :  * \brief Determines the highest message number in use for a given user and mailbox folder.
<span class="lineNum">    4589 </span>            :  * \param vmu
<span class="lineNum">    4590 </span>            :  * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.
<span class="lineNum">    4591 </span>            :  *
<span class="lineNum">    4592 </span>            :  * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).
<span class="lineNum">    4593 </span>            :  * Typical use to set the msgnum would be to take the value returned from this method and add one to it.
<span class="lineNum">    4594 </span>            :  *
<span class="lineNum">    4595 </span>            :  * \note Should always be called with a lock already set on dir.
<a name="4596"><span class="lineNum">    4596 </span>            :  * \return the value of zero or greaterto indicate the last message index in use, -1 to indicate none.</a>
<span class="lineNum">    4597 </span>            :  */
<span class="lineNum">    4598 </span><span class="lineCov">        816 : static int last_message_index(struct ast_vm_user *vmu, char *dir)</span>
<span class="lineNum">    4599 </span>            : {
<span class="lineNum">    4600 </span>            :         int x;
<span class="lineNum">    4601 </span><span class="lineCov">        816 :         unsigned char map[MAXMSGLIMIT] = &quot;&quot;;</span>
<span class="lineNum">    4602 </span>            :         DIR *msgdir;
<span class="lineNum">    4603 </span>            :         struct dirent *msgdirent;
<span class="lineNum">    4604 </span>            :         int msgdirint;
<span class="lineNum">    4605 </span>            :         char extension[4];
<span class="lineNum">    4606 </span><span class="lineCov">        816 :         int stopcount = 0;</span>
<span class="lineNum">    4607 </span>            : 
<span class="lineNum">    4608 </span>            :         /* Reading the entire directory into a file map scales better than
<span class="lineNum">    4609 </span>            :          * doing a stat repeatedly on a predicted sequence.  I suspect this
<span class="lineNum">    4610 </span>            :          * is partially due to stat(2) internally doing a readdir(2) itself to
<span class="lineNum">    4611 </span>            :          * find each file. */
<span class="lineNum">    4612 </span><span class="lineCov">        816 :         if (!(msgdir = opendir(dir))) {</span>
<span class="lineNum">    4613 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4614 </span>            :         }
<span class="lineNum">    4615 </span>            : 
<span class="lineNum">    4616 </span><span class="lineCov">       3997 :         while ((msgdirent = readdir(msgdir))) {</span>
<span class="lineNum">    4617 </span><span class="lineCov">       3181 :                 if (sscanf(msgdirent-&gt;d_name, &quot;msg%30d.%3s&quot;, &amp;msgdirint, extension) == 2 &amp;&amp; !strcmp(extension, &quot;txt&quot;) &amp;&amp; msgdirint &lt; MAXMSGLIMIT) {</span>
<span class="lineNum">    4618 </span><span class="lineCov">        307 :                         map[msgdirint] = 1;</span>
<span class="lineNum">    4619 </span><span class="lineCov">        307 :                         stopcount++;</span>
<span class="lineNum">    4620 </span><span class="lineCov">        307 :                         ast_debug(4, &quot;%s map[%d] = %d, count = %d\n&quot;, dir, msgdirint, map[msgdirint], stopcount);</span>
<span class="lineNum">    4621 </span>            :                 }
<span class="lineNum">    4622 </span>            :         }
<span class="lineNum">    4623 </span><span class="lineCov">        816 :         closedir(msgdir);</span>
<span class="lineNum">    4624 </span>            : 
<span class="lineNum">    4625 </span><span class="lineCov">       1127 :         for (x = 0; x &lt; vmu-&gt;maxmsg; x++) {</span>
<span class="lineNum">    4626 </span><span class="lineCov">       1127 :                 if (map[x] == 1) {</span>
<span class="lineNum">    4627 </span><span class="lineCov">        307 :                         stopcount--;</span>
<span class="lineNum">    4628 </span><span class="lineCov">        820 :                 } else if (map[x] == 0 &amp;&amp; !stopcount) {</span>
<span class="lineNum">    4629 </span><span class="lineCov">        816 :                         break;</span>
<span class="lineNum">    4630 </span>            :                 }
<span class="lineNum">    4631 </span>            :         }
<span class="lineNum">    4632 </span>            : 
<span class="lineNum">    4633 </span><span class="lineCov">        816 :         return x - 1;</span>
<span class="lineNum">    4634 </span>            : }
<span class="lineNum">    4635 </span>            : 
<span class="lineNum">    4636 </span>            : #endif /* #ifndef IMAP_STORAGE */
<span class="lineNum">    4637 </span>            : #endif /* #else of #ifdef ODBC_STORAGE */
<span class="lineNum">    4638 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    4639 </span>            : /*!
<span class="lineNum">    4640 </span>            :  * \brief Utility function to copy a file.
<span class="lineNum">    4641 </span>            :  * \param infile The path to the file to be copied. The file must be readable, it is opened in read only mode.
<span class="lineNum">    4642 </span>            :  * \param outfile The path for which to copy the file to. The directory permissions must allow the creation (or truncation) of the file, and allow for opening the file in write only mode.
<span class="lineNum">    4643 </span>            :  *
<span class="lineNum">    4644 </span>            :  * When the compiler option HARDLINK_WHEN_POSSIBLE is set, the copy operation will attempt to use the hard link facility instead of copy the file (to save disk space). If the link operation fails, it falls back to the copy operation.
<span class="lineNum">    4645 </span>            :  * The copy operation copies up to 4096 bytes at once.
<span class="lineNum">    4646 </span>            :  *
<a name="4647"><span class="lineNum">    4647 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    4648 </span>            :  */
<span class="lineNum">    4649 </span><span class="lineCov">         41 : static int copy(char *infile, char *outfile)</span>
<span class="lineNum">    4650 </span>            : {
<span class="lineNum">    4651 </span>            :         int ifd;
<span class="lineNum">    4652 </span>            :         int ofd;
<span class="lineNum">    4653 </span><span class="lineCov">         41 :         int res = -1;</span>
<span class="lineNum">    4654 </span>            :         int len;
<span class="lineNum">    4655 </span>            :         char buf[4096];
<span class="lineNum">    4656 </span>            : 
<span class="lineNum">    4657 </span>            : #ifdef HARDLINK_WHEN_POSSIBLE
<span class="lineNum">    4658 </span>            :         /* Hard link if possible; saves disk space &amp; is faster */
<span class="lineNum">    4659 </span>            :         if (!link(infile, outfile)) {
<span class="lineNum">    4660 </span>            :                 return 0;
<span class="lineNum">    4661 </span>            :         }
<span class="lineNum">    4662 </span>            : #endif
<span class="lineNum">    4663 </span>            : 
<span class="lineNum">    4664 </span><span class="lineCov">         41 :         if ((ifd = open(infile, O_RDONLY)) &lt; 0) {</span>
<span class="lineNum">    4665 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Unable to open %s in read-only mode: %s\n&quot;, infile, strerror(errno));</span>
<span class="lineNum">    4666 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4667 </span>            :         }
<span class="lineNum">    4668 </span>            : 
<span class="lineNum">    4669 </span><span class="lineCov">         41 :         if ((ofd = open(outfile, O_WRONLY | O_TRUNC | O_CREAT, VOICEMAIL_FILE_MODE)) &lt; 0) {</span>
<span class="lineNum">    4670 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Unable to open %s in write-only mode: %s\n&quot;, outfile, strerror(errno));</span>
<span class="lineNum">    4671 </span><span class="lineNoCov">          0 :                 close(ifd);</span>
<span class="lineNum">    4672 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4673 </span>            :         }
<span class="lineNum">    4674 </span>            : 
<span class="lineNum">    4675 </span><span class="lineCov">         41 :         for (;;) {</span>
<span class="lineNum">    4676 </span>            :                 int wrlen;
<span class="lineNum">    4677 </span>            : 
<span class="lineNum">    4678 </span><span class="lineCov">         82 :                 len = read(ifd, buf, sizeof(buf));</span>
<span class="lineNum">    4679 </span><span class="lineCov">         82 :                 if (!len) {</span>
<span class="lineNum">    4680 </span><span class="lineCov">         41 :                         res = 0;</span>
<span class="lineNum">    4681 </span><span class="lineCov">         41 :                         break;</span>
<span class="lineNum">    4682 </span>            :                 }
<span class="lineNum">    4683 </span>            : 
<span class="lineNum">    4684 </span><span class="lineCov">         41 :                 if (len &lt; 0) {</span>
<span class="lineNum">    4685 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Read failed on %s: %s\n&quot;, infile, strerror(errno));</span>
<span class="lineNum">    4686 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    4687 </span>            :                 }
<span class="lineNum">    4688 </span>            : 
<span class="lineNum">    4689 </span><span class="lineCov">         41 :                 wrlen = write(ofd, buf, len);</span>
<span class="lineNum">    4690 </span><span class="lineCov">         41 :                 if (errno == ENOMEM || errno == ENOSPC || wrlen != len) {</span>
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Write failed on %s (%d of %d): %s\n&quot;, outfile, wrlen, len, strerror(errno));</span>
<span class="lineNum">    4692 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    4693 </span>            :                 }
<span class="lineNum">    4694 </span>            :         }
<span class="lineNum">    4695 </span>            : 
<span class="lineNum">    4696 </span><span class="lineCov">         41 :         close(ifd);</span>
<span class="lineNum">    4697 </span><span class="lineCov">         41 :         close(ofd);</span>
<span class="lineNum">    4698 </span><span class="lineCov">         41 :         if (res) {</span>
<span class="lineNum">    4699 </span><span class="lineNoCov">          0 :                 unlink(outfile);</span>
<span class="lineNum">    4700 </span>            :         }
<span class="lineNum">    4701 </span>            : 
<span class="lineNum">    4702 </span><span class="lineCov">         41 :         return res;</span>
<span class="lineNum">    4703 </span>            : }
<span class="lineNum">    4704 </span>            : 
<span class="lineNum">    4705 </span>            : /*!
<span class="lineNum">    4706 </span>            :  * \brief Copies a voicemail information (envelope) file.
<span class="lineNum">    4707 </span>            :  * \param frompath
<span class="lineNum">    4708 </span>            :  * \param topath
<span class="lineNum">    4709 </span>            :  *
<span class="lineNum">    4710 </span>            :  * Every voicemail has the data (.wav) file, and the information file.
<span class="lineNum">    4711 </span>            :  * This function performs the file system copying of the information file for a voicemail, handling the internal fields and their values.
<a name="4712"><span class="lineNum">    4712 </span>            :  * This is used by the COPY macro when not using IMAP storage.</a>
<span class="lineNum">    4713 </span>            :  */
<span class="lineNum">    4714 </span><span class="lineCov">         39 : static void copy_plain_file(char *frompath, char *topath)</span>
<span class="lineNum">    4715 </span>            : {
<span class="lineNum">    4716 </span>            :         char frompath2[PATH_MAX], topath2[PATH_MAX];
<span class="lineNum">    4717 </span><span class="lineCov">         39 :         struct ast_variable *tmp,*var = NULL;</span>
<span class="lineNum">    4718 </span><span class="lineCov">         39 :         const char *origmailbox = NULL, *context = NULL, *macrocontext = NULL, *exten = NULL, *priority = NULL, *callerchan = NULL, *callerid = NULL, *origdate = NULL, *origtime = NULL, *category = NULL, *duration = NULL;</span>
<span class="lineNum">    4719 </span><span class="lineCov">         39 :         ast_filecopy(frompath, topath, NULL);</span>
<span class="lineNum">    4720 </span><span class="lineCov">         39 :         snprintf(frompath2, sizeof(frompath2), &quot;%s.txt&quot;, frompath);</span>
<span class="lineNum">    4721 </span><span class="lineCov">         39 :         snprintf(topath2, sizeof(topath2), &quot;%s.txt&quot;, topath);</span>
<span class="lineNum">    4722 </span><span class="lineCov">         39 :         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    4723 </span><span class="lineNoCov">          0 :                 var = ast_load_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, frompath, SENTINEL);</span>
<span class="lineNum">    4724 </span>            :                 /* This cycle converts ast_variable linked list, to va_list list of arguments, may be there is a better way to do it? */
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :                 for (tmp = var; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    4726 </span><span class="lineNoCov">          0 :                         if (!strcasecmp(tmp-&gt;name, &quot;origmailbox&quot;)) {</span>
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 :                                 origmailbox = tmp-&gt;value;</span>
<span class="lineNum">    4728 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;context&quot;)) {</span>
<span class="lineNum">    4729 </span><span class="lineNoCov">          0 :                                 context = tmp-&gt;value;</span>
<span class="lineNum">    4730 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;macrocontext&quot;)) {</span>
<span class="lineNum">    4731 </span><span class="lineNoCov">          0 :                                 macrocontext = tmp-&gt;value;</span>
<span class="lineNum">    4732 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;exten&quot;)) {</span>
<span class="lineNum">    4733 </span><span class="lineNoCov">          0 :                                 exten = tmp-&gt;value;</span>
<span class="lineNum">    4734 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;priority&quot;)) {</span>
<span class="lineNum">    4735 </span><span class="lineNoCov">          0 :                                 priority = tmp-&gt;value;</span>
<span class="lineNum">    4736 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;callerchan&quot;)) {</span>
<span class="lineNum">    4737 </span><span class="lineNoCov">          0 :                                 callerchan = tmp-&gt;value;</span>
<span class="lineNum">    4738 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;callerid&quot;)) {</span>
<span class="lineNum">    4739 </span><span class="lineNoCov">          0 :                                 callerid = tmp-&gt;value;</span>
<span class="lineNum">    4740 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;origdate&quot;)) {</span>
<span class="lineNum">    4741 </span><span class="lineNoCov">          0 :                                 origdate = tmp-&gt;value;</span>
<span class="lineNum">    4742 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;origtime&quot;)) {</span>
<span class="lineNum">    4743 </span><span class="lineNoCov">          0 :                                 origtime = tmp-&gt;value;</span>
<span class="lineNum">    4744 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;category&quot;)) {</span>
<span class="lineNum">    4745 </span><span class="lineNoCov">          0 :                                 category = tmp-&gt;value;</span>
<span class="lineNum">    4746 </span><span class="lineNoCov">          0 :                         } else if (!strcasecmp(tmp-&gt;name, &quot;duration&quot;)) {</span>
<span class="lineNum">    4747 </span><span class="lineNoCov">          0 :                                 duration = tmp-&gt;value;</span>
<span class="lineNum">    4748 </span>            :                         }
<span class="lineNum">    4749 </span>            :                 }
<span class="lineNum">    4750 </span><span class="lineNoCov">          0 :                 ast_store_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, topath, &quot;origmailbox&quot;, origmailbox, &quot;context&quot;, context, &quot;macrocontext&quot;, macrocontext, &quot;exten&quot;, exten, &quot;priority&quot;, priority, &quot;callerchan&quot;, callerchan, &quot;callerid&quot;, callerid, &quot;origdate&quot;, origdate, &quot;origtime&quot;, origtime, &quot;category&quot;, category, &quot;duration&quot;, duration, SENTINEL);</span>
<span class="lineNum">    4751 </span>            :         }
<span class="lineNum">    4752 </span><span class="lineCov">         39 :         copy(frompath2, topath2);</span>
<span class="lineNum">    4753 </span><span class="lineCov">         39 :         ast_variables_destroy(var);</span>
<span class="lineNum">    4754 </span><span class="lineCov">         39 : }</span>
<span class="lineNum">    4755 </span>            : #endif
<span class="lineNum">    4756 </span>            : 
<span class="lineNum">    4757 </span>            : /*!
<span class="lineNum">    4758 </span>            :  * \brief Removes the voicemail sound and information file.
<span class="lineNum">    4759 </span>            :  * \param file The path to the sound file. This will be the folder and message index, without the extension.
<span class="lineNum">    4760 </span>            :  *
<span class="lineNum">    4761 </span>            :  * This is used by the DELETE macro when voicemails are stored on the file system.
<span class="lineNum">    4762 </span>            :  *
<a name="4763"><span class="lineNum">    4763 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    4764 </span>            :  */
<span class="lineNum">    4765 </span><span class="lineCov">         30 : static int vm_delete(char *file)</span>
<span class="lineNum">    4766 </span>            : {
<span class="lineNum">    4767 </span>            :         char *txt;
<span class="lineNum">    4768 </span><span class="lineCov">         30 :         int txtsize = 0;</span>
<span class="lineNum">    4769 </span>            : 
<span class="lineNum">    4770 </span><span class="lineCov">         30 :         txtsize = (strlen(file) + 5)*sizeof(char);</span>
<span class="lineNum">    4771 </span><span class="lineCov">         30 :         txt = ast_alloca(txtsize);</span>
<span class="lineNum">    4772 </span>            :         /* Sprintf here would safe because we alloca'd exactly the right length,
<span class="lineNum">    4773 </span>            :          * but trying to eliminate all sprintf's anyhow
<span class="lineNum">    4774 </span>            :          */
<span class="lineNum">    4775 </span><span class="lineCov">         30 :         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    4776 </span><span class="lineNoCov">          0 :                 ast_destroy_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, file, SENTINEL);</span>
<span class="lineNum">    4777 </span>            :         }
<span class="lineNum">    4778 </span><span class="lineCov">         30 :         snprintf(txt, txtsize, &quot;%s.txt&quot;, file);</span>
<span class="lineNum">    4779 </span><span class="lineCov">         30 :         unlink(txt);</span>
<span class="lineNum">    4780 </span><span class="lineCov">         30 :         return ast_filedelete(file, NULL);</span>
<span class="lineNum">    4781 </span>            : }
<span class="lineNum">    4782 </span>            : 
<span class="lineNum">    4783 </span>            : /*!
<a name="4784"><span class="lineNum">    4784 </span>            :  * \brief utility used by inchar(), for base_encode()</a>
<span class="lineNum">    4785 </span>            :  */
<span class="lineNum">    4786 </span><span class="lineCov">        273 : static int inbuf(struct baseio *bio, FILE *fi)</span>
<span class="lineNum">    4787 </span>            : {
<span class="lineNum">    4788 </span>            :         int l;
<span class="lineNum">    4789 </span>            : 
<span class="lineNum">    4790 </span><span class="lineCov">        273 :         if (bio-&gt;ateof)</span>
<span class="lineNum">    4791 </span><span class="lineCov">         14 :                 return 0;</span>
<span class="lineNum">    4792 </span>            : 
<span class="lineNum">    4793 </span><span class="lineCov">        259 :         if ((l = fread(bio-&gt;iobuf, 1, BASEMAXINLINE, fi)) != BASEMAXINLINE) {</span>
<span class="lineNum">    4794 </span><span class="lineCov">         14 :                 bio-&gt;ateof = 1;</span>
<span class="lineNum">    4795 </span><span class="lineCov">         14 :                 if (l == 0) {</span>
<span class="lineNum">    4796 </span>            :                         /* Assume EOF */
<span class="lineNum">    4797 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">    4798 </span>            :                 }
<span class="lineNum">    4799 </span>            :         }
<span class="lineNum">    4800 </span>            : 
<span class="lineNum">    4801 </span><span class="lineCov">        259 :         bio-&gt;iolen = l;</span>
<span class="lineNum">    4802 </span><span class="lineCov">        259 :         bio-&gt;iocp = 0;</span>
<span class="lineNum">    4803 </span>            : 
<span class="lineNum">    4804 </span><span class="lineCov">        259 :         return 1;</span>
<span class="lineNum">    4805 </span>            : }
<span class="lineNum">    4806 </span>            : 
<span class="lineNum">    4807 </span>            : /*!
<a name="4808"><span class="lineNum">    4808 </span>            :  * \brief utility used by base_encode()</a>
<span class="lineNum">    4809 </span>            :  */
<span class="lineNum">    4810 </span><span class="lineCov">      64001 : static int inchar(struct baseio *bio, FILE *fi)</span>
<span class="lineNum">    4811 </span>            : {
<span class="lineNum">    4812 </span><span class="lineCov">      64001 :         if (bio-&gt;iocp&gt;=bio-&gt;iolen) {</span>
<span class="lineNum">    4813 </span><span class="lineCov">        273 :                 if (!inbuf(bio, fi))</span>
<span class="lineNum">    4814 </span><span class="lineCov">         14 :                         return EOF;</span>
<span class="lineNum">    4815 </span>            :         }
<span class="lineNum">    4816 </span>            : 
<span class="lineNum">    4817 </span><span class="lineCov">      63987 :         return bio-&gt;iobuf[bio-&gt;iocp++];</span>
<span class="lineNum">    4818 </span>            : }
<span class="lineNum">    4819 </span>            : 
<span class="lineNum">    4820 </span>            : /*!
<a name="4821"><span class="lineNum">    4821 </span>            :  * \brief utility used by base_encode()</a>
<span class="lineNum">    4822 </span>            :  */
<span class="lineNum">    4823 </span><span class="lineCov">      85316 : static int ochar(struct baseio *bio, int c, FILE *so)</span>
<span class="lineNum">    4824 </span>            : {
<span class="lineNum">    4825 </span><span class="lineCov">      85316 :         if (bio-&gt;linelength &gt;= BASELINELEN) {</span>
<span class="lineNum">    4826 </span><span class="lineCov">       1176 :                 if (fputs(ENDL, so) == EOF) {</span>
<span class="lineNum">    4827 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    4828 </span>            :                 }
<span class="lineNum">    4829 </span>            : 
<span class="lineNum">    4830 </span><span class="lineCov">       1176 :                 bio-&gt;linelength = 0;</span>
<span class="lineNum">    4831 </span>            :         }
<span class="lineNum">    4832 </span>            : 
<span class="lineNum">    4833 </span><span class="lineCov">      85316 :         if (putc(((unsigned char) c), so) == EOF) {</span>
<span class="lineNum">    4834 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4835 </span>            :         }
<span class="lineNum">    4836 </span>            : 
<span class="lineNum">    4837 </span><span class="lineCov">      85316 :         bio-&gt;linelength++;</span>
<span class="lineNum">    4838 </span>            : 
<span class="lineNum">    4839 </span><span class="lineCov">      85316 :         return 1;</span>
<span class="lineNum">    4840 </span>            : }
<span class="lineNum">    4841 </span>            : 
<span class="lineNum">    4842 </span>            : /*!
<span class="lineNum">    4843 </span>            :  * \brief Performs a base 64 encode algorithm on the contents of a File
<span class="lineNum">    4844 </span>            :  * \param filename The path to the file to be encoded. Must be readable, file is opened in read mode.
<span class="lineNum">    4845 </span>            :  * \param so A FILE handle to the output file to receive the base 64 encoded contents of the input file, identified by filename.
<span class="lineNum">    4846 </span>            :  *
<span class="lineNum">    4847 </span>            :  * TODO: shouldn't this (and the above 3 support functions) be put into some kind of external utility location, such as funcs/func_base64.c ?
<span class="lineNum">    4848 </span>            :  *
<a name="4849"><span class="lineNum">    4849 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    4850 </span>            :  */
<span class="lineNum">    4851 </span><span class="lineCov">         14 : static int base_encode(char *filename, FILE *so)</span>
<span class="lineNum">    4852 </span>            : {
<span class="lineNum">    4853 </span>            :         static const unsigned char dtable[] = { 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K',
<span class="lineNum">    4854 </span>            :                 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',
<span class="lineNum">    4855 </span>            :                 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', '0',
<span class="lineNum">    4856 </span>            :                 '1', '2', '3', '4', '5', '6', '7', '8', '9', '+', '/'};
<span class="lineNum">    4857 </span><span class="lineCov">         14 :         int i, hiteof = 0;</span>
<span class="lineNum">    4858 </span>            :         FILE *fi;
<span class="lineNum">    4859 </span>            :         struct baseio bio;
<span class="lineNum">    4860 </span>            : 
<span class="lineNum">    4861 </span><span class="lineCov">         14 :         memset(&amp;bio, 0, sizeof(bio));</span>
<span class="lineNum">    4862 </span><span class="lineCov">         14 :         bio.iocp = BASEMAXINLINE;</span>
<span class="lineNum">    4863 </span>            : 
<span class="lineNum">    4864 </span><span class="lineCov">         14 :         if (!(fi = fopen(filename, &quot;rb&quot;))) {</span>
<span class="lineNum">    4865 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Failed to open file: %s: %s\n&quot;, filename, strerror(errno));</span>
<span class="lineNum">    4866 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    4867 </span>            :         }
<span class="lineNum">    4868 </span>            : 
<span class="lineNum">    4869 </span><span class="lineCov">      21357 :         while (!hiteof){</span>
<span class="lineNum">    4870 </span>            :                 unsigned char igroup[3], ogroup[4];
<span class="lineNum">    4871 </span>            :                 int c, n;
<span class="lineNum">    4872 </span>            : 
<span class="lineNum">    4873 </span><span class="lineCov">      21343 :                 memset(igroup, 0, sizeof(igroup));</span>
<span class="lineNum">    4874 </span>            : 
<span class="lineNum">    4875 </span><span class="lineCov">      85330 :                 for (n = 0; n &lt; 3; n++) {</span>
<span class="lineNum">    4876 </span><span class="lineCov">      64001 :                         if ((c = inchar(&amp;bio, fi)) == EOF) {</span>
<span class="lineNum">    4877 </span><span class="lineCov">         14 :                                 hiteof = 1;</span>
<span class="lineNum">    4878 </span><span class="lineCov">         14 :                                 break;</span>
<span class="lineNum">    4879 </span>            :                         }
<span class="lineNum">    4880 </span>            : 
<span class="lineNum">    4881 </span><span class="lineCov">      63987 :                         igroup[n] = (unsigned char) c;</span>
<span class="lineNum">    4882 </span>            :                 }
<span class="lineNum">    4883 </span>            : 
<span class="lineNum">    4884 </span><span class="lineCov">      21343 :                 if (n &gt; 0) {</span>
<span class="lineNum">    4885 </span><span class="lineCov">      21329 :                         ogroup[0]= dtable[igroup[0] &gt;&gt; 2];</span>
<span class="lineNum">    4886 </span><span class="lineCov">      21329 :                         ogroup[1]= dtable[((igroup[0] &amp; 3) &lt;&lt; 4) | (igroup[1] &gt;&gt; 4)];</span>
<span class="lineNum">    4887 </span><span class="lineCov">      21329 :                         ogroup[2]= dtable[((igroup[1] &amp; 0xF) &lt;&lt; 2) | (igroup[2] &gt;&gt; 6)];</span>
<span class="lineNum">    4888 </span><span class="lineCov">      21329 :                         ogroup[3]= dtable[igroup[2] &amp; 0x3F];</span>
<span class="lineNum">    4889 </span>            : 
<span class="lineNum">    4890 </span><span class="lineCov">      21329 :                         if (n &lt; 3) {</span>
<span class="lineNum">    4891 </span><span class="lineNoCov">          0 :                                 ogroup[3] = '=';</span>
<span class="lineNum">    4892 </span>            : 
<span class="lineNum">    4893 </span><span class="lineNoCov">          0 :                                 if (n &lt; 2)</span>
<span class="lineNum">    4894 </span><span class="lineNoCov">          0 :                                         ogroup[2] = '=';</span>
<span class="lineNum">    4895 </span>            :                         }
<span class="lineNum">    4896 </span>            : 
<span class="lineNum">    4897 </span><span class="lineCov">     106645 :                         for (i = 0; i &lt; 4; i++)</span>
<span class="lineNum">    4898 </span><span class="lineCov">      85316 :                                 ochar(&amp;bio, ogroup[i], so);</span>
<span class="lineNum">    4899 </span>            :                 }
<span class="lineNum">    4900 </span>            :         }
<span class="lineNum">    4901 </span>            : 
<span class="lineNum">    4902 </span><span class="lineCov">         14 :         fclose(fi);</span>
<span class="lineNum">    4903 </span>            : 
<span class="lineNum">    4904 </span><span class="lineCov">         14 :         if (fputs(ENDL, so) == EOF) {</span>
<span class="lineNum">    4905 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    4906 </span>            :         }
<span class="lineNum">    4907 </span>            : 
<span class="lineNum">    4908 </span><span class="lineCov">         14 :         return 1;</span>
<a name="4909"><span class="lineNum">    4909 </span>            : }</a>
<span class="lineNum">    4910 </span>            : 
<span class="lineNum">    4911 </span><span class="lineNoCov">          0 : static void prep_email_sub_vars(struct ast_channel *ast, struct ast_vm_user *vmu, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, char *dur, char *date, const char *category, const char *flag)</span>
<span class="lineNum">    4912 </span>            : {
<span class="lineNum">    4913 </span>            :         char callerid[256];
<span class="lineNum">    4914 </span>            :         char num[12];
<span class="lineNum">    4915 </span>            :         char fromdir[256], fromfile[256];
<span class="lineNum">    4916 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">    4917 </span>            :         const char *origcallerid, *origtime;
<span class="lineNum">    4918 </span>            :         char origcidname[80], origcidnum[80], origdate[80];
<span class="lineNum">    4919 </span>            :         int inttime;
<span class="lineNum">    4920 </span><span class="lineNoCov">          0 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">    4921 </span>            : 
<span class="lineNum">    4922 </span>            :         /* Prepare variables for substitution in email body and subject */
<span class="lineNum">    4923 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_NAME&quot;, vmu-&gt;fullname);</span>
<span class="lineNum">    4924 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_DUR&quot;, dur);</span>
<span class="lineNum">    4925 </span><span class="lineNoCov">          0 :         snprintf(num, sizeof(num), &quot;%d&quot;, msgnum);</span>
<span class="lineNum">    4926 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_MSGNUM&quot;, num);</span>
<span class="lineNum">    4927 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_CONTEXT&quot;, context);</span>
<span class="lineNum">    4928 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_MAILBOX&quot;, mailbox);</span>
<span class="lineNum">    4929 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_CALLERID&quot;, (!ast_strlen_zero(cidname) || !ast_strlen_zero(cidnum)) ?</span>
<span class="lineNum">    4930 </span><span class="lineNoCov">          0 :                 ast_callerid_merge(callerid, sizeof(callerid), cidname, cidnum, NULL) : &quot;an unknown caller&quot;);</span>
<span class="lineNum">    4931 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_CIDNAME&quot;, (!ast_strlen_zero(cidname) ? cidname : &quot;an unknown caller&quot;));</span>
<span class="lineNum">    4932 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_CIDNUM&quot;, (!ast_strlen_zero(cidnum) ? cidnum : &quot;an unknown caller&quot;));</span>
<span class="lineNum">    4933 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_DATE&quot;, date);</span>
<span class="lineNum">    4934 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_CATEGORY&quot;, category ? ast_strdupa(category) : &quot;no category&quot;);</span>
<span class="lineNum">    4935 </span><span class="lineNoCov">          0 :         pbx_builtin_setvar_helper(ast, &quot;VM_FLAG&quot;, flag);</span>
<span class="lineNum">    4936 </span>            : 
<span class="lineNum">    4937 </span>            :         /* Retrieve info from VM attribute file */
<span class="lineNum">    4938 </span><span class="lineNoCov">          0 :         make_dir(fromdir, sizeof(fromdir), vmu-&gt;context, vmu-&gt;mailbox, fromfolder);</span>
<span class="lineNum">    4939 </span><span class="lineNoCov">          0 :         make_file(fromfile, sizeof(fromfile), fromdir, msgnum - 1);</span>
<span class="lineNum">    4940 </span><span class="lineNoCov">          0 :         if (strlen(fromfile) &lt; sizeof(fromfile) - 5) {</span>
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :                 strcat(fromfile, &quot;.txt&quot;);</span>
<span class="lineNum">    4942 </span>            :         }
<span class="lineNum">    4943 </span><span class="lineNoCov">          0 :         if (!(msg_cfg = ast_config_load(fromfile, config_flags)) || !(valid_config(msg_cfg))) {</span>
<span class="lineNum">    4944 </span><span class="lineNoCov">          0 :                 ast_debug(1, &quot;Config load for message text file '%s' failed\n&quot;, fromfile);</span>
<span class="lineNum">    4945 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    4946 </span>            :         }
<span class="lineNum">    4947 </span>            : 
<span class="lineNum">    4948 </span><span class="lineNoCov">          0 :         if ((origcallerid = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;))) {</span>
<span class="lineNum">    4949 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(ast, &quot;ORIG_VM_CALLERID&quot;, origcallerid);</span>
<span class="lineNum">    4950 </span><span class="lineNoCov">          0 :                 ast_callerid_split(origcallerid, origcidname, sizeof(origcidname), origcidnum, sizeof(origcidnum));</span>
<span class="lineNum">    4951 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(ast, &quot;ORIG_VM_CIDNAME&quot;, origcidname);</span>
<span class="lineNum">    4952 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(ast, &quot;ORIG_VM_CIDNUM&quot;, origcidnum);</span>
<span class="lineNum">    4953 </span>            :         }
<span class="lineNum">    4954 </span>            : 
<span class="lineNum">    4955 </span><span class="lineNoCov">          0 :         if ((origtime = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origtime&quot;)) &amp;&amp; sscanf(origtime, &quot;%30d&quot;, &amp;inttime) == 1) {</span>
<span class="lineNum">    4956 </span><span class="lineNoCov">          0 :                 struct timeval tv = { inttime, };</span>
<span class="lineNum">    4957 </span>            :                 struct ast_tm tm;
<span class="lineNum">    4958 </span><span class="lineNoCov">          0 :                 ast_localtime(&amp;tv, &amp;tm, NULL);</span>
<span class="lineNum">    4959 </span><span class="lineNoCov">          0 :                 ast_strftime_locale(origdate, sizeof(origdate), emaildateformat, &amp;tm, S_OR(vmu-&gt;locale, NULL));</span>
<span class="lineNum">    4960 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(ast, &quot;ORIG_VM_DATE&quot;, origdate);</span>
<span class="lineNum">    4961 </span>            :         }
<span class="lineNum">    4962 </span><span class="lineNoCov">          0 :         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">    4963 </span>            : }
<span class="lineNum">    4964 </span>            : 
<span class="lineNum">    4965 </span>            : /*!
<span class="lineNum">    4966 </span>            :  * \brief Wraps a character sequence in double quotes, escaping occurences of quotes within the string.
<span class="lineNum">    4967 </span>            :  * \param from The string to work with.
<span class="lineNum">    4968 </span>            :  * \param buf The buffer into which to write the modified quoted string.
<span class="lineNum">    4969 </span>            :  * \param maxlen Always zero, but see \see ast_str
<span class="lineNum">    4970 </span>            :  *
<a name="4971"><span class="lineNum">    4971 </span>            :  * \return The destination string with quotes wrapped on it (the to field).</a>
<span class="lineNum">    4972 </span>            :  */
<span class="lineNum">    4973 </span><span class="lineCov">          7 : static const char *ast_str_quote(struct ast_str **buf, ssize_t maxlen, const char *from)</span>
<span class="lineNum">    4974 </span>            : {
<span class="lineNum">    4975 </span>            :         const char *ptr;
<span class="lineNum">    4976 </span>            : 
<span class="lineNum">    4977 </span>            :         /* We're only ever passing 0 to maxlen, so short output isn't possible */
<span class="lineNum">    4978 </span><span class="lineCov">          7 :         ast_str_set(buf, maxlen, &quot;\&quot;&quot;);</span>
<span class="lineNum">    4979 </span><span class="lineCov">          7 :         for (ptr = from; *ptr; ptr++) {</span>
<span class="lineNum">    4980 </span><span class="lineNoCov">          0 :                 if (*ptr == '&quot;' || *ptr == '\\') {</span>
<span class="lineNum">    4981 </span><span class="lineNoCov">          0 :                         ast_str_append(buf, maxlen, &quot;\\%c&quot;, *ptr);</span>
<span class="lineNum">    4982 </span>            :                 } else {
<span class="lineNum">    4983 </span><span class="lineNoCov">          0 :                         ast_str_append(buf, maxlen, &quot;%c&quot;, *ptr);</span>
<span class="lineNum">    4984 </span>            :                 }
<span class="lineNum">    4985 </span>            :         }
<span class="lineNum">    4986 </span><span class="lineCov">          7 :         ast_str_append(buf, maxlen, &quot;\&quot;&quot;);</span>
<span class="lineNum">    4987 </span>            : 
<span class="lineNum">    4988 </span><span class="lineCov">          7 :         return ast_str_buffer(*buf);</span>
<span class="lineNum">    4989 </span>            : }
<span class="lineNum">    4990 </span>            : 
<span class="lineNum">    4991 </span>            : /*! \brief
<span class="lineNum">    4992 </span>            :  * fill in *tm for current time according to the proper timezone, if any.
<a name="4993"><span class="lineNum">    4993 </span>            :  * \return tm so it can be used as a function argument.</a>
<span class="lineNum">    4994 </span>            :  */
<span class="lineNum">    4995 </span><span class="lineCov">          7 : static const struct ast_tm *vmu_tm(const struct ast_vm_user *vmu, struct ast_tm *tm)</span>
<span class="lineNum">    4996 </span>            : {
<span class="lineNum">    4997 </span><span class="lineCov">          7 :         const struct vm_zone *z = NULL;</span>
<span class="lineNum">    4998 </span><span class="lineCov">          7 :         struct timeval t = ast_tvnow();</span>
<span class="lineNum">    4999 </span>            : 
<span class="lineNum">    5000 </span>            :         /* Does this user have a timezone specified? */
<span class="lineNum">    5001 </span><span class="lineCov">          7 :         if (!ast_strlen_zero(vmu-&gt;zonetag)) {</span>
<span class="lineNum">    5002 </span>            :                 /* Find the zone in the list */
<span class="lineNum">    5003 </span><span class="lineCov">          7 :                 AST_LIST_LOCK(&amp;zones);</span>
<span class="lineNum">    5004 </span><span class="lineCov">          7 :                 AST_LIST_TRAVERSE(&amp;zones, z, list) {</span>
<span class="lineNum">    5005 </span><span class="lineNoCov">          0 :                         if (!strcmp(z-&gt;name, vmu-&gt;zonetag))</span>
<span class="lineNum">    5006 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    5007 </span>            :                 }
<span class="lineNum">    5008 </span><span class="lineCov">          7 :                 AST_LIST_UNLOCK(&amp;zones);</span>
<span class="lineNum">    5009 </span>            :         }
<span class="lineNum">    5010 </span><span class="lineCov">          7 :         ast_localtime(&amp;t, tm, z ? z-&gt;timezone : NULL);</span>
<span class="lineNum">    5011 </span><span class="lineCov">          7 :         return tm;</span>
<span class="lineNum">    5012 </span>            : }
<span class="lineNum">    5013 </span>            : 
<span class="lineNum">    5014 </span>            : /*!\brief Check if the string would need encoding within the MIME standard, to
<span class="lineNum">    5015 </span>            :  * avoid confusing certain mail software that expects messages to be 7-bit
<a name="5016"><span class="lineNum">    5016 </span>            :  * clean.</a>
<span class="lineNum">    5017 </span>            :  */
<span class="lineNum">    5018 </span><span class="lineCov">          7 : static int check_mime(const char *str)</span>
<span class="lineNum">    5019 </span>            : {
<span class="lineNum">    5020 </span><span class="lineCov">          7 :         for (; *str; str++) {</span>
<span class="lineNum">    5021 </span><span class="lineNoCov">          0 :                 if (*str &gt; 126 || *str &lt; 32 || strchr(&quot;()&lt;&gt;@,:;/\&quot;[]?.=&quot;, *str)) {</span>
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :                         return 1;</span>
<span class="lineNum">    5023 </span>            :                 }
<span class="lineNum">    5024 </span>            :         }
<span class="lineNum">    5025 </span><span class="lineCov">          7 :         return 0;</span>
<span class="lineNum">    5026 </span>            : }
<span class="lineNum">    5027 </span>            : 
<span class="lineNum">    5028 </span>            : /*!\brief Encode a string according to the MIME rules for encoding strings
<span class="lineNum">    5029 </span>            :  * that are not 7-bit clean or contain control characters.
<span class="lineNum">    5030 </span>            :  *
<span class="lineNum">    5031 </span>            :  * Additionally, if the encoded string would exceed the MIME limit of 76
<span class="lineNum">    5032 </span>            :  * characters per line, then the encoding will be broken up into multiple
<span class="lineNum">    5033 </span>            :  * sections, separated by a space character, in order to facilitate
<span class="lineNum">    5034 </span>            :  * breaking up the associated header across multiple lines.
<span class="lineNum">    5035 </span>            :  *
<span class="lineNum">    5036 </span>            :  * \param end An expandable buffer for holding the result
<span class="lineNum">    5037 </span>            :  * \param maxlen Always zero, but see \see ast_str
<span class="lineNum">    5038 </span>            :  * \param start A string to be encoded
<span class="lineNum">    5039 </span>            :  * \param preamble The length of the first line already used for this string,
<span class="lineNum">    5040 </span>            :  * to ensure that each line maintains a maximum length of 76 chars.
<span class="lineNum">    5041 </span>            :  * \param postamble the length of any additional characters appended to the
<span class="lineNum">    5042 </span>            :  * line, used to ensure proper field wrapping.
<a name="5043"><span class="lineNum">    5043 </span>            :  * \retval The encoded string.</a>
<span class="lineNum">    5044 </span>            :  */
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 : static const char *ast_str_encode_mime(struct ast_str **end, ssize_t maxlen, const char *start, size_t preamble, size_t postamble)</span>
<span class="lineNum">    5046 </span>            : {
<span class="lineNum">    5047 </span><span class="lineNoCov">          0 :         struct ast_str *tmp = ast_str_alloca(80);</span>
<span class="lineNum">    5048 </span><span class="lineNoCov">          0 :         int first_section = 1;</span>
<span class="lineNum">    5049 </span>            : 
<span class="lineNum">    5050 </span><span class="lineNoCov">          0 :         ast_str_reset(*end);</span>
<span class="lineNum">    5051 </span><span class="lineNoCov">          0 :         ast_str_set(&amp;tmp, -1, &quot;=?%s?Q?&quot;, charset);</span>
<span class="lineNum">    5052 </span><span class="lineNoCov">          0 :         for (; *start; start++) {</span>
<span class="lineNum">    5053 </span><span class="lineNoCov">          0 :                 int need_encoding = 0;</span>
<span class="lineNum">    5054 </span><span class="lineNoCov">          0 :                 if (*start &lt; 33 || *start &gt; 126 || strchr(&quot;()&lt;&gt;@,:;/\&quot;[]?.=_&quot;, *start)) {</span>
<span class="lineNum">    5055 </span><span class="lineNoCov">          0 :                         need_encoding = 1;</span>
<span class="lineNum">    5056 </span>            :                 }
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :                 if ((first_section &amp;&amp; need_encoding &amp;&amp; preamble + ast_str_strlen(tmp) &gt; 70) ||</span>
<span class="lineNum">    5058 </span><span class="lineNoCov">          0 :                         (first_section &amp;&amp; !need_encoding &amp;&amp; preamble + ast_str_strlen(tmp) &gt; 72) ||</span>
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :                         (!first_section &amp;&amp; need_encoding &amp;&amp; ast_str_strlen(tmp) &gt; 70) ||</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :                         (!first_section &amp;&amp; !need_encoding &amp;&amp; ast_str_strlen(tmp) &gt; 72)) {</span>
<span class="lineNum">    5061 </span>            :                         /* Start new line */
<span class="lineNum">    5062 </span><span class="lineNoCov">          0 :                         ast_str_append(end, maxlen, &quot;%s%s?=&quot;, first_section ? &quot;&quot; : &quot; &quot;, ast_str_buffer(tmp));</span>
<span class="lineNum">    5063 </span><span class="lineNoCov">          0 :                         ast_str_set(&amp;tmp, -1, &quot;=?%s?Q?&quot;, charset);</span>
<span class="lineNum">    5064 </span><span class="lineNoCov">          0 :                         first_section = 0;</span>
<span class="lineNum">    5065 </span>            :                 }
<span class="lineNum">    5066 </span><span class="lineNoCov">          0 :                 if (need_encoding &amp;&amp; *start == ' ') {</span>
<span class="lineNum">    5067 </span><span class="lineNoCov">          0 :                         ast_str_append(&amp;tmp, -1, &quot;_&quot;);</span>
<span class="lineNum">    5068 </span><span class="lineNoCov">          0 :                 } else if (need_encoding) {</span>
<span class="lineNum">    5069 </span><span class="lineNoCov">          0 :                         ast_str_append(&amp;tmp, -1, &quot;=%hhX&quot;, *start);</span>
<span class="lineNum">    5070 </span>            :                 } else {
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 :                         ast_str_append(&amp;tmp, -1, &quot;%c&quot;, *start);</span>
<span class="lineNum">    5072 </span>            :                 }
<span class="lineNum">    5073 </span>            :         }
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :         ast_str_append(end, maxlen, &quot;%s%s?=%s&quot;, first_section ? &quot;&quot; : &quot; &quot;, ast_str_buffer(tmp), ast_str_strlen(tmp) + postamble &gt; 74 ? &quot; &quot; : &quot;&quot;);</span>
<span class="lineNum">    5075 </span><span class="lineNoCov">          0 :         return ast_str_buffer(*end);</span>
<span class="lineNum">    5076 </span>            : }
<span class="lineNum">    5077 </span>            : 
<span class="lineNum">    5078 </span>            : /*!
<span class="lineNum">    5079 </span>            :  * \brief Creates the email file to be sent to indicate a new voicemail exists for a user.
<span class="lineNum">    5080 </span>            :  * \param p The output file to generate the email contents into.
<span class="lineNum">    5081 </span>            :  * \param srcemail The email address to send the email to, presumably the email address for the owner of the mailbox.
<span class="lineNum">    5082 </span>            :  * \param vmu The voicemail user who is sending the voicemail.
<span class="lineNum">    5083 </span>            :  * \param msgnum The message index in the mailbox folder.
<span class="lineNum">    5084 </span>            :  * \param context
<span class="lineNum">    5085 </span>            :  * \param mailbox The voicemail box to read the voicemail to be notified in this email.
<span class="lineNum">    5086 </span>            :  * \param fromfolder
<span class="lineNum">    5087 </span>            :  * \param cidnum The caller ID number.
<span class="lineNum">    5088 </span>            :  * \param cidname The caller ID name.
<span class="lineNum">    5089 </span>            :  * \param attach the name of the sound file to be attached to the email, if attach_user_voicemail == 1.
<span class="lineNum">    5090 </span>            :  * \param attach2
<span class="lineNum">    5091 </span>            :  * \param format The message sound file format. i.e. .wav
<span class="lineNum">    5092 </span>            :  * \param duration The time of the message content, in seconds.
<span class="lineNum">    5093 </span>            :  * \param attach_user_voicemail if 1, the sound file is attached to the email.
<span class="lineNum">    5094 </span>            :  * \param chan
<span class="lineNum">    5095 </span>            :  * \param category
<span class="lineNum">    5096 </span>            :  * \param imap if == 1, indicates the target folder for the email notification to be sent to will be an IMAP mailstore. This causes additional mailbox headers to be set, which would facilitate searching for the email in the destination IMAP folder.
<span class="lineNum">    5097 </span>            :  * \param flag, msg_id
<span class="lineNum">    5098 </span>            :  *
<a name="5099"><span class="lineNum">    5099 </span>            :  * The email body, and base 64 encoded attachement (if any) are stored to the file identified by *p. This method does not actually send the email.  That is done by invoking the configure 'mailcmd' and piping this generated file into it, or with the sendemail() function.</a>
<span class="lineNum">    5100 </span>            :  */
<span class="lineNum">    5101 </span><span class="lineCov">          7 : static void make_email_file(FILE *p,</span>
<span class="lineNum">    5102 </span>            :                 char *srcemail,
<span class="lineNum">    5103 </span>            :                 struct ast_vm_user *vmu,
<span class="lineNum">    5104 </span>            :                 int msgnum,
<span class="lineNum">    5105 </span>            :                 char *context,
<span class="lineNum">    5106 </span>            :                 char *mailbox,
<span class="lineNum">    5107 </span>            :                 const char *fromfolder,
<span class="lineNum">    5108 </span>            :                 char *cidnum,
<span class="lineNum">    5109 </span>            :                 char *cidname,
<span class="lineNum">    5110 </span>            :                 char *attach,
<span class="lineNum">    5111 </span>            :                 char *attach2,
<span class="lineNum">    5112 </span>            :                 char *format,
<span class="lineNum">    5113 </span>            :                 int duration,
<span class="lineNum">    5114 </span>            :                 int attach_user_voicemail,
<span class="lineNum">    5115 </span>            :                 struct ast_channel *chan,
<span class="lineNum">    5116 </span>            :                 const char *category,
<span class="lineNum">    5117 </span>            :                 int imap,
<span class="lineNum">    5118 </span>            :                 const char *flag,
<span class="lineNum">    5119 </span>            :                 const char *msg_id)
<span class="lineNum">    5120 </span>            : {
<span class="lineNum">    5121 </span>            :         char date[256];
<span class="lineNum">    5122 </span><span class="lineCov">          7 :         char host[MAXHOSTNAMELEN] = &quot;&quot;;</span>
<span class="lineNum">    5123 </span>            :         char who[256];
<span class="lineNum">    5124 </span>            :         char bound[256];
<span class="lineNum">    5125 </span>            :         char dur[256];
<span class="lineNum">    5126 </span>            :         struct ast_tm tm;
<span class="lineNum">    5127 </span><span class="lineCov">          7 :         char enc_cidnum[256] = &quot;&quot;, enc_cidname[256] = &quot;&quot;;</span>
<span class="lineNum">    5128 </span><span class="lineCov">          7 :         struct ast_str *str1 = ast_str_create(16), *str2 = ast_str_create(16);</span>
<span class="lineNum">    5129 </span>            :         char *greeting_attachment;
<span class="lineNum">    5130 </span>            :         char filename[256];
<span class="lineNum">    5131 </span>            :         int first_line;
<span class="lineNum">    5132 </span>            :         char *emailsbuf;
<span class="lineNum">    5133 </span>            :         char *email;
<span class="lineNum">    5134 </span>            : 
<span class="lineNum">    5135 </span><span class="lineCov">          7 :         if (!str1 || !str2) {</span>
<span class="lineNum">    5136 </span><span class="lineNoCov">          0 :                 ast_free(str1);</span>
<span class="lineNum">    5137 </span><span class="lineNoCov">          0 :                 ast_free(str2);</span>
<span class="lineNum">    5138 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    5139 </span>            :         }
<span class="lineNum">    5140 </span>            : 
<span class="lineNum">    5141 </span><span class="lineCov">          7 :         if (cidnum) {</span>
<span class="lineNum">    5142 </span><span class="lineCov">          7 :                 strip_control_and_high(cidnum, enc_cidnum, sizeof(enc_cidnum));</span>
<span class="lineNum">    5143 </span>            :         }
<span class="lineNum">    5144 </span><span class="lineCov">          7 :         if (cidname) {</span>
<span class="lineNum">    5145 </span><span class="lineCov">          7 :                 strip_control_and_high(cidname, enc_cidname, sizeof(enc_cidname));</span>
<span class="lineNum">    5146 </span>            :         }
<span class="lineNum">    5147 </span><span class="lineCov">          7 :         gethostname(host, sizeof(host) - 1);</span>
<span class="lineNum">    5148 </span>            : 
<span class="lineNum">    5149 </span><span class="lineCov">          7 :         if (strchr(srcemail, '@')) {</span>
<span class="lineNum">    5150 </span><span class="lineCov">          7 :                 ast_copy_string(who, srcemail, sizeof(who));</span>
<span class="lineNum">    5151 </span>            :         } else {
<span class="lineNum">    5152 </span><span class="lineNoCov">          0 :                 snprintf(who, sizeof(who), &quot;%s@%s&quot;, srcemail, host);</span>
<span class="lineNum">    5153 </span>            :         }
<span class="lineNum">    5154 </span>            : 
<span class="lineNum">    5155 </span><span class="lineCov">          7 :         greeting_attachment = strrchr(ast_strdupa(attach), '/');</span>
<span class="lineNum">    5156 </span><span class="lineCov">          7 :         if (greeting_attachment) {</span>
<span class="lineNum">    5157 </span><span class="lineCov">          7 :                 *greeting_attachment++ = '\0';</span>
<span class="lineNum">    5158 </span>            :         }
<span class="lineNum">    5159 </span>            : 
<span class="lineNum">    5160 </span><span class="lineCov">          7 :         snprintf(dur, sizeof(dur), &quot;%d:%02d&quot;, duration / 60, duration % 60);</span>
<span class="lineNum">    5161 </span><span class="lineCov">          7 :         ast_strftime(date, sizeof(date), &quot;%a, %d %b %Y %H:%M:%S %z&quot;, vmu_tm(vmu, &amp;tm));</span>
<span class="lineNum">    5162 </span><span class="lineCov">          7 :         fprintf(p, &quot;Date: %s&quot; ENDL, date);</span>
<span class="lineNum">    5163 </span>            : 
<span class="lineNum">    5164 </span>            :         /* Set date format for voicemail mail */
<span class="lineNum">    5165 </span><span class="lineCov">          7 :         ast_strftime_locale(date, sizeof(date), emaildateformat, &amp;tm, S_OR(vmu-&gt;locale, NULL));</span>
<span class="lineNum">    5166 </span>            : 
<span class="lineNum">    5167 </span><span class="lineCov">          7 :         if (!ast_strlen_zero(fromstring) || !ast_strlen_zero(vmu-&gt;fromstring)) {</span>
<span class="lineNum">    5168 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5169 </span><span class="lineNoCov">          0 :                 char *e_fromstring = !ast_strlen_zero(vmu-&gt;fromstring) ? vmu-&gt;fromstring : fromstring;</span>
<span class="lineNum">    5170 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5171 </span>            :                         char *ptr;
<span class="lineNum">    5172 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, enc_cidnum, enc_cidname, dur, date, category, flag);</span>
<span class="lineNum">    5173 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, e_fromstring);</span>
<span class="lineNum">    5174 </span>            : 
<span class="lineNum">    5175 </span><span class="lineNoCov">          0 :                         if (check_mime(ast_str_buffer(str1))) {</span>
<span class="lineNum">    5176 </span><span class="lineNoCov">          0 :                                 first_line = 1;</span>
<span class="lineNum">    5177 </span><span class="lineNoCov">          0 :                                 ast_str_encode_mime(&amp;str2, 0, ast_str_buffer(str1), strlen(&quot;From: &quot;), strlen(who) + 3);</span>
<span class="lineNum">    5178 </span><span class="lineNoCov">          0 :                                 while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5179 </span><span class="lineNoCov">          0 :                                         *ptr = '\0';</span>
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :                                         fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;From:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5181 </span><span class="lineNoCov">          0 :                                         first_line = 0;</span>
<span class="lineNum">    5182 </span>            :                                         /* Substring is smaller, so this will never grow */
<span class="lineNum">    5183 </span><span class="lineNoCov">          0 :                                         ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5184 </span>            :                                 }
<span class="lineNum">    5185 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;%s %s &lt;%s&gt;&quot; ENDL, first_line ? &quot;From:&quot; : &quot;&quot;, ast_str_buffer(str2), who);</span>
<span class="lineNum">    5186 </span>            :                         } else {
<span class="lineNum">    5187 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;From: %s &lt;%s&gt;&quot; ENDL, ast_str_quote(&amp;str2, 0, ast_str_buffer(str1)), who);</span>
<span class="lineNum">    5188 </span>            :                         }
<span class="lineNum">    5189 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5190 </span>            :                 } else {
<span class="lineNum">    5191 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5192 </span>            :                 }
<span class="lineNum">    5193 </span>            :         } else {
<span class="lineNum">    5194 </span><span class="lineCov">          7 :                 fprintf(p, &quot;From: Asterisk PBX &lt;%s&gt;&quot; ENDL, who);</span>
<span class="lineNum">    5195 </span>            :         }
<span class="lineNum">    5196 </span>            : 
<span class="lineNum">    5197 </span><span class="lineCov">          7 :         emailsbuf = ast_strdupa(vmu-&gt;email);</span>
<span class="lineNum">    5198 </span><span class="lineCov">          7 :         fprintf(p, &quot;To:&quot;);</span>
<span class="lineNum">    5199 </span><span class="lineCov">          7 :         first_line = 1;</span>
<span class="lineNum">    5200 </span><span class="lineCov">         14 :         while ((email = strsep(&amp;emailsbuf, &quot;|&quot;))) {</span>
<span class="lineNum">    5201 </span><span class="lineCov">          7 :                 char *next = emailsbuf;</span>
<span class="lineNum">    5202 </span><span class="lineCov">          7 :                 if (check_mime(vmu-&gt;fullname)) {</span>
<span class="lineNum">    5203 </span>            :                         char *ptr;
<span class="lineNum">    5204 </span><span class="lineNoCov">          0 :                         ast_str_encode_mime(&amp;str2, 0, vmu-&gt;fullname, first_line ? strlen(&quot;To: &quot;) : 0, strlen(email) + 3 + (next ? strlen(&quot;,&quot;) : 0));</span>
<span class="lineNum">    5205 </span><span class="lineNoCov">          0 :                         while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5206 </span><span class="lineNoCov">          0 :                                 *ptr = '\0';</span>
<span class="lineNum">    5207 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot; %s&quot; ENDL, ast_str_buffer(str2));</span>
<span class="lineNum">    5208 </span>            :                                 /* Substring is smaller, so this will never grow */
<span class="lineNum">    5209 </span><span class="lineNoCov">          0 :                                 ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5210 </span>            :                         }
<span class="lineNum">    5211 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot; %s &lt;%s&gt;%s&quot; ENDL, ast_str_buffer(str2), email, next ? &quot;,&quot; : &quot;&quot;);</span>
<span class="lineNum">    5212 </span>            :                 } else {
<span class="lineNum">    5213 </span><span class="lineCov">          7 :                         fprintf(p, &quot; %s &lt;%s&gt;%s&quot; ENDL, ast_str_quote(&amp;str2, 0, vmu-&gt;fullname), email, next ? &quot;,&quot; : &quot;&quot;);</span>
<span class="lineNum">    5214 </span>            :                 }
<span class="lineNum">    5215 </span><span class="lineCov">          7 :                 first_line = 0;</span>
<span class="lineNum">    5216 </span>            :         }
<span class="lineNum">    5217 </span>            : 
<span class="lineNum">    5218 </span><span class="lineCov">          7 :         if (msgnum &lt;= -1) {</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;Subject: New greeting '%s' on %s.&quot; ENDL, greeting_attachment, date);</span>
<span class="lineNum">    5220 </span><span class="lineCov">          7 :         } else if (!ast_strlen_zero(emailsubject) || !ast_strlen_zero(vmu-&gt;emailsubject)) {</span>
<span class="lineNum">    5221 </span><span class="lineNoCov">          0 :                 char *e_subj = !ast_strlen_zero(vmu-&gt;emailsubject) ? vmu-&gt;emailsubject : emailsubject;</span>
<span class="lineNum">    5222 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5223 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5224 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</span>
<span class="lineNum">    5225 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, e_subj);</span>
<span class="lineNum">    5226 </span><span class="lineNoCov">          0 :                         if (check_mime(ast_str_buffer(str1))) {</span>
<span class="lineNum">    5227 </span>            :                                 char *ptr;
<span class="lineNum">    5228 </span><span class="lineNoCov">          0 :                                 first_line = 1;</span>
<span class="lineNum">    5229 </span><span class="lineNoCov">          0 :                                 ast_str_encode_mime(&amp;str2, 0, ast_str_buffer(str1), strlen(&quot;Subject: &quot;), 0);</span>
<span class="lineNum">    5230 </span><span class="lineNoCov">          0 :                                 while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5231 </span><span class="lineNoCov">          0 :                                         *ptr = '\0';</span>
<span class="lineNum">    5232 </span><span class="lineNoCov">          0 :                                         fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;Subject:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5233 </span><span class="lineNoCov">          0 :                                         first_line = 0;</span>
<span class="lineNum">    5234 </span>            :                                         /* Substring is smaller, so this will never grow */
<span class="lineNum">    5235 </span><span class="lineNoCov">          0 :                                         ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5236 </span>            :                                 }
<span class="lineNum">    5237 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;Subject:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5238 </span>            :                         } else {
<span class="lineNum">    5239 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;Subject: %s&quot; ENDL, ast_str_buffer(str1));</span>
<span class="lineNum">    5240 </span>            :                         }
<span class="lineNum">    5241 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5242 </span>            :                 } else {
<span class="lineNum">    5243 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5244 </span>            :                 }
<span class="lineNum">    5245 </span><span class="lineCov">          7 :         } else if (ast_test_flag((&amp;globalflags), VM_PBXSKIP)) {</span>
<span class="lineNum">    5246 </span><span class="lineNoCov">          0 :                 if (ast_strlen_zero(flag)) {</span>
<span class="lineNum">    5247 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;Subject: New message %d in mailbox %s&quot; ENDL, msgnum + 1, mailbox);</span>
<span class="lineNum">    5248 </span>            :                 } else {
<span class="lineNum">    5249 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;Subject: New %s message %d in mailbox %s&quot; ENDL, flag, msgnum + 1, mailbox);</span>
<span class="lineNum">    5250 </span>            :                 }
<span class="lineNum">    5251 </span>            :         } else {
<span class="lineNum">    5252 </span><span class="lineCov">          7 :                 if (ast_strlen_zero(flag)) {</span>
<span class="lineNum">    5253 </span><span class="lineCov">          7 :                         fprintf(p, &quot;Subject: [PBX]: New message %d in mailbox %s&quot; ENDL, msgnum + 1, mailbox);</span>
<span class="lineNum">    5254 </span>            :                 } else {
<span class="lineNum">    5255 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;Subject: [PBX]: New %s message %d in mailbox %s&quot; ENDL, flag, msgnum + 1, mailbox);</span>
<span class="lineNum">    5256 </span>            :                 }
<span class="lineNum">    5257 </span>            :         }
<span class="lineNum">    5258 </span>            : 
<span class="lineNum">    5259 </span><span class="lineCov">          7 :         fprintf(p, &quot;Message-ID: &lt;Asterisk-%d-%u-%s-%d@%s&gt;&quot; ENDL, msgnum + 1,</span>
<span class="lineNum">    5260 </span><span class="lineCov">          7 :                 (unsigned int) ast_random(), mailbox, (int) getpid(), host);</span>
<span class="lineNum">    5261 </span><span class="lineCov">          7 :         if (imap) {</span>
<span class="lineNum">    5262 </span>            :                 /* additional information needed for IMAP searching */
<span class="lineNum">    5263 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Message-Num: %d&quot; ENDL, msgnum + 1);</span>
<span class="lineNum">    5264 </span>            :                 /* fprintf(p, &quot;X-Asterisk-VM-Orig-Mailbox: %s&quot; ENDL, ext); */
<span class="lineNum">    5265 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Server-Name: %s&quot; ENDL, fromstring);</span>
<span class="lineNum">    5266 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Context: %s&quot; ENDL, context);</span>
<span class="lineNum">    5267 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    5268 </span>            :                 fprintf(p, &quot;X-Asterisk-VM-Extension: %s&quot; ENDL, (!ast_strlen_zero(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));
<span class="lineNum">    5269 </span>            : #else
<span class="lineNum">    5270 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Extension: %s&quot; ENDL, mailbox);</span>
<span class="lineNum">    5271 </span>            : #endif
<span class="lineNum">    5272 </span>            :                 /* flag added for Urgent */
<span class="lineNum">    5273 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Flag: %s&quot; ENDL, S_OR(flag, &quot;&quot;));</span>
<span class="lineNum">    5274 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Priority: %d&quot; ENDL, chan ? ast_channel_priority(chan) : 0);</span>
<span class="lineNum">    5275 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Caller-ID-Num: %s&quot; ENDL, enc_cidnum);</span>
<span class="lineNum">    5276 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Caller-ID-Name: %s&quot; ENDL, enc_cidname);</span>
<span class="lineNum">    5277 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Duration: %d&quot; ENDL, duration);</span>
<span class="lineNum">    5278 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(category)) {</span>
<span class="lineNum">    5279 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;X-Asterisk-VM-Category: %s&quot; ENDL, category);</span>
<span class="lineNum">    5280 </span>            :                 } else {
<span class="lineNum">    5281 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;X-Asterisk-VM-Category: &quot; ENDL);</span>
<span class="lineNum">    5282 </span>            :                 }
<span class="lineNum">    5283 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Message-Type: %s&quot; ENDL, msgnum &gt; -1 ? &quot;Message&quot; : greeting_attachment);</span>
<span class="lineNum">    5284 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Orig-date: %s&quot; ENDL, date);</span>
<span class="lineNum">    5285 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Orig-time: %ld&quot; ENDL, (long) time(NULL));</span>
<span class="lineNum">    5286 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;X-Asterisk-VM-Message-ID: %s&quot; ENDL, msg_id);</span>
<span class="lineNum">    5287 </span>            :         }
<span class="lineNum">    5288 </span><span class="lineCov">          7 :         if (!ast_strlen_zero(cidnum)) {</span>
<span class="lineNum">    5289 </span><span class="lineCov">          7 :                 fprintf(p, &quot;X-Asterisk-CallerID: %s&quot; ENDL, enc_cidnum);</span>
<span class="lineNum">    5290 </span>            :         }
<span class="lineNum">    5291 </span><span class="lineCov">          7 :         if (!ast_strlen_zero(cidname)) {</span>
<span class="lineNum">    5292 </span><span class="lineCov">          7 :                 fprintf(p, &quot;X-Asterisk-CallerIDName: %s&quot; ENDL, enc_cidname);</span>
<span class="lineNum">    5293 </span>            :         }
<span class="lineNum">    5294 </span><span class="lineCov">          7 :         fprintf(p, &quot;MIME-Version: 1.0&quot; ENDL);</span>
<span class="lineNum">    5295 </span><span class="lineCov">          7 :         if (attach_user_voicemail) {</span>
<span class="lineNum">    5296 </span>            :                 /* Something unique. */
<span class="lineNum">    5297 </span><span class="lineCov">         14 :                 snprintf(bound, sizeof(bound), &quot;----voicemail_%d%s%d%u&quot;, msgnum + 1, mailbox,</span>
<span class="lineNum">    5298 </span><span class="lineCov">          7 :                         (int) getpid(), (unsigned int) ast_random());</span>
<span class="lineNum">    5299 </span>            : 
<span class="lineNum">    5300 </span><span class="lineCov">          7 :                 fprintf(p, &quot;Content-Type: multipart/mixed; boundary=\&quot;%s\&quot;&quot; ENDL, bound);</span>
<span class="lineNum">    5301 </span><span class="lineCov">          7 :                 fprintf(p, ENDL ENDL &quot;This is a multi-part message in MIME format.&quot; ENDL ENDL);</span>
<span class="lineNum">    5302 </span><span class="lineCov">          7 :                 fprintf(p, &quot;--%s&quot; ENDL, bound);</span>
<span class="lineNum">    5303 </span>            :         }
<span class="lineNum">    5304 </span><span class="lineCov">          7 :         fprintf(p, &quot;Content-Type: text/plain; charset=%s&quot; ENDL &quot;Content-Transfer-Encoding: 8bit&quot; ENDL ENDL, charset);</span>
<span class="lineNum">    5305 </span><span class="lineCov">          7 :         if (msgnum &lt;= -1) {</span>
<span class="lineNum">    5306 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;This message is to let you know that your greeting '%s' was changed on %s.&quot; ENDL</span>
<span class="lineNum">    5307 </span>            :                                 &quot;Please do not delete this message, lest your greeting vanish with it.&quot; ENDL ENDL,
<span class="lineNum">    5308 </span>            :                                 greeting_attachment, date);
<span class="lineNum">    5309 </span><span class="lineCov">          7 :         } else if (emailbody || vmu-&gt;emailbody) {</span>
<span class="lineNum">    5310 </span><span class="lineNoCov">          0 :                 char* e_body = vmu-&gt;emailbody ? vmu-&gt;emailbody : emailbody;</span>
<span class="lineNum">    5311 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5312 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5313 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</span>
<span class="lineNum">    5314 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, e_body);</span>
<span class="lineNum">    5315 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    5316 </span>            :                                 {
<span class="lineNum">    5317 </span>            :                                         /* Convert body to native line terminators for IMAP backend */
<span class="lineNum">    5318 </span>            :                                         char *line = ast_str_buffer(str1), *next;
<span class="lineNum">    5319 </span>            :                                         do {
<span class="lineNum">    5320 </span>            :                                                 /* Terminate line before outputting it to the file */
<span class="lineNum">    5321 </span>            :                                                 if ((next = strchr(line, '\n'))) {
<span class="lineNum">    5322 </span>            :                                                         *next++ = '\0';
<span class="lineNum">    5323 </span>            :                                                 }
<span class="lineNum">    5324 </span>            :                                                 fprintf(p, &quot;%s&quot; ENDL, line);
<span class="lineNum">    5325 </span>            :                                                 line = next;
<span class="lineNum">    5326 </span>            :                                         } while (!ast_strlen_zero(line));
<span class="lineNum">    5327 </span>            :                                 }
<span class="lineNum">    5328 </span>            : #else
<span class="lineNum">    5329 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;%s&quot; ENDL, ast_str_buffer(str1));</span>
<span class="lineNum">    5330 </span>            : #endif
<span class="lineNum">    5331 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5332 </span>            :                 } else {
<span class="lineNum">    5333 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5334 </span>            :                 }
<span class="lineNum">    5335 </span>            :         } else {
<span class="lineNum">    5336 </span><span class="lineCov">          7 :                 if (strcmp(vmu-&gt;mailbox, mailbox)) {</span>
<span class="lineNum">    5337 </span>            :                         /* Forwarded type */
<span class="lineNum">    5338 </span>            :                         struct ast_config *msg_cfg;
<span class="lineNum">    5339 </span>            :                         const char *v;
<span class="lineNum">    5340 </span>            :                         int inttime;
<span class="lineNum">    5341 </span><span class="lineNoCov">          0 :                         char fromdir[256], fromfile[256], origdate[80] = &quot;&quot;, origcallerid[80] = &quot;&quot;;</span>
<span class="lineNum">    5342 </span><span class="lineNoCov">          0 :                         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">    5343 </span>            :                         /* Retrieve info from VM attribute file */
<span class="lineNum">    5344 </span><span class="lineNoCov">          0 :                         make_dir(fromdir, sizeof(fromdir), vmu-&gt;context, vmu-&gt;mailbox, fromfolder);</span>
<span class="lineNum">    5345 </span><span class="lineNoCov">          0 :                         make_file(fromfile, sizeof(fromfile), fromdir, msgnum);</span>
<span class="lineNum">    5346 </span><span class="lineNoCov">          0 :                         if (strlen(fromfile) &lt; sizeof(fromfile) - 5) {</span>
<span class="lineNum">    5347 </span><span class="lineNoCov">          0 :                                 strcat(fromfile, &quot;.txt&quot;);</span>
<span class="lineNum">    5348 </span>            :                         }
<span class="lineNum">    5349 </span><span class="lineNoCov">          0 :                         if ((msg_cfg = ast_config_load(fromfile, config_flags)) &amp;&amp; valid_config(msg_cfg)) {</span>
<span class="lineNum">    5350 </span><span class="lineNoCov">          0 :                                 if ((v = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;))) {</span>
<span class="lineNum">    5351 </span><span class="lineNoCov">          0 :                                         ast_copy_string(origcallerid, v, sizeof(origcallerid));</span>
<span class="lineNum">    5352 </span>            :                                 }
<span class="lineNum">    5353 </span>            : 
<span class="lineNum">    5354 </span>            :                                 /* You might be tempted to do origdate, except that a) it's in the wrong
<span class="lineNum">    5355 </span>            :                                  * format, and b) it's missing for IMAP recordings. */
<span class="lineNum">    5356 </span><span class="lineNoCov">          0 :                                 if ((v = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origtime&quot;)) &amp;&amp; sscanf(v, &quot;%30d&quot;, &amp;inttime) == 1) {</span>
<span class="lineNum">    5357 </span><span class="lineNoCov">          0 :                                         struct timeval tv = { inttime, };</span>
<span class="lineNum">    5358 </span>            :                                         struct ast_tm tm;
<span class="lineNum">    5359 </span><span class="lineNoCov">          0 :                                         ast_localtime(&amp;tv, &amp;tm, NULL);</span>
<span class="lineNum">    5360 </span><span class="lineNoCov">          0 :                                         ast_strftime_locale(origdate, sizeof(origdate), emaildateformat, &amp;tm, S_OR(vmu-&gt;locale, NULL));</span>
<span class="lineNum">    5361 </span>            :                                 }
<span class="lineNum">    5362 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;Dear %s:&quot; ENDL ENDL &quot;\tJust wanted to let you know you were just forwarded&quot;</span>
<span class="lineNum">    5363 </span>            :                                         &quot; a %s long message (number %d)&quot; ENDL &quot;in mailbox %s from %s, on %s&quot; ENDL
<span class="lineNum">    5364 </span>            :                                         &quot;(originally sent by %s on %s)&quot; ENDL &quot;so you might want to check it when you get a&quot;
<span class="lineNum">    5365 </span><span class="lineNoCov">          0 :                                         &quot; chance.  Thanks!&quot; ENDL ENDL &quot;\t\t\t\t--Asterisk&quot; ENDL ENDL, vmu-&gt;fullname, dur,</span>
<span class="lineNum">    5366 </span><span class="lineNoCov">          0 :                                         msgnum + 1, mailbox, (cidname ? cidname : (cidnum ? cidnum : &quot;an unknown caller&quot;)),</span>
<span class="lineNum">    5367 </span>            :                                         date, origcallerid, origdate);
<span class="lineNum">    5368 </span><span class="lineNoCov">          0 :                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">    5369 </span>            :                         } else {
<span class="lineNum">    5370 </span><span class="lineNoCov">          0 :                                 goto plain_message;</span>
<span class="lineNum">    5371 </span>            :                         }
<span class="lineNum">    5372 </span>            :                 } else {
<span class="lineNum">    5373 </span><span class="lineCov">          7 : plain_message:</span>
<span class="lineNum">    5374 </span><span class="lineCov">          7 :                         fprintf(p, &quot;Dear %s:&quot; ENDL ENDL &quot;\tJust wanted to let you know you were just left a &quot;</span>
<span class="lineNum">    5375 </span>            :                                 &quot;%s long message (number %d)&quot; ENDL &quot;in mailbox %s from %s, on %s so you might&quot; ENDL
<span class="lineNum">    5376 </span>            :                                 &quot;want to check it when you get a chance.  Thanks!&quot; ENDL ENDL &quot;\t\t\t\t--Asterisk&quot;
<span class="lineNum">    5377 </span><span class="lineCov">          7 :                                 ENDL ENDL, vmu-&gt;fullname, dur, msgnum + 1, mailbox,</span>
<span class="lineNum">    5378 </span><span class="lineNoCov">          0 :                                 (cidname ? cidname : (cidnum ? cidnum : &quot;an unknown caller&quot;)), date);</span>
<span class="lineNum">    5379 </span>            :                 }
<span class="lineNum">    5380 </span>            :         }
<span class="lineNum">    5381 </span>            : 
<span class="lineNum">    5382 </span><span class="lineCov">          7 :         if (imap || attach_user_voicemail) {</span>
<span class="lineNum">    5383 </span><span class="lineCov">          7 :                 if (!ast_strlen_zero(attach2)) {</span>
<span class="lineNum">    5384 </span><span class="lineCov">          7 :                         snprintf(filename, sizeof(filename), &quot;msg%04d.%s&quot;, msgnum, format);</span>
<span class="lineNum">    5385 </span><span class="lineCov">          7 :                         ast_debug(5, &quot;creating second attachment filename %s\n&quot;, filename);</span>
<span class="lineNum">    5386 </span><span class="lineCov">          7 :                         add_email_attachment(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 0, msgnum);</span>
<span class="lineNum">    5387 </span><span class="lineCov">          7 :                         snprintf(filename, sizeof(filename), &quot;msgintro%04d.%s&quot;, msgnum, format);</span>
<span class="lineNum">    5388 </span><span class="lineCov">          7 :                         ast_debug(5, &quot;creating attachment filename %s\n&quot;, filename);</span>
<span class="lineNum">    5389 </span><span class="lineCov">          7 :                         add_email_attachment(p, vmu, format, attach2, greeting_attachment, mailbox, bound, filename, 1, msgnum);</span>
<span class="lineNum">    5390 </span>            :                 } else {
<span class="lineNum">    5391 </span><span class="lineNoCov">          0 :                         snprintf(filename, sizeof(filename), &quot;msg%04d.%s&quot;, msgnum, format);</span>
<span class="lineNum">    5392 </span><span class="lineNoCov">          0 :                         ast_debug(5, &quot;creating attachment filename %s, no second attachment.\n&quot;, filename);</span>
<span class="lineNum">    5393 </span><span class="lineNoCov">          0 :                         add_email_attachment(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 1, msgnum);</span>
<span class="lineNum">    5394 </span>            :                 }
<span class="lineNum">    5395 </span>            :         }
<span class="lineNum">    5396 </span><span class="lineCov">          7 :         ast_free(str1);</span>
<span class="lineNum">    5397 </span><span class="lineCov">          7 :         ast_free(str2);</span>
<a name="5398"><span class="lineNum">    5398 </span>            : }</a>
<span class="lineNum">    5399 </span>            : 
<span class="lineNum">    5400 </span><span class="lineCov">         14 : static int add_email_attachment(FILE *p, struct ast_vm_user *vmu, char *format, char *attach, char *greeting_attachment, char *mailbox, char *bound, char *filename, int last, int msgnum)</span>
<span class="lineNum">    5401 </span>            : {
<span class="lineNum">    5402 </span><span class="lineCov">         14 :         char fname[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">    5403 </span>            :         char sox_gain_tmpdir[PATH_MAX];
<span class="lineNum">    5404 </span><span class="lineCov">         14 :         char *file_to_delete = NULL, *dir_to_delete = NULL;</span>
<span class="lineNum">    5405 </span>            :         int res;
<span class="lineNum">    5406 </span>            : 
<span class="lineNum">    5407 </span>            :         /* Eww. We want formats to tell us their own MIME type */
<span class="lineNum">    5408 </span><span class="lineCov">         14 :         char *mime_type = (!strcasecmp(format, &quot;ogg&quot;)) ? &quot;application/&quot; : &quot;audio/x-&quot;;</span>
<span class="lineNum">    5409 </span>            : 
<span class="lineNum">    5410 </span>            :         /* This 'while' loop will only execute once. We use it so that we can 'break' */
<span class="lineNum">    5411 </span><span class="lineCov">         14 :         while (vmu-&gt;volgain &lt; -.001 || vmu-&gt;volgain &gt; .001) {</span>
<span class="lineNum">    5412 </span>            :                 char tmpdir[PATH_MAX];
<span class="lineNum">    5413 </span>            : 
<span class="lineNum">    5414 </span><span class="lineNoCov">          0 :                 create_dirpath(tmpdir, sizeof(tmpdir), vmu-&gt;context, vmu-&gt;mailbox, &quot;tmp&quot;);</span>
<span class="lineNum">    5415 </span>            : 
<span class="lineNum">    5416 </span><span class="lineNoCov">          0 :                 res = snprintf(sox_gain_tmpdir, sizeof(sox_gain_tmpdir), &quot;%s/vm-gain-XXXXXX&quot;, tmpdir);</span>
<span class="lineNum">    5417 </span><span class="lineNoCov">          0 :                 if (res &gt;= sizeof(sox_gain_tmpdir)) {</span>
<span class="lineNum">    5418 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Failed to create temporary directory path %s: Out of buffer space\n&quot;, tmpdir);</span>
<span class="lineNum">    5419 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    5420 </span>            :                 }
<span class="lineNum">    5421 </span>            : 
<span class="lineNum">    5422 </span><span class="lineNoCov">          0 :                 if (mkdtemp(sox_gain_tmpdir)) {</span>
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :                         int soxstatus = 0;</span>
<span class="lineNum">    5424 </span>            :                         char sox_gain_cmd[PATH_MAX];
<span class="lineNum">    5425 </span>            : 
<span class="lineNum">    5426 </span><span class="lineNoCov">          0 :                         ast_debug(3, &quot;sox_gain_tmpdir: %s\n&quot;, sox_gain_tmpdir);</span>
<span class="lineNum">    5427 </span>            : 
<span class="lineNum">    5428 </span>            :                         /* Save for later */
<span class="lineNum">    5429 </span><span class="lineNoCov">          0 :                         dir_to_delete = sox_gain_tmpdir;</span>
<span class="lineNum">    5430 </span>            : 
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :                         res = snprintf(fname, sizeof(fname), &quot;%s/output.%s&quot;, sox_gain_tmpdir, format);</span>
<span class="lineNum">    5432 </span><span class="lineNoCov">          0 :                         if (res &gt;= sizeof(fname)) {</span>
<span class="lineNum">    5433 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR, &quot;Failed to create filename buffer for %s/output.%s: Too long\n&quot;, sox_gain_tmpdir, format);</span>
<span class="lineNum">    5434 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    5435 </span>            :                         }
<span class="lineNum">    5436 </span>            : 
<span class="lineNum">    5437 </span><span class="lineNoCov">          0 :                         res = snprintf(sox_gain_cmd, sizeof(sox_gain_cmd), &quot;sox -v %.4f %s.%s %s&quot;,</span>
<span class="lineNum">    5438 </span>            :                                                    vmu-&gt;volgain, attach, format, fname);
<span class="lineNum">    5439 </span><span class="lineNoCov">          0 :                         if (res &gt;= sizeof(sox_gain_cmd)) {</span>
<span class="lineNum">    5440 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR, &quot;Failed to generate sox command, out of buffer space\n&quot;);</span>
<span class="lineNum">    5441 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    5442 </span>            :                         }
<span class="lineNum">    5443 </span>            : 
<span class="lineNum">    5444 </span><span class="lineNoCov">          0 :                         soxstatus = ast_safe_system(sox_gain_cmd);</span>
<span class="lineNum">    5445 </span><span class="lineNoCov">          0 :                         if (!soxstatus) {</span>
<span class="lineNum">    5446 </span>            :                                 /* Save for later */
<span class="lineNum">    5447 </span><span class="lineNoCov">          0 :                                 file_to_delete = fname;</span>
<span class="lineNum">    5448 </span><span class="lineNoCov">          0 :                                 ast_debug(3, &quot;VOLGAIN: Stored at: %s - Level: %.4f - Mailbox: %s\n&quot;, fname, vmu-&gt;volgain, mailbox);</span>
<span class="lineNum">    5449 </span>            :                         } else {
<span class="lineNum">    5450 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;Sox failed to re-encode %s: %s (have you installed support for all sox file formats?)\n&quot;,</span>
<span class="lineNum">    5451 </span>            :                                                 fname,
<span class="lineNum">    5452 </span>            :                                                 soxstatus == 1 ? &quot;Problem with command line options&quot; : &quot;An error occurred during file processing&quot;);
<span class="lineNum">    5453 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;Voicemail attachment will have no volume gain.\n&quot;);</span>
<span class="lineNum">    5454 </span>            :                         }
<span class="lineNum">    5455 </span>            :                 }
<span class="lineNum">    5456 </span>            : 
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    5458 </span>            :         }
<span class="lineNum">    5459 </span>            : 
<span class="lineNum">    5460 </span><span class="lineCov">         14 :         if (!file_to_delete) {</span>
<span class="lineNum">    5461 </span><span class="lineCov">         14 :                 res = snprintf(fname, sizeof(fname), &quot;%s.%s&quot;, attach, format);</span>
<span class="lineNum">    5462 </span><span class="lineCov">         14 :                 if (res &gt;= sizeof(fname)) {</span>
<span class="lineNum">    5463 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Failed to create filename buffer for %s.%s: Too long\n&quot;, attach, format);</span>
<span class="lineNum">    5464 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    5465 </span>            :                 }
<span class="lineNum">    5466 </span>            :         }
<span class="lineNum">    5467 </span>            : 
<span class="lineNum">    5468 </span><span class="lineCov">         14 :         fprintf(p, &quot;--%s&quot; ENDL, bound);</span>
<span class="lineNum">    5469 </span><span class="lineCov">         14 :         if (msgnum &gt; -1)</span>
<span class="lineNum">    5470 </span><span class="lineCov">         14 :                 fprintf(p, &quot;Content-Type: %s%s; name=\&quot;%s\&quot;&quot; ENDL, mime_type, format, filename);</span>
<span class="lineNum">    5471 </span>            :         else
<span class="lineNum">    5472 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;Content-Type: %s%s; name=\&quot;%s.%s\&quot;&quot; ENDL, mime_type, format, greeting_attachment, format);</span>
<span class="lineNum">    5473 </span><span class="lineCov">         14 :         fprintf(p, &quot;Content-Transfer-Encoding: base64&quot; ENDL);</span>
<span class="lineNum">    5474 </span><span class="lineCov">         14 :         fprintf(p, &quot;Content-Description: Voicemail sound attachment.&quot; ENDL);</span>
<span class="lineNum">    5475 </span><span class="lineCov">         14 :         if (msgnum &gt; -1)</span>
<span class="lineNum">    5476 </span><span class="lineCov">         14 :                 fprintf(p, &quot;Content-Disposition: attachment; filename=\&quot;%s\&quot;&quot; ENDL ENDL, filename);</span>
<span class="lineNum">    5477 </span>            :         else
<span class="lineNum">    5478 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;Content-Disposition: attachment; filename=\&quot;%s.%s\&quot;&quot; ENDL ENDL, greeting_attachment, format);</span>
<span class="lineNum">    5479 </span><span class="lineCov">         14 :         base_encode(fname, p);</span>
<span class="lineNum">    5480 </span><span class="lineCov">         14 :         if (last)</span>
<span class="lineNum">    5481 </span><span class="lineCov">          7 :                 fprintf(p, ENDL ENDL &quot;--%s--&quot; ENDL &quot;.&quot; ENDL, bound);</span>
<span class="lineNum">    5482 </span>            : 
<span class="lineNum">    5483 </span><span class="lineCov">         14 :         if (file_to_delete) {</span>
<span class="lineNum">    5484 </span><span class="lineNoCov">          0 :                 unlink(file_to_delete);</span>
<span class="lineNum">    5485 </span>            :         }
<span class="lineNum">    5486 </span>            : 
<span class="lineNum">    5487 </span><span class="lineCov">         14 :         if (dir_to_delete) {</span>
<span class="lineNum">    5488 </span><span class="lineNoCov">          0 :                 rmdir(dir_to_delete);</span>
<span class="lineNum">    5489 </span>            :         }
<span class="lineNum">    5490 </span>            : 
<span class="lineNum">    5491 </span><span class="lineCov">         14 :         return 0;</span>
<a name="5492"><span class="lineNum">    5492 </span>            : }</a>
<span class="lineNum">    5493 </span>            : 
<span class="lineNum">    5494 </span><span class="lineNoCov">          0 : static int sendmail(char *srcemail,</span>
<span class="lineNum">    5495 </span>            :                 struct ast_vm_user *vmu,
<span class="lineNum">    5496 </span>            :                 int msgnum,
<span class="lineNum">    5497 </span>            :                 char *context,
<span class="lineNum">    5498 </span>            :                 char *mailbox,
<span class="lineNum">    5499 </span>            :                 const char *fromfolder,
<span class="lineNum">    5500 </span>            :                 char *cidnum,
<span class="lineNum">    5501 </span>            :                 char *cidname,
<span class="lineNum">    5502 </span>            :                 char *attach,
<span class="lineNum">    5503 </span>            :                 char *attach2,
<span class="lineNum">    5504 </span>            :                 char *format,
<span class="lineNum">    5505 </span>            :                 int duration,
<span class="lineNum">    5506 </span>            :                 int attach_user_voicemail,
<span class="lineNum">    5507 </span>            :                 struct ast_channel *chan,
<span class="lineNum">    5508 </span>            :                 const char *category,
<span class="lineNum">    5509 </span>            :                 const char *flag,
<span class="lineNum">    5510 </span>            :                 const char *msg_id)
<span class="lineNum">    5511 </span>            : {
<span class="lineNum">    5512 </span><span class="lineNoCov">          0 :         FILE *p = NULL;</span>
<span class="lineNum">    5513 </span><span class="lineNoCov">          0 :         char tmp[80] = &quot;/tmp/astmail-XXXXXX&quot;;</span>
<span class="lineNum">    5514 </span>            :         char tmp2[256];
<span class="lineNum">    5515 </span>            :         char *stringp;
<span class="lineNum">    5516 </span>            : 
<span class="lineNum">    5517 </span><span class="lineNoCov">          0 :         if (vmu &amp;&amp; ast_strlen_zero(vmu-&gt;email)) {</span>
<span class="lineNum">    5518 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;E-mail address missing for mailbox [%s].  E-mail will not be sent.\n&quot;, vmu-&gt;mailbox);</span>
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :                 return(0);</span>
<span class="lineNum">    5520 </span>            :         }
<span class="lineNum">    5521 </span>            : 
<span class="lineNum">    5522 </span>            :         /* Mail only the first format */
<span class="lineNum">    5523 </span><span class="lineNoCov">          0 :         format = ast_strdupa(format);</span>
<span class="lineNum">    5524 </span><span class="lineNoCov">          0 :         stringp = format;</span>
<span class="lineNum">    5525 </span><span class="lineNoCov">          0 :         strsep(&amp;stringp, &quot;|&quot;);</span>
<span class="lineNum">    5526 </span>            : 
<span class="lineNum">    5527 </span><span class="lineNoCov">          0 :         if (!strcmp(format, &quot;wav49&quot;))</span>
<span class="lineNum">    5528 </span><span class="lineNoCov">          0 :                 format = &quot;WAV&quot;;</span>
<span class="lineNum">    5529 </span><span class="lineNoCov">          0 :         ast_debug(3, &quot;Attaching file '%s', format '%s', uservm is '%d', global is %u\n&quot;, attach, format, attach_user_voicemail, ast_test_flag((&amp;globalflags), VM_ATTACH));</span>
<span class="lineNum">    5530 </span>            :         /* Make a temporary file instead of piping directly to sendmail, in case the mail
<span class="lineNum">    5531 </span>            :            command hangs */
<span class="lineNum">    5532 </span><span class="lineNoCov">          0 :         if ((p = vm_mkftemp(tmp)) == NULL) {</span>
<span class="lineNum">    5533 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Unable to launch '%s' (can't create temporary file)\n&quot;, mailcmd);</span>
<span class="lineNum">    5534 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    5535 </span>            :         } else {
<span class="lineNum">    5536 </span><span class="lineNoCov">          0 :                 make_email_file(p, srcemail, vmu, msgnum, context, mailbox, fromfolder, cidnum, cidname, attach, attach2, format, duration, attach_user_voicemail, chan, category, 0, flag, msg_id);</span>
<span class="lineNum">    5537 </span><span class="lineNoCov">          0 :                 fclose(p);</span>
<span class="lineNum">    5538 </span><span class="lineNoCov">          0 :                 snprintf(tmp2, sizeof(tmp2), &quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;, mailcmd, tmp, tmp);</span>
<span class="lineNum">    5539 </span><span class="lineNoCov">          0 :                 ast_safe_system(tmp2);</span>
<span class="lineNum">    5540 </span><span class="lineNoCov">          0 :                 ast_debug(1, &quot;Sent mail to %s with command '%s'\n&quot;, vmu-&gt;email, mailcmd);</span>
<span class="lineNum">    5541 </span>            :         }
<span class="lineNum">    5542 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="5543"><span class="lineNum">    5543 </span>            : }</a>
<span class="lineNum">    5544 </span>            : 
<span class="lineNum">    5545 </span><span class="lineNoCov">          0 : static int sendpage(char *srcemail, char *pager, int msgnum, char *context, char *mailbox, const char *fromfolder, char *cidnum, char *cidname, int duration, struct ast_vm_user *vmu, const char *category, const char *flag)</span>
<span class="lineNum">    5546 </span>            : {
<span class="lineNum">    5547 </span>            :         char enc_cidnum[256], enc_cidname[256];
<span class="lineNum">    5548 </span>            :         char date[256];
<span class="lineNum">    5549 </span><span class="lineNoCov">          0 :         char host[MAXHOSTNAMELEN] = &quot;&quot;;</span>
<span class="lineNum">    5550 </span>            :         char who[256];
<span class="lineNum">    5551 </span>            :         char dur[PATH_MAX];
<span class="lineNum">    5552 </span><span class="lineNoCov">          0 :         char tmp[80] = &quot;/tmp/astmail-XXXXXX&quot;;</span>
<span class="lineNum">    5553 </span>            :         char tmp2[PATH_MAX];
<span class="lineNum">    5554 </span>            :         struct ast_tm tm;
<span class="lineNum">    5555 </span>            :         FILE *p;
<span class="lineNum">    5556 </span><span class="lineNoCov">          0 :         struct ast_str *str1 = ast_str_create(16), *str2 = ast_str_create(16);</span>
<span class="lineNum">    5557 </span>            : 
<span class="lineNum">    5558 </span><span class="lineNoCov">          0 :         if (!str1 || !str2) {</span>
<span class="lineNum">    5559 </span><span class="lineNoCov">          0 :                 ast_free(str1);</span>
<span class="lineNum">    5560 </span><span class="lineNoCov">          0 :                 ast_free(str2);</span>
<span class="lineNum">    5561 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    5562 </span>            :         }
<span class="lineNum">    5563 </span>            : 
<span class="lineNum">    5564 </span><span class="lineNoCov">          0 :         if (cidnum) {</span>
<span class="lineNum">    5565 </span><span class="lineNoCov">          0 :                 strip_control_and_high(cidnum, enc_cidnum, sizeof(enc_cidnum));</span>
<span class="lineNum">    5566 </span>            :         }
<span class="lineNum">    5567 </span><span class="lineNoCov">          0 :         if (cidname) {</span>
<span class="lineNum">    5568 </span><span class="lineNoCov">          0 :                 strip_control_and_high(cidname, enc_cidname, sizeof(enc_cidname));</span>
<span class="lineNum">    5569 </span>            :         }
<span class="lineNum">    5570 </span>            : 
<span class="lineNum">    5571 </span><span class="lineNoCov">          0 :         if ((p = vm_mkftemp(tmp)) == NULL) {</span>
<span class="lineNum">    5572 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Unable to launch '%s' (can't create temporary file)\n&quot;, mailcmd);</span>
<span class="lineNum">    5573 </span><span class="lineNoCov">          0 :                 ast_free(str1);</span>
<span class="lineNum">    5574 </span><span class="lineNoCov">          0 :                 ast_free(str2);</span>
<span class="lineNum">    5575 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    5576 </span>            :         }
<span class="lineNum">    5577 </span><span class="lineNoCov">          0 :         gethostname(host, sizeof(host)-1);</span>
<span class="lineNum">    5578 </span><span class="lineNoCov">          0 :         if (strchr(srcemail, '@')) {</span>
<span class="lineNum">    5579 </span><span class="lineNoCov">          0 :                 ast_copy_string(who, srcemail, sizeof(who));</span>
<span class="lineNum">    5580 </span>            :         } else {
<span class="lineNum">    5581 </span><span class="lineNoCov">          0 :                 snprintf(who, sizeof(who), &quot;%s@%s&quot;, srcemail, host);</span>
<span class="lineNum">    5582 </span>            :         }
<span class="lineNum">    5583 </span><span class="lineNoCov">          0 :         snprintf(dur, sizeof(dur), &quot;%d:%02d&quot;, duration / 60, duration % 60);</span>
<span class="lineNum">    5584 </span><span class="lineNoCov">          0 :         ast_strftime(date, sizeof(date), &quot;%a, %d %b %Y %H:%M:%S %z&quot;, vmu_tm(vmu, &amp;tm));</span>
<span class="lineNum">    5585 </span><span class="lineNoCov">          0 :         fprintf(p, &quot;Date: %s\n&quot;, date);</span>
<span class="lineNum">    5586 </span>            : 
<span class="lineNum">    5587 </span>            :         /* Reformat for custom pager format */
<span class="lineNum">    5588 </span><span class="lineNoCov">          0 :         ast_strftime_locale(date, sizeof(date), pagerdateformat, vmu_tm(vmu, &amp;tm), S_OR(vmu-&gt;locale, NULL));</span>
<span class="lineNum">    5589 </span>            : 
<span class="lineNum">    5590 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(pagerfromstring)) {</span>
<span class="lineNum">    5591 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5592 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5593 </span>            :                         char *ptr;
<span class="lineNum">    5594 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, enc_cidnum, enc_cidname, dur, date, category, flag);</span>
<span class="lineNum">    5595 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, pagerfromstring);</span>
<span class="lineNum">    5596 </span>            : 
<span class="lineNum">    5597 </span><span class="lineNoCov">          0 :                         if (check_mime(ast_str_buffer(str1))) {</span>
<span class="lineNum">    5598 </span><span class="lineNoCov">          0 :                                 int first_line = 1;</span>
<span class="lineNum">    5599 </span><span class="lineNoCov">          0 :                                 ast_str_encode_mime(&amp;str2, 0, ast_str_buffer(str1), strlen(&quot;From: &quot;), strlen(who) + 3);</span>
<span class="lineNum">    5600 </span><span class="lineNoCov">          0 :                                 while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5601 </span><span class="lineNoCov">          0 :                                         *ptr = '\0';</span>
<span class="lineNum">    5602 </span><span class="lineNoCov">          0 :                                         fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;From:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5603 </span><span class="lineNoCov">          0 :                                         first_line = 0;</span>
<span class="lineNum">    5604 </span>            :                                         /* Substring is smaller, so this will never grow */
<span class="lineNum">    5605 </span><span class="lineNoCov">          0 :                                         ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5606 </span>            :                                 }
<span class="lineNum">    5607 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;%s %s &lt;%s&gt;&quot; ENDL, first_line ? &quot;From:&quot; : &quot;&quot;, ast_str_buffer(str2), who);</span>
<span class="lineNum">    5608 </span>            :                         } else {
<span class="lineNum">    5609 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;From: %s &lt;%s&gt;&quot; ENDL, ast_str_quote(&amp;str2, 0, ast_str_buffer(str1)), who);</span>
<span class="lineNum">    5610 </span>            :                         }
<span class="lineNum">    5611 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5612 </span>            :                 } else {
<span class="lineNum">    5613 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5614 </span>            :                 }
<span class="lineNum">    5615 </span>            :         } else {
<span class="lineNum">    5616 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;From: Asterisk PBX &lt;%s&gt;&quot; ENDL, who);</span>
<span class="lineNum">    5617 </span>            :         }
<span class="lineNum">    5618 </span>            : 
<span class="lineNum">    5619 </span><span class="lineNoCov">          0 :         if (check_mime(vmu-&gt;fullname)) {</span>
<span class="lineNum">    5620 </span><span class="lineNoCov">          0 :                 int first_line = 1;</span>
<span class="lineNum">    5621 </span>            :                 char *ptr;
<span class="lineNum">    5622 </span><span class="lineNoCov">          0 :                 ast_str_encode_mime(&amp;str2, 0, vmu-&gt;fullname, strlen(&quot;To: &quot;), strlen(pager) + 3);</span>
<span class="lineNum">    5623 </span><span class="lineNoCov">          0 :                 while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5624 </span><span class="lineNoCov">          0 :                         *ptr = '\0';</span>
<span class="lineNum">    5625 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;To:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5626 </span><span class="lineNoCov">          0 :                         first_line = 0;</span>
<span class="lineNum">    5627 </span>            :                         /* Substring is smaller, so this will never grow */
<span class="lineNum">    5628 </span><span class="lineNoCov">          0 :                         ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5629 </span>            :                 }
<span class="lineNum">    5630 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;%s %s &lt;%s&gt;&quot; ENDL, first_line ? &quot;To:&quot; : &quot;&quot;, ast_str_buffer(str2), pager);</span>
<span class="lineNum">    5631 </span>            :         } else {
<span class="lineNum">    5632 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;To: %s &lt;%s&gt;&quot; ENDL, ast_str_quote(&amp;str2, 0, vmu-&gt;fullname), pager);</span>
<span class="lineNum">    5633 </span>            :         }
<span class="lineNum">    5634 </span>            : 
<span class="lineNum">    5635 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(pagersubject)) {</span>
<span class="lineNum">    5636 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5637 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5638 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</span>
<span class="lineNum">    5639 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, pagersubject);</span>
<span class="lineNum">    5640 </span><span class="lineNoCov">          0 :                         if (check_mime(ast_str_buffer(str1))) {</span>
<span class="lineNum">    5641 </span><span class="lineNoCov">          0 :                                 int first_line = 1;</span>
<span class="lineNum">    5642 </span>            :                                 char *ptr;
<span class="lineNum">    5643 </span><span class="lineNoCov">          0 :                                 ast_str_encode_mime(&amp;str2, 0, ast_str_buffer(str1), strlen(&quot;Subject: &quot;), 0);</span>
<span class="lineNum">    5644 </span><span class="lineNoCov">          0 :                                 while ((ptr = strchr(ast_str_buffer(str2), ' '))) {</span>
<span class="lineNum">    5645 </span><span class="lineNoCov">          0 :                                         *ptr = '\0';</span>
<span class="lineNum">    5646 </span><span class="lineNoCov">          0 :                                         fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;Subject:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5647 </span><span class="lineNoCov">          0 :                                         first_line = 0;</span>
<span class="lineNum">    5648 </span>            :                                         /* Substring is smaller, so this will never grow */
<span class="lineNum">    5649 </span><span class="lineNoCov">          0 :                                         ast_str_set(&amp;str2, 0, &quot;%s&quot;, ptr + 1);</span>
<span class="lineNum">    5650 </span>            :                                 }
<span class="lineNum">    5651 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;%s %s&quot; ENDL, first_line ? &quot;Subject:&quot; : &quot;&quot;, ast_str_buffer(str2));</span>
<span class="lineNum">    5652 </span>            :                         } else {
<span class="lineNum">    5653 </span><span class="lineNoCov">          0 :                                 fprintf(p, &quot;Subject: %s&quot; ENDL, ast_str_buffer(str1));</span>
<span class="lineNum">    5654 </span>            :                         }
<span class="lineNum">    5655 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5656 </span>            :                 } else {
<span class="lineNum">    5657 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5658 </span>            :                 }
<span class="lineNum">    5659 </span>            :         } else {
<span class="lineNum">    5660 </span><span class="lineNoCov">          0 :                 if (ast_strlen_zero(flag)) {</span>
<span class="lineNum">    5661 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;Subject: New VM\n\n&quot;);</span>
<span class="lineNum">    5662 </span>            :                 } else {
<span class="lineNum">    5663 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;Subject: New %s VM\n\n&quot;, flag);</span>
<span class="lineNum">    5664 </span>            :                 }
<span class="lineNum">    5665 </span>            :         }
<span class="lineNum">    5666 </span>            : 
<span class="lineNum">    5667 </span><span class="lineNoCov">          0 :         if (pagerbody) {</span>
<span class="lineNum">    5668 </span>            :                 struct ast_channel *ast;
<span class="lineNum">    5669 </span><span class="lineNoCov">          0 :                 if ((ast = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">    5670 </span><span class="lineNoCov">          0 :                         prep_email_sub_vars(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, category, flag);</span>
<span class="lineNum">    5671 </span><span class="lineNoCov">          0 :                         ast_str_substitute_variables(&amp;str1, 0, ast, pagerbody);</span>
<span class="lineNum">    5672 </span><span class="lineNoCov">          0 :                         fprintf(p, &quot;%s&quot; ENDL, ast_str_buffer(str1));</span>
<span class="lineNum">    5673 </span><span class="lineNoCov">          0 :                         ast = ast_channel_unref(ast);</span>
<span class="lineNum">    5674 </span>            :                 } else {
<span class="lineNum">    5675 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Cannot allocate the channel for variables substitution\n&quot;);</span>
<span class="lineNum">    5676 </span>            :                 }
<span class="lineNum">    5677 </span>            :         } else {
<span class="lineNum">    5678 </span><span class="lineNoCov">          0 :                 fprintf(p, &quot;New %s long %s msg in box %s\n&quot;</span>
<span class="lineNum">    5679 </span><span class="lineNoCov">          0 :                                 &quot;from %s, on %s&quot;, dur, flag, mailbox, (cidname ? cidname : (cidnum ? cidnum : &quot;unknown&quot;)), date);</span>
<span class="lineNum">    5680 </span>            :         }
<span class="lineNum">    5681 </span>            : 
<span class="lineNum">    5682 </span><span class="lineNoCov">          0 :         fclose(p);</span>
<span class="lineNum">    5683 </span><span class="lineNoCov">          0 :         snprintf(tmp2, sizeof(tmp2), &quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;, mailcmd, tmp, tmp);</span>
<span class="lineNum">    5684 </span><span class="lineNoCov">          0 :         ast_safe_system(tmp2);</span>
<span class="lineNum">    5685 </span><span class="lineNoCov">          0 :         ast_debug(1, &quot;Sent page to %s with command '%s'\n&quot;, pager, mailcmd);</span>
<span class="lineNum">    5686 </span><span class="lineNoCov">          0 :         ast_free(str1);</span>
<span class="lineNum">    5687 </span><span class="lineNoCov">          0 :         ast_free(str2);</span>
<span class="lineNum">    5688 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    5689 </span>            : }
<span class="lineNum">    5690 </span>            : 
<span class="lineNum">    5691 </span>            : /*!
<span class="lineNum">    5692 </span>            :  * \brief Gets the current date and time, as formatted string.
<span class="lineNum">    5693 </span>            :  * \param s The buffer to hold the output formatted date.
<span class="lineNum">    5694 </span>            :  * \param len the length of the buffer. Used to prevent buffer overflow in ast_strftime.
<span class="lineNum">    5695 </span>            :  *
<span class="lineNum">    5696 </span>            :  * The date format string used is &quot;%a %b %e %r UTC %Y&quot;.
<span class="lineNum">    5697 </span>            :  *
<a name="5698"><span class="lineNum">    5698 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    5699 </span>            :  */
<span class="lineNum">    5700 </span><span class="lineCov">         11 : static int get_date(char *s, int len)</span>
<span class="lineNum">    5701 </span>            : {
<span class="lineNum">    5702 </span>            :         struct ast_tm tm;
<span class="lineNum">    5703 </span><span class="lineCov">         11 :         struct timeval t = ast_tvnow();</span>
<span class="lineNum">    5704 </span>            : 
<span class="lineNum">    5705 </span><span class="lineCov">         11 :         ast_localtime(&amp;t, &amp;tm, &quot;UTC&quot;);</span>
<span class="lineNum">    5706 </span>            : 
<span class="lineNum">    5707 </span><span class="lineCov">         11 :         return ast_strftime(s, len, &quot;%a %b %e %r UTC %Y&quot;, &amp;tm);</span>
<a name="5708"><span class="lineNum">    5708 </span>            : }</a>
<span class="lineNum">    5709 </span>            : 
<span class="lineNum">    5710 </span><span class="lineCov">         20 : static int invent_message(struct ast_channel *chan, char *context, char *ext, int busy, char *ecodes)</span>
<span class="lineNum">    5711 </span>            : {
<span class="lineNum">    5712 </span>            :         int res;
<span class="lineNum">    5713 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    5714 </span>            :         char dest[PATH_MAX];
<span class="lineNum">    5715 </span>            : 
<span class="lineNum">    5716 </span><span class="lineCov">         20 :         snprintf(fn, sizeof(fn), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, context, ext);</span>
<span class="lineNum">    5717 </span>            : 
<span class="lineNum">    5718 </span><span class="lineCov">         20 :         if ((res = create_dirpath(dest, sizeof(dest), context, ext, &quot;&quot;))) {</span>
<span class="lineNum">    5719 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Failed to make directory(%s)\n&quot;, fn);</span>
<span class="lineNum">    5720 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    5721 </span>            :         }
<span class="lineNum">    5722 </span>            : 
<span class="lineNum">    5723 </span>            :         RETRIEVE(fn, -1, ext, context);
<span class="lineNum">    5724 </span><span class="lineCov">         20 :         if (ast_fileexists(fn, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    5725 </span><span class="lineNoCov">          0 :                 res = ast_stream_and_wait(chan, fn, ecodes);</span>
<span class="lineNum">    5726 </span><span class="lineNoCov">          0 :                 if (res) {</span>
<span class="lineNum">    5727 </span>            :                         DISPOSE(fn, -1);
<span class="lineNum">    5728 </span><span class="lineNoCov">          0 :                         return res;</span>
<span class="lineNum">    5729 </span>            :                 }
<span class="lineNum">    5730 </span>            :         } else {
<span class="lineNum">    5731 </span>            :                 /* Dispose just in case */
<span class="lineNum">    5732 </span>            :                 DISPOSE(fn, -1);
<span class="lineNum">    5733 </span><span class="lineCov">         20 :                 res = ast_stream_and_wait(chan, &quot;vm-theperson&quot;, ecodes);</span>
<span class="lineNum">    5734 </span><span class="lineCov">         20 :                 if (res)</span>
<span class="lineNum">    5735 </span><span class="lineNoCov">          0 :                         return res;</span>
<span class="lineNum">    5736 </span><span class="lineCov">         20 :                 res = ast_say_digit_str(chan, ext, ecodes, ast_channel_language(chan));</span>
<span class="lineNum">    5737 </span><span class="lineCov">         20 :                 if (res)</span>
<span class="lineNum">    5738 </span><span class="lineNoCov">          0 :                         return res;</span>
<span class="lineNum">    5739 </span>            :         }
<span class="lineNum">    5740 </span><span class="lineCov">         20 :         res = ast_stream_and_wait(chan, busy ? &quot;vm-isonphone&quot; : &quot;vm-isunavail&quot;, ecodes);</span>
<span class="lineNum">    5741 </span><span class="lineCov">         20 :         return res;</span>
<a name="5742"><span class="lineNum">    5742 </span>            : }</a>
<span class="lineNum">    5743 </span>            : 
<span class="lineNum">    5744 </span><span class="lineCov">       5320 : static void free_zone(struct vm_zone *z)</span>
<span class="lineNum">    5745 </span>            : {
<span class="lineNum">    5746 </span><span class="lineCov">       5320 :         ast_free(z);</span>
<span class="lineNum">    5747 </span><span class="lineCov">       5320 : }</span>
<span class="lineNum">    5748 </span>            : 
<span class="lineNum">    5749 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">    5750 </span>            : 
<span class="lineNum">    5751 </span>            : static int count_messages_in_folder(struct odbc_obj *odbc, const char *context, const char *mailbox, const char *folder, int *messages)
<span class="lineNum">    5752 </span>            : {
<span class="lineNum">    5753 </span>            :         int res;
<span class="lineNum">    5754 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    5755 </span>            :         char rowdata[20];
<span class="lineNum">    5756 </span>            :         SQLHSTMT stmt = NULL;
<span class="lineNum">    5757 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 0 };
<span class="lineNum">    5758 </span>            : 
<span class="lineNum">    5759 </span>            :         if (!messages) {
<span class="lineNum">    5760 </span>            :                 return 0;
<span class="lineNum">    5761 </span>            :         }
<span class="lineNum">    5762 </span>            : 
<span class="lineNum">    5763 </span>            :         snprintf(sql, sizeof(sql), &quot;SELECT COUNT(*) FROM %s WHERE dir = '%s%s/%s/%s'&quot;, odbc_table, VM_SPOOL_DIR, context, mailbox, folder);
<span class="lineNum">    5764 </span>            :         if (!(stmt = ast_odbc_prepare_and_execute(odbc, generic_prepare, &amp;gps))) {
<span class="lineNum">    5765 </span>            :                 ast_log(LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5766 </span>            :                 return 1;
<span class="lineNum">    5767 </span>            :         }
<span class="lineNum">    5768 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    5769 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    5770 </span>            :                 ast_log(LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5771 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    5772 </span>            :                 return 1;
<span class="lineNum">    5773 </span>            :         }
<span class="lineNum">    5774 </span>            :         res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    5775 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    5776 </span>            :                 ast_log(LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5777 </span>            :                 SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    5778 </span>            :                 return 1;
<span class="lineNum">    5779 </span>            :         }
<span class="lineNum">    5780 </span>            : 
<span class="lineNum">    5781 </span>            :         *messages = atoi(rowdata);
<span class="lineNum">    5782 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    5783 </span>            : 
<span class="lineNum">    5784 </span>            :         return 0;
<span class="lineNum">    5785 </span>            : }
<span class="lineNum">    5786 </span>            : 
<span class="lineNum">    5787 </span>            : static int inboxcount2(const char *mailbox, int *urgentmsgs, int *newmsgs, int *oldmsgs)
<span class="lineNum">    5788 </span>            : {
<span class="lineNum">    5789 </span>            :         char tmp[PATH_MAX] = &quot;&quot;;
<span class="lineNum">    5790 </span>            :         struct odbc_obj *obj;
<span class="lineNum">    5791 </span>            :         char *context;
<span class="lineNum">    5792 </span>            : 
<span class="lineNum">    5793 </span>            :         if (newmsgs)
<span class="lineNum">    5794 </span>            :                 *newmsgs = 0;
<span class="lineNum">    5795 </span>            :         if (oldmsgs)
<span class="lineNum">    5796 </span>            :                 *oldmsgs = 0;
<span class="lineNum">    5797 </span>            :         if (urgentmsgs)
<span class="lineNum">    5798 </span>            :                 *urgentmsgs = 0;
<span class="lineNum">    5799 </span>            : 
<span class="lineNum">    5800 </span>            :         /* If no mailbox, return immediately */
<span class="lineNum">    5801 </span>            :         if (ast_strlen_zero(mailbox))
<span class="lineNum">    5802 </span>            :                 return 0;
<span class="lineNum">    5803 </span>            : 
<span class="lineNum">    5804 </span>            :         ast_copy_string(tmp, mailbox, sizeof(tmp));
<span class="lineNum">    5805 </span>            : 
<span class="lineNum">    5806 </span>            :         if (strchr(mailbox, ' ') || strchr(mailbox, ',')) {
<span class="lineNum">    5807 </span>            :                 int u, n, o;
<span class="lineNum">    5808 </span>            :                 char *next, *remaining = tmp;
<span class="lineNum">    5809 </span>            :                 while ((next = strsep(&amp;remaining, &quot; ,&quot;))) {
<span class="lineNum">    5810 </span>            :                         if (inboxcount2(next, urgentmsgs ? &amp;u : NULL, &amp;n, &amp;o)) {
<span class="lineNum">    5811 </span>            :                                 return -1;
<span class="lineNum">    5812 </span>            :                         }
<span class="lineNum">    5813 </span>            :                         if (urgentmsgs) {
<span class="lineNum">    5814 </span>            :                                 *urgentmsgs += u;
<span class="lineNum">    5815 </span>            :                         }
<span class="lineNum">    5816 </span>            :                         if (newmsgs) {
<span class="lineNum">    5817 </span>            :                                 *newmsgs += n;
<span class="lineNum">    5818 </span>            :                         }
<span class="lineNum">    5819 </span>            :                         if (oldmsgs) {
<span class="lineNum">    5820 </span>            :                                 *oldmsgs += o;
<span class="lineNum">    5821 </span>            :                         }
<span class="lineNum">    5822 </span>            :                 }
<span class="lineNum">    5823 </span>            :                 return 0;
<span class="lineNum">    5824 </span>            :         }
<span class="lineNum">    5825 </span>            : 
<span class="lineNum">    5826 </span>            :         context = strchr(tmp, '@');
<span class="lineNum">    5827 </span>            :         if (context) {
<span class="lineNum">    5828 </span>            :                 *context = '\0';
<span class="lineNum">    5829 </span>            :                 context++;
<span class="lineNum">    5830 </span>            :         } else
<span class="lineNum">    5831 </span>            :                 context = &quot;default&quot;;
<span class="lineNum">    5832 </span>            : 
<span class="lineNum">    5833 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    5834 </span>            :         if (!obj) {
<span class="lineNum">    5835 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    5836 </span>            :                 return -1;
<span class="lineNum">    5837 </span>            :         }
<span class="lineNum">    5838 </span>            : 
<span class="lineNum">    5839 </span>            :         if (count_messages_in_folder(obj, context, tmp, &quot;INBOX&quot;, newmsgs)
<span class="lineNum">    5840 </span>            :            || count_messages_in_folder(obj, context, tmp, &quot;Old&quot;, oldmsgs)
<span class="lineNum">    5841 </span>            :            || count_messages_in_folder(obj, context, tmp, &quot;Urgent&quot;, urgentmsgs)) {
<span class="lineNum">    5842 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain message count for mailbox %s@%s\n&quot;,
<span class="lineNum">    5843 </span>            :                                 tmp, context);
<span class="lineNum">    5844 </span>            :         }
<span class="lineNum">    5845 </span>            : 
<span class="lineNum">    5846 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    5847 </span>            :         return 0;
<span class="lineNum">    5848 </span>            : }
<span class="lineNum">    5849 </span>            : 
<span class="lineNum">    5850 </span>            : /*!
<span class="lineNum">    5851 </span>            :  * \brief Gets the number of messages that exist in a mailbox folder.
<span class="lineNum">    5852 </span>            :  * \param mailbox_id
<span class="lineNum">    5853 </span>            :  * \param folder
<span class="lineNum">    5854 </span>            :  *
<span class="lineNum">    5855 </span>            :  * This method is used when ODBC backend is used.
<span class="lineNum">    5856 </span>            :  * \return The number of messages in this mailbox folder (zero or more).
<span class="lineNum">    5857 </span>            :  */
<span class="lineNum">    5858 </span>            : static int messagecount(const char *mailbox_id, const char *folder)
<span class="lineNum">    5859 </span>            : {
<span class="lineNum">    5860 </span>            :         struct odbc_obj *obj = NULL;
<span class="lineNum">    5861 </span>            :         char *context;
<span class="lineNum">    5862 </span>            :         char *mailbox;
<span class="lineNum">    5863 </span>            :         int nummsgs = 0;
<span class="lineNum">    5864 </span>            :         int res;
<span class="lineNum">    5865 </span>            :         SQLHSTMT stmt = NULL;
<span class="lineNum">    5866 </span>            :         char sql[PATH_MAX];
<span class="lineNum">    5867 </span>            :         char rowdata[20];
<span class="lineNum">    5868 </span>            :         struct generic_prepare_struct gps = { .sql = sql, .argc = 0 };
<span class="lineNum">    5869 </span>            : 
<span class="lineNum">    5870 </span>            :         /* If no mailbox, return immediately */
<span class="lineNum">    5871 </span>            :         if (ast_strlen_zero(mailbox_id)
<span class="lineNum">    5872 </span>            :                 || separate_mailbox(ast_strdupa(mailbox_id), &amp;mailbox, &amp;context)) {
<span class="lineNum">    5873 </span>            :                 return 0;
<span class="lineNum">    5874 </span>            :         }
<span class="lineNum">    5875 </span>            : 
<span class="lineNum">    5876 </span>            :         if (ast_strlen_zero(folder)) {
<span class="lineNum">    5877 </span>            :                 folder = &quot;INBOX&quot;;
<span class="lineNum">    5878 </span>            :         }
<span class="lineNum">    5879 </span>            : 
<span class="lineNum">    5880 </span>            :         obj = ast_odbc_request_obj(odbc_database, 0);
<span class="lineNum">    5881 </span>            :         if (!obj) {
<span class="lineNum">    5882 </span>            :                 ast_log(AST_LOG_WARNING, &quot;Failed to obtain database object for '%s'!\n&quot;, odbc_database);
<span class="lineNum">    5883 </span>            :                 return 0;
<span class="lineNum">    5884 </span>            :         }
<span class="lineNum">    5885 </span>            : 
<span class="lineNum">    5886 </span>            :         if (!strcmp(folder, &quot;INBOX&quot;)) {
<span class="lineNum">    5887 </span>            :                 snprintf(sql, sizeof(sql), &quot;SELECT COUNT(*) FROM %s WHERE dir = '%s%s/%s/INBOX' OR dir = '%s%s/%s/Urgent'&quot;, odbc_table, VM_SPOOL_DIR, context, mailbox, VM_SPOOL_DIR, context, mailbox);
<span class="lineNum">    5888 </span>            :         } else {
<span class="lineNum">    5889 </span>            :                 snprintf(sql, sizeof(sql), &quot;SELECT COUNT(*) FROM %s WHERE dir = '%s%s/%s/%s'&quot;, odbc_table, VM_SPOOL_DIR, context, mailbox, folder);
<span class="lineNum">    5890 </span>            :         }
<span class="lineNum">    5891 </span>            : 
<span class="lineNum">    5892 </span>            :         stmt = ast_odbc_prepare_and_execute(obj, generic_prepare, &amp;gps);
<span class="lineNum">    5893 </span>            :         if (!stmt) {
<span class="lineNum">    5894 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Execute error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5895 </span>            :                 goto bail;
<span class="lineNum">    5896 </span>            :         }
<span class="lineNum">    5897 </span>            :         res = SQLFetch(stmt);
<span class="lineNum">    5898 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    5899 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Fetch error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5900 </span>            :                 goto bail_with_handle;
<span class="lineNum">    5901 </span>            :         }
<span class="lineNum">    5902 </span>            :         res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, sizeof(rowdata), NULL);
<span class="lineNum">    5903 </span>            :         if (!SQL_SUCCEEDED(res)) {
<span class="lineNum">    5904 </span>            :                 ast_log(AST_LOG_WARNING, &quot;SQL Get Data error!\n[%s]\n\n&quot;, sql);
<span class="lineNum">    5905 </span>            :                 goto bail_with_handle;
<span class="lineNum">    5906 </span>            :         }
<span class="lineNum">    5907 </span>            :         nummsgs = atoi(rowdata);
<span class="lineNum">    5908 </span>            : 
<span class="lineNum">    5909 </span>            : bail_with_handle:
<span class="lineNum">    5910 </span>            :         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<span class="lineNum">    5911 </span>            : 
<span class="lineNum">    5912 </span>            : bail:
<span class="lineNum">    5913 </span>            :         ast_odbc_release_obj(obj);
<span class="lineNum">    5914 </span>            :         return nummsgs;
<span class="lineNum">    5915 </span>            : }
<span class="lineNum">    5916 </span>            : 
<span class="lineNum">    5917 </span>            : /**
<span class="lineNum">    5918 </span>            :  * \brief Determines if the given folder has messages.
<span class="lineNum">    5919 </span>            :  * \param mailbox The @ delimited string for user@context. If no context is found, uses 'default' for the context.
<span class="lineNum">    5920 </span>            :  *
<span class="lineNum">    5921 </span>            :  * This function is used when the mailbox is stored in an ODBC back end.
<span class="lineNum">    5922 </span>            :  * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.
<span class="lineNum">    5923 </span>            :  * \return 1 if the folder has one or more messages. zero otherwise.
<span class="lineNum">    5924 </span>            :  */
<span class="lineNum">    5925 </span>            : static int has_voicemail(const char *mailboxes, const char *folder)
<span class="lineNum">    5926 </span>            : {
<span class="lineNum">    5927 </span>            :         char *parse;
<span class="lineNum">    5928 </span>            :         char *mailbox;
<span class="lineNum">    5929 </span>            : 
<span class="lineNum">    5930 </span>            :         parse = ast_strdupa(mailboxes);
<span class="lineNum">    5931 </span>            :         while ((mailbox = strsep(&amp;parse, &quot;,&amp;&quot;))) {
<span class="lineNum">    5932 </span>            :                 if (messagecount(mailbox, folder)) {
<span class="lineNum">    5933 </span>            :                         return 1;
<span class="lineNum">    5934 </span>            :                 }
<span class="lineNum">    5935 </span>            :         }
<span class="lineNum">    5936 </span>            :         return 0;
<span class="lineNum">    5937 </span>            : }
<span class="lineNum">    5938 </span>            : #endif
<span class="lineNum">    5939 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    5940 </span>            : /*!
<span class="lineNum">    5941 </span>            :  * \brief Copies a message from one mailbox to another.
<span class="lineNum">    5942 </span>            :  * \param chan
<span class="lineNum">    5943 </span>            :  * \param vmu
<span class="lineNum">    5944 </span>            :  * \param imbox
<span class="lineNum">    5945 </span>            :  * \param msgnum
<span class="lineNum">    5946 </span>            :  * \param duration
<span class="lineNum">    5947 </span>            :  * \param recip
<span class="lineNum">    5948 </span>            :  * \param fmt
<span class="lineNum">    5949 </span>            :  * \param dir
<span class="lineNum">    5950 </span>            :  * \param flag, dest_folder
<span class="lineNum">    5951 </span>            :  *
<span class="lineNum">    5952 </span>            :  * This is only used by file storage based mailboxes.
<span class="lineNum">    5953 </span>            :  *
<a name="5954"><span class="lineNum">    5954 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    5955 </span>            :  */
<span class="lineNum">    5956 </span><span class="lineCov">         20 : static int copy_message(struct ast_channel *chan, struct ast_vm_user *vmu, int imbox, int msgnum, long duration, struct ast_vm_user *recip, char *fmt, char *dir, const char *flag, const char *dest_folder)</span>
<span class="lineNum">    5957 </span>            : {
<span class="lineNum">    5958 </span>            :         char fromdir[PATH_MAX], todir[PATH_MAX], frompath[PATH_MAX], topath[PATH_MAX];
<span class="lineNum">    5959 </span><span class="lineCov">         20 :         const char *frombox = mbox(vmu, imbox);</span>
<span class="lineNum">    5960 </span>            :         const char *userfolder;
<span class="lineNum">    5961 </span>            :         int recipmsgnum;
<span class="lineNum">    5962 </span><span class="lineCov">         20 :         int res = 0;</span>
<span class="lineNum">    5963 </span>            : 
<span class="lineNum">    5964 </span><span class="lineCov">         20 :         ast_log(AST_LOG_NOTICE, &quot;Copying message from %s@%s to %s@%s\n&quot;, vmu-&gt;mailbox, vmu-&gt;context, recip-&gt;mailbox, recip-&gt;context);</span>
<span class="lineNum">    5965 </span>            : 
<span class="lineNum">    5966 </span><span class="lineCov">         20 :         if (!ast_strlen_zero(flag) &amp;&amp; !strcmp(flag, &quot;Urgent&quot;)) { /* If urgent, copy to Urgent folder */</span>
<span class="lineNum">    5967 </span><span class="lineCov">          5 :                 userfolder = &quot;Urgent&quot;;</span>
<span class="lineNum">    5968 </span><span class="lineCov">         15 :         } else if (!ast_strlen_zero(dest_folder)) {</span>
<span class="lineNum">    5969 </span><span class="lineCov">          8 :                 userfolder = dest_folder;</span>
<span class="lineNum">    5970 </span>            :         } else {
<span class="lineNum">    5971 </span><span class="lineCov">          7 :                 userfolder = &quot;INBOX&quot;;</span>
<span class="lineNum">    5972 </span>            :         }
<span class="lineNum">    5973 </span>            : 
<span class="lineNum">    5974 </span><span class="lineCov">         20 :         create_dirpath(todir, sizeof(todir), recip-&gt;context, recip-&gt;mailbox, userfolder);</span>
<span class="lineNum">    5975 </span>            : 
<span class="lineNum">    5976 </span><span class="lineCov">         20 :         if (!dir)</span>
<span class="lineNum">    5977 </span><span class="lineNoCov">          0 :                 make_dir(fromdir, sizeof(fromdir), vmu-&gt;context, vmu-&gt;mailbox, frombox);</span>
<span class="lineNum">    5978 </span>            :         else
<span class="lineNum">    5979 </span><span class="lineCov">         20 :                 ast_copy_string(fromdir, dir, sizeof(fromdir));</span>
<span class="lineNum">    5980 </span>            : 
<span class="lineNum">    5981 </span><span class="lineCov">         20 :         make_file(frompath, sizeof(frompath), fromdir, msgnum);</span>
<span class="lineNum">    5982 </span><span class="lineCov">         20 :         make_dir(todir, sizeof(todir), recip-&gt;context, recip-&gt;mailbox, userfolder);</span>
<span class="lineNum">    5983 </span>            : 
<span class="lineNum">    5984 </span><span class="lineCov">         20 :         if (vm_lock_path(todir))</span>
<span class="lineNum">    5985 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    5986 </span>            : 
<span class="lineNum">    5987 </span><span class="lineCov">         20 :         recipmsgnum = last_message_index(recip, todir) + 1;</span>
<span class="lineNum">    5988 </span><span class="lineCov">         20 :         if (recipmsgnum &lt; recip-&gt;maxmsg - (imbox ? 0 : inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, 0))) {</span>
<span class="lineNum">    5989 </span><span class="lineCov">         20 :                 make_file(topath, sizeof(topath), todir, recipmsgnum);</span>
<span class="lineNum">    5990 </span>            : #ifndef ODBC_STORAGE
<span class="lineNum">    5991 </span><span class="lineCov">         20 :                 if (EXISTS(fromdir, msgnum, frompath, chan ? ast_channel_language(chan) : &quot;&quot;)) {</span>
<span class="lineNum">    5992 </span><span class="lineCov">         20 :                         COPY(fromdir, msgnum, todir, recipmsgnum, recip-&gt;mailbox, recip-&gt;context, frompath, topath);</span>
<span class="lineNum">    5993 </span>            :                 } else {
<span class="lineNum">    5994 </span>            : #endif
<span class="lineNum">    5995 </span>            :                         /* If we are prepending a message for ODBC, then the message already
<span class="lineNum">    5996 </span>            :                          * exists in the database, but we want to force copying from the
<span class="lineNum">    5997 </span>            :                          * filesystem (since only the FS contains the prepend). */
<span class="lineNum">    5998 </span><span class="lineNoCov">          0 :                         copy_plain_file(frompath, topath);</span>
<span class="lineNum">    5999 </span>            :                         STORE(todir, recip-&gt;mailbox, recip-&gt;context, recipmsgnum, chan, recip, fmt, duration, NULL, NULL, NULL);
<span class="lineNum">    6000 </span><span class="lineNoCov">          0 :                         vm_delete(topath);</span>
<span class="lineNum">    6001 </span>            : #ifndef ODBC_STORAGE
<span class="lineNum">    6002 </span>            :                 }
<span class="lineNum">    6003 </span>            : #endif
<span class="lineNum">    6004 </span>            :         } else {
<span class="lineNum">    6005 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Recipient mailbox %s@%s is full\n&quot;, recip-&gt;mailbox, recip-&gt;context);</span>
<span class="lineNum">    6006 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">    6007 </span>            :         }
<span class="lineNum">    6008 </span><span class="lineCov">         20 :         ast_unlock_path(todir);</span>
<span class="lineNum">    6009 </span><span class="lineCov">         20 :         if (chan) {</span>
<span class="lineNum">    6010 </span><span class="lineCov">         12 :                 struct ast_party_caller *caller = ast_channel_caller(chan);</span>
<span class="lineNum">    6011 </span><span class="lineCov">         12 :                 notify_new_message(chan, recip, NULL, recipmsgnum, duration, fmt,</span>
<span class="lineNum">    6012 </span><span class="lineCov">         12 :                         S_COR(caller-&gt;id.number.valid, caller-&gt;id.number.str, NULL),</span>
<span class="lineNum">    6013 </span><span class="lineCov">         12 :                         S_COR(caller-&gt;id.name.valid, caller-&gt;id.name.str, NULL),</span>
<span class="lineNum">    6014 </span>            :                         flag);
<span class="lineNum">    6015 </span>            :         }
<span class="lineNum">    6016 </span>            : 
<span class="lineNum">    6017 </span><span class="lineCov">         20 :         return res;</span>
<span class="lineNum">    6018 </span>            : }
<span class="lineNum">    6019 </span>            : #endif
<a name="6020"><span class="lineNum">    6020 </span>            : #if !(defined(IMAP_STORAGE) || defined(ODBC_STORAGE))</a>
<span class="lineNum">    6021 </span>            : 
<span class="lineNum">    6022 </span><span class="lineCov">         12 : static int messagecount(const char *mailbox_id, const char *folder)</span>
<span class="lineNum">    6023 </span>            : {
<span class="lineNum">    6024 </span>            :         char *context;
<span class="lineNum">    6025 </span>            :         char *mailbox;
<span class="lineNum">    6026 </span>            : 
<span class="lineNum">    6027 </span><span class="lineCov">         12 :         if (ast_strlen_zero(mailbox_id)</span>
<span class="lineNum">    6028 </span><span class="lineCov">         12 :                 || separate_mailbox(ast_strdupa(mailbox_id), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">    6029 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    6030 </span>            :         }
<span class="lineNum">    6031 </span>            : 
<span class="lineNum">    6032 </span><span class="lineCov">         12 :         return __has_voicemail(context, mailbox, folder, 0) + (folder &amp;&amp; strcmp(folder, &quot;INBOX&quot;) ? 0 : __has_voicemail(context, mailbox, &quot;Urgent&quot;, 0));</span>
<a name="6033"><span class="lineNum">    6033 </span>            : }</a>
<span class="lineNum">    6034 </span>            : 
<span class="lineNum">    6035 </span><span class="lineCov">       6757 : static int __has_voicemail(const char *context, const char *mailbox, const char *folder, int shortcircuit)</span>
<span class="lineNum">    6036 </span>            : {
<span class="lineNum">    6037 </span>            :         DIR *dir;
<span class="lineNum">    6038 </span>            :         struct dirent *de;
<span class="lineNum">    6039 </span>            :         char fn[256];
<span class="lineNum">    6040 </span><span class="lineCov">       6757 :         int ret = 0;</span>
<span class="lineNum">    6041 </span>            : 
<span class="lineNum">    6042 </span>            :         /* If no mailbox, return immediately */
<span class="lineNum">    6043 </span><span class="lineCov">       6757 :         if (ast_strlen_zero(mailbox))</span>
<span class="lineNum">    6044 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    6045 </span>            : 
<span class="lineNum">    6046 </span><span class="lineCov">       6757 :         if (ast_strlen_zero(folder))</span>
<span class="lineNum">    6047 </span><span class="lineNoCov">          0 :                 folder = &quot;INBOX&quot;;</span>
<span class="lineNum">    6048 </span><span class="lineCov">       6757 :         if (ast_strlen_zero(context))</span>
<span class="lineNum">    6049 </span><span class="lineNoCov">          0 :                 context = &quot;default&quot;;</span>
<span class="lineNum">    6050 </span>            : 
<span class="lineNum">    6051 </span><span class="lineCov">       6757 :         snprintf(fn, sizeof(fn), &quot;%s%s/%s/%s&quot;, VM_SPOOL_DIR, context, mailbox, folder);</span>
<span class="lineNum">    6052 </span>            : 
<span class="lineNum">    6053 </span><span class="lineCov">       6757 :         if (!(dir = opendir(fn)))</span>
<span class="lineNum">    6054 </span><span class="lineCov">       5428 :                 return 0;</span>
<span class="lineNum">    6055 </span>            : 
<span class="lineNum">    6056 </span><span class="lineCov">       4281 :         while ((de = readdir(dir))) {</span>
<span class="lineNum">    6057 </span><span class="lineCov">       3014 :                 if (!strncasecmp(de-&gt;d_name, &quot;msg&quot;, 3)) {</span>
<span class="lineNum">    6058 </span><span class="lineCov">        460 :                         if (shortcircuit) {</span>
<span class="lineNum">    6059 </span><span class="lineCov">         62 :                                 ret = 1;</span>
<span class="lineNum">    6060 </span><span class="lineCov">         62 :                                 break;</span>
<span class="lineNum">    6061 </span><span class="lineCov">        398 :                         } else if (!strncasecmp(de-&gt;d_name + 8, &quot;txt&quot;, 3)) {</span>
<span class="lineNum">    6062 </span><span class="lineCov">        126 :                                 ret++;</span>
<span class="lineNum">    6063 </span>            :                         }
<span class="lineNum">    6064 </span>            :                 }
<span class="lineNum">    6065 </span>            :         }
<span class="lineNum">    6066 </span>            : 
<span class="lineNum">    6067 </span><span class="lineCov">       1329 :         closedir(dir);</span>
<span class="lineNum">    6068 </span>            : 
<span class="lineNum">    6069 </span><span class="lineCov">       1329 :         return ret;</span>
<span class="lineNum">    6070 </span>            : }
<span class="lineNum">    6071 </span>            : 
<span class="lineNum">    6072 </span>            : /**
<span class="lineNum">    6073 </span>            :  * \brief Determines if the given folder has messages.
<span class="lineNum">    6074 </span>            :  * \param mailbox The \@ delimited string for user\@context. If no context is found, uses 'default' for the context.
<span class="lineNum">    6075 </span>            :  * \param folder the folder to look in
<span class="lineNum">    6076 </span>            :  *
<span class="lineNum">    6077 </span>            :  * This function is used when the mailbox is stored in a filesystem back end.
<span class="lineNum">    6078 </span>            :  * This invokes the __has_voicemail(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.
<a name="6079"><span class="lineNum">    6079 </span>            :  * \return 1 if the folder has one or more messages. zero otherwise.</a>
<span class="lineNum">    6080 </span>            :  */
<span class="lineNum">    6081 </span><span class="lineCov">         89 : static int has_voicemail(const char *mailbox, const char *folder)</span>
<span class="lineNum">    6082 </span>            : {
<span class="lineNum">    6083 </span><span class="lineCov">         89 :         char tmp[256], *tmp2 = tmp, *box, *context;</span>
<span class="lineNum">    6084 </span><span class="lineCov">         89 :         ast_copy_string(tmp, mailbox, sizeof(tmp));</span>
<span class="lineNum">    6085 </span><span class="lineCov">         89 :         if (ast_strlen_zero(folder)) {</span>
<span class="lineNum">    6086 </span><span class="lineCov">         83 :                 folder = &quot;INBOX&quot;;</span>
<span class="lineNum">    6087 </span>            :         }
<span class="lineNum">    6088 </span><span class="lineCov">        116 :         while ((box = strsep(&amp;tmp2, &quot;,&amp;&quot;))) {</span>
<span class="lineNum">    6089 </span><span class="lineCov">         89 :                 if ((context = strchr(box, '@')))</span>
<span class="lineNum">    6090 </span><span class="lineCov">         89 :                         *context++ = '\0';</span>
<span class="lineNum">    6091 </span>            :                 else
<span class="lineNum">    6092 </span><span class="lineNoCov">          0 :                         context = &quot;default&quot;;</span>
<span class="lineNum">    6093 </span><span class="lineCov">         89 :                 if (__has_voicemail(context, box, folder, 1))</span>
<span class="lineNum">    6094 </span><span class="lineCov">         45 :                         return 1;</span>
<span class="lineNum">    6095 </span>            :                 /* If we are checking INBOX, we should check Urgent as well */
<span class="lineNum">    6096 </span><span class="lineCov">         44 :                 if (!strcmp(folder, &quot;INBOX&quot;) &amp;&amp; __has_voicemail(context, box, &quot;Urgent&quot;, 1)) {</span>
<span class="lineNum">    6097 </span><span class="lineCov">         17 :                         return 1;</span>
<span class="lineNum">    6098 </span>            :                 }
<span class="lineNum">    6099 </span>            :         }
<span class="lineNum">    6100 </span><span class="lineCov">         27 :         return 0;</span>
<span class="lineNum">    6101 </span>            : }
<span class="lineNum">    6102 </span>            : 
<span class="lineNum">    6103 </span>            : /*!
<span class="lineNum">    6104 </span>            :  * \brief Check the given mailbox's message count.
<span class="lineNum">    6105 </span>            :  * \param mailbox The @ delimited string for user@context. If no context is found, uses 'default' for the context.
<span class="lineNum">    6106 </span>            :  * \param urgentmsgs  urgent message count.
<span class="lineNum">    6107 </span>            :  * \param newmsgs new message count.
<span class="lineNum">    6108 </span>            :  * \param oldmsgs old message count pointer
<a name="6109"><span class="lineNum">    6109 </span>            :  * \return -1 if error occurred, 0 otherwise.</a>
<span class="lineNum">    6110 </span>            :  */
<span class="lineNum">    6111 </span><span class="lineCov">       2203 : static int inboxcount2(const char *mailbox, int *urgentmsgs, int *newmsgs, int *oldmsgs)</span>
<span class="lineNum">    6112 </span>            : {
<span class="lineNum">    6113 </span>            :         char tmp[256];
<span class="lineNum">    6114 </span>            :         char *context;
<span class="lineNum">    6115 </span>            : 
<span class="lineNum">    6116 </span>            :         /* If no mailbox, return immediately */
<span class="lineNum">    6117 </span><span class="lineCov">       2203 :         if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">    6118 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    6119 </span>            :         }
<span class="lineNum">    6120 </span>            : 
<span class="lineNum">    6121 </span><span class="lineCov">       2203 :         if (newmsgs) {</span>
<span class="lineNum">    6122 </span><span class="lineCov">       2203 :                 *newmsgs = 0;</span>
<span class="lineNum">    6123 </span>            :         }
<span class="lineNum">    6124 </span><span class="lineCov">       2203 :         if (oldmsgs) {</span>
<span class="lineNum">    6125 </span><span class="lineCov">       2203 :                 *oldmsgs = 0;</span>
<span class="lineNum">    6126 </span>            :         }
<span class="lineNum">    6127 </span><span class="lineCov">       2203 :         if (urgentmsgs) {</span>
<span class="lineNum">    6128 </span><span class="lineCov">       2203 :                 *urgentmsgs = 0;</span>
<span class="lineNum">    6129 </span>            :         }
<span class="lineNum">    6130 </span>            : 
<span class="lineNum">    6131 </span><span class="lineCov">       2203 :         if (strchr(mailbox, ',')) {</span>
<span class="lineNum">    6132 </span>            :                 int tmpnew, tmpold, tmpurgent;
<span class="lineNum">    6133 </span>            :                 char *mb, *cur;
<span class="lineNum">    6134 </span>            : 
<span class="lineNum">    6135 </span><span class="lineNoCov">          0 :                 ast_copy_string(tmp, mailbox, sizeof(tmp));</span>
<span class="lineNum">    6136 </span><span class="lineNoCov">          0 :                 mb = tmp;</span>
<span class="lineNum">    6137 </span><span class="lineNoCov">          0 :                 while ((cur = strsep(&amp;mb, &quot;, &quot;))) {</span>
<span class="lineNum">    6138 </span><span class="lineNoCov">          0 :                         if (!ast_strlen_zero(cur)) {</span>
<span class="lineNum">    6139 </span><span class="lineNoCov">          0 :                                 if (inboxcount2(cur, urgentmsgs ? &amp;tmpurgent : NULL, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL)) {</span>
<span class="lineNum">    6140 </span><span class="lineNoCov">          0 :                                         return -1;</span>
<span class="lineNum">    6141 </span>            :                                 } else {
<span class="lineNum">    6142 </span><span class="lineNoCov">          0 :                                         if (newmsgs) {</span>
<span class="lineNum">    6143 </span><span class="lineNoCov">          0 :                                                 *newmsgs += tmpnew;</span>
<span class="lineNum">    6144 </span>            :                                         }
<span class="lineNum">    6145 </span><span class="lineNoCov">          0 :                                         if (oldmsgs) {</span>
<span class="lineNum">    6146 </span><span class="lineNoCov">          0 :                                                 *oldmsgs += tmpold;</span>
<span class="lineNum">    6147 </span>            :                                         }
<span class="lineNum">    6148 </span><span class="lineNoCov">          0 :                                         if (urgentmsgs) {</span>
<span class="lineNum">    6149 </span><span class="lineNoCov">          0 :                                                 *urgentmsgs += tmpurgent;</span>
<span class="lineNum">    6150 </span>            :                                         }
<span class="lineNum">    6151 </span>            :                                 }
<span class="lineNum">    6152 </span>            :                         }
<span class="lineNum">    6153 </span>            :                 }
<span class="lineNum">    6154 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    6155 </span>            :         }
<span class="lineNum">    6156 </span>            : 
<span class="lineNum">    6157 </span><span class="lineCov">       2203 :         ast_copy_string(tmp, mailbox, sizeof(tmp));</span>
<span class="lineNum">    6158 </span>            : 
<span class="lineNum">    6159 </span><span class="lineCov">       2203 :         if ((context = strchr(tmp, '@'))) {</span>
<span class="lineNum">    6160 </span><span class="lineCov">       2203 :                 *context++ = '\0';</span>
<span class="lineNum">    6161 </span>            :         } else {
<span class="lineNum">    6162 </span><span class="lineNoCov">          0 :                 context = &quot;default&quot;;</span>
<span class="lineNum">    6163 </span>            :         }
<span class="lineNum">    6164 </span>            : 
<span class="lineNum">    6165 </span><span class="lineCov">       2203 :         if (newmsgs) {</span>
<span class="lineNum">    6166 </span><span class="lineCov">       2203 :                 *newmsgs = __has_voicemail(context, tmp, &quot;INBOX&quot;, 0);</span>
<span class="lineNum">    6167 </span>            :         }
<span class="lineNum">    6168 </span><span class="lineCov">       2203 :         if (oldmsgs) {</span>
<span class="lineNum">    6169 </span><span class="lineCov">       2203 :                 *oldmsgs = __has_voicemail(context, tmp, &quot;Old&quot;, 0);</span>
<span class="lineNum">    6170 </span>            :         }
<span class="lineNum">    6171 </span><span class="lineCov">       2203 :         if (urgentmsgs) {</span>
<span class="lineNum">    6172 </span><span class="lineCov">       2203 :                 *urgentmsgs = __has_voicemail(context, tmp, &quot;Urgent&quot;, 0);</span>
<span class="lineNum">    6173 </span>            :         }
<span class="lineNum">    6174 </span>            : 
<span class="lineNum">    6175 </span><span class="lineCov">       2203 :         return 0;</span>
<span class="lineNum">    6176 </span>            : }
<span class="lineNum">    6177 </span>            : 
<span class="lineNum">    6178 </span>            : #endif
<a name="6179"><span class="lineNum">    6179 </span>            : </a>
<span class="lineNum">    6180 </span>            : /* Exactly the same function for file-based, ODBC-based, and IMAP-based, so why create 3 different copies? */
<span class="lineNum">    6181 </span><span class="lineCov">          9 : static int inboxcount(const char *mailbox, int *newmsgs, int *oldmsgs)</span>
<span class="lineNum">    6182 </span>            : {
<span class="lineNum">    6183 </span><span class="lineCov">          9 :         int urgentmsgs = 0;</span>
<span class="lineNum">    6184 </span><span class="lineCov">          9 :         int res = inboxcount2(mailbox, &amp;urgentmsgs, newmsgs, oldmsgs);</span>
<span class="lineNum">    6185 </span><span class="lineCov">          9 :         if (newmsgs) {</span>
<span class="lineNum">    6186 </span><span class="lineCov">          9 :                 *newmsgs += urgentmsgs;</span>
<span class="lineNum">    6187 </span>            :         }
<span class="lineNum">    6188 </span><span class="lineCov">          9 :         return res;</span>
<a name="6189"><span class="lineNum">    6189 </span>            : }</a>
<span class="lineNum">    6190 </span>            : 
<span class="lineNum">    6191 </span><span class="lineCov">         56 : static void run_externnotify(char *context, char *extension, const char *flag)</span>
<span class="lineNum">    6192 </span>            : {
<span class="lineNum">    6193 </span>            :         char arguments[255];
<span class="lineNum">    6194 </span><span class="lineCov">         56 :         char ext_context[256] = &quot;&quot;;</span>
<span class="lineNum">    6195 </span><span class="lineCov">         56 :         int newvoicemails = 0, oldvoicemails = 0, urgentvoicemails = 0;</span>
<span class="lineNum">    6196 </span>            :         struct ast_smdi_mwi_message *mwi_msg;
<span class="lineNum">    6197 </span>            : 
<span class="lineNum">    6198 </span><span class="lineCov">         56 :         if (!ast_strlen_zero(context))</span>
<span class="lineNum">    6199 </span><span class="lineCov">         56 :                 snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, extension, context);</span>
<span class="lineNum">    6200 </span>            :         else
<span class="lineNum">    6201 </span><span class="lineNoCov">          0 :                 ast_copy_string(ext_context, extension, sizeof(ext_context));</span>
<span class="lineNum">    6202 </span>            : 
<span class="lineNum">    6203 </span><span class="lineCov">         56 :         if (smdi_iface) {</span>
<span class="lineNum">    6204 </span><span class="lineNoCov">          0 :                 if (ast_app_has_voicemail(ext_context, NULL))</span>
<span class="lineNum">    6205 </span><span class="lineNoCov">          0 :                         ast_smdi_mwi_set(smdi_iface, extension);</span>
<span class="lineNum">    6206 </span>            :                 else
<span class="lineNum">    6207 </span><span class="lineNoCov">          0 :                         ast_smdi_mwi_unset(smdi_iface, extension);</span>
<span class="lineNum">    6208 </span>            : 
<span class="lineNum">    6209 </span><span class="lineNoCov">          0 :                 if ((mwi_msg = ast_smdi_mwi_message_wait_station(smdi_iface, SMDI_MWI_WAIT_TIMEOUT, extension))) {</span>
<span class="lineNum">    6210 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_ERROR, &quot;Error executing SMDI MWI change for %s\n&quot;, extension);</span>
<span class="lineNum">    6211 </span><span class="lineNoCov">          0 :                         if (!strncmp(mwi_msg-&gt;cause, &quot;INV&quot;, 3))</span>
<span class="lineNum">    6212 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_ERROR, &quot;Invalid MWI extension: %s\n&quot;, mwi_msg-&gt;fwd_st);</span>
<span class="lineNum">    6213 </span><span class="lineNoCov">          0 :                         else if (!strncmp(mwi_msg-&gt;cause, &quot;BLK&quot;, 3))</span>
<span class="lineNum">    6214 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;MWI light was already on or off for %s\n&quot;, mwi_msg-&gt;fwd_st);</span>
<span class="lineNum">    6215 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;The switch reported '%s'\n&quot;, mwi_msg-&gt;cause);</span>
<span class="lineNum">    6216 </span><span class="lineNoCov">          0 :                         ao2_ref(mwi_msg, -1);</span>
<span class="lineNum">    6217 </span>            :                 } else {
<span class="lineNum">    6218 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;Successfully executed SMDI MWI change for %s\n&quot;, extension);</span>
<span class="lineNum">    6219 </span>            :                 }
<span class="lineNum">    6220 </span>            :         }
<span class="lineNum">    6221 </span>            : 
<span class="lineNum">    6222 </span><span class="lineCov">         56 :         if (!ast_strlen_zero(externnotify)) {</span>
<span class="lineNum">    6223 </span><span class="lineNoCov">          0 :                 if (inboxcount2(ext_context, &amp;urgentvoicemails, &amp;newvoicemails, &amp;oldvoicemails)) {</span>
<span class="lineNum">    6224 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_ERROR, &quot;Problem in calculating number of voicemail messages available for extension %s\n&quot;, extension);</span>
<span class="lineNum">    6225 </span>            :                 } else {
<span class="lineNum">    6226 </span><span class="lineNoCov">          0 :                         snprintf(arguments, sizeof(arguments), &quot;%s %s %s %d %d %d &amp;&quot;,</span>
<span class="lineNum">    6227 </span><span class="lineNoCov">          0 :                                 externnotify, S_OR(context, &quot;\&quot;\&quot;&quot;),</span>
<span class="lineNum">    6228 </span>            :                                 extension, newvoicemails,
<span class="lineNum">    6229 </span>            :                                 oldvoicemails, urgentvoicemails);
<span class="lineNum">    6230 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;Executing %s\n&quot;, arguments);</span>
<span class="lineNum">    6231 </span><span class="lineNoCov">          0 :                         ast_safe_system(arguments);</span>
<span class="lineNum">    6232 </span>            :                 }
<span class="lineNum">    6233 </span>            :         }
<span class="lineNum">    6234 </span><span class="lineCov">         56 : }</span>
<span class="lineNum">    6235 </span>            : 
<span class="lineNum">    6236 </span>            : /*!
<span class="lineNum">    6237 </span>            :  * \brief Variables used for saving a voicemail.
<span class="lineNum">    6238 </span>            :  *
<span class="lineNum">    6239 </span>            :  * This includes the record gain, mode flags, and the exit context of the chanel that was used for leaving the voicemail.
<span class="lineNum">    6240 </span>            :  */
<span class="lineNum">    6241 </span>            : struct leave_vm_options {
<span class="lineNum">    6242 </span>            :         unsigned int flags;
<span class="lineNum">    6243 </span>            :         signed char record_gain;
<span class="lineNum">    6244 </span>            :         char *exitcontext;
<a name="6245"><span class="lineNum">    6245 </span>            : };</a>
<span class="lineNum">    6246 </span>            : 
<span class="lineNum">    6247 </span><span class="lineCov">         11 : static void generate_msg_id(char *dst)</span>
<span class="lineNum">    6248 </span>            : {
<span class="lineNum">    6249 </span>            :         /* msg id is time of msg_id generation plus an incrementing value
<span class="lineNum">    6250 </span>            :          * called each time a new msg_id is generated. This should achieve uniqueness,
<span class="lineNum">    6251 </span>            :          * but only in single system solutions.
<span class="lineNum">    6252 </span>            :          */
<span class="lineNum">    6253 </span><span class="lineCov">         11 :         unsigned int unique_counter = ast_atomic_fetchadd_int(&amp;msg_id_incrementor, +1);</span>
<span class="lineNum">    6254 </span><span class="lineCov">         11 :         snprintf(dst, MSG_ID_LEN, &quot;%ld-%08x&quot;, (long) time(NULL), unique_counter);</span>
<span class="lineNum">    6255 </span><span class="lineCov">         11 : }</span>
<span class="lineNum">    6256 </span>            : 
<span class="lineNum">    6257 </span>            : /*!
<span class="lineNum">    6258 </span>            :  * \internal
<span class="lineNum">    6259 </span>            :  * \brief Creates a voicemail based on a specified file to a mailbox.
<span class="lineNum">    6260 </span>            :  * \param recdata A vm_recording_data containing filename and voicemail txt info.
<span class="lineNum">    6261 </span>            :  * \retval -1 failure
<span class="lineNum">    6262 </span>            :  * \retval 0 success
<span class="lineNum">    6263 </span>            :  *
<span class="lineNum">    6264 </span>            :  * This is installed to the app.h voicemail functions and accommodates all voicemail
<span class="lineNum">    6265 </span>            :  * storage methods. It should probably be broken out along with leave_voicemail at
<span class="lineNum">    6266 </span>            :  * some point in the future.
<span class="lineNum">    6267 </span>            :  *
<span class="lineNum">    6268 </span>            :  * This function currently only works for a single recipient and only uses the format
<a name="6269"><span class="lineNum">    6269 </span>            :  * specified in recording_ext.</a>
<span class="lineNum">    6270 </span>            :  */
<span class="lineNum">    6271 </span><span class="lineNoCov">          0 : static int msg_create_from_file(struct ast_vm_recording_data *recdata)</span>
<span class="lineNum">    6272 </span>            : {
<span class="lineNum">    6273 </span>            :         /* voicemail recipient structure */
<span class="lineNum">    6274 </span>            :         struct ast_vm_user *recipient; /* points to svm once it's been created */
<span class="lineNum">    6275 </span>            :         struct ast_vm_user svm; /* struct storing the voicemail recipient */
<span class="lineNum">    6276 </span>            : 
<span class="lineNum">    6277 </span>            :         /* File paths */
<span class="lineNum">    6278 </span>            :         char tmpdir[PATH_MAX]; /* directory temp files are stored in */
<span class="lineNum">    6279 </span>            :         char tmptxtfile[PATH_MAX]; /* tmp file for voicemail txt file */
<span class="lineNum">    6280 </span>            :         char desttxtfile[PATH_MAX]; /* final destination for txt file */
<span class="lineNum">    6281 </span>            :         char tmpaudiofile[PATH_MAX]; /* tmp file where audio is stored */
<span class="lineNum">    6282 </span>            :         char dir[PATH_MAX]; /* destination for tmp files on completion */
<span class="lineNum">    6283 </span>            :         char destination[PATH_MAX]; /* destination with msgXXXX.  Basically &lt;dir&gt;/msgXXXX */
<span class="lineNum">    6284 </span>            : 
<span class="lineNum">    6285 </span>            :         /* stuff that only seems to be needed for IMAP */
<span class="lineNum">    6286 </span>            :         #ifdef IMAP_STORAGE
<span class="lineNum">    6287 </span>            :         struct vm_state *vms = NULL;
<span class="lineNum">    6288 </span>            :         char ext_context[256] = &quot;&quot;;
<span class="lineNum">    6289 </span>            :         char *fmt = ast_strdupa(recdata-&gt;recording_ext);
<span class="lineNum">    6290 </span>            :         int newmsgs = 0;
<span class="lineNum">    6291 </span>            :         int oldmsgs = 0;
<span class="lineNum">    6292 </span>            :         #endif
<span class="lineNum">    6293 </span>            : 
<span class="lineNum">    6294 </span>            :         /* miscellaneous operational variables */
<span class="lineNum">    6295 </span><span class="lineNoCov">          0 :         int res = 0; /* Used to store error codes from functions */</span>
<span class="lineNum">    6296 </span>            :         int txtdes /* File descriptor for the text file used to write the voicemail info */;
<span class="lineNum">    6297 </span>            :         FILE *txt; /* FILE pointer to text file used to write the voicemail info */
<span class="lineNum">    6298 </span>            :         char date[256]; /* string used to hold date of the voicemail (only used for ODBC) */
<span class="lineNum">    6299 </span>            :         int msgnum; /* the 4 digit number designated to the voicemail */
<span class="lineNum">    6300 </span><span class="lineNoCov">          0 :         int duration = 0; /* Length of the audio being recorded in seconds */</span>
<span class="lineNum">    6301 </span>            :         struct ast_filestream *recording_fs; /*used to read the recording to get duration data */
<span class="lineNum">    6302 </span>            : 
<span class="lineNum">    6303 </span>            :         /* We aren't currently doing anything with category, since it comes from a channel variable and
<span class="lineNum">    6304 </span>            :          * this function doesn't use channels, but this function could add that as an argument later. */
<span class="lineNum">    6305 </span><span class="lineNoCov">          0 :         const char *category = NULL; /* pointless for now */</span>
<span class="lineNum">    6306 </span>            :         char msg_id[MSG_ID_LEN];
<span class="lineNum">    6307 </span>            : 
<span class="lineNum">    6308 </span>            :         /* Start by checking to see if the file actually exists... */
<span class="lineNum">    6309 </span><span class="lineNoCov">          0 :         if (!(ast_fileexists(recdata-&gt;recording_file, recdata-&gt;recording_ext, NULL))) {</span>
<span class="lineNum">    6310 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;File: %s not found.\n&quot;, recdata-&gt;recording_file);</span>
<span class="lineNum">    6311 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6312 </span>            :         }
<span class="lineNum">    6313 </span>            : 
<span class="lineNum">    6314 </span><span class="lineNoCov">          0 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">    6315 </span><span class="lineNoCov">          0 :         if (!(recipient = find_user(&amp;svm, recdata-&gt;context, recdata-&gt;mailbox))) {</span>
<span class="lineNum">    6316 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;No entry in voicemail config file for '%s@%s'\n&quot;, recdata-&gt;mailbox, recdata-&gt;context);</span>
<span class="lineNum">    6317 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6318 </span>            :         }
<span class="lineNum">    6319 </span>            : 
<span class="lineNum">    6320 </span>            :         /* determine duration in seconds */
<span class="lineNum">    6321 </span><span class="lineNoCov">          0 :         if ((recording_fs = ast_readfile(recdata-&gt;recording_file, recdata-&gt;recording_ext, NULL, 0, 0, VOICEMAIL_DIR_MODE))) {</span>
<span class="lineNum">    6322 </span><span class="lineNoCov">          0 :                 if (!ast_seekstream(recording_fs, 0, SEEK_END)) {</span>
<span class="lineNum">    6323 </span><span class="lineNoCov">          0 :                         long framelength = ast_tellstream(recording_fs);</span>
<span class="lineNum">    6324 </span><span class="lineNoCov">          0 :                         int sample_rate = ast_ratestream(recording_fs);</span>
<span class="lineNum">    6325 </span><span class="lineNoCov">          0 :                         if (sample_rate) {</span>
<span class="lineNum">    6326 </span><span class="lineNoCov">          0 :                                 duration = (int) (framelength / sample_rate);</span>
<span class="lineNum">    6327 </span>            :                         } else {
<span class="lineNum">    6328 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Unable to determine sample rate of recording %s\n&quot;, recdata-&gt;recording_file);</span>
<span class="lineNum">    6329 </span>            :                         }
<span class="lineNum">    6330 </span>            :                 }
<span class="lineNum">    6331 </span><span class="lineNoCov">          0 :                 ast_closestream(recording_fs);</span>
<span class="lineNum">    6332 </span>            :         }
<span class="lineNum">    6333 </span>            : 
<span class="lineNum">    6334 </span>            :         /* If the duration was below the minimum duration for the user, let's just drop the whole thing now */
<span class="lineNum">    6335 </span><span class="lineNoCov">          0 :         if (duration &lt; recipient-&gt;minsecs) {</span>
<span class="lineNum">    6336 </span><span class="lineNoCov">          0 :                 ast_log(LOG_NOTICE, &quot;Copying recording to voicemail %s@%s skipped because duration was shorter than &quot;</span>
<span class="lineNum">    6337 </span>            :                                         &quot;minmessage of recipient\n&quot;, recdata-&gt;mailbox, recdata-&gt;context);
<span class="lineNum">    6338 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6339 </span>            :         }
<span class="lineNum">    6340 </span>            : 
<span class="lineNum">    6341 </span>            :         /* Note that this number must be dropped back to a net sum of zero before returning from this function */
<span class="lineNum">    6342 </span>            : 
<span class="lineNum">    6343 </span><span class="lineNoCov">          0 :         if ((res = create_dirpath(tmpdir, sizeof(tmpdir), recipient-&gt;context, recdata-&gt;mailbox, &quot;tmp&quot;))) {</span>
<span class="lineNum">    6344 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Failed to make directory.\n&quot;);</span>
<span class="lineNum">    6345 </span>            :         }
<span class="lineNum">    6346 </span>            : 
<span class="lineNum">    6347 </span><span class="lineNoCov">          0 :         snprintf(tmptxtfile, sizeof(tmptxtfile), &quot;%s/XXXXXX&quot;, tmpdir);</span>
<span class="lineNum">    6348 </span><span class="lineNoCov">          0 :         txtdes = mkstemp(tmptxtfile);</span>
<span class="lineNum">    6349 </span><span class="lineNoCov">          0 :         if (txtdes &lt; 0) {</span>
<span class="lineNum">    6350 </span><span class="lineNoCov">          0 :                 chmod(tmptxtfile, VOICEMAIL_FILE_MODE &amp; ~my_umask);</span>
<span class="lineNum">    6351 </span>            :                 /* Something screwed up.  Abort. */
<span class="lineNum">    6352 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Unable to create message file: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">    6353 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6354 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6355 </span>            :         }
<span class="lineNum">    6356 </span>            : 
<span class="lineNum">    6357 </span>            :         /* Store information */
<span class="lineNum">    6358 </span><span class="lineNoCov">          0 :         txt = fdopen(txtdes, &quot;w+&quot;);</span>
<span class="lineNum">    6359 </span><span class="lineNoCov">          0 :         if (txt) {</span>
<span class="lineNum">    6360 </span><span class="lineNoCov">          0 :                 generate_msg_id(msg_id);</span>
<span class="lineNum">    6361 </span><span class="lineNoCov">          0 :                 get_date(date, sizeof(date));</span>
<span class="lineNum">    6362 </span><span class="lineNoCov">          0 :                 fprintf(txt,</span>
<span class="lineNum">    6363 </span>            :                         &quot;;\n&quot;
<span class="lineNum">    6364 </span>            :                         &quot;; Message Information file\n&quot;
<span class="lineNum">    6365 </span>            :                         &quot;;\n&quot;
<span class="lineNum">    6366 </span>            :                         &quot;[message]\n&quot;
<span class="lineNum">    6367 </span>            :                         &quot;origmailbox=%s\n&quot;
<span class="lineNum">    6368 </span>            :                         &quot;context=%s\n&quot;
<span class="lineNum">    6369 </span>            :                         &quot;macrocontext=%s\n&quot;
<span class="lineNum">    6370 </span>            :                         &quot;exten=%s\n&quot;
<span class="lineNum">    6371 </span>            :                         &quot;rdnis=Unknown\n&quot;
<span class="lineNum">    6372 </span>            :                         &quot;priority=%d\n&quot;
<span class="lineNum">    6373 </span>            :                         &quot;callerchan=%s\n&quot;
<span class="lineNum">    6374 </span>            :                         &quot;callerid=%s\n&quot;
<span class="lineNum">    6375 </span>            :                         &quot;origdate=%s\n&quot;
<span class="lineNum">    6376 </span>            :                         &quot;origtime=%ld\n&quot;
<span class="lineNum">    6377 </span>            :                         &quot;category=%s\n&quot;
<span class="lineNum">    6378 </span>            :                         &quot;msg_id=%s\n&quot;
<span class="lineNum">    6379 </span>            :                         &quot;flag=\n&quot; /* flags not supported in copy from file yet */
<span class="lineNum">    6380 </span>            :                         &quot;duration=%d\n&quot;, /* Don't have any reliable way to get duration of file. */
<span class="lineNum">    6381 </span>            : 
<span class="lineNum">    6382 </span>            :                         recdata-&gt;mailbox,
<span class="lineNum">    6383 </span><span class="lineNoCov">          0 :                         S_OR(recdata-&gt;call_context, &quot;&quot;),</span>
<span class="lineNum">    6384 </span><span class="lineNoCov">          0 :                         S_OR(recdata-&gt;call_macrocontext, &quot;&quot;),</span>
<span class="lineNum">    6385 </span><span class="lineNoCov">          0 :                         S_OR(recdata-&gt;call_extension, &quot;&quot;),</span>
<span class="lineNum">    6386 </span>            :                         recdata-&gt;call_priority,
<span class="lineNum">    6387 </span><span class="lineNoCov">          0 :                         S_OR(recdata-&gt;call_callerchan, &quot;Unknown&quot;),</span>
<span class="lineNum">    6388 </span><span class="lineNoCov">          0 :                         S_OR(recdata-&gt;call_callerid, &quot;Unknown&quot;),</span>
<span class="lineNum">    6389 </span><span class="lineNoCov">          0 :                         date, (long) time(NULL),</span>
<span class="lineNum">    6390 </span><span class="lineNoCov">          0 :                         S_OR(category, &quot;&quot;),</span>
<span class="lineNum">    6391 </span>            :                         msg_id,
<span class="lineNum">    6392 </span>            :                         duration);
<span class="lineNum">    6393 </span>            : 
<span class="lineNum">    6394 </span>            :                 /* Since we are recording from a file, we shouldn't need to do anything else with
<span class="lineNum">    6395 </span>            :                  * this txt file */
<span class="lineNum">    6396 </span><span class="lineNoCov">          0 :                 fclose(txt);</span>
<span class="lineNum">    6397 </span>            : 
<span class="lineNum">    6398 </span>            :         } else {
<span class="lineNum">    6399 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Error opening text file for output\n&quot;);</span>
<span class="lineNum">    6400 </span><span class="lineNoCov">          0 :                 if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    6401 </span><span class="lineNoCov">          0 :                         ast_destroy_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, tmptxtfile, SENTINEL);</span>
<span class="lineNum">    6402 </span>            :                 }
<span class="lineNum">    6403 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6404 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6405 </span>            :         }
<span class="lineNum">    6406 </span>            : 
<span class="lineNum">    6407 </span>            :         /* At this point, the actual creation of a voicemail message should be finished.
<span class="lineNum">    6408 </span>            :          * Now we just need to copy the files being recorded into the receiving folder. */
<span class="lineNum">    6409 </span>            : 
<span class="lineNum">    6410 </span><span class="lineNoCov">          0 :         create_dirpath(dir, sizeof(dir), recipient-&gt;context, recipient-&gt;mailbox, recdata-&gt;folder);</span>
<span class="lineNum">    6411 </span>            : 
<span class="lineNum">    6412 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    6413 </span>            :         /* make recipient info into an inboxcount friendly string */
<span class="lineNum">    6414 </span>            :         snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, recipient-&gt;mailbox, recipient-&gt;context);
<span class="lineNum">    6415 </span>            : 
<span class="lineNum">    6416 </span>            :         /* Is ext a mailbox? */
<span class="lineNum">    6417 </span>            :         /* must open stream for this user to get info! */
<span class="lineNum">    6418 </span>            :         res = inboxcount(ext_context, &amp;newmsgs, &amp;oldmsgs);
<span class="lineNum">    6419 </span>            :         if (res &lt; 0) {
<span class="lineNum">    6420 </span>            :                 ast_log(LOG_NOTICE, &quot;Can not leave voicemail, unable to count messages\n&quot;);
<span class="lineNum">    6421 </span>            :                 free_user(recipient);
<span class="lineNum">    6422 </span>            :                 unlink(tmptxtfile);
<span class="lineNum">    6423 </span>            :                 return -1;
<span class="lineNum">    6424 </span>            :         }
<span class="lineNum">    6425 </span>            :         if (!(vms = get_vm_state_by_mailbox(recipient-&gt;mailbox, recipient-&gt;context, 0))) {
<span class="lineNum">    6426 </span>            :         /* It is possible under certain circumstances that inboxcount did not
<span class="lineNum">    6427 </span>            :          * create a vm_state when it was needed. This is a catchall which will
<span class="lineNum">    6428 </span>            :          * rarely be used.
<span class="lineNum">    6429 </span>            :          */
<span class="lineNum">    6430 </span>            :                 if (!(vms = create_vm_state_from_user(recipient))) {
<span class="lineNum">    6431 </span>            :                         ast_log(LOG_ERROR, &quot;Couldn't allocate necessary space\n&quot;);
<span class="lineNum">    6432 </span>            :                         free_user(recipient);
<span class="lineNum">    6433 </span>            :                         unlink(tmptxtfile);
<span class="lineNum">    6434 </span>            :                         return -1;
<span class="lineNum">    6435 </span>            :                 }
<span class="lineNum">    6436 </span>            :         }
<span class="lineNum">    6437 </span>            :         vms-&gt;newmessages++;
<span class="lineNum">    6438 </span>            : 
<span class="lineNum">    6439 </span>            :         /* here is a big difference! We add one to it later */
<span class="lineNum">    6440 </span>            :         msgnum = newmsgs + oldmsgs;
<span class="lineNum">    6441 </span>            :         ast_debug(3, &quot;Messagecount set to %d\n&quot;, msgnum);
<span class="lineNum">    6442 </span>            :         snprintf(destination, sizeof(destination), &quot;%simap/msg%s%04d&quot;, VM_SPOOL_DIR, recipient-&gt;mailbox, msgnum);
<span class="lineNum">    6443 </span>            : 
<span class="lineNum">    6444 </span>            :         /* Check to see if we have enough room in the mailbox. If not, spit out an error and end
<span class="lineNum">    6445 </span>            :          * Note that imap_check_limits raises inprocess_count if successful */
<span class="lineNum">    6446 </span>            :         if ((res = imap_check_limits(NULL, vms, recipient, msgnum))) {
<span class="lineNum">    6447 </span>            :                 ast_log(LOG_NOTICE, &quot;Didn't copy to voicemail. Mailbox for %s@%s is full.\n&quot;, recipient-&gt;mailbox, recipient-&gt;context);
<span class="lineNum">    6448 </span>            :                 inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, -1);
<span class="lineNum">    6449 </span>            :                 free_user(recipient);
<span class="lineNum">    6450 </span>            :                 unlink(tmptxtfile);
<span class="lineNum">    6451 </span>            :                 return -1;
<span class="lineNum">    6452 </span>            :         }
<span class="lineNum">    6453 </span>            : 
<span class="lineNum">    6454 </span>            : #else
<span class="lineNum">    6455 </span>            : 
<span class="lineNum">    6456 </span>            :         /* Check to see if the mailbox is full for ODBC/File storage */
<span class="lineNum">    6457 </span><span class="lineNoCov">          0 :         ast_debug(3, &quot;mailbox = %d : inprocess = %d\n&quot;, count_messages(recipient, dir),</span>
<span class="lineNum">    6458 </span>            :                 inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, 0));
<span class="lineNum">    6459 </span><span class="lineNoCov">          0 :         if (count_messages(recipient, dir) &gt; recipient-&gt;maxmsg - inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, +1)) {</span>
<span class="lineNum">    6460 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Didn't copy to voicemail. Mailbox for %s@%s is full.\n&quot;, recipient-&gt;mailbox, recipient-&gt;context);</span>
<span class="lineNum">    6461 </span><span class="lineNoCov">          0 :                 inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, -1);</span>
<span class="lineNum">    6462 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6463 </span><span class="lineNoCov">          0 :                 unlink(tmptxtfile);</span>
<span class="lineNum">    6464 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6465 </span>            :         }
<span class="lineNum">    6466 </span>            : 
<span class="lineNum">    6467 </span><span class="lineNoCov">          0 :         msgnum = last_message_index(recipient, dir) + 1;</span>
<span class="lineNum">    6468 </span>            : #endif
<span class="lineNum">    6469 </span>            : 
<span class="lineNum">    6470 </span>            :         /* Lock the directory receiving the voicemail since we want it to still exist when we attempt to copy the voicemail.
<span class="lineNum">    6471 </span>            :          * We need to unlock it before we return. */
<span class="lineNum">    6472 </span><span class="lineNoCov">          0 :         if (vm_lock_path(dir)) {</span>
<span class="lineNum">    6473 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Couldn't lock directory %s.  Voicemail will be lost.\n&quot;, dir);</span>
<span class="lineNum">    6474 </span>            :                 /* Delete files */
<span class="lineNum">    6475 </span><span class="lineNoCov">          0 :                 ast_filedelete(tmptxtfile, NULL);</span>
<span class="lineNum">    6476 </span><span class="lineNoCov">          0 :                 unlink(tmptxtfile);</span>
<span class="lineNum">    6477 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6478 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6479 </span>            :         }
<span class="lineNum">    6480 </span>            : 
<span class="lineNum">    6481 </span><span class="lineNoCov">          0 :         make_file(destination, sizeof(destination), dir, msgnum);</span>
<span class="lineNum">    6482 </span>            : 
<span class="lineNum">    6483 </span><span class="lineNoCov">          0 :         make_file(tmpaudiofile, sizeof(tmpaudiofile), tmpdir, msgnum);</span>
<span class="lineNum">    6484 </span>            : 
<span class="lineNum">    6485 </span><span class="lineNoCov">          0 :         if (ast_filecopy(recdata-&gt;recording_file, tmpaudiofile, recdata-&gt;recording_ext)) {</span>
<span class="lineNum">    6486 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Audio file failed to copy to tmp dir. Probably low disk space.\n&quot;);</span>
<span class="lineNum">    6487 </span>            : 
<span class="lineNum">    6488 </span><span class="lineNoCov">          0 :                 inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, -1);</span>
<span class="lineNum">    6489 </span><span class="lineNoCov">          0 :                 ast_unlock_path(dir);</span>
<span class="lineNum">    6490 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6491 </span><span class="lineNoCov">          0 :                 unlink(tmptxtfile);</span>
<span class="lineNum">    6492 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6493 </span>            :         }
<span class="lineNum">    6494 </span>            : 
<span class="lineNum">    6495 </span>            :         /* Alright, try to copy to the destination folder now. */
<span class="lineNum">    6496 </span><span class="lineNoCov">          0 :         if (ast_filerename(tmpaudiofile, destination, recdata-&gt;recording_ext)) {</span>
<span class="lineNum">    6497 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Audio file failed to move to destination directory. Permissions/Overlap?\n&quot;);</span>
<span class="lineNum">    6498 </span><span class="lineNoCov">          0 :                 inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, -1);</span>
<span class="lineNum">    6499 </span><span class="lineNoCov">          0 :                 ast_unlock_path(dir);</span>
<span class="lineNum">    6500 </span><span class="lineNoCov">          0 :                 free_user(recipient);</span>
<span class="lineNum">    6501 </span><span class="lineNoCov">          0 :                 unlink(tmptxtfile);</span>
<span class="lineNum">    6502 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6503 </span>            :         }
<span class="lineNum">    6504 </span>            : 
<span class="lineNum">    6505 </span><span class="lineNoCov">          0 :         snprintf(desttxtfile, sizeof(desttxtfile), &quot;%s.txt&quot;, destination);</span>
<span class="lineNum">    6506 </span><span class="lineNoCov">          0 :         rename(tmptxtfile, desttxtfile);</span>
<span class="lineNum">    6507 </span>            : 
<span class="lineNum">    6508 </span><span class="lineNoCov">          0 :         if (chmod(desttxtfile, VOICEMAIL_FILE_MODE) &lt; 0) {</span>
<span class="lineNum">    6509 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Couldn't set permissions on voicemail text file %s: %s&quot;, desttxtfile, strerror(errno));</span>
<span class="lineNum">    6510 </span>            :         }
<span class="lineNum">    6511 </span>            : 
<span class="lineNum">    6512 </span>            : 
<span class="lineNum">    6513 </span><span class="lineNoCov">          0 :         ast_unlock_path(dir);</span>
<span class="lineNum">    6514 </span><span class="lineNoCov">          0 :         inprocess_count(recipient-&gt;mailbox, recipient-&gt;context, -1);</span>
<span class="lineNum">    6515 </span>            : 
<span class="lineNum">    6516 </span>            :         /* If we copied something, we should store it either to ODBC or IMAP if we are using those. The STORE macro allows us
<span class="lineNum">    6517 </span>            :          * to do both with one line and is also safe to use with file storage mode. Also, if we are using ODBC, now is a good
<span class="lineNum">    6518 </span>            :          * time to create the voicemail database entry. */
<span class="lineNum">    6519 </span><span class="lineNoCov">          0 :         if (ast_fileexists(destination, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    6520 </span><span class="lineNoCov">          0 :                 if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    6521 </span><span class="lineNoCov">          0 :                         get_date(date, sizeof(date));</span>
<span class="lineNum">    6522 </span><span class="lineNoCov">          0 :                         ast_store_realtime(&quot;voicemail_data&quot;,</span>
<span class="lineNum">    6523 </span>            :                                 &quot;origmailbox&quot;, recdata-&gt;mailbox,
<span class="lineNum">    6524 </span><span class="lineNoCov">          0 :                                 &quot;context&quot;, S_OR(recdata-&gt;context, &quot;&quot;),</span>
<span class="lineNum">    6525 </span><span class="lineNoCov">          0 :                                 &quot;macrocontext&quot;, S_OR(recdata-&gt;call_macrocontext, &quot;&quot;),</span>
<span class="lineNum">    6526 </span><span class="lineNoCov">          0 :                                 &quot;exten&quot;, S_OR(recdata-&gt;call_extension, &quot;&quot;),</span>
<span class="lineNum">    6527 </span>            :                                 &quot;priority&quot;, recdata-&gt;call_priority,
<span class="lineNum">    6528 </span><span class="lineNoCov">          0 :                                 &quot;callerchan&quot;, S_OR(recdata-&gt;call_callerchan, &quot;Unknown&quot;),</span>
<span class="lineNum">    6529 </span><span class="lineNoCov">          0 :                                 &quot;callerid&quot;, S_OR(recdata-&gt;call_callerid, &quot;Unknown&quot;),</span>
<span class="lineNum">    6530 </span>            :                                 &quot;origdate&quot;, date,
<span class="lineNum">    6531 </span>            :                                 &quot;origtime&quot;, time(NULL),
<span class="lineNum">    6532 </span><span class="lineNoCov">          0 :                                 &quot;category&quot;, S_OR(category, &quot;&quot;),</span>
<span class="lineNum">    6533 </span>            :                                 &quot;filename&quot;, tmptxtfile,
<span class="lineNum">    6534 </span>            :                                 &quot;duration&quot;, duration,
<span class="lineNum">    6535 </span>            :                                 SENTINEL);
<span class="lineNum">    6536 </span>            :                 }
<span class="lineNum">    6537 </span>            : 
<span class="lineNum">    6538 </span>            :                 STORE(dir, recipient-&gt;mailbox, recipient-&gt;context, msgnum, NULL, recipient, fmt, 0, vms, &quot;&quot;, msg_id);
<span class="lineNum">    6539 </span><span class="lineNoCov">          0 :                 notify_new_state(recipient);</span>
<span class="lineNum">    6540 </span>            :         }
<span class="lineNum">    6541 </span>            : 
<span class="lineNum">    6542 </span><span class="lineNoCov">          0 :         free_user(recipient);</span>
<span class="lineNum">    6543 </span><span class="lineNoCov">          0 :         unlink(tmptxtfile);</span>
<span class="lineNum">    6544 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    6545 </span>            : }
<span class="lineNum">    6546 </span>            : 
<span class="lineNum">    6547 </span>            : /*!
<span class="lineNum">    6548 </span>            :  * \brief Prompts the user and records a voicemail to a mailbox.
<span class="lineNum">    6549 </span>            :  * \param chan
<span class="lineNum">    6550 </span>            :  * \param ext
<span class="lineNum">    6551 </span>            :  * \param options OPT_BUSY_GREETING, OPT_UNAVAIL_GREETING
<span class="lineNum">    6552 </span>            :  *
<span class="lineNum">    6553 </span>            :  *
<span class="lineNum">    6554 </span>            :  *
<a name="6555"><span class="lineNum">    6555 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    6556 </span>            :  */
<span class="lineNum">    6557 </span><span class="lineCov">         22 : static int leave_voicemail(struct ast_channel *chan, char *ext, struct leave_vm_options *options)</span>
<span class="lineNum">    6558 </span>            : {
<span class="lineNum">    6559 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    6560 </span>            :         int newmsgs, oldmsgs;
<span class="lineNum">    6561 </span>            : #else
<span class="lineNum">    6562 </span>            :         char urgdir[PATH_MAX];
<span class="lineNum">    6563 </span>            : #endif
<span class="lineNum">    6564 </span>            :         char txtfile[PATH_MAX];
<span class="lineNum">    6565 </span>            :         char tmptxtfile[PATH_MAX];
<span class="lineNum">    6566 </span><span class="lineCov">         22 :         struct vm_state *vms = NULL;</span>
<span class="lineNum">    6567 </span>            :         char callerid[256];
<span class="lineNum">    6568 </span>            :         FILE *txt;
<span class="lineNum">    6569 </span>            :         char date[256];
<span class="lineNum">    6570 </span>            :         int txtdes;
<span class="lineNum">    6571 </span><span class="lineCov">         22 :         int res = 0;</span>
<span class="lineNum">    6572 </span>            :         int msgnum;
<span class="lineNum">    6573 </span><span class="lineCov">         22 :         int duration = 0;</span>
<span class="lineNum">    6574 </span><span class="lineCov">         22 :         int sound_duration = 0;</span>
<span class="lineNum">    6575 </span><span class="lineCov">         22 :         int ausemacro = 0;</span>
<span class="lineNum">    6576 </span><span class="lineCov">         22 :         int ousemacro = 0;</span>
<span class="lineNum">    6577 </span><span class="lineCov">         22 :         int ouseexten = 0;</span>
<span class="lineNum">    6578 </span><span class="lineCov">         22 :         int greeting_only = 0;</span>
<span class="lineNum">    6579 </span>            :         char tmpdur[16];
<span class="lineNum">    6580 </span>            :         char priority[16];
<span class="lineNum">    6581 </span>            :         char origtime[16];
<span class="lineNum">    6582 </span>            :         char dir[PATH_MAX];
<span class="lineNum">    6583 </span>            :         char tmpdir[PATH_MAX];
<span class="lineNum">    6584 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    6585 </span><span class="lineCov">         22 :         char prefile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">    6586 </span><span class="lineCov">         22 :         char tempfile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">    6587 </span><span class="lineCov">         22 :         char ext_context[256] = &quot;&quot;;</span>
<span class="lineNum">    6588 </span>            :         char fmt[80];
<span class="lineNum">    6589 </span>            :         char *context;
<span class="lineNum">    6590 </span><span class="lineCov">         22 :         char ecodes[17] = &quot;#&quot;;</span>
<span class="lineNum">    6591 </span><span class="lineCov">         22 :         struct ast_str *tmp = ast_str_create(16);</span>
<span class="lineNum">    6592 </span>            :         char *tmpptr;
<span class="lineNum">    6593 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">    6594 </span>            :         struct ast_vm_user svm;
<span class="lineNum">    6595 </span><span class="lineCov">         22 :         const char *category = NULL;</span>
<span class="lineNum">    6596 </span>            :         const char *code;
<span class="lineNum">    6597 </span><span class="lineCov">         22 :         const char *alldtmf = &quot;0123456789ABCD*#&quot;;</span>
<span class="lineNum">    6598 </span>            :         char flag[80];
<span class="lineNum">    6599 </span>            : 
<span class="lineNum">    6600 </span><span class="lineCov">         22 :         if (!tmp) {</span>
<span class="lineNum">    6601 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6602 </span>            :         }
<span class="lineNum">    6603 </span>            : 
<span class="lineNum">    6604 </span><span class="lineCov">         22 :         ast_str_set(&amp;tmp, 0, &quot;%s&quot;, ext);</span>
<span class="lineNum">    6605 </span><span class="lineCov">         22 :         ext = ast_str_buffer(tmp);</span>
<span class="lineNum">    6606 </span><span class="lineCov">         22 :         if ((context = strchr(ext, '@'))) {</span>
<span class="lineNum">    6607 </span><span class="lineCov">         22 :                 *context++ = '\0';</span>
<span class="lineNum">    6608 </span><span class="lineCov">         22 :                 tmpptr = strchr(context, '&amp;');</span>
<span class="lineNum">    6609 </span>            :         } else {
<span class="lineNum">    6610 </span><span class="lineNoCov">          0 :                 tmpptr = strchr(ext, '&amp;');</span>
<span class="lineNum">    6611 </span>            :         }
<span class="lineNum">    6612 </span>            : 
<span class="lineNum">    6613 </span><span class="lineCov">         22 :         if (tmpptr)</span>
<span class="lineNum">    6614 </span><span class="lineCov">          3 :                 *tmpptr++ = '\0';</span>
<span class="lineNum">    6615 </span>            : 
<span class="lineNum">    6616 </span><span class="lineCov">         22 :         ast_channel_lock(chan);</span>
<span class="lineNum">    6617 </span><span class="lineCov">         22 :         if ((category = pbx_builtin_getvar_helper(chan, &quot;VM_CATEGORY&quot;))) {</span>
<span class="lineNum">    6618 </span><span class="lineNoCov">          0 :                 category = ast_strdupa(category);</span>
<span class="lineNum">    6619 </span>            :         }
<span class="lineNum">    6620 </span><span class="lineCov">         22 :         ast_channel_unlock(chan);</span>
<span class="lineNum">    6621 </span>            : 
<span class="lineNum">    6622 </span><span class="lineCov">         22 :         if (ast_test_flag(options, OPT_MESSAGE_Urgent)) {</span>
<span class="lineNum">    6623 </span><span class="lineCov">          3 :                 ast_copy_string(flag, &quot;Urgent&quot;, sizeof(flag));</span>
<span class="lineNum">    6624 </span><span class="lineCov">         19 :         } else if (ast_test_flag(options, OPT_MESSAGE_PRIORITY)) {</span>
<span class="lineNum">    6625 </span><span class="lineCov">          1 :                 ast_copy_string(flag, &quot;PRIORITY&quot;, sizeof(flag));</span>
<span class="lineNum">    6626 </span>            :         } else {
<span class="lineNum">    6627 </span><span class="lineCov">         18 :                 flag[0] = '\0';</span>
<span class="lineNum">    6628 </span>            :         }
<span class="lineNum">    6629 </span>            : 
<span class="lineNum">    6630 </span><span class="lineCov">         22 :         ast_debug(3, &quot;Before find_user\n&quot;);</span>
<span class="lineNum">    6631 </span><span class="lineCov">         22 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">    6632 </span><span class="lineCov">         22 :         if (!(vmu = find_user(&amp;svm, context, ext))) {</span>
<span class="lineNum">    6633 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No entry in voicemail config file for '%s'\n&quot;, ext);</span>
<span class="lineNum">    6634 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    6635 </span><span class="lineNoCov">          0 :                 ast_free(tmp);</span>
<span class="lineNum">    6636 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    6637 </span>            :         }
<span class="lineNum">    6638 </span>            : 
<span class="lineNum">    6639 </span>            :         /* If maxmsg is zero, act as a &quot;greetings only&quot; voicemail: Exit successfully without recording */
<span class="lineNum">    6640 </span><span class="lineCov">         22 :         if (vmu-&gt;maxmsg == 0) {</span>
<span class="lineNum">    6641 </span><span class="lineNoCov">          0 :                 greeting_only = 1;</span>
<span class="lineNum">    6642 </span><span class="lineNoCov">          0 :                 ast_set_flag(options, OPT_SILENT);</span>
<span class="lineNum">    6643 </span>            :         }
<span class="lineNum">    6644 </span>            : 
<span class="lineNum">    6645 </span>            :         /* Setup pre-file if appropriate */
<span class="lineNum">    6646 </span><span class="lineCov">         22 :         if (strcmp(vmu-&gt;context, &quot;default&quot;))</span>
<span class="lineNum">    6647 </span><span class="lineCov">          1 :                 snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, ext, vmu-&gt;context);</span>
<span class="lineNum">    6648 </span>            :         else
<span class="lineNum">    6649 </span><span class="lineCov">         21 :                 ast_copy_string(ext_context, vmu-&gt;mailbox, sizeof(ext_context));</span>
<span class="lineNum">    6650 </span>            : 
<span class="lineNum">    6651 </span>            :         /* Set the path to the prefile. Will be one of
<span class="lineNum">    6652 </span>            :                 VM_SPOOL_DIRcontext/ext/busy
<span class="lineNum">    6653 </span>            :                 VM_SPOOL_DIRcontext/ext/unavail
<span class="lineNum">    6654 </span>            :            Depending on the flag set in options.
<span class="lineNum">    6655 </span>            :         */
<span class="lineNum">    6656 </span><span class="lineCov">         22 :         if (ast_test_flag(options, OPT_BUSY_GREETING)) {</span>
<span class="lineNum">    6657 </span><span class="lineCov">          2 :                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/busy&quot;, VM_SPOOL_DIR, vmu-&gt;context, ext);</span>
<span class="lineNum">    6658 </span><span class="lineCov">         20 :         } else if (ast_test_flag(options, OPT_UNAVAIL_GREETING)) {</span>
<span class="lineNum">    6659 </span><span class="lineCov">         18 :                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/unavail&quot;, VM_SPOOL_DIR, vmu-&gt;context, ext);</span>
<span class="lineNum">    6660 </span>            :         }
<span class="lineNum">    6661 </span>            :         /* Set the path to the tmpfile as
<span class="lineNum">    6662 </span>            :                 VM_SPOOL_DIR/context/ext/temp
<span class="lineNum">    6663 </span>            :            and attempt to create the folder structure.
<span class="lineNum">    6664 </span>            :         */
<span class="lineNum">    6665 </span><span class="lineCov">         22 :         snprintf(tempfile, sizeof(tempfile), &quot;%s%s/%s/temp&quot;, VM_SPOOL_DIR, vmu-&gt;context, ext);</span>
<span class="lineNum">    6666 </span><span class="lineCov">         22 :         if ((res = create_dirpath(tmpdir, sizeof(tmpdir), vmu-&gt;context, ext, &quot;tmp&quot;))) {</span>
<span class="lineNum">    6667 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Failed to make directory (%s)\n&quot;, tempfile);</span>
<span class="lineNum">    6668 </span><span class="lineNoCov">          0 :                 free_user(vmu);</span>
<span class="lineNum">    6669 </span><span class="lineNoCov">          0 :                 ast_free(tmp);</span>
<span class="lineNum">    6670 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6671 </span>            :         }
<span class="lineNum">    6672 </span>            :         RETRIEVE(tempfile, -1, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">    6673 </span><span class="lineCov">         22 :         if (ast_fileexists(tempfile, NULL, NULL) &gt; 0)</span>
<span class="lineNum">    6674 </span><span class="lineNoCov">          0 :                 ast_copy_string(prefile, tempfile, sizeof(prefile));</span>
<span class="lineNum">    6675 </span>            : 
<span class="lineNum">    6676 </span>            :         DISPOSE(tempfile, -1);
<span class="lineNum">    6677 </span>            :         /* It's easier just to try to make it than to check for its existence */
<span class="lineNum">    6678 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    6679 </span><span class="lineCov">         22 :         create_dirpath(dir, sizeof(dir), vmu-&gt;context, ext, &quot;INBOX&quot;);</span>
<span class="lineNum">    6680 </span>            : #else
<span class="lineNum">    6681 </span>            :         snprintf(dir, sizeof(dir), &quot;%simap&quot;, VM_SPOOL_DIR);
<span class="lineNum">    6682 </span>            :         if (mkdir(dir, VOICEMAIL_DIR_MODE) &amp;&amp; errno != EEXIST) {
<span class="lineNum">    6683 </span>            :                 ast_log(LOG_WARNING, &quot;mkdir '%s' failed: %s\n&quot;, dir, strerror(errno));
<span class="lineNum">    6684 </span>            :         }
<span class="lineNum">    6685 </span>            : #endif
<span class="lineNum">    6686 </span>            : 
<span class="lineNum">    6687 </span>            :         /* Check current or macro-calling context for special extensions */
<span class="lineNum">    6688 </span><span class="lineCov">         22 :         if (ast_test_flag(vmu, VM_OPERATOR)) {</span>
<span class="lineNum">    6689 </span><span class="lineCov">         16 :                 if (!ast_strlen_zero(vmu-&gt;exit)) {</span>
<span class="lineNum">    6690 </span><span class="lineCov">          6 :                         if (ast_exists_extension(chan, vmu-&gt;exit, &quot;o&quot;, 1,</span>
<span class="lineNum">    6691 </span><span class="lineCov">          6 :                                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6692 </span><span class="lineCov">          6 :                                 strncat(ecodes, &quot;0&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6693 </span><span class="lineCov">          6 :                                 ouseexten = 1;</span>
<span class="lineNum">    6694 </span>            :                         }
<span class="lineNum">    6695 </span><span class="lineCov">         10 :                 } else if (ast_exists_extension(chan, ast_channel_context(chan), &quot;o&quot;, 1,</span>
<span class="lineNum">    6696 </span><span class="lineCov">         10 :                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6697 </span><span class="lineCov">         10 :                         strncat(ecodes, &quot;0&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6698 </span><span class="lineCov">         10 :                         ouseexten = 1;</span>
<span class="lineNum">    6699 </span><span class="lineNoCov">          0 :                 } else if (!ast_strlen_zero(ast_channel_macrocontext(chan))</span>
<span class="lineNum">    6700 </span><span class="lineNoCov">          0 :                         &amp;&amp; ast_exists_extension(chan, ast_channel_macrocontext(chan), &quot;o&quot;, 1,</span>
<span class="lineNum">    6701 </span><span class="lineNoCov">          0 :                                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6702 </span><span class="lineNoCov">          0 :                         strncat(ecodes, &quot;0&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6703 </span><span class="lineNoCov">          0 :                         ousemacro = 1;</span>
<span class="lineNum">    6704 </span>            :                 }
<span class="lineNum">    6705 </span>            :         }
<span class="lineNum">    6706 </span>            : 
<span class="lineNum">    6707 </span><span class="lineCov">         22 :         if (!ast_strlen_zero(vmu-&gt;exit)) {</span>
<span class="lineNum">    6708 </span><span class="lineCov">          6 :                 if (ast_exists_extension(chan, vmu-&gt;exit, &quot;a&quot;, 1,</span>
<span class="lineNum">    6709 </span><span class="lineCov">          6 :                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6710 </span><span class="lineCov">          6 :                         strncat(ecodes, &quot;*&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6711 </span>            :                 }
<span class="lineNum">    6712 </span><span class="lineCov">         16 :         } else if (ast_exists_extension(chan, ast_channel_context(chan), &quot;a&quot;, 1,</span>
<span class="lineNum">    6713 </span><span class="lineCov">         16 :                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6714 </span><span class="lineCov">         16 :                 strncat(ecodes, &quot;*&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6715 </span><span class="lineNoCov">          0 :         } else if (!ast_strlen_zero(ast_channel_macrocontext(chan))</span>
<span class="lineNum">    6716 </span><span class="lineNoCov">          0 :                 &amp;&amp; ast_exists_extension(chan, ast_channel_macrocontext(chan), &quot;a&quot;, 1,</span>
<span class="lineNum">    6717 </span><span class="lineNoCov">          0 :                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6718 </span><span class="lineNoCov">          0 :                 strncat(ecodes, &quot;*&quot;, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6719 </span><span class="lineNoCov">          0 :                 ausemacro = 1;</span>
<span class="lineNum">    6720 </span>            :         }
<span class="lineNum">    6721 </span>            : 
<span class="lineNum">    6722 </span><span class="lineCov">         22 :         if (ast_test_flag(options, OPT_DTMFEXIT)) {</span>
<span class="lineNum">    6723 </span><span class="lineCov">        187 :                 for (code = alldtmf; *code; code++) {</span>
<span class="lineNum">    6724 </span><span class="lineCov">        176 :                         char e[2] = &quot;&quot;;</span>
<span class="lineNum">    6725 </span><span class="lineCov">        176 :                         e[0] = *code;</span>
<span class="lineNum">    6726 </span><span class="lineCov">        176 :                         if (strchr(ecodes, e[0]) == NULL</span>
<span class="lineNum">    6727 </span><span class="lineCov">        208 :                                 &amp;&amp; ast_canmatch_extension(chan,</span>
<span class="lineNum">    6728 </span><span class="lineCov">         65 :                                         (!ast_strlen_zero(options-&gt;exitcontext) ? options-&gt;exitcontext : ast_channel_context(chan)),</span>
<span class="lineNum">    6729 </span><span class="lineCov">        143 :                                         e, 1, S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">    6730 </span><span class="lineCov">         44 :                                 strncat(ecodes, e, sizeof(ecodes) - strlen(ecodes) - 1);</span>
<span class="lineNum">    6731 </span>            :                         }
<span class="lineNum">    6732 </span>            :                 }
<span class="lineNum">    6733 </span>            :         }
<span class="lineNum">    6734 </span>            : 
<span class="lineNum">    6735 </span>            :         /* Play the beginning intro if desired */
<span class="lineNum">    6736 </span><span class="lineCov">         22 :         if (!ast_strlen_zero(prefile)) {</span>
<span class="lineNum">    6737 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">    6738 </span>            :                 int success =
<span class="lineNum">    6739 </span>            : #endif
<span class="lineNum">    6740 </span>            :                         RETRIEVE(prefile, -1, ext, context);
<span class="lineNum">    6741 </span><span class="lineCov">         20 :                 if (ast_fileexists(prefile, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    6742 </span><span class="lineNoCov">          0 :                         if (ast_streamfile(chan, prefile, ast_channel_language(chan)) &gt; -1)</span>
<span class="lineNum">    6743 </span><span class="lineNoCov">          0 :                                 res = ast_waitstream(chan, ecodes);</span>
<span class="lineNum">    6744 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">    6745 </span>            :                         if (success == -1) {
<span class="lineNum">    6746 </span>            :                                 /* We couldn't retrieve the file from the database, but we found it on the file system. Let's put it in the database. */
<span class="lineNum">    6747 </span>            :                                 ast_debug(1, &quot;Greeting not retrieved from database, but found in file storage. Inserting into database\n&quot;);
<span class="lineNum">    6748 </span>            :                                 store_file(prefile, vmu-&gt;mailbox, vmu-&gt;context, -1);
<span class="lineNum">    6749 </span>            :                         }
<span class="lineNum">    6750 </span>            : #endif
<span class="lineNum">    6751 </span>            :                 } else {
<span class="lineNum">    6752 </span><span class="lineCov">         20 :                         ast_debug(1, &quot;%s doesn't exist, doing what we can\n&quot;, prefile);</span>
<span class="lineNum">    6753 </span><span class="lineCov">         20 :                         res = invent_message(chan, vmu-&gt;context, ext, ast_test_flag(options, OPT_BUSY_GREETING), ecodes);</span>
<span class="lineNum">    6754 </span>            :                 }
<span class="lineNum">    6755 </span>            :                 DISPOSE(prefile, -1);
<span class="lineNum">    6756 </span><span class="lineCov">         20 :                 if (res &lt; 0) {</span>
<span class="lineNum">    6757 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;Hang up during prefile playback\n&quot;);</span>
<span class="lineNum">    6758 </span><span class="lineNoCov">          0 :                         free_user(vmu);</span>
<span class="lineNum">    6759 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    6760 </span><span class="lineNoCov">          0 :                         ast_free(tmp);</span>
<span class="lineNum">    6761 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">    6762 </span>            :                 }
<span class="lineNum">    6763 </span>            :         }
<span class="lineNum">    6764 </span><span class="lineCov">         22 :         if (res == '#') {</span>
<span class="lineNum">    6765 </span>            :                 /* On a '#' we skip the instructions */
<span class="lineNum">    6766 </span><span class="lineNoCov">          0 :                 ast_set_flag(options, OPT_SILENT);</span>
<span class="lineNum">    6767 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">    6768 </span>            :         }
<span class="lineNum">    6769 </span><span class="lineCov">         22 :         if (!res &amp;&amp; !ast_test_flag(options, OPT_SILENT)) {</span>
<span class="lineNum">    6770 </span><span class="lineCov">         22 :                 res = ast_stream_and_wait(chan, INTRO, ecodes);</span>
<span class="lineNum">    6771 </span><span class="lineCov">         22 :                 if (res == '#') {</span>
<span class="lineNum">    6772 </span><span class="lineNoCov">          0 :                         ast_set_flag(options, OPT_SILENT);</span>
<span class="lineNum">    6773 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">    6774 </span>            :                 }
<span class="lineNum">    6775 </span>            :         }
<span class="lineNum">    6776 </span><span class="lineCov">         22 :         if (res &gt; 0)</span>
<span class="lineNum">    6777 </span><span class="lineCov">         11 :                 ast_stopstream(chan);</span>
<span class="lineNum">    6778 </span>            :         /* Check for a '*' here in case the caller wants to escape from voicemail to something
<span class="lineNum">    6779 </span>            :          other than the operator -- an automated attendant or mailbox login for example */
<span class="lineNum">    6780 </span><span class="lineCov">         22 :         if (res == '*') {</span>
<span class="lineNum">    6781 </span><span class="lineCov">          2 :                 ast_channel_exten_set(chan, &quot;a&quot;);</span>
<span class="lineNum">    6782 </span><span class="lineCov">          2 :                 if (!ast_strlen_zero(vmu-&gt;exit)) {</span>
<span class="lineNum">    6783 </span><span class="lineCov">          1 :                         ast_channel_context_set(chan, vmu-&gt;exit);</span>
<span class="lineNum">    6784 </span><span class="lineCov">          1 :                 } else if (ausemacro &amp;&amp; !ast_strlen_zero(ast_channel_macrocontext(chan))) {</span>
<span class="lineNum">    6785 </span><span class="lineNoCov">          0 :                         ast_channel_context_set(chan, ast_channel_macrocontext(chan));</span>
<span class="lineNum">    6786 </span>            :                 }
<span class="lineNum">    6787 </span><span class="lineCov">          2 :                 ast_channel_priority_set(chan, 0);</span>
<span class="lineNum">    6788 </span><span class="lineCov">          2 :                 free_user(vmu);</span>
<span class="lineNum">    6789 </span><span class="lineCov">          2 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;USEREXIT&quot;);</span>
<span class="lineNum">    6790 </span><span class="lineCov">          2 :                 ast_free(tmp);</span>
<span class="lineNum">    6791 </span><span class="lineCov">          2 :                 return 0;</span>
<span class="lineNum">    6792 </span>            :         }
<span class="lineNum">    6793 </span>            : 
<span class="lineNum">    6794 </span>            :         /* Check for a '0' here */
<span class="lineNum">    6795 </span><span class="lineCov">         20 :         if (ast_test_flag(vmu, VM_OPERATOR) &amp;&amp; res == '0') {</span>
<span class="lineNum">    6796 </span><span class="lineCov">          2 :         transfer:</span>
<span class="lineNum">    6797 </span><span class="lineCov">          2 :                 if (ouseexten || ousemacro) {</span>
<span class="lineNum">    6798 </span><span class="lineCov">          2 :                         ast_channel_exten_set(chan, &quot;o&quot;);</span>
<span class="lineNum">    6799 </span><span class="lineCov">          2 :                         if (!ast_strlen_zero(vmu-&gt;exit)) {</span>
<span class="lineNum">    6800 </span><span class="lineCov">          1 :                                 ast_channel_context_set(chan, vmu-&gt;exit);</span>
<span class="lineNum">    6801 </span><span class="lineCov">          1 :                         } else if (ousemacro &amp;&amp; !ast_strlen_zero(ast_channel_macrocontext(chan))) {</span>
<span class="lineNum">    6802 </span><span class="lineNoCov">          0 :                                 ast_channel_context_set(chan, ast_channel_macrocontext(chan));</span>
<span class="lineNum">    6803 </span>            :                         }
<span class="lineNum">    6804 </span><span class="lineCov">          2 :                         ast_play_and_wait(chan, &quot;transfer&quot;);</span>
<span class="lineNum">    6805 </span><span class="lineCov">          2 :                         ast_channel_priority_set(chan, 0);</span>
<span class="lineNum">    6806 </span><span class="lineCov">          2 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;USEREXIT&quot;);</span>
<span class="lineNum">    6807 </span>            :                 }
<span class="lineNum">    6808 </span><span class="lineCov">          2 :                 free_user(vmu);</span>
<span class="lineNum">    6809 </span><span class="lineCov">          2 :                 ast_free(tmp);</span>
<span class="lineNum">    6810 </span><span class="lineCov">          2 :                 return OPERATOR_EXIT;</span>
<span class="lineNum">    6811 </span>            :         }
<span class="lineNum">    6812 </span>            : 
<span class="lineNum">    6813 </span>            :         /* Allow all other digits to exit Voicemail and return to the dialplan */
<span class="lineNum">    6814 </span><span class="lineCov">         18 :         if (ast_test_flag(options, OPT_DTMFEXIT) &amp;&amp; res &gt; 0) {</span>
<span class="lineNum">    6815 </span><span class="lineCov">          7 :                 if (!ast_strlen_zero(options-&gt;exitcontext)) {</span>
<span class="lineNum">    6816 </span><span class="lineCov">          4 :                         ast_channel_context_set(chan, options-&gt;exitcontext);</span>
<span class="lineNum">    6817 </span>            :                 }
<span class="lineNum">    6818 </span><span class="lineCov">          7 :                 free_user(vmu);</span>
<span class="lineNum">    6819 </span><span class="lineCov">          7 :                 ast_free(tmp);</span>
<span class="lineNum">    6820 </span><span class="lineCov">          7 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;USEREXIT&quot;);</span>
<span class="lineNum">    6821 </span><span class="lineCov">          7 :                 return res;</span>
<span class="lineNum">    6822 </span>            :         }
<span class="lineNum">    6823 </span>            : 
<span class="lineNum">    6824 </span><span class="lineCov">         11 :         if (greeting_only) {</span>
<span class="lineNum">    6825 </span><span class="lineNoCov">          0 :                 ast_debug(3, &quot;Greetings only VM (maxmsg=0), Skipping voicemail recording\n&quot;);</span>
<span class="lineNum">    6826 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;SUCCESS&quot;);</span>
<span class="lineNum">    6827 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">    6828 </span><span class="lineNoCov">          0 :                 goto leave_vm_out;</span>
<span class="lineNum">    6829 </span>            :         }
<span class="lineNum">    6830 </span>            : 
<span class="lineNum">    6831 </span><span class="lineCov">         11 :         if (res &lt; 0) {</span>
<span class="lineNum">    6832 </span><span class="lineNoCov">          0 :                 free_user(vmu);</span>
<span class="lineNum">    6833 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    6834 </span><span class="lineNoCov">          0 :                 ast_free(tmp);</span>
<span class="lineNum">    6835 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    6836 </span>            :         }
<span class="lineNum">    6837 </span>            :         /* The meat of recording the message...  All the announcements and beeps have been played*/
<span class="lineNum">    6838 </span><span class="lineCov">         11 :         ast_copy_string(fmt, vmfmts, sizeof(fmt));</span>
<span class="lineNum">    6839 </span><span class="lineCov">         11 :         if (!ast_strlen_zero(fmt)) {</span>
<span class="lineNum">    6840 </span><span class="lineCov">         11 :                 char msg_id[MSG_ID_LEN] = &quot;&quot;;</span>
<span class="lineNum">    6841 </span><span class="lineCov">         11 :                 msgnum = 0;</span>
<span class="lineNum">    6842 </span>            : 
<span class="lineNum">    6843 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    6844 </span>            :                 /* Is ext a mailbox? */
<span class="lineNum">    6845 </span>            :                 /* must open stream for this user to get info! */
<span class="lineNum">    6846 </span>            :                 res = inboxcount(ext_context, &amp;newmsgs, &amp;oldmsgs);
<span class="lineNum">    6847 </span>            :                 if (res &lt; 0) {
<span class="lineNum">    6848 </span>            :                         ast_log(AST_LOG_NOTICE, &quot;Can not leave voicemail, unable to count messages\n&quot;);
<span class="lineNum">    6849 </span>            :                         free_user(vmu);
<span class="lineNum">    6850 </span>            :                         ast_free(tmp);
<span class="lineNum">    6851 </span>            :                         return -1;
<span class="lineNum">    6852 </span>            :                 }
<span class="lineNum">    6853 </span>            :                 if (!(vms = get_vm_state_by_mailbox(ext, context, 0))) {
<span class="lineNum">    6854 </span>            :                 /* It is possible under certain circumstances that inboxcount did not
<span class="lineNum">    6855 </span>            :                  * create a vm_state when it was needed. This is a catchall which will
<span class="lineNum">    6856 </span>            :                  * rarely be used.
<span class="lineNum">    6857 </span>            :                  */
<span class="lineNum">    6858 </span>            :                         if (!(vms = create_vm_state_from_user(vmu))) {
<span class="lineNum">    6859 </span>            :                                 ast_log(AST_LOG_ERROR, &quot;Couldn't allocate necessary space\n&quot;);
<span class="lineNum">    6860 </span>            :                                 free_user(vmu);
<span class="lineNum">    6861 </span>            :                                 ast_free(tmp);
<span class="lineNum">    6862 </span>            :                                 return -1;
<span class="lineNum">    6863 </span>            :                         }
<span class="lineNum">    6864 </span>            :                 }
<span class="lineNum">    6865 </span>            :                 vms-&gt;newmessages++;
<span class="lineNum">    6866 </span>            : 
<span class="lineNum">    6867 </span>            :                 /* here is a big difference! We add one to it later */
<span class="lineNum">    6868 </span>            :                 msgnum = newmsgs + oldmsgs;
<span class="lineNum">    6869 </span>            :                 ast_debug(3, &quot;Messagecount set to %d\n&quot;, msgnum);
<span class="lineNum">    6870 </span>            :                 snprintf(fn, sizeof(fn), &quot;%simap/msg%s%04d&quot;, VM_SPOOL_DIR, vmu-&gt;mailbox, msgnum);
<span class="lineNum">    6871 </span>            :                 /* set variable for compatibility */
<span class="lineNum">    6872 </span>            :                 pbx_builtin_setvar_helper(chan, &quot;VM_MESSAGEFILE&quot;, &quot;IMAP_STORAGE&quot;);
<span class="lineNum">    6873 </span>            : 
<span class="lineNum">    6874 </span>            :                 if ((res = imap_check_limits(chan, vms, vmu, msgnum))) {
<span class="lineNum">    6875 </span>            :                         goto leave_vm_out;
<span class="lineNum">    6876 </span>            :                 }
<span class="lineNum">    6877 </span>            : #else
<span class="lineNum">    6878 </span><span class="lineCov">         11 :                 if (count_messages(vmu, dir) &gt;= vmu-&gt;maxmsg - inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, +1)) {</span>
<span class="lineNum">    6879 </span><span class="lineNoCov">          0 :                         res = ast_streamfile(chan, &quot;vm-mailboxfull&quot;, ast_channel_language(chan));</span>
<span class="lineNum">    6880 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    6881 </span><span class="lineNoCov">          0 :                                 res = ast_waitstream(chan, &quot;&quot;);</span>
<span class="lineNum">    6882 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;No more messages possible\n&quot;);</span>
<span class="lineNum">    6883 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    6884 </span><span class="lineNoCov">          0 :                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    6885 </span><span class="lineNoCov">          0 :                         goto leave_vm_out;</span>
<span class="lineNum">    6886 </span>            :                 }
<span class="lineNum">    6887 </span>            : 
<span class="lineNum">    6888 </span>            : #endif
<span class="lineNum">    6889 </span><span class="lineCov">         11 :                 snprintf(tmptxtfile, sizeof(tmptxtfile), &quot;%s/XXXXXX&quot;, tmpdir);</span>
<span class="lineNum">    6890 </span><span class="lineCov">         11 :                 txtdes = mkstemp(tmptxtfile);</span>
<span class="lineNum">    6891 </span><span class="lineCov">         11 :                 chmod(tmptxtfile, VOICEMAIL_FILE_MODE &amp; ~my_umask);</span>
<span class="lineNum">    6892 </span><span class="lineCov">         11 :                 if (txtdes &lt; 0) {</span>
<span class="lineNum">    6893 </span><span class="lineNoCov">          0 :                         res = ast_streamfile(chan, &quot;vm-mailboxfull&quot;, ast_channel_language(chan));</span>
<span class="lineNum">    6894 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    6895 </span><span class="lineNoCov">          0 :                                 res = ast_waitstream(chan, &quot;&quot;);</span>
<span class="lineNum">    6896 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_ERROR, &quot;Unable to create message file: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">    6897 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    6898 </span><span class="lineNoCov">          0 :                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    6899 </span><span class="lineNoCov">          0 :                         goto leave_vm_out;</span>
<span class="lineNum">    6900 </span>            :                 }
<span class="lineNum">    6901 </span>            : 
<span class="lineNum">    6902 </span>            :                 /* Now play the beep once we have the message number for our next message. */
<span class="lineNum">    6903 </span><span class="lineCov">         11 :                 if (res &gt;= 0) {</span>
<span class="lineNum">    6904 </span>            :                         /* Unless we're *really* silent, try to send the beep */
<span class="lineNum">    6905 </span><span class="lineCov">         11 :                         res = ast_stream_and_wait(chan, &quot;beep&quot;, &quot;&quot;);</span>
<span class="lineNum">    6906 </span>            :                 }
<span class="lineNum">    6907 </span>            : 
<span class="lineNum">    6908 </span>            :                 /* Store information in real-time storage */
<span class="lineNum">    6909 </span><span class="lineCov">         11 :                 if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    6910 </span><span class="lineNoCov">          0 :                         snprintf(priority, sizeof(priority), &quot;%d&quot;, ast_channel_priority(chan));</span>
<span class="lineNum">    6911 </span><span class="lineNoCov">          0 :                         snprintf(origtime, sizeof(origtime), &quot;%ld&quot;, (long) time(NULL));</span>
<span class="lineNum">    6912 </span><span class="lineNoCov">          0 :                         get_date(date, sizeof(date));</span>
<span class="lineNum">    6913 </span><span class="lineNoCov">          0 :                         ast_callerid_merge(callerid, sizeof(callerid),</span>
<span class="lineNum">    6914 </span><span class="lineNoCov">          0 :                                 S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL),</span>
<span class="lineNum">    6915 </span><span class="lineNoCov">          0 :                                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL),</span>
<span class="lineNum">    6916 </span>            :                                 &quot;Unknown&quot;);
<span class="lineNum">    6917 </span><span class="lineNoCov">          0 :                         ast_store_realtime(&quot;voicemail_data&quot;,</span>
<span class="lineNum">    6918 </span>            :                                 &quot;origmailbox&quot;, ext,
<span class="lineNum">    6919 </span>            :                                 &quot;context&quot;, ast_channel_context(chan),
<span class="lineNum">    6920 </span>            :                                 &quot;macrocontext&quot;, ast_channel_macrocontext(chan),
<span class="lineNum">    6921 </span>            :                                 &quot;exten&quot;, ast_channel_exten(chan),
<span class="lineNum">    6922 </span>            :                                 &quot;priority&quot;, priority,
<span class="lineNum">    6923 </span>            :                                 &quot;callerchan&quot;, ast_channel_name(chan),
<span class="lineNum">    6924 </span>            :                                 &quot;callerid&quot;, callerid,
<span class="lineNum">    6925 </span>            :                                 &quot;origdate&quot;, date,
<span class="lineNum">    6926 </span>            :                                 &quot;origtime&quot;, origtime,
<span class="lineNum">    6927 </span><span class="lineNoCov">          0 :                                 &quot;category&quot;, S_OR(category, &quot;&quot;),</span>
<span class="lineNum">    6928 </span>            :                                 &quot;filename&quot;, tmptxtfile,
<span class="lineNum">    6929 </span>            :                                 SENTINEL);
<span class="lineNum">    6930 </span>            :                 }
<span class="lineNum">    6931 </span>            : 
<span class="lineNum">    6932 </span>            :                 /* Store information */
<span class="lineNum">    6933 </span><span class="lineCov">         11 :                 txt = fdopen(txtdes, &quot;w+&quot;);</span>
<span class="lineNum">    6934 </span><span class="lineCov">         11 :                 if (txt) {</span>
<span class="lineNum">    6935 </span><span class="lineCov">         11 :                         generate_msg_id(msg_id);</span>
<span class="lineNum">    6936 </span><span class="lineCov">         11 :                         get_date(date, sizeof(date));</span>
<span class="lineNum">    6937 </span><span class="lineCov">         11 :                         ast_callerid_merge(callerid, sizeof(callerid),</span>
<span class="lineNum">    6938 </span><span class="lineCov">         11 :                                 S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL),</span>
<span class="lineNum">    6939 </span><span class="lineCov">         11 :                                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL),</span>
<span class="lineNum">    6940 </span>            :                                 &quot;Unknown&quot;);
<span class="lineNum">    6941 </span><span class="lineCov">         33 :                         fprintf(txt,</span>
<span class="lineNum">    6942 </span>            :                                 &quot;;\n&quot;
<span class="lineNum">    6943 </span>            :                                 &quot;; Message Information file\n&quot;
<span class="lineNum">    6944 </span>            :                                 &quot;;\n&quot;
<span class="lineNum">    6945 </span>            :                                 &quot;[message]\n&quot;
<span class="lineNum">    6946 </span>            :                                 &quot;origmailbox=%s\n&quot;
<span class="lineNum">    6947 </span>            :                                 &quot;context=%s\n&quot;
<span class="lineNum">    6948 </span>            :                                 &quot;macrocontext=%s\n&quot;
<span class="lineNum">    6949 </span>            :                                 &quot;exten=%s\n&quot;
<span class="lineNum">    6950 </span>            :                                 &quot;rdnis=%s\n&quot;
<span class="lineNum">    6951 </span>            :                                 &quot;priority=%d\n&quot;
<span class="lineNum">    6952 </span>            :                                 &quot;callerchan=%s\n&quot;
<span class="lineNum">    6953 </span>            :                                 &quot;callerid=%s\n&quot;
<span class="lineNum">    6954 </span>            :                                 &quot;origdate=%s\n&quot;
<span class="lineNum">    6955 </span>            :                                 &quot;origtime=%ld\n&quot;
<span class="lineNum">    6956 </span>            :                                 &quot;category=%s\n&quot;
<span class="lineNum">    6957 </span>            :                                 &quot;msg_id=%s\n&quot;,
<span class="lineNum">    6958 </span>            :                                 ext,
<span class="lineNum">    6959 </span>            :                                 ast_channel_context(chan),
<span class="lineNum">    6960 </span>            :                                 ast_channel_macrocontext(chan),
<span class="lineNum">    6961 </span>            :                                 ast_channel_exten(chan),
<span class="lineNum">    6962 </span><span class="lineCov">         11 :                                 S_COR(ast_channel_redirecting(chan)-&gt;from.number.valid,</span>
<span class="lineNum">    6963 </span>            :                                         ast_channel_redirecting(chan)-&gt;from.number.str, &quot;unknown&quot;),
<span class="lineNum">    6964 </span>            :                                 ast_channel_priority(chan),
<span class="lineNum">    6965 </span>            :                                 ast_channel_name(chan),
<span class="lineNum">    6966 </span>            :                                 callerid,
<span class="lineNum">    6967 </span><span class="lineCov">         11 :                                 date, (long) time(NULL),</span>
<span class="lineNum">    6968 </span>            :                                 category ? category : &quot;&quot;,
<span class="lineNum">    6969 </span>            :                                 msg_id);
<span class="lineNum">    6970 </span>            :                 } else {
<span class="lineNum">    6971 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Error opening text file for output\n&quot;);</span>
<span class="lineNum">    6972 </span><span class="lineNoCov">          0 :                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    6973 </span><span class="lineNoCov">          0 :                         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    6974 </span><span class="lineNoCov">          0 :                                 ast_destroy_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, tmptxtfile, SENTINEL);</span>
<span class="lineNum">    6975 </span>            :                         }
<span class="lineNum">    6976 </span><span class="lineNoCov">          0 :                         res = ast_streamfile(chan, &quot;vm-mailboxfull&quot;, ast_channel_language(chan));</span>
<span class="lineNum">    6977 </span><span class="lineNoCov">          0 :                         goto leave_vm_out;</span>
<span class="lineNum">    6978 </span>            :                 }
<span class="lineNum">    6979 </span><span class="lineCov">         11 :                 res = play_record_review(chan, NULL, tmptxtfile, vmu-&gt;maxsecs, fmt, 1, vmu, &amp;duration, &amp;sound_duration, NULL, options-&gt;record_gain, vms, flag, msg_id, 0);</span>
<span class="lineNum">    6980 </span>            : 
<span class="lineNum">    6981 </span><span class="lineCov">         11 :                 if (txt) {</span>
<span class="lineNum">    6982 </span><span class="lineCov">         11 :                         fprintf(txt, &quot;flag=%s\n&quot;, flag);</span>
<span class="lineNum">    6983 </span><span class="lineCov">         11 :                         if (sound_duration &lt; vmu-&gt;minsecs) {</span>
<span class="lineNum">    6984 </span><span class="lineNoCov">          0 :                                 fclose(txt);</span>
<span class="lineNum">    6985 </span><span class="lineNoCov">          0 :                                 ast_verb(3, &quot;Recording was %d seconds long but needs to be at least %d - abandoning\n&quot;, sound_duration, vmu-&gt;minsecs);</span>
<span class="lineNum">    6986 </span><span class="lineNoCov">          0 :                                 ast_filedelete(tmptxtfile, NULL);</span>
<span class="lineNum">    6987 </span><span class="lineNoCov">          0 :                                 unlink(tmptxtfile);</span>
<span class="lineNum">    6988 </span><span class="lineNoCov">          0 :                                 if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    6989 </span><span class="lineNoCov">          0 :                                         ast_destroy_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, tmptxtfile, SENTINEL);</span>
<span class="lineNum">    6990 </span>            :                                 }
<span class="lineNum">    6991 </span><span class="lineNoCov">          0 :                                 inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    6992 </span>            :                         } else {
<span class="lineNum">    6993 </span><span class="lineCov">         11 :                                 fprintf(txt, &quot;duration=%d\n&quot;, duration);</span>
<span class="lineNum">    6994 </span><span class="lineCov">         11 :                                 fclose(txt);</span>
<span class="lineNum">    6995 </span><span class="lineCov">         11 :                                 if (vm_lock_path(dir)) {</span>
<span class="lineNum">    6996 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_ERROR, &quot;Couldn't lock directory %s.  Voicemail will be lost.\n&quot;, dir);</span>
<span class="lineNum">    6997 </span>            :                                         /* Delete files */
<span class="lineNum">    6998 </span><span class="lineNoCov">          0 :                                         ast_filedelete(tmptxtfile, NULL);</span>
<span class="lineNum">    6999 </span><span class="lineNoCov">          0 :                                         unlink(tmptxtfile);</span>
<span class="lineNum">    7000 </span><span class="lineNoCov">          0 :                                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    7001 </span><span class="lineCov">         11 :                                 } else if (ast_fileexists(tmptxtfile, NULL, NULL) &lt;= 0) {</span>
<span class="lineNum">    7002 </span><span class="lineNoCov">          0 :                                         ast_debug(1, &quot;The recorded media file is gone, so we should remove the .txt file too!\n&quot;);</span>
<span class="lineNum">    7003 </span><span class="lineNoCov">          0 :                                         unlink(tmptxtfile);</span>
<span class="lineNum">    7004 </span><span class="lineNoCov">          0 :                                         ast_unlock_path(dir);</span>
<span class="lineNum">    7005 </span><span class="lineNoCov">          0 :                                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    7006 </span><span class="lineNoCov">          0 :                                         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    7007 </span><span class="lineNoCov">          0 :                                                 ast_destroy_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, tmptxtfile, SENTINEL);</span>
<span class="lineNum">    7008 </span>            :                                         }
<span class="lineNum">    7009 </span>            :                                 } else {
<span class="lineNum">    7010 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    7011 </span><span class="lineCov">         11 :                                         msgnum = last_message_index(vmu, dir) + 1;</span>
<span class="lineNum">    7012 </span>            : #endif
<span class="lineNum">    7013 </span><span class="lineCov">         11 :                                         make_file(fn, sizeof(fn), dir, msgnum);</span>
<span class="lineNum">    7014 </span>            : 
<span class="lineNum">    7015 </span>            :                                         /* assign a variable with the name of the voicemail file */
<span class="lineNum">    7016 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    7017 </span><span class="lineCov">         11 :                                         pbx_builtin_setvar_helper(chan, &quot;VM_MESSAGEFILE&quot;, fn);</span>
<span class="lineNum">    7018 </span>            : #else
<span class="lineNum">    7019 </span>            :                                         pbx_builtin_setvar_helper(chan, &quot;VM_MESSAGEFILE&quot;, &quot;IMAP_STORAGE&quot;);
<span class="lineNum">    7020 </span>            : #endif
<span class="lineNum">    7021 </span>            : 
<span class="lineNum">    7022 </span><span class="lineCov">         11 :                                         snprintf(txtfile, sizeof(txtfile), &quot;%s.txt&quot;, fn);</span>
<span class="lineNum">    7023 </span><span class="lineCov">         11 :                                         ast_filerename(tmptxtfile, fn, NULL);</span>
<span class="lineNum">    7024 </span><span class="lineCov">         11 :                                         rename(tmptxtfile, txtfile);</span>
<span class="lineNum">    7025 </span><span class="lineCov">         11 :                                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    7026 </span>            : 
<span class="lineNum">    7027 </span>            :                                         /* Properly set permissions on voicemail text descriptor file.
<span class="lineNum">    7028 </span>            :                                            Unfortunately mkstemp() makes this file 0600 on most unix systems. */
<span class="lineNum">    7029 </span><span class="lineCov">         11 :                                         if (chmod(txtfile, VOICEMAIL_FILE_MODE) &lt; 0)</span>
<span class="lineNum">    7030 </span><span class="lineNoCov">          0 :                                                 ast_log(AST_LOG_ERROR, &quot;Couldn't set permissions on voicemail text file %s: %s&quot;, txtfile, strerror(errno));</span>
<span class="lineNum">    7031 </span>            : 
<span class="lineNum">    7032 </span><span class="lineCov">         11 :                                         ast_unlock_path(dir);</span>
<span class="lineNum">    7033 </span><span class="lineCov">         11 :                                         if (ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    7034 </span><span class="lineNoCov">          0 :                                                 snprintf(tmpdur, sizeof(tmpdur), &quot;%d&quot;, duration);</span>
<span class="lineNum">    7035 </span><span class="lineNoCov">          0 :                                                 ast_update_realtime(&quot;voicemail_data&quot;, &quot;filename&quot;, tmptxtfile, &quot;filename&quot;, fn, &quot;duration&quot;, tmpdur, SENTINEL);</span>
<span class="lineNum">    7036 </span>            :                                         }
<span class="lineNum">    7037 </span>            :                                         /* We must store the file first, before copying the message, because
<span class="lineNum">    7038 </span>            :                                          * ODBC storage does the entire copy with SQL.
<span class="lineNum">    7039 </span>            :                                          */
<span class="lineNum">    7040 </span><span class="lineCov">         11 :                                         if (ast_fileexists(fn, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    7041 </span>            :                                                 STORE(dir, vmu-&gt;mailbox, vmu-&gt;context, msgnum, chan, vmu, fmt, duration, vms, flag, msg_id);
<span class="lineNum">    7042 </span>            :                                         }
<span class="lineNum">    7043 </span>            : 
<span class="lineNum">    7044 </span>            :                                         /* Are there to be more recipients of this message? */
<span class="lineNum">    7045 </span><span class="lineCov">         19 :                                         while (tmpptr) {</span>
<span class="lineNum">    7046 </span>            :                                                 struct ast_vm_user recipu, *recip;
<span class="lineNum">    7047 </span>            :                                                 char *exten, *cntx;
<span class="lineNum">    7048 </span>            : 
<span class="lineNum">    7049 </span><span class="lineCov">          8 :                                                 exten = strsep(&amp;tmpptr, &quot;&amp;&quot;);</span>
<span class="lineNum">    7050 </span><span class="lineCov">          8 :                                                 cntx = strchr(exten, '@');</span>
<span class="lineNum">    7051 </span><span class="lineCov">          8 :                                                 if (cntx) {</span>
<span class="lineNum">    7052 </span><span class="lineCov">          8 :                                                         *cntx = '\0';</span>
<span class="lineNum">    7053 </span><span class="lineCov">          8 :                                                         cntx++;</span>
<span class="lineNum">    7054 </span>            :                                                 }
<span class="lineNum">    7055 </span><span class="lineCov">          8 :                                                 memset(&amp;recipu, 0, sizeof(recipu));</span>
<span class="lineNum">    7056 </span><span class="lineCov">          8 :                                                 if ((recip = find_user(&amp;recipu, cntx, exten))) {</span>
<span class="lineNum">    7057 </span><span class="lineCov">          8 :                                                         copy_message(chan, vmu, 0, msgnum, duration, recip, fmt, dir, flag, NULL);</span>
<span class="lineNum">    7058 </span><span class="lineCov">          8 :                                                         free_user(recip);</span>
<span class="lineNum">    7059 </span>            :                                                 }
<span class="lineNum">    7060 </span>            :                                         }
<span class="lineNum">    7061 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    7062 </span><span class="lineCov">         11 :                                         if (!ast_strlen_zero(flag) &amp;&amp; !strcmp(flag, &quot;Urgent&quot;)) { /* If this is an Urgent message */</span>
<span class="lineNum">    7063 </span>            :                                                 /* Move the message from INBOX to Urgent folder if this is urgent! */
<span class="lineNum">    7064 </span>            :                                                 char sfn[PATH_MAX];
<span class="lineNum">    7065 </span>            :                                                 char dfn[PATH_MAX];
<span class="lineNum">    7066 </span>            :                                                 int x;
<span class="lineNum">    7067 </span>            :                                                 /* It's easier just to try to make it than to check for its existence */
<span class="lineNum">    7068 </span><span class="lineCov">          3 :                                                 create_dirpath(urgdir, sizeof(urgdir), vmu-&gt;context, ext, &quot;Urgent&quot;);</span>
<span class="lineNum">    7069 </span><span class="lineCov">          3 :                                                 x = last_message_index(vmu, urgdir) + 1;</span>
<span class="lineNum">    7070 </span><span class="lineCov">          3 :                                                 make_file(sfn, sizeof(sfn), dir, msgnum);</span>
<span class="lineNum">    7071 </span><span class="lineCov">          3 :                                                 make_file(dfn, sizeof(dfn), urgdir, x);</span>
<span class="lineNum">    7072 </span><span class="lineCov">          3 :                                                 ast_debug(5, &quot;Created an Urgent message, moving file from %s to %s.\n&quot;, sfn, dfn);</span>
<span class="lineNum">    7073 </span><span class="lineCov">          3 :                                                 RENAME(dir, msgnum, vmu-&gt;mailbox, vmu-&gt;context, urgdir, x, sfn, dfn);</span>
<span class="lineNum">    7074 </span>            :                                                 /* Notification must happen for this new message in Urgent folder, not INBOX */
<span class="lineNum">    7075 </span><span class="lineCov">          3 :                                                 ast_copy_string(fn, dfn, sizeof(fn));</span>
<span class="lineNum">    7076 </span><span class="lineCov">          3 :                                                 msgnum = x;</span>
<span class="lineNum">    7077 </span>            :                                         }
<span class="lineNum">    7078 </span>            : #endif
<span class="lineNum">    7079 </span>            :                                         /* Notification needs to happen after the copy, though. */
<span class="lineNum">    7080 </span><span class="lineCov">         11 :                                         if (ast_fileexists(fn, NULL, NULL)) {</span>
<span class="lineNum">    7081 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7082 </span>            :                                                 notify_new_message(chan, vmu, vms, msgnum, duration, fmt,
<span class="lineNum">    7083 </span>            :                                                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL),
<span class="lineNum">    7084 </span>            :                                                         S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL),
<span class="lineNum">    7085 </span>            :                                                         flag);
<span class="lineNum">    7086 </span>            : #else
<span class="lineNum">    7087 </span><span class="lineCov">         11 :                                                 notify_new_message(chan, vmu, NULL, msgnum, duration, fmt,</span>
<span class="lineNum">    7088 </span><span class="lineCov">         11 :                                                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL),</span>
<span class="lineNum">    7089 </span><span class="lineCov">         11 :                                                         S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL),</span>
<span class="lineNum">    7090 </span>            :                                                         flag);
<span class="lineNum">    7091 </span>            : #endif
<span class="lineNum">    7092 </span>            :                                         }
<span class="lineNum">    7093 </span>            : 
<span class="lineNum">    7094 </span>            :                                         /* Disposal needs to happen after the optional move and copy */
<span class="lineNum">    7095 </span><span class="lineCov">         11 :                                         if (ast_fileexists(fn, NULL, NULL)) {</span>
<span class="lineNum">    7096 </span>            :                                                 DISPOSE(dir, msgnum);
<span class="lineNum">    7097 </span>            :                                         }
<span class="lineNum">    7098 </span>            :                                 }
<span class="lineNum">    7099 </span>            :                         }
<span class="lineNum">    7100 </span>            :                 } else {
<span class="lineNum">    7101 </span><span class="lineNoCov">          0 :                         inprocess_count(vmu-&gt;mailbox, vmu-&gt;context, -1);</span>
<span class="lineNum">    7102 </span>            :                 }
<span class="lineNum">    7103 </span><span class="lineCov">         11 :                 if (res == '0') {</span>
<span class="lineNum">    7104 </span><span class="lineNoCov">          0 :                         goto transfer;</span>
<span class="lineNum">    7105 </span><span class="lineCov">         11 :                 } else if (res &gt; 0 &amp;&amp; res != 't')</span>
<span class="lineNum">    7106 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">    7107 </span>            : 
<span class="lineNum">    7108 </span><span class="lineCov">         11 :                 if (sound_duration &lt; vmu-&gt;minsecs)</span>
<span class="lineNum">    7109 </span>            :                         /* XXX We should really give a prompt too short/option start again, with leave_vm_out called only after a timeout XXX */
<span class="lineNum">    7110 </span><span class="lineNoCov">          0 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">    7111 </span>            :                 else
<span class="lineNum">    7112 </span><span class="lineCov">         11 :                         pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;SUCCESS&quot;);</span>
<span class="lineNum">    7113 </span>            :         } else
<span class="lineNum">    7114 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No format for saving voicemail?\n&quot;);</span>
<span class="lineNum">    7115 </span><span class="lineCov">         11 : leave_vm_out:</span>
<span class="lineNum">    7116 </span><span class="lineCov">         11 :         free_user(vmu);</span>
<span class="lineNum">    7117 </span>            : 
<span class="lineNum">    7118 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7119 </span>            :         /* expunge message - use UID Expunge if supported on IMAP server*/
<span class="lineNum">    7120 </span>            :         ast_debug(3, &quot;*** Checking if we can expunge, expungeonhangup set to %d\n&quot;, expungeonhangup);
<span class="lineNum">    7121 </span>            :         if (expungeonhangup == 1) {
<span class="lineNum">    7122 </span>            :                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    7123 </span>            : #ifdef HAVE_IMAP_TK2006
<span class="lineNum">    7124 </span>            :                 if (LEVELUIDPLUS (vms-&gt;mailstream)) {
<span class="lineNum">    7125 </span>            :                         mail_expunge_full(vms-&gt;mailstream, NIL, EX_UID);
<span class="lineNum">    7126 </span>            :                 } else
<span class="lineNum">    7127 </span>            : #endif
<span class="lineNum">    7128 </span>            :                         mail_expunge(vms-&gt;mailstream);
<span class="lineNum">    7129 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    7130 </span>            :         }
<span class="lineNum">    7131 </span>            : #endif
<span class="lineNum">    7132 </span>            : 
<span class="lineNum">    7133 </span><span class="lineCov">         11 :         ast_free(tmp);</span>
<span class="lineNum">    7134 </span><span class="lineCov">         11 :         return res;</span>
<span class="lineNum">    7135 </span>            : }
<a name="7136"><span class="lineNum">    7136 </span>            : </a>
<span class="lineNum">    7137 </span>            : #if !defined(IMAP_STORAGE)
<span class="lineNum">    7138 </span><span class="lineCov">          3 : static int resequence_mailbox(struct ast_vm_user *vmu, char *dir, int stopcount)</span>
<span class="lineNum">    7139 </span>            : {
<span class="lineNum">    7140 </span>            :         /* we know the actual number of messages, so stop process when number is hit */
<span class="lineNum">    7141 </span>            : 
<span class="lineNum">    7142 </span>            :         int x, dest;
<span class="lineNum">    7143 </span>            :         char sfn[PATH_MAX];
<span class="lineNum">    7144 </span>            :         char dfn[PATH_MAX];
<span class="lineNum">    7145 </span>            : 
<span class="lineNum">    7146 </span><span class="lineCov">          3 :         if (vm_lock_path(dir)) {</span>
<span class="lineNum">    7147 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    7148 </span>            :         }
<span class="lineNum">    7149 </span>            : 
<span class="lineNum">    7150 </span><span class="lineCov">         11 :         for (x = 0, dest = 0; dest != stopcount &amp;&amp; x &lt; vmu-&gt;maxmsg + 10; x++) {</span>
<span class="lineNum">    7151 </span><span class="lineCov">          8 :                 make_file(sfn, sizeof(sfn), dir, x);</span>
<span class="lineNum">    7152 </span><span class="lineCov">          8 :                 if (EXISTS(dir, x, sfn, NULL)) {</span>
<span class="lineNum">    7153 </span>            : 
<span class="lineNum">    7154 </span><span class="lineCov">          4 :                         if (x != dest) {</span>
<span class="lineNum">    7155 </span><span class="lineCov">          4 :                                 make_file(dfn, sizeof(dfn), dir, dest);</span>
<span class="lineNum">    7156 </span><span class="lineCov">          4 :                                 RENAME(dir, x, vmu-&gt;mailbox, vmu-&gt;context, dir, dest, sfn, dfn);</span>
<span class="lineNum">    7157 </span>            :                         }
<span class="lineNum">    7158 </span>            : 
<span class="lineNum">    7159 </span><span class="lineCov">          4 :                         dest++;</span>
<span class="lineNum">    7160 </span>            :                 }
<span class="lineNum">    7161 </span>            :         }
<span class="lineNum">    7162 </span><span class="lineCov">          3 :         ast_unlock_path(dir);</span>
<span class="lineNum">    7163 </span>            : 
<span class="lineNum">    7164 </span><span class="lineCov">          3 :         return dest;</span>
<span class="lineNum">    7165 </span>            : }
<a name="7166"><span class="lineNum">    7166 </span>            : #endif</a>
<span class="lineNum">    7167 </span>            : 
<span class="lineNum">    7168 </span><span class="lineCov">         15 : static int say_and_wait(struct ast_channel *chan, int num, const char *language)</span>
<span class="lineNum">    7169 </span>            : {
<span class="lineNum">    7170 </span>            :         int d;
<span class="lineNum">    7171 </span><span class="lineCov">         15 :         d = ast_say_number(chan, num, AST_DIGIT_ANY, language, NULL);</span>
<span class="lineNum">    7172 </span><span class="lineCov">         15 :         return d;</span>
<a name="7173"><span class="lineNum">    7173 </span>            : }</a>
<span class="lineNum">    7174 </span>            : 
<span class="lineNum">    7175 </span><span class="lineCov">         19 : static int save_to_folder(struct ast_vm_user *vmu, struct vm_state *vms, int msg, int box, int *newmsg, int move)</span>
<span class="lineNum">    7176 </span>            : {
<span class="lineNum">    7177 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7178 </span>            :         /* we must use mbox(x) folder names, and copy the message there */
<span class="lineNum">    7179 </span>            :         /* simple. huh? */
<span class="lineNum">    7180 </span>            :         char sequence[10];
<span class="lineNum">    7181 </span>            :         char mailbox[256];
<span class="lineNum">    7182 </span>            :         int res;
<span class="lineNum">    7183 </span>            :         int curr_mbox;
<span class="lineNum">    7184 </span>            : 
<span class="lineNum">    7185 </span>            :         /* get the real IMAP message number for this message */
<span class="lineNum">    7186 </span>            :         snprintf(sequence, sizeof(sequence), &quot;%ld&quot;, vms-&gt;msgArray[msg]);
<span class="lineNum">    7187 </span>            : 
<span class="lineNum">    7188 </span>            :         ast_debug(3, &quot;Copying sequence %s to mailbox %s\n&quot;, sequence, mbox(vmu, box));
<span class="lineNum">    7189 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    7190 </span>            :         /* if save to Old folder, put in INBOX as read */
<span class="lineNum">    7191 </span>            :         if (box == OLD_FOLDER) {
<span class="lineNum">    7192 </span>            :                 mail_setflag(vms-&gt;mailstream, sequence, &quot;\\Seen&quot;);
<span class="lineNum">    7193 </span>            :         } else if (box == NEW_FOLDER) {
<span class="lineNum">    7194 </span>            :                 mail_clearflag(vms-&gt;mailstream, sequence, &quot;\\Seen&quot;);
<span class="lineNum">    7195 </span>            :         }
<span class="lineNum">    7196 </span>            :         if (!strcasecmp(mbox(vmu, NEW_FOLDER), vms-&gt;curbox) &amp;&amp; (box == NEW_FOLDER || box == OLD_FOLDER)) {
<span class="lineNum">    7197 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    7198 </span>            :                 return 0;
<span class="lineNum">    7199 </span>            :         }
<span class="lineNum">    7200 </span>            : 
<span class="lineNum">    7201 </span>            :         /* get the current mailbox so that we can point the mailstream back to it later */
<span class="lineNum">    7202 </span>            :         curr_mbox = get_folder_by_name(vms-&gt;curbox);
<span class="lineNum">    7203 </span>            : 
<span class="lineNum">    7204 </span>            :         /* Create the folder if it dosn't exist */
<span class="lineNum">    7205 </span>            :         imap_mailbox_name(mailbox, sizeof(mailbox), vms, box, 1); /* Get the full mailbox name */
<span class="lineNum">    7206 </span>            :         if (vms-&gt;mailstream &amp;&amp; !mail_status(vms-&gt;mailstream, mailbox, SA_UIDNEXT)) {
<span class="lineNum">    7207 </span>            :                 if (mail_create(vms-&gt;mailstream, mailbox) != NIL) {
<span class="lineNum">    7208 </span>            :                         ast_log(AST_LOG_NOTICE, &quot;Folder %s created!\n&quot;, mbox(vmu, box));
<span class="lineNum">    7209 </span>            :                 }
<span class="lineNum">    7210 </span>            :         }
<span class="lineNum">    7211 </span>            : 
<span class="lineNum">    7212 </span>            :         /* restore previous mbox stream */
<span class="lineNum">    7213 </span>            :         if (init_mailstream(vms, curr_mbox) || !vms-&gt;mailstream) {
<span class="lineNum">    7214 </span>            :                 ast_log(AST_LOG_ERROR, &quot;IMAP mailstream is NULL or can't init_mailstream\n&quot;);
<span class="lineNum">    7215 </span>            :                 res = -1;
<span class="lineNum">    7216 </span>            :         } else {
<span class="lineNum">    7217 </span>            :                 if (move) {
<span class="lineNum">    7218 </span>            :                         res = !mail_move(vms-&gt;mailstream, sequence, (char *) mbox(vmu, box));
<span class="lineNum">    7219 </span>            :                 } else {
<span class="lineNum">    7220 </span>            :                         res = !mail_copy(vms-&gt;mailstream, sequence, (char *) mbox(vmu, box));
<span class="lineNum">    7221 </span>            :                 }
<span class="lineNum">    7222 </span>            :         }
<span class="lineNum">    7223 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    7224 </span>            :         return res;
<span class="lineNum">    7225 </span>            : #else
<span class="lineNum">    7226 </span><span class="lineCov">         19 :         char *dir = vms-&gt;curdir;</span>
<span class="lineNum">    7227 </span><span class="lineCov">         19 :         char *username = vms-&gt;username;</span>
<span class="lineNum">    7228 </span><span class="lineCov">         19 :         char *context = vmu-&gt;context;</span>
<span class="lineNum">    7229 </span>            :         char sfn[PATH_MAX];
<span class="lineNum">    7230 </span>            :         char dfn[PATH_MAX];
<span class="lineNum">    7231 </span>            :         char ddir[PATH_MAX];
<span class="lineNum">    7232 </span><span class="lineCov">         19 :         const char *dbox = mbox(vmu, box);</span>
<span class="lineNum">    7233 </span>            :         int x, i;
<span class="lineNum">    7234 </span><span class="lineCov">         19 :         create_dirpath(ddir, sizeof(ddir), context, username, dbox);</span>
<span class="lineNum">    7235 </span>            : 
<span class="lineNum">    7236 </span><span class="lineCov">         19 :         if (vm_lock_path(ddir))</span>
<span class="lineNum">    7237 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    7238 </span>            : 
<span class="lineNum">    7239 </span><span class="lineCov">         19 :         x = last_message_index(vmu, ddir) + 1;</span>
<span class="lineNum">    7240 </span>            : 
<span class="lineNum">    7241 </span><span class="lineCov">         19 :         if (box == 10 &amp;&amp; x &gt;= vmu-&gt;maxdeletedmsg) { /* &quot;Deleted&quot; folder*/</span>
<span class="lineNum">    7242 </span><span class="lineNoCov">          0 :                 x--;</span>
<span class="lineNum">    7243 </span><span class="lineNoCov">          0 :                 for (i = 1; i &lt;= x; i++) {</span>
<span class="lineNum">    7244 </span>            :                         /* Push files down a &quot;slot&quot;.  The oldest file (msg0000) will be deleted. */
<span class="lineNum">    7245 </span><span class="lineNoCov">          0 :                         make_file(sfn, sizeof(sfn), ddir, i);</span>
<span class="lineNum">    7246 </span><span class="lineNoCov">          0 :                         make_file(dfn, sizeof(dfn), ddir, i - 1);</span>
<span class="lineNum">    7247 </span><span class="lineNoCov">          0 :                         if (EXISTS(ddir, i, sfn, NULL)) {</span>
<span class="lineNum">    7248 </span><span class="lineNoCov">          0 :                                 RENAME(ddir, i, vmu-&gt;mailbox, vmu-&gt;context, ddir, i - 1, sfn, dfn);</span>
<span class="lineNum">    7249 </span>            :                         } else
<span class="lineNum">    7250 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    7251 </span>            :                 }
<span class="lineNum">    7252 </span>            :         } else {
<span class="lineNum">    7253 </span><span class="lineCov">         19 :                 if (x &gt;= vmu-&gt;maxmsg) {</span>
<span class="lineNum">    7254 </span><span class="lineNoCov">          0 :                         ast_unlock_path(ddir);</span>
<span class="lineNum">    7255 </span><span class="lineNoCov">          0 :                         return ERROR_MAX_MSGS;</span>
<span class="lineNum">    7256 </span>            :                 }
<span class="lineNum">    7257 </span>            :         }
<span class="lineNum">    7258 </span><span class="lineCov">         19 :         make_file(sfn, sizeof(sfn), dir, msg);</span>
<span class="lineNum">    7259 </span><span class="lineCov">         19 :         make_file(dfn, sizeof(dfn), ddir, x);</span>
<span class="lineNum">    7260 </span><span class="lineCov">         19 :         if (strcmp(sfn, dfn)) {</span>
<span class="lineNum">    7261 </span><span class="lineCov">         19 :                 COPY(dir, msg, ddir, x, username, context, sfn, dfn);</span>
<span class="lineNum">    7262 </span>            :         }
<span class="lineNum">    7263 </span><span class="lineCov">         19 :         ast_unlock_path(ddir);</span>
<span class="lineNum">    7264 </span>            : 
<span class="lineNum">    7265 </span><span class="lineCov">         19 :         if (newmsg) {</span>
<span class="lineNum">    7266 </span><span class="lineNoCov">          0 :                 *newmsg = x;</span>
<span class="lineNum">    7267 </span>            :         }
<span class="lineNum">    7268 </span><span class="lineCov">         19 :         return 0;</span>
<span class="lineNum">    7269 </span>            : #endif
<a name="7270"><span class="lineNum">    7270 </span>            : }</a>
<span class="lineNum">    7271 </span>            : 
<span class="lineNum">    7272 </span><span class="lineNoCov">          0 : static int adsi_logo(unsigned char *buf)</span>
<span class="lineNum">    7273 </span>            : {
<span class="lineNum">    7274 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7275 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 1, ADSI_JUST_CENT, 0, &quot;Comedian Mail&quot;, &quot;&quot;);</span>
<span class="lineNum">    7276 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 2, ADSI_JUST_CENT, 0, &quot;(C)2002-2006 Digium, Inc.&quot;, &quot;&quot;);</span>
<span class="lineNum">    7277 </span><span class="lineNoCov">          0 :         return bytes;</span>
<a name="7278"><span class="lineNum">    7278 </span>            : }</a>
<span class="lineNum">    7279 </span>            : 
<span class="lineNum">    7280 </span><span class="lineNoCov">          0 : static int adsi_load_vmail(struct ast_channel *chan, int *useadsi)</span>
<span class="lineNum">    7281 </span>            : {
<span class="lineNum">    7282 </span>            :         unsigned char buf[256];
<span class="lineNum">    7283 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7284 </span>            :         int x;
<span class="lineNum">    7285 </span>            :         char num[5];
<span class="lineNum">    7286 </span>            : 
<span class="lineNum">    7287 </span><span class="lineNoCov">          0 :         *useadsi = 0;</span>
<span class="lineNum">    7288 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_data_mode(buf + bytes);</span>
<span class="lineNum">    7289 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7290 </span>            : 
<span class="lineNum">    7291 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7292 </span><span class="lineNoCov">          0 :         bytes += adsi_logo(buf);</span>
<span class="lineNum">    7293 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Downloading Scripts&quot;, &quot;&quot;);</span>
<span class="lineNum">    7294 </span>            : #ifdef DISPLAY
<span class="lineNum">    7295 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, &quot;   .&quot;, &quot;&quot;);
<span class="lineNum">    7296 </span>            : #endif
<span class="lineNum">    7297 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7298 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_data_mode(buf + bytes);</span>
<span class="lineNum">    7299 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7300 </span>            : 
<span class="lineNum">    7301 </span><span class="lineNoCov">          0 :         if (ast_adsi_begin_download(chan, addesc, adsifdn, adsisec, adsiver)) {</span>
<span class="lineNum">    7302 </span><span class="lineNoCov">          0 :                 bytes = 0;</span>
<span class="lineNum">    7303 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Load Cancelled.&quot;, &quot;&quot;);</span>
<span class="lineNum">    7304 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;ADSI Unavailable&quot;, &quot;&quot;);</span>
<span class="lineNum">    7305 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7306 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7307 </span><span class="lineNoCov">          0 :                 ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7308 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    7309 </span>            :         }
<span class="lineNum">    7310 </span>            : 
<span class="lineNum">    7311 </span>            : #ifdef DISPLAY
<span class="lineNum">    7312 </span>            :         /* Add a dot */
<span class="lineNum">    7313 </span>            :         bytes = 0;
<span class="lineNum">    7314 </span>            :         bytes += ast_adsi_logo(buf);
<span class="lineNum">    7315 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Downloading Scripts&quot;, &quot;&quot;);
<span class="lineNum">    7316 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, &quot;   ..&quot;, &quot;&quot;);
<span class="lineNum">    7317 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7318 </span>            :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);
<span class="lineNum">    7319 </span>            : #endif
<span class="lineNum">    7320 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7321 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 0, &quot;Listen&quot;, &quot;Listen&quot;, &quot;1&quot;, 1);</span>
<span class="lineNum">    7322 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 1, &quot;Folder&quot;, &quot;Folder&quot;, &quot;2&quot;, 1);</span>
<span class="lineNum">    7323 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 2, &quot;Advanced&quot;, &quot;Advnced&quot;, &quot;3&quot;, 1);</span>
<span class="lineNum">    7324 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 3, &quot;Options&quot;, &quot;Options&quot;, &quot;0&quot;, 1);</span>
<span class="lineNum">    7325 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 4, &quot;Help&quot;, &quot;Help&quot;, &quot;*&quot;, 1);</span>
<span class="lineNum">    7326 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 5, &quot;Exit&quot;, &quot;Exit&quot;, &quot;#&quot;, 1);</span>
<span class="lineNum">    7327 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DOWNLOAD);</span>
<span class="lineNum">    7328 </span>            : 
<span class="lineNum">    7329 </span>            : #ifdef DISPLAY
<span class="lineNum">    7330 </span>            :         /* Add another dot */
<span class="lineNum">    7331 </span>            :         bytes = 0;
<span class="lineNum">    7332 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, &quot;   ...&quot;, &quot;&quot;);
<span class="lineNum">    7333 </span>            :         bytes += ast_adsi_voice_mode(buf + bytes, 0);
<span class="lineNum">    7334 </span>            : 
<span class="lineNum">    7335 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7336 </span>            :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);
<span class="lineNum">    7337 </span>            : #endif
<span class="lineNum">    7338 </span>            : 
<span class="lineNum">    7339 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7340 </span>            :         /* These buttons we load but don't use yet */
<span class="lineNum">    7341 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 6, &quot;Previous&quot;, &quot;Prev&quot;, &quot;4&quot;, 1);</span>
<span class="lineNum">    7342 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 8, &quot;Repeat&quot;, &quot;Repeat&quot;, &quot;5&quot;, 1);</span>
<span class="lineNum">    7343 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 7, &quot;Delete&quot;, &quot;Delete&quot;, &quot;7&quot;, 1);</span>
<span class="lineNum">    7344 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 9, &quot;Next&quot;, &quot;Next&quot;, &quot;6&quot;, 1);</span>
<span class="lineNum">    7345 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 10, &quot;Save&quot;, &quot;Save&quot;, &quot;9&quot;, 1);</span>
<span class="lineNum">    7346 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 11, &quot;Undelete&quot;, &quot;Restore&quot;, &quot;7&quot;, 1);</span>
<span class="lineNum">    7347 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DOWNLOAD);</span>
<span class="lineNum">    7348 </span>            : 
<span class="lineNum">    7349 </span>            : #ifdef DISPLAY
<span class="lineNum">    7350 </span>            :         /* Add another dot */
<span class="lineNum">    7351 </span>            :         bytes = 0;
<span class="lineNum">    7352 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, &quot;   ....&quot;, &quot;&quot;);
<span class="lineNum">    7353 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7354 </span>            :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);
<span class="lineNum">    7355 </span>            : #endif
<span class="lineNum">    7356 </span>            : 
<span class="lineNum">    7357 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7358 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 5; x++) {</span>
<span class="lineNum">    7359 </span><span class="lineNoCov">          0 :                 snprintf(num, sizeof(num), &quot;%d&quot;, x);</span>
<span class="lineNum">    7360 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 12 + x, mbox(NULL, x), mbox(NULL, x), num, 1);</span>
<span class="lineNum">    7361 </span>            :         }
<span class="lineNum">    7362 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 12 + 5, &quot;Cancel&quot;, &quot;Cancel&quot;, &quot;#&quot;, 1);</span>
<span class="lineNum">    7363 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DOWNLOAD);</span>
<span class="lineNum">    7364 </span>            : 
<span class="lineNum">    7365 </span>            : #ifdef DISPLAY
<span class="lineNum">    7366 </span>            :         /* Add another dot */
<span class="lineNum">    7367 </span>            :         bytes = 0;
<span class="lineNum">    7368 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, &quot;   .....&quot;, &quot;&quot;);
<span class="lineNum">    7369 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7370 </span>            :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);
<span class="lineNum">    7371 </span>            : #endif
<span class="lineNum">    7372 </span>            : 
<span class="lineNum">    7373 </span><span class="lineNoCov">          0 :         if (ast_adsi_end_download(chan)) {</span>
<span class="lineNum">    7374 </span><span class="lineNoCov">          0 :                 bytes = 0;</span>
<span class="lineNum">    7375 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Download Unsuccessful.&quot;, &quot;&quot;);</span>
<span class="lineNum">    7376 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;ADSI Unavailable&quot;, &quot;&quot;);</span>
<span class="lineNum">    7377 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7378 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7379 </span><span class="lineNoCov">          0 :                 ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7380 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    7381 </span>            :         }
<span class="lineNum">    7382 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7383 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_download_disconnect(buf + bytes);</span>
<span class="lineNum">    7384 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7385 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DOWNLOAD);</span>
<span class="lineNum">    7386 </span>            : 
<span class="lineNum">    7387 </span><span class="lineNoCov">          0 :         ast_debug(1, &quot;Done downloading scripts...\n&quot;);</span>
<span class="lineNum">    7388 </span>            : 
<span class="lineNum">    7389 </span>            : #ifdef DISPLAY
<span class="lineNum">    7390 </span>            :         /* Add last dot */
<span class="lineNum">    7391 </span>            :         bytes = 0;
<span class="lineNum">    7392 </span>            :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;   ......&quot;, &quot;&quot;);
<span class="lineNum">    7393 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7394 </span>            : #endif
<span class="lineNum">    7395 </span><span class="lineNoCov">          0 :         ast_debug(1, &quot;Restarting session...\n&quot;);</span>
<span class="lineNum">    7396 </span>            : 
<span class="lineNum">    7397 </span><span class="lineNoCov">          0 :         bytes = 0;</span>
<span class="lineNum">    7398 </span>            :         /* Load the session now */
<span class="lineNum">    7399 </span><span class="lineNoCov">          0 :         if (ast_adsi_load_session(chan, adsifdn, adsiver, 1) == 1) {</span>
<span class="lineNum">    7400 </span><span class="lineNoCov">          0 :                 *useadsi = 1;</span>
<span class="lineNum">    7401 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Scripts Loaded!&quot;, &quot;&quot;);</span>
<span class="lineNum">    7402 </span>            :         } else
<span class="lineNum">    7403 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Load Failed!&quot;, &quot;&quot;);</span>
<span class="lineNum">    7404 </span>            : 
<span class="lineNum">    7405 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7406 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="7407"><span class="lineNum">    7407 </span>            : }</a>
<span class="lineNum">    7408 </span>            : 
<span class="lineNum">    7409 </span><span class="lineCov">         48 : static void adsi_begin(struct ast_channel *chan, int *useadsi)</span>
<span class="lineNum">    7410 </span>            : {
<span class="lineNum">    7411 </span>            :         int x;
<span class="lineNum">    7412 </span><span class="lineCov">         48 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7413 </span><span class="lineCov">         48 :                 return;</span>
<span class="lineNum">    7414 </span><span class="lineNoCov">          0 :         x = ast_adsi_load_session(chan, adsifdn, adsiver, 1);</span>
<span class="lineNum">    7415 </span><span class="lineNoCov">          0 :         if (x &lt; 0)</span>
<span class="lineNum">    7416 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7417 </span><span class="lineNoCov">          0 :         if (!x) {</span>
<span class="lineNum">    7418 </span><span class="lineNoCov">          0 :                 if (adsi_load_vmail(chan, useadsi)) {</span>
<span class="lineNum">    7419 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Unable to upload voicemail scripts\n&quot;);</span>
<span class="lineNum">    7420 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    7421 </span>            :                 }
<span class="lineNum">    7422 </span>            :         } else
<span class="lineNum">    7423 </span><span class="lineNoCov">          0 :                 *useadsi = 1;</span>
<a name="7424"><span class="lineNum">    7424 </span>            : }</a>
<span class="lineNum">    7425 </span>            : 
<span class="lineNum">    7426 </span><span class="lineNoCov">          0 : static void adsi_login(struct ast_channel *chan)</span>
<span class="lineNum">    7427 </span>            : {
<span class="lineNum">    7428 </span>            :         unsigned char buf[256];
<span class="lineNum">    7429 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7430 </span>            :         unsigned char keys[8];
<span class="lineNum">    7431 </span>            :         int x;
<span class="lineNum">    7432 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7433 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7434 </span>            : 
<span class="lineNum">    7435 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 8; x++)</span>
<span class="lineNum">    7436 </span><span class="lineNoCov">          0 :                 keys[x] = 0;</span>
<span class="lineNum">    7437 </span>            :         /* Set one key for next */
<span class="lineNum">    7438 </span><span class="lineNoCov">          0 :         keys[3] = ADSI_KEY_APPS + 3;</span>
<span class="lineNum">    7439 </span>            : 
<span class="lineNum">    7440 </span><span class="lineNoCov">          0 :         bytes += adsi_logo(buf + bytes);</span>
<span class="lineNum">    7441 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot; &quot;, &quot;&quot;);</span>
<span class="lineNum">    7442 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot; &quot;, &quot;&quot;);</span>
<span class="lineNum">    7443 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7444 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_input_format(buf + bytes, 1, ADSI_DIR_FROM_LEFT, 0, &quot;Mailbox: ******&quot;, &quot;&quot;);</span>
<span class="lineNum">    7445 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_input_control(buf + bytes, ADSI_COMM_PAGE, 4, 1, 1, ADSI_JUST_LEFT);</span>
<span class="lineNum">    7446 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_load_soft_key(buf + bytes, ADSI_KEY_APPS + 3, &quot;Enter&quot;, &quot;Enter&quot;, &quot;#&quot;, 1);</span>
<span class="lineNum">    7447 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7448 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7449 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7450"><span class="lineNum">    7450 </span>            : }</a>
<span class="lineNum">    7451 </span>            : 
<span class="lineNum">    7452 </span><span class="lineNoCov">          0 : static void adsi_password(struct ast_channel *chan)</span>
<span class="lineNum">    7453 </span>            : {
<span class="lineNum">    7454 </span>            :         unsigned char buf[256];
<span class="lineNum">    7455 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7456 </span>            :         unsigned char keys[8];
<span class="lineNum">    7457 </span>            :         int x;
<span class="lineNum">    7458 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7459 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7460 </span>            : 
<span class="lineNum">    7461 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 8; x++)</span>
<span class="lineNum">    7462 </span><span class="lineNoCov">          0 :                 keys[x] = 0;</span>
<span class="lineNum">    7463 </span>            :         /* Set one key for next */
<span class="lineNum">    7464 </span><span class="lineNoCov">          0 :         keys[3] = ADSI_KEY_APPS + 3;</span>
<span class="lineNum">    7465 </span>            : 
<span class="lineNum">    7466 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7467 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_input_format(buf + bytes, 1, ADSI_DIR_FROM_LEFT, 0, &quot;Password: ******&quot;, &quot;&quot;);</span>
<span class="lineNum">    7468 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_input_control(buf + bytes, ADSI_COMM_PAGE, 4, 0, 1, ADSI_JUST_LEFT);</span>
<span class="lineNum">    7469 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7470 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7471 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7472"><span class="lineNum">    7472 </span>            : }</a>
<span class="lineNum">    7473 </span>            : 
<span class="lineNum">    7474 </span><span class="lineNoCov">          0 : static void adsi_folders(struct ast_channel *chan, int start, char *label)</span>
<span class="lineNum">    7475 </span>            : {
<span class="lineNum">    7476 </span>            :         unsigned char buf[256];
<span class="lineNum">    7477 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7478 </span>            :         unsigned char keys[8];
<span class="lineNum">    7479 </span>            :         int x, y;
<span class="lineNum">    7480 </span>            : 
<span class="lineNum">    7481 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7482 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7483 </span>            : 
<span class="lineNum">    7484 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 5; x++) {</span>
<span class="lineNum">    7485 </span><span class="lineNoCov">          0 :                 y = ADSI_KEY_APPS + 12 + start + x;</span>
<span class="lineNum">    7486 </span><span class="lineNoCov">          0 :                 if (y &gt; ADSI_KEY_APPS + 12 + 4)</span>
<span class="lineNum">    7487 </span><span class="lineNoCov">          0 :                         y = 0;</span>
<span class="lineNum">    7488 </span><span class="lineNoCov">          0 :                 keys[x] = ADSI_KEY_SKT | y;</span>
<span class="lineNum">    7489 </span>            :         }
<span class="lineNum">    7490 </span><span class="lineNoCov">          0 :         keys[5] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 17);</span>
<span class="lineNum">    7491 </span><span class="lineNoCov">          0 :         keys[6] = 0;</span>
<span class="lineNum">    7492 </span><span class="lineNoCov">          0 :         keys[7] = 0;</span>
<span class="lineNum">    7493 </span>            : 
<span class="lineNum">    7494 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 1, ADSI_JUST_CENT, 0, label, &quot;&quot;);</span>
<span class="lineNum">    7495 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 2, ADSI_JUST_CENT, 0, &quot; &quot;, &quot;&quot;);</span>
<span class="lineNum">    7496 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7497 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7498 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7499 </span>            : 
<span class="lineNum">    7500 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7501"><span class="lineNum">    7501 </span>            : }</a>
<span class="lineNum">    7502 </span>            : 
<span class="lineNum">    7503 </span><span class="lineCov">         12 : static void adsi_message(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    7504 </span>            : {
<span class="lineNum">    7505 </span><span class="lineCov">         12 :         int bytes = 0;</span>
<span class="lineNum">    7506 </span>            :         unsigned char buf[256];
<span class="lineNum">    7507 </span>            :         char buf1[256], buf2[256];
<span class="lineNum">    7508 </span>            :         char fn2[PATH_MAX];
<span class="lineNum">    7509 </span>            : 
<span class="lineNum">    7510 </span><span class="lineCov">         12 :         char cid[256] = &quot;&quot;;</span>
<span class="lineNum">    7511 </span>            :         char *val;
<span class="lineNum">    7512 </span>            :         char *name, *num;
<span class="lineNum">    7513 </span><span class="lineCov">         12 :         char datetime[21] = &quot;&quot;;</span>
<span class="lineNum">    7514 </span>            :         FILE *f;
<span class="lineNum">    7515 </span>            : 
<span class="lineNum">    7516 </span>            :         unsigned char keys[8];
<span class="lineNum">    7517 </span>            : 
<span class="lineNum">    7518 </span>            :         int x;
<span class="lineNum">    7519 </span>            : 
<span class="lineNum">    7520 </span><span class="lineCov">         12 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7521 </span><span class="lineCov">         12 :                 return;</span>
<span class="lineNum">    7522 </span>            : 
<span class="lineNum">    7523 </span>            :         /* Retrieve important info */
<span class="lineNum">    7524 </span><span class="lineNoCov">          0 :         snprintf(fn2, sizeof(fn2), &quot;%s.txt&quot;, vms-&gt;fn);</span>
<span class="lineNum">    7525 </span><span class="lineNoCov">          0 :         f = fopen(fn2, &quot;r&quot;);</span>
<span class="lineNum">    7526 </span><span class="lineNoCov">          0 :         if (f) {</span>
<span class="lineNum">    7527 </span><span class="lineNoCov">          0 :                 while (!feof(f)) {</span>
<span class="lineNum">    7528 </span><span class="lineNoCov">          0 :                         if (!fgets((char *) buf, sizeof(buf), f)) {</span>
<span class="lineNum">    7529 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    7530 </span>            :                         }
<span class="lineNum">    7531 </span><span class="lineNoCov">          0 :                         if (!feof(f)) {</span>
<span class="lineNum">    7532 </span><span class="lineNoCov">          0 :                                 char *stringp = NULL;</span>
<span class="lineNum">    7533 </span><span class="lineNoCov">          0 :                                 stringp = (char *) buf;</span>
<span class="lineNum">    7534 </span><span class="lineNoCov">          0 :                                 strsep(&amp;stringp, &quot;=&quot;);</span>
<span class="lineNum">    7535 </span><span class="lineNoCov">          0 :                                 val = strsep(&amp;stringp, &quot;=&quot;);</span>
<span class="lineNum">    7536 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(val)) {</span>
<span class="lineNum">    7537 </span><span class="lineNoCov">          0 :                                         if (!strcmp((char *) buf, &quot;callerid&quot;))</span>
<span class="lineNum">    7538 </span><span class="lineNoCov">          0 :                                                 ast_copy_string(cid, val, sizeof(cid));</span>
<span class="lineNum">    7539 </span><span class="lineNoCov">          0 :                                         if (!strcmp((char *) buf, &quot;origdate&quot;))</span>
<span class="lineNum">    7540 </span><span class="lineNoCov">          0 :                                                 ast_copy_string(datetime, val, sizeof(datetime));</span>
<span class="lineNum">    7541 </span>            :                                 }
<span class="lineNum">    7542 </span>            :                         }
<span class="lineNum">    7543 </span>            :                 }
<span class="lineNum">    7544 </span><span class="lineNoCov">          0 :                 fclose(f);</span>
<span class="lineNum">    7545 </span>            :         }
<span class="lineNum">    7546 </span>            :         /* New meaning for keys */
<span class="lineNum">    7547 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 5; x++)</span>
<span class="lineNum">    7548 </span><span class="lineNoCov">          0 :                 keys[x] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 6 + x);</span>
<span class="lineNum">    7549 </span><span class="lineNoCov">          0 :         keys[6] = 0x0;</span>
<span class="lineNum">    7550 </span><span class="lineNoCov">          0 :         keys[7] = 0x0;</span>
<span class="lineNum">    7551 </span>            : 
<span class="lineNum">    7552 </span><span class="lineNoCov">          0 :         if (!vms-&gt;curmsg) {</span>
<span class="lineNum">    7553 </span>            :                 /* No prev key, provide &quot;Folder&quot; instead */
<span class="lineNum">    7554 </span><span class="lineNoCov">          0 :                 keys[0] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 1);</span>
<span class="lineNum">    7555 </span>            :         }
<span class="lineNum">    7556 </span><span class="lineNoCov">          0 :         if (vms-&gt;curmsg &gt;= vms-&gt;lastmsg) {</span>
<span class="lineNum">    7557 </span>            :                 /* If last message ... */
<span class="lineNum">    7558 </span><span class="lineNoCov">          0 :                 if (vms-&gt;curmsg) {</span>
<span class="lineNum">    7559 </span>            :                         /* but not only message, provide &quot;Folder&quot; instead */
<span class="lineNum">    7560 </span><span class="lineNoCov">          0 :                         keys[3] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 1);</span>
<span class="lineNum">    7561 </span><span class="lineNoCov">          0 :                         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7562 </span>            : 
<span class="lineNum">    7563 </span>            :                 } else {
<span class="lineNum">    7564 </span>            :                         /* Otherwise if only message, leave blank */
<span class="lineNum">    7565 </span><span class="lineNoCov">          0 :                         keys[3] = 1;</span>
<span class="lineNum">    7566 </span>            :                 }
<span class="lineNum">    7567 </span>            :         }
<span class="lineNum">    7568 </span>            : 
<span class="lineNum">    7569 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(cid)) {</span>
<span class="lineNum">    7570 </span><span class="lineNoCov">          0 :                 ast_callerid_parse(cid, &amp;name, &amp;num);</span>
<span class="lineNum">    7571 </span><span class="lineNoCov">          0 :                 if (!name)</span>
<span class="lineNum">    7572 </span><span class="lineNoCov">          0 :                         name = num;</span>
<span class="lineNum">    7573 </span>            :         } else {
<span class="lineNum">    7574 </span><span class="lineNoCov">          0 :                 name = &quot;Unknown Caller&quot;;</span>
<span class="lineNum">    7575 </span>            :         }
<span class="lineNum">    7576 </span>            : 
<span class="lineNum">    7577 </span>            :         /* If deleted, show &quot;undeleted&quot; */
<span class="lineNum">    7578 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7579 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    7580 </span>            : #endif
<span class="lineNum">    7581 </span><span class="lineNoCov">          0 :         if (vms-&gt;deleted[vms-&gt;curmsg]) {</span>
<span class="lineNum">    7582 </span><span class="lineNoCov">          0 :                 keys[1] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 11);</span>
<span class="lineNum">    7583 </span>            :         }
<span class="lineNum">    7584 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7585 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    7586 </span>            : #endif
<span class="lineNum">    7587 </span>            : 
<span class="lineNum">    7588 </span>            :         /* Except &quot;Exit&quot; */
<span class="lineNum">    7589 </span><span class="lineNoCov">          0 :         keys[5] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 5);</span>
<span class="lineNum">    7590 </span><span class="lineNoCov">          0 :         snprintf(buf1, sizeof(buf1), &quot;%s%s&quot;, vms-&gt;curbox,</span>
<span class="lineNum">    7591 </span><span class="lineNoCov">          0 :                 strcasecmp(vms-&gt;curbox, &quot;INBOX&quot;) ? &quot; Messages&quot; : &quot;&quot;);</span>
<span class="lineNum">    7592 </span><span class="lineNoCov">          0 :         snprintf(buf2, sizeof(buf2), &quot;Message %d of %d&quot;, vms-&gt;curmsg + 1, vms-&gt;lastmsg + 1);</span>
<span class="lineNum">    7593 </span>            : 
<span class="lineNum">    7594 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 1, ADSI_JUST_LEFT, 0, buf1, &quot;&quot;);</span>
<span class="lineNum">    7595 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 2, ADSI_JUST_LEFT, 0, buf2, &quot;&quot;);</span>
<span class="lineNum">    7596 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_LEFT, 0, name, &quot;&quot;);</span>
<span class="lineNum">    7597 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_LEFT, 0, datetime, &quot;&quot;);</span>
<span class="lineNum">    7598 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7599 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7600 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7601 </span>            : 
<span class="lineNum">    7602 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7603"><span class="lineNum">    7603 </span>            : }</a>
<span class="lineNum">    7604 </span>            : 
<span class="lineNum">    7605 </span><span class="lineNoCov">          0 : static void adsi_delete(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    7606 </span>            : {
<span class="lineNum">    7607 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7608 </span>            :         unsigned char buf[256];
<span class="lineNum">    7609 </span>            :         unsigned char keys[8];
<span class="lineNum">    7610 </span>            : 
<span class="lineNum">    7611 </span>            :         int x;
<span class="lineNum">    7612 </span>            : 
<span class="lineNum">    7613 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7614 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7615 </span>            : 
<span class="lineNum">    7616 </span>            :         /* New meaning for keys */
<span class="lineNum">    7617 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 5; x++)</span>
<span class="lineNum">    7618 </span><span class="lineNoCov">          0 :                 keys[x] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 6 + x);</span>
<span class="lineNum">    7619 </span>            : 
<span class="lineNum">    7620 </span><span class="lineNoCov">          0 :         keys[6] = 0x0;</span>
<span class="lineNum">    7621 </span><span class="lineNoCov">          0 :         keys[7] = 0x0;</span>
<span class="lineNum">    7622 </span>            : 
<span class="lineNum">    7623 </span><span class="lineNoCov">          0 :         if (!vms-&gt;curmsg) {</span>
<span class="lineNum">    7624 </span>            :                 /* No prev key, provide &quot;Folder&quot; instead */
<span class="lineNum">    7625 </span><span class="lineNoCov">          0 :                 keys[0] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 1);</span>
<span class="lineNum">    7626 </span>            :         }
<span class="lineNum">    7627 </span><span class="lineNoCov">          0 :         if (vms-&gt;curmsg &gt;= vms-&gt;lastmsg) {</span>
<span class="lineNum">    7628 </span>            :                 /* If last message ... */
<span class="lineNum">    7629 </span><span class="lineNoCov">          0 :                 if (vms-&gt;curmsg) {</span>
<span class="lineNum">    7630 </span>            :                         /* but not only message, provide &quot;Folder&quot; instead */
<span class="lineNum">    7631 </span><span class="lineNoCov">          0 :                         keys[3] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 1);</span>
<span class="lineNum">    7632 </span>            :                 } else {
<span class="lineNum">    7633 </span>            :                         /* Otherwise if only message, leave blank */
<span class="lineNum">    7634 </span><span class="lineNoCov">          0 :                         keys[3] = 1;</span>
<span class="lineNum">    7635 </span>            :                 }
<span class="lineNum">    7636 </span>            :         }
<span class="lineNum">    7637 </span>            : 
<span class="lineNum">    7638 </span>            :         /* If deleted, show &quot;undeleted&quot; */
<span class="lineNum">    7639 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7640 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    7641 </span>            : #endif
<span class="lineNum">    7642 </span><span class="lineNoCov">          0 :         if (vms-&gt;deleted[vms-&gt;curmsg]) {</span>
<span class="lineNum">    7643 </span><span class="lineNoCov">          0 :                 keys[1] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 11);</span>
<span class="lineNum">    7644 </span>            :         }
<span class="lineNum">    7645 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7646 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    7647 </span>            : #endif
<span class="lineNum">    7648 </span>            : 
<span class="lineNum">    7649 </span>            :         /* Except &quot;Exit&quot; */
<span class="lineNum">    7650 </span><span class="lineNoCov">          0 :         keys[5] = ADSI_KEY_SKT | (ADSI_KEY_APPS + 5);</span>
<span class="lineNum">    7651 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7652 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7653 </span>            : 
<span class="lineNum">    7654 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7655"><span class="lineNum">    7655 </span>            : }</a>
<span class="lineNum">    7656 </span>            : 
<span class="lineNum">    7657 </span><span class="lineNoCov">          0 : static void adsi_status(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    7658 </span>            : {
<span class="lineNum">    7659 </span><span class="lineNoCov">          0 :         unsigned char buf[256] = &quot;&quot;;</span>
<span class="lineNum">    7660 </span><span class="lineNoCov">          0 :         char buf1[256] = &quot;&quot;, buf2[256] = &quot;&quot;;</span>
<span class="lineNum">    7661 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7662 </span>            :         unsigned char keys[8];
<span class="lineNum">    7663 </span>            :         int x;
<span class="lineNum">    7664 </span>            : 
<span class="lineNum">    7665 </span><span class="lineNoCov">          0 :         char *newm = (vms-&gt;newmessages == 1) ? &quot;message&quot; : &quot;messages&quot;;</span>
<span class="lineNum">    7666 </span><span class="lineNoCov">          0 :         char *oldm = (vms-&gt;oldmessages == 1) ? &quot;message&quot; : &quot;messages&quot;;</span>
<span class="lineNum">    7667 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7668 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7669 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    7670 </span><span class="lineNoCov">          0 :                 snprintf(buf1, sizeof(buf1), &quot;You have %d new&quot;, vms-&gt;newmessages);</span>
<span class="lineNum">    7671 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages) {</span>
<span class="lineNum">    7672 </span><span class="lineNoCov">          0 :                         strncat(buf1, &quot; and&quot;, sizeof(buf1) - strlen(buf1) - 1);</span>
<span class="lineNum">    7673 </span><span class="lineNoCov">          0 :                         snprintf(buf2, sizeof(buf2), &quot;%d old %s.&quot;, vms-&gt;oldmessages, oldm);</span>
<span class="lineNum">    7674 </span>            :                 } else {
<span class="lineNum">    7675 </span><span class="lineNoCov">          0 :                         snprintf(buf2, sizeof(buf2), &quot;%s.&quot;, newm);</span>
<span class="lineNum">    7676 </span>            :                 }
<span class="lineNum">    7677 </span><span class="lineNoCov">          0 :         } else if (vms-&gt;oldmessages) {</span>
<span class="lineNum">    7678 </span><span class="lineNoCov">          0 :                 snprintf(buf1, sizeof(buf1), &quot;You have %d old&quot;, vms-&gt;oldmessages);</span>
<span class="lineNum">    7679 </span><span class="lineNoCov">          0 :                 snprintf(buf2, sizeof(buf2), &quot;%s.&quot;, oldm);</span>
<span class="lineNum">    7680 </span>            :         } else {
<span class="lineNum">    7681 </span><span class="lineNoCov">          0 :                 strcpy(buf1, &quot;You have no messages.&quot;);</span>
<span class="lineNum">    7682 </span><span class="lineNoCov">          0 :                 buf2[0] = ' ';</span>
<span class="lineNum">    7683 </span><span class="lineNoCov">          0 :                 buf2[1] = '\0';</span>
<span class="lineNum">    7684 </span>            :         }
<span class="lineNum">    7685 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 1, ADSI_JUST_LEFT, 0, buf1, &quot;&quot;);</span>
<span class="lineNum">    7686 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 2, ADSI_JUST_LEFT, 0, buf2, &quot;&quot;);</span>
<span class="lineNum">    7687 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7688 </span>            : 
<span class="lineNum">    7689 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 6; x++)</span>
<span class="lineNum">    7690 </span><span class="lineNoCov">          0 :                 keys[x] = ADSI_KEY_SKT | (ADSI_KEY_APPS + x);</span>
<span class="lineNum">    7691 </span><span class="lineNoCov">          0 :         keys[6] = 0;</span>
<span class="lineNum">    7692 </span><span class="lineNoCov">          0 :         keys[7] = 0;</span>
<span class="lineNum">    7693 </span>            : 
<span class="lineNum">    7694 </span>            :         /* Don't let them listen if there are none */
<span class="lineNum">    7695 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &lt; 0)</span>
<span class="lineNum">    7696 </span><span class="lineNoCov">          0 :                 keys[0] = 1;</span>
<span class="lineNum">    7697 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7698 </span>            : 
<span class="lineNum">    7699 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7700 </span>            : 
<span class="lineNum">    7701 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="7702"><span class="lineNum">    7702 </span>            : }</a>
<span class="lineNum">    7703 </span>            : 
<span class="lineNum">    7704 </span><span class="lineNoCov">          0 : static void adsi_status2(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    7705 </span>            : {
<span class="lineNum">    7706 </span><span class="lineNoCov">          0 :         unsigned char buf[256] = &quot;&quot;;</span>
<span class="lineNum">    7707 </span><span class="lineNoCov">          0 :         char buf1[256] = &quot;&quot;, buf2[256] = &quot;&quot;;</span>
<span class="lineNum">    7708 </span><span class="lineNoCov">          0 :         int bytes = 0;</span>
<span class="lineNum">    7709 </span>            :         unsigned char keys[8];
<span class="lineNum">    7710 </span>            :         int x;
<span class="lineNum">    7711 </span>            : 
<span class="lineNum">    7712 </span><span class="lineNoCov">          0 :         char *mess = (vms-&gt;lastmsg == 0) ? &quot;message&quot; : &quot;messages&quot;;</span>
<span class="lineNum">    7713 </span>            : 
<span class="lineNum">    7714 </span><span class="lineNoCov">          0 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7715 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    7716 </span>            : 
<span class="lineNum">    7717 </span>            :         /* Original command keys */
<span class="lineNum">    7718 </span><span class="lineNoCov">          0 :         for (x = 0; x &lt; 6; x++)</span>
<span class="lineNum">    7719 </span><span class="lineNoCov">          0 :                 keys[x] = ADSI_KEY_SKT | (ADSI_KEY_APPS + x);</span>
<span class="lineNum">    7720 </span>            : 
<span class="lineNum">    7721 </span><span class="lineNoCov">          0 :         keys[6] = 0;</span>
<span class="lineNum">    7722 </span><span class="lineNoCov">          0 :         keys[7] = 0;</span>
<span class="lineNum">    7723 </span>            : 
<span class="lineNum">    7724 </span><span class="lineNoCov">          0 :         if ((vms-&gt;lastmsg + 1) &lt; 1)</span>
<span class="lineNum">    7725 </span><span class="lineNoCov">          0 :                 keys[0] = 0;</span>
<span class="lineNum">    7726 </span>            : 
<span class="lineNum">    7727 </span><span class="lineNoCov">          0 :         snprintf(buf1, sizeof(buf1), &quot;%s%s has&quot;, vms-&gt;curbox,</span>
<span class="lineNum">    7728 </span><span class="lineNoCov">          0 :                 strcasecmp(vms-&gt;curbox, &quot;INBOX&quot;) ? &quot; folder&quot; : &quot;&quot;);</span>
<span class="lineNum">    7729 </span>            : 
<span class="lineNum">    7730 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg + 1)</span>
<span class="lineNum">    7731 </span><span class="lineNoCov">          0 :                 snprintf(buf2, sizeof(buf2), &quot;%d %s.&quot;, vms-&gt;lastmsg + 1, mess);</span>
<span class="lineNum">    7732 </span>            :         else
<span class="lineNum">    7733 </span><span class="lineNoCov">          0 :                 strcpy(buf2, &quot;no messages.&quot;);</span>
<span class="lineNum">    7734 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 1, ADSI_JUST_LEFT, 0, buf1, &quot;&quot;);</span>
<span class="lineNum">    7735 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 2, ADSI_JUST_LEFT, 0, buf2, &quot;&quot;);</span>
<span class="lineNum">    7736 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_LEFT, 0, &quot;&quot;, &quot;&quot;);</span>
<span class="lineNum">    7737 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7738 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_keys(buf + bytes, keys);</span>
<span class="lineNum">    7739 </span>            : 
<span class="lineNum">    7740 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7741 </span>            : 
<span class="lineNum">    7742 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7743 </span>            : 
<span class="lineNum">    7744 </span>            : }
<span class="lineNum">    7745 </span>            : 
<span class="lineNum">    7746 </span>            : /*
<span class="lineNum">    7747 </span>            : static void adsi_clear(struct ast_channel *chan)
<span class="lineNum">    7748 </span>            : {
<span class="lineNum">    7749 </span>            :         char buf[256];
<span class="lineNum">    7750 </span>            :         int bytes=0;
<span class="lineNum">    7751 </span>            :         if (!ast_adsi_available(chan))
<span class="lineNum">    7752 </span>            :                 return;
<span class="lineNum">    7753 </span>            :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);
<span class="lineNum">    7754 </span>            :         bytes += ast_adsi_voice_mode(buf + bytes, 0);
<span class="lineNum">    7755 </span>            : 
<span class="lineNum">    7756 </span>            :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);
<span class="lineNum">    7757 </span>            : }
<a name="7758"><span class="lineNum">    7758 </span>            : */</a>
<span class="lineNum">    7759 </span>            : 
<span class="lineNum">    7760 </span><span class="lineCov">         15 : static void adsi_goodbye(struct ast_channel *chan)</span>
<span class="lineNum">    7761 </span>            : {
<span class="lineNum">    7762 </span>            :         unsigned char buf[256];
<span class="lineNum">    7763 </span><span class="lineCov">         15 :         int bytes = 0;</span>
<span class="lineNum">    7764 </span>            : 
<span class="lineNum">    7765 </span><span class="lineCov">         15 :         if (!ast_adsi_available(chan))</span>
<span class="lineNum">    7766 </span><span class="lineCov">         15 :                 return;</span>
<span class="lineNum">    7767 </span><span class="lineNoCov">          0 :         bytes += adsi_logo(buf + bytes);</span>
<span class="lineNum">    7768 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_LEFT, 0, &quot; &quot;, &quot;&quot;);</span>
<span class="lineNum">    7769 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;Goodbye&quot;, &quot;&quot;);</span>
<span class="lineNum">    7770 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">    7771 </span><span class="lineNoCov">          0 :         bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">    7772 </span>            : 
<span class="lineNum">    7773 </span><span class="lineNoCov">          0 :         ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">    7774 </span>            : }
<span class="lineNum">    7775 </span>            : 
<span class="lineNum">    7776 </span>            : /*!\brief get_folder: Folder menu
<span class="lineNum">    7777 </span>            :  *      Plays &quot;press 1 for INBOX messages&quot; etc.
<a name="7778"><span class="lineNum">    7778 </span>            :  *      Should possibly be internationalized</a>
<span class="lineNum">    7779 </span>            :  */
<span class="lineNum">    7780 </span><span class="lineNoCov">          0 : static int get_folder(struct ast_channel *chan, int start)</span>
<span class="lineNum">    7781 </span>            : {
<span class="lineNum">    7782 </span>            :         int x;
<span class="lineNum">    7783 </span>            :         int d;
<span class="lineNum">    7784 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    7785 </span><span class="lineNoCov">          0 :         d = ast_play_and_wait(chan, &quot;vm-press&quot;);      /* &quot;Press&quot; */</span>
<span class="lineNum">    7786 </span><span class="lineNoCov">          0 :         if (d)</span>
<span class="lineNum">    7787 </span><span class="lineNoCov">          0 :                 return d;</span>
<span class="lineNum">    7788 </span><span class="lineNoCov">          0 :         for (x = start; x &lt; 5; x++) {        /* For all folders */</span>
<span class="lineNum">    7789 </span><span class="lineNoCov">          0 :                 if ((d = ast_say_number(chan, x, AST_DIGIT_ANY, ast_channel_language(chan), NULL)))</span>
<span class="lineNum">    7790 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7791 </span><span class="lineNoCov">          0 :                 d = ast_play_and_wait(chan, &quot;vm-for&quot;);        /* &quot;for&quot; */</span>
<span class="lineNum">    7792 </span><span class="lineNoCov">          0 :                 if (d)</span>
<span class="lineNum">    7793 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7794 </span><span class="lineNoCov">          0 :                 snprintf(fn, sizeof(fn), &quot;vm-%s&quot;, mbox(NULL, x));     /* Folder name */</span>
<span class="lineNum">    7795 </span>            : 
<span class="lineNum">    7796 </span>            :                 /* The inbox folder can have its name changed under certain conditions
<span class="lineNum">    7797 </span>            :                  * so this checks if the sound file exists for the inbox folder name and
<span class="lineNum">    7798 </span>            :                  * if it doesn't, plays the default name instead. */
<span class="lineNum">    7799 </span><span class="lineNoCov">          0 :                 if (x == 0) {</span>
<span class="lineNum">    7800 </span><span class="lineNoCov">          0 :                         if (ast_fileexists(fn, NULL, NULL)) {</span>
<span class="lineNum">    7801 </span><span class="lineNoCov">          0 :                                 d = vm_play_folder_name(chan, fn);</span>
<span class="lineNum">    7802 </span>            :                         } else {
<span class="lineNum">    7803 </span><span class="lineNoCov">          0 :                                 ast_verb(4, &quot;Failed to find file %s; falling back to INBOX\n&quot;, fn);</span>
<span class="lineNum">    7804 </span><span class="lineNoCov">          0 :                                 d = vm_play_folder_name(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    7805 </span>            :                         }
<span class="lineNum">    7806 </span>            :                 } else {
<span class="lineNum">    7807 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;PLAYBACK&quot;, &quot;Message: folder name %s&quot;, fn);</span>
<span class="lineNum">    7808 </span><span class="lineNoCov">          0 :                         d = vm_play_folder_name(chan, fn);</span>
<span class="lineNum">    7809 </span>            :                 }
<span class="lineNum">    7810 </span>            : 
<span class="lineNum">    7811 </span><span class="lineNoCov">          0 :                 if (d)</span>
<span class="lineNum">    7812 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7813 </span><span class="lineNoCov">          0 :                 d = ast_waitfordigit(chan, 500);</span>
<span class="lineNum">    7814 </span><span class="lineNoCov">          0 :                 if (d)</span>
<span class="lineNum">    7815 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7816 </span>            :         }
<span class="lineNum">    7817 </span>            : 
<span class="lineNum">    7818 </span><span class="lineNoCov">          0 :         d = ast_play_and_wait(chan, &quot;vm-tocancel&quot;); /* &quot;or pound to cancel&quot; */</span>
<span class="lineNum">    7819 </span><span class="lineNoCov">          0 :         if (d)</span>
<span class="lineNum">    7820 </span><span class="lineNoCov">          0 :                 return d;</span>
<span class="lineNum">    7821 </span><span class="lineNoCov">          0 :         d = ast_waitfordigit(chan, 4000);</span>
<span class="lineNum">    7822 </span><span class="lineNoCov">          0 :         return d;</span>
<span class="lineNum">    7823 </span>            : }
<a name="7824"><span class="lineNum">    7824 </span>            : </a>
<span class="lineNum">    7825 </span>            : /* Japanese Syntax */
<span class="lineNum">    7826 </span><span class="lineNoCov">          0 : static int get_folder_ja(struct ast_channel *chan, int start)</span>
<span class="lineNum">    7827 </span>            : {
<span class="lineNum">    7828 </span>            :         int x;
<span class="lineNum">    7829 </span>            :         int d;
<span class="lineNum">    7830 </span>            :         char fn[256];
<span class="lineNum">    7831 </span><span class="lineNoCov">          0 :         for (x = start; x&lt; 5; x++) {    /* For all folders */</span>
<span class="lineNum">    7832 </span><span class="lineNoCov">          0 :                 if ((d = ast_say_number(chan, x, AST_DIGIT_ANY, ast_channel_language(chan), (char *) NULL))) {</span>
<span class="lineNum">    7833 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7834 </span>            :                 }
<span class="lineNum">    7835 </span><span class="lineNoCov">          0 :                 snprintf(fn, sizeof(fn), &quot;vm-%s&quot;, mbox(NULL, x));     /* Folder name */</span>
<span class="lineNum">    7836 </span><span class="lineNoCov">          0 :                 d = vm_play_folder_name(chan, fn);</span>
<span class="lineNum">    7837 </span><span class="lineNoCov">          0 :                 if (d) {</span>
<span class="lineNum">    7838 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7839 </span>            :                 }
<span class="lineNum">    7840 </span><span class="lineNoCov">          0 :                 d = ast_waitfordigit(chan, 500);</span>
<span class="lineNum">    7841 </span><span class="lineNoCov">          0 :                 if (d) {</span>
<span class="lineNum">    7842 </span><span class="lineNoCov">          0 :                         return d;</span>
<span class="lineNum">    7843 </span>            :                 }
<span class="lineNum">    7844 </span>            :         }
<span class="lineNum">    7845 </span><span class="lineNoCov">          0 :         d = ast_play_and_wait(chan, &quot;vm-tocancel&quot;); /* &quot;or pound to cancel&quot; */</span>
<span class="lineNum">    7846 </span><span class="lineNoCov">          0 :         if (d) {</span>
<span class="lineNum">    7847 </span><span class="lineNoCov">          0 :                 return d;</span>
<span class="lineNum">    7848 </span>            :         }
<span class="lineNum">    7849 </span><span class="lineNoCov">          0 :         d = ast_waitfordigit(chan, 4000);</span>
<span class="lineNum">    7850 </span><span class="lineNoCov">          0 :         return d;</span>
<span class="lineNum">    7851 </span>            : }
<span class="lineNum">    7852 </span>            : 
<span class="lineNum">    7853 </span>            : /*!
<span class="lineNum">    7854 </span>            :  * \brief plays a prompt and waits for a keypress.
<span class="lineNum">    7855 </span>            :  * \param chan
<span class="lineNum">    7856 </span>            :  * \param fn the name of the voice prompt file to be played. For example, 'vm-changeto', 'vm-savefolder'
<span class="lineNum">    7857 </span>            :  * \param start Does not appear to be used at this time.
<span class="lineNum">    7858 </span>            :  *
<span class="lineNum">    7859 </span>            :  * This is used by the main menu option to move a message to a folder or to save a message into a folder.
<span class="lineNum">    7860 </span>            :  * After playing the  message identified by the fn parameter value, it calls get_folder(), which plays the
<span class="lineNum">    7861 </span>            :  * prompting for the number inputs that correspond to the available folders.
<span class="lineNum">    7862 </span>            :  *
<a name="7863"><span class="lineNum">    7863 </span>            :  * \return zero on success, or -1 on error.</a>
<span class="lineNum">    7864 </span>            :  */
<span class="lineNum">    7865 </span><span class="lineCov">          4 : static int get_folder2(struct ast_channel *chan, char *fn, int start)</span>
<span class="lineNum">    7866 </span>            : {
<span class="lineNum">    7867 </span><span class="lineCov">          4 :         int res = 0;</span>
<span class="lineNum">    7868 </span><span class="lineCov">          4 :         int loops = 0;</span>
<span class="lineNum">    7869 </span>            : 
<span class="lineNum">    7870 </span><span class="lineCov">          4 :         res = ast_play_and_wait(chan, fn);      /* Folder name */</span>
<span class="lineNum">    7871 </span><span class="lineCov">          4 :         while (((res &lt; '0') || (res &gt; '9')) &amp;&amp;</span>
<span class="lineNum">    7872 </span><span class="lineNoCov">          0 :                         (res != '#') &amp;&amp; (res &gt;= 0) &amp;&amp;</span>
<span class="lineNum">    7873 </span>            :                         loops &lt; 4) {
<span class="lineNum">    7874 </span>            :                 /* res = get_folder(chan, 0); */
<span class="lineNum">    7875 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(ast_channel_language(chan),&quot;ja&quot;)) {   /* Japanese syntax */</span>
<span class="lineNum">    7876 </span><span class="lineNoCov">          0 :                       res = get_folder_ja(chan, 0);</span>
<span class="lineNum">    7877 </span>            :                 } else { /* Default syntax */
<span class="lineNum">    7878 </span><span class="lineNoCov">          0 :                       res = get_folder(chan, 0);</span>
<span class="lineNum">    7879 </span>            :                 }
<span class="lineNum">    7880 </span><span class="lineNoCov">          0 :                 loops++;</span>
<span class="lineNum">    7881 </span>            :         }
<span class="lineNum">    7882 </span><span class="lineCov">          4 :         if (loops == 4) { /* give up */</span>
<span class="lineNum">    7883 </span><span class="lineNoCov">          0 :                 ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;, '#', '#');</span>
<span class="lineNum">    7884 </span><span class="lineNoCov">          0 :                 return '#';</span>
<span class="lineNum">    7885 </span>            :         }
<span class="lineNum">    7886 </span><span class="lineCov">          4 :         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">    7887 </span>            :                 isprint(res) ? res : '?', isprint(res) ? res : '?');
<span class="lineNum">    7888 </span><span class="lineCov">          4 :         return res;</span>
<span class="lineNum">    7889 </span>            : }
<span class="lineNum">    7890 </span>            : 
<span class="lineNum">    7891 </span>            : /*!
<span class="lineNum">    7892 </span>            :  * \brief presents the option to prepend to an existing message when forwarding it.
<span class="lineNum">    7893 </span>            :  * \param chan
<span class="lineNum">    7894 </span>            :  * \param vmu
<span class="lineNum">    7895 </span>            :  * \param curdir
<span class="lineNum">    7896 </span>            :  * \param curmsg
<span class="lineNum">    7897 </span>            :  * \param vm_fmts
<span class="lineNum">    7898 </span>            :  * \param context
<span class="lineNum">    7899 </span>            :  * \param record_gain
<span class="lineNum">    7900 </span>            :  * \param duration
<span class="lineNum">    7901 </span>            :  * \param vms
<span class="lineNum">    7902 </span>            :  * \param flag
<span class="lineNum">    7903 </span>            :  *
<span class="lineNum">    7904 </span>            :  * Presents a prompt for 1 to prepend the current message, 2 to forward the message without prepending, or * to return to the main menu.
<span class="lineNum">    7905 </span>            :  *
<span class="lineNum">    7906 </span>            :  * This is invoked from forward_message() when performing a forward operation (option 8 from main menu).
<a name="7907"><span class="lineNum">    7907 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    7908 </span>            :  */
<span class="lineNum">    7909 </span><span class="lineCov">          3 : static int vm_forwardoptions(struct ast_channel *chan, struct ast_vm_user *vmu, char *curdir, int curmsg, char *vm_fmts,</span>
<span class="lineNum">    7910 </span>            :                         char *context, signed char record_gain, long *duration, struct vm_state *vms, char *flag)
<span class="lineNum">    7911 </span>            : {
<span class="lineNum">    7912 </span><span class="lineCov">          3 :         int cmd = 0;</span>
<span class="lineNum">    7913 </span><span class="lineCov">          3 :         int retries = 0, prepend_duration = 0, already_recorded = 0;</span>
<span class="lineNum">    7914 </span>            :         char msgfile[PATH_MAX], backup[PATH_MAX], backup_textfile[PATH_MAX];
<span class="lineNum">    7915 </span>            :         char textfile[PATH_MAX];
<span class="lineNum">    7916 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">    7917 </span><span class="lineCov">          3 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">    7918 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    7919 </span><span class="lineCov">          3 :         signed char zero_gain = 0;</span>
<span class="lineNum">    7920 </span>            : #else
<span class="lineNum">    7921 </span>            :         const char *msg_id = NULL;
<span class="lineNum">    7922 </span>            : #endif
<span class="lineNum">    7923 </span>            :         const char *duration_str;
<span class="lineNum">    7924 </span>            : 
<span class="lineNum">    7925 </span>            :         /* Must always populate duration correctly */
<span class="lineNum">    7926 </span><span class="lineCov">          3 :         make_file(msgfile, sizeof(msgfile), curdir, curmsg);</span>
<span class="lineNum">    7927 </span><span class="lineCov">          3 :         strcpy(textfile, msgfile);</span>
<span class="lineNum">    7928 </span><span class="lineCov">          3 :         strcpy(backup, msgfile);</span>
<span class="lineNum">    7929 </span><span class="lineCov">          3 :         strcpy(backup_textfile, msgfile);</span>
<span class="lineNum">    7930 </span><span class="lineCov">          3 :         strncat(textfile, &quot;.txt&quot;, sizeof(textfile) - strlen(textfile) - 1);</span>
<span class="lineNum">    7931 </span><span class="lineCov">          3 :         strncat(backup, &quot;-bak&quot;, sizeof(backup) - strlen(backup) - 1);</span>
<span class="lineNum">    7932 </span><span class="lineCov">          3 :         strncat(backup_textfile, &quot;-bak.txt&quot;, sizeof(backup_textfile) - strlen(backup_textfile) - 1);</span>
<span class="lineNum">    7933 </span>            : 
<span class="lineNum">    7934 </span><span class="lineCov">          3 :         if ((msg_cfg = ast_config_load(textfile, config_flags)) &amp;&amp; valid_config(msg_cfg) &amp;&amp; (duration_str = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;))) {</span>
<span class="lineNum">    7935 </span><span class="lineCov">          3 :                 *duration = atoi(duration_str);</span>
<span class="lineNum">    7936 </span>            :         } else {
<span class="lineNum">    7937 </span><span class="lineNoCov">          0 :                 *duration = 0;</span>
<span class="lineNum">    7938 </span>            :         }
<span class="lineNum">    7939 </span>            : 
<span class="lineNum">    7940 </span><span class="lineCov">          9 :         while ((cmd &gt;= 0) &amp;&amp; (cmd != 't') &amp;&amp; (cmd != '*')) {</span>
<span class="lineNum">    7941 </span><span class="lineCov">          6 :                 if (cmd)</span>
<span class="lineNum">    7942 </span><span class="lineCov">          3 :                         retries = 0;</span>
<span class="lineNum">    7943 </span><span class="lineCov">          6 :                 switch (cmd) {</span>
<span class="lineNum">    7944 </span><span class="lineCov">          2 :                 case '1':</span>
<span class="lineNum">    7945 </span>            : 
<span class="lineNum">    7946 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    7947 </span>            :                         /* Record new intro file */
<span class="lineNum">    7948 </span>            :                         if (msg_cfg &amp;&amp; msg_cfg != CONFIG_STATUS_FILEINVALID) {
<span class="lineNum">    7949 </span>            :                                 msg_id = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;msg_id&quot;);
<span class="lineNum">    7950 </span>            :                         }
<span class="lineNum">    7951 </span>            :                         make_file(vms-&gt;introfn, sizeof(vms-&gt;introfn), curdir, curmsg);
<span class="lineNum">    7952 </span>            :                         strncat(vms-&gt;introfn, &quot;intro&quot;, sizeof(vms-&gt;introfn));
<span class="lineNum">    7953 </span>            :                         ast_play_and_wait(chan, &quot;vm-record-prepend&quot;);
<span class="lineNum">    7954 </span>            :                         ast_play_and_wait(chan, &quot;beep&quot;);
<span class="lineNum">    7955 </span>            :                         cmd = play_record_review(chan, NULL, vms-&gt;introfn, vmu-&gt;maxsecs, vm_fmts, 1, vmu, (int *) duration, NULL, NULL, record_gain, vms, flag, msg_id, 1);
<span class="lineNum">    7956 </span>            :                         if (cmd == -1) {
<span class="lineNum">    7957 </span>            :                                 break;
<span class="lineNum">    7958 </span>            :                         }
<span class="lineNum">    7959 </span>            :                         cmd = 't';
<span class="lineNum">    7960 </span>            : #else
<span class="lineNum">    7961 </span>            : 
<span class="lineNum">    7962 </span>            :                         /* prepend a message to the current message, update the metadata and return */
<span class="lineNum">    7963 </span>            : 
<span class="lineNum">    7964 </span><span class="lineCov">          2 :                         make_file(msgfile, sizeof(msgfile), curdir, curmsg);</span>
<span class="lineNum">    7965 </span><span class="lineCov">          2 :                         strcpy(textfile, msgfile);</span>
<span class="lineNum">    7966 </span><span class="lineCov">          2 :                         strncat(textfile, &quot;.txt&quot;, sizeof(textfile) - 1);</span>
<span class="lineNum">    7967 </span><span class="lineCov">          2 :                         *duration = 0;</span>
<span class="lineNum">    7968 </span>            : 
<span class="lineNum">    7969 </span>            :                         /* if we can't read the message metadata, stop now */
<span class="lineNum">    7970 </span><span class="lineCov">          2 :                         if (!valid_config(msg_cfg)) {</span>
<span class="lineNum">    7971 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">    7972 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    7973 </span>            :                         }
<span class="lineNum">    7974 </span>            : 
<span class="lineNum">    7975 </span>            :                         /* Back up the original file, so we can retry the prepend and restore it after forward. */
<span class="lineNum">    7976 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    7977 </span><span class="lineCov">          2 :                         if (already_recorded) {</span>
<span class="lineNum">    7978 </span><span class="lineNoCov">          0 :                                 ast_filecopy(backup, msgfile, NULL);</span>
<span class="lineNum">    7979 </span><span class="lineNoCov">          0 :                                 copy(backup_textfile, textfile);</span>
<span class="lineNum">    7980 </span>            :                         }
<span class="lineNum">    7981 </span>            :                         else {
<span class="lineNum">    7982 </span><span class="lineCov">          2 :                                 ast_filecopy(msgfile, backup, NULL);</span>
<span class="lineNum">    7983 </span><span class="lineCov">          2 :                                 copy(textfile, backup_textfile);</span>
<span class="lineNum">    7984 </span>            :                         }
<span class="lineNum">    7985 </span>            : #endif
<span class="lineNum">    7986 </span><span class="lineCov">          2 :                         already_recorded = 1;</span>
<span class="lineNum">    7987 </span>            : 
<span class="lineNum">    7988 </span><span class="lineCov">          2 :                         if (record_gain)</span>
<span class="lineNum">    7989 </span><span class="lineNoCov">          0 :                                 ast_channel_setoption(chan, AST_OPTION_RXGAIN, &amp;record_gain, sizeof(record_gain), 0);</span>
<span class="lineNum">    7990 </span>            : 
<span class="lineNum">    7991 </span><span class="lineCov">          2 :                         cmd = ast_play_and_prepend(chan, NULL, msgfile, 0, vm_fmts, &amp;prepend_duration, NULL, 1, silencethreshold, maxsilence);</span>
<span class="lineNum">    7992 </span>            : 
<span class="lineNum">    7993 </span><span class="lineCov">          2 :                         if (cmd == 'S') { /* If we timed out, tell the user it didn't work properly and clean up the files */</span>
<span class="lineNum">    7994 </span><span class="lineNoCov">          0 :                                 ast_stream_and_wait(chan, vm_pls_try_again, &quot;&quot;); /* this might be removed if a proper vm_prepend_timeout is ever recorded */</span>
<span class="lineNum">    7995 </span><span class="lineNoCov">          0 :                                 ast_stream_and_wait(chan, vm_prepend_timeout, &quot;&quot;);</span>
<span class="lineNum">    7996 </span><span class="lineNoCov">          0 :                                 ast_filerename(backup, msgfile, NULL);</span>
<span class="lineNum">    7997 </span>            :                         }
<span class="lineNum">    7998 </span>            : 
<span class="lineNum">    7999 </span><span class="lineCov">          2 :                         if (record_gain)</span>
<span class="lineNum">    8000 </span><span class="lineNoCov">          0 :                                 ast_channel_setoption(chan, AST_OPTION_RXGAIN, &amp;zero_gain, sizeof(zero_gain), 0);</span>
<span class="lineNum">    8001 </span>            : 
<span class="lineNum">    8002 </span>            : 
<span class="lineNum">    8003 </span><span class="lineCov">          2 :                         if ((duration_str = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;)))</span>
<span class="lineNum">    8004 </span><span class="lineCov">          2 :                                 *duration = atoi(duration_str);</span>
<span class="lineNum">    8005 </span>            : 
<span class="lineNum">    8006 </span><span class="lineCov">          2 :                         if (prepend_duration) {</span>
<span class="lineNum">    8007 </span>            :                                 struct ast_category *msg_cat;
<span class="lineNum">    8008 </span>            :                                 /* need enough space for a maximum-length message duration */
<span class="lineNum">    8009 </span>            :                                 char duration_buf[12];
<span class="lineNum">    8010 </span>            : 
<span class="lineNum">    8011 </span><span class="lineCov">          1 :                                 *duration += prepend_duration;</span>
<span class="lineNum">    8012 </span><span class="lineCov">          1 :                                 msg_cat = ast_category_get(msg_cfg, &quot;message&quot;, NULL);</span>
<span class="lineNum">    8013 </span><span class="lineCov">          1 :                                 snprintf(duration_buf, sizeof(duration_buf), &quot;%ld&quot;, *duration);</span>
<span class="lineNum">    8014 </span><span class="lineCov">          1 :                                 if (!ast_variable_update(msg_cat, &quot;duration&quot;, duration_buf, NULL, 0)) {</span>
<span class="lineNum">    8015 </span><span class="lineCov">          1 :                                         ast_config_text_file_save(textfile, msg_cfg, &quot;app_voicemail&quot;);</span>
<span class="lineNum">    8016 </span>            :                                 }
<span class="lineNum">    8017 </span>            :                         }
<span class="lineNum">    8018 </span>            : 
<span class="lineNum">    8019 </span>            : #endif
<span class="lineNum">    8020 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">    8021 </span><span class="lineCov">          1 :                 case '2':</span>
<span class="lineNum">    8022 </span>            :                         /* NULL out introfile so we know there is no intro! */
<span class="lineNum">    8023 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8024 </span>            :                         *vms-&gt;introfn = '\0';
<span class="lineNum">    8025 </span>            : #endif
<span class="lineNum">    8026 </span><span class="lineCov">          1 :                         cmd = 't';</span>
<span class="lineNum">    8027 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    8028 </span><span class="lineNoCov">          0 :                 case '*':</span>
<span class="lineNum">    8029 </span><span class="lineNoCov">          0 :                         cmd = '*';</span>
<span class="lineNum">    8030 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    8031 </span><span class="lineCov">          3 :                 default:</span>
<span class="lineNum">    8032 </span>            :                         /* If time_out and return to menu, reset already_recorded */
<span class="lineNum">    8033 </span><span class="lineCov">          3 :                         already_recorded = 0;</span>
<span class="lineNum">    8034 </span>            : 
<span class="lineNum">    8035 </span><span class="lineCov">          3 :                         cmd = ast_play_and_wait(chan, &quot;vm-forwardoptions&quot;);</span>
<span class="lineNum">    8036 </span>            :                                 /* &quot;Press 1 to prepend a message or 2 to forward the message without prepending&quot; */
<span class="lineNum">    8037 </span><span class="lineCov">          3 :                         if (!cmd) {</span>
<span class="lineNum">    8038 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-starmain&quot;);</span>
<span class="lineNum">    8039 </span>            :                                 /* &quot;press star to return to the main menu&quot; */
<span class="lineNum">    8040 </span>            :                         }
<span class="lineNum">    8041 </span><span class="lineCov">          3 :                         if (!cmd) {</span>
<span class="lineNum">    8042 </span><span class="lineNoCov">          0 :                                 cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">    8043 </span>            :                         }
<span class="lineNum">    8044 </span><span class="lineCov">          3 :                         if (!cmd) {</span>
<span class="lineNum">    8045 </span><span class="lineNoCov">          0 :                                 retries++;</span>
<span class="lineNum">    8046 </span>            :                         }
<span class="lineNum">    8047 </span><span class="lineCov">          3 :                         if (retries &gt; 3) {</span>
<span class="lineNum">    8048 </span><span class="lineNoCov">          0 :                                 cmd = '*'; /* Let's cancel this beast */</span>
<span class="lineNum">    8049 </span>            :                         }
<span class="lineNum">    8050 </span><span class="lineCov">          3 :                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">    8051 </span>            :                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">    8052 </span>            :                 }
<span class="lineNum">    8053 </span>            :         }
<span class="lineNum">    8054 </span>            : 
<span class="lineNum">    8055 </span><span class="lineCov">          3 :         if (valid_config(msg_cfg))</span>
<span class="lineNum">    8056 </span><span class="lineCov">          3 :                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">    8057 </span><span class="lineCov">          3 :         if (prepend_duration)</span>
<span class="lineNum">    8058 </span><span class="lineCov">          1 :                 *duration = prepend_duration;</span>
<span class="lineNum">    8059 </span>            : 
<span class="lineNum">    8060 </span><span class="lineCov">          3 :         if (already_recorded &amp;&amp; cmd == -1) {</span>
<span class="lineNum">    8061 </span>            :                 /* restore original message if prepention cancelled */
<span class="lineNum">    8062 </span><span class="lineCov">          1 :                 ast_filerename(backup, msgfile, NULL);</span>
<span class="lineNum">    8063 </span><span class="lineCov">          1 :                 rename(backup_textfile, textfile);</span>
<span class="lineNum">    8064 </span>            :         }
<span class="lineNum">    8065 </span>            : 
<span class="lineNum">    8066 </span><span class="lineCov">          3 :         if (cmd == 't' || cmd == 'S') /* XXX entering this block with a value of 'S' is probably no longer possible. */</span>
<span class="lineNum">    8067 </span><span class="lineCov">          2 :                 cmd = 0;</span>
<span class="lineNum">    8068 </span><span class="lineCov">          3 :         return cmd;</span>
<a name="8069"><span class="lineNum">    8069 </span>            : }</a>
<span class="lineNum">    8070 </span>            : 
<span class="lineNum">    8071 </span><span class="lineCov">       2191 : static void queue_mwi_event(const char *channel_id, const char *box, int urgent, int new, int old)</span>
<span class="lineNum">    8072 </span>            : {
<span class="lineNum">    8073 </span>            :         char *mailbox;
<span class="lineNum">    8074 </span>            :         char *context;
<span class="lineNum">    8075 </span>            : 
<span class="lineNum">    8076 </span><span class="lineCov">       2191 :         if (separate_mailbox(ast_strdupa(box), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">    8077 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    8078 </span>            :         }
<span class="lineNum">    8079 </span>            : 
<span class="lineNum">    8080 </span><span class="lineCov">       2191 :         ast_publish_mwi_state_channel(mailbox, context, new + urgent, old, channel_id);</span>
<span class="lineNum">    8081 </span>            : }
<span class="lineNum">    8082 </span>            : 
<span class="lineNum">    8083 </span>            : /*!
<span class="lineNum">    8084 </span>            :  * \brief Sends email notification that a user has a new voicemail waiting for them.
<span class="lineNum">    8085 </span>            :  * \param chan
<span class="lineNum">    8086 </span>            :  * \param vmu
<span class="lineNum">    8087 </span>            :  * \param vms
<span class="lineNum">    8088 </span>            :  * \param msgnum
<span class="lineNum">    8089 </span>            :  * \param duration
<span class="lineNum">    8090 </span>            :  * \param fmt
<span class="lineNum">    8091 </span>            :  * \param cidnum The Caller ID phone number value.
<span class="lineNum">    8092 </span>            :  * \param cidname The Caller ID name value.
<span class="lineNum">    8093 </span>            :  * \param flag
<span class="lineNum">    8094 </span>            :  *
<a name="8095"><span class="lineNum">    8095 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    8096 </span>            :  */
<span class="lineNum">    8097 </span><span class="lineCov">         23 : static int notify_new_message(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msgnum, long duration, char *fmt, char *cidnum, char *cidname, const char *flag)</span>
<span class="lineNum">    8098 </span>            : {
<span class="lineNum">    8099 </span>            :         char todir[PATH_MAX], fn[PATH_MAX], ext_context[PATH_MAX], *stringp;
<span class="lineNum">    8100 </span><span class="lineCov">         23 :         int newmsgs = 0, oldmsgs = 0, urgentmsgs = 0;</span>
<span class="lineNum">    8101 </span>            :         const char *category;
<span class="lineNum">    8102 </span><span class="lineCov">         23 :         char *myserveremail = serveremail;</span>
<span class="lineNum">    8103 </span>            : 
<span class="lineNum">    8104 </span><span class="lineCov">         23 :         ast_channel_lock(chan);</span>
<span class="lineNum">    8105 </span><span class="lineCov">         23 :         if ((category = pbx_builtin_getvar_helper(chan, &quot;VM_CATEGORY&quot;))) {</span>
<span class="lineNum">    8106 </span><span class="lineNoCov">          0 :                 category = ast_strdupa(category);</span>
<span class="lineNum">    8107 </span>            :         }
<span class="lineNum">    8108 </span><span class="lineCov">         23 :         ast_channel_unlock(chan);</span>
<span class="lineNum">    8109 </span>            : 
<span class="lineNum">    8110 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    8111 </span><span class="lineCov">         23 :         make_dir(todir, sizeof(todir), vmu-&gt;context, vmu-&gt;mailbox, !ast_strlen_zero(flag) &amp;&amp; !strcmp(flag, &quot;Urgent&quot;) ? &quot;Urgent&quot; : &quot;INBOX&quot;);</span>
<span class="lineNum">    8112 </span>            : #else
<span class="lineNum">    8113 </span>            :         snprintf(todir, sizeof(todir), &quot;%simap&quot;, VM_SPOOL_DIR);
<span class="lineNum">    8114 </span>            : #endif
<span class="lineNum">    8115 </span><span class="lineCov">         23 :         make_file(fn, sizeof(fn), todir, msgnum);</span>
<span class="lineNum">    8116 </span><span class="lineCov">         23 :         snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, vmu-&gt;mailbox, vmu-&gt;context);</span>
<span class="lineNum">    8117 </span>            : 
<span class="lineNum">    8118 </span><span class="lineCov">         23 :         if (!ast_strlen_zero(vmu-&gt;attachfmt)) {</span>
<span class="lineNum">    8119 </span><span class="lineNoCov">          0 :                 if (strstr(fmt, vmu-&gt;attachfmt))</span>
<span class="lineNum">    8120 </span><span class="lineNoCov">          0 :                         fmt = vmu-&gt;attachfmt;</span>
<span class="lineNum">    8121 </span>            :                 else
<span class="lineNum">    8122 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Attachment format '%s' is not one of the recorded formats '%s'.  Falling back to default format for '%s@%s'.\n&quot;, vmu-&gt;attachfmt, fmt, vmu-&gt;mailbox, vmu-&gt;context);</span>
<span class="lineNum">    8123 </span>            :         }
<span class="lineNum">    8124 </span>            : 
<span class="lineNum">    8125 </span>            :         /* Attach only the first format */
<span class="lineNum">    8126 </span><span class="lineCov">         23 :         fmt = ast_strdupa(fmt);</span>
<span class="lineNum">    8127 </span><span class="lineCov">         23 :         stringp = fmt;</span>
<span class="lineNum">    8128 </span><span class="lineCov">         23 :         strsep(&amp;stringp, &quot;|&quot;);</span>
<span class="lineNum">    8129 </span>            : 
<span class="lineNum">    8130 </span><span class="lineCov">         23 :         if (!ast_strlen_zero(vmu-&gt;serveremail))</span>
<span class="lineNum">    8131 </span><span class="lineNoCov">          0 :                 myserveremail = vmu-&gt;serveremail;</span>
<span class="lineNum">    8132 </span>            : 
<span class="lineNum">    8133 </span><span class="lineCov">         23 :         if (!ast_strlen_zero(vmu-&gt;email)) {</span>
<span class="lineNum">    8134 </span><span class="lineNoCov">          0 :                 int attach_user_voicemail = ast_test_flag(vmu, VM_ATTACH);</span>
<span class="lineNum">    8135 </span><span class="lineNoCov">          0 :                 char *msg_id = NULL;</span>
<span class="lineNum">    8136 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8137 </span>            :                 struct ast_config *msg_cfg;
<span class="lineNum">    8138 </span>            :                 struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };
<span class="lineNum">    8139 </span>            :                 char filename[PATH_MAX];
<span class="lineNum">    8140 </span>            : 
<span class="lineNum">    8141 </span>            :                 snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, fn);
<span class="lineNum">    8142 </span>            :                 msg_cfg = ast_config_load(filename, config_flags);
<span class="lineNum">    8143 </span>            :                 if (msg_cfg &amp;&amp; msg_cfg != CONFIG_STATUS_FILEINVALID) {
<span class="lineNum">    8144 </span>            :                         msg_id = ast_strdupa(ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;msg_id&quot;));
<span class="lineNum">    8145 </span>            :                         ast_config_destroy(msg_cfg);
<span class="lineNum">    8146 </span>            :                 }
<span class="lineNum">    8147 </span>            : #endif
<span class="lineNum">    8148 </span>            : 
<span class="lineNum">    8149 </span>            :                 if (attach_user_voicemail)
<span class="lineNum">    8150 </span>            :                         RETRIEVE(todir, msgnum, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">    8151 </span>            : 
<span class="lineNum">    8152 </span>            :                 /* XXX possible imap issue, should category be NULL XXX */
<span class="lineNum">    8153 </span><span class="lineNoCov">          0 :                 sendmail(myserveremail, vmu, msgnum, vmu-&gt;context, vmu-&gt;mailbox, mbox(vmu, 0), cidnum, cidname, fn, NULL, fmt, duration, attach_user_voicemail, chan, category, flag, msg_id);</span>
<span class="lineNum">    8154 </span>            : 
<span class="lineNum">    8155 </span>            :                 if (attach_user_voicemail)
<span class="lineNum">    8156 </span>            :                         DISPOSE(todir, msgnum);
<span class="lineNum">    8157 </span>            :         }
<span class="lineNum">    8158 </span>            : 
<span class="lineNum">    8159 </span><span class="lineCov">         23 :         if (!ast_strlen_zero(vmu-&gt;pager)) {</span>
<span class="lineNum">    8160 </span><span class="lineNoCov">          0 :                 sendpage(myserveremail, vmu-&gt;pager, msgnum, vmu-&gt;context, vmu-&gt;mailbox, mbox(vmu, 0), cidnum, cidname, duration, vmu, category, flag);</span>
<span class="lineNum">    8161 </span>            :         }
<span class="lineNum">    8162 </span>            : 
<span class="lineNum">    8163 </span><span class="lineCov">         23 :         if (ast_test_flag(vmu, VM_DELETE))</span>
<span class="lineNum">    8164 </span><span class="lineNoCov">          0 :                 DELETE(todir, msgnum, fn, vmu);</span>
<span class="lineNum">    8165 </span>            : 
<span class="lineNum">    8166 </span>            :         /* Leave voicemail for someone */
<span class="lineNum">    8167 </span><span class="lineCov">         23 :         if (ast_app_has_voicemail(ext_context, NULL))</span>
<span class="lineNum">    8168 </span><span class="lineCov">         23 :                 ast_app_inboxcount2(ext_context, &amp;urgentmsgs, &amp;newmsgs, &amp;oldmsgs);</span>
<span class="lineNum">    8169 </span>            : 
<span class="lineNum">    8170 </span><span class="lineCov">         23 :         queue_mwi_event(ast_channel_uniqueid(chan), ext_context, urgentmsgs, newmsgs, oldmsgs);</span>
<span class="lineNum">    8171 </span><span class="lineCov">         23 :         run_externnotify(vmu-&gt;context, vmu-&gt;mailbox, flag);</span>
<span class="lineNum">    8172 </span>            : 
<span class="lineNum">    8173 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8174 </span>            :         vm_delete(fn);  /* Delete the file, but not the IMAP message */
<span class="lineNum">    8175 </span>            :         if (ast_test_flag(vmu, VM_DELETE))  { /* Delete the IMAP message if delete = yes */
<span class="lineNum">    8176 </span>            :                 vm_imap_delete(NULL, vms-&gt;curmsg, vmu);
<span class="lineNum">    8177 </span>            :                 vms-&gt;newmessages--;  /* Fix new message count */
<span class="lineNum">    8178 </span>            :         }
<span class="lineNum">    8179 </span>            : #endif
<span class="lineNum">    8180 </span>            : 
<span class="lineNum">    8181 </span><span class="lineCov">         23 :         return 0;</span>
<span class="lineNum">    8182 </span>            : }
<span class="lineNum">    8183 </span>            : 
<span class="lineNum">    8184 </span>            : /*!
<span class="lineNum">    8185 </span>            :  * \brief Sends a voicemail message to a mailbox recipient.
<span class="lineNum">    8186 </span>            :  * \param chan
<span class="lineNum">    8187 </span>            :  * \param context
<span class="lineNum">    8188 </span>            :  * \param vms
<span class="lineNum">    8189 </span>            :  * \param sender
<span class="lineNum">    8190 </span>            :  * \param fmt
<span class="lineNum">    8191 </span>            :  * \param is_new_message Used to indicate the mode for which this method was invoked.
<span class="lineNum">    8192 </span>            :  *             Will be 0 when called to forward an existing message (option 8)
<span class="lineNum">    8193 </span>            :  *             Will be 1 when called to leave a message (option 3-&gt;5)
<span class="lineNum">    8194 </span>            :  * \param record_gain
<span class="lineNum">    8195 </span>            :  * \param urgent
<span class="lineNum">    8196 </span>            :  *
<span class="lineNum">    8197 </span>            :  * Reads the destination mailbox(es) from keypad input for CID, or if use_directory feature is enabled, the Directory.
<span class="lineNum">    8198 </span>            :  *
<span class="lineNum">    8199 </span>            :  * When in the leave message mode (is_new_message == 1):
<span class="lineNum">    8200 </span>            :  *   - allow the leaving of a message for ourselves. (Will not allow us to forward a message to ourselves, when is_new_message == 0).
<span class="lineNum">    8201 </span>            :  *   - attempt to determine the context and mailbox, and then invoke leave_message() function to record and store the message.
<span class="lineNum">    8202 </span>            :  *
<span class="lineNum">    8203 </span>            :  * When in the forward message mode (is_new_message == 0):
<span class="lineNum">    8204 </span>            :  *   - retrieves the current message to be forwarded
<span class="lineNum">    8205 </span>            :  *   - copies the original message to a temporary file, so updates to the envelope can be done.
<span class="lineNum">    8206 </span>            :  *   - determines the target mailbox and folders
<span class="lineNum">    8207 </span>            :  *   - copies the message into the target mailbox, using copy_message() or by generating the message into an email attachment if using imap folders.
<span class="lineNum">    8208 </span>            :  *
<a name="8209"><span class="lineNum">    8209 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">    8210 </span>            :  */
<span class="lineNum">    8211 </span><span class="lineCov">          3 : static int forward_message(struct ast_channel *chan, char *context, struct vm_state *vms, struct ast_vm_user *sender, char *fmt, int is_new_message, signed char record_gain, int urgent)</span>
<span class="lineNum">    8212 </span>            : {
<span class="lineNum">    8213 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8214 </span>            :         int todircount = 0;
<span class="lineNum">    8215 </span>            :         struct vm_state *dstvms;
<span class="lineNum">    8216 </span>            : #endif
<span class="lineNum">    8217 </span><span class="lineCov">          3 :         char username[70]=&quot;&quot;;</span>
<span class="lineNum">    8218 </span>            :         char fn[PATH_MAX]; /* for playback of name greeting */
<span class="lineNum">    8219 </span><span class="lineCov">          3 :         char ecodes[16] = &quot;#&quot;;</span>
<span class="lineNum">    8220 </span><span class="lineCov">          3 :         int res = 0, cmd = 0;</span>
<span class="lineNum">    8221 </span><span class="lineCov">          3 :         struct ast_vm_user *receiver = NULL, *vmtmp;</span>
<span class="lineNum">    8222 </span><span class="lineCov">          3 :         AST_LIST_HEAD_NOLOCK_STATIC(extensions, ast_vm_user);</span>
<span class="lineNum">    8223 </span>            :         char *stringp;
<span class="lineNum">    8224 </span>            :         const char *s;
<span class="lineNum">    8225 </span>            :         const char mailbox_context[256];
<span class="lineNum">    8226 </span><span class="lineCov">          3 :         int saved_messages = 0;</span>
<span class="lineNum">    8227 </span><span class="lineCov">          3 :         int valid_extensions = 0;</span>
<span class="lineNum">    8228 </span>            :         char *dir;
<span class="lineNum">    8229 </span>            :         int curmsg;
<span class="lineNum">    8230 </span><span class="lineCov">          3 :         char urgent_str[7] = &quot;&quot;;</span>
<span class="lineNum">    8231 </span><span class="lineCov">          3 :         int prompt_played = 0;</span>
<span class="lineNum">    8232 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    8233 </span>            :         char msgfile[PATH_MAX], textfile[PATH_MAX], backup[PATH_MAX], backup_textfile[PATH_MAX];
<span class="lineNum">    8234 </span>            : #endif
<span class="lineNum">    8235 </span><span class="lineCov">          3 :         if (ast_test_flag((&amp;globalflags), VM_FWDURGAUTO)) {</span>
<span class="lineNum">    8236 </span><span class="lineNoCov">          0 :                 ast_copy_string(urgent_str, urgent ? &quot;Urgent&quot; : &quot;&quot;, sizeof(urgent_str));</span>
<span class="lineNum">    8237 </span>            :         }
<span class="lineNum">    8238 </span>            : 
<span class="lineNum">    8239 </span><span class="lineCov">          3 :         if (vms == NULL) return -1;</span>
<span class="lineNum">    8240 </span><span class="lineCov">          3 :         dir = vms-&gt;curdir;</span>
<span class="lineNum">    8241 </span><span class="lineCov">          3 :         curmsg = vms-&gt;curmsg;</span>
<span class="lineNum">    8242 </span>            : 
<span class="lineNum">    8243 </span><span class="lineCov">          3 :         ast_test_suite_event_notify(&quot;FORWARD&quot;, &quot;Message: entering forward message menu&quot;);</span>
<span class="lineNum">    8244 </span><span class="lineCov">          3 :         while (!res &amp;&amp; !valid_extensions) {</span>
<span class="lineNum">    8245 </span><span class="lineCov">          3 :                 int use_directory = 0;</span>
<span class="lineNum">    8246 </span><span class="lineCov">          3 :                 if (ast_test_flag((&amp;globalflags), VM_DIRECFORWARD)) {</span>
<span class="lineNum">    8247 </span><span class="lineNoCov">          0 :                         int done = 0;</span>
<span class="lineNum">    8248 </span><span class="lineNoCov">          0 :                         int retries = 0;</span>
<span class="lineNum">    8249 </span><span class="lineNoCov">          0 :                         cmd = 0;</span>
<span class="lineNum">    8250 </span><span class="lineNoCov">          0 :                         while ((cmd &gt;= 0) &amp;&amp; !done ){</span>
<span class="lineNum">    8251 </span><span class="lineNoCov">          0 :                                 if (cmd)</span>
<span class="lineNum">    8252 </span><span class="lineNoCov">          0 :                                         retries = 0;</span>
<span class="lineNum">    8253 </span><span class="lineNoCov">          0 :                                 switch (cmd) {</span>
<span class="lineNum">    8254 </span><span class="lineNoCov">          0 :                                 case '1':</span>
<span class="lineNum">    8255 </span><span class="lineNoCov">          0 :                                         use_directory = 0;</span>
<span class="lineNum">    8256 </span><span class="lineNoCov">          0 :                                         done = 1;</span>
<span class="lineNum">    8257 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8258 </span><span class="lineNoCov">          0 :                                 case '2':</span>
<span class="lineNum">    8259 </span><span class="lineNoCov">          0 :                                         use_directory = 1;</span>
<span class="lineNum">    8260 </span><span class="lineNoCov">          0 :                                         done = 1;</span>
<span class="lineNum">    8261 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8262 </span><span class="lineNoCov">          0 :                                 case '*':</span>
<span class="lineNum">    8263 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">    8264 </span><span class="lineNoCov">          0 :                                         done = 1;</span>
<span class="lineNum">    8265 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8266 </span><span class="lineNoCov">          0 :                                 default:</span>
<span class="lineNum">    8267 </span>            :                                         /* Press 1 to enter an extension press 2 to use the directory */
<span class="lineNum">    8268 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-forward&quot;);</span>
<span class="lineNum">    8269 </span><span class="lineNoCov">          0 :                                         if (!cmd) {</span>
<span class="lineNum">    8270 </span><span class="lineNoCov">          0 :                                                 cmd = ast_waitfordigit(chan, 3000);</span>
<span class="lineNum">    8271 </span>            :                                         }
<span class="lineNum">    8272 </span><span class="lineNoCov">          0 :                                         if (!cmd) {</span>
<span class="lineNum">    8273 </span><span class="lineNoCov">          0 :                                                 retries++;</span>
<span class="lineNum">    8274 </span>            :                                         }
<span class="lineNum">    8275 </span><span class="lineNoCov">          0 :                                         if (retries &gt; 3) {</span>
<span class="lineNum">    8276 </span><span class="lineNoCov">          0 :                                                 cmd = 't';</span>
<span class="lineNum">    8277 </span><span class="lineNoCov">          0 :                                                 done = 1;</span>
<span class="lineNum">    8278 </span>            :                                         }
<span class="lineNum">    8279 </span><span class="lineNoCov">          0 :                                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">    8280 </span>            :                                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">    8281 </span>            :                                 }
<span class="lineNum">    8282 </span>            :                         }
<span class="lineNum">    8283 </span><span class="lineNoCov">          0 :                         if (cmd &lt; 0 || cmd == 't')</span>
<span class="lineNum">    8284 </span>            :                                 break;
<span class="lineNum">    8285 </span>            :                 }
<span class="lineNum">    8286 </span>            : 
<span class="lineNum">    8287 </span><span class="lineCov">          3 :                 if (use_directory) {</span>
<span class="lineNum">    8288 </span>            :                         /* use app_directory */
<span class="lineNum">    8289 </span>            : 
<span class="lineNum">    8290 </span>            :                         struct ast_app* directory_app;
<span class="lineNum">    8291 </span>            : 
<span class="lineNum">    8292 </span><span class="lineNoCov">          0 :                         directory_app = pbx_findapp(&quot;Directory&quot;);</span>
<span class="lineNum">    8293 </span><span class="lineNoCov">          0 :                         if (directory_app) {</span>
<span class="lineNum">    8294 </span>            :                                 char vmcontext[256];
<span class="lineNum">    8295 </span>            :                                 char *old_context;
<span class="lineNum">    8296 </span>            :                                 char *old_exten;
<span class="lineNum">    8297 </span>            :                                 int old_priority;
<span class="lineNum">    8298 </span>            :                                 /* make backup copies */
<span class="lineNum">    8299 </span><span class="lineNoCov">          0 :                                 old_context = ast_strdupa(ast_channel_context(chan));</span>
<span class="lineNum">    8300 </span><span class="lineNoCov">          0 :                                 old_exten = ast_strdupa(ast_channel_exten(chan));</span>
<span class="lineNum">    8301 </span><span class="lineNoCov">          0 :                                 old_priority = ast_channel_priority(chan);</span>
<span class="lineNum">    8302 </span>            : 
<span class="lineNum">    8303 </span>            :                                 /* call the Directory, changes the channel */
<span class="lineNum">    8304 </span><span class="lineNoCov">          0 :                                 snprintf(vmcontext, sizeof(vmcontext), &quot;%s,,v&quot;, context ? context : &quot;default&quot;);</span>
<span class="lineNum">    8305 </span><span class="lineNoCov">          0 :                                 res = pbx_exec(chan, directory_app, vmcontext);</span>
<span class="lineNum">    8306 </span>            : 
<span class="lineNum">    8307 </span><span class="lineNoCov">          0 :                                 ast_copy_string(username, ast_channel_exten(chan), sizeof(username));</span>
<span class="lineNum">    8308 </span>            : 
<span class="lineNum">    8309 </span>            :                                 /* restore the old context, exten, and priority */
<span class="lineNum">    8310 </span><span class="lineNoCov">          0 :                                 ast_channel_context_set(chan, old_context);</span>
<span class="lineNum">    8311 </span><span class="lineNoCov">          0 :                                 ast_channel_exten_set(chan, old_exten);</span>
<span class="lineNum">    8312 </span><span class="lineNoCov">          0 :                                 ast_channel_priority_set(chan, old_priority);</span>
<span class="lineNum">    8313 </span>            :                         } else {
<span class="lineNum">    8314 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Could not find the Directory application, disabling directory_forward\n&quot;);</span>
<span class="lineNum">    8315 </span><span class="lineNoCov">          0 :                                 ast_clear_flag((&amp;globalflags), VM_DIRECFORWARD);</span>
<span class="lineNum">    8316 </span>            :                         }
<span class="lineNum">    8317 </span>            :                 } else {
<span class="lineNum">    8318 </span>            :                         /* Ask for an extension */
<span class="lineNum">    8319 </span><span class="lineCov">          3 :                         res = ast_streamfile(chan, &quot;vm-extension&quot;, ast_channel_language(chan));       /* &quot;extension&quot; */</span>
<span class="lineNum">    8320 </span><span class="lineCov">          3 :                         prompt_played++;</span>
<span class="lineNum">    8321 </span><span class="lineCov">          3 :                         if (res || prompt_played &gt; 4)</span>
<span class="lineNum">    8322 </span>            :                                 break;
<span class="lineNum">    8323 </span><span class="lineCov">          3 :                         if ((res = ast_readstring(chan, username, sizeof(username) - 1, 2000, 10000, &quot;#&quot;)) &lt; 0)</span>
<span class="lineNum">    8324 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    8325 </span>            :                 }
<span class="lineNum">    8326 </span>            : 
<span class="lineNum">    8327 </span>            :                 /* start all over if no username */
<span class="lineNum">    8328 </span><span class="lineCov">          3 :                 if (ast_strlen_zero(username))</span>
<span class="lineNum">    8329 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    8330 </span><span class="lineCov">          3 :                 stringp = username;</span>
<span class="lineNum">    8331 </span><span class="lineCov">          3 :                 s = strsep(&amp;stringp, &quot;*&quot;);</span>
<span class="lineNum">    8332 </span>            :                 /* start optimistic */
<span class="lineNum">    8333 </span><span class="lineCov">          3 :                 valid_extensions = 1;</span>
<span class="lineNum">    8334 </span><span class="lineCov">          9 :                 while (s) {</span>
<span class="lineNum">    8335 </span><span class="lineCov">          6 :                         snprintf((char*)mailbox_context, sizeof(mailbox_context), &quot;%s@%s&quot;, s, context ? context : &quot;default&quot;);</span>
<span class="lineNum">    8336 </span><span class="lineCov">         12 :                         if ((is_new_message == 1 || strcmp(s, sender-&gt;mailbox)) &amp;&amp; (receiver = find_user(NULL, context, s))) {</span>
<span class="lineNum">    8337 </span>            :                                 int oldmsgs;
<span class="lineNum">    8338 </span>            :                                 int newmsgs;
<span class="lineNum">    8339 </span>            :                                 int capacity;
<span class="lineNum">    8340 </span>            : 
<span class="lineNum">    8341 </span><span class="lineCov">          6 :                                 if (inboxcount(mailbox_context, &amp;newmsgs, &amp;oldmsgs)) {</span>
<span class="lineNum">    8342 </span><span class="lineNoCov">          0 :                                         ast_log(LOG_ERROR, &quot;Problem in calculating number of voicemail messages available for extension %s\n&quot;, mailbox_context);</span>
<span class="lineNum">    8343 </span>            :                                         /* Shouldn't happen, but allow trying another extension if it does */
<span class="lineNum">    8344 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;pbx-invalid&quot;);</span>
<span class="lineNum">    8345 </span><span class="lineNoCov">          0 :                                         valid_extensions = 0;</span>
<span class="lineNum">    8346 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8347 </span>            :                                 }
<span class="lineNum">    8348 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8349 </span>            :                                 if (!(dstvms = get_vm_state_by_mailbox(s, context, 0))) {
<span class="lineNum">    8350 </span>            :                                         if (!(dstvms = create_vm_state_from_user(receiver))) {
<span class="lineNum">    8351 </span>            :                                                 ast_log(AST_LOG_ERROR, &quot;Couldn't allocate necessary space\n&quot;);
<span class="lineNum">    8352 </span>            :                                                 /* Shouldn't happen, but allow trying another extension if it does */
<span class="lineNum">    8353 </span>            :                                                 res = ast_play_and_wait(chan, &quot;pbx-invalid&quot;);
<span class="lineNum">    8354 </span>            :                                                 valid_extensions = 0;
<span class="lineNum">    8355 </span>            :                                                 break;
<span class="lineNum">    8356 </span>            :                                         }
<span class="lineNum">    8357 </span>            :                                 }
<span class="lineNum">    8358 </span>            :                                 check_quota(dstvms, imapfolder);
<span class="lineNum">    8359 </span>            :                                 if (dstvms-&gt;quota_limit &amp;&amp; dstvms-&gt;quota_usage &gt;= dstvms-&gt;quota_limit) {
<span class="lineNum">    8360 </span>            :                                         ast_log(LOG_NOTICE, &quot;Mailbox '%s' is exceeded quota %u &gt;= %u\n&quot;, mailbox_context, dstvms-&gt;quota_usage, dstvms-&gt;quota_limit);
<span class="lineNum">    8361 </span>            :                                         res = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);
<span class="lineNum">    8362 </span>            :                                         valid_extensions = 0;
<span class="lineNum">    8363 </span>            :                                         while ((vmtmp = AST_LIST_REMOVE_HEAD(&amp;extensions, list))) {
<span class="lineNum">    8364 </span>            :                                                 inprocess_count(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);
<span class="lineNum">    8365 </span>            :                                                 free_user(vmtmp);
<span class="lineNum">    8366 </span>            :                                         }
<span class="lineNum">    8367 </span>            :                                         break;
<span class="lineNum">    8368 </span>            :                                 }
<span class="lineNum">    8369 </span>            : #endif
<span class="lineNum">    8370 </span><span class="lineCov">          6 :                                 capacity = receiver-&gt;maxmsg - inprocess_count(receiver-&gt;mailbox, receiver-&gt;context, +1);</span>
<span class="lineNum">    8371 </span><span class="lineCov">          6 :                                 if ((newmsgs + oldmsgs) &gt;= capacity) {</span>
<span class="lineNum">    8372 </span><span class="lineNoCov">          0 :                                         ast_log(LOG_NOTICE, &quot;Mailbox '%s' is full with capacity of %d, prompting for another extension.\n&quot;, mailbox_context, capacity);</span>
<span class="lineNum">    8373 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);</span>
<span class="lineNum">    8374 </span><span class="lineNoCov">          0 :                                         valid_extensions = 0;</span>
<span class="lineNum">    8375 </span><span class="lineNoCov">          0 :                                         while ((vmtmp = AST_LIST_REMOVE_HEAD(&amp;extensions, list))) {</span>
<span class="lineNum">    8376 </span><span class="lineNoCov">          0 :                                                 inprocess_count(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</span>
<span class="lineNum">    8377 </span><span class="lineNoCov">          0 :                                                 free_user(vmtmp);</span>
<span class="lineNum">    8378 </span>            :                                         }
<span class="lineNum">    8379 </span><span class="lineNoCov">          0 :                                         inprocess_count(receiver-&gt;mailbox, receiver-&gt;context, -1);</span>
<span class="lineNum">    8380 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8381 </span>            :                                 }
<span class="lineNum">    8382 </span><span class="lineCov">          6 :                                 AST_LIST_INSERT_HEAD(&amp;extensions, receiver, list);</span>
<span class="lineNum">    8383 </span>            :                         } else {
<span class="lineNum">    8384 </span>            :                                 /* XXX Optimization for the future.  When we encounter a single bad extension,
<span class="lineNum">    8385 </span>            :                                  * bailing out on all of the extensions may not be the way to go.  We should
<span class="lineNum">    8386 </span>            :                                  * probably just bail on that single extension, then allow the user to enter
<span class="lineNum">    8387 </span>            :                                  * several more. XXX
<span class="lineNum">    8388 </span>            :                                  */
<span class="lineNum">    8389 </span><span class="lineNoCov">          0 :                                 while ((receiver = AST_LIST_REMOVE_HEAD(&amp;extensions, list))) {</span>
<span class="lineNum">    8390 </span><span class="lineNoCov">          0 :                                         free_user(receiver);</span>
<span class="lineNum">    8391 </span>            :                                 }
<span class="lineNum">    8392 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_NOTICE, &quot;'%s' is not a valid mailbox\n&quot;, mailbox_context);</span>
<span class="lineNum">    8393 </span>            :                                 /* &quot;I am sorry, that's not a valid extension.  Please try again.&quot; */
<span class="lineNum">    8394 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;pbx-invalid&quot;);</span>
<span class="lineNum">    8395 </span><span class="lineNoCov">          0 :                                 valid_extensions = 0;</span>
<span class="lineNum">    8396 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    8397 </span>            :                         }
<span class="lineNum">    8398 </span>            : 
<span class="lineNum">    8399 </span>            :                         /* play name if available, else play extension number */
<span class="lineNum">    8400 </span><span class="lineCov">          6 :                         snprintf(fn, sizeof(fn), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, receiver-&gt;context, s);</span>
<span class="lineNum">    8401 </span>            :                         RETRIEVE(fn, -1, s, receiver-&gt;context);
<span class="lineNum">    8402 </span><span class="lineCov">          6 :                         if (ast_fileexists(fn, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    8403 </span><span class="lineNoCov">          0 :                                 res = ast_stream_and_wait(chan, fn, ecodes);</span>
<span class="lineNum">    8404 </span><span class="lineNoCov">          0 :                                 if (res) {</span>
<span class="lineNum">    8405 </span>            :                                         DISPOSE(fn, -1);
<span class="lineNum">    8406 </span><span class="lineNoCov">          0 :                                         return res;</span>
<span class="lineNum">    8407 </span>            :                                 }
<span class="lineNum">    8408 </span>            :                         } else {
<span class="lineNum">    8409 </span><span class="lineCov">          6 :                                 res = ast_say_digit_str(chan, s, ecodes, ast_channel_language(chan));</span>
<span class="lineNum">    8410 </span>            :                         }
<span class="lineNum">    8411 </span>            :                         DISPOSE(fn, -1);
<span class="lineNum">    8412 </span>            : 
<span class="lineNum">    8413 </span><span class="lineCov">          6 :                         s = strsep(&amp;stringp, &quot;*&quot;);</span>
<span class="lineNum">    8414 </span>            :                 }
<span class="lineNum">    8415 </span>            :                 /* break from the loop of reading the extensions */
<span class="lineNum">    8416 </span><span class="lineCov">          3 :                 if (valid_extensions)</span>
<span class="lineNum">    8417 </span><span class="lineCov">          3 :                         break;</span>
<span class="lineNum">    8418 </span>            :         }
<span class="lineNum">    8419 </span>            :         /* check if we're clear to proceed */
<span class="lineNum">    8420 </span><span class="lineCov">          3 :         if (AST_LIST_EMPTY(&amp;extensions) || !valid_extensions)</span>
<span class="lineNum">    8421 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    8422 </span><span class="lineCov">          3 :         if (is_new_message == 1) {</span>
<span class="lineNum">    8423 </span>            :                 struct leave_vm_options leave_options;
<span class="lineNum">    8424 </span>            :                 char mailbox[AST_MAX_EXTENSION * 2 + 2];
<span class="lineNum">    8425 </span><span class="lineNoCov">          0 :                 snprintf(mailbox, sizeof(mailbox), &quot;%s@%s&quot;, username, context);</span>
<span class="lineNum">    8426 </span>            : 
<span class="lineNum">    8427 </span>            :                 /* Send VoiceMail */
<span class="lineNum">    8428 </span><span class="lineNoCov">          0 :                 memset(&amp;leave_options, 0, sizeof(leave_options));</span>
<span class="lineNum">    8429 </span><span class="lineNoCov">          0 :                 leave_options.record_gain = record_gain;</span>
<span class="lineNum">    8430 </span><span class="lineNoCov">          0 :                 cmd = leave_voicemail(chan, mailbox, &amp;leave_options);</span>
<span class="lineNum">    8431 </span>            :         } else {
<span class="lineNum">    8432 </span>            :                 /* Forward VoiceMail */
<span class="lineNum">    8433 </span><span class="lineCov">          3 :                 long duration = 0;</span>
<span class="lineNum">    8434 </span>            :                 struct vm_state vmstmp;
<span class="lineNum">    8435 </span><span class="lineCov">          3 :                 int copy_msg_result = 0;</span>
<span class="lineNum">    8436 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8437 </span>            :                 char filename[PATH_MAX];
<span class="lineNum">    8438 </span>            :                 struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };
<span class="lineNum">    8439 </span>            :                 const char *msg_id = NULL;
<span class="lineNum">    8440 </span>            :                 struct ast_config *msg_cfg;
<span class="lineNum">    8441 </span>            : #endif
<span class="lineNum">    8442 </span><span class="lineCov">          3 :                 memcpy(&amp;vmstmp, vms, sizeof(vmstmp));</span>
<span class="lineNum">    8443 </span>            : 
<span class="lineNum">    8444 </span>            :                 RETRIEVE(dir, curmsg, sender-&gt;mailbox, sender-&gt;context);
<span class="lineNum">    8445 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8446 </span>            :                 make_file(filename, sizeof(filename), dir, curmsg);
<span class="lineNum">    8447 </span>            :                 strncat(filename, &quot;.txt&quot;, sizeof(filename) - strlen(filename) - 1);
<span class="lineNum">    8448 </span>            :                 msg_cfg = ast_config_load(filename, config_flags);
<span class="lineNum">    8449 </span>            :                 if (msg_cfg &amp;&amp; msg_cfg == CONFIG_STATUS_FILEINVALID) {
<span class="lineNum">    8450 </span>            :                         msg_id = ast_strdupa(ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;msg_id&quot;));
<span class="lineNum">    8451 </span>            :                         ast_config_destroy(msg_cfg);
<span class="lineNum">    8452 </span>            :                 }
<span class="lineNum">    8453 </span>            : #endif
<span class="lineNum">    8454 </span>            : 
<span class="lineNum">    8455 </span><span class="lineCov">          3 :                 cmd = vm_forwardoptions(chan, sender, vmstmp.curdir, curmsg, vmfmts, S_OR(context, &quot;default&quot;), record_gain, &amp;duration, &amp;vmstmp, urgent_str);</span>
<span class="lineNum">    8456 </span><span class="lineCov">          3 :                 if (!cmd) {</span>
<span class="lineNum">    8457 </span><span class="lineCov">          6 :                         AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;extensions, vmtmp, list) {</span>
<span class="lineNum">    8458 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8459 </span>            :                                 int attach_user_voicemail;
<span class="lineNum">    8460 </span>            :                                 char *myserveremail = serveremail;
<span class="lineNum">    8461 </span>            : 
<span class="lineNum">    8462 </span>            :                                 /* get destination mailbox */
<span class="lineNum">    8463 </span>            :                                 dstvms = get_vm_state_by_mailbox(vmtmp-&gt;mailbox, vmtmp-&gt;context, 0);
<span class="lineNum">    8464 </span>            :                                 if (!dstvms) {
<span class="lineNum">    8465 </span>            :                                         dstvms = create_vm_state_from_user(vmtmp);
<span class="lineNum">    8466 </span>            :                                 }
<span class="lineNum">    8467 </span>            :                                 if (dstvms) {
<span class="lineNum">    8468 </span>            :                                         init_mailstream(dstvms, 0);
<span class="lineNum">    8469 </span>            :                                         if (!dstvms-&gt;mailstream) {
<span class="lineNum">    8470 </span>            :                                                 ast_log(AST_LOG_ERROR, &quot;IMAP mailstream for %s is NULL\n&quot;, vmtmp-&gt;mailbox);
<span class="lineNum">    8471 </span>            :                                         } else {
<span class="lineNum">    8472 </span>            :                                                 copy_msg_result = STORE(vmstmp.curdir, vmtmp-&gt;mailbox, vmtmp-&gt;context, curmsg, chan, vmtmp, fmt, duration, dstvms, urgent_str, msg_id);
<span class="lineNum">    8473 </span>            :                                                 run_externnotify(vmtmp-&gt;context, vmtmp-&gt;mailbox, urgent_str);
<span class="lineNum">    8474 </span>            :                                         }
<span class="lineNum">    8475 </span>            :                                 } else {
<span class="lineNum">    8476 </span>            :                                         ast_log(AST_LOG_ERROR, &quot;Could not find state information for mailbox %s\n&quot;, vmtmp-&gt;mailbox);
<span class="lineNum">    8477 </span>            :                                 }
<span class="lineNum">    8478 </span>            :                                 if (!ast_strlen_zero(vmtmp-&gt;serveremail))
<span class="lineNum">    8479 </span>            :                                         myserveremail = vmtmp-&gt;serveremail;
<span class="lineNum">    8480 </span>            :                                 attach_user_voicemail = ast_test_flag(vmtmp, VM_ATTACH);
<span class="lineNum">    8481 </span>            :                                 /* NULL category for IMAP storage */
<span class="lineNum">    8482 </span>            :                                 sendmail(myserveremail, vmtmp, todircount, vmtmp-&gt;context, vmtmp-&gt;mailbox,
<span class="lineNum">    8483 </span>            :                                         dstvms-&gt;curbox,
<span class="lineNum">    8484 </span>            :                                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL),
<span class="lineNum">    8485 </span>            :                                         S_COR(ast_channel_caller(chan)-&gt;id.name.valid, ast_channel_caller(chan)-&gt;id.name.str, NULL),
<span class="lineNum">    8486 </span>            :                                         vmstmp.fn, vmstmp.introfn, fmt, duration, attach_user_voicemail, chan,
<span class="lineNum">    8487 </span>            :                                         NULL, urgent_str, msg_id);
<span class="lineNum">    8488 </span>            : #else
<span class="lineNum">    8489 </span><span class="lineCov">          4 :                                 copy_msg_result = copy_message(chan, sender, 0, curmsg, duration, vmtmp, fmt, dir, urgent_str, NULL);</span>
<span class="lineNum">    8490 </span>            : #endif
<span class="lineNum">    8491 </span><span class="lineCov">          4 :                                 saved_messages++;</span>
<span class="lineNum">    8492 </span><span class="lineCov">          4 :                                 AST_LIST_REMOVE_CURRENT(list);</span>
<span class="lineNum">    8493 </span><span class="lineCov">          4 :                                 inprocess_count(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</span>
<span class="lineNum">    8494 </span><span class="lineCov">          4 :                                 free_user(vmtmp);</span>
<span class="lineNum">    8495 </span><span class="lineCov">          4 :                                 if (res)</span>
<span class="lineNum">    8496 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    8497 </span>            :                         }
<span class="lineNum">    8498 </span>            :                         AST_LIST_TRAVERSE_SAFE_END;
<span class="lineNum">    8499 </span><span class="lineCov">          2 :                         if (saved_messages &gt; 0 &amp;&amp; !copy_msg_result) {</span>
<span class="lineNum">    8500 </span>            :                                 /* give confirmation that the message was saved */
<span class="lineNum">    8501 </span>            :                                 /* commented out since we can't forward batches yet
<span class="lineNum">    8502 </span>            :                                 if (saved_messages == 1)
<span class="lineNum">    8503 </span>            :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);
<span class="lineNum">    8504 </span>            :                                 else
<span class="lineNum">    8505 </span>            :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);
<span class="lineNum">    8506 </span>            :                                 if (!res)
<span class="lineNum">    8507 </span>            :                                         res = ast_play_and_wait(chan, &quot;vm-saved&quot;); */
<span class="lineNum">    8508 </span><span class="lineCov">          2 :                                 res = ast_play_and_wait(chan, &quot;vm-msgforwarded&quot;);</span>
<span class="lineNum">    8509 </span>            :                         }
<span class="lineNum">    8510 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    8511 </span>            :                         else {
<span class="lineNum">    8512 </span>            :                                 /* with IMAP, mailbox full warning played by imap_check_limits */
<span class="lineNum">    8513 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);</span>
<span class="lineNum">    8514 </span>            :                         }
<span class="lineNum">    8515 </span>            :                         /* Restore original message without prepended message if backup exists */
<span class="lineNum">    8516 </span><span class="lineCov">          2 :                         make_file(msgfile, sizeof(msgfile), dir, curmsg);</span>
<span class="lineNum">    8517 </span><span class="lineCov">          2 :                         strcpy(textfile, msgfile);</span>
<span class="lineNum">    8518 </span><span class="lineCov">          2 :                         strcpy(backup, msgfile);</span>
<span class="lineNum">    8519 </span><span class="lineCov">          2 :                         strcpy(backup_textfile, msgfile);</span>
<span class="lineNum">    8520 </span><span class="lineCov">          2 :                         strncat(textfile, &quot;.txt&quot;, sizeof(textfile) - strlen(textfile) - 1);</span>
<span class="lineNum">    8521 </span><span class="lineCov">          2 :                         strncat(backup, &quot;-bak&quot;, sizeof(backup) - strlen(backup) - 1);</span>
<span class="lineNum">    8522 </span><span class="lineCov">          2 :                         strncat(backup_textfile, &quot;-bak.txt&quot;, sizeof(backup_textfile) - strlen(backup_textfile) - 1);</span>
<span class="lineNum">    8523 </span><span class="lineCov">          2 :                         if (ast_fileexists(backup, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    8524 </span><span class="lineCov">          1 :                                 ast_filerename(backup, msgfile, NULL);</span>
<span class="lineNum">    8525 </span><span class="lineCov">          1 :                                 rename(backup_textfile, textfile);</span>
<span class="lineNum">    8526 </span>            :                         }
<span class="lineNum">    8527 </span>            : #endif
<span class="lineNum">    8528 </span>            :                 }
<span class="lineNum">    8529 </span>            :                 DISPOSE(dir, curmsg);
<span class="lineNum">    8530 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    8531 </span><span class="lineCov">          3 :                 if (cmd) { /* assuming hangup, cleanup backup file */</span>
<span class="lineNum">    8532 </span><span class="lineCov">          1 :                         make_file(msgfile, sizeof(msgfile), dir, curmsg);</span>
<span class="lineNum">    8533 </span><span class="lineCov">          1 :                         strcpy(textfile, msgfile);</span>
<span class="lineNum">    8534 </span><span class="lineCov">          1 :                         strcpy(backup_textfile, msgfile);</span>
<span class="lineNum">    8535 </span><span class="lineCov">          1 :                         strncat(textfile, &quot;.txt&quot;, sizeof(textfile) - strlen(textfile) - 1);</span>
<span class="lineNum">    8536 </span><span class="lineCov">          1 :                         strncat(backup_textfile, &quot;-bak.txt&quot;, sizeof(backup_textfile) - strlen(backup_textfile) - 1);</span>
<span class="lineNum">    8537 </span><span class="lineCov">          1 :                         rename(backup_textfile, textfile);</span>
<span class="lineNum">    8538 </span>            :                 }
<span class="lineNum">    8539 </span>            : #endif
<span class="lineNum">    8540 </span>            :         }
<span class="lineNum">    8541 </span>            : 
<span class="lineNum">    8542 </span>            :         /* If anything failed above, we still have this list to free */
<span class="lineNum">    8543 </span><span class="lineCov">          5 :         while ((vmtmp = AST_LIST_REMOVE_HEAD(&amp;extensions, list))) {</span>
<span class="lineNum">    8544 </span><span class="lineCov">          2 :                 inprocess_count(vmtmp-&gt;mailbox, vmtmp-&gt;context, -1);</span>
<span class="lineNum">    8545 </span><span class="lineCov">          2 :                 free_user(vmtmp);</span>
<span class="lineNum">    8546 </span>            :         }
<span class="lineNum">    8547 </span><span class="lineCov">          3 :         return res ? res : cmd;</span>
<a name="8548"><span class="lineNum">    8548 </span>            : }</a>
<span class="lineNum">    8549 </span>            : 
<span class="lineNum">    8550 </span><span class="lineCov">         28 : static int wait_file2(struct ast_channel *chan, struct vm_state *vms, char *file)</span>
<span class="lineNum">    8551 </span>            : {
<span class="lineNum">    8552 </span>            :         int res;
<span class="lineNum">    8553 </span><span class="lineCov">         28 :         if ((res = ast_stream_and_wait(chan, file, AST_DIGIT_ANY)) &lt; 0)</span>
<span class="lineNum">    8554 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Unable to play message %s\n&quot;, file);</span>
<span class="lineNum">    8555 </span><span class="lineCov">         28 :         return res;</span>
<a name="8556"><span class="lineNum">    8556 </span>            : }</a>
<span class="lineNum">    8557 </span>            : 
<span class="lineNum">    8558 </span><span class="lineCov">         17 : static int wait_file(struct ast_channel *chan, struct vm_state *vms, char *file)</span>
<span class="lineNum">    8559 </span>            : {
<span class="lineNum">    8560 </span><span class="lineCov">         17 :         ast_test_suite_event_notify(&quot;PLAYVOICE&quot;, &quot;Message: Playing %s&quot;, file);</span>
<span class="lineNum">    8561 </span><span class="lineCov">         17 :         return ast_control_streamfile(chan, file, listen_control_forward_key, listen_control_reverse_key, listen_control_stop_key, listen_control_pause_key, listen_control_restart_key, skipms, NULL);</span>
<a name="8562"><span class="lineNum">    8562 </span>            : }</a>
<span class="lineNum">    8563 </span>            : 
<span class="lineNum">    8564 </span><span class="lineCov">         12 : static int play_message_category(struct ast_channel *chan, const char *category)</span>
<span class="lineNum">    8565 </span>            : {
<span class="lineNum">    8566 </span><span class="lineCov">         12 :         int res = 0;</span>
<span class="lineNum">    8567 </span>            : 
<span class="lineNum">    8568 </span><span class="lineCov">         12 :         if (!ast_strlen_zero(category))</span>
<span class="lineNum">    8569 </span><span class="lineCov">         12 :                 res = ast_play_and_wait(chan, category);</span>
<span class="lineNum">    8570 </span>            : 
<span class="lineNum">    8571 </span><span class="lineCov">         12 :         if (res) {</span>
<span class="lineNum">    8572 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No sound file for category '%s' was found.\n&quot;, category);</span>
<span class="lineNum">    8573 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">    8574 </span>            :         }
<span class="lineNum">    8575 </span>            : 
<span class="lineNum">    8576 </span><span class="lineCov">         12 :         return res;</span>
<a name="8577"><span class="lineNum">    8577 </span>            : }</a>
<span class="lineNum">    8578 </span>            : 
<span class="lineNum">    8579 </span><span class="lineCov">         12 : static int play_message_datetime(struct ast_channel *chan, struct ast_vm_user *vmu, const char *origtime, const char *filename)</span>
<span class="lineNum">    8580 </span>            : {
<span class="lineNum">    8581 </span><span class="lineCov">         12 :         int res = 0;</span>
<span class="lineNum">    8582 </span><span class="lineCov">         12 :         struct vm_zone *the_zone = NULL;</span>
<span class="lineNum">    8583 </span>            :         time_t t;
<span class="lineNum">    8584 </span>            : 
<span class="lineNum">    8585 </span><span class="lineCov">         12 :         if (ast_get_time_t(origtime, &amp;t, 0, NULL)) {</span>
<span class="lineNum">    8586 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Couldn't find origtime in %s\n&quot;, filename);</span>
<span class="lineNum">    8587 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    8588 </span>            :         }
<span class="lineNum">    8589 </span>            : 
<span class="lineNum">    8590 </span>            :         /* Does this user have a timezone specified? */
<span class="lineNum">    8591 </span><span class="lineCov">         12 :         if (!ast_strlen_zero(vmu-&gt;zonetag)) {</span>
<span class="lineNum">    8592 </span>            :                 /* Find the zone in the list */
<span class="lineNum">    8593 </span>            :                 struct vm_zone *z;
<span class="lineNum">    8594 </span><span class="lineNoCov">          0 :                 AST_LIST_LOCK(&amp;zones);</span>
<span class="lineNum">    8595 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;zones, z, list) {</span>
<span class="lineNum">    8596 </span><span class="lineNoCov">          0 :                         if (!strcmp(z-&gt;name, vmu-&gt;zonetag)) {</span>
<span class="lineNum">    8597 </span><span class="lineNoCov">          0 :                                 the_zone = z;</span>
<span class="lineNum">    8598 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    8599 </span>            :                         }
<span class="lineNum">    8600 </span>            :                 }
<span class="lineNum">    8601 </span><span class="lineNoCov">          0 :                 AST_LIST_UNLOCK(&amp;zones);</span>
<span class="lineNum">    8602 </span>            :         }
<span class="lineNum">    8603 </span>            : 
<span class="lineNum">    8604 </span>            : /* No internal variable parsing for now, so we'll comment it out for the time being */
<span class="lineNum">    8605 </span>            : #if 0
<span class="lineNum">    8606 </span>            :         /* Set the DIFF_* variables */
<span class="lineNum">    8607 </span>            :         ast_localtime(&amp;t, &amp;time_now, NULL);
<span class="lineNum">    8608 </span>            :         tv_now = ast_tvnow();
<span class="lineNum">    8609 </span>            :         ast_localtime(&amp;tv_now, &amp;time_then, NULL);
<span class="lineNum">    8610 </span>            : 
<span class="lineNum">    8611 </span>            :         /* Day difference */
<span class="lineNum">    8612 </span>            :         if (time_now.tm_year == time_then.tm_year)
<span class="lineNum">    8613 </span>            :                 snprintf(temp, sizeof(temp), &quot;%d&quot;, time_now.tm_yday);
<span class="lineNum">    8614 </span>            :         else
<span class="lineNum">    8615 </span>            :                 snprintf(temp, sizeof(temp), &quot;%d&quot;, (time_now.tm_year - time_then.tm_year) * 365 + (time_now.tm_yday - time_then.tm_yday));
<span class="lineNum">    8616 </span>            :         pbx_builtin_setvar_helper(chan, &quot;DIFF_DAY&quot;, temp);
<span class="lineNum">    8617 </span>            : 
<span class="lineNum">    8618 </span>            :         /* Can't think of how other diffs might be helpful, but I'm sure somebody will think of something. */
<span class="lineNum">    8619 </span>            : #endif
<span class="lineNum">    8620 </span><span class="lineCov">         12 :         if (the_zone) {</span>
<span class="lineNum">    8621 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), the_zone-&gt;msg_format, the_zone-&gt;timezone);</span>
<span class="lineNum">    8622 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;de&quot;, 2)) {     /* GERMAN syntax */</span>
<span class="lineNum">    8623 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' Q 'digits/at' HM&quot;, NULL);</span>
<span class="lineNum">    8624 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;gr&quot;, 2)) {     /* GREEK syntax */</span>
<span class="lineNum">    8625 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' q  H 'digits/kai' M &quot;, NULL);</span>
<span class="lineNum">    8626 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;is&quot;, 2)) {     /* ICELANDIC syntax */</span>
<span class="lineNum">    8627 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' Q 'digits/at' HM&quot;, NULL);</span>
<span class="lineNum">    8628 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;it&quot;, 2)) {     /* ITALIAN syntax */</span>
<span class="lineNum">    8629 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' q 'digits/at' 'digits/hours' k 'digits/e' M 'digits/minutes'&quot;, NULL);</span>
<span class="lineNum">    8630 </span><span class="lineCov">         12 :         } else if (!strcasecmp(ast_channel_language(chan),&quot;ja&quot;)) {     /* Japanese syntax */</span>
<span class="lineNum">    8631 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;PHM q 'jp-ni' 'vm-received'&quot;, NULL);</span>
<span class="lineNum">    8632 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;nl&quot;, 2)) {     /* DUTCH syntax */</span>
<span class="lineNum">    8633 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' q 'digits/nl-om' HM&quot;, NULL);</span>
<span class="lineNum">    8634 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;no&quot;, 2)) {     /* NORWEGIAN syntax */</span>
<span class="lineNum">    8635 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' Q 'digits/at' HM&quot;, NULL);</span>
<span class="lineNum">    8636 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pl&quot;, 2)) {     /* POLISH syntax */</span>
<span class="lineNum">    8637 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' Q HM&quot;, NULL);</span>
<span class="lineNum">    8638 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pt_BR&quot;, 5)) {  /* Brazillian PORTUGUESE syntax */</span>
<span class="lineNum">    8639 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' Ad 'digits/pt-de' B 'digits/pt-de' Y 'digits/pt-as' HM &quot;, NULL);</span>
<span class="lineNum">    8640 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;se&quot;, 2)) {     /* SWEDISH syntax */</span>
<span class="lineNum">    8641 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' dB 'digits/at' k 'and' M&quot;, NULL);</span>
<span class="lineNum">    8642 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;zh&quot;, 2)) {     /* CHINESE (Taiwan) syntax */</span>
<span class="lineNum">    8643 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;qR 'vm-received'&quot;, NULL);</span>
<span class="lineNum">    8644 </span><span class="lineCov">         12 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;vi&quot;, 2)) {     /* VIETNAMESE syntax */</span>
<span class="lineNum">    8645 </span><span class="lineNoCov">          0 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' A 'digits/day' dB 'digits/year' Y 'digits/at' k 'hours' M 'minutes'&quot;, NULL);</span>
<span class="lineNum">    8646 </span>            :         } else {
<span class="lineNum">    8647 </span><span class="lineCov">         12 :                 res = ast_say_date_with_format(chan, t, AST_DIGIT_ANY, ast_channel_language(chan), &quot;'vm-received' q 'digits/at' IMp&quot;, NULL);</span>
<span class="lineNum">    8648 </span>            :         }
<span class="lineNum">    8649 </span>            : #if 0
<span class="lineNum">    8650 </span>            :         pbx_builtin_setvar_helper(chan, &quot;DIFF_DAY&quot;, NULL);
<span class="lineNum">    8651 </span>            : #endif
<span class="lineNum">    8652 </span><span class="lineCov">         12 :         return res;</span>
<span class="lineNum">    8653 </span>            : }
<span class="lineNum">    8654 </span>            : 
<a name="8655"><span class="lineNum">    8655 </span>            : </a>
<span class="lineNum">    8656 </span>            : 
<span class="lineNum">    8657 </span><span class="lineCov">          1 : static int play_message_callerid(struct ast_channel *chan, struct vm_state *vms, char *cid, const char *context, int callback, int saycidnumber)</span>
<span class="lineNum">    8658 </span>            : {
<span class="lineNum">    8659 </span><span class="lineCov">          1 :         int res = 0;</span>
<span class="lineNum">    8660 </span>            :         int i;
<span class="lineNum">    8661 </span>            :         char *callerid, *name;
<span class="lineNum">    8662 </span><span class="lineCov">          1 :         char prefile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">    8663 </span>            : 
<span class="lineNum">    8664 </span>            :         /* If voicemail cid is not enabled, or we didn't get cid or context from
<span class="lineNum">    8665 </span>            :          * the attribute file, leave now.
<span class="lineNum">    8666 </span>            :          *
<span class="lineNum">    8667 </span>            :          * TODO Still need to change this so that if this function is called by the
<span class="lineNum">    8668 </span>            :          * message envelope (and someone is explicitly requesting to hear the CID),
<span class="lineNum">    8669 </span>            :          * it does not check to see if CID is enabled in the config file.
<span class="lineNum">    8670 </span>            :          */
<span class="lineNum">    8671 </span><span class="lineCov">          1 :         if ((cid == NULL)||(context == NULL))</span>
<span class="lineNum">    8672 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    8673 </span>            : 
<span class="lineNum">    8674 </span>            :         /* Strip off caller ID number from name */
<span class="lineNum">    8675 </span><span class="lineCov">          1 :         ast_debug(1, &quot;VM-CID: composite caller ID received: %s, context: %s\n&quot;, cid, context);</span>
<span class="lineNum">    8676 </span><span class="lineCov">          1 :         ast_callerid_parse(cid, &amp;name, &amp;callerid);</span>
<span class="lineNum">    8677 </span><span class="lineCov">          1 :         if ((!ast_strlen_zero(callerid)) &amp;&amp; strcmp(callerid, &quot;Unknown&quot;)) {</span>
<span class="lineNum">    8678 </span>            :                 /* Check for internal contexts and only */
<span class="lineNum">    8679 </span>            :                 /* say extension when the call didn't come from an internal context in the list */
<span class="lineNum">    8680 </span><span class="lineCov">         11 :                 for (i = 0 ; i &lt; MAX_NUM_CID_CONTEXTS ; i++){</span>
<span class="lineNum">    8681 </span><span class="lineCov">         10 :                         ast_debug(1, &quot;VM-CID: comparing internalcontext: %s\n&quot;, cidinternalcontexts[i]);</span>
<span class="lineNum">    8682 </span><span class="lineCov">         10 :                         if ((strcmp(cidinternalcontexts[i], context) == 0))</span>
<span class="lineNum">    8683 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    8684 </span>            :                 }
<span class="lineNum">    8685 </span><span class="lineCov">          2 :                 if (i != MAX_NUM_CID_CONTEXTS){ /* internal context? */</span>
<span class="lineNum">    8686 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    8687 </span><span class="lineNoCov">          0 :                                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, context, callerid);</span>
<span class="lineNum">    8688 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(prefile)) {</span>
<span class="lineNum">    8689 </span>            :                                         /* See if we can find a recorded name for this callerid
<span class="lineNum">    8690 </span>            :                                          * and if found, use that instead of saying number. */
<span class="lineNum">    8691 </span><span class="lineNoCov">          0 :                                         if (ast_fileexists(prefile, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    8692 </span><span class="lineNoCov">          0 :                                                 ast_verb(3, &quot;Playing envelope info: CID number '%s' matches mailbox number, playing recorded name\n&quot;, callerid);</span>
<span class="lineNum">    8693 </span><span class="lineNoCov">          0 :                                                 if (!callback)</span>
<span class="lineNum">    8694 </span><span class="lineNoCov">          0 :                                                         res = wait_file2(chan, vms, &quot;vm-from&quot;);</span>
<span class="lineNum">    8695 </span><span class="lineNoCov">          0 :                                                 res = ast_stream_and_wait(chan, prefile, &quot;&quot;);</span>
<span class="lineNum">    8696 </span>            :                                         } else {
<span class="lineNum">    8697 </span><span class="lineNoCov">          0 :                                                 ast_verb(3, &quot;Playing envelope info: message from '%s'\n&quot;, callerid);</span>
<span class="lineNum">    8698 </span>            :                                                 /* Say &quot;from extension&quot; as one saying to sound smoother */
<span class="lineNum">    8699 </span><span class="lineNoCov">          0 :                                                 if (!callback)</span>
<span class="lineNum">    8700 </span><span class="lineNoCov">          0 :                                                         res = wait_file2(chan, vms, &quot;vm-from-extension&quot;);</span>
<span class="lineNum">    8701 </span><span class="lineNoCov">          0 :                                                 res = ast_say_digit_str(chan, callerid, &quot;&quot;, ast_channel_language(chan));</span>
<span class="lineNum">    8702 </span>            :                                         }
<span class="lineNum">    8703 </span>            :                                 }
<span class="lineNum">    8704 </span>            :                         }
<span class="lineNum">    8705 </span><span class="lineCov">          1 :                 } else if (!res) {</span>
<span class="lineNum">    8706 </span><span class="lineCov">          1 :                         ast_debug(1, &quot;VM-CID: Numeric caller id: (%s)\n&quot;, callerid);</span>
<span class="lineNum">    8707 </span>            :                         /* If there is a recording for this numeric callerid then play that */
<span class="lineNum">    8708 </span><span class="lineCov">          1 :                         if (!callback) {</span>
<span class="lineNum">    8709 </span>            :                                 /* See if we can find a recorded name for this person instead of their extension number */
<span class="lineNum">    8710 </span><span class="lineCov">          1 :                                 snprintf(prefile, sizeof(prefile), &quot;%s/recordings/callerids/%s&quot;, ast_config_AST_SPOOL_DIR, callerid);</span>
<span class="lineNum">    8711 </span><span class="lineCov">          1 :                                 if (!saycidnumber &amp;&amp; ast_fileexists(prefile, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">    8712 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;Playing recorded name for CID number '%s' - '%s'\n&quot;, callerid,prefile);</span>
<span class="lineNum">    8713 </span><span class="lineNoCov">          0 :                                         wait_file2(chan, vms, &quot;vm-from&quot;);</span>
<span class="lineNum">    8714 </span><span class="lineNoCov">          0 :                                         res = ast_stream_and_wait(chan, prefile, &quot;&quot;);</span>
<span class="lineNum">    8715 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;Played recorded name result '%d'\n&quot;, res);</span>
<span class="lineNum">    8716 </span>            :                                 } else {
<span class="lineNum">    8717 </span>            :                                         /* Since this is all nicely figured out, why not say &quot;from phone number&quot; in this case&quot; */
<span class="lineNum">    8718 </span><span class="lineCov">          1 :                                         wait_file2(chan, vms, &quot;vm-from-phonenumber&quot;);</span>
<span class="lineNum">    8719 </span><span class="lineCov">          1 :                                         res = ast_say_digit_str(chan, callerid, AST_DIGIT_ANY, ast_channel_language(chan));</span>
<span class="lineNum">    8720 </span>            :                                 }
<span class="lineNum">    8721 </span>            :                         } else {
<span class="lineNum">    8722 </span><span class="lineNoCov">          0 :                                 res = ast_say_digit_str(chan, callerid, AST_DIGIT_ANY, ast_channel_language(chan));</span>
<span class="lineNum">    8723 </span>            :                         }
<span class="lineNum">    8724 </span>            :                 }
<span class="lineNum">    8725 </span>            :         } else {
<span class="lineNum">    8726 </span>            :                 /* Number unknown */
<span class="lineNum">    8727 </span><span class="lineNoCov">          0 :                 ast_debug(1, &quot;VM-CID: From an unknown number\n&quot;);</span>
<span class="lineNum">    8728 </span>            :                 /* Say &quot;from an unknown caller&quot; as one phrase - it is already recorded by &quot;the voice&quot; anyhow */
<span class="lineNum">    8729 </span><span class="lineNoCov">          0 :                 res = wait_file2(chan, vms, &quot;vm-unknown-caller&quot;);</span>
<span class="lineNum">    8730 </span>            :         }
<span class="lineNum">    8731 </span><span class="lineCov">          1 :         return res;</span>
<a name="8732"><span class="lineNum">    8732 </span>            : }</a>
<span class="lineNum">    8733 </span>            : 
<span class="lineNum">    8734 </span><span class="lineCov">         12 : static int play_message_duration(struct ast_channel *chan, struct vm_state *vms, const char *duration, int minduration)</span>
<span class="lineNum">    8735 </span>            : {
<span class="lineNum">    8736 </span><span class="lineCov">         12 :         int res = 0;</span>
<span class="lineNum">    8737 </span>            :         int durationm;
<span class="lineNum">    8738 </span>            :         int durations;
<span class="lineNum">    8739 </span>            :         /* Verify that we have a duration for the message */
<span class="lineNum">    8740 </span><span class="lineCov">         12 :         if (duration == NULL)</span>
<span class="lineNum">    8741 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    8742 </span>            : 
<span class="lineNum">    8743 </span>            :         /* Convert from seconds to minutes */
<span class="lineNum">    8744 </span><span class="lineCov">         12 :         durations = atoi(duration);</span>
<span class="lineNum">    8745 </span><span class="lineCov">         12 :         durationm = (durations / 60);</span>
<span class="lineNum">    8746 </span>            : 
<span class="lineNum">    8747 </span><span class="lineCov">         12 :         ast_debug(1, &quot;VM-Duration: duration is: %d seconds converted to: %d minutes\n&quot;, durations, durationm);</span>
<span class="lineNum">    8748 </span>            : 
<span class="lineNum">    8749 </span><span class="lineCov">         12 :         if ((!res) &amp;&amp; (durationm &gt;= minduration)) {</span>
<span class="lineNum">    8750 </span><span class="lineCov">          1 :                 res = wait_file2(chan, vms, &quot;vm-duration&quot;);</span>
<span class="lineNum">    8751 </span>            : 
<span class="lineNum">    8752 </span>            :                 /* POLISH syntax */
<span class="lineNum">    8753 </span><span class="lineCov">          1 :                 if (!strncasecmp(ast_channel_language(chan), &quot;pl&quot;, 2)) {</span>
<span class="lineNum">    8754 </span><span class="lineNoCov">          0 :                         div_t num = div(durationm, 10);</span>
<span class="lineNum">    8755 </span>            : 
<span class="lineNum">    8756 </span><span class="lineNoCov">          0 :                         if (durationm == 1) {</span>
<span class="lineNum">    8757 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;digits/1z&quot;);</span>
<span class="lineNum">    8758 </span><span class="lineNoCov">          0 :                                 res = res ? res : ast_play_and_wait(chan, &quot;vm-minute-ta&quot;);</span>
<span class="lineNum">    8759 </span><span class="lineNoCov">          0 :                         } else if (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</span>
<span class="lineNum">    8760 </span><span class="lineNoCov">          0 :                                 if (num.rem == 2) {</span>
<span class="lineNum">    8761 </span><span class="lineNoCov">          0 :                                         if (!num.quot) {</span>
<span class="lineNum">    8762 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    8763 </span>            :                                         } else {
<span class="lineNum">    8764 </span><span class="lineNoCov">          0 :                                                 res = say_and_wait(chan, durationm - 2 , ast_channel_language(chan));</span>
<span class="lineNum">    8765 </span><span class="lineNoCov">          0 :                                                 res = res ? res : ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    8766 </span>            :                                         }
<span class="lineNum">    8767 </span>            :                                 } else {
<span class="lineNum">    8768 </span><span class="lineNoCov">          0 :                                         res = say_and_wait(chan, durationm, ast_channel_language(chan));</span>
<span class="lineNum">    8769 </span>            :                                 }
<span class="lineNum">    8770 </span><span class="lineNoCov">          0 :                                 res = res ? res : ast_play_and_wait(chan, &quot;vm-minute-ty&quot;);</span>
<span class="lineNum">    8771 </span>            :                         } else {
<span class="lineNum">    8772 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, durationm, ast_channel_language(chan));</span>
<span class="lineNum">    8773 </span><span class="lineNoCov">          0 :                                 res = res ? res : ast_play_and_wait(chan, &quot;vm-minute-t&quot;);</span>
<span class="lineNum">    8774 </span>            :                         }
<span class="lineNum">    8775 </span>            :                 /* DEFAULT syntax */
<span class="lineNum">    8776 </span>            :                 } else {
<span class="lineNum">    8777 </span><span class="lineCov">          1 :                         res = ast_say_number(chan, durationm, AST_DIGIT_ANY, ast_channel_language(chan), NULL);</span>
<span class="lineNum">    8778 </span><span class="lineCov">          1 :                         res = wait_file2(chan, vms, &quot;vm-minutes&quot;);</span>
<span class="lineNum">    8779 </span>            :                 }
<span class="lineNum">    8780 </span>            :         }
<span class="lineNum">    8781 </span><span class="lineCov">         12 :         return res;</span>
<a name="8782"><span class="lineNum">    8782 </span>            : }</a>
<span class="lineNum">    8783 </span>            : 
<span class="lineNum">    8784 </span><span class="lineCov">         12 : static int play_message(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms)</span>
<span class="lineNum">    8785 </span>            : {
<span class="lineNum">    8786 </span><span class="lineCov">         12 :         int res = 0;</span>
<span class="lineNum">    8787 </span>            :         char filename[PATH_MAX], *cid;
<span class="lineNum">    8788 </span>            :         const char *origtime, *context, *category, *duration, *flag;
<span class="lineNum">    8789 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">    8790 </span><span class="lineCov">         12 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">    8791 </span>            : 
<span class="lineNum">    8792 </span><span class="lineCov">         12 :         vms-&gt;starting = 0;</span>
<span class="lineNum">    8793 </span><span class="lineCov">         12 :         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">    8794 </span><span class="lineCov">         12 :         adsi_message(chan, vms);</span>
<span class="lineNum">    8795 </span><span class="lineCov">         12 :         if (!vms-&gt;curmsg) {</span>
<span class="lineNum">    8796 </span><span class="lineCov">         10 :                 res = wait_file2(chan, vms, &quot;vm-first&quot;);      /* &quot;First&quot; */</span>
<span class="lineNum">    8797 </span><span class="lineCov">          2 :         } else if (vms-&gt;curmsg == vms-&gt;lastmsg) {</span>
<span class="lineNum">    8798 </span><span class="lineCov">          2 :                 res = wait_file2(chan, vms, &quot;vm-last&quot;);               /* &quot;last&quot; */</span>
<span class="lineNum">    8799 </span>            :         }
<span class="lineNum">    8800 </span>            : 
<span class="lineNum">    8801 </span><span class="lineCov">         12 :         snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, vms-&gt;fn);</span>
<span class="lineNum">    8802 </span>            :         RETRIEVE(vms-&gt;curdir, vms-&gt;curmsg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">    8803 </span><span class="lineCov">         12 :         msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">    8804 </span><span class="lineCov">         12 :         if (!valid_config(msg_cfg)) {</span>
<span class="lineNum">    8805 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;No message attribute file?!! (%s)\n&quot;, filename);</span>
<span class="lineNum">    8806 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    8807 </span>            :         }
<span class="lineNum">    8808 </span><span class="lineCov">         12 :         flag = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;flag&quot;);</span>
<span class="lineNum">    8809 </span>            : 
<span class="lineNum">    8810 </span>            :         /* Play the word urgent if we are listening to urgent messages */
<span class="lineNum">    8811 </span><span class="lineCov">         12 :         if (!ast_strlen_zero(flag) &amp;&amp; !strcmp(flag, &quot;Urgent&quot;)) {</span>
<span class="lineNum">    8812 </span><span class="lineCov">          1 :                 res = wait_file2(chan, vms, &quot;vm-Urgent&quot;);     /* &quot;urgent&quot; */</span>
<span class="lineNum">    8813 </span>            :         }
<span class="lineNum">    8814 </span>            : 
<span class="lineNum">    8815 </span><span class="lineCov">         12 :         if (!res) {</span>
<span class="lineNum">    8816 </span>            :                 /* XXX Why are we playing messages above, and then playing the same language-specific stuff here? */
<span class="lineNum">    8817 </span>            :                 /* POLISH syntax */
<span class="lineNum">    8818 </span><span class="lineCov">         12 :                 if (!strncasecmp(ast_channel_language(chan), &quot;pl&quot;, 2)) {</span>
<span class="lineNum">    8819 </span><span class="lineNoCov">          0 :                         if (vms-&gt;curmsg &amp;&amp; (vms-&gt;curmsg != vms-&gt;lastmsg)) {</span>
<span class="lineNum">    8820 </span>            :                                 int ten, one;
<span class="lineNum">    8821 </span>            :                                 char nextmsg[256];
<span class="lineNum">    8822 </span><span class="lineNoCov">          0 :                                 ten = (vms-&gt;curmsg + 1) / 10;</span>
<span class="lineNum">    8823 </span><span class="lineNoCov">          0 :                                 one = (vms-&gt;curmsg + 1) % 10;</span>
<span class="lineNum">    8824 </span>            : 
<span class="lineNum">    8825 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;curmsg &lt; 20) {</span>
<span class="lineNum">    8826 </span><span class="lineNoCov">          0 :                                         snprintf(nextmsg, sizeof(nextmsg), &quot;digits/n-%d&quot;, vms-&gt;curmsg + 1);</span>
<span class="lineNum">    8827 </span><span class="lineNoCov">          0 :                                         res = wait_file2(chan, vms, nextmsg);</span>
<span class="lineNum">    8828 </span>            :                                 } else {
<span class="lineNum">    8829 </span><span class="lineNoCov">          0 :                                         snprintf(nextmsg, sizeof(nextmsg), &quot;digits/n-%d&quot;, ten * 10);</span>
<span class="lineNum">    8830 </span><span class="lineNoCov">          0 :                                         res = wait_file2(chan, vms, nextmsg);</span>
<span class="lineNum">    8831 </span><span class="lineNoCov">          0 :                                         if (one &gt; 0) {</span>
<span class="lineNum">    8832 </span><span class="lineNoCov">          0 :                                                 if (!res) {</span>
<span class="lineNum">    8833 </span><span class="lineNoCov">          0 :                                                         snprintf(nextmsg, sizeof(nextmsg), &quot;digits/n-%d&quot;, one);</span>
<span class="lineNum">    8834 </span><span class="lineNoCov">          0 :                                                         res = wait_file2(chan, vms, nextmsg);</span>
<span class="lineNum">    8835 </span>            :                                                 }
<span class="lineNum">    8836 </span>            :                                         }
<span class="lineNum">    8837 </span>            :                                 }
<span class="lineNum">    8838 </span>            :                         }
<span class="lineNum">    8839 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    8840 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8841 </span>            :                 /* HEBREW syntax */
<span class="lineNum">    8842 </span><span class="lineCov">         12 :                 } else if (!strncasecmp(ast_channel_language(chan), &quot;he&quot;, 2)) {</span>
<span class="lineNum">    8843 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;curmsg) {</span>
<span class="lineNum">    8844 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8845 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-first&quot;);</span>
<span class="lineNum">    8846 </span><span class="lineNoCov">          0 :                         } else if (vms-&gt;curmsg == vms-&gt;lastmsg) {</span>
<span class="lineNum">    8847 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8848 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-last&quot;);</span>
<span class="lineNum">    8849 </span>            :                         } else {
<span class="lineNum">    8850 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8851 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-number&quot;);</span>
<span class="lineNum">    8852 </span><span class="lineNoCov">          0 :                                 res = ast_say_number(chan, vms-&gt;curmsg + 1, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    8853 </span>            :                         }
<span class="lineNum">    8854 </span>            :                 /* ICELANDIC syntax */
<span class="lineNum">    8855 </span><span class="lineCov">         12 :                 } else if (!strncasecmp(ast_channel_language(chan), &quot;is&quot;, 2)) {</span>
<span class="lineNum">    8856 </span><span class="lineNoCov">          0 :                         res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8857 </span><span class="lineNoCov">          0 :                         if (vms-&gt;curmsg &amp;&amp; (vms-&gt;curmsg != vms-&gt;lastmsg)) {</span>
<span class="lineNum">    8858 </span><span class="lineNoCov">          0 :                                 res = ast_say_number(chan, vms-&gt;curmsg + 1, AST_DIGIT_ANY, ast_channel_language(chan), &quot;n&quot;);</span>
<span class="lineNum">    8859 </span>            :                         }
<span class="lineNum">    8860 </span>            :                 /* VIETNAMESE syntax */
<span class="lineNum">    8861 </span><span class="lineCov">         12 :                 } else if (!strncasecmp(ast_channel_language(chan), &quot;vi&quot;, 2)) {</span>
<span class="lineNum">    8862 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;curmsg) {</span>
<span class="lineNum">    8863 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8864 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-first&quot;);</span>
<span class="lineNum">    8865 </span><span class="lineNoCov">          0 :                         } else if (vms-&gt;curmsg == vms-&gt;lastmsg) {</span>
<span class="lineNum">    8866 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8867 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-last&quot;);</span>
<span class="lineNum">    8868 </span>            :                         } else {
<span class="lineNum">    8869 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8870 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-number&quot;);</span>
<span class="lineNum">    8871 </span><span class="lineNoCov">          0 :                                 res = ast_say_number(chan, vms-&gt;curmsg + 1, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    8872 </span>            :                         }
<span class="lineNum">    8873 </span>            :                 } else {
<span class="lineNum">    8874 </span><span class="lineCov">         12 :                         if (!strncasecmp(ast_channel_language(chan), &quot;se&quot;, 2)) { /* SWEDISH syntax */</span>
<span class="lineNum">    8875 </span><span class="lineNoCov">          0 :                                 res = wait_file2(chan, vms, &quot;vm-meddelandet&quot;);  /* &quot;message&quot; */</span>
<span class="lineNum">    8876 </span>            :                         } else { /* DEFAULT syntax */
<span class="lineNum">    8877 </span><span class="lineCov">         12 :                                 res = wait_file2(chan, vms, &quot;vm-message&quot;);</span>
<span class="lineNum">    8878 </span>            :                         }
<span class="lineNum">    8879 </span><span class="lineCov">         12 :                         if (vms-&gt;curmsg &amp;&amp; (vms-&gt;curmsg != vms-&gt;lastmsg)) {</span>
<span class="lineNum">    8880 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">    8881 </span><span class="lineNoCov">          0 :                                         ast_test_suite_event_notify(&quot;PLAYBACK&quot;, &quot;Message: message number&quot;);</span>
<span class="lineNum">    8882 </span><span class="lineNoCov">          0 :                                         res = ast_say_number(chan, vms-&gt;curmsg + 1, AST_DIGIT_ANY, ast_channel_language(chan), NULL);</span>
<span class="lineNum">    8883 </span>            :                                 }
<span class="lineNum">    8884 </span>            :                         }
<span class="lineNum">    8885 </span>            :                 }
<span class="lineNum">    8886 </span>            :         }
<span class="lineNum">    8887 </span>            : 
<span class="lineNum">    8888 </span><span class="lineCov">         12 :         if (!valid_config(msg_cfg)) {</span>
<span class="lineNum">    8889 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No message attribute file?!! (%s)\n&quot;, filename);</span>
<span class="lineNum">    8890 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    8891 </span>            :         }
<span class="lineNum">    8892 </span>            : 
<span class="lineNum">    8893 </span><span class="lineCov">         12 :         if (!(origtime = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origtime&quot;))) {</span>
<span class="lineNum">    8894 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No origtime?!\n&quot;);</span>
<span class="lineNum">    8895 </span>            :                 DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">    8896 </span><span class="lineNoCov">          0 :                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">    8897 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    8898 </span>            :         }
<span class="lineNum">    8899 </span>            : 
<span class="lineNum">    8900 </span><span class="lineCov">         12 :         cid = ast_strdupa(ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;));</span>
<span class="lineNum">    8901 </span><span class="lineCov">         12 :         duration = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;);</span>
<span class="lineNum">    8902 </span><span class="lineCov">         12 :         category = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;category&quot;);</span>
<span class="lineNum">    8903 </span>            : 
<span class="lineNum">    8904 </span><span class="lineCov">         12 :         context = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;context&quot;);</span>
<span class="lineNum">    8905 </span><span class="lineCov">         12 :         if (!strncasecmp(&quot;macro&quot;, context, 5)) /* Macro names in contexts are useless for our needs */</span>
<span class="lineNum">    8906 </span><span class="lineNoCov">          0 :                 context = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;macrocontext&quot;);</span>
<span class="lineNum">    8907 </span><span class="lineCov">         12 :         if (!res) {</span>
<span class="lineNum">    8908 </span><span class="lineCov">         12 :                 res = play_message_category(chan, category);</span>
<span class="lineNum">    8909 </span>            :         }
<span class="lineNum">    8910 </span><span class="lineCov">         12 :         if ((!res) &amp;&amp; (ast_test_flag(vmu, VM_ENVELOPE))) {</span>
<span class="lineNum">    8911 </span><span class="lineCov">         12 :                 res = play_message_datetime(chan, vmu, origtime, filename);</span>
<span class="lineNum">    8912 </span>            :         }
<span class="lineNum">    8913 </span><span class="lineCov">         12 :         if ((!res) &amp;&amp; (ast_test_flag(vmu, VM_SAYCID))) {</span>
<span class="lineNum">    8914 </span><span class="lineCov">          1 :                 res = play_message_callerid(chan, vms, cid, context, 0, 0);</span>
<span class="lineNum">    8915 </span>            :         }
<span class="lineNum">    8916 </span><span class="lineCov">         12 :         if ((!res) &amp;&amp; (ast_test_flag(vmu, VM_SAYDURATION))) {</span>
<span class="lineNum">    8917 </span><span class="lineCov">         12 :                 res = play_message_duration(chan, vms, duration, vmu-&gt;saydurationm);</span>
<span class="lineNum">    8918 </span>            :         }
<span class="lineNum">    8919 </span>            :         /* Allow pressing '1' to skip envelope / callerid */
<span class="lineNum">    8920 </span><span class="lineCov">         12 :         if (res == '1') {</span>
<span class="lineNum">    8921 </span><span class="lineNoCov">          0 :                 ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;, res, res);</span>
<span class="lineNum">    8922 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">    8923 </span>            :         }
<span class="lineNum">    8924 </span><span class="lineCov">         12 :         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">    8925 </span>            : 
<span class="lineNum">    8926 </span><span class="lineCov">         12 :         if (!res) {</span>
<span class="lineNum">    8927 </span><span class="lineCov">         12 :                 make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">    8928 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8929 </span>            :                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    8930 </span>            : #endif
<span class="lineNum">    8931 </span><span class="lineCov">         12 :                 vms-&gt;heard[vms-&gt;curmsg] = 1;</span>
<span class="lineNum">    8932 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8933 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    8934 </span>            :                 /*IMAP storage stores any prepended message from a forward
<span class="lineNum">    8935 </span>            :                  * as a separate file from the rest of the message
<span class="lineNum">    8936 </span>            :                  */
<span class="lineNum">    8937 </span>            :                 if (!ast_strlen_zero(vms-&gt;introfn) &amp;&amp; ast_fileexists(vms-&gt;introfn, NULL, NULL) &gt; 0) {
<span class="lineNum">    8938 </span>            :                         wait_file(chan, vms, vms-&gt;introfn);
<span class="lineNum">    8939 </span>            :                 }
<span class="lineNum">    8940 </span>            : #endif
<span class="lineNum">    8941 </span><span class="lineCov">         12 :                 if ((res = wait_file(chan, vms, vms-&gt;fn)) &lt; 0) {</span>
<span class="lineNum">    8942 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Playback of message %s failed\n&quot;, vms-&gt;fn);</span>
<span class="lineNum">    8943 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">    8944 </span>            :                 }
<span class="lineNum">    8945 </span><span class="lineCov">         12 :                 ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">    8946 </span>            :                         isprint(res) ? res : '?', isprint(res) ? res : '?');
<span class="lineNum">    8947 </span>            :         }
<span class="lineNum">    8948 </span>            :         DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">    8949 </span><span class="lineCov">         12 :         return res;</span>
<span class="lineNum">    8950 </span>            : }
<span class="lineNum">    8951 </span>            : 
<span class="lineNum">    8952 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    8953 </span>            : static int imap_remove_file(char *dir, int msgnum)
<span class="lineNum">    8954 </span>            : {
<span class="lineNum">    8955 </span>            :         char fn[PATH_MAX];
<span class="lineNum">    8956 </span>            :         char full_fn[PATH_MAX];
<span class="lineNum">    8957 </span>            :         char intro[PATH_MAX] = {0,};
<span class="lineNum">    8958 </span>            : 
<span class="lineNum">    8959 </span>            :         if (msgnum &gt; -1) {
<span class="lineNum">    8960 </span>            :                 make_file(fn, sizeof(fn), dir, msgnum);
<span class="lineNum">    8961 </span>            :                 snprintf(intro, sizeof(intro), &quot;%sintro&quot;, fn);
<span class="lineNum">    8962 </span>            :         } else
<span class="lineNum">    8963 </span>            :                 ast_copy_string(fn, dir, sizeof(fn));
<span class="lineNum">    8964 </span>            : 
<span class="lineNum">    8965 </span>            :         if ((msgnum &lt; 0 &amp;&amp; imapgreetings) || msgnum &gt; -1) {
<span class="lineNum">    8966 </span>            :                 ast_filedelete(fn, NULL);
<span class="lineNum">    8967 </span>            :                 if (!ast_strlen_zero(intro)) {
<span class="lineNum">    8968 </span>            :                         ast_filedelete(intro, NULL);
<span class="lineNum">    8969 </span>            :                 }
<span class="lineNum">    8970 </span>            :                 snprintf(full_fn, sizeof(full_fn), &quot;%s.txt&quot;, fn);
<span class="lineNum">    8971 </span>            :                 unlink(full_fn);
<span class="lineNum">    8972 </span>            :         }
<span class="lineNum">    8973 </span>            :         return 0;
<span class="lineNum">    8974 </span>            : }
<span class="lineNum">    8975 </span>            : 
<span class="lineNum">    8976 </span>            : 
<span class="lineNum">    8977 </span>            : 
<span class="lineNum">    8978 </span>            : static int imap_delete_old_greeting (char *dir, struct vm_state *vms)
<span class="lineNum">    8979 </span>            : {
<span class="lineNum">    8980 </span>            :         char *file, *filename;
<span class="lineNum">    8981 </span>            :         char *attachment;
<span class="lineNum">    8982 </span>            :         char arg[11];
<span class="lineNum">    8983 </span>            :         int i;
<span class="lineNum">    8984 </span>            :         BODY* body;
<span class="lineNum">    8985 </span>            :         int curr_mbox;
<span class="lineNum">    8986 </span>            : 
<span class="lineNum">    8987 </span>            :         file = strrchr(ast_strdupa(dir), '/');
<span class="lineNum">    8988 </span>            :         if (file) {
<span class="lineNum">    8989 </span>            :                 *file++ = '\0';
<span class="lineNum">    8990 </span>            :         } else {
<span class="lineNum">    8991 </span>            :                 ast_log(AST_LOG_ERROR, &quot;Failed to procure file name from directory passed. You should never see this.\n&quot;);
<span class="lineNum">    8992 </span>            :                 return -1;
<span class="lineNum">    8993 </span>            :         }
<span class="lineNum">    8994 </span>            : 
<span class="lineNum">    8995 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    8996 </span>            : 
<span class="lineNum">    8997 </span>            :         /* get the current mailbox so that we can point the mailstream back to it later */
<span class="lineNum">    8998 </span>            :         curr_mbox = get_folder_by_name(vms-&gt;curbox);
<span class="lineNum">    8999 </span>            : 
<span class="lineNum">    9000 </span>            :         if (init_mailstream(vms, GREETINGS_FOLDER) || !vms-&gt;mailstream) {
<span class="lineNum">    9001 </span>            :                 ast_log(AST_LOG_ERROR, &quot;IMAP mailstream is NULL or can't init_mailstream\n&quot;);
<span class="lineNum">    9002 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    9003 </span>            :                 return -1;
<span class="lineNum">    9004 </span>            :         }
<span class="lineNum">    9005 </span>            : 
<span class="lineNum">    9006 </span>            :         for (i = 0; i &lt; vms-&gt;mailstream-&gt;nmsgs; i++) {
<span class="lineNum">    9007 </span>            :                 mail_fetchstructure(vms-&gt;mailstream, i + 1, &amp;body);
<span class="lineNum">    9008 </span>            :                 /* We have the body, now we extract the file name of the first attachment. */
<span class="lineNum">    9009 </span>            :                 if (body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<span class="lineNum">    9010 </span>            :                         attachment = ast_strdupa(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<span class="lineNum">    9011 </span>            :                 } else {
<span class="lineNum">    9012 </span>            :                         ast_log(AST_LOG_ERROR, &quot;There is no file attached to this IMAP message.\n&quot;);
<span class="lineNum">    9013 </span>            :                         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    9014 </span>            :                         return -1;
<span class="lineNum">    9015 </span>            :                 }
<span class="lineNum">    9016 </span>            :                 filename = strsep(&amp;attachment, &quot;.&quot;);
<span class="lineNum">    9017 </span>            :                 if (!strcmp(filename, file)) {
<span class="lineNum">    9018 </span>            :                         snprintf(arg, sizeof(arg), &quot;%d&quot;, i + 1);
<span class="lineNum">    9019 </span>            :                         mail_setflag(vms-&gt;mailstream, arg, &quot;\\DELETED&quot;);
<span class="lineNum">    9020 </span>            :                 }
<span class="lineNum">    9021 </span>            :         }
<span class="lineNum">    9022 </span>            :         mail_expunge(vms-&gt;mailstream);
<span class="lineNum">    9023 </span>            : 
<span class="lineNum">    9024 </span>            :         if (curr_mbox != -1) {
<span class="lineNum">    9025 </span>            :                 /* restore previous mbox stream */
<span class="lineNum">    9026 </span>            :                 if (init_mailstream(vms, curr_mbox) || !vms-&gt;mailstream) {
<span class="lineNum">    9027 </span>            :                         ast_log(AST_LOG_ERROR, &quot;IMAP mailstream is NULL or can't init_mailstream\n&quot;);
<span class="lineNum">    9028 </span>            :                 }
<span class="lineNum">    9029 </span>            :         }
<span class="lineNum">    9030 </span>            : 
<span class="lineNum">    9031 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    9032 </span>            :         return 0;
<span class="lineNum">    9033 </span>            : }
<a name="9034"><span class="lineNum">    9034 </span>            : </a>
<span class="lineNum">    9035 </span>            : #elif !defined(IMAP_STORAGE)
<span class="lineNum">    9036 </span><span class="lineCov">        683 : static int open_mailbox(struct vm_state *vms, struct ast_vm_user *vmu, int box)</span>
<span class="lineNum">    9037 </span>            : {
<span class="lineNum">    9038 </span>            :         int count_msg, last_msg;
<span class="lineNum">    9039 </span>            : 
<span class="lineNum">    9040 </span><span class="lineCov">        683 :         ast_copy_string(vms-&gt;curbox, mbox(vmu, box), sizeof(vms-&gt;curbox));</span>
<span class="lineNum">    9041 </span>            : 
<span class="lineNum">    9042 </span>            :         /* Rename the member vmbox HERE so that we don't try to return before
<span class="lineNum">    9043 </span>            :          * we know what's going on.
<span class="lineNum">    9044 </span>            :          */
<span class="lineNum">    9045 </span><span class="lineCov">        683 :         snprintf(vms-&gt;vmbox, sizeof(vms-&gt;vmbox), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">    9046 </span>            : 
<span class="lineNum">    9047 </span>            :         /* Faster to make the directory than to check if it exists. */
<span class="lineNum">    9048 </span><span class="lineCov">        683 :         create_dirpath(vms-&gt;curdir, sizeof(vms-&gt;curdir), vmu-&gt;context, vms-&gt;username, vms-&gt;curbox);</span>
<span class="lineNum">    9049 </span>            : 
<span class="lineNum">    9050 </span>            :         /* traverses directory using readdir (or select query for ODBC) */
<span class="lineNum">    9051 </span><span class="lineCov">        683 :         count_msg = count_messages(vmu, vms-&gt;curdir);</span>
<span class="lineNum">    9052 </span><span class="lineCov">        683 :         if (count_msg &lt; 0) {</span>
<span class="lineNum">    9053 </span><span class="lineNoCov">          0 :                 return count_msg;</span>
<span class="lineNum">    9054 </span>            :         } else {
<span class="lineNum">    9055 </span><span class="lineCov">        683 :                 vms-&gt;lastmsg = count_msg - 1;</span>
<span class="lineNum">    9056 </span>            :         }
<span class="lineNum">    9057 </span>            : 
<span class="lineNum">    9058 </span><span class="lineCov">        683 :         if (vm_allocate_dh(vms, vmu, count_msg)) {</span>
<span class="lineNum">    9059 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">    9060 </span>            :         }
<span class="lineNum">    9061 </span>            : 
<span class="lineNum">    9062 </span>            :         /*
<span class="lineNum">    9063 </span>            :         The following test is needed in case sequencing gets messed up.
<span class="lineNum">    9064 </span>            :         There appears to be more than one way to mess up sequence, so
<span class="lineNum">    9065 </span>            :         we will not try to find all of the root causes--just fix it when
<span class="lineNum">    9066 </span>            :         detected.
<span class="lineNum">    9067 </span>            :         */
<span class="lineNum">    9068 </span>            : 
<span class="lineNum">    9069 </span><span class="lineCov">        683 :         if (vm_lock_path(vms-&gt;curdir)) {</span>
<span class="lineNum">    9070 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Could not open mailbox %s:  mailbox is locked\n&quot;, vms-&gt;curdir);</span>
<span class="lineNum">    9071 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    9072 </span>            :         }
<span class="lineNum">    9073 </span>            : 
<span class="lineNum">    9074 </span>            :         /* for local storage, checks directory for messages up to maxmsg limit */
<span class="lineNum">    9075 </span><span class="lineCov">        683 :         last_msg = last_message_index(vmu, vms-&gt;curdir);</span>
<span class="lineNum">    9076 </span><span class="lineCov">        683 :         ast_unlock_path(vms-&gt;curdir);</span>
<span class="lineNum">    9077 </span>            : 
<span class="lineNum">    9078 </span><span class="lineCov">        683 :         if (last_msg &lt; -1) {</span>
<span class="lineNum">    9079 </span><span class="lineNoCov">          0 :                 return last_msg;</span>
<span class="lineNum">    9080 </span><span class="lineCov">        683 :         } else if (vms-&gt;lastmsg != last_msg) {</span>
<span class="lineNum">    9081 </span><span class="lineCov">          3 :                 ast_log(LOG_NOTICE, &quot;Resequencing Mailbox: %s, expected %d but found %d message(s) in box with max threshold of %d.\n&quot;, vms-&gt;curdir, last_msg + 1, vms-&gt;lastmsg + 1, vmu-&gt;maxmsg);</span>
<span class="lineNum">    9082 </span><span class="lineCov">          3 :                 resequence_mailbox(vmu, vms-&gt;curdir, count_msg);</span>
<span class="lineNum">    9083 </span>            :         }
<span class="lineNum">    9084 </span>            : 
<span class="lineNum">    9085 </span><span class="lineCov">        683 :         return 0;</span>
<span class="lineNum">    9086 </span>            : }
<a name="9087"><span class="lineNum">    9087 </span>            : #endif</a>
<span class="lineNum">    9088 </span>            : 
<span class="lineNum">    9089 </span><span class="lineCov">        623 : static int close_mailbox(struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">    9090 </span>            : {
<span class="lineNum">    9091 </span><span class="lineCov">        623 :         int x = 0;</span>
<span class="lineNum">    9092 </span><span class="lineCov">        623 :         int last_msg_idx = 0;</span>
<span class="lineNum">    9093 </span>            : 
<span class="lineNum">    9094 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    9095 </span><span class="lineCov">        623 :         int res = 0, nummsg;</span>
<span class="lineNum">    9096 </span>            :         char fn2[PATH_MAX];
<span class="lineNum">    9097 </span>            : #endif
<span class="lineNum">    9098 </span>            : 
<span class="lineNum">    9099 </span><span class="lineCov">        623 :         if (vms-&gt;lastmsg &lt;= -1) {</span>
<span class="lineNum">    9100 </span><span class="lineCov">        543 :                 goto done;</span>
<span class="lineNum">    9101 </span>            :         }
<span class="lineNum">    9102 </span>            : 
<span class="lineNum">    9103 </span><span class="lineCov">         80 :         vms-&gt;curmsg = -1;</span>
<span class="lineNum">    9104 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">    9105 </span>            :         /* Get the deleted messages fixed */
<span class="lineNum">    9106 </span><span class="lineCov">         80 :         if (vm_lock_path(vms-&gt;curdir)) {</span>
<span class="lineNum">    9107 </span><span class="lineNoCov">          0 :                 return ERROR_LOCK_PATH;</span>
<span class="lineNum">    9108 </span>            :         }
<span class="lineNum">    9109 </span>            : 
<span class="lineNum">    9110 </span>            :         /* update count as message may have arrived while we've got mailbox open */
<span class="lineNum">    9111 </span><span class="lineCov">         80 :         last_msg_idx = last_message_index(vmu, vms-&gt;curdir);</span>
<span class="lineNum">    9112 </span><span class="lineCov">         80 :         if (last_msg_idx != vms-&gt;lastmsg) {</span>
<span class="lineNum">    9113 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_NOTICE, &quot;%d messages received after mailbox opened.\n&quot;, last_msg_idx - vms-&gt;lastmsg);</span>
<span class="lineNum">    9114 </span>            :         }
<span class="lineNum">    9115 </span>            : 
<span class="lineNum">    9116 </span>            :         /* must check up to last detected message, just in case it is erroneously greater than maxmsg */
<span class="lineNum">    9117 </span><span class="lineCov">        211 :         for (x = 0; x &lt; last_msg_idx + 1; x++) {</span>
<span class="lineNum">    9118 </span><span class="lineCov">        131 :                 if (!vms-&gt;deleted[x] &amp;&amp; ((strcasecmp(vms-&gt;curbox, &quot;INBOX&quot;) &amp;&amp; strcasecmp(vms-&gt;curbox, &quot;Urgent&quot;)) || !vms-&gt;heard[x] || (vms-&gt;heard[x] &amp;&amp; !ast_test_flag(vmu, VM_MOVEHEARD)))) {</span>
<span class="lineNum">    9119 </span>            :                         /* Save this message.  It's not in INBOX or hasn't been heard */
<span class="lineNum">    9120 </span><span class="lineCov">        103 :                         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, x);</span>
<span class="lineNum">    9121 </span><span class="lineCov">        103 :                         if (!EXISTS(vms-&gt;curdir, x, vms-&gt;fn, NULL)) {</span>
<span class="lineNum">    9122 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    9123 </span>            :                         }
<span class="lineNum">    9124 </span><span class="lineCov">        103 :                         vms-&gt;curmsg++;</span>
<span class="lineNum">    9125 </span><span class="lineCov">        103 :                         make_file(fn2, sizeof(fn2), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">    9126 </span><span class="lineCov">        107 :                         if (strcmp(vms-&gt;fn, fn2)) {</span>
<span class="lineNum">    9127 </span><span class="lineCov">          4 :                                 RENAME(vms-&gt;curdir, x, vmu-&gt;mailbox, vmu-&gt;context, vms-&gt;curdir, vms-&gt;curmsg, vms-&gt;fn, fn2);</span>
<span class="lineNum">    9128 </span>            :                         }
<span class="lineNum">    9129 </span><span class="lineCov">         28 :                 } else if ((!strcasecmp(vms-&gt;curbox, &quot;INBOX&quot;) || !strcasecmp(vms-&gt;curbox, &quot;Urgent&quot;)) &amp;&amp; vms-&gt;heard[x] &amp;&amp; ast_test_flag(vmu, VM_MOVEHEARD) &amp;&amp; !vms-&gt;deleted[x]) {</span>
<span class="lineNum">    9130 </span>            :                         /* Move to old folder before deleting */
<span class="lineNum">    9131 </span><span class="lineCov">          9 :                         res = save_to_folder(vmu, vms, x, 1, NULL, 0);</span>
<span class="lineNum">    9132 </span><span class="lineCov">          9 :                         if (res == ERROR_LOCK_PATH || res == ERROR_MAX_MSGS) {</span>
<span class="lineNum">    9133 </span>            :                                 /* If save failed do not delete the message */
<span class="lineNum">    9134 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Save failed.  Not moving message: %s.\n&quot;, res == ERROR_LOCK_PATH ? &quot;unable to lock path&quot; : &quot;destination folder full&quot;);</span>
<span class="lineNum">    9135 </span><span class="lineNoCov">          0 :                                 vms-&gt;deleted[x] = 0;</span>
<span class="lineNum">    9136 </span><span class="lineNoCov">          0 :                                 vms-&gt;heard[x] = 0;</span>
<span class="lineNum">    9137 </span><span class="lineNoCov">          0 :                                 --x;</span>
<span class="lineNum">    9138 </span>            :                         }
<span class="lineNum">    9139 </span><span class="lineCov">         19 :                 } else if (vms-&gt;deleted[x] &amp;&amp; vmu-&gt;maxdeletedmsg) {</span>
<span class="lineNum">    9140 </span>            :                         /* Move to deleted folder */
<span class="lineNum">    9141 </span><span class="lineNoCov">          0 :                         res = save_to_folder(vmu, vms, x, 10, NULL, 0);</span>
<span class="lineNum">    9142 </span><span class="lineNoCov">          0 :                         if (res == ERROR_LOCK_PATH) {</span>
<span class="lineNum">    9143 </span>            :                                 /* If save failed do not delete the message */
<span class="lineNum">    9144 </span><span class="lineNoCov">          0 :                                 vms-&gt;deleted[x] = 0;</span>
<span class="lineNum">    9145 </span><span class="lineNoCov">          0 :                                 vms-&gt;heard[x] = 0;</span>
<span class="lineNum">    9146 </span><span class="lineNoCov">          0 :                                 --x;</span>
<span class="lineNum">    9147 </span>            :                         }
<span class="lineNum">    9148 </span><span class="lineCov">         19 :                 } else if (vms-&gt;deleted[x] &amp;&amp; ast_check_realtime(&quot;voicemail_data&quot;)) {</span>
<span class="lineNum">    9149 </span>            :                         /* If realtime storage enabled - we should explicitly delete this message,
<span class="lineNum">    9150 </span>            :                         cause RENAME() will overwrite files, but will keep duplicate records in RT-storage */
<span class="lineNum">    9151 </span><span class="lineNoCov">          0 :                         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, x);</span>
<span class="lineNum">    9152 </span><span class="lineNoCov">          0 :                         if (EXISTS(vms-&gt;curdir, x, vms-&gt;fn, NULL)) {</span>
<span class="lineNum">    9153 </span><span class="lineNoCov">          0 :                                 DELETE(vms-&gt;curdir, x, vms-&gt;fn, vmu);</span>
<span class="lineNum">    9154 </span>            :                         }
<span class="lineNum">    9155 </span>            :                 }
<span class="lineNum">    9156 </span>            :         }
<span class="lineNum">    9157 </span>            : 
<span class="lineNum">    9158 </span>            :         /* Delete ALL remaining messages */
<span class="lineNum">    9159 </span><span class="lineCov">         80 :         nummsg = x - 1;</span>
<span class="lineNum">    9160 </span><span class="lineCov">        108 :         for (x = vms-&gt;curmsg + 1; x &lt;= nummsg; x++) {</span>
<span class="lineNum">    9161 </span><span class="lineCov">         28 :                 make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, x);</span>
<span class="lineNum">    9162 </span><span class="lineCov">         28 :                 if (EXISTS(vms-&gt;curdir, x, vms-&gt;fn, NULL)) {</span>
<span class="lineNum">    9163 </span><span class="lineCov">         26 :                         DELETE(vms-&gt;curdir, x, vms-&gt;fn, vmu);</span>
<span class="lineNum">    9164 </span>            :                 }
<span class="lineNum">    9165 </span>            :         }
<span class="lineNum">    9166 </span><span class="lineCov">         80 :         ast_unlock_path(vms-&gt;curdir);</span>
<span class="lineNum">    9167 </span>            : #else /* defined(IMAP_STORAGE) */
<span class="lineNum">    9168 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">    9169 </span>            :         if (vms-&gt;deleted) {
<span class="lineNum">    9170 </span>            :                 /* Since we now expunge after each delete, deleting in reverse order
<span class="lineNum">    9171 </span>            :                  * ensures that no reordering occurs between each step. */
<span class="lineNum">    9172 </span>            :                 last_msg_idx = vms-&gt;dh_arraysize;
<span class="lineNum">    9173 </span>            :                 for (x = last_msg_idx - 1; x &gt;= 0; x--) {
<span class="lineNum">    9174 </span>            :                         if (vms-&gt;deleted[x]) {
<span class="lineNum">    9175 </span>            :                                 ast_debug(3, &quot;IMAP delete of %d\n&quot;, x);
<span class="lineNum">    9176 </span>            :                                 DELETE(vms-&gt;curdir, x, vms-&gt;fn, vmu);
<span class="lineNum">    9177 </span>            :                         }
<span class="lineNum">    9178 </span>            :                 }
<span class="lineNum">    9179 </span>            :         }
<span class="lineNum">    9180 </span>            : #endif
<span class="lineNum">    9181 </span>            : 
<span class="lineNum">    9182 </span><span class="lineCov">        623 : done:</span>
<span class="lineNum">    9183 </span><span class="lineCov">        623 :         if (vms-&gt;deleted) {</span>
<span class="lineNum">    9184 </span><span class="lineCov">        623 :                 ast_free(vms-&gt;deleted);</span>
<span class="lineNum">    9185 </span><span class="lineCov">        623 :                 vms-&gt;deleted = NULL;</span>
<span class="lineNum">    9186 </span>            :         }
<span class="lineNum">    9187 </span><span class="lineCov">        623 :         if (vms-&gt;heard) {</span>
<span class="lineNum">    9188 </span><span class="lineCov">        623 :                 ast_free(vms-&gt;heard);</span>
<span class="lineNum">    9189 </span><span class="lineCov">        623 :                 vms-&gt;heard = NULL;</span>
<span class="lineNum">    9190 </span>            :         }
<span class="lineNum">    9191 </span><span class="lineCov">        623 :         vms-&gt;dh_arraysize = 0;</span>
<span class="lineNum">    9192 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">    9193 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">    9194 </span>            : #endif
<span class="lineNum">    9195 </span>            : 
<span class="lineNum">    9196 </span><span class="lineCov">        623 :         return 0;</span>
<span class="lineNum">    9197 </span>            : }
<span class="lineNum">    9198 </span>            : 
<span class="lineNum">    9199 </span>            : /* In Greek even though we CAN use a syntax like &quot;friends messages&quot;
<span class="lineNum">    9200 </span>            :  * (&quot;filika mynhmata&quot;) it is not elegant. This also goes for &quot;work/family messages&quot;
<span class="lineNum">    9201 </span>            :  * (&quot;ergasiaka/oikogeniaka mynhmata&quot;). Therefore it is better to use a reversed
<span class="lineNum">    9202 </span>            :  * syntax for the above three categories which is more elegant.
<a name="9203"><span class="lineNum">    9203 </span>            :  */</a>
<span class="lineNum">    9204 </span>            : 
<span class="lineNum">    9205 </span><span class="lineNoCov">          0 : static int vm_play_folder_name_gr(struct ast_channel *chan, char *box)</span>
<span class="lineNum">    9206 </span>            : {
<span class="lineNum">    9207 </span>            :         int cmd;
<span class="lineNum">    9208 </span>            :         char *buf;
<span class="lineNum">    9209 </span>            : 
<span class="lineNum">    9210 </span><span class="lineNoCov">          0 :         buf = ast_alloca(strlen(box) + 2);</span>
<span class="lineNum">    9211 </span><span class="lineNoCov">          0 :         strcpy(buf, box);</span>
<span class="lineNum">    9212 </span><span class="lineNoCov">          0 :         strcat(buf, &quot;s&quot;);</span>
<span class="lineNum">    9213 </span>            : 
<span class="lineNum">    9214 </span><span class="lineNoCov">          0 :         if (!strcasecmp(box, &quot;vm-INBOX&quot;) || !strcasecmp(box, &quot;vm-Old&quot;)){</span>
<span class="lineNum">    9215 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, buf); /* &quot;NEA / PALIA&quot; */</span>
<span class="lineNum">    9216 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, &quot;vm-messages&quot;); /* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span>
<span class="lineNum">    9217 </span>            :         } else {
<span class="lineNum">    9218 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;); /* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span>
<span class="lineNum">    9219 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, box); /* friends/family/work... -&gt; &quot;FILWN&quot;/&quot;OIKOGENIAS&quot;/&quot;DOULEIAS&quot;*/</span>
<span class="lineNum">    9220 </span>            :         }
<a name="9221"><span class="lineNum">    9221 </span>            : }</a>
<span class="lineNum">    9222 </span>            : 
<span class="lineNum">    9223 </span><span class="lineNoCov">          0 : static int vm_play_folder_name_ja(struct ast_channel *chan, char *box)</span>
<span class="lineNum">    9224 </span>            : {
<span class="lineNum">    9225 </span>            :         int cmd;
<span class="lineNum">    9226 </span>            : 
<span class="lineNum">    9227 </span><span class="lineNoCov">          0 :         if (!strcasecmp(box, &quot;vm-INBOX&quot;) || !strcasecmp(box, &quot;vm-Old&quot;)) {</span>
<span class="lineNum">    9228 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9229 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9230 </span>            :         } else {
<span class="lineNum">    9231 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9232 </span><span class="lineNoCov">          0 :                 return cmd;</span>
<span class="lineNum">    9233 </span>            :         }
<a name="9234"><span class="lineNum">    9234 </span>            : }</a>
<span class="lineNum">    9235 </span>            : 
<span class="lineNum">    9236 </span><span class="lineNoCov">          0 : static int vm_play_folder_name_pl(struct ast_channel *chan, char *box)</span>
<span class="lineNum">    9237 </span>            : {
<span class="lineNum">    9238 </span>            :         int cmd;
<span class="lineNum">    9239 </span>            : 
<span class="lineNum">    9240 </span><span class="lineNoCov">          0 :         if (!strcasecmp(box, &quot;vm-INBOX&quot;) || !strcasecmp(box, &quot;vm-Old&quot;)) {</span>
<span class="lineNum">    9241 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(box, &quot;vm-INBOX&quot;))</span>
<span class="lineNum">    9242 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-new-e&quot;);</span>
<span class="lineNum">    9243 </span>            :                 else
<span class="lineNum">    9244 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-old-e&quot;);</span>
<span class="lineNum">    9245 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9246 </span>            :         } else {
<span class="lineNum">    9247 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9248 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9249 </span>            :         }
<a name="9250"><span class="lineNum">    9250 </span>            : }</a>
<span class="lineNum">    9251 </span>            : 
<span class="lineNum">    9252 </span><span class="lineNoCov">          0 : static int vm_play_folder_name_ua(struct ast_channel *chan, char *box)</span>
<span class="lineNum">    9253 </span>            : {
<span class="lineNum">    9254 </span>            :         int cmd;
<span class="lineNum">    9255 </span>            : 
<span class="lineNum">    9256 </span><span class="lineNoCov">          0 :         if (!strcasecmp(box, &quot;vm-Family&quot;) || !strcasecmp(box, &quot;vm-Friends&quot;) || !strcasecmp(box, &quot;vm-Work&quot;)){</span>
<span class="lineNum">    9257 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9258 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9259 </span>            :         } else {
<span class="lineNum">    9260 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9261 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9262 </span>            :         }
<a name="9263"><span class="lineNum">    9263 </span>            : }</a>
<span class="lineNum">    9264 </span>            : 
<span class="lineNum">    9265 </span><span class="lineCov">          4 : static int vm_play_folder_name(struct ast_channel *chan, char *box)</span>
<span class="lineNum">    9266 </span>            : {
<span class="lineNum">    9267 </span>            :         int cmd;
<span class="lineNum">    9268 </span>            : 
<span class="lineNum">    9269 </span><span class="lineCov">          4 :         if (  !strncasecmp(ast_channel_language(chan), &quot;it&quot;, 2) ||</span>
<span class="lineNum">    9270 </span><span class="lineCov">          4 :                   !strncasecmp(ast_channel_language(chan), &quot;es&quot;, 2) ||</span>
<span class="lineNum">    9271 </span><span class="lineCov">          4 :                   !strncasecmp(ast_channel_language(chan), &quot;pt&quot;, 2)) { /* Italian, Spanish, or Portuguese syntax */</span>
<span class="lineNum">    9272 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;); /* &quot;messages */</span>
<span class="lineNum">    9273 </span><span class="lineNoCov">          0 :                 return cmd ? cmd : ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9274 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;gr&quot;, 2)) {</span>
<span class="lineNum">    9275 </span><span class="lineNoCov">          0 :                 return vm_play_folder_name_gr(chan, box);</span>
<span class="lineNum">    9276 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;he&quot;, 2)) {  /* Hebrew syntax */</span>
<span class="lineNum">    9277 </span><span class="lineNoCov">          0 :                 return ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9278 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ja&quot;, 2)) {  /* Japanese syntax */</span>
<span class="lineNum">    9279 </span><span class="lineNoCov">          0 :                 return vm_play_folder_name_ja(chan, box);</span>
<span class="lineNum">    9280 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pl&quot;, 2)) {</span>
<span class="lineNum">    9281 </span><span class="lineNoCov">          0 :                 return vm_play_folder_name_pl(chan, box);</span>
<span class="lineNum">    9282 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ua&quot;, 2)) {  /* Ukrainian syntax */</span>
<span class="lineNum">    9283 </span><span class="lineNoCov">          0 :                 return vm_play_folder_name_ua(chan, box);</span>
<span class="lineNum">    9284 </span><span class="lineCov">          4 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;vi&quot;, 2)) {</span>
<span class="lineNum">    9285 </span><span class="lineNoCov">          0 :                 return ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9286 </span>            :         } else {  /* Default English */
<span class="lineNum">    9287 </span><span class="lineCov">          4 :                 cmd = ast_play_and_wait(chan, box);</span>
<span class="lineNum">    9288 </span><span class="lineCov">          4 :                 return cmd ? cmd : ast_play_and_wait(chan, &quot;vm-messages&quot;); /* &quot;messages */</span>
<span class="lineNum">    9289 </span>            :         }
<span class="lineNum">    9290 </span>            : }
<span class="lineNum">    9291 </span>            : 
<span class="lineNum">    9292 </span>            : /* GREEK SYNTAX
<span class="lineNum">    9293 </span>            :         In greek the plural for old/new is
<span class="lineNum">    9294 </span>            :         different so we need the following files
<span class="lineNum">    9295 </span>            :         We also need vm-denExeteMynhmata because
<span class="lineNum">    9296 </span>            :         this syntax is different.
<span class="lineNum">    9297 </span>            : 
<span class="lineNum">    9298 </span>            :         -&gt; vm-Olds.wav       : &quot;Palia&quot;
<span class="lineNum">    9299 </span>            :         -&gt; vm-INBOXs.wav : &quot;Nea&quot;
<span class="lineNum">    9300 </span>            :         -&gt; vm-denExeteMynhmata : &quot;den exete mynhmata&quot;
<span class="lineNum">    9301 </span>            : */
<a name="9302"><span class="lineNum">    9302 </span>            : </a>
<span class="lineNum">    9303 </span>            : 
<span class="lineNum">    9304 </span><span class="lineNoCov">          0 : static int vm_intro_gr(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9305 </span>            : {
<span class="lineNum">    9306 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">    9307 </span>            : 
<span class="lineNum">    9308 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9309 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9310 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">    9311 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;newmessages, AST_DIGIT_ANY, ast_channel_language(chan), NULL);</span>
<span class="lineNum">    9312 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    9313 </span><span class="lineNoCov">          0 :                         if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9314 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9315 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">    9316 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9317 </span>            :                         } else {
<span class="lineNum">    9318 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOXs&quot;);</span>
<span class="lineNum">    9319 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">    9320 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9321 </span>            :                         }
<span class="lineNum">    9322 </span>            :                 }
<span class="lineNum">    9323 </span><span class="lineNoCov">          0 :         } else if (vms-&gt;oldmessages){</span>
<span class="lineNum">    9324 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9325 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">    9326 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;oldmessages, AST_DIGIT_ANY, ast_channel_language(chan), NULL);</span>
<span class="lineNum">    9327 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages == 1){</span>
<span class="lineNum">    9328 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9329 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9330 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9331 </span>            :                 } else {
<span class="lineNum">    9332 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-Olds&quot;);</span>
<span class="lineNum">    9333 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9334 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9335 </span>            :                 }
<span class="lineNum">    9336 </span><span class="lineNoCov">          0 :         } else if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages)</span>
<span class="lineNum">    9337 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-denExeteMynhmata&quot;);</span>
<span class="lineNum">    9338 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9339 </span>            : }
<span class="lineNum">    9340 </span>            : 
<span class="lineNum">    9341 </span>            : /* Version of vm_intro() designed to work for many languages.
<span class="lineNum">    9342 </span>            :  *
<span class="lineNum">    9343 </span>            :  * It is hoped that this function can prevent the proliferation of
<span class="lineNum">    9344 </span>            :  * language-specific vm_intro() functions and in time replace the language-
<span class="lineNum">    9345 </span>            :  * specific functions which already exist.  An examination of the language-
<span class="lineNum">    9346 </span>            :  * specific functions revealed that they all corrected the same deficiencies
<span class="lineNum">    9347 </span>            :  * in vm_intro_en() (which was the default function). Namely:
<span class="lineNum">    9348 </span>            :  *
<span class="lineNum">    9349 </span>            :  *  1) The vm-Old and vm-INBOX sound files were overloaded.  The English
<span class="lineNum">    9350 </span>            :  *     wording of the voicemail greeting hides this problem.  For example,
<span class="lineNum">    9351 </span>            :  *     vm-INBOX contains only the word &quot;new&quot;.  This means that both of these
<span class="lineNum">    9352 </span>            :  *     sequences produce valid utterances:
<span class="lineNum">    9353 </span>            :  *      * vm-youhave digit/1 vm-INBOX vm-message (you have one new message)
<span class="lineNum">    9354 </span>            :  *      * vm-press digit/1 vm-for vm-INBOX vm-messages (press 1 for new messages)
<span class="lineNum">    9355 </span>            :  *     However, if we rerecord vm-INBOX to say &quot;the new&quot; (which is unavoidable
<span class="lineNum">    9356 </span>            :  *     in many languages) the first utterance becomes &quot;you have 1 the new message&quot;.
<span class="lineNum">    9357 </span>            :  *  2) The function contains hardcoded rules for pluralizing the word &quot;message&quot;.
<span class="lineNum">    9358 </span>            :  *     These rules are correct for English, but not for many other languages.
<span class="lineNum">    9359 </span>            :  *  3) No attempt is made to pluralize the adjectives (&quot;old&quot; and &quot;new&quot;) as
<span class="lineNum">    9360 </span>            :  *     required in many languages.
<span class="lineNum">    9361 </span>            :  *  4) The gender of the word for &quot;message&quot; is not specified. This is a problem
<span class="lineNum">    9362 </span>            :  *     because in many languages the gender of the number in phrases such
<span class="lineNum">    9363 </span>            :  *     as &quot;you have one new message&quot; must match the gender of the word
<span class="lineNum">    9364 </span>            :  *     meaning &quot;message&quot;.
<span class="lineNum">    9365 </span>            :  *
<span class="lineNum">    9366 </span>            :  * Fixing these problems for each new language has meant duplication of effort.
<span class="lineNum">    9367 </span>            :  * This new function solves the problems in the following general ways:
<span class="lineNum">    9368 </span>            :  *  1) Add new sound files vm-new and vm-old.  These can be linked to vm-INBOX
<span class="lineNum">    9369 </span>            :  *     and vm-Old respectively for those languages where it makes sense.
<span class="lineNum">    9370 </span>            :  *  2) Call ast_say_counted_noun() to put the proper gender and number prefix
<span class="lineNum">    9371 </span>            :  *     on vm-message.
<span class="lineNum">    9372 </span>            :  *  3) Call ast_say_counted_adjective() to put the proper gender and number
<span class="lineNum">    9373 </span>            :  *     prefix on vm-new and vm-old (none for English).
<span class="lineNum">    9374 </span>            :  *  4) Pass the gender of the language's word for &quot;message&quot; as an agument to
<span class="lineNum">    9375 </span>            :  *     this function which is can in turn pass on to the functions which
<span class="lineNum">    9376 </span>            :  *     say numbers and put endings on nounds and adjectives.
<span class="lineNum">    9377 </span>            :  *
<span class="lineNum">    9378 </span>            :  * All languages require these messages:
<span class="lineNum">    9379 </span>            :  *  vm-youhave          &quot;You have...&quot;
<span class="lineNum">    9380 </span>            :  *  vm-and              &quot;and&quot;
<span class="lineNum">    9381 </span>            :  *  vm-no               &quot;no&quot; (in the sense of &quot;none&quot;, as in &quot;you have no messages&quot;)
<span class="lineNum">    9382 </span>            :  *
<span class="lineNum">    9383 </span>            :  * To use it for English, you will need these additional sound files:
<span class="lineNum">    9384 </span>            :  *  vm-new              &quot;new&quot;
<span class="lineNum">    9385 </span>            :  *  vm-message          &quot;message&quot;, singular
<span class="lineNum">    9386 </span>            :  *  vm-messages         &quot;messages&quot;, plural
<span class="lineNum">    9387 </span>            :  *
<span class="lineNum">    9388 </span>            :  * If you use it for Russian and other slavic languages, you will need these additional sound files:
<span class="lineNum">    9389 </span>            :  *
<span class="lineNum">    9390 </span>            :  *  vm-newn             &quot;novoye&quot; (singular, neuter)
<span class="lineNum">    9391 </span>            :  *  vm-newx             &quot;novikh&quot; (counting plural form, genative plural)
<span class="lineNum">    9392 </span>            :  *  vm-message          &quot;sobsheniye&quot; (singular form)
<span class="lineNum">    9393 </span>            :  *  vm-messagex1        &quot;sobsheniya&quot; (first counting plural form, genative singular)
<span class="lineNum">    9394 </span>            :  *  vm-messagex2        &quot;sobsheniy&quot; (second counting plural form, genative plural)
<span class="lineNum">    9395 </span>            :  *  digits/1n           &quot;odno&quot; (neuter singular for phrases such as &quot;one message&quot; or &quot;thirty one messages&quot;)
<a name="9396"><span class="lineNum">    9396 </span>            :  *  digits/2n           &quot;dva&quot; (neuter singular)</a>
<span class="lineNum">    9397 </span>            :  */
<span class="lineNum">    9398 </span><span class="lineNoCov">          0 : static int vm_intro_multilang(struct ast_channel *chan, struct vm_state *vms, const char message_gender[])</span>
<span class="lineNum">    9399 </span>            : {
<span class="lineNum">    9400 </span>            :         int res;
<span class="lineNum">    9401 </span><span class="lineNoCov">          0 :         int lastnum = 0;</span>
<span class="lineNum">    9402 </span>            : 
<span class="lineNum">    9403 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9404 </span>            : 
<span class="lineNum">    9405 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;newmessages) {</span>
<span class="lineNum">    9406 </span><span class="lineNoCov">          0 :                 lastnum = vms-&gt;newmessages;</span>
<span class="lineNum">    9407 </span>            : 
<span class="lineNum">    9408 </span><span class="lineNoCov">          0 :                 if (!(res = ast_say_number(chan, lastnum, AST_DIGIT_ANY, ast_channel_language(chan), message_gender))) {</span>
<span class="lineNum">    9409 </span><span class="lineNoCov">          0 :                         res = ast_say_counted_adjective(chan, lastnum, &quot;vm-new&quot;, message_gender);</span>
<span class="lineNum">    9410 </span>            :                 }
<span class="lineNum">    9411 </span>            : 
<span class="lineNum">    9412 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9413 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9414 </span>            :                 }
<span class="lineNum">    9415 </span>            :         }
<span class="lineNum">    9416 </span>            : 
<span class="lineNum">    9417 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9418 </span><span class="lineNoCov">          0 :                 lastnum = vms-&gt;oldmessages;</span>
<span class="lineNum">    9419 </span>            : 
<span class="lineNum">    9420 </span><span class="lineNoCov">          0 :                 if (!(res = ast_say_number(chan, lastnum, AST_DIGIT_ANY, ast_channel_language(chan), message_gender))) {</span>
<span class="lineNum">    9421 </span><span class="lineNoCov">          0 :                         res = ast_say_counted_adjective(chan, lastnum, &quot;vm-old&quot;, message_gender);</span>
<span class="lineNum">    9422 </span>            :                 }
<span class="lineNum">    9423 </span>            :         }
<span class="lineNum">    9424 </span>            : 
<span class="lineNum">    9425 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">    9426 </span><span class="lineNoCov">          0 :                 if (lastnum == 0) {</span>
<span class="lineNum">    9427 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9428 </span>            :                 }
<span class="lineNum">    9429 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    9430 </span><span class="lineNoCov">          0 :                         res = ast_say_counted_noun(chan, lastnum, &quot;vm-message&quot;);</span>
<span class="lineNum">    9431 </span>            :                 }
<span class="lineNum">    9432 </span>            :         }
<span class="lineNum">    9433 </span>            : 
<span class="lineNum">    9434 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9435 </span>            : }
<a name="9436"><span class="lineNum">    9436 </span>            : </a>
<span class="lineNum">    9437 </span>            : /* Default Hebrew syntax */
<span class="lineNum">    9438 </span><span class="lineNoCov">          0 : static int vm_intro_he(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9439 </span>            : {
<span class="lineNum">    9440 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">    9441 </span>            : 
<span class="lineNum">    9442 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9443 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">    9444 </span><span class="lineNoCov">          0 :                 if ((vms-&gt;newmessages) || (vms-&gt;oldmessages)) {</span>
<span class="lineNum">    9445 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9446 </span>            :                 }
<span class="lineNum">    9447 </span>            :                 /*
<span class="lineNum">    9448 </span>            :                  * The word &quot;shtei&quot; refers to the number 2 in hebrew when performing a count
<span class="lineNum">    9449 </span>            :                  * of elements. In Hebrew, there are 6 forms of enumerating the number 2 for
<span class="lineNum">    9450 </span>            :                  * an element, this is one of them.
<span class="lineNum">    9451 </span>            :                  */
<span class="lineNum">    9452 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9453 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    9454 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9455 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-INBOX1&quot;);</span>
<span class="lineNum">    9456 </span>            :                                 } else {
<span class="lineNum">    9457 </span><span class="lineNoCov">          0 :                                         if (vms-&gt;newmessages == 2) {</span>
<span class="lineNum">    9458 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-shtei&quot;);</span>
<span class="lineNum">    9459 </span>            :                                         } else {
<span class="lineNum">    9460 </span><span class="lineNoCov">          0 :                                                 res = ast_say_number(chan, vms-&gt;newmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    9461 </span>            :                                         }
<span class="lineNum">    9462 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9463 </span>            :                                 }
<span class="lineNum">    9464 </span>            :                         }
<span class="lineNum">    9465 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res) {</span>
<span class="lineNum">    9466 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9467 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9468 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Old1&quot;);</span>
<span class="lineNum">    9469 </span>            :                                 } else {
<span class="lineNum">    9470 </span><span class="lineNoCov">          0 :                                         if (vms-&gt;oldmessages == 2) {</span>
<span class="lineNum">    9471 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-shtei&quot;);</span>
<span class="lineNum">    9472 </span>            :                                         } else {
<span class="lineNum">    9473 </span><span class="lineNoCov">          0 :                                                 res = ast_say_number(chan, vms-&gt;oldmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    9474 </span>            :                                         }
<span class="lineNum">    9475 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9476 </span>            :                                 }
<span class="lineNum">    9477 </span>            :                         }
<span class="lineNum">    9478 </span>            :                 }
<span class="lineNum">    9479 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9480 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    9481 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9482 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Old1&quot;);</span>
<span class="lineNum">    9483 </span>            :                                 } else {
<span class="lineNum">    9484 </span><span class="lineNoCov">          0 :                                         if (vms-&gt;oldmessages == 2) {</span>
<span class="lineNum">    9485 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-shtei&quot;);</span>
<span class="lineNum">    9486 </span>            :                                         } else {
<span class="lineNum">    9487 </span><span class="lineNoCov">          0 :                                                 res = ast_say_number(chan, vms-&gt;oldmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    9488 </span>            :                                         }
<span class="lineNum">    9489 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9490 </span>            :                                 }
<span class="lineNum">    9491 </span>            :                         }
<span class="lineNum">    9492 </span>            :                 }
<span class="lineNum">    9493 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    9494 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9495 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">    9496 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-nomessages&quot;);</span>
<span class="lineNum">    9497 </span>            :                                 }
<span class="lineNum">    9498 </span>            :                         }
<span class="lineNum">    9499 </span>            :                 }
<span class="lineNum">    9500 </span>            :         }
<span class="lineNum">    9501 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9502 </span>            : }
<a name="9503"><span class="lineNum">    9503 </span>            : </a>
<span class="lineNum">    9504 </span>            : /* Japanese syntax */
<span class="lineNum">    9505 </span><span class="lineNoCov">          0 : static int vm_intro_ja(struct ast_channel *chan,struct vm_state *vms)</span>
<span class="lineNum">    9506 </span>            : {
<span class="lineNum">    9507 </span>            :       /* Introduce messages they have */
<span class="lineNum">    9508 </span>            :       int res;
<span class="lineNum">    9509 </span><span class="lineNoCov">          0 :       if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9510 </span><span class="lineNoCov">          0 :               res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9511 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9512 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9513 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9514 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;jp-ga&quot;);</span>
<span class="lineNum">    9515 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9516 </span><span class="lineNoCov">          0 :                       res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9517 </span><span class="lineNoCov">          0 :               if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9518 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;silence/1&quot;);</span>
<span class="lineNum">    9519 </span>            : 
<span class="lineNum">    9520 </span>            :       }
<span class="lineNum">    9521 </span><span class="lineNoCov">          0 :       if (vms-&gt;oldmessages) {</span>
<span class="lineNum">    9522 </span><span class="lineNoCov">          0 :               res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9523 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9524 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9525 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9526 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;jp-ga&quot;);</span>
<span class="lineNum">    9527 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9528 </span><span class="lineNoCov">          0 :                       res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9529 </span>            :       }
<span class="lineNum">    9530 </span><span class="lineNoCov">          0 :       if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9531 </span><span class="lineNoCov">          0 :               res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9532 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9533 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;jp-wa&quot;);</span>
<span class="lineNum">    9534 </span><span class="lineNoCov">          0 :               if (!res)</span>
<span class="lineNum">    9535 </span><span class="lineNoCov">          0 :                       res = ast_play_and_wait(chan, &quot;jp-arimasen&quot;);</span>
<span class="lineNum">    9536 </span>            :       }
<span class="lineNum">    9537 </span>            :       else {
<span class="lineNum">    9538 </span><span class="lineNoCov">          0 :               res = ast_play_and_wait(chan, &quot;jp-arimasu&quot;);</span>
<span class="lineNum">    9539 </span>            :       }
<span class="lineNum">    9540 </span><span class="lineNoCov">          0 :       return res;</span>
<span class="lineNum">    9541 </span>            : } /* Japanese */
<a name="9542"><span class="lineNum">    9542 </span>            : </a>
<span class="lineNum">    9543 </span>            : /* Default English syntax */
<span class="lineNum">    9544 </span><span class="lineCov">         19 : static int vm_intro_en(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9545 </span>            : {
<span class="lineNum">    9546 </span>            :         int res;
<span class="lineNum">    9547 </span>            : 
<span class="lineNum">    9548 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9549 </span><span class="lineCov">         19 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9550 </span><span class="lineCov">         19 :         if (!res) {</span>
<span class="lineNum">    9551 </span><span class="lineCov">         19 :                 if (vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9552 </span><span class="lineCov">          1 :                         res = say_and_wait(chan, vms-&gt;urgentmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9553 </span><span class="lineCov">          1 :                         if (!res)</span>
<span class="lineNum">    9554 </span><span class="lineCov">          1 :                                 res = ast_play_and_wait(chan, &quot;vm-Urgent&quot;);</span>
<span class="lineNum">    9555 </span><span class="lineCov">          1 :                         if ((vms-&gt;oldmessages || vms-&gt;newmessages) &amp;&amp; !res) {</span>
<span class="lineNum">    9556 </span><span class="lineCov">          1 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9557 </span><span class="lineNoCov">          0 :                         } else if (!res) {</span>
<span class="lineNum">    9558 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;urgentmessages == 1)</span>
<span class="lineNum">    9559 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9560 </span>            :                                 else
<span class="lineNum">    9561 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9562 </span>            :                         }
<span class="lineNum">    9563 </span>            :                 }
<span class="lineNum">    9564 </span><span class="lineCov">         19 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9565 </span><span class="lineCov">          9 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9566 </span><span class="lineCov">          9 :                         if (!res)</span>
<span class="lineNum">    9567 </span><span class="lineCov">          9 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9568 </span><span class="lineCov">          9 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9569 </span><span class="lineCov">          1 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9570 </span><span class="lineCov">          8 :                         else if (!res) {</span>
<span class="lineNum">    9571 </span><span class="lineCov">          8 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">    9572 </span><span class="lineCov">          7 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9573 </span>            :                                 else
<span class="lineNum">    9574 </span><span class="lineCov">          1 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9575 </span>            :                         }
<span class="lineNum">    9576 </span>            : 
<span class="lineNum">    9577 </span>            :                 }
<span class="lineNum">    9578 </span><span class="lineCov">         19 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9579 </span><span class="lineCov">          1 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9580 </span><span class="lineCov">          1 :                         if (!res)</span>
<span class="lineNum">    9581 </span><span class="lineCov">          1 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9582 </span><span class="lineCov">          1 :                         if (!res) {</span>
<span class="lineNum">    9583 </span><span class="lineCov">          1 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">    9584 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9585 </span>            :                                 else
<span class="lineNum">    9586 </span><span class="lineCov">          1 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9587 </span>            :                         }
<span class="lineNum">    9588 </span>            :                 }
<span class="lineNum">    9589 </span><span class="lineCov">         19 :                 if (!res) {</span>
<span class="lineNum">    9590 </span><span class="lineCov">         19 :                         if (!vms-&gt;urgentmessages &amp;&amp; !vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9591 </span><span class="lineCov">         10 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9592 </span><span class="lineCov">         10 :                                 if (!res)</span>
<span class="lineNum">    9593 </span><span class="lineCov">         10 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9594 </span>            :                         }
<span class="lineNum">    9595 </span>            :                 }
<span class="lineNum">    9596 </span>            :         }
<span class="lineNum">    9597 </span><span class="lineCov">         19 :         return res;</span>
<span class="lineNum">    9598 </span>            : }
<a name="9599"><span class="lineNum">    9599 </span>            : </a>
<span class="lineNum">    9600 </span>            : /* ICELANDIC syntax */
<span class="lineNum">    9601 </span><span class="lineNoCov">          0 : static int vm_intro_is(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9602 </span>            : {
<span class="lineNum">    9603 </span>            :         int res;
<span class="lineNum">    9604 </span>            : 
<span class="lineNum">    9605 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9606 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9607 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">    9608 </span><span class="lineNoCov">          0 :                 if (vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9609 </span>            :                         /* Digits 1-4 are spoken in neutral and plural when talking about messages,
<span class="lineNum">    9610 </span>            :                            however, feminine is used for 1 as it is the same as the neutral for plural,
<span class="lineNum">    9611 </span>            :                            and singular neutral is the same after 1. */
<span class="lineNum">    9612 </span><span class="lineNoCov">          0 :                         if (vms-&gt;urgentmessages &lt; 5) {</span>
<span class="lineNum">    9613 </span>            :                                 char recname[16];
<span class="lineNum">    9614 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;urgentmessages == 1)</span>
<span class="lineNum">    9615 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/1kvk&quot;);</span>
<span class="lineNum">    9616 </span>            :                                 else
<span class="lineNum">    9617 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/%dhk&quot;, vms-&gt;urgentmessages);</span>
<span class="lineNum">    9618 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, recname);</span>
<span class="lineNum">    9619 </span><span class="lineNoCov">          0 :                         } else if (!res)</span>
<span class="lineNum">    9620 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Urgent&quot;);</span>
<span class="lineNum">    9621 </span><span class="lineNoCov">          0 :                         if ((vms-&gt;oldmessages || vms-&gt;newmessages) &amp;&amp; !res) {</span>
<span class="lineNum">    9622 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9623 </span><span class="lineNoCov">          0 :                         } else if (!res)</span>
<span class="lineNum">    9624 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9625 </span>            :                 }
<span class="lineNum">    9626 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9627 </span><span class="lineNoCov">          0 :                         if (vms-&gt;newmessages &lt; 5) {</span>
<span class="lineNum">    9628 </span>            :                                 char recname[16];
<span class="lineNum">    9629 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">    9630 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/1kvk&quot;);</span>
<span class="lineNum">    9631 </span>            :                                 else
<span class="lineNum">    9632 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/%dhk&quot;, vms-&gt;newmessages);</span>
<span class="lineNum">    9633 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, recname);</span>
<span class="lineNum">    9634 </span>            :                         } else
<span class="lineNum">    9635 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9636 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9637 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9638 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9639 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9640 </span><span class="lineNoCov">          0 :                         else if (!res)</span>
<span class="lineNum">    9641 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9642 </span>            :                 }
<span class="lineNum">    9643 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9644 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &lt; 5) {</span>
<span class="lineNum">    9645 </span>            :                                 char recname[16];
<span class="lineNum">    9646 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">    9647 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/1kvk&quot;);</span>
<span class="lineNum">    9648 </span>            :                                 else
<span class="lineNum">    9649 </span><span class="lineNoCov">          0 :                                         snprintf(recname, sizeof(recname), &quot;digits/%dhk&quot;, vms-&gt;oldmessages);</span>
<span class="lineNum">    9650 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, recname);</span>
<span class="lineNum">    9651 </span>            :                         } else
<span class="lineNum">    9652 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9653 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9654 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9655 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9656 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9657 </span>            :                 }
<span class="lineNum">    9658 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    9659 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;urgentmessages &amp;&amp; !vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9660 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9661 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">    9662 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9663 </span>            :                         }
<span class="lineNum">    9664 </span>            :                 }
<span class="lineNum">    9665 </span>            :         }
<span class="lineNum">    9666 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9667 </span>            : }
<a name="9668"><span class="lineNum">    9668 </span>            : </a>
<span class="lineNum">    9669 </span>            : /* ITALIAN syntax */
<span class="lineNum">    9670 </span><span class="lineNoCov">          0 : static int vm_intro_it(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9671 </span>            : {
<span class="lineNum">    9672 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9673 </span>            :         int res;
<span class="lineNum">    9674 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp;!vms-&gt;urgentmessages)</span>
<span class="lineNum">    9675 </span><span class="lineNoCov">          0 :                 res =   ast_play_and_wait(chan, &quot;vm-no&quot;) ||</span>
<span class="lineNum">    9676 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9677 </span>            :         else
<span class="lineNum">    9678 </span><span class="lineNoCov">          0 :                 res =   ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9679 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;newmessages) {</span>
<span class="lineNum">    9680 </span><span class="lineNoCov">          0 :                 res = (vms-&gt;newmessages == 1) ?</span>
<span class="lineNum">    9681 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;digits/un&quot;) ||</span>
<span class="lineNum">    9682 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-nuovo&quot;) ||</span>
<span class="lineNum">    9683 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-message&quot;) :</span>
<span class="lineNum">    9684 </span>            :                         /* 2 or more new messages */
<span class="lineNum">    9685 </span><span class="lineNoCov">          0 :                         say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan)) ||</span>
<span class="lineNum">    9686 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-nuovi&quot;) ||</span>
<span class="lineNum">    9687 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9688 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages)</span>
<span class="lineNum">    9689 </span><span class="lineNoCov">          0 :                         res =   ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9690 </span>            :         }
<span class="lineNum">    9691 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9692 </span><span class="lineNoCov">          0 :                 res = (vms-&gt;oldmessages == 1) ?</span>
<span class="lineNum">    9693 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;digits/un&quot;) ||</span>
<span class="lineNum">    9694 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-vecchio&quot;) ||</span>
<span class="lineNum">    9695 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-message&quot;) :</span>
<span class="lineNum">    9696 </span>            :                         /* 2 or more old messages */
<span class="lineNum">    9697 </span><span class="lineNoCov">          0 :                         say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan)) ||</span>
<span class="lineNum">    9698 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-vecchi&quot;) ||</span>
<span class="lineNum">    9699 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9700 </span>            :         }
<span class="lineNum">    9701 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9702 </span>            : }
<a name="9703"><span class="lineNum">    9703 </span>            : </a>
<span class="lineNum">    9704 </span>            : /* POLISH syntax */
<span class="lineNum">    9705 </span><span class="lineNoCov">          0 : static int vm_intro_pl(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9706 </span>            : {
<span class="lineNum">    9707 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9708 </span>            :         int res;
<span class="lineNum">    9709 </span>            :         div_t num;
<span class="lineNum">    9710 </span>            : 
<span class="lineNum">    9711 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">    9712 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9713 </span><span class="lineNoCov">          0 :                 res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9714 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9715 </span>            :         } else {
<span class="lineNum">    9716 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9717 </span>            :         }
<span class="lineNum">    9718 </span>            : 
<span class="lineNum">    9719 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9720 </span><span class="lineNoCov">          0 :                 num = div(vms-&gt;newmessages, 10);</span>
<span class="lineNum">    9721 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9722 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/1-a&quot;);</span>
<span class="lineNum">    9723 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-new-a&quot;);</span>
<span class="lineNum">    9724 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9725 </span><span class="lineNoCov">          0 :                 } else if (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</span>
<span class="lineNum">    9726 </span><span class="lineNoCov">          0 :                         if (num.rem == 2) {</span>
<span class="lineNum">    9727 </span><span class="lineNoCov">          0 :                                 if (!num.quot) {</span>
<span class="lineNum">    9728 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    9729 </span>            :                                 } else {
<span class="lineNum">    9730 </span><span class="lineNoCov">          0 :                                         res = say_and_wait(chan, vms-&gt;newmessages - 2 , ast_channel_language(chan));</span>
<span class="lineNum">    9731 </span><span class="lineNoCov">          0 :                                         res = res ? res : ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    9732 </span>            :                                 }
<span class="lineNum">    9733 </span>            :                         } else {
<span class="lineNum">    9734 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9735 </span>            :                         }
<span class="lineNum">    9736 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-new-e&quot;);</span>
<span class="lineNum">    9737 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9738 </span>            :                 } else {
<span class="lineNum">    9739 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9740 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-new-ych&quot;);</span>
<span class="lineNum">    9741 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9742 </span>            :                 }
<span class="lineNum">    9743 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages)</span>
<span class="lineNum">    9744 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9745 </span>            :         }
<span class="lineNum">    9746 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9747 </span><span class="lineNoCov">          0 :                 num = div(vms-&gt;oldmessages, 10);</span>
<span class="lineNum">    9748 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9749 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/1-a&quot;);</span>
<span class="lineNum">    9750 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-old-a&quot;);</span>
<span class="lineNum">    9751 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9752 </span><span class="lineNoCov">          0 :                 } else if (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {</span>
<span class="lineNum">    9753 </span><span class="lineNoCov">          0 :                         if (num.rem == 2) {</span>
<span class="lineNum">    9754 </span><span class="lineNoCov">          0 :                                 if (!num.quot) {</span>
<span class="lineNum">    9755 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    9756 </span>            :                                 } else {
<span class="lineNum">    9757 </span><span class="lineNoCov">          0 :                                         res = say_and_wait(chan, vms-&gt;oldmessages - 2 , ast_channel_language(chan));</span>
<span class="lineNum">    9758 </span><span class="lineNoCov">          0 :                                         res = res ? res : ast_play_and_wait(chan, &quot;digits/2-ie&quot;);</span>
<span class="lineNum">    9759 </span>            :                                 }
<span class="lineNum">    9760 </span>            :                         } else {
<span class="lineNum">    9761 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9762 </span>            :                         }
<span class="lineNum">    9763 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-old-e&quot;);</span>
<span class="lineNum">    9764 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9765 </span>            :                 } else {
<span class="lineNum">    9766 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9767 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-old-ych&quot;);</span>
<span class="lineNum">    9768 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9769 </span>            :                 }
<span class="lineNum">    9770 </span>            :         }
<span class="lineNum">    9771 </span>            : 
<span class="lineNum">    9772 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9773 </span>            : }
<a name="9774"><span class="lineNum">    9774 </span>            : </a>
<span class="lineNum">    9775 </span>            : /* SWEDISH syntax */
<span class="lineNum">    9776 </span><span class="lineNoCov">          0 : static int vm_intro_se(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9777 </span>            : {
<span class="lineNum">    9778 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9779 </span>            :         int res;
<span class="lineNum">    9780 </span>            : 
<span class="lineNum">    9781 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9782 </span><span class="lineNoCov">          0 :         if (res)</span>
<span class="lineNum">    9783 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9784 </span>            : 
<span class="lineNum">    9785 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9786 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9787 </span><span class="lineNoCov">          0 :                 res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9788 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9789 </span>            :         }
<span class="lineNum">    9790 </span>            : 
<span class="lineNum">    9791 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9792 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9793 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/ett&quot;);</span>
<span class="lineNum">    9794 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-nytt&quot;);</span>
<span class="lineNum">    9795 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9796 </span>            :                 } else {
<span class="lineNum">    9797 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9798 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-nya&quot;);</span>
<span class="lineNum">    9799 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9800 </span>            :                 }
<span class="lineNum">    9801 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages)</span>
<span class="lineNum">    9802 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9803 </span>            :         }
<span class="lineNum">    9804 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9805 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9806 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/ett&quot;);</span>
<span class="lineNum">    9807 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-gammalt&quot;);</span>
<span class="lineNum">    9808 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9809 </span>            :                 } else {
<span class="lineNum">    9810 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9811 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-gamla&quot;);</span>
<span class="lineNum">    9812 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9813 </span>            :                 }
<span class="lineNum">    9814 </span>            :         }
<span class="lineNum">    9815 </span>            : 
<span class="lineNum">    9816 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9817 </span>            : }
<a name="9818"><span class="lineNum">    9818 </span>            : </a>
<span class="lineNum">    9819 </span>            : /* NORWEGIAN syntax */
<span class="lineNum">    9820 </span><span class="lineNoCov">          0 : static int vm_intro_no(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9821 </span>            : {
<span class="lineNum">    9822 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9823 </span>            :         int res;
<span class="lineNum">    9824 </span>            : 
<span class="lineNum">    9825 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9826 </span><span class="lineNoCov">          0 :         if (res)</span>
<span class="lineNum">    9827 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9828 </span>            : 
<span class="lineNum">    9829 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9830 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9831 </span><span class="lineNoCov">          0 :                 res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9832 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9833 </span>            :         }
<span class="lineNum">    9834 </span>            : 
<span class="lineNum">    9835 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9836 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9837 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">    9838 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-ny&quot;);</span>
<span class="lineNum">    9839 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9840 </span>            :                 } else {
<span class="lineNum">    9841 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9842 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-nye&quot;);</span>
<span class="lineNum">    9843 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9844 </span>            :                 }
<span class="lineNum">    9845 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages)</span>
<span class="lineNum">    9846 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9847 </span>            :         }
<span class="lineNum">    9848 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9849 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9850 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">    9851 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-gamel&quot;);</span>
<span class="lineNum">    9852 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9853 </span>            :                 } else {
<span class="lineNum">    9854 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9855 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-gamle&quot;);</span>
<span class="lineNum">    9856 </span><span class="lineNoCov">          0 :                         res = res ? res : ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9857 </span>            :                 }
<span class="lineNum">    9858 </span>            :         }
<span class="lineNum">    9859 </span>            : 
<span class="lineNum">    9860 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9861 </span>            : }
<a name="9862"><span class="lineNum">    9862 </span>            : </a>
<span class="lineNum">    9863 </span>            : /* GERMAN syntax */
<span class="lineNum">    9864 </span><span class="lineNoCov">          0 : static int vm_intro_de(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9865 </span>            : {
<span class="lineNum">    9866 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9867 </span>            :         int res;
<span class="lineNum">    9868 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9869 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">    9870 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9871 </span><span class="lineNoCov">          0 :                         if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">    9872 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;digits/1F&quot;);</span>
<span class="lineNum">    9873 </span>            :                         else
<span class="lineNum">    9874 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9875 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9876 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9877 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9878 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9879 </span><span class="lineNoCov">          0 :                         else if (!res) {</span>
<span class="lineNum">    9880 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">    9881 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9882 </span>            :                                 else
<span class="lineNum">    9883 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9884 </span>            :                         }
<span class="lineNum">    9885 </span>            : 
<span class="lineNum">    9886 </span>            :                 }
<span class="lineNum">    9887 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">    9888 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">    9889 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;digits/1F&quot;);</span>
<span class="lineNum">    9890 </span>            :                         else
<span class="lineNum">    9891 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9892 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9893 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9894 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    9895 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">    9896 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9897 </span>            :                                 else
<span class="lineNum">    9898 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9899 </span>            :                         }
<span class="lineNum">    9900 </span>            :                 }
<span class="lineNum">    9901 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">    9902 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9903 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">    9904 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">    9905 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9906 </span>            :                         }
<span class="lineNum">    9907 </span>            :                 }
<span class="lineNum">    9908 </span>            :         }
<span class="lineNum">    9909 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    9910 </span>            : }
<a name="9911"><span class="lineNum">    9911 </span>            : </a>
<span class="lineNum">    9912 </span>            : /* SPANISH syntax */
<span class="lineNum">    9913 </span><span class="lineNoCov">          0 : static int vm_intro_es(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">    9914 </span>            : {
<span class="lineNum">    9915 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9916 </span>            :         int res;
<span class="lineNum">    9917 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9918 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhaveno&quot;);</span>
<span class="lineNum">    9919 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">    9920 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9921 </span>            :         } else {
<span class="lineNum">    9922 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9923 </span>            :         }
<span class="lineNum">    9924 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">    9925 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9926 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    9927 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9928 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/1M&quot;);</span>
<span class="lineNum">    9929 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9930 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9931 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9932 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-INBOXs&quot;);</span>
<span class="lineNum">    9933 </span>            :                                 } else {
<span class="lineNum">    9934 </span><span class="lineNoCov">          0 :                                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9935 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9936 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9937 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9938 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9939 </span>            :                                 }
<span class="lineNum">    9940 </span>            :                         }
<span class="lineNum">    9941 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9942 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9943 </span>            :                 }
<span class="lineNum">    9944 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages) {</span>
<span class="lineNum">    9945 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">    9946 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9947 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/1M&quot;);</span>
<span class="lineNum">    9948 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9949 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9950 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9951 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-Olds&quot;);</span>
<span class="lineNum">    9952 </span>            :                                 } else {
<span class="lineNum">    9953 </span><span class="lineNoCov">          0 :                                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">    9954 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9955 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9956 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">    9957 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">    9958 </span>            :                                 }
<span class="lineNum">    9959 </span>            :                         }
<span class="lineNum">    9960 </span>            :                 }
<span class="lineNum">    9961 </span>            :         }
<span class="lineNum">    9962 </span><span class="lineNoCov">          0 : return res;</span>
<span class="lineNum">    9963 </span>            : }
<a name="9964"><span class="lineNum">    9964 </span>            : </a>
<span class="lineNum">    9965 </span>            : /* BRAZILIAN PORTUGUESE syntax */
<span class="lineNum">    9966 </span><span class="lineNoCov">          0 : static int vm_intro_pt_BR(struct ast_channel *chan, struct vm_state *vms) {</span>
<span class="lineNum">    9967 </span>            :         /* Introduce messages they have */
<span class="lineNum">    9968 </span>            :         int res;
<span class="lineNum">    9969 </span><span class="lineNoCov">          0 :         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">    9970 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-nomessages&quot;);</span>
<span class="lineNum">    9971 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    9972 </span>            :         } else {
<span class="lineNum">    9973 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">    9974 </span>            :         }
<span class="lineNum">    9975 </span><span class="lineNoCov">          0 :         if (vms-&gt;newmessages) {</span>
<span class="lineNum">    9976 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">    9977 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;newmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    9978 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">    9979 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9980 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9981 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9982 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOXs&quot;);</span>
<span class="lineNum">    9983 </span>            :                 } else {
<span class="lineNum">    9984 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9985 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">    9986 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9987 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">    9988 </span>            :                 }
<span class="lineNum">    9989 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">    9990 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">    9991 </span>            :         }
<span class="lineNum">    9992 </span><span class="lineNoCov">          0 :         if (vms-&gt;oldmessages) {</span>
<span class="lineNum">    9993 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">    9994 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;oldmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">    9995 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">    9996 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9997 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">    9998 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">    9999 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Olds&quot;);</span>
<span class="lineNum">   10000 </span>            :                 } else {
<span class="lineNum">   10001 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10002 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10003 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10004 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10005 </span>            :                 }
<span class="lineNum">   10006 </span>            :         }
<span class="lineNum">   10007 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10008 </span>            : }
<a name="10009"><span class="lineNum">   10009 </span>            : </a>
<span class="lineNum">   10010 </span>            : /* FRENCH syntax */
<span class="lineNum">   10011 </span><span class="lineNoCov">          0 : static int vm_intro_fr(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10012 </span>            : {
<span class="lineNum">   10013 </span>            :         /* Introduce messages they have */
<span class="lineNum">   10014 </span>            :         int res;
<span class="lineNum">   10015 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10016 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   10017 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">   10018 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10019 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10020 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">   10021 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10022 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10023 </span><span class="lineNoCov">          0 :                         else if (!res) {</span>
<span class="lineNum">   10024 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">   10025 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10026 </span>            :                                 else
<span class="lineNum">   10027 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10028 </span>            :                         }
<span class="lineNum">   10029 </span>            : 
<span class="lineNum">   10030 </span>            :                 }
<span class="lineNum">   10031 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10032 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10033 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10034 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10035 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10036 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">   10037 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10038 </span>            :                                 else
<span class="lineNum">   10039 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10040 </span>            :                         }
<span class="lineNum">   10041 </span>            :                 }
<span class="lineNum">   10042 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10043 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">   10044 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10045 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10046 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10047 </span>            :                         }
<span class="lineNum">   10048 </span>            :                 }
<span class="lineNum">   10049 </span>            :         }
<span class="lineNum">   10050 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10051 </span>            : }
<a name="10052"><span class="lineNum">   10052 </span>            : </a>
<span class="lineNum">   10053 </span>            : /* DUTCH syntax */
<span class="lineNum">   10054 </span><span class="lineNoCov">          0 : static int vm_intro_nl(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10055 </span>            : {
<span class="lineNum">   10056 </span>            :         /* Introduce messages they have */
<span class="lineNum">   10057 </span>            :         int res;
<span class="lineNum">   10058 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10059 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   10060 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">   10061 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10062 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10063 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">   10064 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-INBOXs&quot;);</span>
<span class="lineNum">   10065 </span>            :                                 else
<span class="lineNum">   10066 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">   10067 </span>            :                         }
<span class="lineNum">   10068 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10069 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10070 </span><span class="lineNoCov">          0 :                         else if (!res) {</span>
<span class="lineNum">   10071 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">   10072 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10073 </span>            :                                 else
<span class="lineNum">   10074 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10075 </span>            :                         }
<span class="lineNum">   10076 </span>            : 
<span class="lineNum">   10077 </span>            :                 }
<span class="lineNum">   10078 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10079 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10080 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10081 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">   10082 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Olds&quot;);</span>
<span class="lineNum">   10083 </span>            :                                 else
<span class="lineNum">   10084 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10085 </span>            :                         }
<span class="lineNum">   10086 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10087 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">   10088 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10089 </span>            :                                 else
<span class="lineNum">   10090 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10091 </span>            :                         }
<span class="lineNum">   10092 </span>            :                 }
<span class="lineNum">   10093 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10094 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">   10095 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10096 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10097 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10098 </span>            :                         }
<span class="lineNum">   10099 </span>            :                 }
<span class="lineNum">   10100 </span>            :         }
<span class="lineNum">   10101 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10102 </span>            : }
<a name="10103"><span class="lineNum">   10103 </span>            : </a>
<span class="lineNum">   10104 </span>            : /* PORTUGUESE syntax */
<span class="lineNum">   10105 </span><span class="lineNoCov">          0 : static int vm_intro_pt(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10106 </span>            : {
<span class="lineNum">   10107 </span>            :         /* Introduce messages they have */
<span class="lineNum">   10108 </span>            :         int res;
<span class="lineNum">   10109 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10110 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   10111 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">   10112 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;newmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">   10113 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10114 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">   10115 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10116 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">   10117 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-INBOXs&quot;);</span>
<span class="lineNum">   10118 </span>            :                                 } else {
<span class="lineNum">   10119 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10120 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">   10121 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">   10122 </span>            :                                 }
<span class="lineNum">   10123 </span>            :                         }
<span class="lineNum">   10124 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10125 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10126 </span>            :                 }
<span class="lineNum">   10127 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10128 </span><span class="lineNoCov">          0 :                         res = ast_say_number(chan, vms-&gt;oldmessages, AST_DIGIT_ANY, ast_channel_language(chan), &quot;f&quot;);</span>
<span class="lineNum">   10129 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10130 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1) {</span>
<span class="lineNum">   10131 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10132 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">   10133 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-Olds&quot;);</span>
<span class="lineNum">   10134 </span>            :                                 } else {
<span class="lineNum">   10135 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10136 </span><span class="lineNoCov">          0 :                                         if (!res)</span>
<span class="lineNum">   10137 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10138 </span>            :                                 }
<span class="lineNum">   10139 </span>            :                         }
<span class="lineNum">   10140 </span>            :                 }
<span class="lineNum">   10141 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10142 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">   10143 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10144 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10145 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10146 </span>            :                         }
<span class="lineNum">   10147 </span>            :                 }
<span class="lineNum">   10148 </span>            :         }
<span class="lineNum">   10149 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10150 </span>            : }
<span class="lineNum">   10151 </span>            : 
<span class="lineNum">   10152 </span>            : 
<span class="lineNum">   10153 </span>            : /* CZECH syntax */
<span class="lineNum">   10154 </span>            : /* in czech there must be declension of word new and message
<span class="lineNum">   10155 </span>            :  * czech        : english        : czech      : english
<span class="lineNum">   10156 </span>            :  * --------------------------------------------------------
<span class="lineNum">   10157 </span>            :  * vm-youhave   : you have
<span class="lineNum">   10158 </span>            :  * vm-novou     : one new        : vm-zpravu  : message
<span class="lineNum">   10159 </span>            :  * vm-nove      : 2-4 new        : vm-zpravy  : messages
<span class="lineNum">   10160 </span>            :  * vm-novych    : 5-infinite new : vm-zprav   : messages
<span class="lineNum">   10161 </span>            :  * vm-starou    : one old
<span class="lineNum">   10162 </span>            :  * vm-stare     : 2-4 old
<span class="lineNum">   10163 </span>            :  * vm-starych   : 5-infinite old
<span class="lineNum">   10164 </span>            :  * jednu        : one   - falling 4.
<span class="lineNum">   10165 </span>            :  * vm-no        : no  ( no messages )
<a name="10166"><span class="lineNum">   10166 </span>            :  */</a>
<span class="lineNum">   10167 </span>            : 
<span class="lineNum">   10168 </span><span class="lineNoCov">          0 : static int vm_intro_cs(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10169 </span>            : {
<span class="lineNum">   10170 </span>            :         int res;
<span class="lineNum">   10171 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10172 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   10173 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">   10174 </span><span class="lineNoCov">          0 :                         if (vms-&gt;newmessages == 1) {</span>
<span class="lineNum">   10175 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;digits/jednu&quot;);</span>
<span class="lineNum">   10176 </span>            :                         } else {
<span class="lineNum">   10177 </span><span class="lineNoCov">          0 :                                 res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10178 </span>            :                         }
<span class="lineNum">   10179 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10180 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">   10181 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-novou&quot;);</span>
<span class="lineNum">   10182 </span><span class="lineNoCov">          0 :                                 if ((vms-&gt;newmessages) &gt; 1 &amp;&amp; (vms-&gt;newmessages &lt; 5))</span>
<span class="lineNum">   10183 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-nove&quot;);</span>
<span class="lineNum">   10184 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages &gt; 4)</span>
<span class="lineNum">   10185 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-novych&quot;);</span>
<span class="lineNum">   10186 </span>            :                         }
<span class="lineNum">   10187 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10188 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10189 </span><span class="lineNoCov">          0 :                         else if (!res) {</span>
<span class="lineNum">   10190 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages == 1)</span>
<span class="lineNum">   10191 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zpravu&quot;);</span>
<span class="lineNum">   10192 </span><span class="lineNoCov">          0 :                                 if ((vms-&gt;newmessages) &gt; 1 &amp;&amp; (vms-&gt;newmessages &lt; 5))</span>
<span class="lineNum">   10193 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zpravy&quot;);</span>
<span class="lineNum">   10194 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;newmessages &gt; 4)</span>
<span class="lineNum">   10195 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zprav&quot;);</span>
<span class="lineNum">   10196 </span>            :                         }
<span class="lineNum">   10197 </span>            :                 }
<span class="lineNum">   10198 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10199 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10200 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10201 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">   10202 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-starou&quot;);</span>
<span class="lineNum">   10203 </span><span class="lineNoCov">          0 :                                 if ((vms-&gt;oldmessages) &gt; 1 &amp;&amp; (vms-&gt;oldmessages &lt; 5))</span>
<span class="lineNum">   10204 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-stare&quot;);</span>
<span class="lineNum">   10205 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages &gt; 4)</span>
<span class="lineNum">   10206 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-starych&quot;);</span>
<span class="lineNum">   10207 </span>            :                         }
<span class="lineNum">   10208 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10209 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages == 1)</span>
<span class="lineNum">   10210 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zpravu&quot;);</span>
<span class="lineNum">   10211 </span><span class="lineNoCov">          0 :                                 if ((vms-&gt;oldmessages) &gt; 1 &amp;&amp; (vms-&gt;oldmessages &lt; 5))</span>
<span class="lineNum">   10212 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zpravy&quot;);</span>
<span class="lineNum">   10213 </span><span class="lineNoCov">          0 :                                 if (vms-&gt;oldmessages &gt; 4)</span>
<span class="lineNum">   10214 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zprav&quot;);</span>
<span class="lineNum">   10215 </span>            :                         }
<span class="lineNum">   10216 </span>            :                 }
<span class="lineNum">   10217 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10218 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages &amp;&amp; !vms-&gt;urgentmessages) {</span>
<span class="lineNum">   10219 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10220 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10221 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-zpravy&quot;);</span>
<span class="lineNum">   10222 </span>            :                         }
<span class="lineNum">   10223 </span>            :                 }
<span class="lineNum">   10224 </span>            :         }
<span class="lineNum">   10225 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10226 </span>            : }
<a name="10227"><span class="lineNum">   10227 </span>            : </a>
<span class="lineNum">   10228 </span>            : /* CHINESE (Taiwan) syntax */
<span class="lineNum">   10229 </span><span class="lineNoCov">          0 : static int vm_intro_zh(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10230 </span>            : {
<span class="lineNum">   10231 </span>            :         int res;
<span class="lineNum">   10232 </span>            :         /* Introduce messages they have */
<span class="lineNum">   10233 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-you&quot;);</span>
<span class="lineNum">   10234 </span>            : 
<span class="lineNum">   10235 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;newmessages) {</span>
<span class="lineNum">   10236 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-have&quot;);</span>
<span class="lineNum">   10237 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10238 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10239 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10240 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-tong&quot;);</span>
<span class="lineNum">   10241 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10242 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">   10243 </span><span class="lineNoCov">          0 :                 if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10244 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10245 </span><span class="lineNoCov">          0 :                 else if (!res)</span>
<span class="lineNum">   10246 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10247 </span>            :         }
<span class="lineNum">   10248 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10249 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-have&quot;);</span>
<span class="lineNum">   10250 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10251 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10252 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10253 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-tong&quot;);</span>
<span class="lineNum">   10254 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10255 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10256 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10257 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10258 </span>            :         }
<span class="lineNum">   10259 </span><span class="lineNoCov">          0 :         if (!res &amp;&amp; !vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">   10260 </span><span class="lineNoCov">          0 :                 res = ast_play_and_wait(chan, &quot;vm-haveno&quot;);</span>
<span class="lineNum">   10261 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10262 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10263 </span>            :         }
<span class="lineNum">   10264 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   10265 </span>            : }
<a name="10266"><span class="lineNum">   10266 </span>            : </a>
<span class="lineNum">   10267 </span>            : /* Vietnamese syntax */
<span class="lineNum">   10268 </span><span class="lineNoCov">          0 : static int vm_intro_vi(struct ast_channel *chan, struct vm_state *vms)</span>
<span class="lineNum">   10269 </span>            : {
<span class="lineNum">   10270 </span>            :         int res;
<span class="lineNum">   10271 </span>            : 
<span class="lineNum">   10272 </span>            :         /* Introduce messages they have */
<span class="lineNum">   10273 </span><span class="lineNoCov">          0 :         res = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10274 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   10275 </span><span class="lineNoCov">          0 :                 if (vms-&gt;newmessages) {</span>
<span class="lineNum">   10276 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;newmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10277 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10278 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-INBOX&quot;);</span>
<span class="lineNum">   10279 </span><span class="lineNoCov">          0 :                         if (vms-&gt;oldmessages &amp;&amp; !res)</span>
<span class="lineNum">   10280 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-and&quot;);</span>
<span class="lineNum">   10281 </span>            :                 }
<span class="lineNum">   10282 </span><span class="lineNoCov">          0 :                 if (!res &amp;&amp; vms-&gt;oldmessages) {</span>
<span class="lineNum">   10283 </span><span class="lineNoCov">          0 :                         res = say_and_wait(chan, vms-&gt;oldmessages, ast_channel_language(chan));</span>
<span class="lineNum">   10284 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10285 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-Old&quot;);</span>
<span class="lineNum">   10286 </span>            :                 }
<span class="lineNum">   10287 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10288 </span><span class="lineNoCov">          0 :                         if (!vms-&gt;oldmessages &amp;&amp; !vms-&gt;newmessages) {</span>
<span class="lineNum">   10289 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10290 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10291 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10292 </span>            :                         }
<span class="lineNum">   10293 </span>            :                 }
<span class="lineNum">   10294 </span>            :         }
<span class="lineNum">   10295 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="10296"><span class="lineNum">   10296 </span>            : }</a>
<span class="lineNum">   10297 </span>            : 
<span class="lineNum">   10298 </span><span class="lineCov">         19 : static int vm_intro(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms)</span>
<span class="lineNum">   10299 </span>            : {
<span class="lineNum">   10300 </span>            :         char prefile[256];
<span class="lineNum">   10301 </span>            : 
<span class="lineNum">   10302 </span>            :         /* Notify the user that the temp greeting is set and give them the option to remove it */
<span class="lineNum">   10303 </span><span class="lineCov">         19 :         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/temp&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10304 </span><span class="lineCov">         19 :         if (ast_test_flag(vmu, VM_TEMPGREETWARN)) {</span>
<span class="lineNum">   10305 </span>            :                 RETRIEVE(prefile, -1, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   10306 </span><span class="lineNoCov">          0 :                 if (ast_fileexists(prefile, NULL, NULL) &gt; 0) {</span>
<span class="lineNum">   10307 </span><span class="lineNoCov">          0 :                         ast_play_and_wait(chan, &quot;vm-tempgreetactive&quot;);</span>
<span class="lineNum">   10308 </span>            :                 }
<span class="lineNum">   10309 </span>            :                 DISPOSE(prefile, -1);
<span class="lineNum">   10310 </span>            :         }
<span class="lineNum">   10311 </span>            : 
<span class="lineNum">   10312 </span>            :         /* Play voicemail intro - syntax is different for different languages */
<span class="lineNum">   10313 </span>            :         if (0) {
<span class="lineNum">   10314 </span>            :                 return 0;
<span class="lineNum">   10315 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;cs&quot;, 2)) {  /* CZECH syntax */</span>
<span class="lineNum">   10316 </span><span class="lineNoCov">          0 :                 return vm_intro_cs(chan, vms);</span>
<span class="lineNum">   10317 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;cz&quot;, 2)) {  /* deprecated CZECH syntax */</span>
<span class="lineNum">   10318 </span>            :                 static int deprecation_warning = 0;
<span class="lineNum">   10319 </span><span class="lineNoCov">          0 :                 if (deprecation_warning++ % 10 == 0) {</span>
<span class="lineNum">   10320 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;cz is not a standard language code.  Please switch to using cs instead.\n&quot;);</span>
<span class="lineNum">   10321 </span>            :                 }
<span class="lineNum">   10322 </span><span class="lineNoCov">          0 :                 return vm_intro_cs(chan, vms);</span>
<span class="lineNum">   10323 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;de&quot;, 2)) {  /* GERMAN syntax */</span>
<span class="lineNum">   10324 </span><span class="lineNoCov">          0 :                 return vm_intro_de(chan, vms);</span>
<span class="lineNum">   10325 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;es&quot;, 2)) {  /* SPANISH syntax */</span>
<span class="lineNum">   10326 </span><span class="lineNoCov">          0 :                 return vm_intro_es(chan, vms);</span>
<span class="lineNum">   10327 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;fr&quot;, 2)) {  /* FRENCH syntax */</span>
<span class="lineNum">   10328 </span><span class="lineNoCov">          0 :                 return vm_intro_fr(chan, vms);</span>
<span class="lineNum">   10329 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;gr&quot;, 2)) {  /* GREEK syntax */</span>
<span class="lineNum">   10330 </span><span class="lineNoCov">          0 :                 return vm_intro_gr(chan, vms);</span>
<span class="lineNum">   10331 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;he&quot;, 2)) {  /* HEBREW syntax */</span>
<span class="lineNum">   10332 </span><span class="lineNoCov">          0 :                 return vm_intro_he(chan, vms);</span>
<span class="lineNum">   10333 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;is&quot;, 2)) {  /* ICELANDIC syntax */</span>
<span class="lineNum">   10334 </span><span class="lineNoCov">          0 :                 return vm_intro_is(chan, vms);</span>
<span class="lineNum">   10335 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;it&quot;, 2)) {  /* ITALIAN syntax */</span>
<span class="lineNum">   10336 </span><span class="lineNoCov">          0 :                 return vm_intro_it(chan, vms);</span>
<span class="lineNum">   10337 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ja&quot;, 2)) {  /* JAPANESE syntax */</span>
<span class="lineNum">   10338 </span><span class="lineNoCov">          0 :                 return vm_intro_ja(chan, vms);</span>
<span class="lineNum">   10339 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;nl&quot;, 2)) {  /* DUTCH syntax */</span>
<span class="lineNum">   10340 </span><span class="lineNoCov">          0 :                 return vm_intro_nl(chan, vms);</span>
<span class="lineNum">   10341 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;no&quot;, 2)) {  /* NORWEGIAN syntax */</span>
<span class="lineNum">   10342 </span><span class="lineNoCov">          0 :                 return vm_intro_no(chan, vms);</span>
<span class="lineNum">   10343 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pl&quot;, 2)) {  /* POLISH syntax */</span>
<span class="lineNum">   10344 </span><span class="lineNoCov">          0 :                 return vm_intro_pl(chan, vms);</span>
<span class="lineNum">   10345 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pt_BR&quot;, 5)) {  /* BRAZILIAN PORTUGUESE syntax */</span>
<span class="lineNum">   10346 </span><span class="lineNoCov">          0 :                 return vm_intro_pt_BR(chan, vms);</span>
<span class="lineNum">   10347 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pt&quot;, 2)) {  /* PORTUGUESE syntax */</span>
<span class="lineNum">   10348 </span><span class="lineNoCov">          0 :                 return vm_intro_pt(chan, vms);</span>
<span class="lineNum">   10349 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ru&quot;, 2)) {  /* RUSSIAN syntax */</span>
<span class="lineNum">   10350 </span><span class="lineNoCov">          0 :                 return vm_intro_multilang(chan, vms, &quot;n&quot;);</span>
<span class="lineNum">   10351 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;se&quot;, 2)) {  /* SWEDISH syntax */</span>
<span class="lineNum">   10352 </span><span class="lineNoCov">          0 :                 return vm_intro_se(chan, vms);</span>
<span class="lineNum">   10353 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ua&quot;, 2)) {  /* UKRAINIAN syntax */</span>
<span class="lineNum">   10354 </span><span class="lineNoCov">          0 :                 return vm_intro_multilang(chan, vms, &quot;n&quot;);</span>
<span class="lineNum">   10355 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;vi&quot;, 2)) { /* VIETNAMESE syntax */</span>
<span class="lineNum">   10356 </span><span class="lineNoCov">          0 :                 return vm_intro_vi(chan, vms);</span>
<span class="lineNum">   10357 </span><span class="lineCov">         19 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;zh&quot;, 2)) { /* CHINESE (Taiwan) syntax */</span>
<span class="lineNum">   10358 </span><span class="lineNoCov">          0 :                 return vm_intro_zh(chan, vms);</span>
<span class="lineNum">   10359 </span>            :         } else {                                             /* Default to ENGLISH */
<span class="lineNum">   10360 </span><span class="lineCov">         19 :                 return vm_intro_en(chan, vms);</span>
<span class="lineNum">   10361 </span>            :         }
<a name="10362"><span class="lineNum">   10362 </span>            : }</a>
<span class="lineNum">   10363 </span>            : 
<span class="lineNum">   10364 </span><span class="lineCov">         44 : static int vm_instructions_en(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</span>
<span class="lineNum">   10365 </span>            : {
<span class="lineNum">   10366 </span><span class="lineCov">         44 :         int res = 0;</span>
<span class="lineNum">   10367 </span>            :         /* Play instructions and wait for new command */
<span class="lineNum">   10368 </span><span class="lineCov">         88 :         while (!res) {</span>
<span class="lineNum">   10369 </span><span class="lineCov">         44 :                 if (vms-&gt;starting) {</span>
<span class="lineNum">   10370 </span><span class="lineCov">         25 :                         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10371 </span><span class="lineCov">          9 :                                 if (skipadvanced)</span>
<span class="lineNum">   10372 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-onefor-full&quot;);</span>
<span class="lineNum">   10373 </span>            :                                 else
<span class="lineNum">   10374 </span><span class="lineCov">          9 :                                         res = ast_play_and_wait(chan, &quot;vm-onefor&quot;);</span>
<span class="lineNum">   10375 </span><span class="lineCov">          9 :                                 if (!res)</span>
<span class="lineNum">   10376 </span><span class="lineNoCov">          0 :                                         res = vm_play_folder_name(chan, vms-&gt;vmbox);</span>
<span class="lineNum">   10377 </span>            :                         }
<span class="lineNum">   10378 </span><span class="lineCov">         25 :                         if (!res) {</span>
<span class="lineNum">   10379 </span><span class="lineCov">         16 :                                 if (skipadvanced)</span>
<span class="lineNum">   10380 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-opts-full&quot;);</span>
<span class="lineNum">   10381 </span>            :                                 else
<span class="lineNum">   10382 </span><span class="lineCov">         16 :                                         res = ast_play_and_wait(chan, &quot;vm-opts&quot;);</span>
<span class="lineNum">   10383 </span>            :                         }
<span class="lineNum">   10384 </span>            :                 } else {
<span class="lineNum">   10385 </span>            :                         /* Added for additional help */
<span class="lineNum">   10386 </span><span class="lineCov">         19 :                         if (skipadvanced) {</span>
<span class="lineNum">   10387 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-onefor-full&quot;);</span>
<span class="lineNum">   10388 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10389 </span><span class="lineNoCov">          0 :                                         res = vm_play_folder_name(chan, vms-&gt;vmbox);</span>
<span class="lineNum">   10390 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-opts-full&quot;);</span>
<span class="lineNum">   10391 </span>            :                         }
<span class="lineNum">   10392 </span>            :                         /* Logic:
<span class="lineNum">   10393 </span>            :                          * If the current message is not the first OR
<span class="lineNum">   10394 </span>            :                          * if we're listening to the first new message and there are
<span class="lineNum">   10395 </span>            :                          * also urgent messages, then prompt for navigation to the
<span class="lineNum">   10396 </span>            :                          * previous message
<span class="lineNum">   10397 </span>            :                          */
<span class="lineNum">   10398 </span><span class="lineCov">         19 :                         if (vms-&gt;curmsg || (!in_urgent &amp;&amp; vms-&gt;urgentmessages &gt; 0) || (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms-&gt;lastmsg &gt; 0)) {</span>
<span class="lineNum">   10399 </span><span class="lineCov">          5 :                                 res = ast_play_and_wait(chan, &quot;vm-prev&quot;);</span>
<span class="lineNum">   10400 </span>            :                         }
<span class="lineNum">   10401 </span><span class="lineCov">         19 :                         if (!res &amp;&amp; !skipadvanced)</span>
<span class="lineNum">   10402 </span><span class="lineCov">         14 :                                 res = ast_play_and_wait(chan, &quot;vm-advopts&quot;);</span>
<span class="lineNum">   10403 </span><span class="lineCov">         19 :                         if (!res)</span>
<span class="lineNum">   10404 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-repeat&quot;);</span>
<span class="lineNum">   10405 </span>            :                         /* Logic:
<span class="lineNum">   10406 </span>            :                          * If we're not listening to the last message OR
<span class="lineNum">   10407 </span>            :                          * we're listening to the last urgent message and there are
<span class="lineNum">   10408 </span>            :                          * also new non-urgent messages, then prompt for navigation
<span class="lineNum">   10409 </span>            :                          * to the next message
<span class="lineNum">   10410 </span>            :                          */
<span class="lineNum">   10411 </span><span class="lineCov">         19 :                         if (!res &amp;&amp; ((vms-&gt;curmsg != vms-&gt;lastmsg) || (in_urgent &amp;&amp; vms-&gt;newmessages &gt; 0) ||</span>
<span class="lineNum">   10412 </span><span class="lineNoCov">          0 :                                 (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms-&gt;lastmsg &gt; 0) )) {</span>
<span class="lineNum">   10413 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-next&quot;);</span>
<span class="lineNum">   10414 </span>            :                         }
<span class="lineNum">   10415 </span><span class="lineCov">         19 :                         if (!res) {</span>
<span class="lineNum">   10416 </span>            :                                 int curmsg_deleted;
<span class="lineNum">   10417 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   10418 </span>            :                                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">   10419 </span>            : #endif
<span class="lineNum">   10420 </span><span class="lineNoCov">          0 :                                 curmsg_deleted = vms-&gt;deleted[vms-&gt;curmsg];</span>
<span class="lineNum">   10421 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   10422 </span>            :                                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">   10423 </span>            : #endif
<span class="lineNum">   10424 </span><span class="lineNoCov">          0 :                                 if (!curmsg_deleted) {</span>
<span class="lineNum">   10425 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-delete&quot;);</span>
<span class="lineNum">   10426 </span>            :                                 } else {
<span class="lineNum">   10427 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-undelete&quot;);</span>
<span class="lineNum">   10428 </span>            :                                 }
<span class="lineNum">   10429 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">   10430 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-toforward&quot;);</span>
<span class="lineNum">   10431 </span>            :                                 }
<span class="lineNum">   10432 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">   10433 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-savemessage&quot;);</span>
<span class="lineNum">   10434 </span>            :                                 }
<span class="lineNum">   10435 </span>            :                         }
<span class="lineNum">   10436 </span>            :                 }
<span class="lineNum">   10437 </span><span class="lineCov">         44 :                 if (!res) {</span>
<span class="lineNum">   10438 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-helpexit&quot;);</span>
<span class="lineNum">   10439 </span>            :                 }
<span class="lineNum">   10440 </span><span class="lineCov">         44 :                 if (!res)</span>
<span class="lineNum">   10441 </span><span class="lineNoCov">          0 :                         res = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   10442 </span><span class="lineCov">         44 :                 if (!res) {</span>
<span class="lineNum">   10443 </span><span class="lineNoCov">          0 :                         vms-&gt;repeats++;</span>
<span class="lineNum">   10444 </span><span class="lineNoCov">          0 :                         if (vms-&gt;repeats &gt; 2) {</span>
<span class="lineNum">   10445 </span><span class="lineNoCov">          0 :                                 res = 't';</span>
<span class="lineNum">   10446 </span>            :                         }
<span class="lineNum">   10447 </span>            :                 }
<span class="lineNum">   10448 </span>            :         }
<span class="lineNum">   10449 </span><span class="lineCov">         44 :         return res;</span>
<a name="10450"><span class="lineNum">   10450 </span>            : }</a>
<span class="lineNum">   10451 </span>            : 
<span class="lineNum">   10452 </span><span class="lineNoCov">          0 : static int vm_instructions_ja(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms,  int skipadvanced, int in_urgent)</span>
<span class="lineNum">   10453 </span>            : {
<span class="lineNum">   10454 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">   10455 </span>            :         /* Play instructions and wait for new command */
<span class="lineNum">   10456 </span><span class="lineNoCov">          0 :         while (!res) {</span>
<span class="lineNum">   10457 </span><span class="lineNoCov">          0 :                 if (vms-&gt;starting) {</span>
<span class="lineNum">   10458 </span><span class="lineNoCov">          0 :                         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10459 </span><span class="lineNoCov">          0 :                                 res = vm_play_folder_name(chan, vms-&gt;vmbox);</span>
<span class="lineNum">   10460 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10461 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;jp-wa&quot;);</span>
<span class="lineNum">   10462 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10463 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">   10464 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10465 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;jp-wo&quot;);</span>
<span class="lineNum">   10466 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10467 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;silence/1&quot;);</span>
<span class="lineNum">   10468 </span>            :                         }
<span class="lineNum">   10469 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10470 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-opts&quot;);</span>
<span class="lineNum">   10471 </span>            :                 } else {
<span class="lineNum">   10472 </span>            :                         /* Added for additional help */
<span class="lineNum">   10473 </span><span class="lineNoCov">          0 :                         if (skipadvanced) {</span>
<span class="lineNum">   10474 </span><span class="lineNoCov">          0 :                                 res = vm_play_folder_name(chan, vms-&gt;vmbox);</span>
<span class="lineNum">   10475 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10476 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;jp-wa&quot;);</span>
<span class="lineNum">   10477 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10478 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">   10479 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10480 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;jp-wo&quot;);</span>
<span class="lineNum">   10481 </span><span class="lineNoCov">          0 :                                 if (!res)</span>
<span class="lineNum">   10482 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;silence/1&quot;);</span>
<span class="lineNum">   10483 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-opts-full&quot;);</span>
<span class="lineNum">   10484 </span>            :                         }
<span class="lineNum">   10485 </span>            :                         /* Logic:
<span class="lineNum">   10486 </span>            :                          * If the current message is not the first OR
<span class="lineNum">   10487 </span>            :                          * if we're listening to the first new message and there are
<span class="lineNum">   10488 </span>            :                          * also urgent messages, then prompt for navigation to the
<span class="lineNum">   10489 </span>            :                          * previous message
<span class="lineNum">   10490 </span>            :                          */
<span class="lineNum">   10491 </span><span class="lineNoCov">          0 :                         if (vms-&gt;curmsg || (!in_urgent &amp;&amp; vms-&gt;urgentmessages &gt; 0) || (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms-&gt;lastmsg &gt; 0)) {</span>
<span class="lineNum">   10492 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-prev&quot;);</span>
<span class="lineNum">   10493 </span>            :                         }
<span class="lineNum">   10494 </span><span class="lineNoCov">          0 :                         if (!res &amp;&amp; !skipadvanced)</span>
<span class="lineNum">   10495 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-advopts&quot;);</span>
<span class="lineNum">   10496 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10497 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-repeat&quot;);</span>
<span class="lineNum">   10498 </span>            :                         /* Logic:
<span class="lineNum">   10499 </span>            :                          * If we're not listening to the last message OR
<span class="lineNum">   10500 </span>            :                          * we're listening to the last urgent message and there are
<span class="lineNum">   10501 </span>            :                          * also new non-urgent messages, then prompt for navigation
<span class="lineNum">   10502 </span>            :                          * to the next message
<span class="lineNum">   10503 </span>            :                          */
<span class="lineNum">   10504 </span><span class="lineNoCov">          0 :                         if (!res &amp;&amp; ((vms-&gt;curmsg != vms-&gt;lastmsg) || (in_urgent &amp;&amp; vms-&gt;newmessages &gt; 0) ||</span>
<span class="lineNum">   10505 </span><span class="lineNoCov">          0 :                                 (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms-&gt;lastmsg &gt; 0) )) {</span>
<span class="lineNum">   10506 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-next&quot;);</span>
<span class="lineNum">   10507 </span>            :                         }
<span class="lineNum">   10508 </span><span class="lineNoCov">          0 :                         if (!res) {</span>
<span class="lineNum">   10509 </span>            :                                 int curmsg_deleted;
<span class="lineNum">   10510 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   10511 </span>            :                                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">   10512 </span>            : #endif
<span class="lineNum">   10513 </span><span class="lineNoCov">          0 :                                 curmsg_deleted = vms-&gt;deleted[vms-&gt;curmsg];</span>
<span class="lineNum">   10514 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   10515 </span>            :                                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">   10516 </span>            : #endif
<span class="lineNum">   10517 </span><span class="lineNoCov">          0 :                                 if (!curmsg_deleted) {</span>
<span class="lineNum">   10518 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-delete&quot;);</span>
<span class="lineNum">   10519 </span>            :                                 } else {
<span class="lineNum">   10520 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-undelete&quot;);</span>
<span class="lineNum">   10521 </span>            :                                 }
<span class="lineNum">   10522 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">   10523 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-toforward&quot;);</span>
<span class="lineNum">   10524 </span>            :                                 }
<span class="lineNum">   10525 </span><span class="lineNoCov">          0 :                                 if (!res) {</span>
<span class="lineNum">   10526 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-savemessage&quot;);</span>
<span class="lineNum">   10527 </span>            :                                 }
<span class="lineNum">   10528 </span>            :                         }
<span class="lineNum">   10529 </span>            :                 }
<span class="lineNum">   10530 </span>            : 
<span class="lineNum">   10531 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10532 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-helpexit&quot;);</span>
<span class="lineNum">   10533 </span>            :                 }
<span class="lineNum">   10534 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10535 </span><span class="lineNoCov">          0 :                         res = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   10536 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10537 </span><span class="lineNoCov">          0 :                         vms-&gt;repeats++;</span>
<span class="lineNum">   10538 </span><span class="lineNoCov">          0 :                         if (vms-&gt;repeats &gt; 2) {</span>
<span class="lineNum">   10539 </span><span class="lineNoCov">          0 :                                 res = 't';</span>
<span class="lineNum">   10540 </span>            :                         }
<span class="lineNum">   10541 </span>            :                 }
<span class="lineNum">   10542 </span>            : 
<span class="lineNum">   10543 </span>            :         }
<span class="lineNum">   10544 </span>            : 
<span class="lineNum">   10545 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="10546"><span class="lineNum">   10546 </span>            : }</a>
<span class="lineNum">   10547 </span>            : 
<span class="lineNum">   10548 </span><span class="lineNoCov">          0 : static int vm_instructions_zh(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms,  int skipadvanced, int in_urgent)</span>
<span class="lineNum">   10549 </span>            : {
<span class="lineNum">   10550 </span><span class="lineNoCov">          0 :         int res = 0;</span>
<span class="lineNum">   10551 </span>            :         /* Play instructions and wait for new command */
<span class="lineNum">   10552 </span><span class="lineNoCov">          0 :         while (!res) {</span>
<span class="lineNum">   10553 </span><span class="lineNoCov">          0 :                 if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10554 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-listen&quot;);</span>
<span class="lineNum">   10555 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10556 </span><span class="lineNoCov">          0 :                                 res = vm_play_folder_name(chan, vms-&gt;vmbox);</span>
<span class="lineNum">   10557 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10558 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;press&quot;);</span>
<span class="lineNum">   10559 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   10560 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">   10561 </span>            :                 }
<span class="lineNum">   10562 </span><span class="lineNoCov">          0 :                 if (!res)</span>
<span class="lineNum">   10563 </span><span class="lineNoCov">          0 :                         res = ast_play_and_wait(chan, &quot;vm-opts&quot;);</span>
<span class="lineNum">   10564 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   10565 </span><span class="lineNoCov">          0 :                         vms-&gt;starting = 0;</span>
<span class="lineNum">   10566 </span><span class="lineNoCov">          0 :                         return vm_instructions_en(chan, vmu, vms, skipadvanced, in_urgent);</span>
<span class="lineNum">   10567 </span>            :                 }
<span class="lineNum">   10568 </span>            :         }
<span class="lineNum">   10569 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="10570"><span class="lineNum">   10570 </span>            : }</a>
<span class="lineNum">   10571 </span>            : 
<span class="lineNum">   10572 </span><span class="lineCov">         44 : static int vm_instructions(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int skipadvanced, int in_urgent)</span>
<span class="lineNum">   10573 </span>            : {
<span class="lineNum">   10574 </span><span class="lineCov">         44 :         if (!strncasecmp(ast_channel_language(chan), &quot;ja&quot;, 2)) { /* Japanese syntax */</span>
<span class="lineNum">   10575 </span><span class="lineNoCov">          0 :                 return vm_instructions_ja(chan, vmu, vms, skipadvanced, in_urgent);</span>
<span class="lineNum">   10576 </span><span class="lineCov">         44 :         } else if (vms-&gt;starting &amp;&amp; !strncasecmp(ast_channel_language(chan), &quot;zh&quot;, 2)) { /* CHINESE (Taiwan) syntax */</span>
<span class="lineNum">   10577 </span><span class="lineNoCov">          0 :                 return vm_instructions_zh(chan, vmu, vms, skipadvanced, in_urgent);</span>
<span class="lineNum">   10578 </span>            :         } else {                                        /* Default to ENGLISH */
<span class="lineNum">   10579 </span><span class="lineCov">         44 :                 return vm_instructions_en(chan, vmu, vms, skipadvanced, in_urgent);</span>
<span class="lineNum">   10580 </span>            :         }
<span class="lineNum">   10581 </span>            : }
<a name="10582"><span class="lineNum">   10582 </span>            : </a>
<span class="lineNum">   10583 </span>            : 
<span class="lineNum">   10584 </span><span class="lineCov">          2 : static int vm_newuser_setup(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</span>
<span class="lineNum">   10585 </span>            : {
<span class="lineNum">   10586 </span><span class="lineCov">          2 :         int cmd = 0;</span>
<span class="lineNum">   10587 </span><span class="lineCov">          2 :         int duration = 0;</span>
<span class="lineNum">   10588 </span><span class="lineCov">          2 :         int tries = 0;</span>
<span class="lineNum">   10589 </span><span class="lineCov">          2 :         char newpassword[80] = &quot;&quot;;</span>
<span class="lineNum">   10590 </span><span class="lineCov">          2 :         char newpassword2[80] = &quot;&quot;;</span>
<span class="lineNum">   10591 </span><span class="lineCov">          2 :         char prefile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">   10592 </span>            :         unsigned char buf[256];
<span class="lineNum">   10593 </span><span class="lineCov">          2 :         int bytes = 0;</span>
<span class="lineNum">   10594 </span>            : 
<span class="lineNum">   10595 </span><span class="lineCov">          2 :         ast_test_suite_event_notify(&quot;NEWUSER&quot;, &quot;Message: entering new user state&quot;);</span>
<span class="lineNum">   10596 </span><span class="lineCov">          2 :         if (ast_adsi_available(chan)) {</span>
<span class="lineNum">   10597 </span><span class="lineNoCov">          0 :                 bytes += adsi_logo(buf + bytes);</span>
<span class="lineNum">   10598 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;New User Setup&quot;, &quot;&quot;);</span>
<span class="lineNum">   10599 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;Not Done&quot;, &quot;&quot;);</span>
<span class="lineNum">   10600 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">   10601 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">   10602 </span><span class="lineNoCov">          0 :                 ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">   10603 </span>            :         }
<span class="lineNum">   10604 </span>            : 
<span class="lineNum">   10605 </span>            :         /* If forcename is set, have the user record their name */
<span class="lineNum">   10606 </span><span class="lineCov">          2 :         if (ast_test_flag(vmu, VM_FORCENAME)) {</span>
<span class="lineNum">   10607 </span><span class="lineCov">          2 :                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10608 </span><span class="lineCov">          2 :                 if (ast_fileexists(prefile, NULL, NULL) &lt; 1) {</span>
<span class="lineNum">   10609 </span><span class="lineCov">          2 :                         cmd = play_record_review(chan, &quot;vm-rec-name&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10610 </span><span class="lineCov">          2 :                         if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10611 </span><span class="lineNoCov">          0 :                                 return cmd;</span>
<span class="lineNum">   10612 </span>            :                 }
<span class="lineNum">   10613 </span>            :         }
<span class="lineNum">   10614 </span>            : 
<span class="lineNum">   10615 </span>            :         /* If forcegreetings is set, have the user record their greetings */
<span class="lineNum">   10616 </span><span class="lineCov">          2 :         if (ast_test_flag(vmu, VM_FORCEGREET)) {</span>
<span class="lineNum">   10617 </span><span class="lineCov">          2 :                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/unavail&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10618 </span><span class="lineCov">          2 :                 if (ast_fileexists(prefile, NULL, NULL) &lt; 1) {</span>
<span class="lineNum">   10619 </span><span class="lineCov">          2 :                         cmd = play_record_review(chan, &quot;vm-rec-unv&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10620 </span><span class="lineCov">          2 :                         if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10621 </span><span class="lineNoCov">          0 :                                 return cmd;</span>
<span class="lineNum">   10622 </span>            :                 }
<span class="lineNum">   10623 </span>            : 
<span class="lineNum">   10624 </span><span class="lineCov">          2 :                 snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/busy&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10625 </span><span class="lineCov">          2 :                 if (ast_fileexists(prefile, NULL, NULL) &lt; 1) {</span>
<span class="lineNum">   10626 </span><span class="lineCov">          2 :                         cmd = play_record_review(chan, &quot;vm-rec-busy&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10627 </span><span class="lineCov">          2 :                         if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10628 </span><span class="lineNoCov">          0 :                                 return cmd;</span>
<span class="lineNum">   10629 </span>            :                 }
<span class="lineNum">   10630 </span>            :         }
<span class="lineNum">   10631 </span>            : 
<span class="lineNum">   10632 </span>            :         /*
<span class="lineNum">   10633 </span>            :          * Change the password last since new users will be able to skip over any steps this one comes before
<span class="lineNum">   10634 </span>            :          * by hanging up and calling back to voicemail main since the password is used to verify new user status.
<span class="lineNum">   10635 </span>            :          */
<span class="lineNum">   10636 </span>            :         for (;;) {
<span class="lineNum">   10637 </span><span class="lineNoCov">          0 :                 newpassword[1] = '\0';</span>
<span class="lineNum">   10638 </span><span class="lineCov">          2 :                 newpassword[0] = cmd = ast_play_and_wait(chan, vm_newpassword);</span>
<span class="lineNum">   10639 </span><span class="lineCov">          2 :                 if (cmd == '#')</span>
<span class="lineNum">   10640 </span><span class="lineNoCov">          0 :                         newpassword[0] = '\0';</span>
<span class="lineNum">   10641 </span><span class="lineCov">          2 :                 if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10642 </span><span class="lineNoCov">          0 :                         return cmd;</span>
<span class="lineNum">   10643 </span><span class="lineCov">          2 :                 cmd = ast_readstring(chan, newpassword + strlen(newpassword), sizeof(newpassword) - 1, 2000, 10000, &quot;#&quot;);</span>
<span class="lineNum">   10644 </span><span class="lineCov">          2 :                 if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10645 </span><span class="lineNoCov">          0 :                         return cmd;</span>
<span class="lineNum">   10646 </span><span class="lineCov">          2 :                 cmd = check_password(vmu, newpassword); /* perform password validation */</span>
<span class="lineNum">   10647 </span><span class="lineCov">          2 :                 if (cmd != 0) {</span>
<span class="lineNum">   10648 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_NOTICE, &quot;Invalid password for user %s (%s)\n&quot;, vms-&gt;username, newpassword);</span>
<span class="lineNum">   10649 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vm_invalid_password);</span>
<span class="lineNum">   10650 </span>            :                 } else {
<span class="lineNum">   10651 </span><span class="lineCov">          2 :                         newpassword2[1] = '\0';</span>
<span class="lineNum">   10652 </span><span class="lineCov">          2 :                         newpassword2[0] = cmd = ast_play_and_wait(chan, vm_reenterpassword);</span>
<span class="lineNum">   10653 </span><span class="lineCov">          2 :                         if (cmd == '#')</span>
<span class="lineNum">   10654 </span><span class="lineNoCov">          0 :                                 newpassword2[0] = '\0';</span>
<span class="lineNum">   10655 </span><span class="lineCov">          2 :                         if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10656 </span><span class="lineCov">          1 :                                 return cmd;</span>
<span class="lineNum">   10657 </span><span class="lineCov">          1 :                         cmd = ast_readstring(chan, newpassword2 + strlen(newpassword2), sizeof(newpassword2) - 1, 2000, 10000, &quot;#&quot;);</span>
<span class="lineNum">   10658 </span><span class="lineCov">          1 :                         if (cmd &lt; 0 || cmd == 't' || cmd == '#')</span>
<span class="lineNum">   10659 </span><span class="lineNoCov">          0 :                                 return cmd;</span>
<span class="lineNum">   10660 </span><span class="lineCov">          1 :                         if (!strcmp(newpassword, newpassword2))</span>
<span class="lineNum">   10661 </span><span class="lineCov">          1 :                                 break;</span>
<span class="lineNum">   10662 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_NOTICE, &quot;Password mismatch for user %s (%s != %s)\n&quot;, vms-&gt;username, newpassword, newpassword2);</span>
<span class="lineNum">   10663 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vm_mismatch);</span>
<span class="lineNum">   10664 </span>            :                 }
<span class="lineNum">   10665 </span><span class="lineNoCov">          0 :                 if (++tries == 3)</span>
<span class="lineNum">   10666 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">   10667 </span><span class="lineNoCov">          0 :                 if (cmd != 0) {</span>
<span class="lineNum">   10668 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vm_pls_try_again);</span>
<span class="lineNum">   10669 </span>            :                 }
<span class="lineNum">   10670 </span>            :         }
<span class="lineNum">   10671 </span><span class="lineCov">          1 :         if (pwdchange &amp; PWDCHANGE_INTERNAL)</span>
<span class="lineNum">   10672 </span><span class="lineCov">          1 :                 vm_change_password(vmu, newpassword);</span>
<span class="lineNum">   10673 </span><span class="lineCov">          1 :         if ((pwdchange &amp; PWDCHANGE_EXTERNAL) &amp;&amp; !ast_strlen_zero(ext_pass_cmd))</span>
<span class="lineNum">   10674 </span><span class="lineNoCov">          0 :                 vm_change_password_shell(vmu, newpassword);</span>
<span class="lineNum">   10675 </span>            : 
<span class="lineNum">   10676 </span><span class="lineCov">          1 :         ast_debug(1, &quot;User %s set password to %s of length %d\n&quot;, vms-&gt;username, newpassword, (int) strlen(newpassword));</span>
<span class="lineNum">   10677 </span><span class="lineCov">          1 :         cmd = ast_play_and_wait(chan, vm_passchanged);</span>
<span class="lineNum">   10678 </span>            : 
<span class="lineNum">   10679 </span><span class="lineCov">          1 :         return cmd;</span>
<a name="10680"><span class="lineNum">   10680 </span>            : }</a>
<span class="lineNum">   10681 </span>            : 
<span class="lineNum">   10682 </span><span class="lineCov">          9 : static int vm_options(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</span>
<span class="lineNum">   10683 </span>            : {
<span class="lineNum">   10684 </span><span class="lineCov">          9 :         int cmd = 0;</span>
<span class="lineNum">   10685 </span><span class="lineCov">          9 :         int retries = 0;</span>
<span class="lineNum">   10686 </span><span class="lineCov">          9 :         int duration = 0;</span>
<span class="lineNum">   10687 </span><span class="lineCov">          9 :         char newpassword[80] = &quot;&quot;;</span>
<span class="lineNum">   10688 </span><span class="lineCov">          9 :         char newpassword2[80] = &quot;&quot;;</span>
<span class="lineNum">   10689 </span><span class="lineCov">          9 :         char prefile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">   10690 </span>            :         unsigned char buf[256];
<span class="lineNum">   10691 </span><span class="lineCov">          9 :         int bytes = 0;</span>
<span class="lineNum">   10692 </span>            : 
<span class="lineNum">   10693 </span><span class="lineCov">          9 :         ast_test_suite_event_notify(&quot;VMOPTIONS&quot;, &quot;Message: entering mailbox options&quot;);</span>
<span class="lineNum">   10694 </span><span class="lineCov">          9 :         if (ast_adsi_available(chan)) {</span>
<span class="lineNum">   10695 </span><span class="lineNoCov">          0 :                 bytes += adsi_logo(buf + bytes);</span>
<span class="lineNum">   10696 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Options Menu&quot;, &quot;&quot;);</span>
<span class="lineNum">   10697 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;Not Done&quot;, &quot;&quot;);</span>
<span class="lineNum">   10698 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">   10699 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">   10700 </span><span class="lineNoCov">          0 :                 ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">   10701 </span>            :         }
<span class="lineNum">   10702 </span><span class="lineCov">         48 :         while ((cmd &gt;= 0) &amp;&amp; (cmd != 't')) {</span>
<span class="lineNum">   10703 </span><span class="lineCov">         42 :                 if (cmd)</span>
<span class="lineNum">   10704 </span><span class="lineCov">         21 :                         retries = 0;</span>
<span class="lineNum">   10705 </span><span class="lineCov">         42 :                 switch (cmd) {</span>
<span class="lineNum">   10706 </span><span class="lineCov">          1 :                 case '1': /* Record your unavailable message */</span>
<span class="lineNum">   10707 </span><span class="lineCov">          1 :                         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/unavail&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10708 </span><span class="lineCov">          1 :                         cmd = play_record_review(chan, &quot;vm-rec-unv&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10709 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">   10710 </span><span class="lineCov">          1 :                 case '2':  /* Record your busy message */</span>
<span class="lineNum">   10711 </span><span class="lineCov">          1 :                         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/busy&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10712 </span><span class="lineCov">          1 :                         cmd = play_record_review(chan, &quot;vm-rec-busy&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10713 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">   10714 </span><span class="lineCov">          1 :                 case '3': /* Record greeting */</span>
<span class="lineNum">   10715 </span><span class="lineCov">          1 :                         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10716 </span><span class="lineCov">          1 :                         cmd = play_record_review(chan, &quot;vm-rec-name&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10717 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">   10718 </span><span class="lineCov">          2 :                 case '4':  /* manage the temporary greeting */</span>
<span class="lineNum">   10719 </span><span class="lineCov">          2 :                         cmd = vm_tempgreeting(chan, vmu, vms, fmtc, record_gain);</span>
<span class="lineNum">   10720 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">   10721 </span><span class="lineCov">         10 :                 case '5': /* change password */</span>
<span class="lineNum">   10722 </span><span class="lineCov">         10 :                         if (vmu-&gt;password[0] == '-') {</span>
<span class="lineNum">   10723 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10724 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   10725 </span>            :                         }
<span class="lineNum">   10726 </span><span class="lineCov">         10 :                         newpassword[1] = '\0';</span>
<span class="lineNum">   10727 </span><span class="lineCov">         10 :                         newpassword[0] = cmd = ast_play_and_wait(chan, vm_newpassword);</span>
<span class="lineNum">   10728 </span><span class="lineCov">         10 :                         if (cmd == '#')</span>
<span class="lineNum">   10729 </span><span class="lineNoCov">          0 :                                 newpassword[0] = '\0';</span>
<span class="lineNum">   10730 </span>            :                         else {
<span class="lineNum">   10731 </span><span class="lineCov">         10 :                                 if (cmd &lt; 0)</span>
<span class="lineNum">   10732 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   10733 </span><span class="lineCov">         10 :                                 if ((cmd = ast_readstring(chan, newpassword + strlen(newpassword), sizeof(newpassword) - 1, 2000, 10000, &quot;#&quot;)) &lt; 0) {</span>
<span class="lineNum">   10734 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   10735 </span>            :                                 }
<span class="lineNum">   10736 </span>            :                         }
<span class="lineNum">   10737 </span><span class="lineCov">         10 :                         cmd = check_password(vmu, newpassword); /* perform password validation */</span>
<span class="lineNum">   10738 </span><span class="lineCov">          7 :                         if (cmd != 0) {</span>
<span class="lineNum">   10739 </span><span class="lineCov">          5 :                                 ast_log(AST_LOG_NOTICE, &quot;Invalid password for user %s (%s)\n&quot;, vms-&gt;username, newpassword);</span>
<span class="lineNum">   10740 </span><span class="lineCov">          5 :                                 cmd = ast_play_and_wait(chan, vm_invalid_password);</span>
<span class="lineNum">   10741 </span><span class="lineCov">          5 :                                 if (!cmd) {</span>
<span class="lineNum">   10742 </span><span class="lineCov">          5 :                                         cmd = ast_play_and_wait(chan, vm_pls_try_again);</span>
<span class="lineNum">   10743 </span>            :                                 }
<span class="lineNum">   10744 </span><span class="lineCov">          5 :                                 break;</span>
<span class="lineNum">   10745 </span>            :                         }
<span class="lineNum">   10746 </span><span class="lineCov">          2 :                         newpassword2[1] = '\0';</span>
<span class="lineNum">   10747 </span><span class="lineCov">          2 :                         newpassword2[0] = cmd = ast_play_and_wait(chan, vm_reenterpassword);</span>
<span class="lineNum">   10748 </span><span class="lineCov">          2 :                         if (cmd == '#')</span>
<span class="lineNum">   10749 </span><span class="lineNoCov">          0 :                                 newpassword2[0] = '\0';</span>
<span class="lineNum">   10750 </span>            :                         else {
<span class="lineNum">   10751 </span><span class="lineCov">          2 :                                 if (cmd &lt; 0)</span>
<span class="lineNum">   10752 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   10753 </span>            : 
<span class="lineNum">   10754 </span><span class="lineCov">          2 :                                 if ((cmd = ast_readstring(chan, newpassword2 + strlen(newpassword2), sizeof(newpassword2) - 1, 2000, 10000, &quot;#&quot;)) &lt; 0) {</span>
<span class="lineNum">   10755 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   10756 </span>            :                                 }
<span class="lineNum">   10757 </span>            :                         }
<span class="lineNum">   10758 </span><span class="lineCov">          2 :                         if (strcmp(newpassword, newpassword2)) {</span>
<span class="lineNum">   10759 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_NOTICE, &quot;Password mismatch for user %s (%s != %s)\n&quot;, vms-&gt;username, newpassword, newpassword2);</span>
<span class="lineNum">   10760 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, vm_mismatch);</span>
<span class="lineNum">   10761 </span><span class="lineNoCov">          0 :                                 if (!cmd) {</span>
<span class="lineNum">   10762 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, vm_pls_try_again);</span>
<span class="lineNum">   10763 </span>            :                                 }
<span class="lineNum">   10764 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   10765 </span>            :                         }
<span class="lineNum">   10766 </span>            : 
<span class="lineNum">   10767 </span><span class="lineCov">          2 :                         if (pwdchange &amp; PWDCHANGE_INTERNAL) {</span>
<span class="lineNum">   10768 </span><span class="lineCov">          2 :                                 vm_change_password(vmu, newpassword);</span>
<span class="lineNum">   10769 </span>            :                         }
<span class="lineNum">   10770 </span><span class="lineCov">          2 :                         if ((pwdchange &amp; PWDCHANGE_EXTERNAL) &amp;&amp; !ast_strlen_zero(ext_pass_cmd)) {</span>
<span class="lineNum">   10771 </span><span class="lineCov">          1 :                                 vm_change_password_shell(vmu, newpassword);</span>
<span class="lineNum">   10772 </span>            :                         }
<span class="lineNum">   10773 </span>            : 
<span class="lineNum">   10774 </span><span class="lineCov">          2 :                         ast_debug(1, &quot;User %s set password to %s of length %d\n&quot;,</span>
<span class="lineNum">   10775 </span>            :                                 vms-&gt;username, newpassword, (int) strlen(newpassword));
<span class="lineNum">   10776 </span><span class="lineCov">          2 :                         cmd = ast_play_and_wait(chan, vm_passchanged);</span>
<span class="lineNum">   10777 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">   10778 </span><span class="lineCov">          6 :                 case '*':</span>
<span class="lineNum">   10779 </span><span class="lineCov">          6 :                         cmd = 't';</span>
<span class="lineNum">   10780 </span><span class="lineCov">          6 :                         break;</span>
<span class="lineNum">   10781 </span><span class="lineCov">         21 :                 default:</span>
<span class="lineNum">   10782 </span><span class="lineCov">         21 :                         cmd = 0;</span>
<span class="lineNum">   10783 </span><span class="lineCov">         21 :                         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/temp&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10784 </span>            :                         RETRIEVE(prefile, -1, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   10785 </span><span class="lineCov">         21 :                         if (ast_fileexists(prefile, NULL, NULL)) {</span>
<span class="lineNum">   10786 </span><span class="lineCov">          1 :                                 cmd = ast_play_and_wait(chan, &quot;vm-tmpexists&quot;);</span>
<span class="lineNum">   10787 </span>            :                         }
<span class="lineNum">   10788 </span>            :                         DISPOSE(prefile, -1);
<span class="lineNum">   10789 </span><span class="lineCov">         21 :                         if (!cmd) {</span>
<span class="lineNum">   10790 </span><span class="lineCov">         20 :                                 cmd = ast_play_and_wait(chan, &quot;vm-options&quot;);</span>
<span class="lineNum">   10791 </span>            :                         }
<span class="lineNum">   10792 </span><span class="lineCov">         21 :                         if (!cmd) {</span>
<span class="lineNum">   10793 </span><span class="lineNoCov">          0 :                                 cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   10794 </span>            :                         }
<span class="lineNum">   10795 </span><span class="lineCov">         21 :                         if (!cmd) {</span>
<span class="lineNum">   10796 </span><span class="lineNoCov">          0 :                                 retries++;</span>
<span class="lineNum">   10797 </span>            :                         }
<span class="lineNum">   10798 </span><span class="lineCov">         21 :                         if (retries &gt; 3) {</span>
<span class="lineNum">   10799 </span><span class="lineNoCov">          0 :                                 cmd = 't';</span>
<span class="lineNum">   10800 </span>            :                         }
<span class="lineNum">   10801 </span><span class="lineCov">         21 :                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   10802 </span>            :                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   10803 </span>            :                 }
<span class="lineNum">   10804 </span>            :         }
<span class="lineNum">   10805 </span><span class="lineCov">          6 :         if (cmd == 't')</span>
<span class="lineNum">   10806 </span><span class="lineCov">          6 :                 cmd = 0;</span>
<span class="lineNum">   10807 </span><span class="lineCov">          6 :         return cmd;</span>
<span class="lineNum">   10808 </span>            : }
<span class="lineNum">   10809 </span>            : 
<span class="lineNum">   10810 </span>            : /*!
<span class="lineNum">   10811 </span>            :  * \brief The handler for 'record a temporary greeting'.
<span class="lineNum">   10812 </span>            :  * \param chan
<span class="lineNum">   10813 </span>            :  * \param vmu
<span class="lineNum">   10814 </span>            :  * \param vms
<span class="lineNum">   10815 </span>            :  * \param fmtc
<span class="lineNum">   10816 </span>            :  * \param record_gain
<span class="lineNum">   10817 </span>            :  *
<span class="lineNum">   10818 </span>            :  * This is option 4 from the mailbox options menu.
<span class="lineNum">   10819 </span>            :  * This function manages the following promptings:
<span class="lineNum">   10820 </span>            :  * 1: play / record / review the temporary greeting. : invokes play_record_review().
<span class="lineNum">   10821 </span>            :  * 2: remove (delete) the temporary greeting.
<span class="lineNum">   10822 </span>            :  * *: return to the main menu.
<span class="lineNum">   10823 </span>            :  *
<a name="10824"><span class="lineNum">   10824 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   10825 </span>            :  */
<span class="lineNum">   10826 </span><span class="lineCov">          2 : static int vm_tempgreeting(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, char *fmtc, signed char record_gain)</span>
<span class="lineNum">   10827 </span>            : {
<span class="lineNum">   10828 </span><span class="lineCov">          2 :         int cmd = 0;</span>
<span class="lineNum">   10829 </span><span class="lineCov">          2 :         int retries = 0;</span>
<span class="lineNum">   10830 </span><span class="lineCov">          2 :         int duration = 0;</span>
<span class="lineNum">   10831 </span><span class="lineCov">          2 :         char prefile[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">   10832 </span>            :         unsigned char buf[256];
<span class="lineNum">   10833 </span><span class="lineCov">          2 :         int bytes = 0;</span>
<span class="lineNum">   10834 </span>            : 
<span class="lineNum">   10835 </span><span class="lineCov">          2 :         if (ast_adsi_available(chan)) {</span>
<span class="lineNum">   10836 </span><span class="lineNoCov">          0 :                 bytes += adsi_logo(buf + bytes);</span>
<span class="lineNum">   10837 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 3, ADSI_JUST_CENT, 0, &quot;Temp Greeting Menu&quot;, &quot;&quot;);</span>
<span class="lineNum">   10838 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_display(buf + bytes, ADSI_COMM_PAGE, 4, ADSI_JUST_CENT, 0, &quot;Not Done&quot;, &quot;&quot;);</span>
<span class="lineNum">   10839 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<span class="lineNum">   10840 </span><span class="lineNoCov">          0 :                 bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<span class="lineNum">   10841 </span><span class="lineNoCov">          0 :                 ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<span class="lineNum">   10842 </span>            :         }
<span class="lineNum">   10843 </span>            : 
<span class="lineNum">   10844 </span><span class="lineCov">          2 :         ast_test_suite_event_notify(&quot;TEMPGREETING&quot;, &quot;Message: entering temp greeting options&quot;);</span>
<span class="lineNum">   10845 </span><span class="lineCov">          2 :         snprintf(prefile, sizeof(prefile), &quot;%s%s/%s/temp&quot;, VM_SPOOL_DIR, vmu-&gt;context, vms-&gt;username);</span>
<span class="lineNum">   10846 </span><span class="lineCov">          5 :         while ((cmd &gt;= 0) &amp;&amp; (cmd != 't')) {</span>
<span class="lineNum">   10847 </span><span class="lineCov">          3 :                 if (cmd)</span>
<span class="lineNum">   10848 </span><span class="lineCov">          1 :                         retries = 0;</span>
<span class="lineNum">   10849 </span>            :                 RETRIEVE(prefile, -1, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   10850 </span><span class="lineCov">          3 :                 if (ast_fileexists(prefile, NULL, NULL) &lt;= 0) {</span>
<span class="lineNum">   10851 </span><span class="lineCov">          1 :                         cmd = play_record_review(chan, &quot;vm-rec-temp&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10852 </span><span class="lineCov">          1 :                         if (cmd == -1) {</span>
<span class="lineNum">   10853 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   10854 </span>            :                         }
<span class="lineNum">   10855 </span><span class="lineCov">          1 :                         cmd = 't';</span>
<span class="lineNum">   10856 </span>            :                 } else {
<span class="lineNum">   10857 </span><span class="lineCov">          2 :                         switch (cmd) {</span>
<span class="lineNum">   10858 </span><span class="lineNoCov">          0 :                         case '1':</span>
<span class="lineNum">   10859 </span><span class="lineNoCov">          0 :                                 cmd = play_record_review(chan, &quot;vm-rec-temp&quot;, prefile, maxgreet, fmtc, 0, vmu, &amp;duration, NULL, NULL, record_gain, vms, NULL, NULL, 0);</span>
<span class="lineNum">   10860 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   10861 </span><span class="lineCov">          1 :                         case '2':</span>
<span class="lineNum">   10862 </span><span class="lineCov">          1 :                                 DELETE(prefile, -1, prefile, vmu);</span>
<span class="lineNum">   10863 </span><span class="lineCov">          1 :                                 ast_play_and_wait(chan, &quot;vm-tempremoved&quot;);</span>
<span class="lineNum">   10864 </span><span class="lineCov">          1 :                                 cmd = 't';</span>
<span class="lineNum">   10865 </span><span class="lineCov">          1 :                                 break;</span>
<span class="lineNum">   10866 </span><span class="lineNoCov">          0 :                         case '*':</span>
<span class="lineNum">   10867 </span><span class="lineNoCov">          0 :                                 cmd = 't';</span>
<span class="lineNum">   10868 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   10869 </span><span class="lineCov">          1 :                         default:</span>
<span class="lineNum">   10870 </span><span class="lineCov">          1 :                                 cmd = ast_play_and_wait(chan,</span>
<span class="lineNum">   10871 </span><span class="lineCov">          1 :                                         ast_fileexists(prefile, NULL, NULL) &gt; 0 ? /* XXX always true ? */</span>
<span class="lineNum">   10872 </span>            :                                                 &quot;vm-tempgreeting2&quot; : &quot;vm-tempgreeting&quot;);
<span class="lineNum">   10873 </span><span class="lineCov">          1 :                                 if (!cmd) {</span>
<span class="lineNum">   10874 </span><span class="lineNoCov">          0 :                                         cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   10875 </span>            :                                 }
<span class="lineNum">   10876 </span><span class="lineCov">          1 :                                 if (!cmd) {</span>
<span class="lineNum">   10877 </span><span class="lineNoCov">          0 :                                         retries++;</span>
<span class="lineNum">   10878 </span>            :                                 }
<span class="lineNum">   10879 </span><span class="lineCov">          1 :                                 if (retries &gt; 3) {</span>
<span class="lineNum">   10880 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   10881 </span>            :                                 }
<span class="lineNum">   10882 </span><span class="lineCov">          1 :                                 ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   10883 </span>            :                                         isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   10884 </span>            :                         }
<span class="lineNum">   10885 </span>            :                 }
<span class="lineNum">   10886 </span>            :                 DISPOSE(prefile, -1);
<span class="lineNum">   10887 </span>            :         }
<span class="lineNum">   10888 </span><span class="lineCov">          2 :         if (cmd == 't')</span>
<span class="lineNum">   10889 </span><span class="lineCov">          2 :                 cmd = 0;</span>
<span class="lineNum">   10890 </span><span class="lineCov">          2 :         return cmd;</span>
<span class="lineNum">   10891 </span>            : }
<span class="lineNum">   10892 </span>            : 
<span class="lineNum">   10893 </span>            : /*!
<span class="lineNum">   10894 </span>            :  * \brief Greek syntax for 'You have N messages' greeting.
<span class="lineNum">   10895 </span>            :  * \param chan
<span class="lineNum">   10896 </span>            :  * \param vms
<span class="lineNum">   10897 </span>            :  * \param vmu
<span class="lineNum">   10898 </span>            :  *
<a name="10899"><span class="lineNum">   10899 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   10900 </span>            :  */
<span class="lineNum">   10901 </span><span class="lineNoCov">          0 : static int vm_browse_messages_gr(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   10902 </span>            : {
<span class="lineNum">   10903 </span><span class="lineNoCov">          0 :         int cmd = 0;</span>
<span class="lineNum">   10904 </span>            : 
<span class="lineNum">   10905 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10906 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   10907 </span>            :         } else {
<span class="lineNum">   10908 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-youhaveno&quot;);</span>
<span class="lineNum">   10909 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(vms-&gt;vmbox, &quot;vm-INBOX&quot;) ||!strcasecmp(vms-&gt;vmbox, &quot;vm-Old&quot;)){</span>
<span class="lineNum">   10910 </span><span class="lineNoCov">          0 :                         if (!cmd) {</span>
<span class="lineNum">   10911 </span><span class="lineNoCov">          0 :                                 snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%ss&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   10912 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   10913 </span>            :                         }
<span class="lineNum">   10914 </span><span class="lineNoCov">          0 :                         if (!cmd)</span>
<span class="lineNum">   10915 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10916 </span>            :                 } else {
<span class="lineNum">   10917 </span><span class="lineNoCov">          0 :                         if (!cmd)</span>
<span class="lineNum">   10918 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10919 </span><span class="lineNoCov">          0 :                         if (!cmd) {</span>
<span class="lineNum">   10920 </span><span class="lineNoCov">          0 :                                 snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   10921 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   10922 </span>            :                         }
<span class="lineNum">   10923 </span>            :                 }
<span class="lineNum">   10924 </span>            :         }
<span class="lineNum">   10925 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   10926 </span>            : }
<a name="10927"><span class="lineNum">   10927 </span>            : </a>
<span class="lineNum">   10928 </span>            : /* Hebrew Syntax */
<span class="lineNum">   10929 </span><span class="lineNoCov">          0 : static int vm_browse_messages_he(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   10930 </span>            : {
<span class="lineNum">   10931 </span><span class="lineNoCov">          0 :         int cmd = 0;</span>
<span class="lineNum">   10932 </span>            : 
<span class="lineNum">   10933 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10934 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   10935 </span>            :         } else {
<span class="lineNum">   10936 </span><span class="lineNoCov">          0 :                 if (!strcasecmp(vms-&gt;fn, &quot;INBOX&quot;)) {</span>
<span class="lineNum">   10937 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-nonewmessages&quot;);</span>
<span class="lineNum">   10938 </span>            :                 } else {
<span class="lineNum">   10939 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-nomessages&quot;);</span>
<span class="lineNum">   10940 </span>            :                 }
<span class="lineNum">   10941 </span>            :         }
<span class="lineNum">   10942 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   10943 </span>            : }
<span class="lineNum">   10944 </span>            : 
<span class="lineNum">   10945 </span>            : /*!
<span class="lineNum">   10946 </span>            :  * \brief Default English syntax for 'You have N messages' greeting.
<span class="lineNum">   10947 </span>            :  * \param chan
<span class="lineNum">   10948 </span>            :  * \param vms
<span class="lineNum">   10949 </span>            :  * \param vmu
<span class="lineNum">   10950 </span>            :  *
<a name="10951"><span class="lineNum">   10951 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   10952 </span>            :  */
<span class="lineNum">   10953 </span><span class="lineCov">          9 : static int vm_browse_messages_en(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   10954 </span>            : {
<span class="lineNum">   10955 </span><span class="lineCov">          9 :         int cmd = 0;</span>
<span class="lineNum">   10956 </span>            : 
<span class="lineNum">   10957 </span><span class="lineCov">          9 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10958 </span><span class="lineCov">          9 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   10959 </span>            :         } else {
<span class="lineNum">   10960 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-youhave&quot;);</span>
<span class="lineNum">   10961 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   10962 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10963 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   10964 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   10965 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   10966 </span>            :                 }
<span class="lineNum">   10967 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   10968 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   10969 </span>            :         }
<span class="lineNum">   10970 </span><span class="lineCov">          9 :         return cmd;</span>
<span class="lineNum">   10971 </span>            : }
<span class="lineNum">   10972 </span>            : 
<span class="lineNum">   10973 </span>            : /*!
<span class="lineNum">   10974 </span>            :  *\brief Italian syntax for 'You have N messages' greeting.
<span class="lineNum">   10975 </span>            :  * \param chan
<span class="lineNum">   10976 </span>            :  * \param vms
<span class="lineNum">   10977 </span>            :  * \param vmu
<span class="lineNum">   10978 </span>            :  *
<a name="10979"><span class="lineNum">   10979 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   10980 </span>            :  */
<span class="lineNum">   10981 </span><span class="lineNoCov">          0 : static int vm_browse_messages_it(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   10982 </span>            : {
<span class="lineNum">   10983 </span>            :         int cmd;
<span class="lineNum">   10984 </span>            : 
<span class="lineNum">   10985 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   10986 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   10987 </span>            :         } else {
<span class="lineNum">   10988 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   10989 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   10990 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   10991 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   10992 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   10993 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   10994 </span>            :                 }
<span class="lineNum">   10995 </span>            :         }
<span class="lineNum">   10996 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   10997 </span>            : }
<span class="lineNum">   10998 </span>            : 
<span class="lineNum">   10999 </span>            : /*!
<span class="lineNum">   11000 </span>            :  * \brief Japanese syntax for 'You have N messages' greeting.
<span class="lineNum">   11001 </span>            :  * \param chan
<span class="lineNum">   11002 </span>            :  * \param vms
<span class="lineNum">   11003 </span>            :  * \param vmu
<span class="lineNum">   11004 </span>            :  *
<a name="11005"><span class="lineNum">   11005 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11006 </span>            :  */
<span class="lineNum">   11007 </span><span class="lineNoCov">          0 : static int vm_browse_messages_ja(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11008 </span>            : {
<span class="lineNum">   11009 </span><span class="lineNoCov">          0 :         int cmd = 0;</span>
<span class="lineNum">   11010 </span>            : 
<span class="lineNum">   11011 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   11012 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   11013 </span>            :         } else {
<span class="lineNum">   11014 </span><span class="lineNoCov">          0 :                 snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   11015 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   11016 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11017 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   11018 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11019 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;jp-wa&quot;);</span>
<span class="lineNum">   11020 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11021 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;jp-arimasen&quot;);</span>
<span class="lineNum">   11022 </span>            :         }
<span class="lineNum">   11023 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   11024 </span>            : }
<span class="lineNum">   11025 </span>            : 
<span class="lineNum">   11026 </span>            : /*!
<span class="lineNum">   11027 </span>            :  * \brief Spanish syntax for 'You have N messages' greeting.
<span class="lineNum">   11028 </span>            :  * \param chan
<span class="lineNum">   11029 </span>            :  * \param vms
<span class="lineNum">   11030 </span>            :  * \param vmu
<span class="lineNum">   11031 </span>            :  *
<a name="11032"><span class="lineNum">   11032 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11033 </span>            :  */
<span class="lineNum">   11034 </span><span class="lineNoCov">          0 : static int vm_browse_messages_es(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11035 </span>            : {
<span class="lineNum">   11036 </span>            :         int cmd;
<span class="lineNum">   11037 </span>            : 
<span class="lineNum">   11038 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   11039 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   11040 </span>            :         } else {
<span class="lineNum">   11041 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-youhaveno&quot;);</span>
<span class="lineNum">   11042 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11043 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   11044 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   11045 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   11046 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   11047 </span>            :                 }
<span class="lineNum">   11048 </span>            :         }
<span class="lineNum">   11049 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   11050 </span>            : }
<span class="lineNum">   11051 </span>            : 
<span class="lineNum">   11052 </span>            : /*!
<span class="lineNum">   11053 </span>            :  * \brief Portuguese syntax for 'You have N messages' greeting.
<span class="lineNum">   11054 </span>            :  * \param chan
<span class="lineNum">   11055 </span>            :  * \param vms
<span class="lineNum">   11056 </span>            :  * \param vmu
<span class="lineNum">   11057 </span>            :  *
<a name="11058"><span class="lineNum">   11058 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11059 </span>            :  */
<span class="lineNum">   11060 </span><span class="lineNoCov">          0 : static int vm_browse_messages_pt(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11061 </span>            : {
<span class="lineNum">   11062 </span>            :         int cmd;
<span class="lineNum">   11063 </span>            : 
<span class="lineNum">   11064 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   11065 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   11066 </span>            :         } else {
<span class="lineNum">   11067 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   11068 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   11069 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   11070 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   11071 </span>            :                 }
<span class="lineNum">   11072 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11073 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   11074 </span>            :         }
<span class="lineNum">   11075 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   11076 </span>            : }
<span class="lineNum">   11077 </span>            : 
<span class="lineNum">   11078 </span>            : /*!
<span class="lineNum">   11079 </span>            :  * \brief Chinese (Taiwan)syntax for 'You have N messages' greeting.
<span class="lineNum">   11080 </span>            :  * \param chan
<span class="lineNum">   11081 </span>            :  * \param vms
<span class="lineNum">   11082 </span>            :  * \param vmu
<span class="lineNum">   11083 </span>            :  *
<a name="11084"><span class="lineNum">   11084 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11085 </span>            :  */
<span class="lineNum">   11086 </span><span class="lineNoCov">          0 : static int vm_browse_messages_zh(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11087 </span>            : {
<span class="lineNum">   11088 </span>            :         int cmd;
<span class="lineNum">   11089 </span>            : 
<span class="lineNum">   11090 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   11091 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   11092 </span>            :         } else {
<span class="lineNum">   11093 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-you&quot;);</span>
<span class="lineNum">   11094 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11095 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-haveno&quot;);</span>
<span class="lineNum">   11096 </span><span class="lineNoCov">          0 :                 if (!cmd)</span>
<span class="lineNum">   11097 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<span class="lineNum">   11098 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   11099 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   11100 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   11101 </span>            :                 }
<span class="lineNum">   11102 </span>            :         }
<span class="lineNum">   11103 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   11104 </span>            : }
<span class="lineNum">   11105 </span>            : 
<span class="lineNum">   11106 </span>            : /*!
<span class="lineNum">   11107 </span>            :  * \brief Vietnamese syntax for 'You have N messages' greeting.
<span class="lineNum">   11108 </span>            :  * \param chan
<span class="lineNum">   11109 </span>            :  * \param vms
<span class="lineNum">   11110 </span>            :  * \param vmu
<span class="lineNum">   11111 </span>            :  *
<a name="11112"><span class="lineNum">   11112 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11113 </span>            :  */
<span class="lineNum">   11114 </span><span class="lineNoCov">          0 : static int vm_browse_messages_vi(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11115 </span>            : {
<span class="lineNum">   11116 </span><span class="lineNoCov">          0 :         int cmd = 0;</span>
<span class="lineNum">   11117 </span>            : 
<span class="lineNum">   11118 </span><span class="lineNoCov">          0 :         if (vms-&gt;lastmsg &gt; -1) {</span>
<span class="lineNum">   11119 </span><span class="lineNoCov">          0 :                 cmd = play_message(chan, vmu, vms);</span>
<span class="lineNum">   11120 </span>            :         } else {
<span class="lineNum">   11121 </span><span class="lineNoCov">          0 :                 cmd = ast_play_and_wait(chan, &quot;vm-no&quot;);</span>
<span class="lineNum">   11122 </span><span class="lineNoCov">          0 :                 if (!cmd) {</span>
<span class="lineNum">   11123 </span><span class="lineNoCov">          0 :                         snprintf(vms-&gt;fn, sizeof(vms-&gt;fn), &quot;vm-%s&quot;, vms-&gt;curbox);</span>
<span class="lineNum">   11124 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, vms-&gt;fn);</span>
<span class="lineNum">   11125 </span>            :                 }
<span class="lineNum">   11126 </span>            :         }
<span class="lineNum">   11127 </span><span class="lineNoCov">          0 :         return cmd;</span>
<span class="lineNum">   11128 </span>            : }
<span class="lineNum">   11129 </span>            : 
<span class="lineNum">   11130 </span>            : /*!
<span class="lineNum">   11131 </span>            :  * \brief Top level method to invoke the language variant vm_browse_messages_XX function.
<span class="lineNum">   11132 </span>            :  * \param chan The channel for the current user. We read the language property from this.
<span class="lineNum">   11133 </span>            :  * \param vms passed into the language-specific vm_browse_messages function.
<span class="lineNum">   11134 </span>            :  * \param vmu passed into the language-specific vm_browse_messages function.
<span class="lineNum">   11135 </span>            :  *
<span class="lineNum">   11136 </span>            :  * The method to be invoked is determined by the value of language code property in the user's channel.
<span class="lineNum">   11137 </span>            :  * The default (when unable to match) is to use english.
<span class="lineNum">   11138 </span>            :  *
<a name="11139"><span class="lineNum">   11139 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   11140 </span>            :  */
<span class="lineNum">   11141 </span><span class="lineCov">          9 : static int vm_browse_messages(struct ast_channel *chan, struct vm_state *vms, struct ast_vm_user *vmu)</span>
<span class="lineNum">   11142 </span>            : {
<span class="lineNum">   11143 </span><span class="lineCov">          9 :         if (!strncasecmp(ast_channel_language(chan), &quot;es&quot;, 2)) {         /* SPANISH */</span>
<span class="lineNum">   11144 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_es(chan, vms, vmu);</span>
<span class="lineNum">   11145 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;gr&quot;, 2)) {  /* GREEK */</span>
<span class="lineNum">   11146 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_gr(chan, vms, vmu);</span>
<span class="lineNum">   11147 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;he&quot;, 2)) {  /* HEBREW */</span>
<span class="lineNum">   11148 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_he(chan, vms, vmu);</span>
<span class="lineNum">   11149 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;it&quot;, 2)) {  /* ITALIAN */</span>
<span class="lineNum">   11150 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_it(chan, vms, vmu);</span>
<span class="lineNum">   11151 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;ja&quot;, 2)) {  /* JAPANESE */</span>
<span class="lineNum">   11152 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_ja(chan, vms, vmu);</span>
<span class="lineNum">   11153 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;pt&quot;, 2)) {  /* PORTUGUESE */</span>
<span class="lineNum">   11154 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_pt(chan, vms, vmu);</span>
<span class="lineNum">   11155 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;vi&quot;, 2)) {  /* VIETNAMESE */</span>
<span class="lineNum">   11156 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_vi(chan, vms, vmu);</span>
<span class="lineNum">   11157 </span><span class="lineCov">          9 :         } else if (!strncasecmp(ast_channel_language(chan), &quot;zh&quot;, 2)) {  /* CHINESE (Taiwan) */</span>
<span class="lineNum">   11158 </span><span class="lineNoCov">          0 :                 return vm_browse_messages_zh(chan, vms, vmu);</span>
<span class="lineNum">   11159 </span>            :         } else {                                             /* Default to English syntax */
<span class="lineNum">   11160 </span><span class="lineCov">          9 :                 return vm_browse_messages_en(chan, vms, vmu);</span>
<span class="lineNum">   11161 </span>            :         }
<a name="11162"><span class="lineNum">   11162 </span>            : }</a>
<span class="lineNum">   11163 </span>            : 
<span class="lineNum">   11164 </span><span class="lineCov">         28 : static int vm_authenticate(struct ast_channel *chan, char *mailbox, int mailbox_size,</span>
<span class="lineNum">   11165 </span>            :                         struct ast_vm_user *res_vmu, const char *context, const char *prefix,
<span class="lineNum">   11166 </span>            :                         int skipuser, int max_logins, int silent)
<span class="lineNum">   11167 </span>            : {
<span class="lineNum">   11168 </span><span class="lineCov">         28 :         int useadsi = 0, valid = 0, logretries = 0;</span>
<span class="lineNum">   11169 </span>            :         char password[AST_MAX_EXTENSION], *passptr;
<span class="lineNum">   11170 </span><span class="lineCov">         28 :         struct ast_vm_user vmus, *vmu = NULL;</span>
<span class="lineNum">   11171 </span>            : 
<span class="lineNum">   11172 </span>            :         /* If ADSI is supported, setup login screen */
<span class="lineNum">   11173 </span><span class="lineCov">         28 :         adsi_begin(chan, &amp;useadsi);</span>
<span class="lineNum">   11174 </span><span class="lineCov">         28 :         if (!skipuser &amp;&amp; useadsi)</span>
<span class="lineNum">   11175 </span><span class="lineNoCov">          0 :                 adsi_login(chan);</span>
<span class="lineNum">   11176 </span><span class="lineCov">         28 :         if (!silent &amp;&amp; !skipuser &amp;&amp; ast_streamfile(chan, vm_login, ast_channel_language(chan))) {</span>
<span class="lineNum">   11177 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Couldn't stream login file\n&quot;);</span>
<span class="lineNum">   11178 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   11179 </span>            :         }
<span class="lineNum">   11180 </span>            : 
<span class="lineNum">   11181 </span>            :         /* Authenticate them and get their mailbox/password */
<span class="lineNum">   11182 </span>            : 
<span class="lineNum">   11183 </span><span class="lineCov">         60 :         while (!valid &amp;&amp; (logretries &lt; max_logins)) {</span>
<span class="lineNum">   11184 </span>            :                 /* Prompt for, and read in the username */
<span class="lineNum">   11185 </span><span class="lineCov">         34 :                 if (!skipuser &amp;&amp; ast_readstring(chan, mailbox, mailbox_size - 1, 2000, 10000, &quot;#&quot;) &lt; 0) {</span>
<span class="lineNum">   11186 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Couldn't read username\n&quot;);</span>
<span class="lineNum">   11187 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">   11188 </span>            :                 }
<span class="lineNum">   11189 </span><span class="lineCov">         34 :                 if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">   11190 </span><span class="lineNoCov">          0 :                         if (ast_channel_caller(chan)-&gt;id.number.valid &amp;&amp; ast_channel_caller(chan)-&gt;id.number.str) {</span>
<span class="lineNum">   11191 </span><span class="lineNoCov">          0 :                                 ast_copy_string(mailbox, ast_channel_caller(chan)-&gt;id.number.str, mailbox_size);</span>
<span class="lineNum">   11192 </span>            :                         } else {
<span class="lineNum">   11193 </span><span class="lineNoCov">          0 :                                 ast_verb(3, &quot;Username not entered\n&quot;);</span>
<span class="lineNum">   11194 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   11195 </span>            :                         }
<span class="lineNum">   11196 </span><span class="lineCov">         34 :                 } else if (mailbox[0] == '*') {</span>
<span class="lineNum">   11197 </span>            :                         /* user entered '*' */
<span class="lineNum">   11198 </span><span class="lineCov">          1 :                         ast_verb(4, &quot;Mailbox begins with '*', attempting jump to extension 'a'\n&quot;);</span>
<span class="lineNum">   11199 </span><span class="lineCov">          1 :                         if (ast_exists_extension(chan, ast_channel_context(chan), &quot;a&quot;, 1,</span>
<span class="lineNum">   11200 </span><span class="lineCov">          1 :                                 S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">   11201 </span><span class="lineCov">          1 :                                 return -1;</span>
<span class="lineNum">   11202 </span>            :                         }
<span class="lineNum">   11203 </span><span class="lineNoCov">          0 :                         ast_verb(4, &quot;Jump to extension 'a' failed; setting mailbox to NULL\n&quot;);</span>
<span class="lineNum">   11204 </span><span class="lineNoCov">          0 :                         mailbox[0] = '\0';</span>
<span class="lineNum">   11205 </span>            :                 }
<span class="lineNum">   11206 </span>            : 
<span class="lineNum">   11207 </span><span class="lineCov">         33 :                 if (useadsi)</span>
<span class="lineNum">   11208 </span><span class="lineNoCov">          0 :                         adsi_password(chan);</span>
<span class="lineNum">   11209 </span>            : 
<span class="lineNum">   11210 </span><span class="lineCov">         33 :                 if (!ast_strlen_zero(prefix)) {</span>
<span class="lineNum">   11211 </span>            :                         char fullusername[80];
<span class="lineNum">   11212 </span>            : 
<span class="lineNum">   11213 </span><span class="lineNoCov">          0 :                         ast_copy_string(fullusername, prefix, sizeof(fullusername));</span>
<span class="lineNum">   11214 </span><span class="lineNoCov">          0 :                         strncat(fullusername, mailbox, sizeof(fullusername) - 1 - strlen(fullusername));</span>
<span class="lineNum">   11215 </span><span class="lineNoCov">          0 :                         ast_copy_string(mailbox, fullusername, mailbox_size);</span>
<span class="lineNum">   11216 </span>            :                 }
<span class="lineNum">   11217 </span>            : 
<span class="lineNum">   11218 </span><span class="lineCov">         33 :                 ast_debug(1, &quot;Before find user for mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   11219 </span><span class="lineCov">         33 :                 memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   11220 </span><span class="lineCov">         33 :                 vmu = find_user(&amp;vmus, context, mailbox);</span>
<span class="lineNum">   11221 </span><span class="lineCov">         33 :                 if (vmu &amp;&amp; (vmu-&gt;password[0] == '\0' || (vmu-&gt;password[0] == '-' &amp;&amp; vmu-&gt;password[1] == '\0'))) {</span>
<span class="lineNum">   11222 </span>            :                         /* saved password is blank, so don't bother asking */
<span class="lineNum">   11223 </span><span class="lineNoCov">          0 :                         password[0] = '\0';</span>
<span class="lineNum">   11224 </span>            :                 } else {
<span class="lineNum">   11225 </span><span class="lineCov">         33 :                         if (ast_streamfile(chan, vm_password, ast_channel_language(chan))) {</span>
<span class="lineNum">   11226 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Unable to stream password file\n&quot;);</span>
<span class="lineNum">   11227 </span><span class="lineNoCov">          0 :                                 free_user(vmu);</span>
<span class="lineNum">   11228 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   11229 </span>            :                         }
<span class="lineNum">   11230 </span><span class="lineCov">         33 :                         if (ast_readstring(chan, password, sizeof(password) - 1, 2000, 10000, &quot;#&quot;) &lt; 0) {</span>
<span class="lineNum">   11231 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Unable to read password\n&quot;);</span>
<span class="lineNum">   11232 </span><span class="lineNoCov">          0 :                                 free_user(vmu);</span>
<span class="lineNum">   11233 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   11234 </span><span class="lineCov">         33 :                         } else if (password[0] == '*') {</span>
<span class="lineNum">   11235 </span>            :                                 /* user entered '*' */
<span class="lineNum">   11236 </span><span class="lineCov">          1 :                                 ast_verb(4, &quot;Password begins with '*', attempting jump to extension 'a'\n&quot;);</span>
<span class="lineNum">   11237 </span><span class="lineCov">          1 :                                 if (ast_exists_extension(chan, ast_channel_context(chan), &quot;a&quot;, 1,</span>
<span class="lineNum">   11238 </span><span class="lineCov">          1 :                                         S_COR(ast_channel_caller(chan)-&gt;id.number.valid, ast_channel_caller(chan)-&gt;id.number.str, NULL))) {</span>
<span class="lineNum">   11239 </span><span class="lineCov">          1 :                                         mailbox[0] = '*';</span>
<span class="lineNum">   11240 </span><span class="lineCov">          1 :                                         free_user(vmu);</span>
<span class="lineNum">   11241 </span><span class="lineCov">          1 :                                         return -1;</span>
<span class="lineNum">   11242 </span>            :                                 }
<span class="lineNum">   11243 </span><span class="lineNoCov">          0 :                                 ast_verb(4, &quot;Jump to extension 'a' failed; setting mailbox and user to NULL\n&quot;);</span>
<span class="lineNum">   11244 </span><span class="lineNoCov">          0 :                                 mailbox[0] = '\0';</span>
<span class="lineNum">   11245 </span>            :                                 /* if the password entered was '*', do not let a user mailbox be created if the extension 'a' is not defined */
<span class="lineNum">   11246 </span><span class="lineNoCov">          0 :                                 free_user(vmu);</span>
<span class="lineNum">   11247 </span><span class="lineNoCov">          0 :                                 vmu = NULL;</span>
<span class="lineNum">   11248 </span>            :                         }
<span class="lineNum">   11249 </span>            :                 }
<span class="lineNum">   11250 </span>            : 
<span class="lineNum">   11251 </span><span class="lineCov">         32 :                 if (vmu) {</span>
<span class="lineNum">   11252 </span><span class="lineCov">         29 :                         passptr = vmu-&gt;password;</span>
<span class="lineNum">   11253 </span><span class="lineCov">         29 :                         if (passptr[0] == '-') passptr++;</span>
<span class="lineNum">   11254 </span>            :                 }
<span class="lineNum">   11255 </span><span class="lineCov">         32 :                 if (vmu &amp;&amp; !strcmp(passptr, password))</span>
<span class="lineNum">   11256 </span><span class="lineCov">         23 :                         valid++;</span>
<span class="lineNum">   11257 </span>            :                 else {
<span class="lineNum">   11258 </span><span class="lineCov">          9 :                         ast_verb(3, &quot;Incorrect password '%s' for user '%s' (context = %s)\n&quot;, password, mailbox, context ? context : &quot;default&quot;);</span>
<span class="lineNum">   11259 </span><span class="lineCov">          9 :                         if (!ast_strlen_zero(prefix))</span>
<span class="lineNum">   11260 </span><span class="lineNoCov">          0 :                                 mailbox[0] = '\0';</span>
<span class="lineNum">   11261 </span>            :                 }
<span class="lineNum">   11262 </span><span class="lineCov">         32 :                 logretries++;</span>
<span class="lineNum">   11263 </span><span class="lineCov">         32 :                 if (!valid) {</span>
<span class="lineNum">   11264 </span><span class="lineCov">          9 :                         if (skipuser || logretries &gt;= max_logins) {</span>
<span class="lineNum">   11265 </span><span class="lineCov">          5 :                                 if (ast_streamfile(chan, &quot;vm-incorrect&quot;, ast_channel_language(chan))) {</span>
<span class="lineNum">   11266 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;Unable to stream incorrect message\n&quot;);</span>
<span class="lineNum">   11267 </span><span class="lineNoCov">          0 :                                         free_user(vmu);</span>
<span class="lineNum">   11268 </span><span class="lineNoCov">          0 :                                         return -1;</span>
<span class="lineNum">   11269 </span>            :                                 }
<span class="lineNum">   11270 </span><span class="lineCov">          5 :                                 if (ast_waitstream(chan, &quot;&quot;)) {       /* Channel is hung up */</span>
<span class="lineNum">   11271 </span><span class="lineNoCov">          0 :                                         free_user(vmu);</span>
<span class="lineNum">   11272 </span><span class="lineNoCov">          0 :                                         return -1;</span>
<span class="lineNum">   11273 </span>            :                                 }
<span class="lineNum">   11274 </span>            :                         } else {
<span class="lineNum">   11275 </span><span class="lineCov">          4 :                                 if (useadsi)</span>
<span class="lineNum">   11276 </span><span class="lineNoCov">          0 :                                         adsi_login(chan);</span>
<span class="lineNum">   11277 </span><span class="lineCov">          4 :                                 if (ast_streamfile(chan, &quot;vm-incorrect-mailbox&quot;, ast_channel_language(chan))) {</span>
<span class="lineNum">   11278 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;Unable to stream incorrect mailbox message\n&quot;);</span>
<span class="lineNum">   11279 </span><span class="lineNoCov">          0 :                                         free_user(vmu);</span>
<span class="lineNum">   11280 </span><span class="lineNoCov">          0 :                                         return -1;</span>
<span class="lineNum">   11281 </span>            :                                 }
<span class="lineNum">   11282 </span>            :                         }
<span class="lineNum">   11283 </span>            :                 }
<span class="lineNum">   11284 </span>            :         }
<span class="lineNum">   11285 </span><span class="lineCov">         26 :         if (!valid &amp;&amp; (logretries &gt;= max_logins)) {</span>
<span class="lineNum">   11286 </span><span class="lineCov">          3 :                 ast_stopstream(chan);</span>
<span class="lineNum">   11287 </span><span class="lineCov">          3 :                 ast_play_and_wait(chan, &quot;vm-goodbye&quot;);</span>
<span class="lineNum">   11288 </span><span class="lineCov">          3 :                 free_user(vmu);</span>
<span class="lineNum">   11289 </span><span class="lineCov">          3 :                 return -1;</span>
<span class="lineNum">   11290 </span>            :         }
<span class="lineNum">   11291 </span><span class="lineCov">         23 :         if (vmu &amp;&amp; !skipuser) {</span>
<span class="lineNum">   11292 </span><span class="lineCov">         16 :                 *res_vmu = *vmu;</span>
<span class="lineNum">   11293 </span>            :         }
<span class="lineNum">   11294 </span><span class="lineCov">         23 :         return 0;</span>
<a name="11295"><span class="lineNum">   11295 </span>            : }</a>
<span class="lineNum">   11296 </span>            : 
<span class="lineNum">   11297 </span><span class="lineCov">          6 : static int play_message_by_id_helper(struct ast_channel *chan,</span>
<span class="lineNum">   11298 </span>            :         struct ast_vm_user *vmu,
<span class="lineNum">   11299 </span>            :         struct vm_state *vms,
<span class="lineNum">   11300 </span>            :         const char *msg_id)
<span class="lineNum">   11301 </span>            : {
<span class="lineNum">   11302 </span><span class="lineCov">          6 :         if (message_range_and_existence_check(vms, &amp;msg_id, 1, &amp;vms-&gt;curmsg, vmu)) {</span>
<span class="lineNum">   11303 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   11304 </span>            :         }
<span class="lineNum">   11305 </span>            :         /* Found the msg, so play it back */
<span class="lineNum">   11306 </span>            : 
<span class="lineNum">   11307 </span><span class="lineCov">          4 :         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">   11308 </span>            : 
<span class="lineNum">   11309 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11310 </span>            :         /*IMAP storage stores any prepended message from a forward
<span class="lineNum">   11311 </span>            :          * as a separate file from the rest of the message
<span class="lineNum">   11312 </span>            :          */
<span class="lineNum">   11313 </span>            :         if (!ast_strlen_zero(vms-&gt;introfn) &amp;&amp; ast_fileexists(vms-&gt;introfn, NULL, NULL) &gt; 0) {
<span class="lineNum">   11314 </span>            :                 wait_file(chan, vms, vms-&gt;introfn);
<span class="lineNum">   11315 </span>            :         }
<span class="lineNum">   11316 </span>            : #endif
<span class="lineNum">   11317 </span>            :         RETRIEVE(vms-&gt;curdir,vms-&gt;curmsg,vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   11318 </span>            : 
<span class="lineNum">   11319 </span><span class="lineCov">          4 :         if ((wait_file(chan, vms, vms-&gt;fn)) &lt; 0) {</span>
<span class="lineNum">   11320 </span><span class="lineCov">          4 :                 ast_log(AST_LOG_WARNING, &quot;Playback of message %s failed\n&quot;, vms-&gt;fn);</span>
<span class="lineNum">   11321 </span>            :         } else {
<span class="lineNum">   11322 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11323 </span>            :                 ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">   11324 </span>            : #endif
<span class="lineNum">   11325 </span><span class="lineNoCov">          0 :                 vms-&gt;heard[vms-&gt;curmsg] = 1;</span>
<span class="lineNum">   11326 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11327 </span>            :                 ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">   11328 </span>            : #endif
<span class="lineNum">   11329 </span>            :         }
<span class="lineNum">   11330 </span>            :         DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   11331 </span><span class="lineCov">          4 :         return 0;</span>
<span class="lineNum">   11332 </span>            : }
<span class="lineNum">   11333 </span>            : 
<span class="lineNum">   11334 </span>            : /*!
<span class="lineNum">   11335 </span>            :  * \brief Finds a message in a specific mailbox by msg_id and plays it to the channel
<span class="lineNum">   11336 </span>            :  *
<span class="lineNum">   11337 </span>            :  * \retval 0 Success
<a name="11338"><span class="lineNum">   11338 </span>            :  * \retval -1 Failure</a>
<span class="lineNum">   11339 </span>            :  */
<span class="lineNum">   11340 </span><span class="lineCov">          6 : static int play_message_by_id(struct ast_channel *chan, const char *mailbox, const char *context, const char *msg_id)</span>
<span class="lineNum">   11341 </span>            : {
<span class="lineNum">   11342 </span>            :         struct vm_state vms;
<span class="lineNum">   11343 </span><span class="lineCov">          6 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   11344 </span><span class="lineCov">          6 :         int res = 0;</span>
<span class="lineNum">   11345 </span><span class="lineCov">          6 :         int open = 0;</span>
<span class="lineNum">   11346 </span><span class="lineCov">          6 :         int played = 0;</span>
<span class="lineNum">   11347 </span>            :         int i;
<span class="lineNum">   11348 </span>            : 
<span class="lineNum">   11349 </span><span class="lineCov">          6 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   11350 </span><span class="lineCov">          6 :         memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   11351 </span>            : 
<span class="lineNum">   11352 </span><span class="lineCov">          6 :         if (!(vmu = find_user(&amp;vmus, context, mailbox))) {</span>
<span class="lineNum">   11353 </span><span class="lineCov">          1 :                 goto play_msg_cleanup;</span>
<span class="lineNum">   11354 </span>            :         }
<span class="lineNum">   11355 </span>            : 
<span class="lineNum">   11356 </span>            :         /* Iterate through every folder, find the msg, and play it */
<span class="lineNum">   11357 </span><span class="lineCov">         32 :         for (i = 0; i &lt; ARRAY_LEN(mailbox_folders) &amp;&amp; !played; i++) {</span>
<span class="lineNum">   11358 </span><span class="lineCov">         27 :                 ast_copy_string(vms.username, mailbox, sizeof(vms.username));</span>
<span class="lineNum">   11359 </span><span class="lineCov">         27 :                 vms.lastmsg = -1;</span>
<span class="lineNum">   11360 </span>            : 
<span class="lineNum">   11361 </span>            :                 /* open the mailbox state */
<span class="lineNum">   11362 </span><span class="lineCov">         27 :                 if ((res = open_mailbox(&amp;vms, vmu, i)) &lt; 0) {</span>
<span class="lineNum">   11363 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   11364 </span><span class="lineNoCov">          0 :                         res = -1;</span>
<span class="lineNum">   11365 </span><span class="lineNoCov">          0 :                         goto play_msg_cleanup;</span>
<span class="lineNum">   11366 </span>            :                 }
<span class="lineNum">   11367 </span><span class="lineCov">         27 :                 open = 1;</span>
<span class="lineNum">   11368 </span>            : 
<span class="lineNum">   11369 </span>            :                 /* play msg if it exists in this mailbox */
<span class="lineNum">   11370 </span><span class="lineCov">         27 :                 if ((vms.lastmsg != -1) &amp;&amp; !(play_message_by_id_helper(chan, vmu, &amp;vms, msg_id))) {</span>
<span class="lineNum">   11371 </span><span class="lineCov">          4 :                         played = 1;</span>
<span class="lineNum">   11372 </span>            :                 }
<span class="lineNum">   11373 </span>            : 
<span class="lineNum">   11374 </span>            :                 /* close mailbox */
<span class="lineNum">   11375 </span><span class="lineCov">         27 :                 if ((res = close_mailbox(&amp;vms, vmu) == ERROR_LOCK_PATH)) {</span>
<span class="lineNum">   11376 </span><span class="lineNoCov">          0 :                         res = -1;</span>
<span class="lineNum">   11377 </span><span class="lineNoCov">          0 :                         goto play_msg_cleanup;</span>
<span class="lineNum">   11378 </span>            :                 }
<span class="lineNum">   11379 </span><span class="lineCov">         27 :                 open = 0;</span>
<span class="lineNum">   11380 </span>            :         }
<span class="lineNum">   11381 </span>            : 
<span class="lineNum">   11382 </span><span class="lineCov">          5 : play_msg_cleanup:</span>
<span class="lineNum">   11383 </span><span class="lineCov">          6 :         if (!played) {</span>
<span class="lineNum">   11384 </span><span class="lineCov">          2 :                 res = -1;</span>
<span class="lineNum">   11385 </span>            :         }
<span class="lineNum">   11386 </span>            : 
<span class="lineNum">   11387 </span><span class="lineCov">          6 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   11388 </span><span class="lineNoCov">          0 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   11389 </span>            :         }
<span class="lineNum">   11390 </span>            : 
<span class="lineNum">   11391 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11392 </span>            :         if (vmu) {
<span class="lineNum">   11393 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   11394 </span>            :         }
<span class="lineNum">   11395 </span>            : #endif
<span class="lineNum">   11396 </span>            : 
<span class="lineNum">   11397 </span><span class="lineCov">          6 :         free_user(vmu);</span>
<span class="lineNum">   11398 </span>            : 
<span class="lineNum">   11399 </span><span class="lineCov">          6 :         return res;</span>
<a name="11400"><span class="lineNum">   11400 </span>            : }</a>
<span class="lineNum">   11401 </span>            : 
<span class="lineNum">   11402 </span><span class="lineCov">          7 : static int vm_playmsgexec(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   11403 </span>            : {
<span class="lineNum">   11404 </span>            :         char *parse;
<span class="lineNum">   11405 </span><span class="lineCov">          7 :         char *mailbox = NULL;</span>
<span class="lineNum">   11406 </span><span class="lineCov">          7 :         char *context = NULL;</span>
<span class="lineNum">   11407 </span>            :         int res;
<span class="lineNum">   11408 </span>            : 
<span class="lineNum">   11409 </span><span class="lineCov">          7 :         AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">   11410 </span>            :                 AST_APP_ARG(mailbox);
<span class="lineNum">   11411 </span>            :                 AST_APP_ARG(msg_id);
<span class="lineNum">   11412 </span>            :         );
<span class="lineNum">   11413 </span>            : 
<span class="lineNum">   11414 </span><span class="lineCov">          7 :         if (ast_channel_state(chan) != AST_STATE_UP) {</span>
<span class="lineNum">   11415 </span><span class="lineCov">          7 :                 ast_debug(1, &quot;Before ast_answer\n&quot;);</span>
<span class="lineNum">   11416 </span><span class="lineCov">          7 :                 ast_answer(chan);</span>
<span class="lineNum">   11417 </span>            :         }
<span class="lineNum">   11418 </span>            : 
<span class="lineNum">   11419 </span><span class="lineCov">          7 :         if (ast_strlen_zero(data)) {</span>
<span class="lineNum">   11420 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   11421 </span>            :         }
<span class="lineNum">   11422 </span>            : 
<span class="lineNum">   11423 </span><span class="lineCov">          7 :         parse = ast_strdupa(data);</span>
<span class="lineNum">   11424 </span><span class="lineCov">          7 :         AST_STANDARD_APP_ARGS(args, parse);</span>
<span class="lineNum">   11425 </span>            : 
<span class="lineNum">   11426 </span><span class="lineCov">          7 :         if (ast_strlen_zero(args.mailbox) || ast_strlen_zero(args.msg_id)) {</span>
<span class="lineNum">   11427 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   11428 </span>            :         }
<span class="lineNum">   11429 </span>            : 
<span class="lineNum">   11430 </span><span class="lineCov">          6 :         if ((context = strchr(args.mailbox, '@'))) {</span>
<span class="lineNum">   11431 </span><span class="lineCov">          5 :                 *context++ = '\0';</span>
<span class="lineNum">   11432 </span>            :         }
<span class="lineNum">   11433 </span><span class="lineCov">          6 :         mailbox = args.mailbox;</span>
<span class="lineNum">   11434 </span>            : 
<span class="lineNum">   11435 </span><span class="lineCov">          6 :         res = play_message_by_id(chan, mailbox, context, args.msg_id);</span>
<span class="lineNum">   11436 </span><span class="lineCov">          6 :         pbx_builtin_setvar_helper(chan, &quot;VOICEMAIL_PLAYBACKSTATUS&quot;, res ? &quot;FAILED&quot; : &quot;SUCCESS&quot;);</span>
<span class="lineNum">   11437 </span>            : 
<span class="lineNum">   11438 </span><span class="lineCov">          6 :         return 0;</span>
<a name="11439"><span class="lineNum">   11439 </span>            : }</a>
<span class="lineNum">   11440 </span>            : 
<span class="lineNum">   11441 </span><span class="lineCov">         20 : static int vm_execmain(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   11442 </span>            : {
<span class="lineNum">   11443 </span>            :         /* XXX This is, admittedly, some pretty horrendous code.  For some
<span class="lineNum">   11444 </span>            :            reason it just seemed a lot easier to do with GOTO's.  I feel
<span class="lineNum">   11445 </span>            :            like I'm back in my GWBASIC days. XXX */
<span class="lineNum">   11446 </span><span class="lineCov">         20 :         int res = -1;</span>
<span class="lineNum">   11447 </span><span class="lineCov">         20 :         int cmd = 0;</span>
<span class="lineNum">   11448 </span><span class="lineCov">         20 :         int valid = 0;</span>
<span class="lineNum">   11449 </span><span class="lineCov">         20 :         char prefixstr[80] =&quot;&quot;;</span>
<span class="lineNum">   11450 </span><span class="lineCov">         20 :         char ext_context[256]=&quot;&quot;;</span>
<span class="lineNum">   11451 </span>            :         int box;
<span class="lineNum">   11452 </span><span class="lineCov">         20 :         int useadsi = 0;</span>
<span class="lineNum">   11453 </span><span class="lineCov">         20 :         int skipuser = 0;</span>
<span class="lineNum">   11454 </span><span class="lineCov">         20 :         struct vm_state vms = {{0}};</span>
<span class="lineNum">   11455 </span><span class="lineCov">         20 :         struct ast_vm_user *vmu = NULL, vmus = {{0}};</span>
<span class="lineNum">   11456 </span><span class="lineCov">         20 :         char *context = NULL;</span>
<span class="lineNum">   11457 </span><span class="lineCov">         20 :         int silentexit = 0;</span>
<span class="lineNum">   11458 </span><span class="lineCov">         20 :         struct ast_flags flags = { 0 };</span>
<span class="lineNum">   11459 </span><span class="lineCov">         20 :         signed char record_gain = 0;</span>
<span class="lineNum">   11460 </span><span class="lineCov">         20 :         int play_auto = 0;</span>
<span class="lineNum">   11461 </span><span class="lineCov">         20 :         int play_folder = 0;</span>
<span class="lineNum">   11462 </span><span class="lineCov">         20 :         int in_urgent = 0;</span>
<span class="lineNum">   11463 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11464 </span>            :         int deleted = 0;
<span class="lineNum">   11465 </span>            : #endif
<span class="lineNum">   11466 </span>            : 
<span class="lineNum">   11467 </span>            :         /* Add the vm_state to the active list and keep it active */
<span class="lineNum">   11468 </span><span class="lineCov">         20 :         vms.lastmsg = -1;</span>
<span class="lineNum">   11469 </span>            : 
<span class="lineNum">   11470 </span><span class="lineCov">         20 :         ast_test_suite_event_notify(&quot;START&quot;, &quot;Message: vm_execmain started&quot;);</span>
<span class="lineNum">   11471 </span><span class="lineCov">         20 :         if (ast_channel_state(chan) != AST_STATE_UP) {</span>
<span class="lineNum">   11472 </span><span class="lineCov">         20 :                 ast_debug(1, &quot;Before ast_answer\n&quot;);</span>
<span class="lineNum">   11473 </span><span class="lineCov">         20 :                 ast_answer(chan);</span>
<span class="lineNum">   11474 </span>            :         }
<span class="lineNum">   11475 </span>            : 
<span class="lineNum">   11476 </span><span class="lineCov">         20 :         if (!ast_strlen_zero(data)) {</span>
<span class="lineNum">   11477 </span>            :                 char *opts[OPT_ARG_ARRAY_SIZE];
<span class="lineNum">   11478 </span>            :                 char *parse;
<span class="lineNum">   11479 </span><span class="lineCov">          5 :                 AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">   11480 </span>            :                         AST_APP_ARG(argv0);
<span class="lineNum">   11481 </span>            :                         AST_APP_ARG(argv1);
<span class="lineNum">   11482 </span>            :                 );
<span class="lineNum">   11483 </span>            : 
<span class="lineNum">   11484 </span><span class="lineCov">          5 :                 parse = ast_strdupa(data);</span>
<span class="lineNum">   11485 </span>            : 
<span class="lineNum">   11486 </span><span class="lineCov">          5 :                 AST_STANDARD_APP_ARGS(args, parse);</span>
<span class="lineNum">   11487 </span>            : 
<span class="lineNum">   11488 </span><span class="lineCov">          5 :                 if (args.argc == 2) {</span>
<span class="lineNum">   11489 </span><span class="lineNoCov">          0 :                         if (ast_app_parse_options(vm_app_options, &amp;flags, opts, args.argv1))</span>
<span class="lineNum">   11490 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   11491 </span><span class="lineNoCov">          0 :                         if (ast_test_flag(&amp;flags, OPT_RECORDGAIN)) {</span>
<span class="lineNum">   11492 </span>            :                                 int gain;
<span class="lineNum">   11493 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(opts[OPT_ARG_RECORDGAIN])) {</span>
<span class="lineNum">   11494 </span><span class="lineNoCov">          0 :                                         if (sscanf(opts[OPT_ARG_RECORDGAIN], &quot;%30d&quot;, &amp;gain) != 1) {</span>
<span class="lineNum">   11495 </span><span class="lineNoCov">          0 :                                                 ast_log(AST_LOG_WARNING, &quot;Invalid value '%s' provided for record gain option\n&quot;, opts[OPT_ARG_RECORDGAIN]);</span>
<span class="lineNum">   11496 </span><span class="lineNoCov">          0 :                                                 return -1;</span>
<span class="lineNum">   11497 </span>            :                                         } else {
<span class="lineNum">   11498 </span><span class="lineNoCov">          0 :                                                 record_gain = (signed char) gain;</span>
<span class="lineNum">   11499 </span>            :                                         }
<span class="lineNum">   11500 </span>            :                                 } else {
<span class="lineNum">   11501 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;Invalid Gain level set with option g\n&quot;);</span>
<span class="lineNum">   11502 </span>            :                                 }
<span class="lineNum">   11503 </span>            :                         }
<span class="lineNum">   11504 </span><span class="lineNoCov">          0 :                         if (ast_test_flag(&amp;flags, OPT_AUTOPLAY) ) {</span>
<span class="lineNum">   11505 </span><span class="lineNoCov">          0 :                                 play_auto = 1;</span>
<span class="lineNum">   11506 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(opts[OPT_ARG_PLAYFOLDER])) {</span>
<span class="lineNum">   11507 </span>            :                                         /* See if it is a folder name first */
<span class="lineNum">   11508 </span><span class="lineNoCov">          0 :                                         if (isdigit(opts[OPT_ARG_PLAYFOLDER][0])) {</span>
<span class="lineNum">   11509 </span><span class="lineNoCov">          0 :                                                 if (sscanf(opts[OPT_ARG_PLAYFOLDER], &quot;%30d&quot;, &amp;play_folder) != 1) {</span>
<span class="lineNum">   11510 </span><span class="lineNoCov">          0 :                                                         play_folder = -1;</span>
<span class="lineNum">   11511 </span>            :                                                 }
<span class="lineNum">   11512 </span>            :                                         } else {
<span class="lineNum">   11513 </span><span class="lineNoCov">          0 :                                                 play_folder = get_folder_by_name(opts[OPT_ARG_PLAYFOLDER]);</span>
<span class="lineNum">   11514 </span>            :                                         }
<span class="lineNum">   11515 </span>            :                                 } else {
<span class="lineNum">   11516 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;Invalid folder set with option a\n&quot;);</span>
<span class="lineNum">   11517 </span>            :                                 }
<span class="lineNum">   11518 </span><span class="lineNoCov">          0 :                                 if (play_folder &gt; 9 || play_folder &lt; 0) {</span>
<span class="lineNum">   11519 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING,</span>
<span class="lineNum">   11520 </span>            :                                                 &quot;Invalid value '%s' provided for folder autoplay option. Defaulting to 'INBOX'\n&quot;,
<span class="lineNum">   11521 </span>            :                                                 opts[OPT_ARG_PLAYFOLDER]);
<span class="lineNum">   11522 </span><span class="lineNoCov">          0 :                                         play_folder = 0;</span>
<span class="lineNum">   11523 </span>            :                                 }
<span class="lineNum">   11524 </span>            :                         }
<span class="lineNum">   11525 </span>            :                 } else {
<span class="lineNum">   11526 </span>            :                         /* old style options parsing */
<span class="lineNum">   11527 </span><span class="lineCov">          5 :                         while (*(args.argv0)) {</span>
<span class="lineNum">   11528 </span><span class="lineCov">          5 :                                 if (*(args.argv0) == 's')</span>
<span class="lineNum">   11529 </span><span class="lineNoCov">          0 :                                         ast_set_flag(&amp;flags, OPT_SILENT);</span>
<span class="lineNum">   11530 </span><span class="lineCov">          5 :                                 else if (*(args.argv0) == 'p')</span>
<span class="lineNum">   11531 </span><span class="lineNoCov">          0 :                                         ast_set_flag(&amp;flags, OPT_PREPEND_MAILBOX);</span>
<span class="lineNum">   11532 </span>            :                                 else
<span class="lineNum">   11533 </span><span class="lineCov">          5 :                                         break;</span>
<span class="lineNum">   11534 </span><span class="lineNoCov">          0 :                                 (args.argv0)++;</span>
<span class="lineNum">   11535 </span>            :                         }
<span class="lineNum">   11536 </span>            : 
<span class="lineNum">   11537 </span>            :                 }
<span class="lineNum">   11538 </span>            : 
<span class="lineNum">   11539 </span><span class="lineCov">          5 :                 valid = ast_test_flag(&amp;flags, OPT_SILENT);</span>
<span class="lineNum">   11540 </span>            : 
<span class="lineNum">   11541 </span><span class="lineCov">          5 :                 if ((context = strchr(args.argv0, '@')))</span>
<span class="lineNum">   11542 </span><span class="lineCov">          5 :                         *context++ = '\0';</span>
<span class="lineNum">   11543 </span>            : 
<span class="lineNum">   11544 </span><span class="lineCov">          5 :                 if (ast_test_flag(&amp;flags, OPT_PREPEND_MAILBOX))</span>
<span class="lineNum">   11545 </span><span class="lineNoCov">          0 :                         ast_copy_string(prefixstr, args.argv0, sizeof(prefixstr));</span>
<span class="lineNum">   11546 </span>            :                 else
<span class="lineNum">   11547 </span><span class="lineCov">          5 :                         ast_copy_string(vms.username, args.argv0, sizeof(vms.username));</span>
<span class="lineNum">   11548 </span>            : 
<span class="lineNum">   11549 </span><span class="lineCov">          5 :                 if (!ast_strlen_zero(vms.username) &amp;&amp; (vmu = find_user(&amp;vmus, context ,vms.username)))</span>
<span class="lineNum">   11550 </span><span class="lineCov">          5 :                         skipuser++;</span>
<span class="lineNum">   11551 </span>            :                 else
<span class="lineNum">   11552 </span><span class="lineNoCov">          0 :                         valid = 0;</span>
<span class="lineNum">   11553 </span>            :         }
<span class="lineNum">   11554 </span>            : 
<span class="lineNum">   11555 </span><span class="lineCov">         20 :         if (!valid)</span>
<span class="lineNum">   11556 </span><span class="lineCov">         20 :                 res = vm_authenticate(chan, vms.username, sizeof(vms.username), &amp;vmus, context, prefixstr, skipuser, maxlogins, 0);</span>
<span class="lineNum">   11557 </span>            : 
<span class="lineNum">   11558 </span><span class="lineCov">         20 :         ast_debug(1, &quot;After vm_authenticate\n&quot;);</span>
<span class="lineNum">   11559 </span>            : 
<span class="lineNum">   11560 </span><span class="lineCov">         20 :         if (vms.username[0] == '*') {</span>
<span class="lineNum">   11561 </span><span class="lineNoCov">          0 :                 ast_debug(1, &quot;user pressed * in context '%s'\n&quot;, ast_channel_context(chan));</span>
<span class="lineNum">   11562 </span>            : 
<span class="lineNum">   11563 </span>            :                 /* user entered '*' */
<span class="lineNum">   11564 </span><span class="lineNoCov">          0 :                 if (!ast_goto_if_exists(chan, ast_channel_context(chan), &quot;a&quot;, 1)) {</span>
<span class="lineNum">   11565 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;REDIRECT&quot;, &quot;Message: redirecting user to 'a' extension&quot;);</span>
<span class="lineNum">   11566 </span><span class="lineNoCov">          0 :                         res = 0;        /* prevent hangup */</span>
<span class="lineNum">   11567 </span><span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">   11568 </span>            :                 }
<span class="lineNum">   11569 </span>            :         }
<span class="lineNum">   11570 </span>            : 
<span class="lineNum">   11571 </span><span class="lineCov">         20 :         if (!res) {</span>
<span class="lineNum">   11572 </span><span class="lineCov">         20 :                 valid = 1;</span>
<span class="lineNum">   11573 </span><span class="lineCov">         20 :                 if (!skipuser)</span>
<span class="lineNum">   11574 </span><span class="lineCov">         15 :                         vmu = &amp;vmus;</span>
<span class="lineNum">   11575 </span>            :         } else {
<span class="lineNum">   11576 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">   11577 </span>            :         }
<span class="lineNum">   11578 </span>            : 
<span class="lineNum">   11579 </span>            :         /* If ADSI is supported, setup login screen */
<span class="lineNum">   11580 </span><span class="lineCov">         20 :         adsi_begin(chan, &amp;useadsi);</span>
<span class="lineNum">   11581 </span>            : 
<span class="lineNum">   11582 </span><span class="lineCov">         20 :         if (!valid) {</span>
<span class="lineNum">   11583 </span><span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">   11584 </span>            :         }
<span class="lineNum">   11585 </span><span class="lineCov">         20 :         ast_test_suite_event_notify(&quot;AUTHENTICATED&quot;, &quot;Message: vm_user authenticated&quot;);</span>
<span class="lineNum">   11586 </span>            : 
<span class="lineNum">   11587 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11588 </span>            :         pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<span class="lineNum">   11589 </span>            :         pthread_setspecific(ts_vmstate.key, &amp;vms);
<span class="lineNum">   11590 </span>            : 
<span class="lineNum">   11591 </span>            :         vms.interactive = 1;
<span class="lineNum">   11592 </span>            :         vms.updated = 1;
<span class="lineNum">   11593 </span>            :         if (vmu)
<span class="lineNum">   11594 </span>            :                 ast_copy_string(vms.context, vmu-&gt;context, sizeof(vms.context));
<span class="lineNum">   11595 </span>            :         vmstate_insert(&amp;vms);
<span class="lineNum">   11596 </span>            :         init_vm_state(&amp;vms);
<span class="lineNum">   11597 </span>            : #endif
<span class="lineNum">   11598 </span>            : 
<span class="lineNum">   11599 </span>            :         /* Set language from config to override channel language */
<span class="lineNum">   11600 </span><span class="lineCov">         20 :         if (!ast_strlen_zero(vmu-&gt;language)) {</span>
<span class="lineNum">   11601 </span><span class="lineNoCov">          0 :                 ast_channel_lock(chan);</span>
<span class="lineNum">   11602 </span><span class="lineNoCov">          0 :                 ast_channel_language_set(chan, vmu-&gt;language);</span>
<span class="lineNum">   11603 </span><span class="lineNoCov">          0 :                 ast_channel_unlock(chan);</span>
<span class="lineNum">   11604 </span>            :         }
<span class="lineNum">   11605 </span>            : 
<span class="lineNum">   11606 </span>            :         /* Retrieve urgent, old and new message counts */
<span class="lineNum">   11607 </span><span class="lineCov">         20 :         ast_debug(1, &quot;Before open_mailbox\n&quot;);</span>
<span class="lineNum">   11608 </span><span class="lineCov">         20 :         res = open_mailbox(&amp;vms, vmu, OLD_FOLDER); /* Count all messages, even Urgent */</span>
<span class="lineNum">   11609 </span><span class="lineCov">         20 :         if (res &lt; 0)</span>
<span class="lineNum">   11610 </span><span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">   11611 </span><span class="lineCov">         20 :         vms.oldmessages = vms.lastmsg + 1;</span>
<span class="lineNum">   11612 </span><span class="lineCov">         20 :         ast_debug(1, &quot;Number of old messages: %d\n&quot;, vms.oldmessages);</span>
<span class="lineNum">   11613 </span>            :         /* check INBOX */
<span class="lineNum">   11614 </span><span class="lineCov">         20 :         res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   11615 </span><span class="lineCov">         20 :         if (res &lt; 0)</span>
<span class="lineNum">   11616 </span><span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">   11617 </span><span class="lineCov">         20 :         vms.newmessages = vms.lastmsg + 1;</span>
<span class="lineNum">   11618 </span><span class="lineCov">         20 :         ast_debug(1, &quot;Number of new messages: %d\n&quot;, vms.newmessages);</span>
<span class="lineNum">   11619 </span>            :         /* Start in Urgent */
<span class="lineNum">   11620 </span><span class="lineCov">         20 :         in_urgent = 1;</span>
<span class="lineNum">   11621 </span><span class="lineCov">         20 :         res = open_mailbox(&amp;vms, vmu, 11); /*11 is the Urgent folder */</span>
<span class="lineNum">   11622 </span><span class="lineCov">         20 :         if (res &lt; 0)</span>
<span class="lineNum">   11623 </span><span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">   11624 </span><span class="lineCov">         20 :         vms.urgentmessages = vms.lastmsg + 1;</span>
<span class="lineNum">   11625 </span><span class="lineCov">         20 :         ast_debug(1, &quot;Number of urgent messages: %d\n&quot;, vms.urgentmessages);</span>
<span class="lineNum">   11626 </span>            : 
<span class="lineNum">   11627 </span>            :         /* Select proper mailbox FIRST!! */
<span class="lineNum">   11628 </span><span class="lineCov">         20 :         if (play_auto) {</span>
<span class="lineNum">   11629 </span><span class="lineNoCov">          0 :                 ast_test_suite_event_notify(&quot;AUTOPLAY&quot;, &quot;Message: auto-playing messages&quot;);</span>
<span class="lineNum">   11630 </span><span class="lineNoCov">          0 :                 if (vms.urgentmessages) {</span>
<span class="lineNum">   11631 </span><span class="lineNoCov">          0 :                         in_urgent = 1;</span>
<span class="lineNum">   11632 </span><span class="lineNoCov">          0 :                         res = open_mailbox(&amp;vms, vmu, 11);</span>
<span class="lineNum">   11633 </span>            :                 } else {
<span class="lineNum">   11634 </span><span class="lineNoCov">          0 :                         in_urgent = 0;</span>
<span class="lineNum">   11635 </span><span class="lineNoCov">          0 :                         res = open_mailbox(&amp;vms, vmu, play_folder);</span>
<span class="lineNum">   11636 </span>            :                 }
<span class="lineNum">   11637 </span><span class="lineNoCov">          0 :                 if (res &lt; 0)</span>
<span class="lineNum">   11638 </span><span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">   11639 </span>            : 
<span class="lineNum">   11640 </span>            :                 /* If there are no new messages, inform the user and hangup */
<span class="lineNum">   11641 </span><span class="lineNoCov">          0 :                 if (vms.lastmsg == -1) {</span>
<span class="lineNum">   11642 </span><span class="lineNoCov">          0 :                         in_urgent = 0;</span>
<span class="lineNum">   11643 </span><span class="lineNoCov">          0 :                         cmd = vm_browse_messages(chan, &amp;vms, vmu);</span>
<span class="lineNum">   11644 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">   11645 </span><span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">   11646 </span>            :                 }
<span class="lineNum">   11647 </span>            :         } else {
<span class="lineNum">   11648 </span><span class="lineCov">         20 :                 if (!vms.newmessages &amp;&amp; !vms.urgentmessages &amp;&amp; vms.oldmessages) {</span>
<span class="lineNum">   11649 </span>            :                         /* If we only have old messages start here */
<span class="lineNum">   11650 </span><span class="lineNoCov">          0 :                         res = open_mailbox(&amp;vms, vmu, OLD_FOLDER); /* Count all messages, even Urgent */</span>
<span class="lineNum">   11651 </span><span class="lineNoCov">          0 :                         in_urgent = 0;</span>
<span class="lineNum">   11652 </span><span class="lineNoCov">          0 :                         play_folder = 1;</span>
<span class="lineNum">   11653 </span><span class="lineNoCov">          0 :                         if (res &lt; 0)</span>
<span class="lineNum">   11654 </span><span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">   11655 </span><span class="lineCov">         20 :                 } else if (!vms.urgentmessages &amp;&amp; vms.newmessages) {</span>
<span class="lineNum">   11656 </span>            :                         /* If we have new messages but none are urgent */
<span class="lineNum">   11657 </span><span class="lineCov">          8 :                         in_urgent = 0;</span>
<span class="lineNum">   11658 </span><span class="lineCov">          8 :                         res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   11659 </span><span class="lineCov">          8 :                         if (res &lt; 0)</span>
<span class="lineNum">   11660 </span><span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">   11661 </span>            :                 }
<span class="lineNum">   11662 </span>            :         }
<span class="lineNum">   11663 </span>            : 
<span class="lineNum">   11664 </span><span class="lineCov">         20 :         if (useadsi)</span>
<span class="lineNum">   11665 </span><span class="lineNoCov">          0 :                 adsi_status(chan, &amp;vms);</span>
<span class="lineNum">   11666 </span><span class="lineCov">         20 :         res = 0;</span>
<span class="lineNum">   11667 </span>            : 
<span class="lineNum">   11668 </span>            :         /* Check to see if this is a new user */
<span class="lineNum">   11669 </span><span class="lineCov">         20 :         if (!strcasecmp(vmu-&gt;mailbox, vmu-&gt;password) &amp;&amp;</span>
<span class="lineNum">   11670 </span><span class="lineCov">         20 :                 (ast_test_flag(vmu, VM_FORCENAME | VM_FORCEGREET))) {</span>
<span class="lineNum">   11671 </span><span class="lineCov">          2 :                 if (ast_play_and_wait(chan, vm_newuser) == -1)</span>
<span class="lineNum">   11672 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Couldn't stream new user file\n&quot;);</span>
<span class="lineNum">   11673 </span><span class="lineCov">          2 :                 cmd = vm_newuser_setup(chan, vmu, &amp;vms, vmfmts, record_gain);</span>
<span class="lineNum">   11674 </span><span class="lineCov">          2 :                 if ((cmd == 't') || (cmd == '#')) {</span>
<span class="lineNum">   11675 </span>            :                         /* Timeout */
<span class="lineNum">   11676 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;TIMEOUT&quot;, &quot;Message: response from user timed out&quot;);</span>
<span class="lineNum">   11677 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">   11678 </span><span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">   11679 </span><span class="lineCov">          2 :                 } else if (cmd &lt; 0) {</span>
<span class="lineNum">   11680 </span>            :                         /* Hangup */
<span class="lineNum">   11681 </span><span class="lineCov">          1 :                         ast_test_suite_event_notify(&quot;HANGUP&quot;, &quot;Message: hangup detected&quot;);</span>
<span class="lineNum">   11682 </span><span class="lineCov">          1 :                         res = -1;</span>
<span class="lineNum">   11683 </span><span class="lineCov">          1 :                         goto out;</span>
<span class="lineNum">   11684 </span>            :                 }
<span class="lineNum">   11685 </span>            :         }
<span class="lineNum">   11686 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11687 </span>            :                 ast_debug(3, &quot;Checking quotas: comparing %u to %u\n&quot;, vms.quota_usage, vms.quota_limit);
<span class="lineNum">   11688 </span>            :                 if (vms.quota_limit &amp;&amp; vms.quota_usage &gt;= vms.quota_limit) {
<span class="lineNum">   11689 </span>            :                         ast_debug(1, &quot;*** QUOTA EXCEEDED!!\n&quot;);
<span class="lineNum">   11690 </span>            :                         cmd = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);
<span class="lineNum">   11691 </span>            :                 }
<span class="lineNum">   11692 </span>            :                 ast_debug(3, &quot;Checking quotas: User has %d messages and limit is %d.\n&quot;, (vms.newmessages + vms.oldmessages), vmu-&gt;maxmsg);
<span class="lineNum">   11693 </span>            :                 if ((vms.newmessages + vms.oldmessages) &gt;= vmu-&gt;maxmsg) {
<span class="lineNum">   11694 </span>            :                         ast_log(AST_LOG_WARNING, &quot;No more messages possible.  User has %d messages and limit is %d.\n&quot;, (vms.newmessages + vms.oldmessages), vmu-&gt;maxmsg);
<span class="lineNum">   11695 </span>            :                         cmd = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);
<span class="lineNum">   11696 </span>            :                 }
<span class="lineNum">   11697 </span>            : #endif
<span class="lineNum">   11698 </span>            : 
<span class="lineNum">   11699 </span><span class="lineCov">         19 :         ast_test_suite_event_notify(&quot;INTRO&quot;, &quot;Message: playing intro menu&quot;);</span>
<span class="lineNum">   11700 </span><span class="lineCov">         19 :         if (play_auto) {</span>
<span class="lineNum">   11701 </span><span class="lineNoCov">          0 :                 cmd = '1';</span>
<span class="lineNum">   11702 </span>            :         } else {
<span class="lineNum">   11703 </span><span class="lineCov">         19 :                 cmd = vm_intro(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11704 </span>            :         }
<span class="lineNum">   11705 </span><span class="lineCov">         19 :         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   11706 </span>            :                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   11707 </span>            : 
<span class="lineNum">   11708 </span><span class="lineCov">         19 :         vms.repeats = 0;</span>
<span class="lineNum">   11709 </span><span class="lineCov">         19 :         vms.starting = 1;</span>
<span class="lineNum">   11710 </span><span class="lineCov">         93 :         while ((cmd &gt; -1) &amp;&amp; (cmd != 't') &amp;&amp; (cmd != '#')) {</span>
<span class="lineNum">   11711 </span>            :                 /* Run main menu */
<span class="lineNum">   11712 </span><span class="lineCov">         79 :                 switch (cmd) {</span>
<span class="lineNum">   11713 </span><span class="lineCov">          9 :                 case '1': /* First message */</span>
<span class="lineNum">   11714 </span><span class="lineCov">          9 :                         vms.curmsg = 0;</span>
<span class="lineNum">   11715 </span>            :                         /* Fall through */
<span class="lineNum">   11716 </span><span class="lineCov">          9 :                 case '5': /* Play current message */</span>
<span class="lineNum">   11717 </span><span class="lineCov">          9 :                         ast_test_suite_event_notify(&quot;BROWSE&quot;, &quot;Message: browsing message %d\r\nVoicemail: %d&quot;, vms.curmsg, vms.curmsg);</span>
<span class="lineNum">   11718 </span><span class="lineCov">          9 :                         cmd = vm_browse_messages(chan, &amp;vms, vmu);</span>
<span class="lineNum">   11719 </span><span class="lineCov">          9 :                         break;</span>
<span class="lineNum">   11720 </span><span class="lineNoCov">          0 :                 case '2': /* Change folders */</span>
<span class="lineNum">   11721 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;CHANGEFOLDER&quot;, &quot;Message: browsing to a different folder&quot;);</span>
<span class="lineNum">   11722 </span><span class="lineNoCov">          0 :                         if (useadsi)</span>
<span class="lineNum">   11723 </span><span class="lineNoCov">          0 :                                 adsi_folders(chan, 0, &quot;Change to folder...&quot;);</span>
<span class="lineNum">   11724 </span>            : 
<span class="lineNum">   11725 </span><span class="lineNoCov">          0 :                         cmd = get_folder2(chan, &quot;vm-changeto&quot;, 0);</span>
<span class="lineNum">   11726 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   11727 </span>            :                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   11728 </span><span class="lineNoCov">          0 :                         if (cmd == '#') {</span>
<span class="lineNum">   11729 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   11730 </span><span class="lineNoCov">          0 :                         } else if (cmd &gt; 0) {</span>
<span class="lineNum">   11731 </span><span class="lineNoCov">          0 :                                 cmd = cmd - '0';</span>
<span class="lineNum">   11732 </span><span class="lineNoCov">          0 :                                 res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   11733 </span><span class="lineNoCov">          0 :                                 if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   11734 </span><span class="lineNoCov">          0 :                                         goto out;</span>
<span class="lineNum">   11735 </span>            :                                 /* If folder is not urgent, set in_urgent to zero! */
<span class="lineNum">   11736 </span><span class="lineNoCov">          0 :                                 if (cmd != 11) in_urgent = 0;</span>
<span class="lineNum">   11737 </span><span class="lineNoCov">          0 :                                 res = open_mailbox(&amp;vms, vmu, cmd);</span>
<span class="lineNum">   11738 </span><span class="lineNoCov">          0 :                                 if (res &lt; 0)</span>
<span class="lineNum">   11739 </span><span class="lineNoCov">          0 :                                         goto out;</span>
<span class="lineNum">   11740 </span><span class="lineNoCov">          0 :                                 play_folder = cmd;</span>
<span class="lineNum">   11741 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   11742 </span>            :                         }
<span class="lineNum">   11743 </span><span class="lineNoCov">          0 :                         if (useadsi)</span>
<span class="lineNum">   11744 </span><span class="lineNoCov">          0 :                                 adsi_status2(chan, &amp;vms);</span>
<span class="lineNum">   11745 </span>            : 
<span class="lineNum">   11746 </span><span class="lineNoCov">          0 :                         if (!cmd) {</span>
<span class="lineNum">   11747 </span><span class="lineNoCov">          0 :                                 cmd = vm_play_folder_name(chan, vms.vmbox);</span>
<span class="lineNum">   11748 </span>            :                         }
<span class="lineNum">   11749 </span>            : 
<span class="lineNum">   11750 </span><span class="lineNoCov">          0 :                         vms.starting = 1;</span>
<span class="lineNum">   11751 </span><span class="lineNoCov">          0 :                         vms.curmsg = 0;</span>
<span class="lineNum">   11752 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   11753 </span><span class="lineCov">          3 :                 case '3': /* Advanced options */</span>
<span class="lineNum">   11754 </span><span class="lineCov">          3 :                         ast_test_suite_event_notify(&quot;ADVOPTIONS&quot;, &quot;Message: entering advanced options menu&quot;);</span>
<span class="lineNum">   11755 </span><span class="lineCov">          3 :                         cmd = 0;</span>
<span class="lineNum">   11756 </span><span class="lineCov">          3 :                         vms.repeats = 0;</span>
<span class="lineNum">   11757 </span><span class="lineCov">          7 :                         while ((cmd &gt; -1) &amp;&amp; (cmd != 't') &amp;&amp; (cmd != '#')) {</span>
<span class="lineNum">   11758 </span>            :                                 switch (cmd) {
<span class="lineNum">   11759 </span><span class="lineCov">          1 :                                 case '1': /* Reply */</span>
<span class="lineNum">   11760 </span><span class="lineCov">          1 :                                         if (vms.lastmsg &gt; -1 &amp;&amp; !vms.starting) {</span>
<span class="lineNum">   11761 </span><span class="lineCov">          1 :                                                 cmd = advanced_options(chan, vmu, &amp;vms, vms.curmsg, 1, record_gain);</span>
<span class="lineNum">   11762 </span><span class="lineCov">          1 :                                                 if (cmd == ERROR_LOCK_PATH || cmd == OPERATOR_EXIT) {</span>
<span class="lineNum">   11763 </span><span class="lineNoCov">          0 :                                                         res = cmd;</span>
<span class="lineNum">   11764 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   11765 </span>            :                                                 }
<span class="lineNum">   11766 </span>            :                                         } else {
<span class="lineNum">   11767 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   11768 </span>            :                                         }
<span class="lineNum">   11769 </span><span class="lineCov">          1 :                                         cmd = 't';</span>
<span class="lineNum">   11770 </span><span class="lineCov">          1 :                                         break;</span>
<span class="lineNum">   11771 </span><span class="lineCov">          1 :                                 case '2': /* Callback */</span>
<span class="lineNum">   11772 </span><span class="lineCov">          1 :                                         if (!vms.starting)</span>
<span class="lineNum">   11773 </span><span class="lineCov">          1 :                                                 ast_verb(3, &quot;Callback Requested\n&quot;);</span>
<span class="lineNum">   11774 </span><span class="lineCov">          1 :                                         if (!ast_strlen_zero(vmu-&gt;callback) &amp;&amp; vms.lastmsg &gt; -1 &amp;&amp; !vms.starting) {</span>
<span class="lineNum">   11775 </span><span class="lineCov">          1 :                                                 cmd = advanced_options(chan, vmu, &amp;vms, vms.curmsg, 2, record_gain);</span>
<span class="lineNum">   11776 </span><span class="lineCov">          1 :                                                 if (cmd == 9) {</span>
<span class="lineNum">   11777 </span><span class="lineCov">          1 :                                                         silentexit = 1;</span>
<span class="lineNum">   11778 </span><span class="lineCov">          1 :                                                         goto out;</span>
<span class="lineNum">   11779 </span><span class="lineNoCov">          0 :                                                 } else if (cmd == ERROR_LOCK_PATH) {</span>
<span class="lineNum">   11780 </span><span class="lineNoCov">          0 :                                                         res = cmd;</span>
<span class="lineNum">   11781 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   11782 </span>            :                                                 }
<span class="lineNum">   11783 </span>            :                                         } else {
<span class="lineNum">   11784 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   11785 </span>            :                                         }
<span class="lineNum">   11786 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   11787 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   11788 </span><span class="lineNoCov">          0 :                                 case '3': /* Envelope */</span>
<span class="lineNum">   11789 </span><span class="lineNoCov">          0 :                                         if (vms.lastmsg &gt; -1 &amp;&amp; !vms.starting) {</span>
<span class="lineNum">   11790 </span><span class="lineNoCov">          0 :                                                 cmd = advanced_options(chan, vmu, &amp;vms, vms.curmsg, 3, record_gain);</span>
<span class="lineNum">   11791 </span><span class="lineNoCov">          0 :                                                 if (cmd == ERROR_LOCK_PATH) {</span>
<span class="lineNum">   11792 </span><span class="lineNoCov">          0 :                                                         res = cmd;</span>
<span class="lineNum">   11793 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   11794 </span>            :                                                 }
<span class="lineNum">   11795 </span>            :                                         } else {
<span class="lineNum">   11796 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   11797 </span>            :                                         }
<span class="lineNum">   11798 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   11799 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   11800 </span><span class="lineCov">          1 :                                 case '4': /* Dialout */</span>
<span class="lineNum">   11801 </span><span class="lineCov">          1 :                                         if (!ast_strlen_zero(vmu-&gt;dialout)) {</span>
<span class="lineNum">   11802 </span><span class="lineCov">          1 :                                                 cmd = dialout(chan, vmu, NULL, vmu-&gt;dialout);</span>
<span class="lineNum">   11803 </span><span class="lineCov">          1 :                                                 if (cmd == 9) {</span>
<span class="lineNum">   11804 </span><span class="lineCov">          1 :                                                         silentexit = 1;</span>
<span class="lineNum">   11805 </span><span class="lineCov">          1 :                                                         goto out;</span>
<span class="lineNum">   11806 </span>            :                                                 }
<span class="lineNum">   11807 </span>            :                                         } else {
<span class="lineNum">   11808 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   11809 </span>            :                                         }
<span class="lineNum">   11810 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   11811 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   11812 </span>            : 
<span class="lineNum">   11813 </span><span class="lineNoCov">          0 :                                 case '5': /* Leave VoiceMail */</span>
<span class="lineNum">   11814 </span><span class="lineNoCov">          0 :                                         if (ast_test_flag(vmu, VM_SVMAIL)) {</span>
<span class="lineNum">   11815 </span><span class="lineNoCov">          0 :                                                 cmd = forward_message(chan, context, &amp;vms, vmu, vmfmts, 1, record_gain, 0);</span>
<span class="lineNum">   11816 </span><span class="lineNoCov">          0 :                                                 if (cmd == ERROR_LOCK_PATH || cmd == OPERATOR_EXIT) {</span>
<span class="lineNum">   11817 </span><span class="lineNoCov">          0 :                                                         res = cmd;</span>
<span class="lineNum">   11818 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   11819 </span>            :                                                 }
<span class="lineNum">   11820 </span>            :                                         } else {
<span class="lineNum">   11821 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   11822 </span>            :                                         }
<span class="lineNum">   11823 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   11824 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   11825 </span>            : 
<span class="lineNum">   11826 </span><span class="lineNoCov">          0 :                                 case '*': /* Return to main menu */</span>
<span class="lineNum">   11827 </span><span class="lineNoCov">          0 :                                         cmd = 't';</span>
<span class="lineNum">   11828 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   11829 </span>            : 
<span class="lineNum">   11830 </span><span class="lineCov">          3 :                                 default:</span>
<span class="lineNum">   11831 </span><span class="lineCov">          3 :                                         cmd = 0;</span>
<span class="lineNum">   11832 </span><span class="lineCov">          3 :                                         if (!vms.starting) {</span>
<span class="lineNum">   11833 </span><span class="lineCov">          3 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-toreply&quot;);</span>
<span class="lineNum">   11834 </span>            :                                         }
<span class="lineNum">   11835 </span><span class="lineCov">          3 :                                         if (!ast_strlen_zero(vmu-&gt;callback) &amp;&amp; !vms.starting &amp;&amp; !cmd) {</span>
<span class="lineNum">   11836 </span><span class="lineCov">          1 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-tocallback&quot;);</span>
<span class="lineNum">   11837 </span>            :                                         }
<span class="lineNum">   11838 </span><span class="lineCov">          3 :                                         if (!cmd &amp;&amp; !vms.starting) {</span>
<span class="lineNum">   11839 </span><span class="lineCov">          1 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-tohearenv&quot;);</span>
<span class="lineNum">   11840 </span>            :                                         }
<span class="lineNum">   11841 </span><span class="lineCov">          3 :                                         if (!ast_strlen_zero(vmu-&gt;dialout) &amp;&amp; !cmd) {</span>
<span class="lineNum">   11842 </span><span class="lineCov">          1 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-tomakecall&quot;);</span>
<span class="lineNum">   11843 </span>            :                                         }
<span class="lineNum">   11844 </span><span class="lineCov">          3 :                                         if (ast_test_flag(vmu, VM_SVMAIL) &amp;&amp; !cmd) {</span>
<span class="lineNum">   11845 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-leavemsg&quot;);</span>
<span class="lineNum">   11846 </span>            :                                         }
<span class="lineNum">   11847 </span><span class="lineCov">          3 :                                         if (!cmd) {</span>
<span class="lineNum">   11848 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-starmain&quot;);</span>
<span class="lineNum">   11849 </span>            :                                         }
<span class="lineNum">   11850 </span><span class="lineCov">          3 :                                         if (!cmd) {</span>
<span class="lineNum">   11851 </span><span class="lineNoCov">          0 :                                                 cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   11852 </span>            :                                         }
<span class="lineNum">   11853 </span><span class="lineCov">          3 :                                         if (!cmd) {</span>
<span class="lineNum">   11854 </span><span class="lineNoCov">          0 :                                                 vms.repeats++;</span>
<span class="lineNum">   11855 </span>            :                                         }
<span class="lineNum">   11856 </span><span class="lineCov">          3 :                                         if (vms.repeats &gt; 3) {</span>
<span class="lineNum">   11857 </span><span class="lineNoCov">          0 :                                                 cmd = 't';</span>
<span class="lineNum">   11858 </span>            :                                         }
<span class="lineNum">   11859 </span><span class="lineCov">          3 :                                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   11860 </span>            :                                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   11861 </span>            :                                 }
<span class="lineNum">   11862 </span>            :                         }
<span class="lineNum">   11863 </span><span class="lineCov">          1 :                         if (cmd == 't') {</span>
<span class="lineNum">   11864 </span><span class="lineCov">          1 :                                 cmd = 0;</span>
<span class="lineNum">   11865 </span><span class="lineCov">          1 :                                 vms.repeats = 0;</span>
<span class="lineNum">   11866 </span>            :                         }
<span class="lineNum">   11867 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">   11868 </span><span class="lineNoCov">          0 :                 case '4': /* Go to the previous message */</span>
<span class="lineNum">   11869 </span><span class="lineNoCov">          0 :                         ast_test_suite_event_notify(&quot;PREVMSG&quot;, &quot;Message: browsing message %d\r\nVoicemail: %d&quot;, vms.curmsg - 1, vms.curmsg - 1);</span>
<span class="lineNum">   11870 </span><span class="lineNoCov">          0 :                         if (vms.curmsg &gt; 0) {</span>
<span class="lineNum">   11871 </span><span class="lineNoCov">          0 :                                 vms.curmsg--;</span>
<span class="lineNum">   11872 </span><span class="lineNoCov">          0 :                                 cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11873 </span>            :                         } else {
<span class="lineNum">   11874 </span>            :                                 /* Check if we were listening to new
<span class="lineNum">   11875 </span>            :                                    messages.  If so, go to Urgent messages
<span class="lineNum">   11876 </span>            :                                    instead of saying &quot;no more messages&quot;
<span class="lineNum">   11877 </span>            :                                 */
<span class="lineNum">   11878 </span><span class="lineNoCov">          0 :                                 if (in_urgent == 0 &amp;&amp; vms.urgentmessages &gt; 0) {</span>
<span class="lineNum">   11879 </span>            :                                         /* Check for Urgent messages */
<span class="lineNum">   11880 </span><span class="lineNoCov">          0 :                                         in_urgent = 1;</span>
<span class="lineNum">   11881 </span><span class="lineNoCov">          0 :                                         res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   11882 </span><span class="lineNoCov">          0 :                                         if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   11883 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   11884 </span><span class="lineNoCov">          0 :                                         res = open_mailbox(&amp;vms, vmu, 11);  /* Open Urgent folder */</span>
<span class="lineNum">   11885 </span><span class="lineNoCov">          0 :                                         if (res &lt; 0)</span>
<span class="lineNum">   11886 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   11887 </span><span class="lineNoCov">          0 :                                         ast_debug(1, &quot;No more new messages, opened INBOX and got %d Urgent messages\n&quot;, vms.lastmsg + 1);</span>
<span class="lineNum">   11888 </span><span class="lineNoCov">          0 :                                         vms.curmsg = vms.lastmsg;</span>
<span class="lineNum">   11889 </span><span class="lineNoCov">          0 :                                         if (vms.lastmsg &lt; 0) {</span>
<span class="lineNum">   11890 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11891 </span>            :                                         }
<span class="lineNum">   11892 </span><span class="lineNoCov">          0 :                                 } else if (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms.lastmsg &gt; 0) {</span>
<span class="lineNum">   11893 </span><span class="lineNoCov">          0 :                                         vms.curmsg = vms.lastmsg;</span>
<span class="lineNum">   11894 </span><span class="lineNoCov">          0 :                                         cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11895 </span>            :                                 } else {
<span class="lineNum">   11896 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11897 </span>            :                                 }
<span class="lineNum">   11898 </span>            :                         }
<span class="lineNum">   11899 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   11900 </span><span class="lineCov">          5 :                 case '6': /* Go to the next message */</span>
<span class="lineNum">   11901 </span><span class="lineCov">          5 :                         ast_test_suite_event_notify(&quot;PREVMSG&quot;, &quot;Message: browsing message %d\r\nVoicemail: %d&quot;, vms.curmsg + 1, vms.curmsg + 1);</span>
<span class="lineNum">   11902 </span><span class="lineCov">          5 :                         if (vms.curmsg &lt; vms.lastmsg) {</span>
<span class="lineNum">   11903 </span><span class="lineCov">          2 :                                 vms.curmsg++;</span>
<span class="lineNum">   11904 </span><span class="lineCov">          2 :                                 cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11905 </span>            :                         } else {
<span class="lineNum">   11906 </span><span class="lineCov">          3 :                                 if (in_urgent &amp;&amp; vms.newmessages &gt; 0) {</span>
<span class="lineNum">   11907 </span>            :                                         /* Check if we were listening to urgent
<span class="lineNum">   11908 </span>            :                                          * messages.  If so, go to regular new messages
<span class="lineNum">   11909 </span>            :                                          * instead of saying &quot;no more messages&quot;
<span class="lineNum">   11910 </span>            :                                          */
<span class="lineNum">   11911 </span><span class="lineCov">          1 :                                         in_urgent = 0;</span>
<span class="lineNum">   11912 </span><span class="lineCov">          1 :                                         res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   11913 </span><span class="lineCov">          1 :                                         if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   11914 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   11915 </span><span class="lineCov">          1 :                                         res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   11916 </span><span class="lineCov">          1 :                                         if (res &lt; 0)</span>
<span class="lineNum">   11917 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   11918 </span><span class="lineCov">          1 :                                         ast_debug(1, &quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;, vms.lastmsg + 1);</span>
<span class="lineNum">   11919 </span><span class="lineCov">          1 :                                         vms.curmsg = -1;</span>
<span class="lineNum">   11920 </span><span class="lineCov">          1 :                                         if (vms.lastmsg &lt; 0) {</span>
<span class="lineNum">   11921 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11922 </span>            :                                         }
<span class="lineNum">   11923 </span><span class="lineCov">          2 :                                 } else if (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms.lastmsg &gt; 0) {</span>
<span class="lineNum">   11924 </span><span class="lineNoCov">          0 :                                         vms.curmsg = 0;</span>
<span class="lineNum">   11925 </span><span class="lineNoCov">          0 :                                         cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11926 </span>            :                                 } else {
<span class="lineNum">   11927 </span><span class="lineCov">          2 :                                         cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11928 </span>            :                                 }
<span class="lineNum">   11929 </span>            :                         }
<span class="lineNum">   11930 </span><span class="lineCov">          5 :                         break;</span>
<span class="lineNum">   11931 </span><span class="lineCov">          2 :                 case '7': /* Delete the current message */</span>
<span class="lineNum">   11932 </span><span class="lineCov">          2 :                         if (vms.curmsg &gt;= 0 &amp;&amp; vms.curmsg &lt;= vms.lastmsg) {</span>
<span class="lineNum">   11933 </span><span class="lineCov">          2 :                                 vms.deleted[vms.curmsg] = !vms.deleted[vms.curmsg];</span>
<span class="lineNum">   11934 </span><span class="lineCov">          2 :                                 if (useadsi)</span>
<span class="lineNum">   11935 </span><span class="lineNoCov">          0 :                                         adsi_delete(chan, &amp;vms);</span>
<span class="lineNum">   11936 </span><span class="lineCov">          2 :                                 if (vms.deleted[vms.curmsg]) {</span>
<span class="lineNum">   11937 </span><span class="lineCov">          2 :                                         if (play_folder == 0) {</span>
<span class="lineNum">   11938 </span><span class="lineCov">          2 :                                                 if (in_urgent) {</span>
<span class="lineNum">   11939 </span><span class="lineNoCov">          0 :                                                         vms.urgentmessages--;</span>
<span class="lineNum">   11940 </span>            :                                                 } else {
<span class="lineNum">   11941 </span><span class="lineCov">          2 :                                                         vms.newmessages--;</span>
<span class="lineNum">   11942 </span>            :                                                 }
<span class="lineNum">   11943 </span>            :                                         }
<span class="lineNum">   11944 </span><span class="lineNoCov">          0 :                                         else if (play_folder == 1)</span>
<span class="lineNum">   11945 </span><span class="lineNoCov">          0 :                                                 vms.oldmessages--;</span>
<span class="lineNum">   11946 </span><span class="lineCov">          2 :                                         cmd = ast_play_and_wait(chan, &quot;vm-deleted&quot;);</span>
<span class="lineNum">   11947 </span>            :                                 } else {
<span class="lineNum">   11948 </span><span class="lineNoCov">          0 :                                         if (play_folder == 0) {</span>
<span class="lineNum">   11949 </span><span class="lineNoCov">          0 :                                                 if (in_urgent) {</span>
<span class="lineNum">   11950 </span><span class="lineNoCov">          0 :                                                         vms.urgentmessages++;</span>
<span class="lineNum">   11951 </span>            :                                                 } else {
<span class="lineNum">   11952 </span><span class="lineNoCov">          0 :                                                         vms.newmessages++;</span>
<span class="lineNum">   11953 </span>            :                                                 }
<span class="lineNum">   11954 </span>            :                                         }
<span class="lineNum">   11955 </span><span class="lineNoCov">          0 :                                         else if (play_folder == 1)</span>
<span class="lineNum">   11956 </span><span class="lineNoCov">          0 :                                                 vms.oldmessages++;</span>
<span class="lineNum">   11957 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-undeleted&quot;);</span>
<span class="lineNum">   11958 </span>            :                                 }
<span class="lineNum">   11959 </span><span class="lineCov">          4 :                                 if (ast_test_flag(vmu, VM_SKIPAFTERCMD)) {</span>
<span class="lineNum">   11960 </span><span class="lineCov">          2 :                                         if (vms.curmsg &lt; vms.lastmsg) {</span>
<span class="lineNum">   11961 </span><span class="lineCov">          1 :                                                 vms.curmsg++;</span>
<span class="lineNum">   11962 </span><span class="lineCov">          1 :                                                 cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11963 </span><span class="lineCov">          1 :                                         } else if (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms.lastmsg &gt; 0) {</span>
<span class="lineNum">   11964 </span><span class="lineNoCov">          0 :                                                 vms.curmsg = 0;</span>
<span class="lineNum">   11965 </span><span class="lineNoCov">          0 :                                                 cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   11966 </span>            :                                         } else {
<span class="lineNum">   11967 </span>            :                                                 /* Check if we were listening to urgent
<span class="lineNum">   11968 </span>            :                                                    messages.  If so, go to regular new messages
<span class="lineNum">   11969 </span>            :                                                    instead of saying &quot;no more messages&quot;
<span class="lineNum">   11970 </span>            :                                                 */
<span class="lineNum">   11971 </span><span class="lineCov">          1 :                                                 if (in_urgent == 1) {</span>
<span class="lineNum">   11972 </span>            :                                                         /* Check for new messages */
<span class="lineNum">   11973 </span><span class="lineNoCov">          0 :                                                         in_urgent = 0;</span>
<span class="lineNum">   11974 </span><span class="lineNoCov">          0 :                                                         res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   11975 </span><span class="lineNoCov">          0 :                                                         if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   11976 </span><span class="lineNoCov">          0 :                                                                 goto out;</span>
<span class="lineNum">   11977 </span><span class="lineNoCov">          0 :                                                         res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   11978 </span><span class="lineNoCov">          0 :                                                         if (res &lt; 0)</span>
<span class="lineNum">   11979 </span><span class="lineNoCov">          0 :                                                                 goto out;</span>
<span class="lineNum">   11980 </span><span class="lineNoCov">          0 :                                                         ast_debug(1, &quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;, vms.lastmsg + 1);</span>
<span class="lineNum">   11981 </span><span class="lineNoCov">          0 :                                                         vms.curmsg = -1;</span>
<span class="lineNum">   11982 </span><span class="lineNoCov">          0 :                                                         if (vms.lastmsg &lt; 0) {</span>
<span class="lineNum">   11983 </span><span class="lineNoCov">          0 :                                                                 cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11984 </span>            :                                                         }
<span class="lineNum">   11985 </span>            :                                                 } else {
<span class="lineNum">   11986 </span><span class="lineCov">          1 :                                                         cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   11987 </span>            :                                                 }
<span class="lineNum">   11988 </span>            :                                         }
<span class="lineNum">   11989 </span>            :                                 }
<span class="lineNum">   11990 </span>            :                         } else /* Delete not valid if we haven't selected a message */
<span class="lineNum">   11991 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   11992 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   11993 </span>            :                         deleted = 1;
<span class="lineNum">   11994 </span>            : #endif
<span class="lineNum">   11995 </span><span class="lineCov">          2 :                         break;</span>
<span class="lineNum">   11996 </span>            : 
<span class="lineNum">   11997 </span><span class="lineCov">          3 :                 case '8': /* Forward the current message */</span>
<span class="lineNum">   11998 </span><span class="lineCov">          3 :                         if (vms.lastmsg &gt; -1) {</span>
<span class="lineNum">   11999 </span><span class="lineCov">          3 :                                 cmd = forward_message(chan, context, &amp;vms, vmu, vmfmts, 0, record_gain, in_urgent);</span>
<span class="lineNum">   12000 </span><span class="lineCov">          3 :                                 if (cmd == ERROR_LOCK_PATH) {</span>
<span class="lineNum">   12001 </span><span class="lineNoCov">          0 :                                         res = cmd;</span>
<span class="lineNum">   12002 </span><span class="lineNoCov">          0 :                                         goto out;</span>
<span class="lineNum">   12003 </span>            :                                 }
<span class="lineNum">   12004 </span>            :                         } else {
<span class="lineNum">   12005 </span>            :                                 /* Check if we were listening to urgent
<span class="lineNum">   12006 </span>            :                                    messages.  If so, go to regular new messages
<span class="lineNum">   12007 </span>            :                                    instead of saying &quot;no more messages&quot;
<span class="lineNum">   12008 </span>            :                                 */
<span class="lineNum">   12009 </span><span class="lineNoCov">          0 :                                 if (in_urgent == 1 &amp;&amp; vms.newmessages &gt; 0) {</span>
<span class="lineNum">   12010 </span>            :                                         /* Check for new messages */
<span class="lineNum">   12011 </span><span class="lineNoCov">          0 :                                         in_urgent = 0;</span>
<span class="lineNum">   12012 </span><span class="lineNoCov">          0 :                                         res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   12013 </span><span class="lineNoCov">          0 :                                         if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   12014 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   12015 </span><span class="lineNoCov">          0 :                                         res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   12016 </span><span class="lineNoCov">          0 :                                         if (res &lt; 0)</span>
<span class="lineNum">   12017 </span><span class="lineNoCov">          0 :                                                 goto out;</span>
<span class="lineNum">   12018 </span><span class="lineNoCov">          0 :                                         ast_debug(1, &quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;, vms.lastmsg + 1);</span>
<span class="lineNum">   12019 </span><span class="lineNoCov">          0 :                                         vms.curmsg = -1;</span>
<span class="lineNum">   12020 </span><span class="lineNoCov">          0 :                                         if (vms.lastmsg &lt; 0) {</span>
<span class="lineNum">   12021 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   12022 </span>            :                                         }
<span class="lineNum">   12023 </span>            :                                 } else {
<span class="lineNum">   12024 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   12025 </span>            :                                 }
<span class="lineNum">   12026 </span>            :                         }
<span class="lineNum">   12027 </span><span class="lineCov">          3 :                         break;</span>
<span class="lineNum">   12028 </span><span class="lineCov">          4 :                 case '9': /* Save message to folder */</span>
<span class="lineNum">   12029 </span><span class="lineCov">          4 :                         ast_test_suite_event_notify(&quot;SAVEMSG&quot;, &quot;Message: saving message %d\r\nVoicemail: %d&quot;, vms.curmsg, vms.curmsg);</span>
<span class="lineNum">   12030 </span><span class="lineCov">          4 :                         if (vms.curmsg &lt; 0 || vms.curmsg &gt; vms.lastmsg) {</span>
<span class="lineNum">   12031 </span>            :                                 /* No message selected */
<span class="lineNum">   12032 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   12033 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   12034 </span>            :                         }
<span class="lineNum">   12035 </span><span class="lineCov">          4 :                         if (useadsi)</span>
<span class="lineNum">   12036 </span><span class="lineNoCov">          0 :                                 adsi_folders(chan, 1, &quot;Save to folder...&quot;);</span>
<span class="lineNum">   12037 </span><span class="lineCov">          4 :                         cmd = get_folder2(chan, &quot;vm-savefolder&quot;, 1);</span>
<span class="lineNum">   12038 </span><span class="lineCov">          4 :                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   12039 </span>            :                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   12040 </span><span class="lineCov">          4 :                         box = 0;        /* Shut up compiler */</span>
<span class="lineNum">   12041 </span><span class="lineCov">          4 :                         if (cmd == '#') {</span>
<span class="lineNum">   12042 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   12043 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   12044 </span><span class="lineCov">          4 :                         } else if (cmd &gt; 0) {</span>
<span class="lineNum">   12045 </span><span class="lineCov">          4 :                                 box = cmd = cmd - '0';</span>
<span class="lineNum">   12046 </span><span class="lineCov">          4 :                                 cmd = save_to_folder(vmu, &amp;vms, vms.curmsg, cmd, NULL, 0);</span>
<span class="lineNum">   12047 </span><span class="lineCov">          4 :                                 if (cmd == ERROR_LOCK_PATH) {</span>
<span class="lineNum">   12048 </span><span class="lineNoCov">          0 :                                         res = cmd;</span>
<span class="lineNum">   12049 </span><span class="lineNoCov">          0 :                                         goto out;</span>
<span class="lineNum">   12050 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">   12051 </span><span class="lineCov">          4 :                                 } else if (!cmd) {</span>
<span class="lineNum">   12052 </span><span class="lineCov">          4 :                                         vms.deleted[vms.curmsg] = 1;</span>
<span class="lineNum">   12053 </span>            : #endif
<span class="lineNum">   12054 </span>            :                                 } else {
<span class="lineNum">   12055 </span><span class="lineNoCov">          0 :                                         vms.deleted[vms.curmsg] = 0;</span>
<span class="lineNum">   12056 </span><span class="lineNoCov">          0 :                                         vms.heard[vms.curmsg] = 0;</span>
<span class="lineNum">   12057 </span>            :                                 }
<span class="lineNum">   12058 </span>            :                         }
<span class="lineNum">   12059 </span><span class="lineCov">          4 :                         make_file(vms.fn, sizeof(vms.fn), vms.curdir, vms.curmsg);</span>
<span class="lineNum">   12060 </span><span class="lineCov">          4 :                         if (useadsi)</span>
<span class="lineNum">   12061 </span><span class="lineNoCov">          0 :                                 adsi_message(chan, &amp;vms);</span>
<span class="lineNum">   12062 </span><span class="lineCov">          4 :                         snprintf(vms.fn, sizeof(vms.fn), &quot;vm-%s&quot;, mbox(vmu, box));</span>
<span class="lineNum">   12063 </span><span class="lineCov">          4 :                         if (!cmd) {</span>
<span class="lineNum">   12064 </span><span class="lineCov">          4 :                                 cmd = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<span class="lineNum">   12065 </span><span class="lineCov">          4 :                                 if (!cmd)</span>
<span class="lineNum">   12066 </span><span class="lineCov">          4 :                                         cmd = say_and_wait(chan, vms.curmsg + 1, ast_channel_language(chan));</span>
<span class="lineNum">   12067 </span><span class="lineCov">          4 :                                 if (!cmd)</span>
<span class="lineNum">   12068 </span><span class="lineCov">          4 :                                         cmd = ast_play_and_wait(chan, &quot;vm-savedto&quot;);</span>
<span class="lineNum">   12069 </span><span class="lineCov">          4 :                                 if (!cmd)</span>
<span class="lineNum">   12070 </span><span class="lineCov">          4 :                                         cmd = vm_play_folder_name(chan, vms.fn);</span>
<span class="lineNum">   12071 </span>            :                         } else {
<span class="lineNum">   12072 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-mailboxfull&quot;);</span>
<span class="lineNum">   12073 </span>            :                         }
<span class="lineNum">   12074 </span><span class="lineCov">          4 :                         if (ast_test_flag((&amp;globalflags), VM_SKIPAFTERCMD)) {</span>
<span class="lineNum">   12075 </span><span class="lineNoCov">          0 :                                 if (vms.curmsg &lt; vms.lastmsg) {</span>
<span class="lineNum">   12076 </span><span class="lineNoCov">          0 :                                         vms.curmsg++;</span>
<span class="lineNum">   12077 </span><span class="lineNoCov">          0 :                                         cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   12078 </span><span class="lineNoCov">          0 :                                 } else if (ast_test_flag(vmu, VM_MESSAGEWRAP) &amp;&amp; vms.lastmsg &gt; 0) {</span>
<span class="lineNum">   12079 </span><span class="lineNoCov">          0 :                                         vms.curmsg = 0;</span>
<span class="lineNum">   12080 </span><span class="lineNoCov">          0 :                                         cmd = play_message(chan, vmu, &amp;vms);</span>
<span class="lineNum">   12081 </span>            :                                 } else {
<span class="lineNum">   12082 </span>            :                                         /* Check if we were listening to urgent
<span class="lineNum">   12083 </span>            :                                            messages.  If so, go to regular new messages
<span class="lineNum">   12084 </span>            :                                            instead of saying &quot;no more messages&quot;
<span class="lineNum">   12085 </span>            :                                         */
<span class="lineNum">   12086 </span><span class="lineNoCov">          0 :                                         if (in_urgent == 1 &amp;&amp; vms.newmessages &gt; 0) {</span>
<span class="lineNum">   12087 </span>            :                                                 /* Check for new messages */
<span class="lineNum">   12088 </span><span class="lineNoCov">          0 :                                                 in_urgent = 0;</span>
<span class="lineNum">   12089 </span><span class="lineNoCov">          0 :                                                 res = close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   12090 </span><span class="lineNoCov">          0 :                                                 if (res == ERROR_LOCK_PATH)</span>
<span class="lineNum">   12091 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   12092 </span><span class="lineNoCov">          0 :                                                 res = open_mailbox(&amp;vms, vmu, NEW_FOLDER);</span>
<span class="lineNum">   12093 </span><span class="lineNoCov">          0 :                                                 if (res &lt; 0)</span>
<span class="lineNum">   12094 </span><span class="lineNoCov">          0 :                                                         goto out;</span>
<span class="lineNum">   12095 </span><span class="lineNoCov">          0 :                                                 ast_debug(1, &quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;, vms.lastmsg + 1);</span>
<span class="lineNum">   12096 </span><span class="lineNoCov">          0 :                                                 vms.curmsg = -1;</span>
<span class="lineNum">   12097 </span><span class="lineNoCov">          0 :                                                 if (vms.lastmsg &lt; 0) {</span>
<span class="lineNum">   12098 </span><span class="lineNoCov">          0 :                                                         cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   12099 </span>            :                                                 }
<span class="lineNum">   12100 </span>            :                                         } else {
<span class="lineNum">   12101 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-nomore&quot;);</span>
<span class="lineNum">   12102 </span>            :                                         }
<span class="lineNum">   12103 </span>            :                                 }
<span class="lineNum">   12104 </span>            :                         }
<span class="lineNum">   12105 </span><span class="lineCov">          4 :                         break;</span>
<span class="lineNum">   12106 </span><span class="lineNoCov">          0 :                 case '*': /* Help */</span>
<span class="lineNum">   12107 </span><span class="lineNoCov">          0 :                         if (!vms.starting) {</span>
<span class="lineNum">   12108 </span><span class="lineNoCov">          0 :                                 if (!strncasecmp(ast_channel_language(chan), &quot;ja&quot;, 2)) {</span>
<span class="lineNum">   12109 </span><span class="lineNoCov">          0 :                                         cmd = vm_play_folder_name(chan, vms.vmbox);</span>
<span class="lineNum">   12110 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12111 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;jp-wa&quot;);</span>
<span class="lineNum">   12112 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12113 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;digits/1&quot;);</span>
<span class="lineNum">   12114 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12115 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;jp-wo&quot;);</span>
<span class="lineNum">   12116 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12117 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;silence/1&quot;);</span>
<span class="lineNum">   12118 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12119 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-opts&quot;);</span>
<span class="lineNum">   12120 </span><span class="lineNoCov">          0 :                                         if (!cmd)</span>
<span class="lineNum">   12121 </span><span class="lineNoCov">          0 :                                                 cmd = vm_instructions(chan, vmu, &amp;vms, 1, in_urgent);</span>
<span class="lineNum">   12122 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   12123 </span>            :                                 }
<span class="lineNum">   12124 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-onefor&quot;);</span>
<span class="lineNum">   12125 </span><span class="lineNoCov">          0 :                                 if (!strncasecmp(ast_channel_language(chan), &quot;he&quot;, 2)) {</span>
<span class="lineNum">   12126 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-for&quot;);</span>
<span class="lineNum">   12127 </span>            :                                 }
<span class="lineNum">   12128 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   12129 </span><span class="lineNoCov">          0 :                                         cmd = vm_play_folder_name(chan, vms.vmbox);</span>
<span class="lineNum">   12130 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   12131 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-opts&quot;);</span>
<span class="lineNum">   12132 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   12133 </span><span class="lineNoCov">          0 :                                         cmd = vm_instructions(chan, vmu, &amp;vms, 1, in_urgent);</span>
<span class="lineNum">   12134 </span>            :                         } else
<span class="lineNum">   12135 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   12136 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   12137 </span><span class="lineCov">          9 :                 case '0': /* Mailbox options */</span>
<span class="lineNum">   12138 </span><span class="lineCov">          9 :                         cmd = vm_options(chan, vmu, &amp;vms, vmfmts, record_gain);</span>
<span class="lineNum">   12139 </span><span class="lineCov">          6 :                         if (useadsi)</span>
<span class="lineNum">   12140 </span><span class="lineNoCov">          0 :                                 adsi_status(chan, &amp;vms);</span>
<span class="lineNum">   12141 </span>            :                         /* Reopen play_folder */
<span class="lineNum">   12142 </span><span class="lineCov">          6 :                         res = open_mailbox(&amp;vms, vmu, play_folder);</span>
<span class="lineNum">   12143 </span><span class="lineCov">          6 :                         if (res &lt; 0) {</span>
<span class="lineNum">   12144 </span><span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">   12145 </span>            :                         }
<span class="lineNum">   12146 </span><span class="lineCov">          6 :                         vms.starting = 1;</span>
<span class="lineNum">   12147 </span><span class="lineCov">          6 :                         break;</span>
<span class="lineNum">   12148 </span><span class="lineCov">         44 :                 default:        /* Nothing */</span>
<span class="lineNum">   12149 </span><span class="lineCov">         44 :                         ast_test_suite_event_notify(&quot;PLAYBACK&quot;, &quot;Message: instructions&quot;);</span>
<span class="lineNum">   12150 </span><span class="lineCov">         44 :                         cmd = vm_instructions(chan, vmu, &amp;vms, 0, in_urgent);</span>
<span class="lineNum">   12151 </span><span class="lineCov">         44 :                         break;</span>
<span class="lineNum">   12152 </span>            :                 }
<span class="lineNum">   12153 </span>            :         }
<span class="lineNum">   12154 </span><span class="lineCov">         14 :         if ((cmd == 't') || (cmd == '#')) {</span>
<span class="lineNum">   12155 </span>            :                 /* Timeout */
<span class="lineNum">   12156 </span><span class="lineCov">         13 :                 res = 0;</span>
<span class="lineNum">   12157 </span>            :         } else {
<span class="lineNum">   12158 </span>            :                 /* Hangup */
<span class="lineNum">   12159 </span><span class="lineCov">          1 :                 res = -1;</span>
<span class="lineNum">   12160 </span>            :         }
<span class="lineNum">   12161 </span>            : 
<span class="lineNum">   12162 </span><span class="lineCov">         17 : out:</span>
<span class="lineNum">   12163 </span><span class="lineCov">         17 :         if (res &gt; -1) {</span>
<span class="lineNum">   12164 </span><span class="lineCov">         15 :                 ast_stopstream(chan);</span>
<span class="lineNum">   12165 </span><span class="lineCov">         15 :                 adsi_goodbye(chan);</span>
<span class="lineNum">   12166 </span><span class="lineCov">         15 :                 if (valid &amp;&amp; res != OPERATOR_EXIT) {</span>
<span class="lineNum">   12167 </span><span class="lineCov">         15 :                         if (silentexit)</span>
<span class="lineNum">   12168 </span><span class="lineCov">          2 :                                 res = ast_play_and_wait(chan, &quot;vm-dialout&quot;);</span>
<span class="lineNum">   12169 </span>            :                         else
<span class="lineNum">   12170 </span><span class="lineCov">         13 :                                 res = ast_play_and_wait(chan, &quot;vm-goodbye&quot;);</span>
<span class="lineNum">   12171 </span>            :                 }
<span class="lineNum">   12172 </span><span class="lineCov">         15 :                 if ((valid &amp;&amp; res &gt; 0) || res == OPERATOR_EXIT) {</span>
<span class="lineNum">   12173 </span><span class="lineNoCov">          0 :                         res = 0;</span>
<span class="lineNum">   12174 </span>            :                 }
<span class="lineNum">   12175 </span><span class="lineCov">         15 :                 if (useadsi)</span>
<span class="lineNum">   12176 </span><span class="lineNoCov">          0 :                         ast_adsi_unload_session(chan);</span>
<span class="lineNum">   12177 </span>            :         }
<span class="lineNum">   12178 </span><span class="lineCov">         17 :         if (vmu)</span>
<span class="lineNum">   12179 </span><span class="lineCov">         17 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   12180 </span><span class="lineCov">         17 :         if (valid) {</span>
<span class="lineNum">   12181 </span><span class="lineCov">         17 :                 int new = 0, old = 0, urgent = 0;</span>
<span class="lineNum">   12182 </span><span class="lineCov">         17 :                 snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, vms.username, vmu-&gt;context);</span>
<span class="lineNum">   12183 </span>            :                 /* Urgent flag not passwd to externnotify here */
<span class="lineNum">   12184 </span><span class="lineCov">         17 :                 run_externnotify(vmu-&gt;context, vmu-&gt;mailbox, NULL);</span>
<span class="lineNum">   12185 </span><span class="lineCov">         17 :                 ast_app_inboxcount2(ext_context, &amp;urgent, &amp;new, &amp;old);</span>
<span class="lineNum">   12186 </span><span class="lineCov">         17 :                 queue_mwi_event(ast_channel_uniqueid(chan), ext_context, urgent, new, old);</span>
<span class="lineNum">   12187 </span>            :         }
<span class="lineNum">   12188 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   12189 </span>            :         /* expunge message - use UID Expunge if supported on IMAP server*/
<span class="lineNum">   12190 </span>            :         ast_debug(3, &quot;*** Checking if we can expunge, deleted set to %d, expungeonhangup set to %d\n&quot;, deleted, expungeonhangup);
<span class="lineNum">   12191 </span>            :         if (vmu &amp;&amp; deleted == 1 &amp;&amp; expungeonhangup == 1 &amp;&amp; vms.mailstream != NULL) {
<span class="lineNum">   12192 </span>            :                 ast_mutex_lock(&amp;vms.lock);
<span class="lineNum">   12193 </span>            : #ifdef HAVE_IMAP_TK2006
<span class="lineNum">   12194 </span>            :                 if (LEVELUIDPLUS (vms.mailstream)) {
<span class="lineNum">   12195 </span>            :                         mail_expunge_full(vms.mailstream, NIL, EX_UID);
<span class="lineNum">   12196 </span>            :                 } else
<span class="lineNum">   12197 </span>            : #endif
<span class="lineNum">   12198 </span>            :                         mail_expunge(vms.mailstream);
<span class="lineNum">   12199 </span>            :                 ast_mutex_unlock(&amp;vms.lock);
<span class="lineNum">   12200 </span>            :         }
<span class="lineNum">   12201 </span>            :         /*  before we delete the state, we should copy pertinent info
<span class="lineNum">   12202 </span>            :          *  back to the persistent model */
<span class="lineNum">   12203 </span>            :         if (vmu) {
<span class="lineNum">   12204 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   12205 </span>            :         }
<span class="lineNum">   12206 </span>            : #endif
<span class="lineNum">   12207 </span><span class="lineCov">         17 :         if (vmu)</span>
<span class="lineNum">   12208 </span><span class="lineCov">         17 :                 free_user(vmu);</span>
<span class="lineNum">   12209 </span>            : 
<span class="lineNum">   12210 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   12211 </span>            :         pthread_setspecific(ts_vmstate.key, NULL);
<span class="lineNum">   12212 </span>            : #endif
<span class="lineNum">   12213 </span><span class="lineCov">         17 :         return res;</span>
<a name="12214"><span class="lineNum">   12214 </span>            : }</a>
<span class="lineNum">   12215 </span>            : 
<span class="lineNum">   12216 </span><span class="lineCov">         21 : static int vm_exec(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   12217 </span>            : {
<span class="lineNum">   12218 </span><span class="lineCov">         21 :         int res = 0;</span>
<span class="lineNum">   12219 </span>            :         char *tmp;
<span class="lineNum">   12220 </span>            :         struct leave_vm_options leave_options;
<span class="lineNum">   12221 </span><span class="lineCov">         21 :         struct ast_flags flags = { 0 };</span>
<span class="lineNum">   12222 </span>            :         char *opts[OPT_ARG_ARRAY_SIZE];
<span class="lineNum">   12223 </span><span class="lineCov">         21 :         AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">   12224 </span>            :                 AST_APP_ARG(argv0);
<span class="lineNum">   12225 </span>            :                 AST_APP_ARG(argv1);
<span class="lineNum">   12226 </span>            :         );
<span class="lineNum">   12227 </span>            : 
<span class="lineNum">   12228 </span><span class="lineCov">         21 :         memset(&amp;leave_options, 0, sizeof(leave_options));</span>
<span class="lineNum">   12229 </span>            : 
<span class="lineNum">   12230 </span><span class="lineCov">         21 :         if (ast_channel_state(chan) != AST_STATE_UP)</span>
<span class="lineNum">   12231 </span><span class="lineCov">         21 :                 ast_answer(chan);</span>
<span class="lineNum">   12232 </span>            : 
<span class="lineNum">   12233 </span><span class="lineCov">         21 :         if (!ast_strlen_zero(data)) {</span>
<span class="lineNum">   12234 </span><span class="lineCov">         21 :                 tmp = ast_strdupa(data);</span>
<span class="lineNum">   12235 </span><span class="lineCov">         21 :                 AST_STANDARD_APP_ARGS(args, tmp);</span>
<span class="lineNum">   12236 </span><span class="lineCov">         21 :                 if (args.argc == 2) {</span>
<span class="lineNum">   12237 </span><span class="lineCov">         20 :                         if (ast_app_parse_options(vm_app_options, &amp;flags, opts, args.argv1))</span>
<span class="lineNum">   12238 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   12239 </span><span class="lineCov">         20 :                         ast_copy_flags(&amp;leave_options, &amp;flags, OPT_SILENT | OPT_BUSY_GREETING | OPT_UNAVAIL_GREETING | OPT_MESSAGE_Urgent | OPT_MESSAGE_PRIORITY | OPT_DTMFEXIT);</span>
<span class="lineNum">   12240 </span><span class="lineCov">         20 :                         if (ast_test_flag(&amp;flags, OPT_RECORDGAIN)) {</span>
<span class="lineNum">   12241 </span>            :                                 int gain;
<span class="lineNum">   12242 </span>            : 
<span class="lineNum">   12243 </span><span class="lineNoCov">          0 :                                 if (sscanf(opts[OPT_ARG_RECORDGAIN], &quot;%30d&quot;, &amp;gain) != 1) {</span>
<span class="lineNum">   12244 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;Invalid value '%s' provided for record gain option\n&quot;, opts[OPT_ARG_RECORDGAIN]);</span>
<span class="lineNum">   12245 </span><span class="lineNoCov">          0 :                                         return -1;</span>
<span class="lineNum">   12246 </span>            :                                 } else {
<span class="lineNum">   12247 </span><span class="lineNoCov">          0 :                                         leave_options.record_gain = (signed char) gain;</span>
<span class="lineNum">   12248 </span>            :                                 }
<span class="lineNum">   12249 </span>            :                         }
<span class="lineNum">   12250 </span><span class="lineCov">         20 :                         if (ast_test_flag(&amp;flags, OPT_DTMFEXIT)) {</span>
<span class="lineNum">   12251 </span><span class="lineCov">         11 :                                 if (!ast_strlen_zero(opts[OPT_ARG_DTMFEXIT]))</span>
<span class="lineNum">   12252 </span><span class="lineCov">          6 :                                         leave_options.exitcontext = opts[OPT_ARG_DTMFEXIT];</span>
<span class="lineNum">   12253 </span>            :                         }
<span class="lineNum">   12254 </span>            :                 }
<span class="lineNum">   12255 </span>            :         } else {
<span class="lineNum">   12256 </span>            :                 char temp[256];
<span class="lineNum">   12257 </span><span class="lineNoCov">          0 :                 res = ast_app_getdata(chan, &quot;vm-whichbox&quot;, temp, sizeof(temp) - 1, 0);</span>
<span class="lineNum">   12258 </span><span class="lineNoCov">          0 :                 if (res &lt; 0)</span>
<span class="lineNum">   12259 </span><span class="lineNoCov">          0 :                         return res;</span>
<span class="lineNum">   12260 </span><span class="lineNoCov">          0 :                 if (ast_strlen_zero(temp))</span>
<span class="lineNum">   12261 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">   12262 </span><span class="lineNoCov">          0 :                 args.argv0 = ast_strdupa(temp);</span>
<span class="lineNum">   12263 </span>            :         }
<span class="lineNum">   12264 </span>            : 
<span class="lineNum">   12265 </span><span class="lineCov">         21 :         res = leave_voicemail(chan, args.argv0, &amp;leave_options);</span>
<span class="lineNum">   12266 </span><span class="lineCov">         21 :         if (res == 't') {</span>
<span class="lineNum">   12267 </span><span class="lineNoCov">          0 :                 ast_play_and_wait(chan, &quot;vm-goodbye&quot;);</span>
<span class="lineNum">   12268 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">   12269 </span>            :         }
<span class="lineNum">   12270 </span>            : 
<span class="lineNum">   12271 </span><span class="lineCov">         21 :         if (res == OPERATOR_EXIT) {</span>
<span class="lineNum">   12272 </span><span class="lineCov">          2 :                 res = 0;</span>
<span class="lineNum">   12273 </span>            :         }
<span class="lineNum">   12274 </span>            : 
<span class="lineNum">   12275 </span><span class="lineCov">         21 :         if (res == ERROR_LOCK_PATH) {</span>
<span class="lineNum">   12276 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Could not leave voicemail. The path is already locked.\n&quot;);</span>
<span class="lineNum">   12277 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">   12278 </span><span class="lineNoCov">          0 :                 res = 0;</span>
<span class="lineNum">   12279 </span>            :         }
<span class="lineNum">   12280 </span>            : 
<span class="lineNum">   12281 </span><span class="lineCov">         21 :         return res;</span>
<a name="12282"><span class="lineNum">   12282 </span>            : }</a>
<span class="lineNum">   12283 </span>            : 
<span class="lineNum">   12284 </span><span class="lineNoCov">          0 : static int add_message_id(struct ast_config *msg_cfg, char *dir, int msg, char *filename, char *id, size_t id_size, struct ast_vm_user *vmu, int folder)</span>
<span class="lineNum">   12285 </span>            : {
<span class="lineNum">   12286 </span>            :         struct ast_variable *var;
<span class="lineNum">   12287 </span>            :         struct ast_category *cat;
<span class="lineNum">   12288 </span><span class="lineNoCov">          0 :         generate_msg_id(id);</span>
<span class="lineNum">   12289 </span>            : 
<span class="lineNum">   12290 </span><span class="lineNoCov">          0 :         var = ast_variable_new(&quot;msg_id&quot;, id, &quot;&quot;);</span>
<span class="lineNum">   12291 </span><span class="lineNoCov">          0 :         if (!var) {</span>
<span class="lineNum">   12292 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12293 </span>            :         }
<span class="lineNum">   12294 </span>            : 
<span class="lineNum">   12295 </span><span class="lineNoCov">          0 :         cat = ast_category_get(msg_cfg, &quot;message&quot;, NULL);</span>
<span class="lineNum">   12296 </span><span class="lineNoCov">          0 :         if (!cat) {</span>
<span class="lineNum">   12297 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Voicemail data file %s/%d.txt has no [message] category?\n&quot;, dir, msg);</span>
<span class="lineNum">   12298 </span><span class="lineNoCov">          0 :                 ast_variables_destroy(var);</span>
<span class="lineNum">   12299 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12300 </span>            :         }
<span class="lineNum">   12301 </span>            : 
<span class="lineNum">   12302 </span><span class="lineNoCov">          0 :         ast_variable_append(cat, var);</span>
<span class="lineNum">   12303 </span>            : 
<span class="lineNum">   12304 </span><span class="lineNoCov">          0 :         if (ast_config_text_file_save(filename, msg_cfg, &quot;app_voicemail&quot;)) {</span>
<span class="lineNum">   12305 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Unable to update %s to have a message ID\n&quot;, filename);</span>
<span class="lineNum">   12306 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12307 </span>            :         }
<span class="lineNum">   12308 </span>            : 
<span class="lineNum">   12309 </span>            :         UPDATE_MSG_ID(dir, msg, id, vmu, msg_cfg, folder);
<span class="lineNum">   12310 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="12311"><span class="lineNum">   12311 </span>            : }</a>
<span class="lineNum">   12312 </span>            : 
<span class="lineNum">   12313 </span><span class="lineCov">       2157 : static struct ast_vm_user *find_or_create(const char *context, const char *box)</span>
<span class="lineNum">   12314 </span>            : {
<span class="lineNum">   12315 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   12316 </span>            : 
<span class="lineNum">   12317 </span><span class="lineCov">       2157 :         if (!ast_strlen_zero(box) &amp;&amp; box[0] == '*') {</span>
<span class="lineNum">   12318 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Mailbox %s in context %s begins with '*' character.  The '*' character,&quot;</span>
<span class="lineNum">   12319 </span>            :                                 &quot;\n\twhen it is the first character in a mailbox or password, is used to jump to a&quot;
<span class="lineNum">   12320 </span>            :                                 &quot;\n\tpredefined extension 'a'.  A mailbox or password beginning with '*' is not valid&quot;
<span class="lineNum">   12321 </span>            :                                 &quot;\n\tand will be ignored.\n&quot;, box, context);
<span class="lineNum">   12322 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   12323 </span>            :         }
<span class="lineNum">   12324 </span>            : 
<span class="lineNum">   12325 </span><span class="lineCov">       3297 :         AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   12326 </span><span class="lineCov">       1140 :                 if (ast_test_flag((&amp;globalflags), VM_SEARCH) &amp;&amp; !strcasecmp(box, vmu-&gt;mailbox)) {</span>
<span class="lineNum">   12327 </span><span class="lineNoCov">          0 :                         if (strcasecmp(vmu-&gt;context, context)) {</span>
<span class="lineNum">   12328 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;\nIt has been detected that you have defined mailbox '%s' in separate\</span>
<span class="lineNum">   12329 </span>            :                                                 \n\tcontexts and that you have the 'searchcontexts' option on. This type of\
<span class="lineNum">   12330 </span>            :                                                 \n\tconfiguration creates an ambiguity that you likely do not want. Please\
<span class="lineNum">   12331 </span>            :                                                 \n\tamend your voicemail.conf file to avoid this situation.\n&quot;, box);
<span class="lineNum">   12332 </span>            :                         }
<span class="lineNum">   12333 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Ignoring duplicated mailbox %s\n&quot;, box);</span>
<span class="lineNum">   12334 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">   12335 </span>            :                 }
<span class="lineNum">   12336 </span><span class="lineCov">       1140 :                 if (!strcasecmp(context, vmu-&gt;context) &amp;&amp; !strcasecmp(box, vmu-&gt;mailbox)) {</span>
<span class="lineNum">   12337 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Ignoring duplicated mailbox %s in context %s\n&quot;, box, context);</span>
<span class="lineNum">   12338 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">   12339 </span>            :                 }
<span class="lineNum">   12340 </span>            :         }
<span class="lineNum">   12341 </span>            : 
<span class="lineNum">   12342 </span><span class="lineCov">       2157 :         if (!(vmu = ast_calloc(1, sizeof(*vmu))))</span>
<span class="lineNum">   12343 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   12344 </span>            : 
<span class="lineNum">   12345 </span><span class="lineCov">       2157 :         ast_copy_string(vmu-&gt;context, context, sizeof(vmu-&gt;context));</span>
<span class="lineNum">   12346 </span><span class="lineCov">       2157 :         ast_copy_string(vmu-&gt;mailbox, box, sizeof(vmu-&gt;mailbox));</span>
<span class="lineNum">   12347 </span>            : 
<span class="lineNum">   12348 </span><span class="lineCov">       2157 :         AST_LIST_INSERT_TAIL(&amp;users, vmu, list);</span>
<span class="lineNum">   12349 </span>            : 
<span class="lineNum">   12350 </span><span class="lineCov">       2157 :         return vmu;</span>
<a name="12351"><span class="lineNum">   12351 </span>            : }</a>
<span class="lineNum">   12352 </span>            : 
<span class="lineNum">   12353 </span><span class="lineCov">       2135 : static int append_mailbox(const char *context, const char *box, const char *data)</span>
<span class="lineNum">   12354 </span>            : {
<span class="lineNum">   12355 </span>            :         /* Assumes lock is already held */
<span class="lineNum">   12356 </span>            :         char *tmp;
<span class="lineNum">   12357 </span>            :         char *stringp;
<span class="lineNum">   12358 </span>            :         char *s;
<span class="lineNum">   12359 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   12360 </span>            :         char *mailbox_full;
<span class="lineNum">   12361 </span><span class="lineCov">       2135 :         int new = 0, old = 0, urgent = 0;</span>
<span class="lineNum">   12362 </span><span class="lineCov">       2135 :         char secretfn[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">   12363 </span>            : 
<span class="lineNum">   12364 </span><span class="lineCov">       2135 :         tmp = ast_strdupa(data);</span>
<span class="lineNum">   12365 </span>            : 
<span class="lineNum">   12366 </span><span class="lineCov">       2135 :         if (!(vmu = find_or_create(context, box)))</span>
<span class="lineNum">   12367 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12368 </span>            : 
<span class="lineNum">   12369 </span><span class="lineCov">       2135 :         populate_defaults(vmu);</span>
<span class="lineNum">   12370 </span>            : 
<span class="lineNum">   12371 </span><span class="lineCov">       2135 :         stringp = tmp;</span>
<span class="lineNum">   12372 </span><span class="lineCov">       2135 :         if ((s = strsep(&amp;stringp, &quot;,&quot;))) {</span>
<span class="lineNum">   12373 </span><span class="lineCov">       2135 :                 if (!ast_strlen_zero(s) &amp;&amp; s[0] == '*') {</span>
<span class="lineNum">   12374 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Invalid password detected for mailbox %s.  The password&quot;</span>
<span class="lineNum">   12375 </span>            :                                 &quot;\n\tmust be reset in voicemail.conf.\n&quot;, box);
<span class="lineNum">   12376 </span>            :                 }
<span class="lineNum">   12377 </span>            :                 /* assign password regardless of validity to prevent NULL password from being assigned */
<span class="lineNum">   12378 </span><span class="lineCov">       2135 :                 ast_copy_string(vmu-&gt;password, s, sizeof(vmu-&gt;password));</span>
<span class="lineNum">   12379 </span>            :         }
<span class="lineNum">   12380 </span><span class="lineCov">       2135 :         if (stringp &amp;&amp; (s = strsep(&amp;stringp, &quot;,&quot;))) {</span>
<span class="lineNum">   12381 </span><span class="lineCov">       2135 :                 ast_copy_string(vmu-&gt;fullname, s, sizeof(vmu-&gt;fullname));</span>
<span class="lineNum">   12382 </span>            :         }
<span class="lineNum">   12383 </span><span class="lineCov">       2135 :         if (stringp &amp;&amp; (s = strsep(&amp;stringp, &quot;,&quot;))) {</span>
<span class="lineNum">   12384 </span><span class="lineCov">       2076 :                 vmu-&gt;email = ast_strdup(s);</span>
<span class="lineNum">   12385 </span>            :         }
<span class="lineNum">   12386 </span><span class="lineCov">       2135 :         if (stringp &amp;&amp; (s = strsep(&amp;stringp, &quot;,&quot;))) {</span>
<span class="lineNum">   12387 </span><span class="lineCov">          2 :                 ast_copy_string(vmu-&gt;pager, s, sizeof(vmu-&gt;pager));</span>
<span class="lineNum">   12388 </span>            :         }
<span class="lineNum">   12389 </span><span class="lineCov">       2135 :         if (stringp &amp;&amp; (s = strsep(&amp;stringp, &quot;,&quot;))) {</span>
<span class="lineNum">   12390 </span><span class="lineCov">          2 :                 apply_options(vmu, s);</span>
<span class="lineNum">   12391 </span>            :         }
<span class="lineNum">   12392 </span>            : 
<span class="lineNum">   12393 </span><span class="lineCov">       2135 :         switch (vmu-&gt;passwordlocation) {</span>
<span class="lineNum">   12394 </span><span class="lineCov">          1 :         case OPT_PWLOC_SPOOLDIR:</span>
<span class="lineNum">   12395 </span><span class="lineCov">          1 :                 snprintf(secretfn, sizeof(secretfn), &quot;%s%s/%s/secret.conf&quot;, VM_SPOOL_DIR, vmu-&gt;context, vmu-&gt;mailbox);</span>
<span class="lineNum">   12396 </span><span class="lineCov">          1 :                 read_password_from_file(secretfn, vmu-&gt;password, sizeof(vmu-&gt;password));</span>
<span class="lineNum">   12397 </span>            :         }
<span class="lineNum">   12398 </span>            : 
<span class="lineNum">   12399 </span><span class="lineCov">       2135 :         mailbox_full = ast_alloca(strlen(box) + strlen(context) + 1);</span>
<span class="lineNum">   12400 </span><span class="lineCov">       2135 :         strcpy(mailbox_full, box);</span>
<span class="lineNum">   12401 </span><span class="lineCov">       2135 :         strcat(mailbox_full, &quot;@&quot;);</span>
<span class="lineNum">   12402 </span><span class="lineCov">       2135 :         strcat(mailbox_full, context);</span>
<span class="lineNum">   12403 </span>            : 
<span class="lineNum">   12404 </span><span class="lineCov">       2135 :         inboxcount2(mailbox_full, &amp;urgent, &amp;new, &amp;old);</span>
<span class="lineNum">   12405 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   12406 </span>            :         imap_logout(mailbox_full);
<span class="lineNum">   12407 </span>            : #endif
<span class="lineNum">   12408 </span><span class="lineCov">       2135 :         queue_mwi_event(NULL, mailbox_full, urgent, new, old);</span>
<span class="lineNum">   12409 </span>            : 
<span class="lineNum">   12410 </span><span class="lineCov">       2135 :         return 0;</span>
<span class="lineNum">   12411 </span>            : }
<a name="12412"><span class="lineNum">   12412 </span>            : </a>
<span class="lineNum">   12413 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   12414 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_vmuser)</span>
<span class="lineNum">   12415 </span>            : {
<span class="lineNum">   12416 </span><span class="lineCov">       1074 :         int res = 0;</span>
<span class="lineNum">   12417 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   12418 </span>            :         /* language parameter seems to only be used for display in manager action */
<span class="lineNum">   12419 </span>            :         static const char options_string[] = &quot;attach=yes|attachfmt=wav49|&quot;
<span class="lineNum">   12420 </span>            :                 &quot;serveremail=someguy@digium.com|fromstring=Voicemail System|tz=central|delete=yes|saycid=yes|&quot;
<span class="lineNum">   12421 </span>            :                 &quot;sendvoicemail=yes|review=yes|tempgreetwarn=yes|messagewrap=yes|operator=yes|&quot;
<span class="lineNum">   12422 </span>            :                 &quot;envelope=yes|moveheard=yes|sayduration=yes|saydurationm=5|forcename=yes|&quot;
<span class="lineNum">   12423 </span>            :                 &quot;forcegreetings=yes|callback=somecontext|dialout=somecontext2|&quot;
<span class="lineNum">   12424 </span>            :                 &quot;exitcontext=somecontext3|minsecs=10|maxsecs=100|nextaftercmd=yes|&quot;
<span class="lineNum">   12425 </span>            :                 &quot;backupdeleted=50|volgain=1.3|passwordlocation=spooldir|emailbody=&quot;
<span class="lineNum">   12426 </span>            :                 &quot;Dear ${VM_NAME}:\n\n\tYou were just left a ${VM_DUR} long message|emailsubject=&quot;
<span class="lineNum">   12427 </span>            :                 &quot;[PBX]: New message \\\\${VM_MSGNUM}\\\\ in mailbox ${VM_MAILBOX}&quot;;
<span class="lineNum">   12428 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   12429 </span>            :         static const char option_string2[] = &quot;imapuser=imapuser|imappassword=imappasswd|&quot;
<span class="lineNum">   12430 </span>            :                 &quot;imapfolder=INBOX|imapvmshareid=6000|imapserver=imapserver|imapport=1234|imapflags=flagged&quot;;
<span class="lineNum">   12431 </span>            : #endif
<span class="lineNum">   12432 </span>            : 
<span class="lineNum">   12433 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   12434 </span><span class="lineCov">       1073 :         case TEST_INIT:</span>
<span class="lineNum">   12435 </span><span class="lineCov">       1073 :                 info-&gt;name = &quot;vmuser&quot;;</span>
<span class="lineNum">   12436 </span><span class="lineCov">       1073 :                 info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   12437 </span><span class="lineCov">       1073 :                 info-&gt;summary = &quot;Vmuser unit test&quot;;</span>
<span class="lineNum">   12438 </span><span class="lineCov">       1073 :                 info-&gt;description =</span>
<span class="lineNum">   12439 </span>            :                         &quot;This tests passing all supported parameters to apply_options, the voicemail user config parser&quot;;
<span class="lineNum">   12440 </span><span class="lineCov">       1073 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   12441 </span><span class="lineCov">          1 :         case TEST_EXECUTE:</span>
<span class="lineNum">   12442 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">   12443 </span>            :         }
<span class="lineNum">   12444 </span>            : 
<span class="lineNum">   12445 </span><span class="lineCov">          1 :         if (!(vmu = ast_calloc(1, sizeof(*vmu)))) {</span>
<span class="lineNum">   12446 </span><span class="lineNoCov">          0 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   12447 </span>            :         }
<span class="lineNum">   12448 </span><span class="lineCov">          1 :         populate_defaults(vmu);</span>
<span class="lineNum">   12449 </span><span class="lineCov">          1 :         ast_set_flag(vmu, VM_ALLOCED);</span>
<span class="lineNum">   12450 </span>            : 
<span class="lineNum">   12451 </span><span class="lineCov">          1 :         apply_options(vmu, options_string);</span>
<span class="lineNum">   12452 </span>            : 
<span class="lineNum">   12453 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_ATTACH)) {</span>
<span class="lineNum">   12454 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for attach option\n&quot;);</span>
<span class="lineNum">   12455 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12456 </span>            :         }
<span class="lineNum">   12457 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;attachfmt, &quot;wav49&quot;)) {</span>
<span class="lineNum">   12458 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for attachftm option\n&quot;);</span>
<span class="lineNum">   12459 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12460 </span>            :         }
<span class="lineNum">   12461 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;fromstring, &quot;Voicemail System&quot;)) {</span>
<span class="lineNum">   12462 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for fromstring option\n&quot;);</span>
<span class="lineNum">   12463 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12464 </span>            :         }
<span class="lineNum">   12465 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;serveremail, &quot;someguy@digium.com&quot;)) {</span>
<span class="lineNum">   12466 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for serveremail option\n&quot;);</span>
<span class="lineNum">   12467 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12468 </span>            :         }
<span class="lineNum">   12469 </span><span class="lineCov">          1 :         if (!vmu-&gt;emailsubject || strcasecmp(vmu-&gt;emailsubject, &quot;[PBX]: New message \\${VM_MSGNUM}\\ in mailbox ${VM_MAILBOX}&quot;)) {</span>
<span class="lineNum">   12470 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for emailsubject option\n&quot;);</span>
<span class="lineNum">   12471 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12472 </span>            :         }
<span class="lineNum">   12473 </span><span class="lineCov">          1 :         if (!vmu-&gt;emailbody || strcasecmp(vmu-&gt;emailbody, &quot;Dear ${VM_NAME}:\n\n\tYou were just left a ${VM_DUR} long message&quot;)) {</span>
<span class="lineNum">   12474 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for emailbody option\n&quot;);</span>
<span class="lineNum">   12475 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12476 </span>            :         }
<span class="lineNum">   12477 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;zonetag, &quot;central&quot;)) {</span>
<span class="lineNum">   12478 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for tz option\n&quot;);</span>
<span class="lineNum">   12479 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12480 </span>            :         }
<span class="lineNum">   12481 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_DELETE)) {</span>
<span class="lineNum">   12482 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for delete option\n&quot;);</span>
<span class="lineNum">   12483 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12484 </span>            :         }
<span class="lineNum">   12485 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_SAYCID)) {</span>
<span class="lineNum">   12486 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for saycid option\n&quot;);</span>
<span class="lineNum">   12487 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12488 </span>            :         }
<span class="lineNum">   12489 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_SVMAIL)) {</span>
<span class="lineNum">   12490 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for sendvoicemail option\n&quot;);</span>
<span class="lineNum">   12491 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12492 </span>            :         }
<span class="lineNum">   12493 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_REVIEW)) {</span>
<span class="lineNum">   12494 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for review option\n&quot;);</span>
<span class="lineNum">   12495 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12496 </span>            :         }
<span class="lineNum">   12497 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_TEMPGREETWARN)) {</span>
<span class="lineNum">   12498 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for tempgreetwarm option\n&quot;);</span>
<span class="lineNum">   12499 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12500 </span>            :         }
<span class="lineNum">   12501 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_MESSAGEWRAP)) {</span>
<span class="lineNum">   12502 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for messagewrap option\n&quot;);</span>
<span class="lineNum">   12503 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12504 </span>            :         }
<span class="lineNum">   12505 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_OPERATOR)) {</span>
<span class="lineNum">   12506 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for operator option\n&quot;);</span>
<span class="lineNum">   12507 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12508 </span>            :         }
<span class="lineNum">   12509 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_ENVELOPE)) {</span>
<span class="lineNum">   12510 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for envelope option\n&quot;);</span>
<span class="lineNum">   12511 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12512 </span>            :         }
<span class="lineNum">   12513 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_MOVEHEARD)) {</span>
<span class="lineNum">   12514 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for moveheard option\n&quot;);</span>
<span class="lineNum">   12515 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12516 </span>            :         }
<span class="lineNum">   12517 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_SAYDURATION)) {</span>
<span class="lineNum">   12518 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for sayduration option\n&quot;);</span>
<span class="lineNum">   12519 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12520 </span>            :         }
<span class="lineNum">   12521 </span><span class="lineCov">          1 :         if (vmu-&gt;saydurationm != 5) {</span>
<span class="lineNum">   12522 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for saydurationm option\n&quot;);</span>
<span class="lineNum">   12523 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12524 </span>            :         }
<span class="lineNum">   12525 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_FORCENAME)) {</span>
<span class="lineNum">   12526 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for forcename option\n&quot;);</span>
<span class="lineNum">   12527 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12528 </span>            :         }
<span class="lineNum">   12529 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_FORCEGREET)) {</span>
<span class="lineNum">   12530 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for forcegreetings option\n&quot;);</span>
<span class="lineNum">   12531 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12532 </span>            :         }
<span class="lineNum">   12533 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;callback, &quot;somecontext&quot;)) {</span>
<span class="lineNum">   12534 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for callbacks option\n&quot;);</span>
<span class="lineNum">   12535 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12536 </span>            :         }
<span class="lineNum">   12537 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;dialout, &quot;somecontext2&quot;)) {</span>
<span class="lineNum">   12538 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for dialout option\n&quot;);</span>
<span class="lineNum">   12539 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12540 </span>            :         }
<span class="lineNum">   12541 </span><span class="lineCov">          1 :         if (strcasecmp(vmu-&gt;exit, &quot;somecontext3&quot;)) {</span>
<span class="lineNum">   12542 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for exitcontext option\n&quot;);</span>
<span class="lineNum">   12543 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12544 </span>            :         }
<span class="lineNum">   12545 </span><span class="lineCov">          1 :         if (vmu-&gt;minsecs != 10) {</span>
<span class="lineNum">   12546 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for minsecs option\n&quot;);</span>
<span class="lineNum">   12547 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12548 </span>            :         }
<span class="lineNum">   12549 </span><span class="lineCov">          1 :         if (vmu-&gt;maxsecs != 100) {</span>
<span class="lineNum">   12550 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for maxsecs option\n&quot;);</span>
<span class="lineNum">   12551 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12552 </span>            :         }
<span class="lineNum">   12553 </span><span class="lineCov">          1 :         if (!ast_test_flag(vmu, VM_SKIPAFTERCMD)) {</span>
<span class="lineNum">   12554 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for nextaftercmd option\n&quot;);</span>
<span class="lineNum">   12555 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12556 </span>            :         }
<span class="lineNum">   12557 </span><span class="lineCov">          1 :         if (vmu-&gt;maxdeletedmsg != 50) {</span>
<span class="lineNum">   12558 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for backupdeleted option\n&quot;);</span>
<span class="lineNum">   12559 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12560 </span>            :         }
<span class="lineNum">   12561 </span><span class="lineCov">          1 :         if (vmu-&gt;volgain != 1.3) {</span>
<span class="lineNum">   12562 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for volgain option\n&quot;);</span>
<span class="lineNum">   12563 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12564 </span>            :         }
<span class="lineNum">   12565 </span><span class="lineCov">          1 :         if (vmu-&gt;passwordlocation != OPT_PWLOC_SPOOLDIR) {</span>
<span class="lineNum">   12566 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Parse failure for passwordlocation option\n&quot;);</span>
<span class="lineNum">   12567 </span><span class="lineNoCov">          0 :                 res = 1;</span>
<span class="lineNum">   12568 </span>            :         }
<span class="lineNum">   12569 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   12570 </span>            :         apply_options(vmu, option_string2);
<span class="lineNum">   12571 </span>            : 
<span class="lineNum">   12572 </span>            :         if (strcasecmp(vmu-&gt;imapuser, &quot;imapuser&quot;)) {
<span class="lineNum">   12573 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapuser option\n&quot;);
<span class="lineNum">   12574 </span>            :                 res = 1;
<span class="lineNum">   12575 </span>            :         }
<span class="lineNum">   12576 </span>            :         if (strcasecmp(vmu-&gt;imappassword, &quot;imappasswd&quot;)) {
<span class="lineNum">   12577 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imappasswd option\n&quot;);
<span class="lineNum">   12578 </span>            :                 res = 1;
<span class="lineNum">   12579 </span>            :         }
<span class="lineNum">   12580 </span>            :         if (strcasecmp(vmu-&gt;imapfolder, &quot;INBOX&quot;)) {
<span class="lineNum">   12581 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapfolder option\n&quot;);
<span class="lineNum">   12582 </span>            :                 res = 1;
<span class="lineNum">   12583 </span>            :         }
<span class="lineNum">   12584 </span>            :         if (strcasecmp(vmu-&gt;imapvmshareid, &quot;6000&quot;)) {
<span class="lineNum">   12585 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapvmshareid option\n&quot;);
<span class="lineNum">   12586 </span>            :                 res = 1;
<span class="lineNum">   12587 </span>            :         }
<span class="lineNum">   12588 </span>            :         if (strcasecmp(vmu-&gt;imapserver, &quot;imapserver&quot;)) {
<span class="lineNum">   12589 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapserver option\n&quot;);
<span class="lineNum">   12590 </span>            :                 res = 1;
<span class="lineNum">   12591 </span>            :         }
<span class="lineNum">   12592 </span>            :         if (strcasecmp(vmu-&gt;imapport, &quot;1234&quot;)) {
<span class="lineNum">   12593 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapport option\n&quot;);
<span class="lineNum">   12594 </span>            :                 res = 1;
<span class="lineNum">   12595 </span>            :         }
<span class="lineNum">   12596 </span>            :         if (strcasecmp(vmu-&gt;imapflags, &quot;flagged&quot;)) {
<span class="lineNum">   12597 </span>            :                 ast_test_status_update(test, &quot;Parse failure for imapflags option\n&quot;);
<span class="lineNum">   12598 </span>            :                 res = 1;
<span class="lineNum">   12599 </span>            :         }
<span class="lineNum">   12600 </span>            : #endif
<span class="lineNum">   12601 </span>            : 
<span class="lineNum">   12602 </span><span class="lineCov">          1 :         free_user(vmu);</span>
<span class="lineNum">   12603 </span><span class="lineCov">          1 :         return res ? AST_TEST_FAIL : AST_TEST_PASS;</span>
<span class="lineNum">   12604 </span>            : }
<a name="12605"><span class="lineNum">   12605 </span>            : #endif</a>
<span class="lineNum">   12606 </span>            : 
<span class="lineNum">   12607 </span><span class="lineNoCov">          0 : static int vm_box_exists(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   12608 </span>            : {
<span class="lineNum">   12609 </span>            :         struct ast_vm_user svm, *vmu;
<span class="lineNum">   12610 </span>            :         char *context, *box;
<span class="lineNum">   12611 </span><span class="lineNoCov">          0 :         AST_DECLARE_APP_ARGS(args,</span>
<span class="lineNum">   12612 </span>            :                 AST_APP_ARG(mbox);
<span class="lineNum">   12613 </span>            :                 AST_APP_ARG(options);
<span class="lineNum">   12614 </span>            :         );
<span class="lineNum">   12615 </span>            :         static int dep_warning = 0;
<span class="lineNum">   12616 </span>            : 
<span class="lineNum">   12617 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(data)) {</span>
<span class="lineNum">   12618 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;MailboxExists requires an argument: (vmbox[@context][|options])\n&quot;);</span>
<span class="lineNum">   12619 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12620 </span>            :         }
<span class="lineNum">   12621 </span>            : 
<span class="lineNum">   12622 </span><span class="lineNoCov">          0 :         if (!dep_warning) {</span>
<span class="lineNum">   12623 </span><span class="lineNoCov">          0 :                 dep_warning = 1;</span>
<span class="lineNum">   12624 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;MailboxExists is deprecated.  Please use ${VM_INFO(%s,exists)} instead.\n&quot;, data);</span>
<span class="lineNum">   12625 </span>            :         }
<span class="lineNum">   12626 </span>            : 
<span class="lineNum">   12627 </span><span class="lineNoCov">          0 :         box = ast_strdupa(data);</span>
<span class="lineNum">   12628 </span>            : 
<span class="lineNum">   12629 </span><span class="lineNoCov">          0 :         AST_STANDARD_APP_ARGS(args, box);</span>
<span class="lineNum">   12630 </span>            : 
<span class="lineNum">   12631 </span><span class="lineNoCov">          0 :         if (args.options) {</span>
<span class="lineNum">   12632 </span>            :         }
<span class="lineNum">   12633 </span>            : 
<span class="lineNum">   12634 </span><span class="lineNoCov">          0 :         if ((context = strchr(args.mbox, '@'))) {</span>
<span class="lineNum">   12635 </span><span class="lineNoCov">          0 :                 *context = '\0';</span>
<span class="lineNum">   12636 </span><span class="lineNoCov">          0 :                 context++;</span>
<span class="lineNum">   12637 </span>            :         }
<span class="lineNum">   12638 </span>            : 
<span class="lineNum">   12639 </span><span class="lineNoCov">          0 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">   12640 </span><span class="lineNoCov">          0 :         vmu = find_user(&amp;svm, context, args.mbox);</span>
<span class="lineNum">   12641 </span><span class="lineNoCov">          0 :         if (vmu) {</span>
<span class="lineNum">   12642 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMBOXEXISTSSTATUS&quot;, &quot;SUCCESS&quot;);</span>
<span class="lineNum">   12643 </span><span class="lineNoCov">          0 :                 free_user(vmu);</span>
<span class="lineNum">   12644 </span>            :         } else
<span class="lineNum">   12645 </span><span class="lineNoCov">          0 :                 pbx_builtin_setvar_helper(chan, &quot;VMBOXEXISTSSTATUS&quot;, &quot;FAILED&quot;);</span>
<span class="lineNum">   12646 </span>            : 
<span class="lineNum">   12647 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="12648"><span class="lineNum">   12648 </span>            : }</a>
<span class="lineNum">   12649 </span>            : 
<span class="lineNum">   12650 </span><span class="lineNoCov">          0 : static int acf_mailbox_exists(struct ast_channel *chan, const char *cmd, char *args, char *buf, size_t len)</span>
<span class="lineNum">   12651 </span>            : {
<span class="lineNum">   12652 </span>            :         struct ast_vm_user svm, *vmu;
<span class="lineNum">   12653 </span><span class="lineNoCov">          0 :         AST_DECLARE_APP_ARGS(arg,</span>
<span class="lineNum">   12654 </span>            :                 AST_APP_ARG(mbox);
<span class="lineNum">   12655 </span>            :                 AST_APP_ARG(context);
<span class="lineNum">   12656 </span>            :         );
<span class="lineNum">   12657 </span>            :         static int dep_warning = 0;
<span class="lineNum">   12658 </span>            : 
<span class="lineNum">   12659 </span><span class="lineNoCov">          0 :         AST_NONSTANDARD_APP_ARGS(arg, args, '@');</span>
<span class="lineNum">   12660 </span>            : 
<span class="lineNum">   12661 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(arg.mbox)) {</span>
<span class="lineNum">   12662 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;MAILBOX_EXISTS requires an argument (&lt;mailbox&gt;[@&lt;context&gt;])\n&quot;);</span>
<span class="lineNum">   12663 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   12664 </span>            :         }
<span class="lineNum">   12665 </span>            : 
<span class="lineNum">   12666 </span><span class="lineNoCov">          0 :         if (!dep_warning) {</span>
<span class="lineNum">   12667 </span><span class="lineNoCov">          0 :                 dep_warning = 1;</span>
<span class="lineNum">   12668 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;MAILBOX_EXISTS is deprecated.  Please use ${VM_INFO(%s,exists)} instead.\n&quot;, args);</span>
<span class="lineNum">   12669 </span>            :         }
<span class="lineNum">   12670 </span>            : 
<span class="lineNum">   12671 </span><span class="lineNoCov">          0 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">   12672 </span><span class="lineNoCov">          0 :         vmu = find_user(&amp;svm, ast_strlen_zero(arg.context) ? &quot;default&quot; : arg.context, arg.mbox);</span>
<span class="lineNum">   12673 </span><span class="lineNoCov">          0 :         ast_copy_string(buf, vmu ? &quot;1&quot; : &quot;0&quot;, len);</span>
<span class="lineNum">   12674 </span><span class="lineNoCov">          0 :         free_user(vmu);</span>
<span class="lineNum">   12675 </span>            : 
<span class="lineNum">   12676 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="12677"><span class="lineNum">   12677 </span>            : }</a>
<span class="lineNum">   12678 </span>            : 
<span class="lineNum">   12679 </span><span class="lineCov">         13 : static int acf_vm_info(struct ast_channel *chan, const char *cmd, char *args, char *buf, size_t len)</span>
<span class="lineNum">   12680 </span>            : {
<span class="lineNum">   12681 </span>            :         struct ast_vm_user svm;
<span class="lineNum">   12682 </span><span class="lineCov">         13 :         struct ast_vm_user *vmu = NULL;</span>
<span class="lineNum">   12683 </span>            :         char *parse;
<span class="lineNum">   12684 </span>            :         char *mailbox;
<span class="lineNum">   12685 </span>            :         char *context;
<span class="lineNum">   12686 </span><span class="lineCov">         13 :         int res = 0;</span>
<span class="lineNum">   12687 </span>            : 
<span class="lineNum">   12688 </span><span class="lineCov">         13 :         AST_DECLARE_APP_ARGS(arg,</span>
<span class="lineNum">   12689 </span>            :                 AST_APP_ARG(mailbox_context);
<span class="lineNum">   12690 </span>            :                 AST_APP_ARG(attribute);
<span class="lineNum">   12691 </span>            :                 AST_APP_ARG(folder);
<span class="lineNum">   12692 </span>            :         );
<span class="lineNum">   12693 </span>            : 
<span class="lineNum">   12694 </span><span class="lineCov">         13 :         buf[0] = '\0';</span>
<span class="lineNum">   12695 </span>            : 
<span class="lineNum">   12696 </span><span class="lineCov">         13 :         if (ast_strlen_zero(args)) {</span>
<span class="lineNum">   12697 </span><span class="lineCov">          1 :                 ast_log(LOG_ERROR, &quot;VM_INFO requires an argument (&lt;mailbox&gt;[@&lt;context&gt;],attribute[,folder])\n&quot;);</span>
<span class="lineNum">   12698 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   12699 </span>            :         }
<span class="lineNum">   12700 </span>            : 
<span class="lineNum">   12701 </span><span class="lineCov">         12 :         parse = ast_strdupa(args);</span>
<span class="lineNum">   12702 </span><span class="lineCov">         12 :         AST_STANDARD_APP_ARGS(arg, parse);</span>
<span class="lineNum">   12703 </span>            : 
<span class="lineNum">   12704 </span><span class="lineCov">         12 :         if (ast_strlen_zero(arg.mailbox_context)</span>
<span class="lineNum">   12705 </span><span class="lineCov">         12 :                 || ast_strlen_zero(arg.attribute)</span>
<span class="lineNum">   12706 </span><span class="lineCov">         11 :                 || separate_mailbox(ast_strdupa(arg.mailbox_context), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">   12707 </span><span class="lineCov">          1 :                 ast_log(LOG_ERROR, &quot;VM_INFO requires an argument (&lt;mailbox&gt;[@&lt;context&gt;],attribute[,folder])\n&quot;);</span>
<span class="lineNum">   12708 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   12709 </span>            :         }
<span class="lineNum">   12710 </span>            : 
<span class="lineNum">   12711 </span><span class="lineCov">         11 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">   12712 </span><span class="lineCov">         11 :         vmu = find_user(&amp;svm, context, mailbox);</span>
<span class="lineNum">   12713 </span>            : 
<span class="lineNum">   12714 </span><span class="lineCov">         11 :         if (!strncasecmp(arg.attribute, &quot;exists&quot;, 5)) {</span>
<span class="lineNum">   12715 </span><span class="lineCov">          2 :                 ast_copy_string(buf, vmu ? &quot;1&quot; : &quot;0&quot;, len);</span>
<span class="lineNum">   12716 </span><span class="lineCov">          2 :                 free_user(vmu);</span>
<span class="lineNum">   12717 </span><span class="lineCov">          2 :                 return 0;</span>
<span class="lineNum">   12718 </span>            :         }
<span class="lineNum">   12719 </span>            : 
<span class="lineNum">   12720 </span><span class="lineCov">          9 :         if (vmu) {</span>
<span class="lineNum">   12721 </span><span class="lineCov">          8 :                 if (!strncasecmp(arg.attribute, &quot;password&quot;, 8)) {</span>
<span class="lineNum">   12722 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;password, len);</span>
<span class="lineNum">   12723 </span><span class="lineCov">          7 :                 } else if (!strncasecmp(arg.attribute, &quot;fullname&quot;, 8)) {</span>
<span class="lineNum">   12724 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;fullname, len);</span>
<span class="lineNum">   12725 </span><span class="lineCov">          6 :                 } else if (!strncasecmp(arg.attribute, &quot;email&quot;, 5)) {</span>
<span class="lineNum">   12726 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;email, len);</span>
<span class="lineNum">   12727 </span><span class="lineCov">          5 :                 } else if (!strncasecmp(arg.attribute, &quot;pager&quot;, 5)) {</span>
<span class="lineNum">   12728 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;pager, len);</span>
<span class="lineNum">   12729 </span><span class="lineCov">          4 :                 } else if (!strncasecmp(arg.attribute, &quot;language&quot;, 8)) {</span>
<span class="lineNum">   12730 </span><span class="lineCov">          1 :                         ast_copy_string(buf, S_OR(vmu-&gt;language, ast_channel_language(chan)), len);</span>
<span class="lineNum">   12731 </span><span class="lineCov">          3 :                 } else if (!strncasecmp(arg.attribute, &quot;locale&quot;, 6)) {</span>
<span class="lineNum">   12732 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;locale, len);</span>
<span class="lineNum">   12733 </span><span class="lineCov">          2 :                 } else if (!strncasecmp(arg.attribute, &quot;tz&quot;, 2)) {</span>
<span class="lineNum">   12734 </span><span class="lineCov">          1 :                         ast_copy_string(buf, vmu-&gt;zonetag, len);</span>
<span class="lineNum">   12735 </span><span class="lineCov">          1 :                 } else if (!strncasecmp(arg.attribute, &quot;count&quot;, 5)) {</span>
<span class="lineNum">   12736 </span>            :                         char *mailbox_id;
<span class="lineNum">   12737 </span>            : 
<span class="lineNum">   12738 </span><span class="lineNoCov">          0 :                         mailbox_id = ast_alloca(strlen(mailbox) + strlen(context) + 2);</span>
<span class="lineNum">   12739 </span><span class="lineNoCov">          0 :                         sprintf(mailbox_id, &quot;%s@%s&quot;, mailbox, context);/* Safe */</span>
<span class="lineNum">   12740 </span>            : 
<span class="lineNum">   12741 </span>            :                         /* If mbxfolder is empty messagecount will default to INBOX */
<span class="lineNum">   12742 </span><span class="lineNoCov">          0 :                         res = messagecount(mailbox_id, arg.folder);</span>
<span class="lineNum">   12743 </span><span class="lineNoCov">          0 :                         if (res &lt; 0) {</span>
<span class="lineNum">   12744 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR, &quot;Unable to retrieve message count for mailbox %s\n&quot;, arg.mailbox_context);</span>
<span class="lineNum">   12745 </span><span class="lineNoCov">          0 :                                 free_user(vmu);</span>
<span class="lineNum">   12746 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">   12747 </span>            :                         }
<span class="lineNum">   12748 </span><span class="lineNoCov">          0 :                         snprintf(buf, len, &quot;%d&quot;, res);</span>
<span class="lineNum">   12749 </span>            :                 } else {
<span class="lineNum">   12750 </span><span class="lineCov">          1 :                         ast_log(LOG_ERROR, &quot;Unknown attribute '%s' for VM_INFO\n&quot;, arg.attribute);</span>
<span class="lineNum">   12751 </span><span class="lineCov">          1 :                         free_user(vmu);</span>
<span class="lineNum">   12752 </span><span class="lineCov">          1 :                         return -1;</span>
<span class="lineNum">   12753 </span>            :                 }
<span class="lineNum">   12754 </span><span class="lineCov">          7 :                 free_user(vmu);</span>
<span class="lineNum">   12755 </span>            :         }
<span class="lineNum">   12756 </span>            : 
<span class="lineNum">   12757 </span><span class="lineCov">          8 :         return 0;</span>
<span class="lineNum">   12758 </span>            : }
<span class="lineNum">   12759 </span>            : 
<span class="lineNum">   12760 </span>            : static struct ast_custom_function mailbox_exists_acf = {
<span class="lineNum">   12761 </span>            :         .name = &quot;MAILBOX_EXISTS&quot;,
<span class="lineNum">   12762 </span>            :         .read = acf_mailbox_exists,
<span class="lineNum">   12763 </span>            : };
<span class="lineNum">   12764 </span>            : 
<span class="lineNum">   12765 </span>            : static struct ast_custom_function vm_info_acf = {
<span class="lineNum">   12766 </span>            :         .name = &quot;VM_INFO&quot;,
<span class="lineNum">   12767 </span>            :         .read = acf_vm_info,
<a name="12768"><span class="lineNum">   12768 </span>            : };</a>
<span class="lineNum">   12769 </span>            : 
<span class="lineNum">   12770 </span><span class="lineCov">          8 : static int vmauthenticate(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   12771 </span>            : {
<span class="lineNum">   12772 </span><span class="lineCov">          8 :         char *s, *user = NULL, *context = NULL, mailbox[AST_MAX_EXTENSION] = &quot;&quot;;</span>
<span class="lineNum">   12773 </span><span class="lineCov">          8 :         struct ast_vm_user vmus = {{0}};</span>
<span class="lineNum">   12774 </span><span class="lineCov">          8 :         char *options = NULL;</span>
<span class="lineNum">   12775 </span><span class="lineCov">          8 :         int silent = 0, skipuser = 0;</span>
<span class="lineNum">   12776 </span><span class="lineCov">          8 :         int res = -1;</span>
<span class="lineNum">   12777 </span>            : 
<span class="lineNum">   12778 </span><span class="lineCov">          8 :         if (data) {</span>
<span class="lineNum">   12779 </span><span class="lineCov">          8 :                 s = ast_strdupa(data);</span>
<span class="lineNum">   12780 </span><span class="lineCov">          8 :                 user = strsep(&amp;s, &quot;,&quot;);</span>
<span class="lineNum">   12781 </span><span class="lineCov">          8 :                 options = strsep(&amp;s, &quot;,&quot;);</span>
<span class="lineNum">   12782 </span><span class="lineCov">          8 :                 if (user) {</span>
<span class="lineNum">   12783 </span><span class="lineCov">          8 :                         s = user;</span>
<span class="lineNum">   12784 </span><span class="lineCov">          8 :                         user = strsep(&amp;s, &quot;@&quot;);</span>
<span class="lineNum">   12785 </span><span class="lineCov">          8 :                         context = strsep(&amp;s, &quot;&quot;);</span>
<span class="lineNum">   12786 </span><span class="lineCov">          8 :                         if (!ast_strlen_zero(user))</span>
<span class="lineNum">   12787 </span><span class="lineCov">          3 :                                 skipuser++;</span>
<span class="lineNum">   12788 </span><span class="lineCov">          8 :                         ast_copy_string(mailbox, user, sizeof(mailbox));</span>
<span class="lineNum">   12789 </span>            :                 }
<span class="lineNum">   12790 </span>            :         }
<span class="lineNum">   12791 </span>            : 
<span class="lineNum">   12792 </span><span class="lineCov">          8 :         if (options) {</span>
<span class="lineNum">   12793 </span><span class="lineNoCov">          0 :                 silent = (strchr(options, 's')) != NULL;</span>
<span class="lineNum">   12794 </span>            :         }
<span class="lineNum">   12795 </span>            : 
<span class="lineNum">   12796 </span><span class="lineCov">          8 :         if (!vm_authenticate(chan, mailbox, sizeof(mailbox), &amp;vmus, context, NULL, skipuser, 3, silent)) {</span>
<span class="lineNum">   12797 </span><span class="lineCov">          3 :                 pbx_builtin_setvar_helper(chan, &quot;AUTH_MAILBOX&quot;, mailbox);</span>
<span class="lineNum">   12798 </span><span class="lineCov">          3 :                 pbx_builtin_setvar_helper(chan, &quot;AUTH_CONTEXT&quot;, vmus.context);</span>
<span class="lineNum">   12799 </span><span class="lineCov">          3 :                 ast_play_and_wait(chan, &quot;auth-thankyou&quot;);</span>
<span class="lineNum">   12800 </span><span class="lineCov">          3 :                 res = 0;</span>
<span class="lineNum">   12801 </span><span class="lineCov">          5 :         } else if (mailbox[0] == '*') {</span>
<span class="lineNum">   12802 </span>            :                 /* user entered '*' */
<span class="lineNum">   12803 </span><span class="lineCov">          2 :                 if (!ast_goto_if_exists(chan, ast_channel_context(chan), &quot;a&quot;, 1)) {</span>
<span class="lineNum">   12804 </span><span class="lineCov">          2 :                         res = 0;        /* prevent hangup */</span>
<span class="lineNum">   12805 </span>            :                 }
<span class="lineNum">   12806 </span>            :         }
<span class="lineNum">   12807 </span>            : 
<span class="lineNum">   12808 </span><span class="lineCov">          8 :         return res;</span>
<a name="12809"><span class="lineNum">   12809 </span>            : }</a>
<span class="lineNum">   12810 </span>            : 
<span class="lineNum">   12811 </span><span class="lineNoCov">          0 : static char *show_users_realtime(int fd, const char *context)</span>
<span class="lineNum">   12812 </span>            : {
<span class="lineNum">   12813 </span>            :         struct ast_config *cfg;
<span class="lineNum">   12814 </span><span class="lineNoCov">          0 :         const char *cat = NULL;</span>
<span class="lineNum">   12815 </span>            : 
<span class="lineNum">   12816 </span><span class="lineNoCov">          0 :         if (!(cfg = ast_load_realtime_multientry(&quot;voicemail&quot;,</span>
<span class="lineNum">   12817 </span>            :                 &quot;context&quot;, context, SENTINEL))) {
<span class="lineNum">   12818 </span><span class="lineNoCov">          0 :                 return CLI_FAILURE;</span>
<span class="lineNum">   12819 </span>            :         }
<span class="lineNum">   12820 </span>            : 
<span class="lineNum">   12821 </span><span class="lineNoCov">          0 :         ast_cli(fd,</span>
<span class="lineNum">   12822 </span>            :                 &quot;\n&quot;
<span class="lineNum">   12823 </span>            :                 &quot;=============================================================\n&quot;
<span class="lineNum">   12824 </span>            :                 &quot;=== Configured Voicemail Users ==============================\n&quot;
<span class="lineNum">   12825 </span>            :                 &quot;=============================================================\n&quot;
<span class="lineNum">   12826 </span>            :                 &quot;===\n&quot;);
<span class="lineNum">   12827 </span>            : 
<span class="lineNum">   12828 </span><span class="lineNoCov">          0 :         while ((cat = ast_category_browse(cfg, cat))) {</span>
<span class="lineNum">   12829 </span><span class="lineNoCov">          0 :                 struct ast_variable *var = NULL;</span>
<span class="lineNum">   12830 </span><span class="lineNoCov">          0 :                 ast_cli(fd,</span>
<span class="lineNum">   12831 </span>            :                         &quot;=== Mailbox ...\n&quot;
<span class="lineNum">   12832 </span>            :                         &quot;===\n&quot;);
<span class="lineNum">   12833 </span><span class="lineNoCov">          0 :                 for (var = ast_variable_browse(cfg, cat); var; var = var-&gt;next)</span>
<span class="lineNum">   12834 </span><span class="lineNoCov">          0 :                         ast_cli(fd, &quot;=== ==&gt; %s: %s\n&quot;, var-&gt;name, var-&gt;value);</span>
<span class="lineNum">   12835 </span><span class="lineNoCov">          0 :                 ast_cli(fd,</span>
<span class="lineNum">   12836 </span>            :                         &quot;===\n&quot;
<span class="lineNum">   12837 </span>            :                         &quot;=== ---------------------------------------------------------\n&quot;
<span class="lineNum">   12838 </span>            :                         &quot;===\n&quot;);
<span class="lineNum">   12839 </span>            :         }
<span class="lineNum">   12840 </span>            : 
<span class="lineNum">   12841 </span><span class="lineNoCov">          0 :         ast_cli(fd,</span>
<span class="lineNum">   12842 </span>            :                 &quot;=============================================================\n&quot;
<span class="lineNum">   12843 </span>            :                 &quot;\n&quot;);
<span class="lineNum">   12844 </span>            : 
<span class="lineNum">   12845 </span><span class="lineNoCov">          0 :         ast_config_destroy(cfg);</span>
<span class="lineNum">   12846 </span>            : 
<span class="lineNum">   12847 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<a name="12848"><span class="lineNum">   12848 </span>            : }</a>
<span class="lineNum">   12849 </span>            : 
<span class="lineNum">   12850 </span><span class="lineNoCov">          0 : static char *complete_voicemail_show_users(const char *line, const char *word, int pos, int state)</span>
<span class="lineNum">   12851 </span>            : {
<span class="lineNum">   12852 </span><span class="lineNoCov">          0 :         int which = 0;</span>
<span class="lineNum">   12853 </span>            :         int wordlen;
<span class="lineNum">   12854 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   12855 </span><span class="lineNoCov">          0 :         const char *context = &quot;&quot;;</span>
<span class="lineNum">   12856 </span>            : 
<span class="lineNum">   12857 </span>            :         /* 0 - voicemail; 1 - show; 2 - users; 3 - for; 4 - &lt;context&gt; */
<span class="lineNum">   12858 </span><span class="lineNoCov">          0 :         if (pos &gt; 4)</span>
<span class="lineNum">   12859 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   12860 </span><span class="lineNoCov">          0 :         wordlen = strlen(word);</span>
<span class="lineNum">   12861 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   12862 </span><span class="lineNoCov">          0 :                 if (!strncasecmp(word, vmu-&gt;context, wordlen)) {</span>
<span class="lineNum">   12863 </span><span class="lineNoCov">          0 :                         if (context &amp;&amp; strcmp(context, vmu-&gt;context) &amp;&amp; ++which &gt; state)</span>
<span class="lineNum">   12864 </span><span class="lineNoCov">          0 :                                 return ast_strdup(vmu-&gt;context);</span>
<span class="lineNum">   12865 </span>            :                         /* ignore repeated contexts ? */
<span class="lineNum">   12866 </span><span class="lineNoCov">          0 :                         context = vmu-&gt;context;</span>
<span class="lineNum">   12867 </span>            :                 }
<span class="lineNum">   12868 </span>            :         }
<span class="lineNum">   12869 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">   12870 </span>            : }
<a name="12871"><span class="lineNum">   12871 </span>            : </a>
<span class="lineNum">   12872 </span>            : /*! \brief Show a list of voicemail users in the CLI */
<span class="lineNum">   12873 </span><span class="lineCov">         62 : static char *handle_voicemail_show_users(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">   12874 </span>            : {
<span class="lineNum">   12875 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   12876 </span>            : #define HVSU_OUTPUT_FORMAT &quot;%-10s %-5s %-25s %-10s %6s\n&quot;
<span class="lineNum">   12877 </span><span class="lineCov">         62 :         const char *context = NULL;</span>
<span class="lineNum">   12878 </span><span class="lineCov">         62 :         int users_counter = 0;</span>
<span class="lineNum">   12879 </span>            : 
<span class="lineNum">   12880 </span><span class="lineCov">         62 :         switch (cmd) {</span>
<span class="lineNum">   12881 </span><span class="lineCov">         62 :         case CLI_INIT:</span>
<span class="lineNum">   12882 </span><span class="lineCov">         62 :                 e-&gt;command = &quot;voicemail show users [for]&quot;;</span>
<span class="lineNum">   12883 </span><span class="lineCov">         62 :                 e-&gt;usage =</span>
<span class="lineNum">   12884 </span>            :                         &quot;Usage: voicemail show users [for &lt;context&gt;]\n&quot;
<span class="lineNum">   12885 </span>            :                         &quot;       Lists all mailboxes currently set up\n&quot;;
<span class="lineNum">   12886 </span><span class="lineCov">         62 :                 return NULL;</span>
<span class="lineNum">   12887 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">   12888 </span><span class="lineNoCov">          0 :                 return complete_voicemail_show_users(a-&gt;line, a-&gt;word, a-&gt;pos, a-&gt;n);</span>
<span class="lineNum">   12889 </span>            :         }
<span class="lineNum">   12890 </span>            : 
<span class="lineNum">   12891 </span><span class="lineNoCov">          0 :         if ((a-&gt;argc &lt; 3) || (a-&gt;argc &gt; 5) || (a-&gt;argc == 4))</span>
<span class="lineNum">   12892 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">   12893 </span><span class="lineNoCov">          0 :         if (a-&gt;argc == 5) {</span>
<span class="lineNum">   12894 </span><span class="lineNoCov">          0 :                 if (strcmp(a-&gt;argv[3],&quot;for&quot;))</span>
<span class="lineNum">   12895 </span><span class="lineNoCov">          0 :                         return CLI_SHOWUSAGE;</span>
<span class="lineNum">   12896 </span><span class="lineNoCov">          0 :                 context = a-&gt;argv[4];</span>
<span class="lineNum">   12897 </span>            :         }
<span class="lineNum">   12898 </span>            : 
<span class="lineNum">   12899 </span><span class="lineNoCov">          0 :         if (ast_check_realtime(&quot;voicemail&quot;)) {</span>
<span class="lineNum">   12900 </span><span class="lineNoCov">          0 :                 if (!context) {</span>
<span class="lineNum">   12901 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;You must specify a specific context to show users from realtime!\n&quot;);</span>
<span class="lineNum">   12902 </span><span class="lineNoCov">          0 :                         return CLI_SHOWUSAGE;</span>
<span class="lineNum">   12903 </span>            :                 }
<span class="lineNum">   12904 </span><span class="lineNoCov">          0 :                 return show_users_realtime(a-&gt;fd, context);</span>
<span class="lineNum">   12905 </span>            :         }
<span class="lineNum">   12906 </span>            : 
<span class="lineNum">   12907 </span><span class="lineNoCov">          0 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   12908 </span><span class="lineNoCov">          0 :         if (AST_LIST_EMPTY(&amp;users)) {</span>
<span class="lineNum">   12909 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;There are no voicemail users currently defined\n&quot;);</span>
<span class="lineNum">   12910 </span><span class="lineNoCov">          0 :                 AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   12911 </span><span class="lineNoCov">          0 :                 return CLI_FAILURE;</span>
<span class="lineNum">   12912 </span>            :         }
<span class="lineNum">   12913 </span><span class="lineNoCov">          0 :         if (!context) {</span>
<span class="lineNum">   12914 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, HVSU_OUTPUT_FORMAT, &quot;Context&quot;, &quot;Mbox&quot;, &quot;User&quot;, &quot;Zone&quot;, &quot;NewMsg&quot;);</span>
<span class="lineNum">   12915 </span>            :         } else {
<span class="lineNum">   12916 </span><span class="lineNoCov">          0 :                 int count = 0;</span>
<span class="lineNum">   12917 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   12918 </span><span class="lineNoCov">          0 :                         if (!strcmp(context, vmu-&gt;context)) {</span>
<span class="lineNum">   12919 </span><span class="lineNoCov">          0 :                                 count++;</span>
<span class="lineNum">   12920 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   12921 </span>            :                         }
<span class="lineNum">   12922 </span>            :                 }
<span class="lineNum">   12923 </span><span class="lineNoCov">          0 :                 if (count) {</span>
<span class="lineNum">   12924 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, HVSU_OUTPUT_FORMAT, &quot;Context&quot;, &quot;Mbox&quot;, &quot;User&quot;, &quot;Zone&quot;, &quot;NewMsg&quot;);</span>
<span class="lineNum">   12925 </span>            :                 } else {
<span class="lineNum">   12926 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, &quot;No such voicemail context \&quot;%s\&quot;\n&quot;, context);</span>
<span class="lineNum">   12927 </span><span class="lineNoCov">          0 :                         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   12928 </span><span class="lineNoCov">          0 :                         return CLI_FAILURE;</span>
<span class="lineNum">   12929 </span>            :                 }
<span class="lineNum">   12930 </span>            :         }
<span class="lineNum">   12931 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   12932 </span><span class="lineNoCov">          0 :                 int newmsgs = 0, oldmsgs = 0;</span>
<span class="lineNum">   12933 </span><span class="lineNoCov">          0 :                 char count[12], tmp[256] = &quot;&quot;;</span>
<span class="lineNum">   12934 </span>            : 
<span class="lineNum">   12935 </span><span class="lineNoCov">          0 :                 if (!context || !strcmp(context, vmu-&gt;context)) {</span>
<span class="lineNum">   12936 </span><span class="lineNoCov">          0 :                         snprintf(tmp, sizeof(tmp), &quot;%s@%s&quot;, vmu-&gt;mailbox, ast_strlen_zero(vmu-&gt;context) ? &quot;default&quot; : vmu-&gt;context);</span>
<span class="lineNum">   12937 </span><span class="lineNoCov">          0 :                         inboxcount(tmp, &amp;newmsgs, &amp;oldmsgs);</span>
<span class="lineNum">   12938 </span><span class="lineNoCov">          0 :                         snprintf(count, sizeof(count), &quot;%d&quot;, newmsgs);</span>
<span class="lineNum">   12939 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, HVSU_OUTPUT_FORMAT, vmu-&gt;context, vmu-&gt;mailbox, vmu-&gt;fullname, vmu-&gt;zonetag, count);</span>
<span class="lineNum">   12940 </span><span class="lineNoCov">          0 :                         users_counter++;</span>
<span class="lineNum">   12941 </span>            :                 }
<span class="lineNum">   12942 </span>            :         }
<span class="lineNum">   12943 </span><span class="lineNoCov">          0 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   12944 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;%d voicemail users configured.\n&quot;, users_counter);</span>
<span class="lineNum">   12945 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<span class="lineNum">   12946 </span>            : }
<a name="12947"><span class="lineNum">   12947 </span>            : </a>
<span class="lineNum">   12948 </span>            : /*! \brief Show a list of voicemail zones in the CLI */
<span class="lineNum">   12949 </span><span class="lineCov">         62 : static char *handle_voicemail_show_zones(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">   12950 </span>            : {
<span class="lineNum">   12951 </span>            :         struct vm_zone *zone;
<span class="lineNum">   12952 </span>            : #define HVSZ_OUTPUT_FORMAT &quot;%-15s %-20s %-45s\n&quot;
<span class="lineNum">   12953 </span><span class="lineCov">         62 :         char *res = CLI_SUCCESS;</span>
<span class="lineNum">   12954 </span>            : 
<span class="lineNum">   12955 </span><span class="lineCov">         62 :         switch (cmd) {</span>
<span class="lineNum">   12956 </span><span class="lineCov">         62 :         case CLI_INIT:</span>
<span class="lineNum">   12957 </span><span class="lineCov">         62 :                 e-&gt;command = &quot;voicemail show zones&quot;;</span>
<span class="lineNum">   12958 </span><span class="lineCov">         62 :                 e-&gt;usage =</span>
<span class="lineNum">   12959 </span>            :                         &quot;Usage: voicemail show zones\n&quot;
<span class="lineNum">   12960 </span>            :                         &quot;       Lists zone message formats\n&quot;;
<span class="lineNum">   12961 </span><span class="lineCov">         62 :                 return NULL;</span>
<span class="lineNum">   12962 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">   12963 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   12964 </span>            :         }
<span class="lineNum">   12965 </span>            : 
<span class="lineNum">   12966 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 3)</span>
<span class="lineNum">   12967 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">   12968 </span>            : 
<span class="lineNum">   12969 </span><span class="lineNoCov">          0 :         AST_LIST_LOCK(&amp;zones);</span>
<span class="lineNum">   12970 </span><span class="lineNoCov">          0 :         if (!AST_LIST_EMPTY(&amp;zones)) {</span>
<span class="lineNum">   12971 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, HVSZ_OUTPUT_FORMAT, &quot;Zone&quot;, &quot;Timezone&quot;, &quot;Message Format&quot;);</span>
<span class="lineNum">   12972 </span><span class="lineNoCov">          0 :                 AST_LIST_TRAVERSE(&amp;zones, zone, list) {</span>
<span class="lineNum">   12973 </span><span class="lineNoCov">          0 :                         ast_cli(a-&gt;fd, HVSZ_OUTPUT_FORMAT, zone-&gt;name, zone-&gt;timezone, zone-&gt;msg_format);</span>
<span class="lineNum">   12974 </span>            :                 }
<span class="lineNum">   12975 </span>            :         } else {
<span class="lineNum">   12976 </span><span class="lineNoCov">          0 :                 ast_cli(a-&gt;fd, &quot;There are no voicemail zones currently defined\n&quot;);</span>
<span class="lineNum">   12977 </span><span class="lineNoCov">          0 :                 res = CLI_FAILURE;</span>
<span class="lineNum">   12978 </span>            :         }
<span class="lineNum">   12979 </span><span class="lineNoCov">          0 :         AST_LIST_UNLOCK(&amp;zones);</span>
<span class="lineNum">   12980 </span>            : 
<span class="lineNum">   12981 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">   12982 </span>            : }
<a name="12983"><span class="lineNum">   12983 </span>            : </a>
<span class="lineNum">   12984 </span>            : /*! \brief Reload voicemail configuration from the CLI */
<span class="lineNum">   12985 </span><span class="lineCov">         62 : static char *handle_voicemail_reload(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)</span>
<span class="lineNum">   12986 </span>            : {
<span class="lineNum">   12987 </span><span class="lineCov">         62 :         switch (cmd) {</span>
<span class="lineNum">   12988 </span><span class="lineCov">         62 :         case CLI_INIT:</span>
<span class="lineNum">   12989 </span><span class="lineCov">         62 :                 e-&gt;command = &quot;voicemail reload&quot;;</span>
<span class="lineNum">   12990 </span><span class="lineCov">         62 :                 e-&gt;usage =</span>
<span class="lineNum">   12991 </span>            :                         &quot;Usage: voicemail reload\n&quot;
<span class="lineNum">   12992 </span>            :                         &quot;       Reload voicemail configuration\n&quot;;
<span class="lineNum">   12993 </span><span class="lineCov">         62 :                 return NULL;</span>
<span class="lineNum">   12994 </span><span class="lineNoCov">          0 :         case CLI_GENERATE:</span>
<span class="lineNum">   12995 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   12996 </span>            :         }
<span class="lineNum">   12997 </span>            : 
<span class="lineNum">   12998 </span><span class="lineNoCov">          0 :         if (a-&gt;argc != 2)</span>
<span class="lineNum">   12999 </span><span class="lineNoCov">          0 :                 return CLI_SHOWUSAGE;</span>
<span class="lineNum">   13000 </span>            : 
<span class="lineNum">   13001 </span><span class="lineNoCov">          0 :         ast_cli(a-&gt;fd, &quot;Reloading voicemail configuration...\n&quot;);</span>
<span class="lineNum">   13002 </span><span class="lineNoCov">          0 :         load_config(1);</span>
<span class="lineNum">   13003 </span>            : 
<span class="lineNum">   13004 </span><span class="lineNoCov">          0 :         return CLI_SUCCESS;</span>
<span class="lineNum">   13005 </span>            : }
<span class="lineNum">   13006 </span>            : 
<span class="lineNum">   13007 </span>            : static struct ast_cli_entry cli_voicemail[] = {
<span class="lineNum">   13008 </span>            :         AST_CLI_DEFINE(handle_voicemail_show_users, &quot;List defined voicemail boxes&quot;),
<span class="lineNum">   13009 </span>            :         AST_CLI_DEFINE(handle_voicemail_show_zones, &quot;List zone message formats&quot;),
<span class="lineNum">   13010 </span>            :         AST_CLI_DEFINE(handle_voicemail_reload, &quot;Reload voicemail configuration&quot;),
<a name="13011"><span class="lineNum">   13011 </span>            : };</a>
<span class="lineNum">   13012 </span>            : 
<span class="lineNum">   13013 </span><span class="lineNoCov">          0 : static void poll_subscribed_mailbox(struct mwi_sub *mwi_sub)</span>
<span class="lineNum">   13014 </span>            : {
<span class="lineNum">   13015 </span><span class="lineNoCov">          0 :         int new = 0, old = 0, urgent = 0;</span>
<span class="lineNum">   13016 </span>            : 
<span class="lineNum">   13017 </span><span class="lineNoCov">          0 :         inboxcount2(mwi_sub-&gt;mailbox, &amp;urgent, &amp;new, &amp;old);</span>
<span class="lineNum">   13018 </span>            : 
<span class="lineNum">   13019 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13020 </span>            :         if (imap_poll_logout) {
<span class="lineNum">   13021 </span>            :                 imap_logout(mwi_sub-&gt;mailbox);
<span class="lineNum">   13022 </span>            :         }
<span class="lineNum">   13023 </span>            : #endif
<span class="lineNum">   13024 </span>            : 
<span class="lineNum">   13025 </span><span class="lineNoCov">          0 :         if (urgent != mwi_sub-&gt;old_urgent || new != mwi_sub-&gt;old_new || old != mwi_sub-&gt;old_old) {</span>
<span class="lineNum">   13026 </span><span class="lineNoCov">          0 :                 mwi_sub-&gt;old_urgent = urgent;</span>
<span class="lineNum">   13027 </span><span class="lineNoCov">          0 :                 mwi_sub-&gt;old_new = new;</span>
<span class="lineNum">   13028 </span><span class="lineNoCov">          0 :                 mwi_sub-&gt;old_old = old;</span>
<span class="lineNum">   13029 </span><span class="lineNoCov">          0 :                 queue_mwi_event(NULL, mwi_sub-&gt;mailbox, urgent, new, old);</span>
<span class="lineNum">   13030 </span><span class="lineNoCov">          0 :                 run_externnotify(NULL, mwi_sub-&gt;mailbox, NULL);</span>
<span class="lineNum">   13031 </span>            :         }
<a name="13032"><span class="lineNum">   13032 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">   13033 </span>            : 
<span class="lineNum">   13034 </span><span class="lineNoCov">          0 : static void poll_subscribed_mailboxes(void)</span>
<span class="lineNum">   13035 </span>            : {
<span class="lineNum">   13036 </span>            :         struct mwi_sub *mwi_sub;
<span class="lineNum">   13037 </span>            : 
<span class="lineNum">   13038 </span><span class="lineNoCov">          0 :         AST_RWLIST_RDLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13039 </span><span class="lineNoCov">          0 :         AST_RWLIST_TRAVERSE(&amp;mwi_subs, mwi_sub, entry) {</span>
<span class="lineNum">   13040 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(mwi_sub-&gt;mailbox)) {</span>
<span class="lineNum">   13041 </span><span class="lineNoCov">          0 :                         poll_subscribed_mailbox(mwi_sub);</span>
<span class="lineNum">   13042 </span>            :                 }
<span class="lineNum">   13043 </span>            :         }
<span class="lineNum">   13044 </span><span class="lineNoCov">          0 :         AST_RWLIST_UNLOCK(&amp;mwi_subs);</span>
<a name="13045"><span class="lineNum">   13045 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">   13046 </span>            : 
<span class="lineNum">   13047 </span><span class="lineNoCov">          0 : static void *mb_poll_thread(void *data)</span>
<span class="lineNum">   13048 </span>            : {
<span class="lineNum">   13049 </span><span class="lineNoCov">          0 :         while (poll_thread_run) {</span>
<span class="lineNum">   13050 </span><span class="lineNoCov">          0 :                 struct timespec ts = { 0, };</span>
<span class="lineNum">   13051 </span>            :                 struct timeval wait;
<span class="lineNum">   13052 </span>            : 
<span class="lineNum">   13053 </span><span class="lineNoCov">          0 :                 wait = ast_tvadd(ast_tvnow(), ast_samp2tv(poll_freq, 1));</span>
<span class="lineNum">   13054 </span><span class="lineNoCov">          0 :                 ts.tv_sec = wait.tv_sec;</span>
<span class="lineNum">   13055 </span><span class="lineNoCov">          0 :                 ts.tv_nsec = wait.tv_usec * 1000;</span>
<span class="lineNum">   13056 </span>            : 
<span class="lineNum">   13057 </span><span class="lineNoCov">          0 :                 ast_mutex_lock(&amp;poll_lock);</span>
<span class="lineNum">   13058 </span><span class="lineNoCov">          0 :                 ast_cond_timedwait(&amp;poll_cond, &amp;poll_lock, &amp;ts);</span>
<span class="lineNum">   13059 </span><span class="lineNoCov">          0 :                 ast_mutex_unlock(&amp;poll_lock);</span>
<span class="lineNum">   13060 </span>            : 
<span class="lineNum">   13061 </span><span class="lineNoCov">          0 :                 if (!poll_thread_run)</span>
<span class="lineNum">   13062 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   13063 </span>            : 
<span class="lineNum">   13064 </span><span class="lineNoCov">          0 :                 poll_subscribed_mailboxes();</span>
<span class="lineNum">   13065 </span>            :         }
<span class="lineNum">   13066 </span>            : 
<span class="lineNum">   13067 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="13068"><span class="lineNum">   13068 </span>            : }</a>
<span class="lineNum">   13069 </span>            : 
<span class="lineNum">   13070 </span><span class="lineNoCov">          0 : static void mwi_sub_destroy(struct mwi_sub *mwi_sub)</span>
<span class="lineNum">   13071 </span>            : {
<span class="lineNum">   13072 </span><span class="lineNoCov">          0 :         ast_free(mwi_sub-&gt;uniqueid);</span>
<span class="lineNum">   13073 </span><span class="lineNoCov">          0 :         ast_free(mwi_sub);</span>
<span class="lineNum">   13074 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">   13075 </span>            : 
<span class="lineNum">   13076 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13077 </span>            : static void imap_logout(const char *mailbox_id)
<span class="lineNum">   13078 </span>            : {
<span class="lineNum">   13079 </span>            :         char *context;
<span class="lineNum">   13080 </span>            :         char *mailbox;
<span class="lineNum">   13081 </span>            :         struct ast_vm_user vmus;
<span class="lineNum">   13082 </span>            :         RAII_VAR(struct ast_vm_user *, vmu, NULL, free_user);
<span class="lineNum">   13083 </span>            :         struct vm_state *vms = NULL;
<span class="lineNum">   13084 </span>            : 
<span class="lineNum">   13085 </span>            :         if (ast_strlen_zero(mailbox_id)
<span class="lineNum">   13086 </span>            :                 || separate_mailbox(ast_strdupa(mailbox_id), &amp;mailbox, &amp;context)) {
<span class="lineNum">   13087 </span>            :                 return;
<span class="lineNum">   13088 </span>            :         }
<span class="lineNum">   13089 </span>            : 
<span class="lineNum">   13090 </span>            :         memset(&amp;vmus, 0, sizeof(vmus));
<span class="lineNum">   13091 </span>            : 
<span class="lineNum">   13092 </span>            :         if (!(vmu = find_user(&amp;vmus, context, mailbox)) || vmu-&gt;imapuser[0] == '\0') {
<span class="lineNum">   13093 </span>            :                 return;
<span class="lineNum">   13094 </span>            :         }
<span class="lineNum">   13095 </span>            : 
<span class="lineNum">   13096 </span>            :         vms = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0);
<span class="lineNum">   13097 </span>            :         if (!vms) {
<span class="lineNum">   13098 </span>            :                 vms = get_vm_state_by_mailbox(mailbox, context, 0);
<span class="lineNum">   13099 </span>            :         }
<span class="lineNum">   13100 </span>            :         if (!vms) {
<span class="lineNum">   13101 </span>            :                 return;
<span class="lineNum">   13102 </span>            :         }
<span class="lineNum">   13103 </span>            : 
<span class="lineNum">   13104 </span>            :         ast_mutex_lock(&amp;vms-&gt;lock);
<span class="lineNum">   13105 </span>            :         vms-&gt;mailstream = mail_close(vms-&gt;mailstream);
<span class="lineNum">   13106 </span>            :         ast_mutex_unlock(&amp;vms-&gt;lock);
<span class="lineNum">   13107 </span>            : 
<span class="lineNum">   13108 </span>            :         vmstate_delete(vms);
<span class="lineNum">   13109 </span>            : }
<span class="lineNum">   13110 </span>            : 
<span class="lineNum">   13111 </span>            : static void imap_close_subscribed_mailboxes(void)
<span class="lineNum">   13112 </span>            : {
<span class="lineNum">   13113 </span>            :         struct mwi_sub *mwi_sub;
<span class="lineNum">   13114 </span>            : 
<span class="lineNum">   13115 </span>            :         AST_RWLIST_RDLOCK(&amp;mwi_subs);
<span class="lineNum">   13116 </span>            :         AST_RWLIST_TRAVERSE(&amp;mwi_subs, mwi_sub, entry) {
<span class="lineNum">   13117 </span>            :                 if (!ast_strlen_zero(mwi_sub-&gt;mailbox)) {
<span class="lineNum">   13118 </span>            :                         imap_logout(mwi_sub-&gt;mailbox);
<span class="lineNum">   13119 </span>            :                 }
<span class="lineNum">   13120 </span>            :         }
<span class="lineNum">   13121 </span>            :         AST_RWLIST_UNLOCK(&amp;mwi_subs);
<span class="lineNum">   13122 </span>            : }
<a name="13123"><span class="lineNum">   13123 </span>            : #endif</a>
<span class="lineNum">   13124 </span>            : 
<span class="lineNum">   13125 </span><span class="lineNoCov">          0 : static int handle_unsubscribe(void *datap)</span>
<span class="lineNum">   13126 </span>            : {
<span class="lineNum">   13127 </span>            :         struct mwi_sub *mwi_sub;
<span class="lineNum">   13128 </span><span class="lineNoCov">          0 :         char *uniqueid = datap;</span>
<span class="lineNum">   13129 </span>            : 
<span class="lineNum">   13130 </span><span class="lineNoCov">          0 :         AST_RWLIST_WRLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13131 </span><span class="lineNoCov">          0 :         AST_RWLIST_TRAVERSE_SAFE_BEGIN(&amp;mwi_subs, mwi_sub, entry) {</span>
<span class="lineNum">   13132 </span><span class="lineNoCov">          0 :                 if (!strcmp(mwi_sub-&gt;uniqueid, uniqueid)) {</span>
<span class="lineNum">   13133 </span><span class="lineNoCov">          0 :                         AST_LIST_REMOVE_CURRENT(entry);</span>
<span class="lineNum">   13134 </span>            :                         /* Don't break here since a duplicate uniqueid
<span class="lineNum">   13135 </span>            :                          * may have been added as a result of a cache dump. */
<span class="lineNum">   13136 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13137 </span>            :                         imap_logout(mwi_sub-&gt;mailbox);
<span class="lineNum">   13138 </span>            : #endif
<span class="lineNum">   13139 </span><span class="lineNoCov">          0 :                         mwi_sub_destroy(mwi_sub);</span>
<span class="lineNum">   13140 </span>            :                 }
<span class="lineNum">   13141 </span>            :         }
<span class="lineNum">   13142 </span>            :         AST_RWLIST_TRAVERSE_SAFE_END
<span class="lineNum">   13143 </span><span class="lineNoCov">          0 :         AST_RWLIST_UNLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13144 </span>            : 
<span class="lineNum">   13145 </span><span class="lineNoCov">          0 :         ast_free(uniqueid);</span>
<span class="lineNum">   13146 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="13147"><span class="lineNum">   13147 </span>            : }</a>
<span class="lineNum">   13148 </span>            : 
<span class="lineNum">   13149 </span><span class="lineNoCov">          0 : static int handle_subscribe(void *datap)</span>
<span class="lineNum">   13150 </span>            : {
<span class="lineNum">   13151 </span>            :         unsigned int len;
<span class="lineNum">   13152 </span>            :         struct mwi_sub *mwi_sub;
<span class="lineNum">   13153 </span><span class="lineNoCov">          0 :         struct mwi_sub_task *p = datap;</span>
<span class="lineNum">   13154 </span>            : 
<span class="lineNum">   13155 </span><span class="lineNoCov">          0 :         len = sizeof(*mwi_sub) + 1;</span>
<span class="lineNum">   13156 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(p-&gt;mailbox))</span>
<span class="lineNum">   13157 </span><span class="lineNoCov">          0 :                 len += strlen(p-&gt;mailbox);</span>
<span class="lineNum">   13158 </span>            : 
<span class="lineNum">   13159 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(p-&gt;context))</span>
<span class="lineNum">   13160 </span><span class="lineNoCov">          0 :                 len += strlen(p-&gt;context) + 1; /* Allow for seperator */</span>
<span class="lineNum">   13161 </span>            : 
<span class="lineNum">   13162 </span><span class="lineNoCov">          0 :         if (!(mwi_sub = ast_calloc(1, len)))</span>
<span class="lineNum">   13163 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   13164 </span>            : 
<span class="lineNum">   13165 </span><span class="lineNoCov">          0 :         mwi_sub-&gt;uniqueid = ast_strdup(p-&gt;uniqueid);</span>
<span class="lineNum">   13166 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(p-&gt;mailbox))</span>
<span class="lineNum">   13167 </span><span class="lineNoCov">          0 :                 strcpy(mwi_sub-&gt;mailbox, p-&gt;mailbox);</span>
<span class="lineNum">   13168 </span>            : 
<span class="lineNum">   13169 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(p-&gt;context)) {</span>
<span class="lineNum">   13170 </span><span class="lineNoCov">          0 :                 strcat(mwi_sub-&gt;mailbox, &quot;@&quot;);</span>
<span class="lineNum">   13171 </span><span class="lineNoCov">          0 :                 strcat(mwi_sub-&gt;mailbox, p-&gt;context);</span>
<span class="lineNum">   13172 </span>            :         }
<span class="lineNum">   13173 </span>            : 
<span class="lineNum">   13174 </span><span class="lineNoCov">          0 :         AST_RWLIST_WRLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13175 </span><span class="lineNoCov">          0 :         AST_RWLIST_INSERT_TAIL(&amp;mwi_subs, mwi_sub, entry);</span>
<span class="lineNum">   13176 </span><span class="lineNoCov">          0 :         AST_RWLIST_UNLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13177 </span><span class="lineNoCov">          0 :         mwi_sub_task_dtor(p);</span>
<span class="lineNum">   13178 </span><span class="lineNoCov">          0 :         poll_subscribed_mailbox(mwi_sub);</span>
<span class="lineNum">   13179 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="13180"><span class="lineNum">   13180 </span>            : }</a>
<span class="lineNum">   13181 </span>            : 
<span class="lineNum">   13182 </span><span class="lineNoCov">          0 : static void mwi_unsub_event_cb(struct stasis_subscription_change *change)</span>
<span class="lineNum">   13183 </span>            : {
<span class="lineNum">   13184 </span><span class="lineNoCov">          0 :         char *uniqueid = ast_strdup(change-&gt;uniqueid);</span>
<span class="lineNum">   13185 </span>            : 
<span class="lineNum">   13186 </span><span class="lineNoCov">          0 :         if (!uniqueid) {</span>
<span class="lineNum">   13187 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Unable to allocate memory for uniqueid\n&quot;);</span>
<span class="lineNum">   13188 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">   13189 </span>            :         }
<span class="lineNum">   13190 </span>            : 
<span class="lineNum">   13191 </span><span class="lineNoCov">          0 :         if (ast_taskprocessor_push(mwi_subscription_tps, handle_unsubscribe, uniqueid) &lt; 0) {</span>
<span class="lineNum">   13192 </span><span class="lineNoCov">          0 :                 ast_free(uniqueid);</span>
<span class="lineNum">   13193 </span>            :         }
<a name="13194"><span class="lineNum">   13194 </span>            : }</a>
<span class="lineNum">   13195 </span>            : 
<span class="lineNum">   13196 </span><span class="lineNoCov">          0 : static void mwi_sub_event_cb(struct stasis_subscription_change *change)</span>
<span class="lineNum">   13197 </span>            : {
<span class="lineNum">   13198 </span>            :         struct mwi_sub_task *mwist;
<span class="lineNum">   13199 </span>            :         char *context;
<span class="lineNum">   13200 </span>            :         char *mailbox;
<span class="lineNum">   13201 </span>            : 
<span class="lineNum">   13202 </span><span class="lineNoCov">          0 :         mwist = ast_calloc(1, (sizeof(*mwist)));</span>
<span class="lineNum">   13203 </span><span class="lineNoCov">          0 :         if (!mwist) {</span>
<span class="lineNum">   13204 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">   13205 </span>            :         }
<span class="lineNum">   13206 </span>            : 
<span class="lineNum">   13207 </span><span class="lineNoCov">          0 :         if (separate_mailbox(ast_strdupa(stasis_topic_name(change-&gt;topic)), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">   13208 </span><span class="lineNoCov">          0 :                 ast_free(mwist);</span>
<span class="lineNum">   13209 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">   13210 </span>            :         }
<span class="lineNum">   13211 </span>            : 
<span class="lineNum">   13212 </span><span class="lineNoCov">          0 :         mwist-&gt;mailbox = ast_strdup(mailbox);</span>
<span class="lineNum">   13213 </span><span class="lineNoCov">          0 :         mwist-&gt;context = ast_strdup(context);</span>
<span class="lineNum">   13214 </span><span class="lineNoCov">          0 :         mwist-&gt;uniqueid = ast_strdup(change-&gt;uniqueid);</span>
<span class="lineNum">   13215 </span>            : 
<span class="lineNum">   13216 </span><span class="lineNoCov">          0 :         if (ast_taskprocessor_push(mwi_subscription_tps, handle_subscribe, mwist) &lt; 0) {</span>
<span class="lineNum">   13217 </span><span class="lineNoCov">          0 :                 mwi_sub_task_dtor(mwist);</span>
<span class="lineNum">   13218 </span>            :         }
<a name="13219"><span class="lineNum">   13219 </span>            : }</a>
<span class="lineNum">   13220 </span>            : 
<span class="lineNum">   13221 </span><span class="lineNoCov">          0 : static void mwi_event_cb(void *userdata, struct stasis_subscription *sub, struct stasis_message *msg)</span>
<span class="lineNum">   13222 </span>            : {
<span class="lineNum">   13223 </span>            :         struct stasis_subscription_change *change;
<span class="lineNum">   13224 </span>            :         /* Only looking for subscription change notices here */
<span class="lineNum">   13225 </span><span class="lineNoCov">          0 :         if (stasis_message_type(msg) != stasis_subscription_change_type()) {</span>
<span class="lineNum">   13226 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">   13227 </span>            :         }
<span class="lineNum">   13228 </span>            : 
<span class="lineNum">   13229 </span><span class="lineNoCov">          0 :         change = stasis_message_data(msg);</span>
<span class="lineNum">   13230 </span><span class="lineNoCov">          0 :         if (change-&gt;topic == ast_mwi_topic_all()) {</span>
<span class="lineNum">   13231 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">   13232 </span>            :         }
<span class="lineNum">   13233 </span>            : 
<span class="lineNum">   13234 </span><span class="lineNoCov">          0 :         if (!strcmp(change-&gt;description, &quot;Subscribe&quot;)) {</span>
<span class="lineNum">   13235 </span><span class="lineNoCov">          0 :                 mwi_sub_event_cb(change);</span>
<span class="lineNum">   13236 </span><span class="lineNoCov">          0 :         } else if (!strcmp(change-&gt;description, &quot;Unsubscribe&quot;)) {</span>
<span class="lineNum">   13237 </span><span class="lineNoCov">          0 :                 mwi_unsub_event_cb(change);</span>
<span class="lineNum">   13238 </span>            :         }
<a name="13239"><span class="lineNum">   13239 </span>            : }</a>
<span class="lineNum">   13240 </span>            : 
<span class="lineNum">   13241 </span><span class="lineNoCov">          0 : static int dump_cache(void *obj, void *arg, int flags)</span>
<span class="lineNum">   13242 </span>            : {
<span class="lineNum">   13243 </span><span class="lineNoCov">          0 :         struct stasis_message *msg = obj;</span>
<span class="lineNum">   13244 </span><span class="lineNoCov">          0 :         mwi_event_cb(NULL, NULL, msg);</span>
<span class="lineNum">   13245 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="13246"><span class="lineNum">   13246 </span>            : }</a>
<span class="lineNum">   13247 </span>            : 
<span class="lineNum">   13248 </span><span class="lineNoCov">          0 : static void start_poll_thread(void)</span>
<span class="lineNum">   13249 </span>            : {
<span class="lineNum">   13250 </span>            :         int errcode;
<span class="lineNum">   13251 </span><span class="lineNoCov">          0 :         mwi_sub_sub = stasis_subscribe(ast_mwi_topic_all(), mwi_event_cb, NULL);</span>
<span class="lineNum">   13252 </span>            : 
<span class="lineNum">   13253 </span><span class="lineNoCov">          0 :         if (mwi_sub_sub) {</span>
<span class="lineNum">   13254 </span><span class="lineNoCov">          0 :                 struct ao2_container *cached = stasis_cache_dump(ast_mwi_state_cache(), stasis_subscription_change_type());</span>
<span class="lineNum">   13255 </span><span class="lineNoCov">          0 :                 if (cached) {</span>
<span class="lineNum">   13256 </span><span class="lineNoCov">          0 :                         ao2_callback(cached, OBJ_MULTIPLE | OBJ_NODATA, dump_cache, NULL);</span>
<span class="lineNum">   13257 </span>            :                 }
<span class="lineNum">   13258 </span><span class="lineNoCov">          0 :                 ao2_cleanup(cached);</span>
<span class="lineNum">   13259 </span>            :         }
<span class="lineNum">   13260 </span>            : 
<span class="lineNum">   13261 </span><span class="lineNoCov">          0 :         poll_thread_run = 1;</span>
<span class="lineNum">   13262 </span>            : 
<span class="lineNum">   13263 </span><span class="lineNoCov">          0 :         if ((errcode = ast_pthread_create(&amp;poll_thread, NULL, mb_poll_thread, NULL))) {</span>
<span class="lineNum">   13264 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Could not create thread: %s\n&quot;, strerror(errcode));</span>
<span class="lineNum">   13265 </span>            :         }
<a name="13266"><span class="lineNum">   13266 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">   13267 </span>            : 
<span class="lineNum">   13268 </span><span class="lineNoCov">          0 : static void stop_poll_thread(void)</span>
<span class="lineNum">   13269 </span>            : {
<span class="lineNum">   13270 </span><span class="lineNoCov">          0 :         poll_thread_run = 0;</span>
<span class="lineNum">   13271 </span>            : 
<span class="lineNum">   13272 </span><span class="lineNoCov">          0 :         mwi_sub_sub = stasis_unsubscribe_and_join(mwi_sub_sub);</span>
<span class="lineNum">   13273 </span>            : 
<span class="lineNum">   13274 </span><span class="lineNoCov">          0 :         ast_mutex_lock(&amp;poll_lock);</span>
<span class="lineNum">   13275 </span><span class="lineNoCov">          0 :         ast_cond_signal(&amp;poll_cond);</span>
<span class="lineNum">   13276 </span><span class="lineNoCov">          0 :         ast_mutex_unlock(&amp;poll_lock);</span>
<span class="lineNum">   13277 </span>            : 
<span class="lineNum">   13278 </span><span class="lineNoCov">          0 :         pthread_join(poll_thread, NULL);</span>
<span class="lineNum">   13279 </span>            : 
<span class="lineNum">   13280 </span><span class="lineNoCov">          0 :         poll_thread = AST_PTHREADT_NULL;</span>
<span class="lineNum">   13281 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">   13282 </span>            : 
<span class="lineNum">   13283 </span>            : /*!
<span class="lineNum">   13284 </span>            :  * \brief Append vmu info string into given astman with event_name.
<a name="13285"><span class="lineNum">   13285 </span>            :  * \return 0 failed. 1 otherwise.</a>
<span class="lineNum">   13286 </span>            : */
<span class="lineNum">   13287 </span><span class="lineNoCov">          0 : static int append_vmu_info_astman(</span>
<span class="lineNum">   13288 </span>            :                 struct mansession *s,
<span class="lineNum">   13289 </span>            :                 struct ast_vm_user *vmu,
<span class="lineNum">   13290 </span>            :                 const char* event_name,
<span class="lineNum">   13291 </span>            :                 const char* actionid
<span class="lineNum">   13292 </span>            :                 )
<span class="lineNum">   13293 </span>            : {
<span class="lineNum">   13294 </span>            :         int new;
<span class="lineNum">   13295 </span>            :         int old;
<span class="lineNum">   13296 </span>            :         char *mailbox;
<span class="lineNum">   13297 </span>            :         int ret;
<span class="lineNum">   13298 </span>            : 
<span class="lineNum">   13299 </span><span class="lineNoCov">          0 :         if((s == NULL) || (vmu == NULL) || (event_name == NULL) || (actionid == NULL)) {</span>
<span class="lineNum">   13300 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Wrong input parameter.&quot;);</span>
<span class="lineNum">   13301 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   13302 </span>            :         }
<span class="lineNum">   13303 </span>            : 
<span class="lineNum">   13304 </span>            :         /* create mailbox string */
<span class="lineNum">   13305 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(vmu-&gt;context)) {</span>
<span class="lineNum">   13306 </span><span class="lineNoCov">          0 :                 ret = ast_asprintf(&amp;mailbox, &quot;%s@%s&quot;, vmu-&gt;mailbox, vmu-&gt;context);</span>
<span class="lineNum">   13307 </span>            :         } else {
<span class="lineNum">   13308 </span><span class="lineNoCov">          0 :                 ret = ast_asprintf(&amp;mailbox, &quot;%s&quot;, vmu-&gt;mailbox);</span>
<span class="lineNum">   13309 </span>            :         }
<span class="lineNum">   13310 </span><span class="lineNoCov">          0 :         if (ret == -1) {</span>
<span class="lineNum">   13311 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Could not create mailbox string. err[%s]\n&quot;, strerror(errno));</span>
<span class="lineNum">   13312 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   13313 </span>            :         }
<span class="lineNum">   13314 </span>            : 
<span class="lineNum">   13315 </span>            :         /* get mailbox count */
<span class="lineNum">   13316 </span><span class="lineNoCov">          0 :         ret = inboxcount(mailbox, &amp;new, &amp;old);</span>
<span class="lineNum">   13317 </span><span class="lineNoCov">          0 :         ast_free(mailbox);</span>
<span class="lineNum">   13318 </span><span class="lineNoCov">          0 :         if (ret == -1) {</span>
<span class="lineNum">   13319 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Could not get mailbox count. user[%s], context[%s]\n&quot;,</span>
<span class="lineNum">   13320 </span><span class="lineNoCov">          0 :                         vmu-&gt;mailbox ?: &quot;&quot;, vmu-&gt;context ?: &quot;&quot;);</span>
<span class="lineNum">   13321 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   13322 </span>            :         }
<span class="lineNum">   13323 </span>            : 
<span class="lineNum">   13324 </span><span class="lineNoCov">          0 :         astman_append(s,</span>
<span class="lineNum">   13325 </span>            :                 &quot;Event: %s\r\n&quot;
<span class="lineNum">   13326 </span>            :                 &quot;%s&quot;
<span class="lineNum">   13327 </span>            :                 &quot;VMContext: %s\r\n&quot;
<span class="lineNum">   13328 </span>            :                 &quot;VoiceMailbox: %s\r\n&quot;
<span class="lineNum">   13329 </span>            :                 &quot;Fullname: %s\r\n&quot;
<span class="lineNum">   13330 </span>            :                 &quot;Email: %s\r\n&quot;
<span class="lineNum">   13331 </span>            :                 &quot;Pager: %s\r\n&quot;
<span class="lineNum">   13332 </span>            :                 &quot;ServerEmail: %s\r\n&quot;
<span class="lineNum">   13333 </span>            :                 &quot;FromString: %s\r\n&quot;
<span class="lineNum">   13334 </span>            :                 &quot;MailCommand: %s\r\n&quot;
<span class="lineNum">   13335 </span>            :                 &quot;Language: %s\r\n&quot;
<span class="lineNum">   13336 </span>            :                 &quot;TimeZone: %s\r\n&quot;
<span class="lineNum">   13337 </span>            :                 &quot;Callback: %s\r\n&quot;
<span class="lineNum">   13338 </span>            :                 &quot;Dialout: %s\r\n&quot;
<span class="lineNum">   13339 </span>            :                 &quot;UniqueID: %s\r\n&quot;
<span class="lineNum">   13340 </span>            :                 &quot;ExitContext: %s\r\n&quot;
<span class="lineNum">   13341 </span>            :                 &quot;SayDurationMinimum: %d\r\n&quot;
<span class="lineNum">   13342 </span>            :                 &quot;SayEnvelope: %s\r\n&quot;
<span class="lineNum">   13343 </span>            :                 &quot;SayCID: %s\r\n&quot;
<span class="lineNum">   13344 </span>            :                 &quot;AttachMessage: %s\r\n&quot;
<span class="lineNum">   13345 </span>            :                 &quot;AttachmentFormat: %s\r\n&quot;
<span class="lineNum">   13346 </span>            :                 &quot;DeleteMessage: %s\r\n&quot;
<span class="lineNum">   13347 </span>            :                 &quot;VolumeGain: %.2f\r\n&quot;
<span class="lineNum">   13348 </span>            :                 &quot;CanReview: %s\r\n&quot;
<span class="lineNum">   13349 </span>            :                 &quot;CallOperator: %s\r\n&quot;
<span class="lineNum">   13350 </span>            :                 &quot;MaxMessageCount: %d\r\n&quot;
<span class="lineNum">   13351 </span>            :                 &quot;MaxMessageLength: %d\r\n&quot;
<span class="lineNum">   13352 </span>            :                 &quot;NewMessageCount: %d\r\n&quot;
<span class="lineNum">   13353 </span>            :                 &quot;OldMessageCount: %d\r\n&quot;
<span class="lineNum">   13354 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13355 </span>            :                 &quot;IMAPUser: %s\r\n&quot;
<span class="lineNum">   13356 </span>            :                 &quot;IMAPServer: %s\r\n&quot;
<span class="lineNum">   13357 </span>            :                 &quot;IMAPPort: %s\r\n&quot;
<span class="lineNum">   13358 </span>            :                 &quot;IMAPFlags: %s\r\n&quot;
<span class="lineNum">   13359 </span>            : #endif
<span class="lineNum">   13360 </span>            :                 &quot;\r\n&quot;,
<span class="lineNum">   13361 </span>            : 
<span class="lineNum">   13362 </span>            :                 event_name,
<span class="lineNum">   13363 </span>            :                 actionid,
<span class="lineNum">   13364 </span><span class="lineNoCov">          0 :                 vmu-&gt;context,</span>
<span class="lineNum">   13365 </span><span class="lineNoCov">          0 :                 vmu-&gt;mailbox,</span>
<span class="lineNum">   13366 </span><span class="lineNoCov">          0 :                 vmu-&gt;fullname,</span>
<span class="lineNum">   13367 </span>            :                 vmu-&gt;email,
<span class="lineNum">   13368 </span><span class="lineNoCov">          0 :                 vmu-&gt;pager,</span>
<span class="lineNum">   13369 </span><span class="lineNoCov">          0 :                 ast_strlen_zero(vmu-&gt;serveremail) ? serveremail : vmu-&gt;serveremail,</span>
<span class="lineNum">   13370 </span><span class="lineNoCov">          0 :                 ast_strlen_zero(vmu-&gt;fromstring) ? fromstring : vmu-&gt;fromstring,</span>
<span class="lineNum">   13371 </span>            :                 mailcmd,
<span class="lineNum">   13372 </span><span class="lineNoCov">          0 :                 vmu-&gt;language,</span>
<span class="lineNum">   13373 </span><span class="lineNoCov">          0 :                 vmu-&gt;zonetag,</span>
<span class="lineNum">   13374 </span><span class="lineNoCov">          0 :                 vmu-&gt;callback,</span>
<span class="lineNum">   13375 </span><span class="lineNoCov">          0 :                 vmu-&gt;dialout,</span>
<span class="lineNum">   13376 </span><span class="lineNoCov">          0 :                 vmu-&gt;uniqueid,</span>
<span class="lineNum">   13377 </span><span class="lineNoCov">          0 :                 vmu-&gt;exit,</span>
<span class="lineNum">   13378 </span>            :                 vmu-&gt;saydurationm,
<span class="lineNum">   13379 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_ENVELOPE) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13380 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_SAYCID) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13381 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_ATTACH) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13382 </span><span class="lineNoCov">          0 :                 vmu-&gt;attachfmt,</span>
<span class="lineNum">   13383 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_DELETE) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13384 </span>            :                 vmu-&gt;volgain,
<span class="lineNum">   13385 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_REVIEW) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13386 </span><span class="lineNoCov">          0 :                 ast_test_flag(vmu, VM_OPERATOR) ? &quot;Yes&quot; : &quot;No&quot;,</span>
<span class="lineNum">   13387 </span>            :                 vmu-&gt;maxmsg,
<span class="lineNum">   13388 </span>            :                 vmu-&gt;maxsecs,
<span class="lineNum">   13389 </span>            :                 new,
<span class="lineNum">   13390 </span>            :                 old
<span class="lineNum">   13391 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13392 </span>            :                 ,
<span class="lineNum">   13393 </span>            :                 vmu-&gt;imapuser,
<span class="lineNum">   13394 </span>            :                 vmu-&gt;imapserver,
<span class="lineNum">   13395 </span>            :                 vmu-&gt;imapport,
<span class="lineNum">   13396 </span>            :                 vmu-&gt;imapflags
<span class="lineNum">   13397 </span>            : #endif
<span class="lineNum">   13398 </span>            :                 );
<span class="lineNum">   13399 </span>            : 
<span class="lineNum">   13400 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">   13401 </span>            : 
<a name="13402"><span class="lineNum">   13402 </span>            : }</a>
<span class="lineNum">   13403 </span>            : 
<span class="lineNum">   13404 </span><span class="lineNoCov">          0 : static int manager_voicemail_refresh(struct mansession *s, const struct message *m)</span>
<span class="lineNum">   13405 </span>            : {
<span class="lineNum">   13406 </span><span class="lineNoCov">          0 :         const char *context = astman_get_header(m, &quot;Context&quot;);</span>
<span class="lineNum">   13407 </span><span class="lineNoCov">          0 :         const char *mailbox = astman_get_header(m, &quot;Mailbox&quot;);</span>
<span class="lineNum">   13408 </span>            :         struct mwi_sub *mwi_sub;
<span class="lineNum">   13409 </span>            :         const char *at;
<span class="lineNum">   13410 </span>            : 
<span class="lineNum">   13411 </span><span class="lineNoCov">          0 :         AST_RWLIST_RDLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13412 </span><span class="lineNoCov">          0 :         AST_RWLIST_TRAVERSE(&amp;mwi_subs, mwi_sub, entry) {</span>
<span class="lineNum">   13413 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(mwi_sub-&gt;mailbox)) {</span>
<span class="lineNum">   13414 </span><span class="lineNoCov">          0 :                         if (</span>
<span class="lineNum">   13415 </span>            :                                 /* First case: everything matches */
<span class="lineNum">   13416 </span><span class="lineNoCov">          0 :                                 (ast_strlen_zero(context) &amp;&amp; ast_strlen_zero(mailbox)) ||</span>
<span class="lineNum">   13417 </span>            :                                 /* Second case: match the mailbox only */
<span class="lineNum">   13418 </span><span class="lineNoCov">          0 :                                 (ast_strlen_zero(context) &amp;&amp; !ast_strlen_zero(mailbox) &amp;&amp;</span>
<span class="lineNum">   13419 </span><span class="lineNoCov">          0 :                                         (at = strchr(mwi_sub-&gt;mailbox, '@')) &amp;&amp;</span>
<span class="lineNum">   13420 </span><span class="lineNoCov">          0 :                                         strncmp(mailbox, mwi_sub-&gt;mailbox, at - mwi_sub-&gt;mailbox) == 0) ||</span>
<span class="lineNum">   13421 </span>            :                                 /* Third case: match the context only */
<span class="lineNum">   13422 </span><span class="lineNoCov">          0 :                                 (!ast_strlen_zero(context) &amp;&amp; ast_strlen_zero(mailbox) &amp;&amp;</span>
<span class="lineNum">   13423 </span><span class="lineNoCov">          0 :                                         (at = strchr(mwi_sub-&gt;mailbox, '@')) &amp;&amp;</span>
<span class="lineNum">   13424 </span><span class="lineNoCov">          0 :                                         strcmp(context, at + 1) == 0) ||</span>
<span class="lineNum">   13425 </span>            :                                 /* Final case: match an exact specified mailbox */
<span class="lineNum">   13426 </span><span class="lineNoCov">          0 :                                 (!ast_strlen_zero(context) &amp;&amp; !ast_strlen_zero(mailbox) &amp;&amp;</span>
<span class="lineNum">   13427 </span><span class="lineNoCov">          0 :                                         (at = strchr(mwi_sub-&gt;mailbox, '@')) &amp;&amp;</span>
<span class="lineNum">   13428 </span><span class="lineNoCov">          0 :                                         strncmp(mailbox, mwi_sub-&gt;mailbox, at - mwi_sub-&gt;mailbox) == 0 &amp;&amp;</span>
<span class="lineNum">   13429 </span><span class="lineNoCov">          0 :                                         strcmp(context, at + 1) == 0)</span>
<span class="lineNum">   13430 </span>            :                         ) {
<span class="lineNum">   13431 </span><span class="lineNoCov">          0 :                                 poll_subscribed_mailbox(mwi_sub);</span>
<span class="lineNum">   13432 </span>            :                         }
<span class="lineNum">   13433 </span>            :                 }
<span class="lineNum">   13434 </span>            :         }
<span class="lineNum">   13435 </span><span class="lineNoCov">          0 :         AST_RWLIST_UNLOCK(&amp;mwi_subs);</span>
<span class="lineNum">   13436 </span><span class="lineNoCov">          0 :         astman_send_ack(s, m, &quot;Refresh sent&quot;);</span>
<span class="lineNum">   13437 </span><span class="lineNoCov">          0 :         return RESULT_SUCCESS;</span>
<a name="13438"><span class="lineNum">   13438 </span>            : }</a>
<span class="lineNum">   13439 </span>            : 
<span class="lineNum">   13440 </span><span class="lineNoCov">          0 : static int manager_status_voicemail_user(struct mansession *s, const struct message *m)</span>
<span class="lineNum">   13441 </span>            : {
<span class="lineNum">   13442 </span><span class="lineNoCov">          0 :         struct ast_vm_user *vmu = NULL;</span>
<span class="lineNum">   13443 </span><span class="lineNoCov">          0 :         const char *id = astman_get_header(m, &quot;ActionID&quot;);</span>
<span class="lineNum">   13444 </span>            :         char actionid[128];
<span class="lineNum">   13445 </span>            :         struct ast_vm_user svm;
<span class="lineNum">   13446 </span>            :         int ret;
<span class="lineNum">   13447 </span>            : 
<span class="lineNum">   13448 </span><span class="lineNoCov">          0 :         const char *context = astman_get_header(m, &quot;Context&quot;);</span>
<span class="lineNum">   13449 </span><span class="lineNoCov">          0 :         const char *mailbox = astman_get_header(m, &quot;Mailbox&quot;);</span>
<span class="lineNum">   13450 </span>            : 
<span class="lineNum">   13451 </span><span class="lineNoCov">          0 :         if ((ast_strlen_zero(context) || ast_strlen_zero(mailbox))) {</span>
<span class="lineNum">   13452 </span><span class="lineNoCov">          0 :                 astman_send_error(s, m, &quot;Need 'Context' and 'Mailbox' parameters.&quot;);</span>
<span class="lineNum">   13453 </span><span class="lineNoCov">          0 :                 return RESULT_SUCCESS;</span>
<span class="lineNum">   13454 </span>            :         }
<span class="lineNum">   13455 </span>            : 
<span class="lineNum">   13456 </span><span class="lineNoCov">          0 :         actionid[0] = '\0';</span>
<span class="lineNum">   13457 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(id)) {</span>
<span class="lineNum">   13458 </span><span class="lineNoCov">          0 :                 snprintf(actionid, sizeof(actionid), &quot;ActionID: %s\r\n&quot;, id);</span>
<span class="lineNum">   13459 </span>            :         }
<span class="lineNum">   13460 </span>            : 
<span class="lineNum">   13461 </span>            :         /* find user */
<span class="lineNum">   13462 </span><span class="lineNoCov">          0 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">   13463 </span><span class="lineNoCov">          0 :         vmu = find_user(&amp;svm, context, mailbox);</span>
<span class="lineNum">   13464 </span><span class="lineNoCov">          0 :         if (!vmu) {</span>
<span class="lineNum">   13465 </span>            :                 /* could not find it */
<span class="lineNum">   13466 </span><span class="lineNoCov">          0 :                 astman_send_ack(s, m, &quot;There is no voicemail user of the given info.&quot;);</span>
<span class="lineNum">   13467 </span><span class="lineNoCov">          0 :                 return RESULT_SUCCESS;</span>
<span class="lineNum">   13468 </span>            :         }
<span class="lineNum">   13469 </span>            : 
<span class="lineNum">   13470 </span><span class="lineNoCov">          0 :         astman_send_listack(s, m, &quot;Voicemail user detail will follow&quot;, &quot;start&quot;);</span>
<span class="lineNum">   13471 </span>            : 
<span class="lineNum">   13472 </span>            :         /* append vmu info event */
<span class="lineNum">   13473 </span><span class="lineNoCov">          0 :         ret = append_vmu_info_astman(s, vmu, &quot;VoicemailUserDetail&quot;, actionid);</span>
<span class="lineNum">   13474 </span><span class="lineNoCov">          0 :         free_user(vmu);</span>
<span class="lineNum">   13475 </span><span class="lineNoCov">          0 :         if(ret == 0) {</span>
<span class="lineNum">   13476 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Could not append voicemail user info.&quot;);</span>
<span class="lineNum">   13477 </span>            :         }
<span class="lineNum">   13478 </span>            : 
<span class="lineNum">   13479 </span><span class="lineNoCov">          0 :         astman_send_list_complete_start(s, m, &quot;VoicemailUserDetailComplete&quot;, 1);</span>
<span class="lineNum">   13480 </span><span class="lineNoCov">          0 :         astman_send_list_complete_end(s);</span>
<span class="lineNum">   13481 </span>            : 
<span class="lineNum">   13482 </span><span class="lineNoCov">          0 :         return RESULT_SUCCESS;</span>
<span class="lineNum">   13483 </span>            : }
<a name="13484"><span class="lineNum">   13484 </span>            : </a>
<span class="lineNum">   13485 </span>            : /*! \brief Manager list voicemail users command */
<span class="lineNum">   13486 </span><span class="lineNoCov">          0 : static int manager_list_voicemail_users(struct mansession *s, const struct message *m)</span>
<span class="lineNum">   13487 </span>            : {
<span class="lineNum">   13488 </span><span class="lineNoCov">          0 :         struct ast_vm_user *vmu = NULL;</span>
<span class="lineNum">   13489 </span><span class="lineNoCov">          0 :         const char *id = astman_get_header(m, &quot;ActionID&quot;);</span>
<span class="lineNum">   13490 </span>            :         char actionid[128];
<span class="lineNum">   13491 </span><span class="lineNoCov">          0 :         int num_users = 0;</span>
<span class="lineNum">   13492 </span>            :         int ret;
<span class="lineNum">   13493 </span>            : 
<span class="lineNum">   13494 </span><span class="lineNoCov">          0 :         actionid[0] = '\0';</span>
<span class="lineNum">   13495 </span><span class="lineNoCov">          0 :         if (!ast_strlen_zero(id)) {</span>
<span class="lineNum">   13496 </span><span class="lineNoCov">          0 :                 snprintf(actionid, sizeof(actionid), &quot;ActionID: %s\r\n&quot;, id);</span>
<span class="lineNum">   13497 </span>            :         }
<span class="lineNum">   13498 </span>            : 
<span class="lineNum">   13499 </span><span class="lineNoCov">          0 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   13500 </span>            : 
<span class="lineNum">   13501 </span><span class="lineNoCov">          0 :         if (AST_LIST_EMPTY(&amp;users)) {</span>
<span class="lineNum">   13502 </span><span class="lineNoCov">          0 :                 astman_send_ack(s, m, &quot;There are no voicemail users currently defined.&quot;);</span>
<span class="lineNum">   13503 </span><span class="lineNoCov">          0 :                 AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   13504 </span><span class="lineNoCov">          0 :                 return RESULT_SUCCESS;</span>
<span class="lineNum">   13505 </span>            :         }
<span class="lineNum">   13506 </span>            : 
<span class="lineNum">   13507 </span><span class="lineNoCov">          0 :         astman_send_listack(s, m, &quot;Voicemail user list will follow&quot;, &quot;start&quot;);</span>
<span class="lineNum">   13508 </span>            : 
<span class="lineNum">   13509 </span><span class="lineNoCov">          0 :         AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   13510 </span>            :                 /* append vmu info event */
<span class="lineNum">   13511 </span><span class="lineNoCov">          0 :                 ret = append_vmu_info_astman(s, vmu, &quot;VoicemailUserEntry&quot;, actionid);</span>
<span class="lineNum">   13512 </span><span class="lineNoCov">          0 :                 if(ret == 0) {</span>
<span class="lineNum">   13513 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Could not append voicemail user info.&quot;);</span>
<span class="lineNum">   13514 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">   13515 </span>            :                 }
<span class="lineNum">   13516 </span><span class="lineNoCov">          0 :                 ++num_users;</span>
<span class="lineNum">   13517 </span>            :         }
<span class="lineNum">   13518 </span>            : 
<span class="lineNum">   13519 </span><span class="lineNoCov">          0 :         astman_send_list_complete_start(s, m, &quot;VoicemailUserEntryComplete&quot;, num_users);</span>
<span class="lineNum">   13520 </span><span class="lineNoCov">          0 :         astman_send_list_complete_end(s);</span>
<span class="lineNum">   13521 </span>            : 
<span class="lineNum">   13522 </span><span class="lineNoCov">          0 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   13523 </span>            : 
<span class="lineNum">   13524 </span><span class="lineNoCov">          0 :         return RESULT_SUCCESS;</span>
<span class="lineNum">   13525 </span>            : }
<a name="13526"><span class="lineNum">   13526 </span>            : </a>
<span class="lineNum">   13527 </span>            : /*! \brief Free the users structure. */
<span class="lineNum">   13528 </span><span class="lineCov">       2143 : static void free_vm_users(void)</span>
<span class="lineNum">   13529 </span>            : {
<span class="lineNum">   13530 </span>            :         struct ast_vm_user *current;
<span class="lineNum">   13531 </span><span class="lineCov">       2143 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   13532 </span><span class="lineCov">       4275 :         while ((current = AST_LIST_REMOVE_HEAD(&amp;users, list))) {</span>
<span class="lineNum">   13533 </span><span class="lineCov">       2132 :                 ast_set_flag(current, VM_ALLOCED);</span>
<span class="lineNum">   13534 </span><span class="lineCov">       2132 :                 free_user(current);</span>
<span class="lineNum">   13535 </span>            :         }
<span class="lineNum">   13536 </span><span class="lineCov">       2143 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   13537 </span><span class="lineCov">       2143 : }</span>
<a name="13538"><span class="lineNum">   13538 </span>            : </a>
<span class="lineNum">   13539 </span>            : /*! \brief Free the zones structure. */
<span class="lineNum">   13540 </span><span class="lineCov">       2143 : static void free_vm_zones(void)</span>
<span class="lineNum">   13541 </span>            : {
<span class="lineNum">   13542 </span>            :         struct vm_zone *zcur;
<span class="lineNum">   13543 </span><span class="lineCov">       2143 :         AST_LIST_LOCK(&amp;zones);</span>
<span class="lineNum">   13544 </span><span class="lineCov">       7463 :         while ((zcur = AST_LIST_REMOVE_HEAD(&amp;zones, list)))</span>
<span class="lineNum">   13545 </span><span class="lineCov">       5320 :                 free_zone(zcur);</span>
<span class="lineNum">   13546 </span><span class="lineCov">       2143 :         AST_LIST_UNLOCK(&amp;zones);</span>
<a name="13547"><span class="lineNum">   13547 </span><span class="lineCov">       2143 : }</span></a>
<span class="lineNum">   13548 </span>            : 
<span class="lineNum">   13549 </span><span class="lineCov">          2 : static const char *substitute_escapes(const char *value)</span>
<span class="lineNum">   13550 </span>            : {
<span class="lineNum">   13551 </span>            :         char *current;
<span class="lineNum">   13552 </span>            : 
<span class="lineNum">   13553 </span>            :         /* Add 16 for fudge factor */
<span class="lineNum">   13554 </span><span class="lineCov">          2 :         struct ast_str *str = ast_str_thread_get(&amp;ast_str_thread_global_buf, strlen(value) + 16);</span>
<span class="lineNum">   13555 </span>            : 
<span class="lineNum">   13556 </span><span class="lineCov">          2 :         ast_str_reset(str);</span>
<span class="lineNum">   13557 </span>            : 
<span class="lineNum">   13558 </span>            :         /* Substitute strings \r, \n, and \t into the appropriate characters */
<span class="lineNum">   13559 </span><span class="lineCov">        122 :         for (current = (char *) value; *current; current++) {</span>
<span class="lineNum">   13560 </span><span class="lineCov">        120 :                 if (*current == '\\') {</span>
<span class="lineNum">   13561 </span><span class="lineCov">          2 :                         current++;</span>
<span class="lineNum">   13562 </span><span class="lineCov">          2 :                         if (!*current) {</span>
<span class="lineNum">   13563 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_NOTICE, &quot;Incomplete escape at end of value.\n&quot;);</span>
<span class="lineNum">   13564 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   13565 </span>            :                         }
<span class="lineNum">   13566 </span><span class="lineCov">          2 :                         switch (*current) {</span>
<span class="lineNum">   13567 </span><span class="lineCov">          2 :                         case '\\':</span>
<span class="lineNum">   13568 </span><span class="lineCov">          2 :                                 ast_str_append(&amp;str, 0, &quot;\\&quot;);</span>
<span class="lineNum">   13569 </span><span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">   13570 </span><span class="lineNoCov">          0 :                         case 'r':</span>
<span class="lineNum">   13571 </span><span class="lineNoCov">          0 :                                 ast_str_append(&amp;str, 0, &quot;\r&quot;);</span>
<span class="lineNum">   13572 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   13573 </span><span class="lineNoCov">          0 :                         case 'n':</span>
<span class="lineNum">   13574 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13575 </span>            :                                 if (!str-&gt;used || str-&gt;str[str-&gt;used - 1] != '\r') {
<span class="lineNum">   13576 </span>            :                                         ast_str_append(&amp;str, 0, &quot;\r&quot;);
<span class="lineNum">   13577 </span>            :                                 }
<span class="lineNum">   13578 </span>            : #endif
<span class="lineNum">   13579 </span><span class="lineNoCov">          0 :                                 ast_str_append(&amp;str, 0, &quot;\n&quot;);</span>
<span class="lineNum">   13580 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   13581 </span><span class="lineNoCov">          0 :                         case 't':</span>
<span class="lineNum">   13582 </span><span class="lineNoCov">          0 :                                 ast_str_append(&amp;str, 0, &quot;\t&quot;);</span>
<span class="lineNum">   13583 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   13584 </span><span class="lineNoCov">          0 :                         default:</span>
<span class="lineNum">   13585 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_NOTICE, &quot;Substitution routine does not support this character: \\%c\n&quot;, *current);</span>
<span class="lineNum">   13586 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   13587 </span>            :                         }
<span class="lineNum">   13588 </span>            :                 } else {
<span class="lineNum">   13589 </span><span class="lineCov">        118 :                         ast_str_append(&amp;str, 0, &quot;%c&quot;, *current);</span>
<span class="lineNum">   13590 </span>            :                 }
<span class="lineNum">   13591 </span>            :         }
<span class="lineNum">   13592 </span>            : 
<span class="lineNum">   13593 </span><span class="lineCov">          2 :         return ast_str_buffer(str);</span>
<a name="13594"><span class="lineNum">   13594 </span>            : }</a>
<span class="lineNum">   13595 </span>            : 
<span class="lineNum">   13596 </span><span class="lineCov">       1074 : static int load_config(int reload)</span>
<span class="lineNum">   13597 </span>            : {
<span class="lineNum">   13598 </span>            :         struct ast_config *cfg, *ucfg;
<span class="lineNum">   13599 </span><span class="lineCov">       1074 :         struct ast_flags config_flags = { reload ? CONFIG_FLAG_FILEUNCHANGED : 0 };</span>
<span class="lineNum">   13600 </span>            :         int res;
<span class="lineNum">   13601 </span>            : 
<span class="lineNum">   13602 </span><span class="lineCov">       1074 :         ast_unload_realtime(&quot;voicemail&quot;);</span>
<span class="lineNum">   13603 </span><span class="lineCov">       1074 :         ast_unload_realtime(&quot;voicemail_data&quot;);</span>
<span class="lineNum">   13604 </span>            : 
<span class="lineNum">   13605 </span><span class="lineCov">       1074 :         if ((cfg = ast_config_load(VOICEMAIL_CONFIG, config_flags)) == CONFIG_STATUS_FILEUNCHANGED) {</span>
<span class="lineNum">   13606 </span><span class="lineCov">          1 :                 if ((ucfg = ast_config_load(&quot;users.conf&quot;, config_flags)) == CONFIG_STATUS_FILEUNCHANGED) {</span>
<span class="lineNum">   13607 </span><span class="lineCov">          1 :                         return 0;</span>
<span class="lineNum">   13608 </span><span class="lineNoCov">          0 :                 } else if (ucfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   13609 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;);</span>
<span class="lineNum">   13610 </span><span class="lineNoCov">          0 :                         ucfg = NULL;</span>
<span class="lineNum">   13611 </span>            :                 }
<span class="lineNum">   13612 </span><span class="lineNoCov">          0 :                 ast_clear_flag(&amp;config_flags, CONFIG_FLAG_FILEUNCHANGED);</span>
<span class="lineNum">   13613 </span><span class="lineNoCov">          0 :                 if ((cfg = ast_config_load(VOICEMAIL_CONFIG, config_flags)) == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   13614 </span><span class="lineNoCov">          0 :                         ast_config_destroy(ucfg);</span>
<span class="lineNum">   13615 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Config file &quot; VOICEMAIL_CONFIG &quot; is in an invalid format.  Aborting.\n&quot;);</span>
<span class="lineNum">   13616 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">   13617 </span>            :                 }
<span class="lineNum">   13618 </span><span class="lineCov">       1073 :         } else if (cfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   13619 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Config file &quot; VOICEMAIL_CONFIG &quot; is in an invalid format.  Aborting.\n&quot;);</span>
<span class="lineNum">   13620 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   13621 </span>            :         } else {
<span class="lineNum">   13622 </span><span class="lineCov">       1073 :                 ast_clear_flag(&amp;config_flags, CONFIG_FLAG_FILEUNCHANGED);</span>
<span class="lineNum">   13623 </span><span class="lineCov">       1073 :                 if ((ucfg = ast_config_load(&quot;users.conf&quot;, config_flags)) == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   13624 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR, &quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;);</span>
<span class="lineNum">   13625 </span><span class="lineNoCov">          0 :                         ucfg = NULL;</span>
<span class="lineNum">   13626 </span>            :                 }
<span class="lineNum">   13627 </span>            :         }
<span class="lineNum">   13628 </span>            : 
<span class="lineNum">   13629 </span><span class="lineCov">       1073 :         res = actual_load_config(reload, cfg, ucfg);</span>
<span class="lineNum">   13630 </span>            : 
<span class="lineNum">   13631 </span><span class="lineCov">       1073 :         ast_config_destroy(cfg);</span>
<span class="lineNum">   13632 </span><span class="lineCov">       1073 :         ast_config_destroy(ucfg);</span>
<span class="lineNum">   13633 </span>            : 
<span class="lineNum">   13634 </span><span class="lineCov">       1073 :         return res;</span>
<span class="lineNum">   13635 </span>            : }
<a name="13636"><span class="lineNum">   13636 </span>            : </a>
<span class="lineNum">   13637 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   13638 </span><span class="lineCov">          1 : static int load_config_from_memory(int reload, struct ast_config *cfg, struct ast_config *ucfg)</span>
<span class="lineNum">   13639 </span>            : {
<span class="lineNum">   13640 </span><span class="lineCov">          1 :         ast_unload_realtime(&quot;voicemail&quot;);</span>
<span class="lineNum">   13641 </span><span class="lineCov">          1 :         ast_unload_realtime(&quot;voicemail_data&quot;);</span>
<span class="lineNum">   13642 </span><span class="lineCov">          1 :         return actual_load_config(reload, cfg, ucfg);</span>
<span class="lineNum">   13643 </span>            : }
<a name="13644"><span class="lineNum">   13644 </span>            : #endif</a>
<span class="lineNum">   13645 </span>            : 
<span class="lineNum">   13646 </span><span class="lineCov">       1074 : static int actual_load_config(int reload, struct ast_config *cfg, struct ast_config *ucfg)</span>
<span class="lineNum">   13647 </span>            : {
<span class="lineNum">   13648 </span>            :         struct ast_vm_user *current;
<span class="lineNum">   13649 </span>            :         char *cat;
<span class="lineNum">   13650 </span>            :         struct ast_variable *var;
<span class="lineNum">   13651 </span>            :         const char *val;
<span class="lineNum">   13652 </span>            :         char *q, *stringp, *tmp;
<span class="lineNum">   13653 </span>            :         int x;
<span class="lineNum">   13654 </span>            :         unsigned int tmpadsi[4];
<span class="lineNum">   13655 </span><span class="lineCov">       1074 :         char secretfn[PATH_MAX] = &quot;&quot;;</span>
<span class="lineNum">   13656 </span>            :         long tps_queue_low;
<span class="lineNum">   13657 </span>            :         long tps_queue_high;
<span class="lineNum">   13658 </span>            : 
<span class="lineNum">   13659 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13660 </span>            :         ast_copy_string(imapparentfolder, &quot;\0&quot;, sizeof(imapparentfolder));
<span class="lineNum">   13661 </span>            : #endif
<span class="lineNum">   13662 </span>            :         /* set audio control prompts */
<span class="lineNum">   13663 </span><span class="lineCov">       1074 :         strcpy(listen_control_forward_key, DEFAULT_LISTEN_CONTROL_FORWARD_KEY);</span>
<span class="lineNum">   13664 </span><span class="lineCov">       1074 :         strcpy(listen_control_reverse_key, DEFAULT_LISTEN_CONTROL_REVERSE_KEY);</span>
<span class="lineNum">   13665 </span><span class="lineCov">       1074 :         strcpy(listen_control_pause_key, DEFAULT_LISTEN_CONTROL_PAUSE_KEY);</span>
<span class="lineNum">   13666 </span><span class="lineCov">       1074 :         strcpy(listen_control_restart_key, DEFAULT_LISTEN_CONTROL_RESTART_KEY);</span>
<span class="lineNum">   13667 </span><span class="lineCov">       1074 :         strcpy(listen_control_stop_key, DEFAULT_LISTEN_CONTROL_STOP_KEY);</span>
<span class="lineNum">   13668 </span>            : 
<span class="lineNum">   13669 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13670 </span>            :         imap_close_subscribed_mailboxes();
<span class="lineNum">   13671 </span>            : #endif
<span class="lineNum">   13672 </span>            : 
<span class="lineNum">   13673 </span>            :         /* Free all the users structure */
<span class="lineNum">   13674 </span><span class="lineCov">       1074 :         free_vm_users();</span>
<span class="lineNum">   13675 </span>            : 
<span class="lineNum">   13676 </span>            :         /* Free all the zones structure */
<span class="lineNum">   13677 </span><span class="lineCov">       1074 :         free_vm_zones();</span>
<span class="lineNum">   13678 </span>            : 
<span class="lineNum">   13679 </span><span class="lineCov">       1074 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   13680 </span>            : 
<span class="lineNum">   13681 </span><span class="lineCov">       1074 :         memset(ext_pass_cmd, 0, sizeof(ext_pass_cmd));</span>
<span class="lineNum">   13682 </span><span class="lineCov">       1074 :         memset(ext_pass_check_cmd, 0, sizeof(ext_pass_check_cmd));</span>
<span class="lineNum">   13683 </span>            : 
<span class="lineNum">   13684 </span><span class="lineCov">       1074 :         if (cfg) {</span>
<span class="lineNum">   13685 </span>            :                 /* General settings */
<span class="lineNum">   13686 </span>            : 
<span class="lineNum">   13687 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;userscontext&quot;)))</span>
<span class="lineNum">   13688 </span><span class="lineCov">       1074 :                         val = &quot;default&quot;;</span>
<span class="lineNum">   13689 </span><span class="lineCov">       1074 :                 ast_copy_string(userscontext, val, sizeof(userscontext));</span>
<span class="lineNum">   13690 </span>            :                 /* Attach voice message to mail message ? */
<span class="lineNum">   13691 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;attach&quot;)))</span>
<span class="lineNum">   13692 </span><span class="lineCov">         37 :                         val = &quot;yes&quot;;</span>
<span class="lineNum">   13693 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_ATTACH);</span>
<span class="lineNum">   13694 </span>            : 
<span class="lineNum">   13695 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;searchcontexts&quot;)))</span>
<span class="lineNum">   13696 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   13697 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_SEARCH);</span>
<span class="lineNum">   13698 </span>            : 
<span class="lineNum">   13699 </span><span class="lineCov">       1074 :                 volgain = 0.0;</span>
<span class="lineNum">   13700 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;volgain&quot;)))</span>
<span class="lineNum">   13701 </span><span class="lineNoCov">          0 :                         sscanf(val, &quot;%30lf&quot;, &amp;volgain);</span>
<span class="lineNum">   13702 </span>            : 
<span class="lineNum">   13703 </span>            : #ifdef ODBC_STORAGE
<span class="lineNum">   13704 </span>            :                 strcpy(odbc_database, &quot;asterisk&quot;);
<span class="lineNum">   13705 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;odbcstorage&quot;))) {
<span class="lineNum">   13706 </span>            :                         ast_copy_string(odbc_database, val, sizeof(odbc_database));
<span class="lineNum">   13707 </span>            :                 }
<span class="lineNum">   13708 </span>            :                 strcpy(odbc_table, &quot;voicemessages&quot;);
<span class="lineNum">   13709 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;odbctable&quot;))) {
<span class="lineNum">   13710 </span>            :                         ast_copy_string(odbc_table, val, sizeof(odbc_table));
<span class="lineNum">   13711 </span>            :                 }
<span class="lineNum">   13712 </span>            : #endif
<span class="lineNum">   13713 </span>            :                 /* Mail command */
<span class="lineNum">   13714 </span><span class="lineCov">       1074 :                 strcpy(mailcmd, SENDMAIL);</span>
<span class="lineNum">   13715 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;mailcmd&quot;)))</span>
<span class="lineNum">   13716 </span><span class="lineNoCov">          0 :                         ast_copy_string(mailcmd, val, sizeof(mailcmd)); /* User setting */</span>
<span class="lineNum">   13717 </span>            : 
<span class="lineNum">   13718 </span><span class="lineCov">       1074 :                 maxsilence = 0;</span>
<span class="lineNum">   13719 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxsilence&quot;))) {</span>
<span class="lineNum">   13720 </span><span class="lineCov">       1068 :                         maxsilence = atoi(val);</span>
<span class="lineNum">   13721 </span><span class="lineCov">       1068 :                         if (maxsilence &gt; 0)</span>
<span class="lineNum">   13722 </span><span class="lineCov">       1037 :                                 maxsilence *= 1000;</span>
<span class="lineNum">   13723 </span>            :                 }
<span class="lineNum">   13724 </span>            : 
<span class="lineNum">   13725 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxmsg&quot;))) {</span>
<span class="lineNum">   13726 </span><span class="lineCov">       1074 :                         maxmsg = MAXMSG;</span>
<span class="lineNum">   13727 </span>            :                 } else {
<span class="lineNum">   13728 </span><span class="lineNoCov">          0 :                         maxmsg = atoi(val);</span>
<span class="lineNum">   13729 </span><span class="lineNoCov">          0 :                         if (maxmsg &lt; 0) {</span>
<span class="lineNum">   13730 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid number of messages per folder '%s'. Using default value %i\n&quot;, val, MAXMSG);</span>
<span class="lineNum">   13731 </span><span class="lineNoCov">          0 :                                 maxmsg = MAXMSG;</span>
<span class="lineNum">   13732 </span><span class="lineNoCov">          0 :                         } else if (maxmsg &gt; MAXMSGLIMIT) {</span>
<span class="lineNum">   13733 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Maximum number of messages per folder is %i. Cannot accept value '%s'\n&quot;, MAXMSGLIMIT, val);</span>
<span class="lineNum">   13734 </span><span class="lineNoCov">          0 :                                 maxmsg = MAXMSGLIMIT;</span>
<span class="lineNum">   13735 </span>            :                         }
<span class="lineNum">   13736 </span>            :                 }
<span class="lineNum">   13737 </span>            : 
<span class="lineNum">   13738 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;backupdeleted&quot;))) {</span>
<span class="lineNum">   13739 </span><span class="lineCov">       1074 :                         maxdeletedmsg = 0;</span>
<span class="lineNum">   13740 </span>            :                 } else {
<span class="lineNum">   13741 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1)</span>
<span class="lineNum">   13742 </span><span class="lineNoCov">          0 :                                 maxdeletedmsg = x;</span>
<span class="lineNum">   13743 </span><span class="lineNoCov">          0 :                         else if (ast_true(val))</span>
<span class="lineNum">   13744 </span><span class="lineNoCov">          0 :                                 maxdeletedmsg = MAXMSG;</span>
<span class="lineNum">   13745 </span>            :                         else
<span class="lineNum">   13746 </span><span class="lineNoCov">          0 :                                 maxdeletedmsg = 0;</span>
<span class="lineNum">   13747 </span>            : 
<span class="lineNum">   13748 </span><span class="lineNoCov">          0 :                         if (maxdeletedmsg &lt; 0) {</span>
<span class="lineNum">   13749 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid number of deleted messages saved per mailbox '%s'. Using default value %i\n&quot;, val, MAXMSG);</span>
<span class="lineNum">   13750 </span><span class="lineNoCov">          0 :                                 maxdeletedmsg = MAXMSG;</span>
<span class="lineNum">   13751 </span><span class="lineNoCov">          0 :                         } else if (maxdeletedmsg &gt; MAXMSGLIMIT) {</span>
<span class="lineNum">   13752 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Maximum number of deleted messages saved per mailbox is %i. Cannot accept value '%s'\n&quot;, MAXMSGLIMIT, val);</span>
<span class="lineNum">   13753 </span><span class="lineNoCov">          0 :                                 maxdeletedmsg = MAXMSGLIMIT;</span>
<span class="lineNum">   13754 </span>            :                         }
<span class="lineNum">   13755 </span>            :                 }
<span class="lineNum">   13756 </span>            : 
<span class="lineNum">   13757 </span>            :                 /* Load date format config for voicemail mail */
<span class="lineNum">   13758 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;emaildateformat&quot;))) {</span>
<span class="lineNum">   13759 </span><span class="lineCov">       1036 :                         ast_copy_string(emaildateformat, val, sizeof(emaildateformat));</span>
<span class="lineNum">   13760 </span>            :                 }
<span class="lineNum">   13761 </span>            : 
<span class="lineNum">   13762 </span>            :                 /* Load date format config for voicemail pager mail */
<span class="lineNum">   13763 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pagerdateformat&quot;))) {</span>
<span class="lineNum">   13764 </span><span class="lineCov">       1036 :                         ast_copy_string(pagerdateformat, val, sizeof(pagerdateformat));</span>
<span class="lineNum">   13765 </span>            :                 }
<span class="lineNum">   13766 </span>            : 
<span class="lineNum">   13767 </span>            :                 /* External password changing command */
<span class="lineNum">   13768 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;externpass&quot;))) {</span>
<span class="lineNum">   13769 </span><span class="lineNoCov">          0 :                         ast_copy_string(ext_pass_cmd, val, sizeof(ext_pass_cmd));</span>
<span class="lineNum">   13770 </span><span class="lineNoCov">          0 :                         pwdchange = PWDCHANGE_EXTERNAL;</span>
<span class="lineNum">   13771 </span><span class="lineCov">       1074 :                 } else if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;externpassnotify&quot;))) {</span>
<span class="lineNum">   13772 </span><span class="lineCov">          4 :                         ast_copy_string(ext_pass_cmd, val, sizeof(ext_pass_cmd));</span>
<span class="lineNum">   13773 </span><span class="lineCov">          4 :                         pwdchange = PWDCHANGE_EXTERNAL | PWDCHANGE_INTERNAL;</span>
<span class="lineNum">   13774 </span>            :                 }
<span class="lineNum">   13775 </span>            : 
<span class="lineNum">   13776 </span>            :                 /* External password validation command */
<span class="lineNum">   13777 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;externpasscheck&quot;))) {</span>
<span class="lineNum">   13778 </span><span class="lineCov">          4 :                         ast_copy_string(ext_pass_check_cmd, val, sizeof(ext_pass_check_cmd));</span>
<span class="lineNum">   13779 </span><span class="lineCov">          4 :                         ast_debug(1, &quot;found externpasscheck: %s\n&quot;, ext_pass_check_cmd);</span>
<span class="lineNum">   13780 </span>            :                 }
<span class="lineNum">   13781 </span>            : 
<span class="lineNum">   13782 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   13783 </span>            :                 /* IMAP server address */
<span class="lineNum">   13784 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapserver&quot;))) {
<span class="lineNum">   13785 </span>            :                         ast_copy_string(imapserver, val, sizeof(imapserver));
<span class="lineNum">   13786 </span>            :                 } else {
<span class="lineNum">   13787 </span>            :                         ast_copy_string(imapserver, &quot;localhost&quot;, sizeof(imapserver));
<span class="lineNum">   13788 </span>            :                 }
<span class="lineNum">   13789 </span>            :                 /* IMAP server port */
<span class="lineNum">   13790 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapport&quot;))) {
<span class="lineNum">   13791 </span>            :                         ast_copy_string(imapport, val, sizeof(imapport));
<span class="lineNum">   13792 </span>            :                 } else {
<span class="lineNum">   13793 </span>            :                         ast_copy_string(imapport, &quot;143&quot;, sizeof(imapport));
<span class="lineNum">   13794 </span>            :                 }
<span class="lineNum">   13795 </span>            :                 /* IMAP server flags */
<span class="lineNum">   13796 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapflags&quot;))) {
<span class="lineNum">   13797 </span>            :                         ast_copy_string(imapflags, val, sizeof(imapflags));
<span class="lineNum">   13798 </span>            :                 }
<span class="lineNum">   13799 </span>            :                 /* IMAP server master username */
<span class="lineNum">   13800 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;authuser&quot;))) {
<span class="lineNum">   13801 </span>            :                         ast_copy_string(authuser, val, sizeof(authuser));
<span class="lineNum">   13802 </span>            :                 }
<span class="lineNum">   13803 </span>            :                 /* IMAP server master password */
<span class="lineNum">   13804 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;authpassword&quot;))) {
<span class="lineNum">   13805 </span>            :                         ast_copy_string(authpassword, val, sizeof(authpassword));
<span class="lineNum">   13806 </span>            :                 }
<span class="lineNum">   13807 </span>            :                 /* Expunge on exit */
<span class="lineNum">   13808 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;expungeonhangup&quot;))) {
<span class="lineNum">   13809 </span>            :                         if (ast_false(val))
<span class="lineNum">   13810 </span>            :                                 expungeonhangup = 0;
<span class="lineNum">   13811 </span>            :                         else
<span class="lineNum">   13812 </span>            :                                 expungeonhangup = 1;
<span class="lineNum">   13813 </span>            :                 } else {
<span class="lineNum">   13814 </span>            :                         expungeonhangup = 1;
<span class="lineNum">   13815 </span>            :                 }
<span class="lineNum">   13816 </span>            :                 /* IMAP voicemail folder */
<span class="lineNum">   13817 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapfolder&quot;))) {
<span class="lineNum">   13818 </span>            :                         ast_copy_string(imapfolder, val, sizeof(imapfolder));
<span class="lineNum">   13819 </span>            :                 } else {
<span class="lineNum">   13820 </span>            :                         ast_copy_string(imapfolder, &quot;INBOX&quot;, sizeof(imapfolder));
<span class="lineNum">   13821 </span>            :                 }
<span class="lineNum">   13822 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapparentfolder&quot;))) {
<span class="lineNum">   13823 </span>            :                         ast_copy_string(imapparentfolder, val, sizeof(imapparentfolder));
<span class="lineNum">   13824 </span>            :                 }
<span class="lineNum">   13825 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapgreetings&quot;))) {
<span class="lineNum">   13826 </span>            :                         imapgreetings = ast_true(val);
<span class="lineNum">   13827 </span>            :                 } else {
<span class="lineNum">   13828 </span>            :                         imapgreetings = 0;
<span class="lineNum">   13829 </span>            :                 }
<span class="lineNum">   13830 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;greetingfolder&quot;))) {
<span class="lineNum">   13831 </span>            :                         ast_copy_string(greetingfolder, val, sizeof(greetingfolder));
<span class="lineNum">   13832 </span>            :                 } else if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;greetingsfolder&quot;))) {
<span class="lineNum">   13833 </span>            :                         /* Also support greetingsfolder as documented in voicemail.conf.sample */
<span class="lineNum">   13834 </span>            :                         ast_copy_string(greetingfolder, val, sizeof(greetingfolder));
<span class="lineNum">   13835 </span>            :                 } else {
<span class="lineNum">   13836 </span>            :                         ast_copy_string(greetingfolder, imapfolder, sizeof(greetingfolder));
<span class="lineNum">   13837 </span>            :                 }
<span class="lineNum">   13838 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imap_poll_logout&quot;))) {
<span class="lineNum">   13839 </span>            :                         imap_poll_logout = ast_true(val);
<span class="lineNum">   13840 </span>            :                 } else {
<span class="lineNum">   13841 </span>            :                         imap_poll_logout = 0;
<span class="lineNum">   13842 </span>            :                 }
<span class="lineNum">   13843 </span>            : 
<span class="lineNum">   13844 </span>            :                 /* There is some very unorthodox casting done here. This is due
<span class="lineNum">   13845 </span>            :                  * to the way c-client handles the argument passed in. It expects a
<span class="lineNum">   13846 </span>            :                  * void pointer and casts the pointer directly to a long without
<span class="lineNum">   13847 </span>            :                  * first dereferencing it. */
<span class="lineNum">   13848 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapreadtimeout&quot;))) {
<span class="lineNum">   13849 </span>            :                         mail_parameters(NIL, SET_READTIMEOUT, (void *) (atol(val)));
<span class="lineNum">   13850 </span>            :                 } else {
<span class="lineNum">   13851 </span>            :                         mail_parameters(NIL, SET_READTIMEOUT, (void *) 60L);
<span class="lineNum">   13852 </span>            :                 }
<span class="lineNum">   13853 </span>            : 
<span class="lineNum">   13854 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapwritetimeout&quot;))) {
<span class="lineNum">   13855 </span>            :                         mail_parameters(NIL, SET_WRITETIMEOUT, (void *) (atol(val)));
<span class="lineNum">   13856 </span>            :                 } else {
<span class="lineNum">   13857 </span>            :                         mail_parameters(NIL, SET_WRITETIMEOUT, (void *) 60L);
<span class="lineNum">   13858 </span>            :                 }
<span class="lineNum">   13859 </span>            : 
<span class="lineNum">   13860 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapopentimeout&quot;))) {
<span class="lineNum">   13861 </span>            :                         mail_parameters(NIL, SET_OPENTIMEOUT, (void *) (atol(val)));
<span class="lineNum">   13862 </span>            :                 } else {
<span class="lineNum">   13863 </span>            :                         mail_parameters(NIL, SET_OPENTIMEOUT, (void *) 60L);
<span class="lineNum">   13864 </span>            :                 }
<span class="lineNum">   13865 </span>            : 
<span class="lineNum">   13866 </span>            :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;imapclosetimeout&quot;))) {
<span class="lineNum">   13867 </span>            :                         mail_parameters(NIL, SET_CLOSETIMEOUT, (void *) (atol(val)));
<span class="lineNum">   13868 </span>            :                 } else {
<span class="lineNum">   13869 </span>            :                         mail_parameters(NIL, SET_CLOSETIMEOUT, (void *) 60L);
<span class="lineNum">   13870 </span>            :                 }
<span class="lineNum">   13871 </span>            : 
<span class="lineNum">   13872 </span>            :                 /* Increment configuration version */
<span class="lineNum">   13873 </span>            :                 imapversion++;
<span class="lineNum">   13874 </span>            : #endif
<span class="lineNum">   13875 </span>            :                 /* External voicemail notify application */
<span class="lineNum">   13876 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;externnotify&quot;))) {</span>
<span class="lineNum">   13877 </span><span class="lineNoCov">          0 :                         ast_copy_string(externnotify, val, sizeof(externnotify));</span>
<span class="lineNum">   13878 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;found externnotify: %s\n&quot;, externnotify);</span>
<span class="lineNum">   13879 </span>            :                 } else {
<span class="lineNum">   13880 </span><span class="lineCov">       1074 :                         externnotify[0] = '\0';</span>
<span class="lineNum">   13881 </span>            :                 }
<span class="lineNum">   13882 </span>            : 
<span class="lineNum">   13883 </span>            :                 /* SMDI voicemail notification */
<span class="lineNum">   13884 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;smdienable&quot;)) &amp;&amp; ast_true(val)) {</span>
<span class="lineNum">   13885 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;Enabled SMDI voicemail notification\n&quot;);</span>
<span class="lineNum">   13886 </span><span class="lineNoCov">          0 :                         if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;smdiport&quot;))) {</span>
<span class="lineNum">   13887 </span><span class="lineNoCov">          0 :                                 smdi_iface = ast_smdi_interface_find(val);</span>
<span class="lineNum">   13888 </span>            :                         } else {
<span class="lineNum">   13889 </span><span class="lineNoCov">          0 :                                 ast_debug(1, &quot;No SMDI interface set, trying default (/dev/ttyS0)\n&quot;);</span>
<span class="lineNum">   13890 </span><span class="lineNoCov">          0 :                                 smdi_iface = ast_smdi_interface_find(&quot;/dev/ttyS0&quot;);</span>
<span class="lineNum">   13891 </span>            :                         }
<span class="lineNum">   13892 </span><span class="lineNoCov">          0 :                         if (!smdi_iface) {</span>
<span class="lineNum">   13893 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_ERROR, &quot;No valid SMDI interface specfied, disabling SMDI voicemail notification\n&quot;);</span>
<span class="lineNum">   13894 </span>            :                         }
<span class="lineNum">   13895 </span>            :                 }
<span class="lineNum">   13896 </span>            : 
<span class="lineNum">   13897 </span>            :                 /* Silence treshold */
<span class="lineNum">   13898 </span><span class="lineCov">       1074 :                 silencethreshold = ast_dsp_get_threshold_from_settings(THRESHOLD_SILENCE);</span>
<span class="lineNum">   13899 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;silencethreshold&quot;)))</span>
<span class="lineNum">   13900 </span><span class="lineCov">       1068 :                         silencethreshold = atoi(val);</span>
<span class="lineNum">   13901 </span>            : 
<span class="lineNum">   13902 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;serveremail&quot;)))</span>
<span class="lineNum">   13903 </span><span class="lineCov">         37 :                         val = ASTERISK_USERNAME;</span>
<span class="lineNum">   13904 </span><span class="lineCov">       1074 :                 ast_copy_string(serveremail, val, sizeof(serveremail));</span>
<span class="lineNum">   13905 </span>            : 
<span class="lineNum">   13906 </span><span class="lineCov">       1074 :                 vmmaxsecs = 0;</span>
<span class="lineNum">   13907 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxsecs&quot;))) {</span>
<span class="lineNum">   13908 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13909 </span><span class="lineNoCov">          0 :                                 vmmaxsecs = x;</span>
<span class="lineNum">   13910 </span>            :                         } else {
<span class="lineNum">   13911 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid max message time length\n&quot;);</span>
<span class="lineNum">   13912 </span>            :                         }
<span class="lineNum">   13913 </span><span class="lineCov">       1074 :                 } else if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxmessage&quot;))) {</span>
<span class="lineNum">   13914 </span>            :                         static int maxmessage_deprecate = 0;
<span class="lineNum">   13915 </span><span class="lineNoCov">          0 :                         if (maxmessage_deprecate == 0) {</span>
<span class="lineNum">   13916 </span><span class="lineNoCov">          0 :                                 maxmessage_deprecate = 1;</span>
<span class="lineNum">   13917 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Setting 'maxmessage' has been deprecated in favor of 'maxsecs'.\n&quot;);</span>
<span class="lineNum">   13918 </span>            :                         }
<span class="lineNum">   13919 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13920 </span><span class="lineNoCov">          0 :                                 vmmaxsecs = x;</span>
<span class="lineNum">   13921 </span>            :                         } else {
<span class="lineNum">   13922 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid max message time length\n&quot;);</span>
<span class="lineNum">   13923 </span>            :                         }
<span class="lineNum">   13924 </span>            :                 }
<span class="lineNum">   13925 </span>            : 
<span class="lineNum">   13926 </span><span class="lineCov">       1074 :                 vmminsecs = 0;</span>
<span class="lineNum">   13927 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;minsecs&quot;))) {</span>
<span class="lineNum">   13928 </span><span class="lineCov">         31 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13929 </span><span class="lineCov">         31 :                                 vmminsecs = x;</span>
<span class="lineNum">   13930 </span><span class="lineCov">         31 :                                 if (maxsilence / 1000 &gt;= vmminsecs) {</span>
<span class="lineNum">   13931 </span><span class="lineCov">         31 :                                         ast_log(AST_LOG_WARNING, &quot;maxsilence should be less than minsecs or you may get empty messages\n&quot;);</span>
<span class="lineNum">   13932 </span>            :                                 }
<span class="lineNum">   13933 </span>            :                         } else {
<span class="lineNum">   13934 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid min message time length\n&quot;);</span>
<span class="lineNum">   13935 </span>            :                         }
<span class="lineNum">   13936 </span><span class="lineCov">       1043 :                 } else if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;minmessage&quot;))) {</span>
<span class="lineNum">   13937 </span>            :                         static int maxmessage_deprecate = 0;
<span class="lineNum">   13938 </span><span class="lineNoCov">          0 :                         if (maxmessage_deprecate == 0) {</span>
<span class="lineNum">   13939 </span><span class="lineNoCov">          0 :                                 maxmessage_deprecate = 1;</span>
<span class="lineNum">   13940 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Setting 'minmessage' has been deprecated in favor of 'minsecs'.\n&quot;);</span>
<span class="lineNum">   13941 </span>            :                         }
<span class="lineNum">   13942 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13943 </span><span class="lineNoCov">          0 :                                 vmminsecs = x;</span>
<span class="lineNum">   13944 </span><span class="lineNoCov">          0 :                                 if (maxsilence / 1000 &gt;= vmminsecs) {</span>
<span class="lineNum">   13945 </span><span class="lineNoCov">          0 :                                         ast_log(AST_LOG_WARNING, &quot;maxsilence should be less than minmessage or you may get empty messages\n&quot;);</span>
<span class="lineNum">   13946 </span>            :                                 }
<span class="lineNum">   13947 </span>            :                         } else {
<span class="lineNum">   13948 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid min message time length\n&quot;);</span>
<span class="lineNum">   13949 </span>            :                         }
<span class="lineNum">   13950 </span>            :                 }
<span class="lineNum">   13951 </span>            : 
<span class="lineNum">   13952 </span><span class="lineCov">       1074 :                 val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;format&quot;);</span>
<span class="lineNum">   13953 </span><span class="lineCov">       1074 :                 if (!val) {</span>
<span class="lineNum">   13954 </span><span class="lineCov">          6 :                         val = &quot;wav&quot;;</span>
<span class="lineNum">   13955 </span>            :                 } else {
<span class="lineNum">   13956 </span><span class="lineCov">       1068 :                         tmp = ast_strdupa(val);</span>
<span class="lineNum">   13957 </span><span class="lineCov">       1068 :                         val = ast_format_str_reduce(tmp);</span>
<span class="lineNum">   13958 </span><span class="lineCov">       1068 :                         if (!val) {</span>
<span class="lineNum">   13959 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR, &quot;Error processing format string, defaulting to format 'wav'\n&quot;);</span>
<span class="lineNum">   13960 </span><span class="lineNoCov">          0 :                                 val = &quot;wav&quot;;</span>
<span class="lineNum">   13961 </span>            :                         }
<span class="lineNum">   13962 </span>            :                 }
<span class="lineNum">   13963 </span><span class="lineCov">       1074 :                 ast_copy_string(vmfmts, val, sizeof(vmfmts));</span>
<span class="lineNum">   13964 </span>            : 
<span class="lineNum">   13965 </span><span class="lineCov">       1074 :                 skipms = 3000;</span>
<span class="lineNum">   13966 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxgreet&quot;))) {</span>
<span class="lineNum">   13967 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13968 </span><span class="lineNoCov">          0 :                                 maxgreet = x;</span>
<span class="lineNum">   13969 </span>            :                         } else {
<span class="lineNum">   13970 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid max message greeting length\n&quot;);</span>
<span class="lineNum">   13971 </span>            :                         }
<span class="lineNum">   13972 </span>            :                 }
<span class="lineNum">   13973 </span>            : 
<span class="lineNum">   13974 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;skipms&quot;))) {</span>
<span class="lineNum">   13975 </span><span class="lineCov">       1068 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13976 </span><span class="lineCov">       1068 :                                 skipms = x;</span>
<span class="lineNum">   13977 </span>            :                         } else {
<span class="lineNum">   13978 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid skipms value\n&quot;);</span>
<span class="lineNum">   13979 </span>            :                         }
<span class="lineNum">   13980 </span>            :                 }
<span class="lineNum">   13981 </span>            : 
<span class="lineNum">   13982 </span><span class="lineCov">       1074 :                 maxlogins = 3;</span>
<span class="lineNum">   13983 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;maxlogins&quot;))) {</span>
<span class="lineNum">   13984 </span><span class="lineCov">       1068 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13985 </span><span class="lineCov">       1068 :                                 maxlogins = x;</span>
<span class="lineNum">   13986 </span>            :                         } else {
<span class="lineNum">   13987 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid max failed login attempts\n&quot;);</span>
<span class="lineNum">   13988 </span>            :                         }
<span class="lineNum">   13989 </span>            :                 }
<span class="lineNum">   13990 </span>            : 
<span class="lineNum">   13991 </span><span class="lineCov">       1074 :                 minpassword = MINPASSWORD;</span>
<span class="lineNum">   13992 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;minpassword&quot;))) {</span>
<span class="lineNum">   13993 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   13994 </span><span class="lineNoCov">          0 :                                 minpassword = x;</span>
<span class="lineNum">   13995 </span>            :                         } else {
<span class="lineNum">   13996 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid minimum password length.  Default to %d\n&quot;, minpassword);</span>
<span class="lineNum">   13997 </span>            :                         }
<span class="lineNum">   13998 </span>            :                 }
<span class="lineNum">   13999 </span>            : 
<span class="lineNum">   14000 </span>            :                 /* Force new user to record name ? */
<span class="lineNum">   14001 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;forcename&quot;)))</span>
<span class="lineNum">   14002 </span><span class="lineCov">       1072 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14003 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_FORCENAME);</span>
<span class="lineNum">   14004 </span>            : 
<span class="lineNum">   14005 </span>            :                 /* Force new user to record greetings ? */
<span class="lineNum">   14006 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;forcegreetings&quot;)))</span>
<span class="lineNum">   14007 </span><span class="lineCov">       1072 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14008 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_FORCEGREET);</span>
<span class="lineNum">   14009 </span>            : 
<span class="lineNum">   14010 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;cidinternalcontexts&quot;))) {</span>
<span class="lineNum">   14011 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;VM_CID Internal context string: %s\n&quot;, val);</span>
<span class="lineNum">   14012 </span><span class="lineNoCov">          0 :                         stringp = ast_strdupa(val);</span>
<span class="lineNum">   14013 </span><span class="lineNoCov">          0 :                         for (x = 0 ; x &lt; MAX_NUM_CID_CONTEXTS ; x++){</span>
<span class="lineNum">   14014 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(stringp)) {</span>
<span class="lineNum">   14015 </span><span class="lineNoCov">          0 :                                         q = strsep(&amp;stringp, &quot;,&quot;);</span>
<span class="lineNum">   14016 </span><span class="lineNoCov">          0 :                                         while ((*q == ' ')||(*q == '\t')) /* Eat white space between contexts */</span>
<span class="lineNum">   14017 </span><span class="lineNoCov">          0 :                                                 q++;</span>
<span class="lineNum">   14018 </span><span class="lineNoCov">          0 :                                         ast_copy_string(cidinternalcontexts[x], q, sizeof(cidinternalcontexts[x]));</span>
<span class="lineNum">   14019 </span><span class="lineNoCov">          0 :                                         ast_debug(1, &quot;VM_CID Internal context %d: %s\n&quot;, x, cidinternalcontexts[x]);</span>
<span class="lineNum">   14020 </span>            :                                 } else {
<span class="lineNum">   14021 </span><span class="lineNoCov">          0 :                                         cidinternalcontexts[x][0] = '\0';</span>
<span class="lineNum">   14022 </span>            :                                 }
<span class="lineNum">   14023 </span>            :                         }
<span class="lineNum">   14024 </span>            :                 }
<span class="lineNum">   14025 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;review&quot;))){</span>
<span class="lineNum">   14026 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;VM Review Option disabled globally\n&quot;);</span>
<span class="lineNum">   14027 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14028 </span>            :                 }
<span class="lineNum">   14029 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_REVIEW);</span>
<span class="lineNum">   14030 </span>            : 
<span class="lineNum">   14031 </span>            :                 /* Temporary greeting reminder */
<span class="lineNum">   14032 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;tempgreetwarn&quot;))) {</span>
<span class="lineNum">   14033 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;VM Temporary Greeting Reminder Option disabled globally\n&quot;);</span>
<span class="lineNum">   14034 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14035 </span>            :                 } else {
<span class="lineNum">   14036 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;VM Temporary Greeting Reminder Option enabled globally\n&quot;);</span>
<span class="lineNum">   14037 </span>            :                 }
<span class="lineNum">   14038 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_TEMPGREETWARN);</span>
<span class="lineNum">   14039 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;messagewrap&quot;))){</span>
<span class="lineNum">   14040 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;VM next message wrap disabled globally\n&quot;);</span>
<span class="lineNum">   14041 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14042 </span>            :                 }
<span class="lineNum">   14043 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_MESSAGEWRAP);</span>
<span class="lineNum">   14044 </span>            : 
<span class="lineNum">   14045 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;operator&quot;))){</span>
<span class="lineNum">   14046 </span><span class="lineCov">       1068 :                         ast_debug(1, &quot;VM Operator break disabled globally\n&quot;);</span>
<span class="lineNum">   14047 </span><span class="lineCov">       1068 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14048 </span>            :                 }
<span class="lineNum">   14049 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_OPERATOR);</span>
<span class="lineNum">   14050 </span>            : 
<span class="lineNum">   14051 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;saycid&quot;))) {</span>
<span class="lineNum">   14052 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;VM CID Info before msg disabled globally\n&quot;);</span>
<span class="lineNum">   14053 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14054 </span>            :                 }
<span class="lineNum">   14055 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_SAYCID);</span>
<span class="lineNum">   14056 </span>            : 
<span class="lineNum">   14057 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;sendvoicemail&quot;))){</span>
<span class="lineNum">   14058 </span><span class="lineCov">         37 :                         ast_debug(1, &quot;Send Voicemail msg disabled globally\n&quot;);</span>
<span class="lineNum">   14059 </span><span class="lineCov">         37 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14060 </span>            :                 }
<span class="lineNum">   14061 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_SVMAIL);</span>
<span class="lineNum">   14062 </span>            : 
<span class="lineNum">   14063 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;envelope&quot;))) {</span>
<span class="lineNum">   14064 </span><span class="lineCov">       1073 :                         ast_debug(1, &quot;ENVELOPE before msg enabled globally\n&quot;);</span>
<span class="lineNum">   14065 </span><span class="lineCov">       1073 :                         val = &quot;yes&quot;;</span>
<span class="lineNum">   14066 </span>            :                 }
<span class="lineNum">   14067 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_ENVELOPE);</span>
<span class="lineNum">   14068 </span>            : 
<span class="lineNum">   14069 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;moveheard&quot;))) {</span>
<span class="lineNum">   14070 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;Move Heard enabled globally\n&quot;);</span>
<span class="lineNum">   14071 </span><span class="lineCov">       1074 :                         val = &quot;yes&quot;;</span>
<span class="lineNum">   14072 </span>            :                 }
<span class="lineNum">   14073 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_MOVEHEARD);</span>
<span class="lineNum">   14074 </span>            : 
<span class="lineNum">   14075 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;forward_urgent_auto&quot;))) {</span>
<span class="lineNum">   14076 </span><span class="lineCov">       1073 :                         ast_debug(1, &quot;Autoset of Urgent flag on forwarded Urgent messages disabled globally\n&quot;);</span>
<span class="lineNum">   14077 </span><span class="lineCov">       1073 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14078 </span>            :                 }
<span class="lineNum">   14079 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_FWDURGAUTO);</span>
<span class="lineNum">   14080 </span>            : 
<span class="lineNum">   14081 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;sayduration&quot;))) {</span>
<span class="lineNum">   14082 </span><span class="lineCov">       1074 :                         ast_debug(1, &quot;Duration info before msg enabled globally\n&quot;);</span>
<span class="lineNum">   14083 </span><span class="lineCov">       1074 :                         val = &quot;yes&quot;;</span>
<span class="lineNum">   14084 </span>            :                 }
<span class="lineNum">   14085 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_SAYDURATION);</span>
<span class="lineNum">   14086 </span>            : 
<span class="lineNum">   14087 </span><span class="lineCov">       1074 :                 saydurationminfo = 2;</span>
<span class="lineNum">   14088 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;saydurationm&quot;))) {</span>
<span class="lineNum">   14089 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30d&quot;, &amp;x) == 1) {</span>
<span class="lineNum">   14090 </span><span class="lineNoCov">          0 :                                 saydurationminfo = x;</span>
<span class="lineNum">   14091 </span>            :                         } else {
<span class="lineNum">   14092 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid min duration for say duration\n&quot;);</span>
<span class="lineNum">   14093 </span>            :                         }
<span class="lineNum">   14094 </span>            :                 }
<span class="lineNum">   14095 </span>            : 
<span class="lineNum">   14096 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;nextaftercmd&quot;))) {</span>
<span class="lineNum">   14097 </span><span class="lineCov">       1070 :                         ast_debug(1, &quot;We are not going to skip to the next msg after save/delete\n&quot;);</span>
<span class="lineNum">   14098 </span><span class="lineCov">       1070 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14099 </span>            :                 }
<span class="lineNum">   14100 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_SKIPAFTERCMD);</span>
<span class="lineNum">   14101 </span>            : 
<span class="lineNum">   14102 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;dialout&quot;))) {</span>
<span class="lineNum">   14103 </span><span class="lineCov">          1 :                         ast_copy_string(dialcontext, val, sizeof(dialcontext));</span>
<span class="lineNum">   14104 </span><span class="lineCov">          1 :                         ast_debug(1, &quot;found dialout context: %s\n&quot;, dialcontext);</span>
<span class="lineNum">   14105 </span>            :                 } else {
<span class="lineNum">   14106 </span><span class="lineCov">       1073 :                         dialcontext[0] = '\0';</span>
<span class="lineNum">   14107 </span>            :                 }
<span class="lineNum">   14108 </span>            : 
<span class="lineNum">   14109 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;callback&quot;))) {</span>
<span class="lineNum">   14110 </span><span class="lineCov">          2 :                         ast_copy_string(callcontext, val, sizeof(callcontext));</span>
<span class="lineNum">   14111 </span><span class="lineCov">          2 :                         ast_debug(1, &quot;found callback context: %s\n&quot;, callcontext);</span>
<span class="lineNum">   14112 </span>            :                 } else {
<span class="lineNum">   14113 </span><span class="lineCov">       1072 :                         callcontext[0] = '\0';</span>
<span class="lineNum">   14114 </span>            :                 }
<span class="lineNum">   14115 </span>            : 
<span class="lineNum">   14116 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;exitcontext&quot;))) {</span>
<span class="lineNum">   14117 </span><span class="lineNoCov">          0 :                         ast_copy_string(exitcontext, val, sizeof(exitcontext));</span>
<span class="lineNum">   14118 </span><span class="lineNoCov">          0 :                         ast_debug(1, &quot;found operator context: %s\n&quot;, exitcontext);</span>
<span class="lineNum">   14119 </span>            :                 } else {
<span class="lineNum">   14120 </span><span class="lineCov">       1074 :                         exitcontext[0] = '\0';</span>
<span class="lineNum">   14121 </span>            :                 }
<span class="lineNum">   14122 </span>            : 
<span class="lineNum">   14123 </span>            :                 /* load password sounds configuration */
<span class="lineNum">   14124 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-login&quot;)))</span>
<span class="lineNum">   14125 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_login, val, sizeof(vm_login));</span>
<span class="lineNum">   14126 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-newuser&quot;)))</span>
<span class="lineNum">   14127 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_newuser, val, sizeof(vm_newuser));</span>
<span class="lineNum">   14128 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-password&quot;)))</span>
<span class="lineNum">   14129 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_password, val, sizeof(vm_password));</span>
<span class="lineNum">   14130 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-newpassword&quot;)))</span>
<span class="lineNum">   14131 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_newpassword, val, sizeof(vm_newpassword));</span>
<span class="lineNum">   14132 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-invalid-password&quot;)))</span>
<span class="lineNum">   14133 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_invalid_password, val, sizeof(vm_invalid_password));</span>
<span class="lineNum">   14134 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-passchanged&quot;)))</span>
<span class="lineNum">   14135 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_passchanged, val, sizeof(vm_passchanged));</span>
<span class="lineNum">   14136 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-reenterpassword&quot;)))</span>
<span class="lineNum">   14137 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_reenterpassword, val, sizeof(vm_reenterpassword));</span>
<span class="lineNum">   14138 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-mismatch&quot;)))</span>
<span class="lineNum">   14139 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_mismatch, val, sizeof(vm_mismatch));</span>
<span class="lineNum">   14140 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-pls-try-again&quot;))) {</span>
<span class="lineNum">   14141 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_pls_try_again, val, sizeof(vm_pls_try_again));</span>
<span class="lineNum">   14142 </span>            :                 }
<span class="lineNum">   14143 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;vm-prepend-timeout&quot;))) {</span>
<span class="lineNum">   14144 </span><span class="lineNoCov">          0 :                         ast_copy_string(vm_prepend_timeout, val, sizeof(vm_prepend_timeout));</span>
<span class="lineNum">   14145 </span>            :                 }
<span class="lineNum">   14146 </span>            :                 /* load configurable audio prompts */
<span class="lineNum">   14147 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;listen-control-forward-key&quot;)) &amp;&amp; is_valid_dtmf(val))</span>
<span class="lineNum">   14148 </span><span class="lineNoCov">          0 :                         ast_copy_string(listen_control_forward_key, val, sizeof(listen_control_forward_key));</span>
<span class="lineNum">   14149 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;listen-control-reverse-key&quot;)) &amp;&amp; is_valid_dtmf(val))</span>
<span class="lineNum">   14150 </span><span class="lineNoCov">          0 :                         ast_copy_string(listen_control_reverse_key, val, sizeof(listen_control_reverse_key));</span>
<span class="lineNum">   14151 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;listen-control-pause-key&quot;)) &amp;&amp; is_valid_dtmf(val))</span>
<span class="lineNum">   14152 </span><span class="lineNoCov">          0 :                         ast_copy_string(listen_control_pause_key, val, sizeof(listen_control_pause_key));</span>
<span class="lineNum">   14153 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;listen-control-restart-key&quot;)) &amp;&amp; is_valid_dtmf(val))</span>
<span class="lineNum">   14154 </span><span class="lineNoCov">          0 :                         ast_copy_string(listen_control_restart_key, val, sizeof(listen_control_restart_key));</span>
<span class="lineNum">   14155 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;listen-control-stop-key&quot;)) &amp;&amp; is_valid_dtmf(val))</span>
<span class="lineNum">   14156 </span><span class="lineNoCov">          0 :                         ast_copy_string(listen_control_stop_key, val, sizeof(listen_control_stop_key));</span>
<span class="lineNum">   14157 </span>            : 
<span class="lineNum">   14158 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;usedirectory&quot;)))</span>
<span class="lineNum">   14159 </span><span class="lineCov">       1074 :                         val = &quot;no&quot;;</span>
<span class="lineNum">   14160 </span><span class="lineCov">       1074 :                 ast_set2_flag((&amp;globalflags), ast_true(val), VM_DIRECFORWARD);</span>
<span class="lineNum">   14161 </span>            : 
<span class="lineNum">   14162 </span><span class="lineCov">       1074 :                 if (!(val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;passwordlocation&quot;))) {</span>
<span class="lineNum">   14163 </span><span class="lineCov">       1073 :                         val = &quot;voicemail.conf&quot;;</span>
<span class="lineNum">   14164 </span>            :                 }
<span class="lineNum">   14165 </span><span class="lineCov">       1074 :                 if (!(strcmp(val, &quot;spooldir&quot;))) {</span>
<span class="lineNum">   14166 </span><span class="lineCov">          1 :                         passwordlocation = OPT_PWLOC_SPOOLDIR;</span>
<span class="lineNum">   14167 </span>            :                 } else {
<span class="lineNum">   14168 </span><span class="lineCov">       1073 :                         passwordlocation = OPT_PWLOC_VOICEMAILCONF;</span>
<span class="lineNum">   14169 </span>            :                 }
<span class="lineNum">   14170 </span>            : 
<span class="lineNum">   14171 </span><span class="lineCov">       1074 :                 poll_freq = DEFAULT_POLL_FREQ;</span>
<span class="lineNum">   14172 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pollfreq&quot;))) {</span>
<span class="lineNum">   14173 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30u&quot;, &amp;poll_freq) != 1) {</span>
<span class="lineNum">   14174 </span><span class="lineNoCov">          0 :                                 poll_freq = DEFAULT_POLL_FREQ;</span>
<span class="lineNum">   14175 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_ERROR, &quot;'%s' is not a valid value for the pollfreq option!\n&quot;, val);</span>
<span class="lineNum">   14176 </span>            :                         }
<span class="lineNum">   14177 </span>            :                 }
<span class="lineNum">   14178 </span>            : 
<span class="lineNum">   14179 </span><span class="lineCov">       1074 :                 poll_mailboxes = 0;</span>
<span class="lineNum">   14180 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pollmailboxes&quot;)))</span>
<span class="lineNum">   14181 </span><span class="lineNoCov">          0 :                         poll_mailboxes = ast_true(val);</span>
<span class="lineNum">   14182 </span>            : 
<span class="lineNum">   14183 </span><span class="lineCov">       1074 :                 memset(fromstring, 0, sizeof(fromstring));</span>
<span class="lineNum">   14184 </span><span class="lineCov">       1074 :                 memset(pagerfromstring, 0, sizeof(pagerfromstring));</span>
<span class="lineNum">   14185 </span><span class="lineCov">       1074 :                 strcpy(charset, &quot;ISO-8859-1&quot;);</span>
<span class="lineNum">   14186 </span><span class="lineCov">       1074 :                 if (emailbody) {</span>
<span class="lineNum">   14187 </span><span class="lineNoCov">          0 :                         ast_free(emailbody);</span>
<span class="lineNum">   14188 </span><span class="lineNoCov">          0 :                         emailbody = NULL;</span>
<span class="lineNum">   14189 </span>            :                 }
<span class="lineNum">   14190 </span><span class="lineCov">       1074 :                 if (emailsubject) {</span>
<span class="lineNum">   14191 </span><span class="lineNoCov">          0 :                         ast_free(emailsubject);</span>
<span class="lineNum">   14192 </span><span class="lineNoCov">          0 :                         emailsubject = NULL;</span>
<span class="lineNum">   14193 </span>            :                 }
<span class="lineNum">   14194 </span><span class="lineCov">       1074 :                 if (pagerbody) {</span>
<span class="lineNum">   14195 </span><span class="lineNoCov">          0 :                         ast_free(pagerbody);</span>
<span class="lineNum">   14196 </span><span class="lineNoCov">          0 :                         pagerbody = NULL;</span>
<span class="lineNum">   14197 </span>            :                 }
<span class="lineNum">   14198 </span><span class="lineCov">       1074 :                 if (pagersubject) {</span>
<span class="lineNum">   14199 </span><span class="lineNoCov">          0 :                         ast_free(pagersubject);</span>
<span class="lineNum">   14200 </span><span class="lineNoCov">          0 :                         pagersubject = NULL;</span>
<span class="lineNum">   14201 </span>            :                 }
<span class="lineNum">   14202 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pbxskip&quot;)))</span>
<span class="lineNum">   14203 </span><span class="lineNoCov">          0 :                         ast_set2_flag((&amp;globalflags), ast_true(val), VM_PBXSKIP);</span>
<span class="lineNum">   14204 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;fromstring&quot;)))</span>
<span class="lineNum">   14205 </span><span class="lineNoCov">          0 :                         ast_copy_string(fromstring, val, sizeof(fromstring));</span>
<span class="lineNum">   14206 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pagerfromstring&quot;)))</span>
<span class="lineNum">   14207 </span><span class="lineNoCov">          0 :                         ast_copy_string(pagerfromstring, val, sizeof(pagerfromstring));</span>
<span class="lineNum">   14208 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;charset&quot;)))</span>
<span class="lineNum">   14209 </span><span class="lineNoCov">          0 :                         ast_copy_string(charset, val, sizeof(charset));</span>
<span class="lineNum">   14210 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;adsifdn&quot;))) {</span>
<span class="lineNum">   14211 </span><span class="lineNoCov">          0 :                         sscanf(val, &quot;%2x%2x%2x%2x&quot;, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);</span>
<span class="lineNum">   14212 </span><span class="lineNoCov">          0 :                         for (x = 0; x &lt; 4; x++) {</span>
<span class="lineNum">   14213 </span><span class="lineNoCov">          0 :                                 memcpy(&amp;adsifdn[x], &amp;tmpadsi[x], 1);</span>
<span class="lineNum">   14214 </span>            :                         }
<span class="lineNum">   14215 </span>            :                 }
<span class="lineNum">   14216 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;adsisec&quot;))) {</span>
<span class="lineNum">   14217 </span><span class="lineNoCov">          0 :                         sscanf(val, &quot;%2x%2x%2x%2x&quot;, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);</span>
<span class="lineNum">   14218 </span><span class="lineNoCov">          0 :                         for (x = 0; x &lt; 4; x++) {</span>
<span class="lineNum">   14219 </span><span class="lineNoCov">          0 :                                 memcpy(&amp;adsisec[x], &amp;tmpadsi[x], 1);</span>
<span class="lineNum">   14220 </span>            :                         }
<span class="lineNum">   14221 </span>            :                 }
<span class="lineNum">   14222 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;adsiver&quot;))) {</span>
<span class="lineNum">   14223 </span><span class="lineNoCov">          0 :                         if (atoi(val)) {</span>
<span class="lineNum">   14224 </span><span class="lineNoCov">          0 :                                 adsiver = atoi(val);</span>
<span class="lineNum">   14225 </span>            :                         }
<span class="lineNum">   14226 </span>            :                 }
<span class="lineNum">   14227 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;tz&quot;))) {</span>
<span class="lineNum">   14228 </span><span class="lineCov">          1 :                         ast_copy_string(zonetag, val, sizeof(zonetag));</span>
<span class="lineNum">   14229 </span>            :                 }
<span class="lineNum">   14230 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;locale&quot;))) {</span>
<span class="lineNum">   14231 </span><span class="lineCov">          1 :                         ast_copy_string(locale, val, sizeof(locale));</span>
<span class="lineNum">   14232 </span>            :                 }
<span class="lineNum">   14233 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;emailsubject&quot;))) {</span>
<span class="lineNum">   14234 </span><span class="lineNoCov">          0 :                         emailsubject = ast_strdup(substitute_escapes(val));</span>
<span class="lineNum">   14235 </span>            :                 }
<span class="lineNum">   14236 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;emailbody&quot;))) {</span>
<span class="lineNum">   14237 </span><span class="lineNoCov">          0 :                         emailbody = ast_strdup(substitute_escapes(val));</span>
<span class="lineNum">   14238 </span>            :                 }
<span class="lineNum">   14239 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pagersubject&quot;))) {</span>
<span class="lineNum">   14240 </span><span class="lineNoCov">          0 :                         pagersubject = ast_strdup(substitute_escapes(val));</span>
<span class="lineNum">   14241 </span>            :                 }
<span class="lineNum">   14242 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;pagerbody&quot;))) {</span>
<span class="lineNum">   14243 </span><span class="lineNoCov">          0 :                         pagerbody = ast_strdup(substitute_escapes(val));</span>
<span class="lineNum">   14244 </span>            :                 }
<span class="lineNum">   14245 </span>            : 
<span class="lineNum">   14246 </span><span class="lineCov">       1074 :                 tps_queue_high = AST_TASKPROCESSOR_HIGH_WATER_LEVEL;</span>
<span class="lineNum">   14247 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;tps_queue_high&quot;))) {</span>
<span class="lineNum">   14248 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30ld&quot;, &amp;tps_queue_high) != 1 || tps_queue_high &lt;= 0) {</span>
<span class="lineNum">   14249 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid the taskprocessor high water alert trigger level '%s'\n&quot;, val);</span>
<span class="lineNum">   14250 </span><span class="lineNoCov">          0 :                                 tps_queue_high = AST_TASKPROCESSOR_HIGH_WATER_LEVEL;</span>
<span class="lineNum">   14251 </span>            :                         }
<span class="lineNum">   14252 </span>            :                 }
<span class="lineNum">   14253 </span><span class="lineCov">       1074 :                 tps_queue_low = -1;</span>
<span class="lineNum">   14254 </span><span class="lineCov">       1074 :                 if ((val = ast_variable_retrieve(cfg, &quot;general&quot;, &quot;tps_queue_low&quot;))) {</span>
<span class="lineNum">   14255 </span><span class="lineNoCov">          0 :                         if (sscanf(val, &quot;%30ld&quot;, &amp;tps_queue_low) != 1 ||</span>
<span class="lineNum">   14256 </span><span class="lineNoCov">          0 :                                 tps_queue_low &lt; -1 || tps_queue_high &lt; tps_queue_low) {</span>
<span class="lineNum">   14257 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Invalid the taskprocessor low water clear alert level '%s'\n&quot;, val);</span>
<span class="lineNum">   14258 </span><span class="lineNoCov">          0 :                                 tps_queue_low = -1;</span>
<span class="lineNum">   14259 </span>            :                         }
<span class="lineNum">   14260 </span>            :                 }
<span class="lineNum">   14261 </span><span class="lineCov">       1074 :                 if (ast_taskprocessor_alert_set_levels(mwi_subscription_tps, tps_queue_low, tps_queue_high)) {</span>
<span class="lineNum">   14262 </span><span class="lineNoCov">          0 :                         ast_log(AST_LOG_WARNING, &quot;Failed to set alert levels for voicemail taskprocessor.\n&quot;);</span>
<span class="lineNum">   14263 </span>            :                 }
<span class="lineNum">   14264 </span>            : 
<span class="lineNum">   14265 </span>            :                 /* load mailboxes from users.conf */
<span class="lineNum">   14266 </span><span class="lineCov">       1074 :                 if (ucfg) {</span>
<span class="lineNum">   14267 </span><span class="lineCov">       2148 :                         for (cat = ast_category_browse(ucfg, NULL); cat ; cat = ast_category_browse(ucfg, cat)) {</span>
<span class="lineNum">   14268 </span><span class="lineCov">       1075 :                                 if (!strcasecmp(cat, &quot;general&quot;)) {</span>
<span class="lineNum">   14269 </span><span class="lineCov">       1072 :                                         continue;</span>
<span class="lineNum">   14270 </span>            :                                 }
<span class="lineNum">   14271 </span><span class="lineCov">          3 :                                 if (!ast_true(ast_config_option(ucfg, cat, &quot;hasvoicemail&quot;)))</span>
<span class="lineNum">   14272 </span><span class="lineCov">          3 :                                         continue;</span>
<span class="lineNum">   14273 </span><span class="lineNoCov">          0 :                                 if ((current = find_or_create(userscontext, cat))) {</span>
<span class="lineNum">   14274 </span><span class="lineNoCov">          0 :                                         populate_defaults(current);</span>
<span class="lineNum">   14275 </span><span class="lineNoCov">          0 :                                         apply_options_full(current, ast_variable_browse(ucfg, cat));</span>
<span class="lineNum">   14276 </span><span class="lineNoCov">          0 :                                         ast_copy_string(current-&gt;context, userscontext, sizeof(current-&gt;context));</span>
<span class="lineNum">   14277 </span><span class="lineNoCov">          0 :                                         if (!ast_strlen_zero(current-&gt;password) &amp;&amp; current-&gt;passwordlocation == OPT_PWLOC_VOICEMAILCONF) {</span>
<span class="lineNum">   14278 </span><span class="lineNoCov">          0 :                                                 current-&gt;passwordlocation = OPT_PWLOC_USERSCONF;</span>
<span class="lineNum">   14279 </span>            :                                         }
<span class="lineNum">   14280 </span>            : 
<span class="lineNum">   14281 </span><span class="lineNoCov">          0 :                                         switch (current-&gt;passwordlocation) {</span>
<span class="lineNum">   14282 </span><span class="lineNoCov">          0 :                                         case OPT_PWLOC_SPOOLDIR:</span>
<span class="lineNum">   14283 </span><span class="lineNoCov">          0 :                                                 snprintf(secretfn, sizeof(secretfn), &quot;%s%s/%s/secret.conf&quot;, VM_SPOOL_DIR, current-&gt;context, current-&gt;mailbox);</span>
<span class="lineNum">   14284 </span><span class="lineNoCov">          0 :                                                 read_password_from_file(secretfn, current-&gt;password, sizeof(current-&gt;password));</span>
<span class="lineNum">   14285 </span>            :                                         }
<span class="lineNum">   14286 </span>            :                                 }
<span class="lineNum">   14287 </span>            :                         }
<span class="lineNum">   14288 </span>            :                 }
<span class="lineNum">   14289 </span>            : 
<span class="lineNum">   14290 </span>            :                 /* load mailboxes from voicemail.conf */
<span class="lineNum">   14291 </span><span class="lineCov">       1074 :                 cat = ast_category_browse(cfg, NULL);</span>
<span class="lineNum">   14292 </span><span class="lineCov">       5325 :                 while (cat) {</span>
<span class="lineNum">   14293 </span><span class="lineCov">       4251 :                         if (strcasecmp(cat, &quot;general&quot;)) {</span>
<span class="lineNum">   14294 </span><span class="lineCov">       3182 :                                 var = ast_variable_browse(cfg, cat);</span>
<span class="lineNum">   14295 </span><span class="lineCov">       3182 :                                 if (strcasecmp(cat, &quot;zonemessages&quot;)) {</span>
<span class="lineNum">   14296 </span>            :                                         /* Process mailboxes in this context */
<span class="lineNum">   14297 </span><span class="lineCov">       4250 :                                         while (var) {</span>
<span class="lineNum">   14298 </span><span class="lineCov">       2135 :                                                 append_mailbox(cat, var-&gt;name, var-&gt;value);</span>
<span class="lineNum">   14299 </span><span class="lineCov">       2135 :                                                 var = var-&gt;next;</span>
<span class="lineNum">   14300 </span>            :                                         }
<span class="lineNum">   14301 </span>            :                                 } else {
<span class="lineNum">   14302 </span>            :                                         /* Timezones in this context */
<span class="lineNum">   14303 </span><span class="lineCov">       6402 :                                         while (var) {</span>
<span class="lineNum">   14304 </span>            :                                                 struct vm_zone *z;
<span class="lineNum">   14305 </span><span class="lineCov">       5335 :                                                 if ((z = ast_malloc(sizeof(*z)))) {</span>
<span class="lineNum">   14306 </span>            :                                                         char *msg_format, *tzone;
<span class="lineNum">   14307 </span><span class="lineCov">       5335 :                                                         msg_format = ast_strdupa(var-&gt;value);</span>
<span class="lineNum">   14308 </span><span class="lineCov">       5335 :                                                         tzone = strsep(&amp;msg_format, &quot;|,&quot;);</span>
<span class="lineNum">   14309 </span><span class="lineCov">       5335 :                                                         if (msg_format) {</span>
<span class="lineNum">   14310 </span><span class="lineCov">       5335 :                                                                 ast_copy_string(z-&gt;name, var-&gt;name, sizeof(z-&gt;name));</span>
<span class="lineNum">   14311 </span><span class="lineCov">       5335 :                                                                 ast_copy_string(z-&gt;timezone, tzone, sizeof(z-&gt;timezone));</span>
<span class="lineNum">   14312 </span><span class="lineCov">       5335 :                                                                 ast_copy_string(z-&gt;msg_format, msg_format, sizeof(z-&gt;msg_format));</span>
<span class="lineNum">   14313 </span><span class="lineCov">       5335 :                                                                 AST_LIST_LOCK(&amp;zones);</span>
<span class="lineNum">   14314 </span><span class="lineCov">       5335 :                                                                 AST_LIST_INSERT_HEAD(&amp;zones, z, list);</span>
<span class="lineNum">   14315 </span><span class="lineCov">       5335 :                                                                 AST_LIST_UNLOCK(&amp;zones);</span>
<span class="lineNum">   14316 </span>            :                                                         } else {
<span class="lineNum">   14317 </span><span class="lineNoCov">          0 :                                                                 ast_log(AST_LOG_WARNING, &quot;Invalid timezone definition at line %d\n&quot;, var-&gt;lineno);</span>
<span class="lineNum">   14318 </span><span class="lineNoCov">          0 :                                                                 ast_free(z);</span>
<span class="lineNum">   14319 </span>            :                                                         }
<span class="lineNum">   14320 </span>            :                                                 } else {
<span class="lineNum">   14321 </span><span class="lineNoCov">          0 :                                                         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   14322 </span><span class="lineNoCov">          0 :                                                         return -1;</span>
<span class="lineNum">   14323 </span>            :                                                 }
<span class="lineNum">   14324 </span><span class="lineCov">       5335 :                                                 var = var-&gt;next;</span>
<span class="lineNum">   14325 </span>            :                                         }
<span class="lineNum">   14326 </span>            :                                 }
<span class="lineNum">   14327 </span>            :                         }
<span class="lineNum">   14328 </span><span class="lineCov">       4251 :                         cat = ast_category_browse(cfg, cat);</span>
<span class="lineNum">   14329 </span>            :                 }
<span class="lineNum">   14330 </span>            : 
<span class="lineNum">   14331 </span><span class="lineCov">       1074 :                 AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   14332 </span>            : 
<span class="lineNum">   14333 </span><span class="lineCov">       1074 :                 if (poll_mailboxes &amp;&amp; poll_thread == AST_PTHREADT_NULL)</span>
<span class="lineNum">   14334 </span><span class="lineNoCov">          0 :                         start_poll_thread();</span>
<span class="lineNum">   14335 </span><span class="lineCov">       1074 :                 if (!poll_mailboxes &amp;&amp; poll_thread != AST_PTHREADT_NULL)</span>
<span class="lineNum">   14336 </span><span class="lineNoCov">          0 :                         stop_poll_thread();;</span>
<span class="lineNum">   14337 </span>            : 
<span class="lineNum">   14338 </span><span class="lineCov">       1074 :                 return 0;</span>
<span class="lineNum">   14339 </span>            :         } else {
<span class="lineNum">   14340 </span><span class="lineNoCov">          0 :                 AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   14341 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Failed to load configuration file.\n&quot;);</span>
<span class="lineNum">   14342 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   14343 </span>            :         }
<a name="14344"><span class="lineNum">   14344 </span>            : }</a>
<span class="lineNum">   14345 </span>            : 
<span class="lineNum">   14346 </span><span class="lineCov">          2 : static int sayname(struct ast_channel *chan, const char *mailbox, const char *context)</span>
<span class="lineNum">   14347 </span>            : {
<span class="lineNum">   14348 </span><span class="lineCov">          2 :         int res = -1;</span>
<span class="lineNum">   14349 </span>            :         char dir[PATH_MAX];
<span class="lineNum">   14350 </span><span class="lineCov">          2 :         snprintf(dir, sizeof(dir), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, context, mailbox);</span>
<span class="lineNum">   14351 </span><span class="lineCov">          2 :         ast_debug(2, &quot;About to try retrieving name file %s\n&quot;, dir);</span>
<span class="lineNum">   14352 </span>            :         RETRIEVE(dir, -1, mailbox, context);
<span class="lineNum">   14353 </span><span class="lineCov">          2 :         if (ast_fileexists(dir, NULL, NULL)) {</span>
<span class="lineNum">   14354 </span><span class="lineNoCov">          0 :                 res = ast_stream_and_wait(chan, dir, AST_DIGIT_ANY);</span>
<span class="lineNum">   14355 </span>            :         }
<span class="lineNum">   14356 </span>            :         DISPOSE(dir, -1);
<span class="lineNum">   14357 </span><span class="lineCov">          2 :         return res;</span>
<span class="lineNum">   14358 </span>            : }
<span class="lineNum">   14359 </span>            : 
<span class="lineNum">   14360 </span>            : /*!
<span class="lineNum">   14361 </span>            :  * \internal
<span class="lineNum">   14362 </span>            :  * \brief Play a recorded user name for the mailbox to the specified channel.
<span class="lineNum">   14363 </span>            :  *
<span class="lineNum">   14364 </span>            :  * \param chan Where to play the recorded name file.
<span class="lineNum">   14365 </span>            :  * \param mailbox_id The mailbox name.
<span class="lineNum">   14366 </span>            :  *
<span class="lineNum">   14367 </span>            :  * \retval 0 Name played without interruption
<span class="lineNum">   14368 </span>            :  * \retval dtmf ASCII value of the DTMF which interrupted playback.
<a name="14369"><span class="lineNum">   14369 </span>            :  * \retval -1 Unable to locate mailbox or hangup occurred.</a>
<span class="lineNum">   14370 </span>            :  */
<span class="lineNum">   14371 </span><span class="lineNoCov">          0 : static int vm_sayname(struct ast_channel *chan, const char *mailbox_id)</span>
<span class="lineNum">   14372 </span>            : {
<span class="lineNum">   14373 </span>            :         char *context;
<span class="lineNum">   14374 </span>            :         char *mailbox;
<span class="lineNum">   14375 </span>            : 
<span class="lineNum">   14376 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(mailbox_id)</span>
<span class="lineNum">   14377 </span><span class="lineNoCov">          0 :                 || separate_mailbox(ast_strdupa(mailbox_id), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">   14378 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   14379 </span>            :         }
<span class="lineNum">   14380 </span><span class="lineNoCov">          0 :         return sayname(chan, mailbox, context);</span>
<a name="14381"><span class="lineNum">   14381 </span>            : }</a>
<span class="lineNum">   14382 </span>            : 
<span class="lineNum">   14383 </span><span class="lineCov">          1 : static void read_password_from_file(const char *secretfn, char *password, int passwordlen) {</span>
<span class="lineNum">   14384 </span>            :         struct ast_config *pwconf;
<span class="lineNum">   14385 </span><span class="lineCov">          1 :         struct ast_flags config_flags = { 0 };</span>
<span class="lineNum">   14386 </span>            : 
<span class="lineNum">   14387 </span><span class="lineCov">          1 :         pwconf = ast_config_load(secretfn, config_flags);</span>
<span class="lineNum">   14388 </span><span class="lineCov">          1 :         if (valid_config(pwconf)) {</span>
<span class="lineNum">   14389 </span><span class="lineNoCov">          0 :                 const char *val = ast_variable_retrieve(pwconf, &quot;general&quot;, &quot;password&quot;);</span>
<span class="lineNum">   14390 </span><span class="lineNoCov">          0 :                 if (val) {</span>
<span class="lineNum">   14391 </span><span class="lineNoCov">          0 :                         ast_copy_string(password, val, passwordlen);</span>
<span class="lineNum">   14392 </span><span class="lineNoCov">          0 :                         ast_config_destroy(pwconf);</span>
<span class="lineNum">   14393 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">   14394 </span>            :                 }
<span class="lineNum">   14395 </span><span class="lineNoCov">          0 :                 ast_config_destroy(pwconf);</span>
<span class="lineNum">   14396 </span>            :         }
<span class="lineNum">   14397 </span><span class="lineCov">          1 :         ast_log(LOG_NOTICE, &quot;Failed reading voicemail password from %s, using secret from config file\n&quot;, secretfn);</span>
<a name="14398"><span class="lineNum">   14398 </span>            : }</a>
<span class="lineNum">   14399 </span>            : 
<span class="lineNum">   14400 </span><span class="lineCov">          1 : static int write_password_to_file(const char *secretfn, const char *password) {</span>
<span class="lineNum">   14401 </span>            :         struct ast_config *conf;
<span class="lineNum">   14402 </span>            :         struct ast_category *cat;
<span class="lineNum">   14403 </span>            :         struct ast_variable *var;
<span class="lineNum">   14404 </span><span class="lineCov">          1 :         int res = -1;</span>
<span class="lineNum">   14405 </span>            : 
<span class="lineNum">   14406 </span><span class="lineCov">          1 :         if (!(conf = ast_config_new())) {</span>
<span class="lineNum">   14407 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Error creating new config structure\n&quot;);</span>
<span class="lineNum">   14408 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">   14409 </span>            :         }
<span class="lineNum">   14410 </span><span class="lineCov">          1 :         if (!(cat = ast_category_new(&quot;general&quot;, &quot;&quot;, 1))) {</span>
<span class="lineNum">   14411 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Error creating new category structure\n&quot;);</span>
<span class="lineNum">   14412 </span><span class="lineNoCov">          0 :                 ast_config_destroy(conf);</span>
<span class="lineNum">   14413 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">   14414 </span>            :         }
<span class="lineNum">   14415 </span><span class="lineCov">          1 :         if (!(var = ast_variable_new(&quot;password&quot;, password, &quot;&quot;))) {</span>
<span class="lineNum">   14416 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Error creating new variable structure\n&quot;);</span>
<span class="lineNum">   14417 </span><span class="lineNoCov">          0 :                 ast_config_destroy(conf);</span>
<span class="lineNum">   14418 </span><span class="lineNoCov">          0 :                 ast_category_destroy(cat);</span>
<span class="lineNum">   14419 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">   14420 </span>            :         }
<span class="lineNum">   14421 </span><span class="lineCov">          1 :         ast_category_append(conf, cat);</span>
<span class="lineNum">   14422 </span><span class="lineCov">          1 :         ast_variable_append(cat, var);</span>
<span class="lineNum">   14423 </span><span class="lineCov">          1 :         if (!ast_config_text_file_save(secretfn, conf, &quot;app_voicemail&quot;)) {</span>
<span class="lineNum">   14424 </span><span class="lineCov">          1 :                 res = 0;</span>
<span class="lineNum">   14425 </span>            :         } else {
<span class="lineNum">   14426 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Error writing voicemail password to %s\n&quot;, secretfn);</span>
<span class="lineNum">   14427 </span>            :         }
<span class="lineNum">   14428 </span>            : 
<span class="lineNum">   14429 </span><span class="lineCov">          1 :         ast_config_destroy(conf);</span>
<span class="lineNum">   14430 </span><span class="lineCov">          1 :         return res;</span>
<a name="14431"><span class="lineNum">   14431 </span>            : }</a>
<span class="lineNum">   14432 </span>            : 
<span class="lineNum">   14433 </span><span class="lineCov">          2 : static int vmsayname_exec(struct ast_channel *chan, const char *data)</span>
<span class="lineNum">   14434 </span>            : {
<span class="lineNum">   14435 </span>            :         char *context;
<span class="lineNum">   14436 </span>            :         char *mailbox;
<span class="lineNum">   14437 </span>            :         int res;
<span class="lineNum">   14438 </span>            : 
<span class="lineNum">   14439 </span><span class="lineCov">          2 :         if (ast_strlen_zero(data)</span>
<span class="lineNum">   14440 </span><span class="lineCov">          2 :                 || separate_mailbox(ast_strdupa(data), &amp;mailbox, &amp;context)) {</span>
<span class="lineNum">   14441 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;VMSayName requires argument mailbox@context\n&quot;);</span>
<span class="lineNum">   14442 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   14443 </span>            :         }
<span class="lineNum">   14444 </span>            : 
<span class="lineNum">   14445 </span><span class="lineCov">          2 :         if ((res = sayname(chan, mailbox, context)) &lt; 0) {</span>
<span class="lineNum">   14446 </span><span class="lineCov">          2 :                 ast_debug(3, &quot;Greeting not found for '%s@%s', falling back to mailbox number.\n&quot;, mailbox, context);</span>
<span class="lineNum">   14447 </span><span class="lineCov">          2 :                 res = ast_stream_and_wait(chan, &quot;vm-extension&quot;, AST_DIGIT_ANY);</span>
<span class="lineNum">   14448 </span><span class="lineCov">          2 :                 if (!res) {</span>
<span class="lineNum">   14449 </span><span class="lineCov">          2 :                         res = ast_say_character_str(chan, mailbox, AST_DIGIT_ANY, ast_channel_language(chan), AST_SAY_CASE_NONE);</span>
<span class="lineNum">   14450 </span>            :                 }
<span class="lineNum">   14451 </span>            :         }
<span class="lineNum">   14452 </span>            : 
<span class="lineNum">   14453 </span><span class="lineCov">          2 :         return res;</span>
<span class="lineNum">   14454 </span>            : }
<a name="14455"><span class="lineNum">   14455 </span>            : </a>
<span class="lineNum">   14456 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   14457 </span><span class="lineCov">        444 : static int fake_write(struct ast_channel *ast, struct ast_frame *frame)</span>
<span class="lineNum">   14458 </span>            : {
<span class="lineNum">   14459 </span><span class="lineCov">        444 :         return 0;</span>
<a name="14460"><span class="lineNum">   14460 </span>            : }</a>
<span class="lineNum">   14461 </span>            : 
<span class="lineNum">   14462 </span><span class="lineNoCov">          0 : static struct ast_frame *fake_read(struct ast_channel *ast)</span>
<span class="lineNum">   14463 </span>            : {
<span class="lineNum">   14464 </span><span class="lineNoCov">          0 :         return &amp;ast_null_frame;</span>
<a name="14465"><span class="lineNum">   14465 </span>            : }</a>
<span class="lineNum">   14466 </span>            : 
<span class="lineNum">   14467 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_vmsayname)</span>
<span class="lineNum">   14468 </span>            : {
<span class="lineNum">   14469 </span>            :         char dir[PATH_MAX];
<span class="lineNum">   14470 </span>            :         char dir2[PATH_MAX];
<span class="lineNum">   14471 </span>            :         static const char TEST_CONTEXT[] = &quot;very_long_unique_context_so_that_nobody_will_ever_have_the_same_one_configured_3141592653&quot;;
<span class="lineNum">   14472 </span>            :         static const char TEST_EXTENSION[] = &quot;1234&quot;;
<span class="lineNum">   14473 </span>            : 
<span class="lineNum">   14474 </span><span class="lineCov">       1074 :         struct ast_channel *test_channel1 = NULL;</span>
<span class="lineNum">   14475 </span><span class="lineCov">       1074 :         int res = -1;</span>
<span class="lineNum">   14476 </span>            :         struct ast_format_cap *capabilities;
<span class="lineNum">   14477 </span>            : 
<span class="lineNum">   14478 </span>            :         static const struct ast_channel_tech fake_tech = {
<span class="lineNum">   14479 </span>            :                 .write = fake_write,
<span class="lineNum">   14480 </span>            :                 .read = fake_read,
<span class="lineNum">   14481 </span>            :         };
<span class="lineNum">   14482 </span>            : 
<span class="lineNum">   14483 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   14484 </span><span class="lineCov">       1073 :         case TEST_INIT:</span>
<span class="lineNum">   14485 </span><span class="lineCov">       1073 :                 info-&gt;name = &quot;vmsayname_exec&quot;;</span>
<span class="lineNum">   14486 </span><span class="lineCov">       1073 :                 info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   14487 </span><span class="lineCov">       1073 :                 info-&gt;summary = &quot;Vmsayname unit test&quot;;</span>
<span class="lineNum">   14488 </span><span class="lineCov">       1073 :                 info-&gt;description =</span>
<span class="lineNum">   14489 </span>            :                         &quot;This tests passing various parameters to vmsayname&quot;;
<span class="lineNum">   14490 </span><span class="lineCov">       1073 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14491 </span><span class="lineCov">          1 :         case TEST_EXECUTE:</span>
<span class="lineNum">   14492 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">   14493 </span>            :         }
<span class="lineNum">   14494 </span>            : 
<span class="lineNum">   14495 </span><span class="lineCov">          1 :         if (!(test_channel1 = ast_channel_alloc(0, AST_STATE_DOWN, NULL, NULL, NULL, NULL,</span>
<span class="lineNum">   14496 </span>            :         NULL, NULL, 0, 0, &quot;TestChannel1&quot;))) {
<span class="lineNum">   14497 </span><span class="lineNoCov">          0 :                 goto exit_vmsayname_test;</span>
<span class="lineNum">   14498 </span>            :         }
<span class="lineNum">   14499 </span>            : 
<span class="lineNum">   14500 </span>            :         /* normally this is done in the channel driver */
<span class="lineNum">   14501 </span><span class="lineCov">          1 :         capabilities = ast_format_cap_alloc(AST_FORMAT_CAP_FLAG_DEFAULT);</span>
<span class="lineNum">   14502 </span><span class="lineCov">          1 :         if (!capabilities) {</span>
<span class="lineNum">   14503 </span><span class="lineNoCov">          0 :                 goto exit_vmsayname_test;</span>
<span class="lineNum">   14504 </span>            :         }
<span class="lineNum">   14505 </span><span class="lineCov">          1 :         ast_format_cap_append(capabilities, ast_format_gsm, 0);</span>
<span class="lineNum">   14506 </span><span class="lineCov">          1 :         ast_channel_nativeformats_set(test_channel1, capabilities);</span>
<span class="lineNum">   14507 </span><span class="lineCov">          1 :         ao2_ref(capabilities, -1);</span>
<span class="lineNum">   14508 </span><span class="lineCov">          1 :         ast_channel_set_writeformat(test_channel1, ast_format_gsm);</span>
<span class="lineNum">   14509 </span><span class="lineCov">          1 :         ast_channel_set_rawwriteformat(test_channel1, ast_format_gsm);</span>
<span class="lineNum">   14510 </span><span class="lineCov">          1 :         ast_channel_set_readformat(test_channel1, ast_format_gsm);</span>
<span class="lineNum">   14511 </span><span class="lineCov">          1 :         ast_channel_set_rawreadformat(test_channel1, ast_format_gsm);</span>
<span class="lineNum">   14512 </span><span class="lineCov">          1 :         ast_channel_tech_set(test_channel1, &amp;fake_tech);</span>
<span class="lineNum">   14513 </span>            : 
<span class="lineNum">   14514 </span><span class="lineCov">          1 :         ast_channel_unlock(test_channel1);</span>
<span class="lineNum">   14515 </span>            : 
<span class="lineNum">   14516 </span><span class="lineCov">          1 :         ast_test_status_update(test, &quot;Test playing of extension when greeting is not available...\n&quot;);</span>
<span class="lineNum">   14517 </span><span class="lineCov">          1 :         snprintf(dir, sizeof(dir), &quot;%s@%s&quot;, TEST_EXTENSION, TEST_CONTEXT); /* not a dir, don't get confused */</span>
<span class="lineNum">   14518 </span><span class="lineCov">          1 :         if (!(res = vmsayname_exec(test_channel1, dir))) {</span>
<span class="lineNum">   14519 </span><span class="lineCov">          1 :                 snprintf(dir, sizeof(dir), &quot;%s%s/%s/greet&quot;, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</span>
<span class="lineNum">   14520 </span><span class="lineCov">          1 :                 if (ast_fileexists(dir, NULL, NULL)) {</span>
<span class="lineNum">   14521 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;This should not happen, most likely means clean up from previous test failed\n&quot;);</span>
<span class="lineNum">   14522 </span><span class="lineNoCov">          0 :                         res = -1;</span>
<span class="lineNum">   14523 </span><span class="lineNoCov">          0 :                         goto exit_vmsayname_test;</span>
<span class="lineNum">   14524 </span>            :                 } else {
<span class="lineNum">   14525 </span>            :                         /* no greeting already exists as expected, let's create one to fully test sayname */
<span class="lineNum">   14526 </span><span class="lineCov">          1 :                         if ((res = create_dirpath(dir, sizeof(dir), TEST_CONTEXT, TEST_EXTENSION, &quot;&quot;))) {</span>
<span class="lineNum">   14527 </span><span class="lineNoCov">          0 :                                 ast_log(AST_LOG_WARNING, &quot;Failed to make test directory\n&quot;);</span>
<span class="lineNum">   14528 </span><span class="lineNoCov">          0 :                                 goto exit_vmsayname_test;</span>
<span class="lineNum">   14529 </span>            :                         }
<span class="lineNum">   14530 </span><span class="lineCov">          1 :                         snprintf(dir, sizeof(dir), &quot;%s/sounds/beep.gsm&quot;, ast_config_AST_DATA_DIR);</span>
<span class="lineNum">   14531 </span><span class="lineCov">          1 :                         snprintf(dir2, sizeof(dir2), &quot;%s%s/%s/greet.gsm&quot;, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</span>
<span class="lineNum">   14532 </span>            :                         /* we're not going to hear the sound anyway, just use a valid gsm audio file */
<span class="lineNum">   14533 </span><span class="lineCov">          1 :                         if ((res = symlink(dir, dir2))) {</span>
<span class="lineNum">   14534 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;Symlink reported %s\n&quot;, strerror(errno));</span>
<span class="lineNum">   14535 </span><span class="lineNoCov">          0 :                                 goto exit_vmsayname_test;</span>
<span class="lineNum">   14536 </span>            :                         }
<span class="lineNum">   14537 </span><span class="lineCov">          1 :                         ast_test_status_update(test, &quot;Test playing created mailbox greeting...\n&quot;);</span>
<span class="lineNum">   14538 </span><span class="lineCov">          1 :                         snprintf(dir, sizeof(dir), &quot;%s@%s&quot;, TEST_EXTENSION, TEST_CONTEXT); /* not a dir, don't get confused */</span>
<span class="lineNum">   14539 </span><span class="lineCov">          1 :                         res = vmsayname_exec(test_channel1, dir);</span>
<span class="lineNum">   14540 </span>            : 
<span class="lineNum">   14541 </span>            :                         /* TODO: there may be a better way to do this */
<span class="lineNum">   14542 </span><span class="lineCov">          1 :                         unlink(dir2);</span>
<span class="lineNum">   14543 </span><span class="lineCov">          1 :                         snprintf(dir2, sizeof(dir2), &quot;%s%s/%s&quot;, VM_SPOOL_DIR, TEST_CONTEXT, TEST_EXTENSION);</span>
<span class="lineNum">   14544 </span><span class="lineCov">          1 :                         rmdir(dir2);</span>
<span class="lineNum">   14545 </span><span class="lineCov">          1 :                         snprintf(dir2, sizeof(dir2), &quot;%s%s&quot;, VM_SPOOL_DIR, TEST_CONTEXT);</span>
<span class="lineNum">   14546 </span><span class="lineCov">          1 :                         rmdir(dir2);</span>
<span class="lineNum">   14547 </span>            :                 }
<span class="lineNum">   14548 </span>            :         }
<span class="lineNum">   14549 </span>            : 
<span class="lineNum">   14550 </span><span class="lineNoCov">          0 : exit_vmsayname_test:</span>
<span class="lineNum">   14551 </span>            : 
<span class="lineNum">   14552 </span><span class="lineCov">          1 :         ast_hangup(test_channel1);</span>
<span class="lineNum">   14553 </span>            : 
<span class="lineNum">   14554 </span><span class="lineCov">          1 :         return res ? AST_TEST_FAIL : AST_TEST_PASS;</span>
<a name="14555"><span class="lineNum">   14555 </span>            : }</a>
<span class="lineNum">   14556 </span>            : 
<span class="lineNum">   14557 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_msgcount)</span>
<span class="lineNum">   14558 </span>            : {
<span class="lineNum">   14559 </span><span class="lineCov">       1074 :         int i, j, res = AST_TEST_PASS, syserr;</span>
<span class="lineNum">   14560 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   14561 </span>            :         struct ast_vm_user svm;
<span class="lineNum">   14562 </span>            :         struct vm_state vms;
<span class="lineNum">   14563 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14564 </span>            :         struct ast_channel *chan = NULL;
<span class="lineNum">   14565 </span>            : #endif
<span class="lineNum">   14566 </span>            :         struct {
<span class="lineNum">   14567 </span>            :                 char dir[256];
<span class="lineNum">   14568 </span>            :                 char file[256];
<span class="lineNum">   14569 </span>            :                 char txtfile[256];
<span class="lineNum">   14570 </span>            :         } tmp[3];
<span class="lineNum">   14571 </span>            :         char syscmd[256];
<span class="lineNum">   14572 </span><span class="lineCov">       1074 :         const char origweasels[] = &quot;tt-weasels&quot;;</span>
<span class="lineNum">   14573 </span><span class="lineCov">       1074 :         const char testcontext[] = &quot;test&quot;;</span>
<span class="lineNum">   14574 </span><span class="lineCov">       1074 :         const char testmailbox[] = &quot;00000000&quot;;</span>
<span class="lineNum">   14575 </span><span class="lineCov">       1074 :         const char testspec[] = &quot;00000000@test&quot;;</span>
<span class="lineNum">   14576 </span>            :         FILE *txt;
<span class="lineNum">   14577 </span>            :         int new, old, urgent;
<span class="lineNum">   14578 </span><span class="lineCov">       1074 :         const char *folders[3] = { &quot;Old&quot;, &quot;Urgent&quot;, &quot;INBOX&quot; };</span>
<span class="lineNum">   14579 </span><span class="lineCov">       1074 :         const int folder2mbox[3] = { 1, 11, 0 };</span>
<span class="lineNum">   14580 </span><span class="lineCov">       1074 :         const int expected_results[3][12] = {</span>
<span class="lineNum">   14581 </span>            :                 /* hasvm-old, hasvm-urgent, hasvm-new, ic-old, ic-urgent, ic-new, ic2-old, ic2-urgent, ic2-new, mc-old, mc-urgent, mc-new */
<span class="lineNum">   14582 </span>            :                 {          1,            0,         0,      1,         0,      0,       1,          0,       0,      1,         0,      0 },
<span class="lineNum">   14583 </span>            :                 {          1,            1,         1,      1,         0,      1,       1,          1,       0,      1,         1,      1 },
<span class="lineNum">   14584 </span>            :                 {          1,            1,         1,      1,         0,      2,       1,          1,       1,      1,         1,      2 },
<span class="lineNum">   14585 </span>            :         };
<span class="lineNum">   14586 </span>            : 
<span class="lineNum">   14587 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   14588 </span><span class="lineCov">       1073 :         case TEST_INIT:</span>
<span class="lineNum">   14589 </span><span class="lineCov">       1073 :                 info-&gt;name = &quot;test_voicemail_msgcount&quot;;</span>
<span class="lineNum">   14590 </span><span class="lineCov">       1073 :                 info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   14591 </span><span class="lineCov">       1073 :                 info-&gt;summary = &quot;Test Voicemail status checks&quot;;</span>
<span class="lineNum">   14592 </span><span class="lineCov">       1073 :                 info-&gt;description =</span>
<span class="lineNum">   14593 </span>            :                         &quot;Verify that message counts are correct when retrieved through the public API&quot;;
<span class="lineNum">   14594 </span><span class="lineCov">       1073 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14595 </span><span class="lineCov">          1 :         case TEST_EXECUTE:</span>
<span class="lineNum">   14596 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">   14597 </span>            :         }
<span class="lineNum">   14598 </span>            : 
<span class="lineNum">   14599 </span>            :         /* Make sure the original path was completely empty */
<span class="lineNum">   14600 </span><span class="lineCov">          1 :         snprintf(syscmd, sizeof(syscmd), &quot;rm -rf \&quot;%s%s/%s\&quot;&quot;, VM_SPOOL_DIR, testcontext, testmailbox);</span>
<span class="lineNum">   14601 </span><span class="lineCov">          1 :         if ((syserr = ast_safe_system(syscmd))) {</span>
<span class="lineNum">   14602 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Unable to clear test directory: %s\n&quot;,</span>
<span class="lineNum">   14603 </span>            :                         syserr &gt; 0 ? strerror(syserr) : &quot;unable to fork()&quot;);
<span class="lineNum">   14604 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14605 </span>            :         }
<span class="lineNum">   14606 </span>            : 
<span class="lineNum">   14607 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14608 </span>            :         if (!(chan = ast_dummy_channel_alloc())) {
<span class="lineNum">   14609 </span>            :                 ast_test_status_update(test, &quot;Unable to create dummy channel\n&quot;);
<span class="lineNum">   14610 </span>            :                 return AST_TEST_FAIL;
<span class="lineNum">   14611 </span>            :         }
<span class="lineNum">   14612 </span>            : #endif
<span class="lineNum">   14613 </span>            : 
<span class="lineNum">   14614 </span><span class="lineCov">          1 :         memset(&amp;svm, 0, sizeof(svm));</span>
<span class="lineNum">   14615 </span><span class="lineCov">          1 :         if (!(vmu = find_user(&amp;svm, testcontext, testmailbox)) &amp;&amp;</span>
<span class="lineNum">   14616 </span><span class="lineNoCov">          0 :                 !(vmu = find_or_create(testcontext, testmailbox))) {</span>
<span class="lineNum">   14617 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Cannot create vmu structure\n&quot;);</span>
<span class="lineNum">   14618 </span><span class="lineNoCov">          0 :                 ast_unreplace_sigchld();</span>
<span class="lineNum">   14619 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14620 </span>            :                 chan = ast_channel_unref(chan);
<span class="lineNum">   14621 </span>            : #endif
<span class="lineNum">   14622 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14623 </span>            :         }
<span class="lineNum">   14624 </span>            : 
<span class="lineNum">   14625 </span><span class="lineCov">          1 :         populate_defaults(vmu);</span>
<span class="lineNum">   14626 </span><span class="lineCov">          1 :         memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   14627 </span>            : 
<span class="lineNum">   14628 </span>            :         /* Create temporary voicemail */
<span class="lineNum">   14629 </span><span class="lineCov">          4 :         for (i = 0; i &lt; 3; i++) {</span>
<span class="lineNum">   14630 </span><span class="lineCov">          3 :                 create_dirpath(tmp[i].dir, sizeof(tmp[i].dir), testcontext, testmailbox, folders[i]);</span>
<span class="lineNum">   14631 </span><span class="lineCov">          3 :                 make_file(tmp[i].file, sizeof(tmp[i].file), tmp[i].dir, 0);</span>
<span class="lineNum">   14632 </span><span class="lineCov">          3 :                 snprintf(tmp[i].txtfile, sizeof(tmp[i].txtfile), &quot;%s.txt&quot;, tmp[i].file);</span>
<span class="lineNum">   14633 </span>            : 
<span class="lineNum">   14634 </span><span class="lineCov">          3 :                 if (ast_fileexists(origweasels, &quot;gsm&quot;, &quot;en&quot;) &gt; 0) {</span>
<span class="lineNum">   14635 </span><span class="lineCov">          3 :                         snprintf(syscmd, sizeof(syscmd), &quot;cp \&quot;%s/sounds/en/%s.gsm\&quot; \&quot;%s/%s/%s/%s/msg0000.gsm\&quot;&quot;, ast_config_AST_DATA_DIR, origweasels,</span>
<span class="lineNum">   14636 </span>            :                                 VM_SPOOL_DIR, testcontext, testmailbox, folders[i]);
<span class="lineNum">   14637 </span><span class="lineCov">          3 :                         if ((syserr = ast_safe_system(syscmd))) {</span>
<span class="lineNum">   14638 </span><span class="lineNoCov">          0 :                                 ast_test_status_update(test, &quot;Unable to create test voicemail: %s\n&quot;,</span>
<span class="lineNum">   14639 </span>            :                                         syserr &gt; 0 ? strerror(syserr) : &quot;unable to fork()&quot;);
<span class="lineNum">   14640 </span><span class="lineNoCov">          0 :                                 ast_unreplace_sigchld();</span>
<span class="lineNum">   14641 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14642 </span>            :                                 chan = ast_channel_unref(chan);
<span class="lineNum">   14643 </span>            : #endif
<span class="lineNum">   14644 </span><span class="lineNoCov">          0 :                                 free_user(vmu);</span>
<span class="lineNum">   14645 </span><span class="lineNoCov">          0 :                                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14646 </span>            :                         }
<span class="lineNum">   14647 </span>            :                 }
<span class="lineNum">   14648 </span>            : 
<span class="lineNum">   14649 </span><span class="lineCov">          3 :                 if ((txt = fopen(tmp[i].txtfile, &quot;w+&quot;))) {</span>
<span class="lineNum">   14650 </span><span class="lineCov">          3 :                         fprintf(txt, &quot;; just a stub\n[message]\nflag=%s\n&quot;, strcmp(folders[i], &quot;Urgent&quot;) ? &quot;&quot; : &quot;Urgent&quot;);</span>
<span class="lineNum">   14651 </span><span class="lineCov">          3 :                         fclose(txt);</span>
<span class="lineNum">   14652 </span>            :                 } else {
<span class="lineNum">   14653 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;Unable to write message file '%s'\n&quot;, tmp[i].txtfile);</span>
<span class="lineNum">   14654 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14655 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   14656 </span>            :                 }
<span class="lineNum">   14657 </span><span class="lineCov">          3 :                 open_mailbox(&amp;vms, vmu, folder2mbox[i]);</span>
<span class="lineNum">   14658 </span>            :                 STORE(tmp[i].dir, testmailbox, testcontext, 0, chan, vmu, &quot;gsm&quot;, 600, &amp;vms, strcmp(folders[i], &quot;Urgent&quot;) ? &quot;&quot; : &quot;Urgent&quot;, NULL);
<span class="lineNum">   14659 </span>            : 
<span class="lineNum">   14660 </span>            :                 /* hasvm-old, hasvm-urgent, hasvm-new, ic-old, ic-urgent, ic-new, ic2-old, ic2-urgent, ic2-new, mc-old, mc-urgent, mc-new */
<span class="lineNum">   14661 </span><span class="lineCov">         12 :                 for (j = 0; j &lt; 3; j++) {</span>
<span class="lineNum">   14662 </span>            :                         /* folder[2] is INBOX, __has_voicemail will default back to INBOX */
<span class="lineNum">   14663 </span><span class="lineCov">          9 :                         if (ast_app_has_voicemail(testspec, (j==2 ? NULL : folders[j])) != expected_results[i][0 + j]) {</span>
<span class="lineNum">   14664 </span><span class="lineNoCov">          0 :                                 ast_test_status_update(test, &quot;has_voicemail(%s, %s) returned %d and we expected %d\n&quot;,</span>
<span class="lineNum">   14665 </span>            :                                         testspec, folders[j], ast_app_has_voicemail(testspec, folders[j]), expected_results[i][0 + j]);
<span class="lineNum">   14666 </span><span class="lineNoCov">          0 :                                 res = AST_TEST_FAIL;</span>
<span class="lineNum">   14667 </span>            :                         }
<span class="lineNum">   14668 </span>            :                 }
<span class="lineNum">   14669 </span>            : 
<span class="lineNum">   14670 </span><span class="lineCov">          3 :                 new = old = urgent = 0;</span>
<span class="lineNum">   14671 </span><span class="lineCov">          3 :                 if (ast_app_inboxcount(testspec, &amp;new, &amp;old)) {</span>
<span class="lineNum">   14672 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;inboxcount returned failure\n&quot;);</span>
<span class="lineNum">   14673 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14674 </span><span class="lineCov">          3 :                 } else if (old != expected_results[i][3 + 0] || new != expected_results[i][3 + 2]) {</span>
<span class="lineNum">   14675 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;inboxcount(%s) returned old=%d (expected %d) and new=%d (expected %d)\n&quot;,</span>
<span class="lineNum">   14676 </span>            :                                 testspec, old, expected_results[i][3 + 0], new, expected_results[i][3 + 2]);
<span class="lineNum">   14677 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14678 </span>            :                 }
<span class="lineNum">   14679 </span>            : 
<span class="lineNum">   14680 </span><span class="lineCov">          3 :                 new = old = urgent = 0;</span>
<span class="lineNum">   14681 </span><span class="lineCov">          3 :                 if (ast_app_inboxcount2(testspec, &amp;urgent, &amp;new, &amp;old)) {</span>
<span class="lineNum">   14682 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;inboxcount2 returned failure\n&quot;);</span>
<span class="lineNum">   14683 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14684 </span><span class="lineCov">          3 :                 } else if (old != expected_results[i][6 + 0] ||</span>
<span class="lineNum">   14685 </span><span class="lineCov">          3 :                                 urgent != expected_results[i][6 + 1] ||</span>
<span class="lineNum">   14686 </span><span class="lineCov">          3 :                                    new != expected_results[i][6 + 2]    ) {</span>
<span class="lineNum">   14687 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;inboxcount2(%s) returned old=%d (expected %d), urgent=%d (expected %d), and new=%d (expected %d)\n&quot;,</span>
<span class="lineNum">   14688 </span>            :                                 testspec, old, expected_results[i][6 + 0], urgent, expected_results[i][6 + 1], new, expected_results[i][6 + 2]);
<span class="lineNum">   14689 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14690 </span>            :                 }
<span class="lineNum">   14691 </span>            : 
<span class="lineNum">   14692 </span><span class="lineCov">          3 :                 new = old = urgent = 0;</span>
<span class="lineNum">   14693 </span><span class="lineCov">         12 :                 for (j = 0; j &lt; 3; j++) {</span>
<span class="lineNum">   14694 </span><span class="lineCov">          9 :                         if (ast_app_messagecount(testspec, folders[j]) != expected_results[i][9 + j]) {</span>
<span class="lineNum">   14695 </span><span class="lineNoCov">          0 :                                 ast_test_status_update(test, &quot;messagecount(%s, %s) returned %d and we expected %d\n&quot;,</span>
<span class="lineNum">   14696 </span>            :                                         testspec, folders[j], ast_app_messagecount(testspec, folders[j]), expected_results[i][9 + j]);
<span class="lineNum">   14697 </span><span class="lineNoCov">          0 :                                 res = AST_TEST_FAIL;</span>
<span class="lineNum">   14698 </span>            :                         }
<span class="lineNum">   14699 </span>            :                 }
<span class="lineNum">   14700 </span>            :         }
<span class="lineNum">   14701 </span>            : 
<span class="lineNum">   14702 </span><span class="lineCov">          4 :         for (i = 0; i &lt; 3; i++) {</span>
<span class="lineNum">   14703 </span>            :                 /* This is necessary if the voicemails are stored on an ODBC/IMAP
<span class="lineNum">   14704 </span>            :                  * server, in which case, the rm below will not affect the
<span class="lineNum">   14705 </span>            :                  * voicemails. */
<span class="lineNum">   14706 </span><span class="lineCov">          3 :                 DELETE(tmp[i].dir, 0, tmp[i].file, vmu);</span>
<span class="lineNum">   14707 </span>            :                 DISPOSE(tmp[i].dir, 0);
<span class="lineNum">   14708 </span>            :         }
<span class="lineNum">   14709 </span>            : 
<span class="lineNum">   14710 </span><span class="lineCov">          1 :         if (vms.deleted) {</span>
<span class="lineNum">   14711 </span><span class="lineCov">          1 :                 ast_free(vms.deleted);</span>
<span class="lineNum">   14712 </span>            :         }
<span class="lineNum">   14713 </span><span class="lineCov">          1 :         if (vms.heard) {</span>
<span class="lineNum">   14714 </span><span class="lineCov">          1 :                 ast_free(vms.heard);</span>
<span class="lineNum">   14715 </span>            :         }
<span class="lineNum">   14716 </span>            : 
<span class="lineNum">   14717 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14718 </span>            :         chan = ast_channel_unref(chan);
<span class="lineNum">   14719 </span>            : #endif
<span class="lineNum">   14720 </span>            : 
<span class="lineNum">   14721 </span>            :         /* And remove test directory */
<span class="lineNum">   14722 </span><span class="lineCov">          1 :         snprintf(syscmd, sizeof(syscmd), &quot;rm -rf \&quot;%s%s/%s\&quot;&quot;, VM_SPOOL_DIR, testcontext, testmailbox);</span>
<span class="lineNum">   14723 </span><span class="lineCov">          1 :         if ((syserr = ast_safe_system(syscmd))) {</span>
<span class="lineNum">   14724 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Unable to clear test directory: %s\n&quot;,</span>
<span class="lineNum">   14725 </span>            :                         syserr &gt; 0 ? strerror(syserr) : &quot;unable to fork()&quot;);
<span class="lineNum">   14726 </span>            :         }
<span class="lineNum">   14727 </span>            : 
<span class="lineNum">   14728 </span><span class="lineCov">          1 :         free_user(vmu);</span>
<span class="lineNum">   14729 </span><span class="lineCov">          1 :         return res;</span>
<a name="14730"><span class="lineNum">   14730 </span>            : }</a>
<span class="lineNum">   14731 </span>            : 
<span class="lineNum">   14732 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_notify_endl)</span>
<span class="lineNum">   14733 </span>            : {
<span class="lineNum">   14734 </span><span class="lineCov">       1074 :         int res = AST_TEST_PASS;</span>
<span class="lineNum">   14735 </span><span class="lineCov">       1074 :         char testcontext[] = &quot;test&quot;;</span>
<span class="lineNum">   14736 </span><span class="lineCov">       1074 :         char testmailbox[] = &quot;00000000&quot;;</span>
<span class="lineNum">   14737 </span><span class="lineCov">       1074 :         char from[] = &quot;test@example.net&quot;, cidnum[] = &quot;1234&quot;, cidname[] = &quot;Mark Spencer&quot;, format[] = &quot;gsm&quot;;</span>
<span class="lineNum">   14738 </span>            :         char attach[256], attach2[256];
<span class="lineNum">   14739 </span><span class="lineCov">       1074 :         char buf[256] = &quot;&quot;; /* No line should actually be longer than 80 */</span>
<span class="lineNum">   14740 </span><span class="lineCov">       1074 :         struct ast_channel *chan = NULL;</span>
<span class="lineNum">   14741 </span><span class="lineCov">       1074 :         struct ast_vm_user *vmu, vmus = {</span>
<span class="lineNum">   14742 </span>            :                 .flags = 0,
<span class="lineNum">   14743 </span>            :         };
<span class="lineNum">   14744 </span>            :         FILE *file;
<span class="lineNum">   14745 </span>            :         struct {
<span class="lineNum">   14746 </span>            :                 char *name;
<span class="lineNum">   14747 </span>            :                 enum { INT, FLAGVAL, STATIC, STRPTR } type;
<span class="lineNum">   14748 </span>            :                 void *location;
<span class="lineNum">   14749 </span>            :                 union {
<span class="lineNum">   14750 </span>            :                         int intval;
<span class="lineNum">   14751 </span>            :                         char *strval;
<span class="lineNum">   14752 </span>            :                 } u;
<span class="lineNum">   14753 </span><span class="lineCov">       3222 :         } test_items[] = {</span>
<span class="lineNum">   14754 </span>            :                 { &quot;plain jane config&quot;, STATIC, vmus.password, .u.strval = &quot;1234&quot; }, /* No, this doesn't change this test any. */
<span class="lineNum">   14755 </span><span class="lineCov">       1074 :                 { &quot;emailsubject&quot;, STRPTR, vmus.emailsubject, .u.strval = &quot;Oogly boogly\xf8koogly with what appears to be UTF-8&quot; },</span>
<span class="lineNum">   14756 </span><span class="lineCov">       1074 :                 { &quot;emailbody&quot;, STRPTR, vmus.emailbody, .u.strval = &quot;This is a test\n\twith multiple\nlines\nwithin\n&quot; },</span>
<span class="lineNum">   14757 </span>            :                 { &quot;serveremail&quot;, STATIC, vmus.serveremail, .u.strval = &quot;\&quot;\xf8Something\xe8that\xd8seems to have UTF-8 chars\&quot; &lt;test@example.net&gt;&quot; },
<span class="lineNum">   14758 </span>            :                 { &quot;attachment flag&quot;, FLAGVAL, &amp;vmus.flags, .u.intval = VM_ATTACH },
<span class="lineNum">   14759 </span>            :                 { &quot;attach2&quot;, STRPTR, attach2, .u.strval = &quot;&quot; },
<span class="lineNum">   14760 </span>            :                 { &quot;attach&quot;, STRPTR, attach, .u.strval = &quot;&quot; },
<span class="lineNum">   14761 </span>            :         };
<span class="lineNum">   14762 </span>            :         int which;
<span class="lineNum">   14763 </span>            : 
<span class="lineNum">   14764 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   14765 </span><span class="lineCov">       1073 :         case TEST_INIT:</span>
<span class="lineNum">   14766 </span><span class="lineCov">       1073 :                 info-&gt;name = &quot;test_voicemail_notify_endl&quot;;</span>
<span class="lineNum">   14767 </span><span class="lineCov">       1073 :                 info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   14768 </span><span class="lineCov">       1073 :                 info-&gt;summary = &quot;Test Voicemail notification end-of-line&quot;;</span>
<span class="lineNum">   14769 </span><span class="lineCov">       1073 :                 info-&gt;description =</span>
<span class="lineNum">   14770 </span>            :                         &quot;Verify that notification emails use a consistent end-of-line character&quot;;
<span class="lineNum">   14771 </span><span class="lineCov">       1073 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14772 </span><span class="lineCov">          1 :         case TEST_EXECUTE:</span>
<span class="lineNum">   14773 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">   14774 </span>            :         }
<span class="lineNum">   14775 </span>            : 
<span class="lineNum">   14776 </span><span class="lineCov">          1 :         snprintf(attach, sizeof(attach), &quot;%s/sounds/en/tt-weasels&quot;, ast_config_AST_DATA_DIR);</span>
<span class="lineNum">   14777 </span><span class="lineCov">          1 :         snprintf(attach2, sizeof(attach2), &quot;%s/sounds/en/tt-somethingwrong&quot;, ast_config_AST_DATA_DIR);</span>
<span class="lineNum">   14778 </span>            : 
<span class="lineNum">   14779 </span><span class="lineCov">          2 :         if (!(vmu = find_user(&amp;vmus, testcontext, testmailbox)) &amp;&amp;</span>
<span class="lineNum">   14780 </span><span class="lineCov">          1 :                 !(vmu = find_or_create(testcontext, testmailbox))) {</span>
<span class="lineNum">   14781 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Cannot create vmu structure\n&quot;);</span>
<span class="lineNum">   14782 </span><span class="lineNoCov">          0 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14783 </span>            :         }
<span class="lineNum">   14784 </span>            : 
<span class="lineNum">   14785 </span><span class="lineCov">          1 :         if (vmu != &amp;vmus &amp;&amp; !(vmu = find_user(&amp;vmus, testcontext, testmailbox))) {</span>
<span class="lineNum">   14786 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Cannot find vmu structure?!!\n&quot;);</span>
<span class="lineNum">   14787 </span><span class="lineNoCov">          0 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14788 </span>            :         }
<span class="lineNum">   14789 </span>            : 
<span class="lineNum">   14790 </span><span class="lineCov">          1 :         populate_defaults(vmu);</span>
<span class="lineNum">   14791 </span><span class="lineCov">          1 :         vmu-&gt;email = ast_strdup(&quot;test2@example.net&quot;);</span>
<span class="lineNum">   14792 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14793 </span>            :         /* TODO When we set up the IMAP server test, we'll need to have credentials for the VMU structure added here */
<span class="lineNum">   14794 </span>            : #endif
<span class="lineNum">   14795 </span>            : 
<span class="lineNum">   14796 </span><span class="lineCov">          1 :         file = tmpfile();</span>
<span class="lineNum">   14797 </span><span class="lineCov">          8 :         for (which = 0; which &lt; ARRAY_LEN(test_items); which++) {</span>
<span class="lineNum">   14798 </span>            :                 /* Kill previous test, if any */
<span class="lineNum">   14799 </span><span class="lineCov">          7 :                 rewind(file);</span>
<span class="lineNum">   14800 </span><span class="lineCov">          7 :                 if (ftruncate(fileno(file), 0)) {</span>
<span class="lineNum">   14801 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;Cannot truncate test output file: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">   14802 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14803 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   14804 </span>            :                 }
<span class="lineNum">   14805 </span>            : 
<span class="lineNum">   14806 </span>            :                 /* Make each change, in order, to the test mailbox */
<span class="lineNum">   14807 </span><span class="lineCov">          7 :                 if (test_items[which].type == INT) {</span>
<span class="lineNum">   14808 </span><span class="lineNoCov">          0 :                         *((int *) test_items[which].location) = test_items[which].u.intval;</span>
<span class="lineNum">   14809 </span><span class="lineCov">          7 :                 } else if (test_items[which].type == FLAGVAL) {</span>
<span class="lineNum">   14810 </span><span class="lineCov">          1 :                         if (ast_test_flag(vmu, test_items[which].u.intval)) {</span>
<span class="lineNum">   14811 </span><span class="lineCov">          1 :                                 ast_clear_flag(vmu, test_items[which].u.intval);</span>
<span class="lineNum">   14812 </span>            :                         } else {
<span class="lineNum">   14813 </span><span class="lineNoCov">          0 :                                 ast_set_flag(vmu, test_items[which].u.intval);</span>
<span class="lineNum">   14814 </span>            :                         }
<span class="lineNum">   14815 </span><span class="lineCov">          6 :                 } else if (test_items[which].type == STATIC) {</span>
<span class="lineNum">   14816 </span><span class="lineCov">          2 :                         strcpy(test_items[which].location, test_items[which].u.strval);</span>
<span class="lineNum">   14817 </span><span class="lineCov">          4 :                 } else if (test_items[which].type == STRPTR) {</span>
<span class="lineNum">   14818 </span><span class="lineCov">          4 :                         test_items[which].location = test_items[which].u.strval;</span>
<span class="lineNum">   14819 </span>            :                 }
<span class="lineNum">   14820 </span>            : 
<span class="lineNum">   14821 </span><span class="lineCov">          7 :                 make_email_file(file, from, vmu, 0, testcontext, testmailbox, &quot;INBOX&quot;, cidnum, cidname, attach, attach2, format, 999, 1, chan, NULL, 0, NULL, NULL);</span>
<span class="lineNum">   14822 </span><span class="lineCov">          7 :                 rewind(file);</span>
<span class="lineNum">   14823 </span><span class="lineCov">       1484 :                 while (fgets(buf, sizeof(buf), file)) {</span>
<span class="lineNum">   14824 </span><span class="lineCov">       1477 :                         if (</span>
<span class="lineNum">   14825 </span><span class="lineCov">       1477 :                         (strlen(buf) &gt; 1 &amp;&amp;</span>
<span class="lineNum">   14826 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   14827 </span>            :                         buf[strlen(buf) - 2] != '\r'
<span class="lineNum">   14828 </span>            : #else
<span class="lineNum">   14829 </span><span class="lineCov">       1400 :                         buf[strlen(buf) - 2] == '\r'</span>
<span class="lineNum">   14830 </span>            : #endif
<span class="lineNum">   14831 </span>            :                         )
<span class="lineNum">   14832 </span><span class="lineCov">       1477 :                         || buf[strlen(buf) - 1] != '\n') {</span>
<span class="lineNum">   14833 </span><span class="lineNoCov">          0 :                                 res = AST_TEST_FAIL;</span>
<span class="lineNum">   14834 </span>            :                         }
<span class="lineNum">   14835 </span>            :                 }
<span class="lineNum">   14836 </span>            :         }
<span class="lineNum">   14837 </span><span class="lineCov">          1 :         fclose(file);</span>
<span class="lineNum">   14838 </span><span class="lineCov">          1 :         free_user(vmu);</span>
<span class="lineNum">   14839 </span><span class="lineCov">          1 :         return res;</span>
<a name="14840"><span class="lineNum">   14840 </span>            : }</a>
<span class="lineNum">   14841 </span>            : 
<span class="lineNum">   14842 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_load_config)</span>
<span class="lineNum">   14843 </span>            : {
<span class="lineNum">   14844 </span><span class="lineCov">       1074 :         int res = AST_TEST_PASS;</span>
<span class="lineNum">   14845 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   14846 </span>            :         struct ast_config *cfg;
<span class="lineNum">   14847 </span><span class="lineCov">       1074 :         char config_filename[32] = &quot;/tmp/voicemail.conf.XXXXXX&quot;;</span>
<span class="lineNum">   14848 </span>            :         int fd;
<span class="lineNum">   14849 </span>            :         FILE *file;
<span class="lineNum">   14850 </span><span class="lineCov">       1074 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">   14851 </span>            : 
<span class="lineNum">   14852 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   14853 </span><span class="lineCov">       1073 :         case TEST_INIT:</span>
<span class="lineNum">   14854 </span><span class="lineCov">       1073 :                 info-&gt;name = &quot;test_voicemail_load_config&quot;;</span>
<span class="lineNum">   14855 </span><span class="lineCov">       1073 :                 info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   14856 </span><span class="lineCov">       1073 :                 info-&gt;summary = &quot;Test loading Voicemail config&quot;;</span>
<span class="lineNum">   14857 </span><span class="lineCov">       1073 :                 info-&gt;description =</span>
<span class="lineNum">   14858 </span>            :                         &quot;Verify that configuration is loaded consistently. &quot;
<span class="lineNum">   14859 </span>            :                         &quot;This is to test regressions of ASTERISK-18838 where it was noticed that &quot;
<span class="lineNum">   14860 </span>            :                         &quot;some options were loaded after the mailboxes were instantiated, causing &quot;
<span class="lineNum">   14861 </span>            :                         &quot;those options not to be set correctly.&quot;;
<span class="lineNum">   14862 </span><span class="lineCov">       1073 :                 return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14863 </span><span class="lineCov">          1 :         case TEST_EXECUTE:</span>
<span class="lineNum">   14864 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">   14865 </span>            :         }
<span class="lineNum">   14866 </span>            : 
<span class="lineNum">   14867 </span>            :         /* build a config file by hand... */
<span class="lineNum">   14868 </span><span class="lineCov">          1 :         if ((fd = mkstemp(config_filename)) &lt; 0) {</span>
<span class="lineNum">   14869 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14870 </span>            :         }
<span class="lineNum">   14871 </span><span class="lineCov">          1 :         if (!(file = fdopen(fd, &quot;w&quot;))) {</span>
<span class="lineNum">   14872 </span><span class="lineNoCov">          0 :                 close(fd);</span>
<span class="lineNum">   14873 </span><span class="lineNoCov">          0 :                 unlink(config_filename);</span>
<span class="lineNum">   14874 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14875 </span>            :         }
<span class="lineNum">   14876 </span><span class="lineCov">          1 :         fputs(&quot;[general]\ncallback=somecontext\nlocale=de_DE.UTF-8\ntz=european\n[test]&quot;, file);</span>
<span class="lineNum">   14877 </span><span class="lineCov">          1 :         fputs(&quot;00000001 =&gt; 9999,Mr. Test,,,callback=othercontext|locale=nl_NL.UTF-8|tz=central\n&quot;, file);</span>
<span class="lineNum">   14878 </span><span class="lineCov">          1 :         fputs(&quot;00000002 =&gt; 9999,Mrs. Test\n&quot;, file);</span>
<span class="lineNum">   14879 </span><span class="lineCov">          1 :         fclose(file);</span>
<span class="lineNum">   14880 </span>            : 
<span class="lineNum">   14881 </span><span class="lineCov">          1 :         if (!(cfg = ast_config_load(config_filename, config_flags)) || !valid_config(cfg)) {</span>
<span class="lineNum">   14882 </span><span class="lineNoCov">          0 :                 res = AST_TEST_FAIL;</span>
<span class="lineNum">   14883 </span><span class="lineNoCov">          0 :                 goto cleanup;</span>
<span class="lineNum">   14884 </span>            :         }
<span class="lineNum">   14885 </span>            : 
<span class="lineNum">   14886 </span><span class="lineCov">          1 :         load_config_from_memory(1, cfg, NULL);</span>
<span class="lineNum">   14887 </span><span class="lineCov">          1 :         ast_config_destroy(cfg);</span>
<span class="lineNum">   14888 </span>            : 
<span class="lineNum">   14889 </span>            : #define CHECK(u, attr, value) else if (strcmp(u-&gt;attr, value)) { \
<span class="lineNum">   14890 </span>            :         ast_test_status_update(test, &quot;mailbox %s should have %s '%s', but has '%s'\n&quot;, \
<span class="lineNum">   14891 </span>            :         u-&gt;mailbox, #attr, value, u-&gt;attr); res = AST_TEST_FAIL; break; }
<span class="lineNum">   14892 </span>            : 
<span class="lineNum">   14893 </span><span class="lineCov">          1 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   14894 </span><span class="lineCov">          2 :         AST_LIST_TRAVERSE(&amp;users, vmu, list) {</span>
<span class="lineNum">   14895 </span><span class="lineCov">          1 :                 if (!strcmp(vmu-&gt;mailbox, &quot;00000001&quot;)) {</span>
<span class="lineNum">   14896 </span>            :                         if (0); /* trick to get CHECK to work */
<span class="lineNum">   14897 </span><span class="lineNoCov">          0 :                         CHECK(vmu, callback, &quot;othercontext&quot;)</span>
<span class="lineNum">   14898 </span><span class="lineNoCov">          0 :                         CHECK(vmu, locale, &quot;nl_NL.UTF-8&quot;)</span>
<span class="lineNum">   14899 </span><span class="lineNoCov">          0 :                         CHECK(vmu, zonetag, &quot;central&quot;)</span>
<span class="lineNum">   14900 </span><span class="lineCov">          1 :                 } else if (!strcmp(vmu-&gt;mailbox, &quot;00000002&quot;)) {</span>
<span class="lineNum">   14901 </span>            :                         if (0); /* trick to get CHECK to work */
<span class="lineNum">   14902 </span><span class="lineCov">          1 :                         CHECK(vmu, callback, &quot;somecontext&quot;)</span>
<span class="lineNum">   14903 </span><span class="lineCov">          1 :                         CHECK(vmu, locale, &quot;de_DE.UTF-8&quot;)</span>
<span class="lineNum">   14904 </span><span class="lineCov">          1 :                         CHECK(vmu, zonetag, &quot;european&quot;)</span>
<span class="lineNum">   14905 </span>            :                 }
<span class="lineNum">   14906 </span>            :         }
<span class="lineNum">   14907 </span><span class="lineCov">          1 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   14908 </span>            : 
<span class="lineNum">   14909 </span>            : #undef CHECK
<span class="lineNum">   14910 </span>            : 
<span class="lineNum">   14911 </span>            :         /* restore config */
<span class="lineNum">   14912 </span><span class="lineCov">          1 :         load_config(1); /* this might say &quot;Failed to load configuration file.&quot; */</span>
<span class="lineNum">   14913 </span>            : 
<span class="lineNum">   14914 </span><span class="lineCov">          1 : cleanup:</span>
<span class="lineNum">   14915 </span><span class="lineCov">          1 :         unlink(config_filename);</span>
<span class="lineNum">   14916 </span><span class="lineCov">          1 :         return res;</span>
<a name="14917"><span class="lineNum">   14917 </span>            : }</a>
<span class="lineNum">   14918 </span>            : 
<span class="lineNum">   14919 </span><span class="lineCov">       1074 : AST_TEST_DEFINE(test_voicemail_vm_info)</span>
<span class="lineNum">   14920 </span>            : {
<span class="lineNum">   14921 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   14922 </span><span class="lineCov">       1074 :         struct ast_channel *chan = NULL;</span>
<span class="lineNum">   14923 </span><span class="lineCov">       1074 :         const char testcontext[] = &quot;test&quot;;</span>
<span class="lineNum">   14924 </span><span class="lineCov">       1074 :         const char testmailbox[] = &quot;00000000&quot;;</span>
<span class="lineNum">   14925 </span><span class="lineCov">       1074 :         const char vminfo_cmd[] = &quot;VM_INFO&quot;;</span>
<span class="lineNum">   14926 </span>            :         char vminfo_buf[256], vminfo_args[256];
<span class="lineNum">   14927 </span><span class="lineCov">       1074 :         int res = AST_TEST_PASS;</span>
<span class="lineNum">   14928 </span><span class="lineCov">       1074 :         int test_ret = 0;</span>
<span class="lineNum">   14929 </span><span class="lineCov">       1074 :         int test_counter = 0;</span>
<span class="lineNum">   14930 </span>            : 
<span class="lineNum">   14931 </span>            :         struct {
<span class="lineNum">   14932 </span>            :                 char *vminfo_test_args;
<span class="lineNum">   14933 </span>            :                 char *vminfo_expected;
<span class="lineNum">   14934 </span>            :                 int vminfo_ret;
<span class="lineNum">   14935 </span><span class="lineCov">       1074 :         } test_items[] = {</span>
<span class="lineNum">   14936 </span>            :                 { &quot;&quot;, &quot;&quot;, -1 },                             /* Missing argument */
<span class="lineNum">   14937 </span>            :                 { &quot;00000000@test,badparam&quot;, &quot;&quot;, -1 },       /* Wrong argument */
<span class="lineNum">   14938 </span>            :                 { &quot;00000000@test&quot;, &quot;&quot;, -1 },                /* Missing argument */
<span class="lineNum">   14939 </span>            :                 { &quot;00000000@test,exists&quot;, &quot;1&quot;, 0 },
<span class="lineNum">   14940 </span>            :                 { &quot;11111111@test,exists&quot;, &quot;0&quot;, 0 }, /* Invalid mailbox */
<span class="lineNum">   14941 </span>            :                 { &quot;00000000@test,email&quot;, &quot;vm-info-test@example.net&quot;, 0 },
<span class="lineNum">   14942 </span>            :                 { &quot;11111111@test,email&quot;, &quot;&quot;, 0 },   /* Invalid mailbox */
<span class="lineNum">   14943 </span>            :                 { &quot;00000000@test,fullname&quot;, &quot;Test Framework Mailbox&quot;, 0 },
<span class="lineNum">   14944 </span>            :                 { &quot;00000000@test,pager&quot;, &quot;vm-info-pager-test@example.net&quot;, 0 },
<span class="lineNum">   14945 </span>            :                 { &quot;00000000@test,locale&quot;, &quot;en_US&quot;, 0 },
<span class="lineNum">   14946 </span>            :                 { &quot;00000000@test,tz&quot;, &quot;central&quot;, 0 },
<span class="lineNum">   14947 </span>            :                 { &quot;00000000@test,language&quot;, &quot;en&quot;, 0 },
<span class="lineNum">   14948 </span>            :                 { &quot;00000000@test,password&quot;, &quot;9876&quot;, 0 },
<span class="lineNum">   14949 </span>            :         };
<span class="lineNum">   14950 </span>            : 
<span class="lineNum">   14951 </span><span class="lineCov">       1074 :         switch (cmd) {</span>
<span class="lineNum">   14952 </span><span class="lineCov">       1073 :                 case TEST_INIT:</span>
<span class="lineNum">   14953 </span><span class="lineCov">       1073 :                         info-&gt;name = &quot;test_voicemail_vm_info&quot;;</span>
<span class="lineNum">   14954 </span><span class="lineCov">       1073 :                         info-&gt;category = &quot;/apps/app_voicemail/&quot;;</span>
<span class="lineNum">   14955 </span><span class="lineCov">       1073 :                         info-&gt;summary = &quot;VM_INFO unit test&quot;;</span>
<span class="lineNum">   14956 </span><span class="lineCov">       1073 :                         info-&gt;description =</span>
<span class="lineNum">   14957 </span>            :                                 &quot;This tests passing various parameters to VM_INFO&quot;;
<span class="lineNum">   14958 </span><span class="lineCov">       1073 :                         return AST_TEST_NOT_RUN;</span>
<span class="lineNum">   14959 </span><span class="lineCov">          1 :                 case TEST_EXECUTE:</span>
<span class="lineNum">   14960 </span><span class="lineCov">          1 :                         break;</span>
<span class="lineNum">   14961 </span>            :         }
<span class="lineNum">   14962 </span>            : 
<span class="lineNum">   14963 </span><span class="lineCov">          1 :         if (!(chan = ast_dummy_channel_alloc())) {</span>
<span class="lineNum">   14964 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Unable to create dummy channel\n&quot;);</span>
<span class="lineNum">   14965 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14966 </span>            :         }
<span class="lineNum">   14967 </span>            : 
<span class="lineNum">   14968 </span><span class="lineCov">          2 :         if (!(vmu = find_user(NULL, testcontext, testmailbox)) &amp;&amp;</span>
<span class="lineNum">   14969 </span><span class="lineCov">          1 :                         !(vmu = find_or_create(testcontext, testmailbox))) {</span>
<span class="lineNum">   14970 </span><span class="lineNoCov">          0 :                 ast_test_status_update(test, &quot;Cannot create vmu structure\n&quot;);</span>
<span class="lineNum">   14971 </span><span class="lineNoCov">          0 :                 chan = ast_channel_unref(chan);</span>
<span class="lineNum">   14972 </span><span class="lineNoCov">          0 :                 return AST_TEST_FAIL;</span>
<span class="lineNum">   14973 </span>            :         }
<span class="lineNum">   14974 </span>            : 
<span class="lineNum">   14975 </span><span class="lineCov">          1 :         populate_defaults(vmu);</span>
<span class="lineNum">   14976 </span>            : 
<span class="lineNum">   14977 </span><span class="lineCov">          1 :         vmu-&gt;email = ast_strdup(&quot;vm-info-test@example.net&quot;);</span>
<span class="lineNum">   14978 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;fullname, &quot;Test Framework Mailbox&quot;, sizeof(vmu-&gt;fullname));</span>
<span class="lineNum">   14979 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;pager, &quot;vm-info-pager-test@example.net&quot;, sizeof(vmu-&gt;pager));</span>
<span class="lineNum">   14980 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;language, &quot;en&quot;, sizeof(vmu-&gt;language));</span>
<span class="lineNum">   14981 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;zonetag, &quot;central&quot;, sizeof(vmu-&gt;zonetag));</span>
<span class="lineNum">   14982 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;locale, &quot;en_US&quot;, sizeof(vmu-&gt;zonetag));</span>
<span class="lineNum">   14983 </span><span class="lineCov">          1 :         ast_copy_string(vmu-&gt;password, &quot;9876&quot;, sizeof(vmu-&gt;password));</span>
<span class="lineNum">   14984 </span>            : 
<span class="lineNum">   14985 </span><span class="lineCov">         14 :         for (test_counter = 0; test_counter &lt; ARRAY_LEN(test_items); test_counter++) {</span>
<span class="lineNum">   14986 </span><span class="lineCov">         13 :                 ast_copy_string(vminfo_args, test_items[test_counter].vminfo_test_args, sizeof(vminfo_args));</span>
<span class="lineNum">   14987 </span><span class="lineCov">         13 :                 test_ret = acf_vm_info(chan, vminfo_cmd, vminfo_args, vminfo_buf, sizeof(vminfo_buf));</span>
<span class="lineNum">   14988 </span><span class="lineCov">         13 :                 if (strcmp(vminfo_buf, test_items[test_counter].vminfo_expected)) {</span>
<span class="lineNum">   14989 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;VM_INFO respose was: '%s', but expected: '%s'\n&quot;, vminfo_buf, test_items[test_counter].vminfo_expected);</span>
<span class="lineNum">   14990 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14991 </span>            :                 }
<span class="lineNum">   14992 </span><span class="lineCov">         13 :                 if (!(test_ret == test_items[test_counter].vminfo_ret)) {</span>
<span class="lineNum">   14993 </span><span class="lineNoCov">          0 :                         ast_test_status_update(test, &quot;VM_INFO return code was: '%i', but expected '%i'\n&quot;, test_ret, test_items[test_counter].vminfo_ret);</span>
<span class="lineNum">   14994 </span><span class="lineNoCov">          0 :                         res = AST_TEST_FAIL;</span>
<span class="lineNum">   14995 </span>            :                 }
<span class="lineNum">   14996 </span>            :         }
<span class="lineNum">   14997 </span>            : 
<span class="lineNum">   14998 </span><span class="lineCov">          1 :         chan = ast_channel_unref(chan);</span>
<span class="lineNum">   14999 </span><span class="lineCov">          1 :         free_user(vmu);</span>
<span class="lineNum">   15000 </span><span class="lineCov">          1 :         return res;</span>
<span class="lineNum">   15001 </span>            : }
<span class="lineNum">   15002 </span>            : #endif /* defined(TEST_FRAMEWORK) */
<span class="lineNum">   15003 </span>            : 
<span class="lineNum">   15004 </span>            : static const struct ast_vm_functions vm_table = {
<span class="lineNum">   15005 </span>            :         .module_version = VM_MODULE_VERSION,
<span class="lineNum">   15006 </span>            :         .module_name = AST_MODULE,
<span class="lineNum">   15007 </span>            : 
<span class="lineNum">   15008 </span>            :         .has_voicemail = has_voicemail,
<span class="lineNum">   15009 </span>            :         .inboxcount = inboxcount,
<span class="lineNum">   15010 </span>            :         .inboxcount2 = inboxcount2,
<span class="lineNum">   15011 </span>            :         .messagecount = messagecount,
<span class="lineNum">   15012 </span>            :         .copy_recording_to_vm = msg_create_from_file,
<span class="lineNum">   15013 </span>            :         .index_to_foldername = vm_index_to_foldername,
<span class="lineNum">   15014 </span>            :         .mailbox_snapshot_create = vm_mailbox_snapshot_create,
<span class="lineNum">   15015 </span>            :         .mailbox_snapshot_destroy = vm_mailbox_snapshot_destroy,
<span class="lineNum">   15016 </span>            :         .msg_move = vm_msg_move,
<span class="lineNum">   15017 </span>            :         .msg_remove = vm_msg_remove,
<span class="lineNum">   15018 </span>            :         .msg_forward = vm_msg_forward,
<span class="lineNum">   15019 </span>            :         .msg_play = vm_msg_play,
<span class="lineNum">   15020 </span>            : };
<span class="lineNum">   15021 </span>            : 
<span class="lineNum">   15022 </span>            : static const struct ast_vm_greeter_functions vm_greeter_table = {
<span class="lineNum">   15023 </span>            :         .module_version = VM_GREETER_MODULE_VERSION,
<span class="lineNum">   15024 </span>            :         .module_name = AST_MODULE,
<span class="lineNum">   15025 </span>            : 
<span class="lineNum">   15026 </span>            :         .sayname = vm_sayname,
<a name="15027"><span class="lineNum">   15027 </span>            : };</a>
<span class="lineNum">   15028 </span>            : 
<span class="lineNum">   15029 </span><span class="lineNoCov">          0 : static int reload(void)</span>
<span class="lineNum">   15030 </span>            : {
<span class="lineNum">   15031 </span><span class="lineNoCov">          0 :         return load_config(1);</span>
<a name="15032"><span class="lineNum">   15032 </span>            : }</a>
<span class="lineNum">   15033 </span>            : 
<span class="lineNum">   15034 </span><span class="lineCov">       1069 : static int unload_module(void)</span>
<span class="lineNum">   15035 </span>            : {
<span class="lineNum">   15036 </span>            :         int res;
<span class="lineNum">   15037 </span>            : 
<span class="lineNum">   15038 </span><span class="lineCov">       1069 :         res = ast_unregister_application(app);</span>
<span class="lineNum">   15039 </span><span class="lineCov">       1069 :         res |= ast_unregister_application(app2);</span>
<span class="lineNum">   15040 </span><span class="lineCov">       1069 :         res |= ast_unregister_application(app3);</span>
<span class="lineNum">   15041 </span><span class="lineCov">       1069 :         res |= ast_unregister_application(app4);</span>
<span class="lineNum">   15042 </span><span class="lineCov">       1069 :         res |= ast_unregister_application(playmsg_app);</span>
<span class="lineNum">   15043 </span><span class="lineCov">       1069 :         res |= ast_unregister_application(sayname_app);</span>
<span class="lineNum">   15044 </span><span class="lineCov">       1069 :         res |= ast_custom_function_unregister(&amp;mailbox_exists_acf);</span>
<span class="lineNum">   15045 </span><span class="lineCov">       1069 :         res |= ast_custom_function_unregister(&amp;vm_info_acf);</span>
<span class="lineNum">   15046 </span><span class="lineCov">       1069 :         res |= ast_manager_unregister(&quot;VoicemailUsersList&quot;);</span>
<span class="lineNum">   15047 </span><span class="lineCov">       1069 :         res |= ast_manager_unregister(&quot;VoicemailUserStatus&quot;);</span>
<span class="lineNum">   15048 </span><span class="lineCov">       1069 :         res |= ast_manager_unregister(&quot;VoicemailRefresh&quot;);</span>
<span class="lineNum">   15049 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   15050 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_vmsayname);</span>
<span class="lineNum">   15051 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_msgcount);</span>
<span class="lineNum">   15052 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_vmuser);</span>
<span class="lineNum">   15053 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_notify_endl);</span>
<span class="lineNum">   15054 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_load_config);</span>
<span class="lineNum">   15055 </span><span class="lineCov">       1069 :         res |= AST_TEST_UNREGISTER(test_voicemail_vm_info);</span>
<span class="lineNum">   15056 </span>            : #endif
<span class="lineNum">   15057 </span><span class="lineCov">       1069 :         ast_cli_unregister_multiple(cli_voicemail, ARRAY_LEN(cli_voicemail));</span>
<span class="lineNum">   15058 </span><span class="lineCov">       1069 :         ast_vm_unregister(vm_table.module_name);</span>
<span class="lineNum">   15059 </span><span class="lineCov">       1069 :         ast_vm_greeter_unregister(vm_greeter_table.module_name);</span>
<span class="lineNum">   15060 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   15061 </span><span class="lineCov">       1069 :         ast_uninstall_vm_test_functions();</span>
<span class="lineNum">   15062 </span>            : #endif
<span class="lineNum">   15063 </span><span class="lineCov">       1069 :         ao2_ref(inprocess_container, -1);</span>
<span class="lineNum">   15064 </span>            : 
<span class="lineNum">   15065 </span><span class="lineCov">       1069 :         if (poll_thread != AST_PTHREADT_NULL)</span>
<span class="lineNum">   15066 </span><span class="lineNoCov">          0 :                 stop_poll_thread();</span>
<span class="lineNum">   15067 </span>            : 
<span class="lineNum">   15068 </span><span class="lineCov">       1069 :         mwi_subscription_tps = ast_taskprocessor_unreference(mwi_subscription_tps);</span>
<span class="lineNum">   15069 </span><span class="lineCov">       1069 :         ast_unload_realtime(&quot;voicemail&quot;);</span>
<span class="lineNum">   15070 </span><span class="lineCov">       1069 :         ast_unload_realtime(&quot;voicemail_data&quot;);</span>
<span class="lineNum">   15071 </span>            : 
<span class="lineNum">   15072 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   15073 </span>            :         imap_close_subscribed_mailboxes();
<span class="lineNum">   15074 </span>            : #endif
<span class="lineNum">   15075 </span><span class="lineCov">       1069 :         free_vm_users();</span>
<span class="lineNum">   15076 </span><span class="lineCov">       1069 :         free_vm_zones();</span>
<span class="lineNum">   15077 </span><span class="lineCov">       1069 :         return res;</span>
<span class="lineNum">   15078 </span>            : }
<span class="lineNum">   15079 </span>            : 
<span class="lineNum">   15080 </span>            : /*!
<span class="lineNum">   15081 </span>            :  * \brief Load the module
<span class="lineNum">   15082 </span>            :  *
<span class="lineNum">   15083 </span>            :  * Module loading including tests for configuration or dependencies.
<span class="lineNum">   15084 </span>            :  * This function can return AST_MODULE_LOAD_FAILURE, AST_MODULE_LOAD_DECLINE,
<span class="lineNum">   15085 </span>            :  * or AST_MODULE_LOAD_SUCCESS.
<span class="lineNum">   15086 </span>            :  *
<span class="lineNum">   15087 </span>            :  * If a dependency, allocation or environment variable fails tests, return AST_MODULE_LOAD_FAILURE.
<span class="lineNum">   15088 </span>            :  *
<span class="lineNum">   15089 </span>            :  * If the module can't load the configuration file, can't register as a provider or
<span class="lineNum">   15090 </span>            :  * has another issue not fatal to Asterisk itself, return AST_MODULE_LOAD_DECLINE.
<span class="lineNum">   15091 </span>            :  *
<a name="15092"><span class="lineNum">   15092 </span>            :  * On success return AST_MODULE_LOAD_SUCCESS.</a>
<span class="lineNum">   15093 </span>            :  */
<span class="lineNum">   15094 </span><span class="lineCov">       1073 : static int load_module(void)</span>
<span class="lineNum">   15095 </span>            : {
<span class="lineNum">   15096 </span>            :         int res;
<span class="lineNum">   15097 </span><span class="lineCov">       1073 :         my_umask = umask(0);</span>
<span class="lineNum">   15098 </span><span class="lineCov">       1073 :         umask(my_umask);</span>
<span class="lineNum">   15099 </span>            : 
<span class="lineNum">   15100 </span><span class="lineCov">       1073 :         if (!(inprocess_container = ao2_container_alloc(573, inprocess_hash_fn, inprocess_cmp_fn))) {</span>
<span class="lineNum">   15101 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">   15102 </span>            :         }
<span class="lineNum">   15103 </span>            : 
<span class="lineNum">   15104 </span>            :         /* compute the location of the voicemail spool directory */
<span class="lineNum">   15105 </span><span class="lineCov">       1073 :         snprintf(VM_SPOOL_DIR, sizeof(VM_SPOOL_DIR), &quot;%s/voicemail/&quot;, ast_config_AST_SPOOL_DIR);</span>
<span class="lineNum">   15106 </span>            : 
<span class="lineNum">   15107 </span><span class="lineCov">       1073 :         if (!(mwi_subscription_tps = ast_taskprocessor_get(&quot;app_voicemail&quot;, 0))) {</span>
<span class="lineNum">   15108 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;failed to reference mwi subscription taskprocessor.  MWI will not work\n&quot;);</span>
<span class="lineNum">   15109 </span>            :         }
<span class="lineNum">   15110 </span>            : 
<span class="lineNum">   15111 </span><span class="lineCov">       1073 :         if ((res = load_config(0))) {</span>
<span class="lineNum">   15112 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">   15113 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">   15114 </span>            :         }
<span class="lineNum">   15115 </span>            : 
<span class="lineNum">   15116 </span><span class="lineCov">       1073 :         res = ast_register_application_xml(app, vm_exec);</span>
<span class="lineNum">   15117 </span><span class="lineCov">       1073 :         res |= ast_register_application_xml(app2, vm_execmain);</span>
<span class="lineNum">   15118 </span><span class="lineCov">       1073 :         res |= ast_register_application_xml(app3, vm_box_exists);</span>
<span class="lineNum">   15119 </span><span class="lineCov">       1073 :         res |= ast_register_application_xml(app4, vmauthenticate);</span>
<span class="lineNum">   15120 </span><span class="lineCov">       1073 :         res |= ast_register_application_xml(playmsg_app, vm_playmsgexec);</span>
<span class="lineNum">   15121 </span><span class="lineCov">       1073 :         res |= ast_register_application_xml(sayname_app, vmsayname_exec);</span>
<span class="lineNum">   15122 </span><span class="lineCov">       1073 :         res |= ast_custom_function_register(&amp;mailbox_exists_acf);</span>
<span class="lineNum">   15123 </span><span class="lineCov">       1073 :         res |= ast_custom_function_register(&amp;vm_info_acf);</span>
<span class="lineNum">   15124 </span><span class="lineCov">       1073 :         res |= ast_manager_register_xml(&quot;VoicemailUsersList&quot;, EVENT_FLAG_CALL | EVENT_FLAG_REPORTING, manager_list_voicemail_users);</span>
<span class="lineNum">   15125 </span><span class="lineCov">       1073 :         res |= ast_manager_register_xml(&quot;VoicemailUserStatus&quot;, EVENT_FLAG_CALL | EVENT_FLAG_REPORTING, manager_status_voicemail_user);</span>
<span class="lineNum">   15126 </span><span class="lineCov">       1073 :         res |= ast_manager_register_xml(&quot;VoicemailRefresh&quot;, EVENT_FLAG_USER, manager_voicemail_refresh);</span>
<span class="lineNum">   15127 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   15128 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_vmsayname);</span>
<span class="lineNum">   15129 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_msgcount);</span>
<span class="lineNum">   15130 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_vmuser);</span>
<span class="lineNum">   15131 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_notify_endl);</span>
<span class="lineNum">   15132 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_load_config);</span>
<span class="lineNum">   15133 </span><span class="lineCov">       1073 :         res |= AST_TEST_REGISTER(test_voicemail_vm_info);</span>
<span class="lineNum">   15134 </span>            : #endif
<span class="lineNum">   15135 </span>            : 
<span class="lineNum">   15136 </span><span class="lineCov">       1073 :         if (res) {</span>
<span class="lineNum">   15137 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Failure registering applications, functions or tests\n&quot;);</span>
<span class="lineNum">   15138 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">   15139 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">   15140 </span>            :         }
<span class="lineNum">   15141 </span>            : 
<span class="lineNum">   15142 </span>            :         /* ast_vm_register may return DECLINE if another module registered for vm */
<span class="lineNum">   15143 </span><span class="lineCov">       1073 :         res = ast_vm_register(&amp;vm_table);</span>
<span class="lineNum">   15144 </span><span class="lineCov">       1073 :         if (res) {</span>
<span class="lineNum">   15145 </span><span class="lineCov">       1011 :                 ast_log(LOG_ERROR, &quot;Failure registering as a voicemail provider\n&quot;);</span>
<span class="lineNum">   15146 </span><span class="lineCov">       1011 :                 unload_module();</span>
<span class="lineNum">   15147 </span><span class="lineCov">       1011 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">   15148 </span>            :         }
<span class="lineNum">   15149 </span>            : 
<span class="lineNum">   15150 </span>            :         /* ast_vm_greeter_register may return DECLINE if another module registered as a greeter */
<span class="lineNum">   15151 </span><span class="lineCov">         62 :         res = ast_vm_greeter_register(&amp;vm_greeter_table);</span>
<span class="lineNum">   15152 </span><span class="lineCov">         62 :         if (res) {</span>
<span class="lineNum">   15153 </span><span class="lineNoCov">          0 :                 ast_log(LOG_ERROR, &quot;Failure registering as a greeter provider\n&quot;);</span>
<span class="lineNum">   15154 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">   15155 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">   15156 </span>            :         }
<span class="lineNum">   15157 </span>            : 
<span class="lineNum">   15158 </span><span class="lineCov">         62 :         ast_cli_register_multiple(cli_voicemail, ARRAY_LEN(cli_voicemail));</span>
<span class="lineNum">   15159 </span>            : 
<span class="lineNum">   15160 </span>            : #ifdef TEST_FRAMEWORK
<span class="lineNum">   15161 </span><span class="lineCov">         62 :         ast_install_vm_test_functions(vm_test_create_user, vm_test_destroy_user);</span>
<span class="lineNum">   15162 </span>            : #endif
<span class="lineNum">   15163 </span>            : 
<span class="lineNum">   15164 </span><span class="lineCov">         62 :         ast_realtime_require_field(&quot;voicemail&quot;, &quot;uniqueid&quot;, RQ_UINTEGER3, 11, &quot;password&quot;, RQ_CHAR, 10, SENTINEL);</span>
<span class="lineNum">   15165 </span><span class="lineCov">         62 :         ast_realtime_require_field(&quot;voicemail_data&quot;, &quot;filename&quot;, RQ_CHAR, 30, &quot;duration&quot;, RQ_UINTEGER3, 5, SENTINEL);</span>
<span class="lineNum">   15166 </span>            : 
<span class="lineNum">   15167 </span><span class="lineCov">         62 :         return AST_MODULE_LOAD_SUCCESS;</span>
<a name="15168"><span class="lineNum">   15168 </span>            : }</a>
<span class="lineNum">   15169 </span>            : 
<span class="lineNum">   15170 </span><span class="lineCov">          2 : static int dialout(struct ast_channel *chan, struct ast_vm_user *vmu, char *num, char *outgoing_context)</span>
<span class="lineNum">   15171 </span>            : {
<span class="lineNum">   15172 </span><span class="lineCov">          2 :         int cmd = 0;</span>
<span class="lineNum">   15173 </span><span class="lineCov">          2 :         char destination[80] = &quot;&quot;;</span>
<span class="lineNum">   15174 </span><span class="lineCov">          2 :         int retries = 0;</span>
<span class="lineNum">   15175 </span>            : 
<span class="lineNum">   15176 </span><span class="lineCov">          2 :         if (!num) {</span>
<span class="lineNum">   15177 </span><span class="lineCov">          1 :                 ast_verb(3, &quot;Destination number will be entered manually\n&quot;);</span>
<span class="lineNum">   15178 </span><span class="lineCov">          2 :                 while (retries &lt; 3 &amp;&amp; cmd != 't') {</span>
<span class="lineNum">   15179 </span><span class="lineCov">          1 :                         destination[1] = '\0';</span>
<span class="lineNum">   15180 </span><span class="lineCov">          1 :                         destination[0] = cmd = ast_play_and_wait(chan, &quot;vm-enter-num-to-call&quot;);</span>
<span class="lineNum">   15181 </span><span class="lineCov">          1 :                         if (!cmd)</span>
<span class="lineNum">   15182 </span><span class="lineNoCov">          0 :                                 destination[0] = cmd = ast_play_and_wait(chan, &quot;vm-then-pound&quot;);</span>
<span class="lineNum">   15183 </span><span class="lineCov">          1 :                         if (!cmd)</span>
<span class="lineNum">   15184 </span><span class="lineNoCov">          0 :                                 destination[0] = cmd = ast_play_and_wait(chan, &quot;vm-star-cancel&quot;);</span>
<span class="lineNum">   15185 </span><span class="lineCov">          1 :                         if (!cmd) {</span>
<span class="lineNum">   15186 </span><span class="lineNoCov">          0 :                                 cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   15187 </span><span class="lineNoCov">          0 :                                 if (cmd)</span>
<span class="lineNum">   15188 </span><span class="lineNoCov">          0 :                                         destination[0] = cmd;</span>
<span class="lineNum">   15189 </span>            :                         }
<span class="lineNum">   15190 </span><span class="lineCov">          1 :                         if (!cmd) {</span>
<span class="lineNum">   15191 </span><span class="lineNoCov">          0 :                                 retries++;</span>
<span class="lineNum">   15192 </span>            :                         } else {
<span class="lineNum">   15193 </span>            : 
<span class="lineNum">   15194 </span><span class="lineCov">          1 :                                 if (cmd &lt; 0)</span>
<span class="lineNum">   15195 </span><span class="lineNoCov">          0 :                                         return 0;</span>
<span class="lineNum">   15196 </span><span class="lineCov">          1 :                                 if (cmd == '*') {</span>
<span class="lineNum">   15197 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;User hit '*' to cancel outgoing call\n&quot;);</span>
<span class="lineNum">   15198 </span><span class="lineNoCov">          0 :                                         return 0;</span>
<span class="lineNum">   15199 </span>            :                                 }
<span class="lineNum">   15200 </span><span class="lineCov">          1 :                                 if ((cmd = ast_readstring(chan, destination + strlen(destination), sizeof(destination) - 1, 6000, 10000, &quot;#&quot;)) &lt; 0)</span>
<span class="lineNum">   15201 </span><span class="lineNoCov">          0 :                                         retries++;</span>
<span class="lineNum">   15202 </span>            :                                 else
<span class="lineNum">   15203 </span><span class="lineCov">          1 :                                         cmd = 't';</span>
<span class="lineNum">   15204 </span>            :                         }
<span class="lineNum">   15205 </span><span class="lineCov">          1 :                         ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   15206 </span>            :                                 isprint(cmd) ? cmd : '?', isprint(cmd) ? cmd : '?');
<span class="lineNum">   15207 </span>            :                 }
<span class="lineNum">   15208 </span><span class="lineCov">          1 :                 if (retries &gt;= 3) {</span>
<span class="lineNum">   15209 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">   15210 </span>            :                 }
<span class="lineNum">   15211 </span>            : 
<span class="lineNum">   15212 </span>            :         } else {
<span class="lineNum">   15213 </span><span class="lineCov">          1 :                 ast_verb(3, &quot;Destination number is CID number '%s'\n&quot;, num);</span>
<span class="lineNum">   15214 </span><span class="lineCov">          1 :                 ast_copy_string(destination, num, sizeof(destination));</span>
<span class="lineNum">   15215 </span>            :         }
<span class="lineNum">   15216 </span>            : 
<span class="lineNum">   15217 </span><span class="lineCov">          2 :         if (!ast_strlen_zero(destination)) {</span>
<span class="lineNum">   15218 </span><span class="lineCov">          2 :                 if (destination[strlen(destination) -1 ] == '*')</span>
<span class="lineNum">   15219 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">   15220 </span><span class="lineCov">          2 :                 ast_verb(3, &quot;Placing outgoing call to extension '%s' in context '%s' from context '%s'\n&quot;, destination, outgoing_context, ast_channel_context(chan));</span>
<span class="lineNum">   15221 </span><span class="lineCov">          2 :                 ast_channel_exten_set(chan, destination);</span>
<span class="lineNum">   15222 </span><span class="lineCov">          2 :                 ast_channel_context_set(chan, outgoing_context);</span>
<span class="lineNum">   15223 </span><span class="lineCov">          2 :                 ast_channel_priority_set(chan, 0);</span>
<span class="lineNum">   15224 </span><span class="lineCov">          2 :                 return 9;</span>
<span class="lineNum">   15225 </span>            :         }
<span class="lineNum">   15226 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">   15227 </span>            : }
<span class="lineNum">   15228 </span>            : 
<span class="lineNum">   15229 </span>            : /*!
<span class="lineNum">   15230 </span>            :  * \brief The advanced options within a message.
<span class="lineNum">   15231 </span>            :  * \param chan
<span class="lineNum">   15232 </span>            :  * \param vmu
<span class="lineNum">   15233 </span>            :  * \param vms
<span class="lineNum">   15234 </span>            :  * \param msg
<span class="lineNum">   15235 </span>            :  * \param option
<span class="lineNum">   15236 </span>            :  * \param record_gain
<span class="lineNum">   15237 </span>            :  *
<span class="lineNum">   15238 </span>            :  * Provides handling for the play message envelope, call the person back, or reply to message.
<span class="lineNum">   15239 </span>            :  *
<a name="15240"><span class="lineNum">   15240 </span>            :  * \return zero on success, -1 on error.</a>
<span class="lineNum">   15241 </span>            :  */
<span class="lineNum">   15242 </span><span class="lineCov">          2 : static int advanced_options(struct ast_channel *chan, struct ast_vm_user *vmu, struct vm_state *vms, int msg, int option, signed char record_gain)</span>
<span class="lineNum">   15243 </span>            : {
<span class="lineNum">   15244 </span><span class="lineCov">          2 :         int res = 0;</span>
<span class="lineNum">   15245 </span>            :         char filename[PATH_MAX];
<span class="lineNum">   15246 </span><span class="lineCov">          2 :         struct ast_config *msg_cfg = NULL;</span>
<span class="lineNum">   15247 </span>            :         const char *origtime, *context;
<span class="lineNum">   15248 </span>            :         char *name, *num;
<span class="lineNum">   15249 </span><span class="lineCov">          2 :         int retries = 0;</span>
<span class="lineNum">   15250 </span>            :         char *cid;
<span class="lineNum">   15251 </span><span class="lineCov">          2 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE, };</span>
<span class="lineNum">   15252 </span>            : 
<span class="lineNum">   15253 </span><span class="lineCov">          2 :         vms-&gt;starting = 0;</span>
<span class="lineNum">   15254 </span>            : 
<span class="lineNum">   15255 </span><span class="lineCov">          2 :         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, msg);</span>
<span class="lineNum">   15256 </span>            : 
<span class="lineNum">   15257 </span>            :         /* Retrieve info from VM attribute file */
<span class="lineNum">   15258 </span><span class="lineCov">          2 :         snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, vms-&gt;fn);</span>
<span class="lineNum">   15259 </span>            :         RETRIEVE(vms-&gt;curdir, vms-&gt;curmsg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   15260 </span><span class="lineCov">          2 :         msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">   15261 </span>            :         DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   15262 </span><span class="lineCov">          2 :         if (!valid_config(msg_cfg)) {</span>
<span class="lineNum">   15263 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;No message attribute file?!! (%s)\n&quot;, filename);</span>
<span class="lineNum">   15264 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   15265 </span>            :         }
<span class="lineNum">   15266 </span>            : 
<span class="lineNum">   15267 </span><span class="lineCov">          2 :         if (!(origtime = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origtime&quot;))) {</span>
<span class="lineNum">   15268 </span><span class="lineNoCov">          0 :                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15269 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">   15270 </span>            :         }
<span class="lineNum">   15271 </span>            : 
<span class="lineNum">   15272 </span><span class="lineCov">          2 :         cid = ast_strdupa(ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;));</span>
<span class="lineNum">   15273 </span>            : 
<span class="lineNum">   15274 </span><span class="lineCov">          2 :         context = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;context&quot;);</span>
<span class="lineNum">   15275 </span><span class="lineCov">          2 :         if (!strncasecmp(&quot;macro&quot;, context, 5)) /* Macro names in contexts are useless for our needs */</span>
<span class="lineNum">   15276 </span><span class="lineNoCov">          0 :                 context = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;macrocontext&quot;);</span>
<span class="lineNum">   15277 </span><span class="lineCov">          2 :         switch (option) {</span>
<span class="lineNum">   15278 </span><span class="lineNoCov">          0 :         case 3: /* Play message envelope */</span>
<span class="lineNum">   15279 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   15280 </span><span class="lineNoCov">          0 :                         res = play_message_datetime(chan, vmu, origtime, filename);</span>
<span class="lineNum">   15281 </span>            :                 }
<span class="lineNum">   15282 </span><span class="lineNoCov">          0 :                 if (!res) {</span>
<span class="lineNum">   15283 </span><span class="lineNoCov">          0 :                         res = play_message_callerid(chan, vms, cid, context, 0, 1);</span>
<span class="lineNum">   15284 </span>            :                 }
<span class="lineNum">   15285 </span>            : 
<span class="lineNum">   15286 </span><span class="lineNoCov">          0 :                 res = 't';</span>
<span class="lineNum">   15287 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">   15288 </span>            : 
<span class="lineNum">   15289 </span><span class="lineCov">          1 :         case 2: /* Call back */</span>
<span class="lineNum">   15290 </span>            : 
<span class="lineNum">   15291 </span><span class="lineCov">          1 :                 if (ast_strlen_zero(cid))</span>
<span class="lineNum">   15292 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   15293 </span>            : 
<span class="lineNum">   15294 </span><span class="lineCov">          1 :                 ast_callerid_parse(cid, &amp;name, &amp;num);</span>
<span class="lineNum">   15295 </span><span class="lineCov">          2 :                 while ((res &gt; -1) &amp;&amp; (res != 't')) {</span>
<span class="lineNum">   15296 </span>            :                         switch (res) {
<span class="lineNum">   15297 </span><span class="lineCov">          1 :                         case '1':</span>
<span class="lineNum">   15298 </span><span class="lineCov">          1 :                                 if (num) {</span>
<span class="lineNum">   15299 </span>            :                                         /* Dial the CID number */
<span class="lineNum">   15300 </span><span class="lineCov">          1 :                                         res = dialout(chan, vmu, num, vmu-&gt;callback);</span>
<span class="lineNum">   15301 </span><span class="lineCov">          1 :                                         if (res) {</span>
<span class="lineNum">   15302 </span><span class="lineCov">          1 :                                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15303 </span><span class="lineCov">          1 :                                                 return 9;</span>
<span class="lineNum">   15304 </span>            :                                         }
<span class="lineNum">   15305 </span>            :                                 } else {
<span class="lineNum">   15306 </span><span class="lineNoCov">          0 :                                         res = '2';</span>
<span class="lineNum">   15307 </span>            :                                 }
<span class="lineNum">   15308 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15309 </span>            : 
<span class="lineNum">   15310 </span><span class="lineNoCov">          0 :                         case '2':</span>
<span class="lineNum">   15311 </span>            :                                 /* Want to enter a different number, can only do this if there's a dialout context for this user */
<span class="lineNum">   15312 </span><span class="lineNoCov">          0 :                                 if (!ast_strlen_zero(vmu-&gt;dialout)) {</span>
<span class="lineNum">   15313 </span><span class="lineNoCov">          0 :                                         res = dialout(chan, vmu, NULL, vmu-&gt;dialout);</span>
<span class="lineNum">   15314 </span><span class="lineNoCov">          0 :                                         if (res) {</span>
<span class="lineNum">   15315 </span><span class="lineNoCov">          0 :                                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15316 </span><span class="lineNoCov">          0 :                                                 return 9;</span>
<span class="lineNum">   15317 </span>            :                                         }
<span class="lineNum">   15318 </span>            :                                 } else {
<span class="lineNum">   15319 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;Caller can not specify callback number - no dialout context available\n&quot;);</span>
<span class="lineNum">   15320 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15321 </span>            :                                 }
<span class="lineNum">   15322 </span><span class="lineNoCov">          0 :                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15323 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">   15324 </span><span class="lineNoCov">          0 :                         case '*':</span>
<span class="lineNum">   15325 </span><span class="lineNoCov">          0 :                                 res = 't';</span>
<span class="lineNum">   15326 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15327 </span><span class="lineNoCov">          0 :                         case '3':</span>
<span class="lineNum">   15328 </span>            :                         case '4':
<span class="lineNum">   15329 </span>            :                         case '5':
<span class="lineNum">   15330 </span>            :                         case '6':
<span class="lineNum">   15331 </span>            :                         case '7':
<span class="lineNum">   15332 </span>            :                         case '8':
<span class="lineNum">   15333 </span>            :                         case '9':
<span class="lineNum">   15334 </span>            :                         case '0':
<span class="lineNum">   15335 </span>            : 
<span class="lineNum">   15336 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15337 </span><span class="lineNoCov">          0 :                                 retries++;</span>
<span class="lineNum">   15338 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15339 </span><span class="lineCov">          1 :                         default:</span>
<span class="lineNum">   15340 </span><span class="lineCov">          1 :                                 if (num) {</span>
<span class="lineNum">   15341 </span><span class="lineCov">          1 :                                         ast_verb(3, &quot;Confirm CID number '%s' is number to use for callback\n&quot;, num);</span>
<span class="lineNum">   15342 </span><span class="lineCov">          1 :                                         res = ast_play_and_wait(chan, &quot;vm-num-i-have&quot;);</span>
<span class="lineNum">   15343 </span><span class="lineCov">          1 :                                         if (!res)</span>
<span class="lineNum">   15344 </span><span class="lineNoCov">          0 :                                                 res = play_message_callerid(chan, vms, num, vmu-&gt;context, 1, 1);</span>
<span class="lineNum">   15345 </span><span class="lineCov">          1 :                                         if (!res)</span>
<span class="lineNum">   15346 </span><span class="lineNoCov">          0 :                                                 res = ast_play_and_wait(chan, &quot;vm-tocallnum&quot;);</span>
<span class="lineNum">   15347 </span>            :                                         /* Only prompt for a caller-specified number if there is a dialout context specified */
<span class="lineNum">   15348 </span><span class="lineCov">          1 :                                         if (!ast_strlen_zero(vmu-&gt;dialout)) {</span>
<span class="lineNum">   15349 </span><span class="lineNoCov">          0 :                                                 if (!res)</span>
<span class="lineNum">   15350 </span><span class="lineNoCov">          0 :                                                         res = ast_play_and_wait(chan, &quot;vm-calldiffnum&quot;);</span>
<span class="lineNum">   15351 </span>            :                                         }
<span class="lineNum">   15352 </span>            :                                 } else {
<span class="lineNum">   15353 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-nonumber&quot;);</span>
<span class="lineNum">   15354 </span><span class="lineNoCov">          0 :                                         if (!ast_strlen_zero(vmu-&gt;dialout)) {</span>
<span class="lineNum">   15355 </span><span class="lineNoCov">          0 :                                                 if (!res)</span>
<span class="lineNum">   15356 </span><span class="lineNoCov">          0 :                                                         res = ast_play_and_wait(chan, &quot;vm-toenternumber&quot;);</span>
<span class="lineNum">   15357 </span>            :                                         }
<span class="lineNum">   15358 </span>            :                                 }
<span class="lineNum">   15359 </span><span class="lineCov">          1 :                                 if (!res) {</span>
<span class="lineNum">   15360 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-star-cancel&quot;);</span>
<span class="lineNum">   15361 </span>            :                                 }
<span class="lineNum">   15362 </span><span class="lineCov">          1 :                                 if (!res) {</span>
<span class="lineNum">   15363 </span><span class="lineNoCov">          0 :                                         res = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   15364 </span>            :                                 }
<span class="lineNum">   15365 </span><span class="lineCov">          1 :                                 if (!res) {</span>
<span class="lineNum">   15366 </span><span class="lineNoCov">          0 :                                         retries++;</span>
<span class="lineNum">   15367 </span><span class="lineNoCov">          0 :                                         if (retries &gt; 3) {</span>
<span class="lineNum">   15368 </span><span class="lineNoCov">          0 :                                                 res = 't';</span>
<span class="lineNum">   15369 </span>            :                                         }
<span class="lineNum">   15370 </span>            :                                 }
<span class="lineNum">   15371 </span><span class="lineCov">          1 :                                 ast_test_suite_event_notify(&quot;USERPRESS&quot;, &quot;Message: User pressed %c\r\nDTMF: %c&quot;,</span>
<span class="lineNum">   15372 </span>            :                                         isprint(res) ? res : '?', isprint(res) ? res : '?');
<span class="lineNum">   15373 </span><span class="lineCov">          1 :                                 break;</span>
<span class="lineNum">   15374 </span>            : 
<span class="lineNum">   15375 </span>            :                         }
<span class="lineNum">   15376 </span><span class="lineCov">          1 :                         if (res == 't')</span>
<span class="lineNum">   15377 </span><span class="lineNoCov">          0 :                                 res = 0;</span>
<span class="lineNum">   15378 </span><span class="lineCov">          1 :                         else if (res == '*')</span>
<span class="lineNum">   15379 </span><span class="lineNoCov">          0 :                                 res = -1;</span>
<span class="lineNum">   15380 </span>            :                 }
<span class="lineNum">   15381 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">   15382 </span>            : 
<span class="lineNum">   15383 </span><span class="lineCov">          1 :         case 1: /* Reply */</span>
<span class="lineNum">   15384 </span>            :                 /* Send reply directly to sender */
<span class="lineNum">   15385 </span><span class="lineCov">          1 :                 if (ast_strlen_zero(cid))</span>
<span class="lineNum">   15386 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   15387 </span>            : 
<span class="lineNum">   15388 </span><span class="lineCov">          1 :                 ast_callerid_parse(cid, &amp;name, &amp;num);</span>
<span class="lineNum">   15389 </span><span class="lineCov">          1 :                 if (!num) {</span>
<span class="lineNum">   15390 </span><span class="lineNoCov">          0 :                         ast_verb(3, &quot;No CID number available, no reply sent\n&quot;);</span>
<span class="lineNum">   15391 </span><span class="lineNoCov">          0 :                         if (!res)</span>
<span class="lineNum">   15392 </span><span class="lineNoCov">          0 :                                 res = ast_play_and_wait(chan, &quot;vm-nonumber&quot;);</span>
<span class="lineNum">   15393 </span><span class="lineNoCov">          0 :                         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15394 </span><span class="lineNoCov">          0 :                         return res;</span>
<span class="lineNum">   15395 </span>            :                 } else {
<span class="lineNum">   15396 </span>            :                         struct ast_vm_user vmu2, *vmu3;
<span class="lineNum">   15397 </span><span class="lineCov">          1 :                         memset(&amp;vmu2, 0, sizeof(vmu2));</span>
<span class="lineNum">   15398 </span><span class="lineCov">          1 :                         vmu3 = find_user(&amp;vmu2, vmu-&gt;context, num);</span>
<span class="lineNum">   15399 </span><span class="lineCov">          1 :                         if (vmu3) {</span>
<span class="lineNum">   15400 </span>            :                                 struct leave_vm_options leave_options;
<span class="lineNum">   15401 </span>            :                                 char mailbox[AST_MAX_EXTENSION * 2 + 2];
<span class="lineNum">   15402 </span><span class="lineCov">          1 :                                 snprintf(mailbox, sizeof(mailbox), &quot;%s@%s&quot;, num, vmu-&gt;context);</span>
<span class="lineNum">   15403 </span>            : 
<span class="lineNum">   15404 </span><span class="lineCov">          1 :                                 ast_verb(3, &quot;Leaving voicemail for '%s' in context '%s'\n&quot;, num, vmu-&gt;context);</span>
<span class="lineNum">   15405 </span>            : 
<span class="lineNum">   15406 </span><span class="lineCov">          1 :                                 memset(&amp;leave_options, 0, sizeof(leave_options));</span>
<span class="lineNum">   15407 </span><span class="lineCov">          1 :                                 leave_options.record_gain = record_gain;</span>
<span class="lineNum">   15408 </span><span class="lineCov">          1 :                                 res = leave_voicemail(chan, mailbox, &amp;leave_options);</span>
<span class="lineNum">   15409 </span><span class="lineCov">          1 :                                 if (!res)</span>
<span class="lineNum">   15410 </span><span class="lineCov">          1 :                                         res = 't';</span>
<span class="lineNum">   15411 </span><span class="lineCov">          1 :                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15412 </span><span class="lineCov">          1 :                                 free_user(vmu3);</span>
<span class="lineNum">   15413 </span><span class="lineCov">          1 :                                 return res;</span>
<span class="lineNum">   15414 </span>            :                         } else {
<span class="lineNum">   15415 </span>            :                                 /* Sender has no mailbox, can't reply */
<span class="lineNum">   15416 </span><span class="lineNoCov">          0 :                                 ast_verb(3, &quot;No mailbox number '%s' in context '%s', no reply sent\n&quot;, num, vmu-&gt;context);</span>
<span class="lineNum">   15417 </span><span class="lineNoCov">          0 :                                 ast_play_and_wait(chan, &quot;vm-nobox&quot;);</span>
<span class="lineNum">   15418 </span><span class="lineNoCov">          0 :                                 res = 't';</span>
<span class="lineNum">   15419 </span><span class="lineNoCov">          0 :                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15420 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">   15421 </span>            :                         }
<span class="lineNum">   15422 </span>            :                 }
<span class="lineNum">   15423 </span>            :                 res = 0;
<span class="lineNum">   15424 </span>            : 
<span class="lineNum">   15425 </span>            :                 break;
<span class="lineNum">   15426 </span>            :         }
<span class="lineNum">   15427 </span>            : 
<span class="lineNum">   15428 </span><span class="lineNoCov">          0 :         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15429 </span>            : 
<span class="lineNum">   15430 </span>            : #ifndef IMAP_STORAGE
<span class="lineNum">   15431 </span><span class="lineNoCov">          0 :         if (!res) {</span>
<span class="lineNum">   15432 </span><span class="lineNoCov">          0 :                 make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, msg);</span>
<span class="lineNum">   15433 </span><span class="lineNoCov">          0 :                 vms-&gt;heard[msg] = 1;</span>
<span class="lineNum">   15434 </span><span class="lineNoCov">          0 :                 res = wait_file(chan, vms, vms-&gt;fn);</span>
<span class="lineNum">   15435 </span>            :         }
<span class="lineNum">   15436 </span>            : #endif
<span class="lineNum">   15437 </span><span class="lineNoCov">          0 :         return res;</span>
<a name="15438"><span class="lineNum">   15438 </span>            : }</a>
<span class="lineNum">   15439 </span>            : 
<span class="lineNum">   15440 </span><span class="lineCov">         21 : static int play_record_review(struct ast_channel *chan, char *playfile, char *recordfile, int maxtime, char *fmt,</span>
<span class="lineNum">   15441 </span>            :                         int outsidecaller, struct ast_vm_user *vmu, int *duration, int *sound_duration, const char *unlockdir,
<span class="lineNum">   15442 </span>            :                         signed char record_gain, struct vm_state *vms, char *flag, const char *msg_id, int forwardintro)
<span class="lineNum">   15443 </span>            : {
<span class="lineNum">   15444 </span>            :         /* Record message &amp; let caller review or re-record it, or set options if applicable */
<span class="lineNum">   15445 </span><span class="lineCov">         21 :         int res = 0;</span>
<span class="lineNum">   15446 </span><span class="lineCov">         21 :         int cmd = 0;</span>
<span class="lineNum">   15447 </span><span class="lineCov">         21 :         int max_attempts = 3;</span>
<span class="lineNum">   15448 </span><span class="lineCov">         21 :         int attempts = 0;</span>
<span class="lineNum">   15449 </span><span class="lineCov">         21 :         int recorded = 0;</span>
<span class="lineNum">   15450 </span><span class="lineCov">         21 :         int msg_exists = 0;</span>
<span class="lineNum">   15451 </span><span class="lineCov">         21 :         signed char zero_gain = 0;</span>
<span class="lineNum">   15452 </span>            :         char tempfile[PATH_MAX];
<span class="lineNum">   15453 </span><span class="lineCov">         21 :         char *acceptdtmf = &quot;#&quot;;</span>
<span class="lineNum">   15454 </span><span class="lineCov">         21 :         char *canceldtmf = &quot;&quot;;</span>
<span class="lineNum">   15455 </span><span class="lineCov">         21 :         int canceleddtmf = 0;</span>
<span class="lineNum">   15456 </span>            : 
<span class="lineNum">   15457 </span>            :         /* Note that urgent and private are for flagging messages as such in the future */
<span class="lineNum">   15458 </span>            : 
<span class="lineNum">   15459 </span>            :         /* barf if no pointer passed to store duration in */
<span class="lineNum">   15460 </span><span class="lineCov">         21 :         if (duration == NULL) {</span>
<span class="lineNum">   15461 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Error play_record_review called without duration pointer\n&quot;);</span>
<span class="lineNum">   15462 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   15463 </span>            :         }
<span class="lineNum">   15464 </span>            : 
<span class="lineNum">   15465 </span><span class="lineCov">         21 :         if (!outsidecaller)</span>
<span class="lineNum">   15466 </span><span class="lineCov">         10 :                 snprintf(tempfile, sizeof(tempfile), &quot;%s.tmp&quot;, recordfile);</span>
<span class="lineNum">   15467 </span>            :         else
<span class="lineNum">   15468 </span><span class="lineCov">         11 :                 ast_copy_string(tempfile, recordfile, sizeof(tempfile));</span>
<span class="lineNum">   15469 </span>            : 
<span class="lineNum">   15470 </span><span class="lineCov">         21 :         cmd = '3';  /* Want to start by recording */</span>
<span class="lineNum">   15471 </span>            : 
<span class="lineNum">   15472 </span><span class="lineCov">         52 :         while ((cmd &gt;= 0) &amp;&amp; (cmd != 't')) {</span>
<span class="lineNum">   15473 </span><span class="lineCov">         52 :                 switch (cmd) {</span>
<span class="lineNum">   15474 </span><span class="lineCov">         10 :                 case '1':</span>
<span class="lineNum">   15475 </span><span class="lineCov">         10 :                         if (!msg_exists) {</span>
<span class="lineNum">   15476 </span>            :                                 /* In this case, 1 is to record a message */
<span class="lineNum">   15477 </span><span class="lineNoCov">          0 :                                 cmd = '3';</span>
<span class="lineNum">   15478 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15479 </span>            :                         } else {
<span class="lineNum">   15480 </span>            :                                 /* Otherwise 1 is to save the existing message */
<span class="lineNum">   15481 </span><span class="lineCov">         10 :                                 ast_verb(3, &quot;Saving message as is\n&quot;);</span>
<span class="lineNum">   15482 </span><span class="lineCov">         10 :                                 if (!outsidecaller)</span>
<span class="lineNum">   15483 </span><span class="lineCov">         10 :                                         ast_filerename(tempfile, recordfile, NULL);</span>
<span class="lineNum">   15484 </span><span class="lineCov">         10 :                                 if (!forwardintro) {</span>
<span class="lineNum">   15485 </span><span class="lineCov">         10 :                                         ast_stream_and_wait(chan, &quot;vm-msgsaved&quot;, &quot;&quot;);</span>
<span class="lineNum">   15486 </span>            :                                 }
<span class="lineNum">   15487 </span>            :                                 if (!outsidecaller) {
<span class="lineNum">   15488 </span>            :                                         /* Saves to IMAP server only if imapgreeting=yes */
<span class="lineNum">   15489 </span>            :                                         STORE(recordfile, vmu-&gt;mailbox, vmu-&gt;context, -1, chan, vmu, fmt, *duration, vms, flag, msg_id);
<span class="lineNum">   15490 </span>            :                                         DISPOSE(recordfile, -1);
<span class="lineNum">   15491 </span>            :                                 }
<span class="lineNum">   15492 </span><span class="lineCov">         10 :                                 cmd = 't';</span>
<span class="lineNum">   15493 </span><span class="lineCov">         10 :                                 return res;</span>
<span class="lineNum">   15494 </span>            :                         }
<span class="lineNum">   15495 </span><span class="lineNoCov">          0 :                 case '2':</span>
<span class="lineNum">   15496 </span>            :                         /* Review */
<span class="lineNum">   15497 </span><span class="lineNoCov">          0 :                         ast_verb(3, &quot;Reviewing the message\n&quot;);</span>
<span class="lineNum">   15498 </span><span class="lineNoCov">          0 :                         cmd = ast_stream_and_wait(chan, tempfile, AST_DIGIT_ANY);</span>
<span class="lineNum">   15499 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   15500 </span><span class="lineCov">         21 :                 case '3':</span>
<span class="lineNum">   15501 </span><span class="lineCov">         21 :                         msg_exists = 0;</span>
<span class="lineNum">   15502 </span>            :                         /* Record */
<span class="lineNum">   15503 </span><span class="lineCov">         21 :                         if (recorded == 1)</span>
<span class="lineNum">   15504 </span><span class="lineNoCov">          0 :                                 ast_verb(3, &quot;Re-recording the message\n&quot;);</span>
<span class="lineNum">   15505 </span>            :                         else
<span class="lineNum">   15506 </span><span class="lineCov">         21 :                                 ast_verb(3, &quot;Recording the message\n&quot;);</span>
<span class="lineNum">   15507 </span>            : 
<span class="lineNum">   15508 </span><span class="lineCov">         21 :                         if (recorded &amp;&amp; outsidecaller) {</span>
<span class="lineNum">   15509 </span><span class="lineNoCov">          0 :                                 if (forwardintro) {</span>
<span class="lineNum">   15510 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, &quot;vm-record-prepend&quot;);</span>
<span class="lineNum">   15511 </span>            :                                 } else {
<span class="lineNum">   15512 </span><span class="lineNoCov">          0 :                                         cmd = ast_play_and_wait(chan, INTRO);</span>
<span class="lineNum">   15513 </span>            :                                 }
<span class="lineNum">   15514 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;beep&quot;);</span>
<span class="lineNum">   15515 </span>            :                         }
<span class="lineNum">   15516 </span><span class="lineCov">         21 :                         recorded = 1;</span>
<span class="lineNum">   15517 </span>            :                         /* After an attempt has been made to record message, we have to take care of INTRO and beep for incoming messages, but not for greetings */
<span class="lineNum">   15518 </span><span class="lineCov">         21 :                         if (record_gain)</span>
<span class="lineNum">   15519 </span><span class="lineNoCov">          0 :                                 ast_channel_setoption(chan, AST_OPTION_RXGAIN, &amp;record_gain, sizeof(record_gain), 0);</span>
<span class="lineNum">   15520 </span><span class="lineCov">         21 :                         if (ast_test_flag(vmu, VM_OPERATOR))</span>
<span class="lineNum">   15521 </span><span class="lineCov">          5 :                                 canceldtmf = &quot;0&quot;;</span>
<span class="lineNum">   15522 </span><span class="lineCov">         21 :                         cmd = ast_play_and_record_full(chan, playfile, tempfile, maxtime, fmt, duration, sound_duration, 0, silencethreshold, maxsilence, unlockdir, acceptdtmf, canceldtmf, 0, AST_RECORD_IF_EXISTS_OVERWRITE);</span>
<span class="lineNum">   15523 </span><span class="lineCov">         21 :                         if (strchr(canceldtmf, cmd)) {</span>
<span class="lineNum">   15524 </span>            :                         /* need this flag here to distinguish between pressing '0' during message recording or after */
<span class="lineNum">   15525 </span><span class="lineNoCov">          0 :                                 canceleddtmf = 1;</span>
<span class="lineNum">   15526 </span>            :                         }
<span class="lineNum">   15527 </span><span class="lineCov">         21 :                         if (record_gain)</span>
<span class="lineNum">   15528 </span><span class="lineNoCov">          0 :                                 ast_channel_setoption(chan, AST_OPTION_RXGAIN, &amp;zero_gain, sizeof(zero_gain), 0);</span>
<span class="lineNum">   15529 </span><span class="lineCov">         21 :                         if (cmd == -1) {</span>
<span class="lineNum">   15530 </span>            :                                 /* User has hung up, no options to give */
<span class="lineNum">   15531 </span><span class="lineNoCov">          0 :                                 if (!outsidecaller) {</span>
<span class="lineNum">   15532 </span>            :                                         /* user was recording a greeting and they hung up, so let's delete the recording. */
<span class="lineNum">   15533 </span><span class="lineNoCov">          0 :                                         ast_filedelete(tempfile, NULL);</span>
<span class="lineNum">   15534 </span>            :                                 }
<span class="lineNum">   15535 </span><span class="lineNoCov">          0 :                                 return cmd;</span>
<span class="lineNum">   15536 </span>            :                         }
<span class="lineNum">   15537 </span><span class="lineCov">         21 :                         if (cmd == '0') {</span>
<span class="lineNum">   15538 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15539 </span><span class="lineCov">         21 :                         } else if (cmd == '*') {</span>
<span class="lineNum">   15540 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15541 </span>            : #if 0
<span class="lineNum">   15542 </span>            :                         } else if (vmu-&gt;review &amp;&amp; sound_duration &amp;&amp; (*sound_duration &lt; 5)) {
<span class="lineNum">   15543 </span>            :                                 /* Message is too short */
<span class="lineNum">   15544 </span>            :                                 ast_verb(3, &quot;Message too short\n&quot;);
<span class="lineNum">   15545 </span>            :                                 cmd = ast_play_and_wait(chan, &quot;vm-tooshort&quot;);
<span class="lineNum">   15546 </span>            :                                 cmd = ast_filedelete(tempfile, NULL);
<span class="lineNum">   15547 </span>            :                                 break;
<span class="lineNum">   15548 </span>            :                         } else if (vmu-&gt;review &amp;&amp; (cmd == 2 &amp;&amp; sound_duration &amp;&amp; *sound_duration &lt; (maxsilence + 3))) {
<span class="lineNum">   15549 </span>            :                                 /* Message is all silence */
<span class="lineNum">   15550 </span>            :                                 ast_verb(3, &quot;Nothing recorded\n&quot;);
<span class="lineNum">   15551 </span>            :                                 cmd = ast_filedelete(tempfile, NULL);
<span class="lineNum">   15552 </span>            :                                 cmd = ast_play_and_wait(chan, &quot;vm-nothingrecorded&quot;);
<span class="lineNum">   15553 </span>            :                                 if (!cmd)
<span class="lineNum">   15554 </span>            :                                         cmd = ast_play_and_wait(chan, &quot;vm-speakup&quot;);
<span class="lineNum">   15555 </span>            :                                 break;
<span class="lineNum">   15556 </span>            : #endif
<span class="lineNum">   15557 </span>            :                         } else {
<span class="lineNum">   15558 </span>            :                                 /* If all is well, a message exists */
<span class="lineNum">   15559 </span><span class="lineCov">         21 :                                 msg_exists = 1;</span>
<span class="lineNum">   15560 </span><span class="lineCov">         21 :                                 cmd = 0;</span>
<span class="lineNum">   15561 </span>            :                         }
<span class="lineNum">   15562 </span><span class="lineCov">         21 :                         break;</span>
<span class="lineNum">   15563 </span><span class="lineNoCov">          0 :                 case '4':</span>
<span class="lineNum">   15564 </span><span class="lineNoCov">          0 :                         if (outsidecaller) {  /* only mark vm messages */</span>
<span class="lineNum">   15565 </span>            :                                 /* Mark Urgent */
<span class="lineNum">   15566 </span><span class="lineNoCov">          0 :                                 if ((flag &amp;&amp; ast_strlen_zero(flag)) || (!ast_strlen_zero(flag) &amp;&amp; strcmp(flag, &quot;Urgent&quot;))) {</span>
<span class="lineNum">   15567 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;marking message as Urgent\n&quot;);</span>
<span class="lineNum">   15568 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-marked-urgent&quot;);</span>
<span class="lineNum">   15569 </span><span class="lineNoCov">          0 :                                         strcpy(flag, &quot;Urgent&quot;);</span>
<span class="lineNum">   15570 </span><span class="lineNoCov">          0 :                                 } else if (flag) {</span>
<span class="lineNum">   15571 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;UNmarking message as Urgent\n&quot;);</span>
<span class="lineNum">   15572 </span><span class="lineNoCov">          0 :                                         res = ast_play_and_wait(chan, &quot;vm-marked-nonurgent&quot;);</span>
<span class="lineNum">   15573 </span><span class="lineNoCov">          0 :                                         strcpy(flag, &quot;&quot;);</span>
<span class="lineNum">   15574 </span>            :                                 } else {
<span class="lineNum">   15575 </span><span class="lineNoCov">          0 :                                         ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15576 </span>            :                                 }
<span class="lineNum">   15577 </span><span class="lineNoCov">          0 :                                 cmd = 0;</span>
<span class="lineNum">   15578 </span>            :                         } else {
<span class="lineNum">   15579 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15580 </span>            :                         }
<span class="lineNum">   15581 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   15582 </span><span class="lineNoCov">          0 :                 case '5':</span>
<span class="lineNum">   15583 </span>            :                 case '6':
<span class="lineNum">   15584 </span>            :                 case '7':
<span class="lineNum">   15585 </span>            :                 case '8':
<span class="lineNum">   15586 </span>            :                 case '9':
<span class="lineNum">   15587 </span>            :                 case '*':
<span class="lineNum">   15588 </span>            :                 case '#':
<span class="lineNum">   15589 </span><span class="lineNoCov">          0 :                         cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15590 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">   15591 </span>            : #if 0
<span class="lineNum">   15592 </span>            : /*  XXX Commented out for the moment because of the dangers of deleting
<span class="lineNum">   15593 </span>            :     a message while recording (can put the message numbers out of sync) */
<span class="lineNum">   15594 </span>            :                 case '*':
<span class="lineNum">   15595 </span>            :                         /* Cancel recording, delete message, offer to take another message*/
<span class="lineNum">   15596 </span>            :                         cmd = ast_play_and_wait(chan, &quot;vm-deleted&quot;);
<span class="lineNum">   15597 </span>            :                         cmd = ast_filedelete(tempfile, NULL);
<span class="lineNum">   15598 </span>            :                         if (outsidecaller) {
<span class="lineNum">   15599 </span>            :                                 res = vm_exec(chan, NULL);
<span class="lineNum">   15600 </span>            :                                 return res;
<span class="lineNum">   15601 </span>            :                         }
<span class="lineNum">   15602 </span>            :                         else
<span class="lineNum">   15603 </span>            :                                 return 1;
<span class="lineNum">   15604 </span>            : #endif
<span class="lineNum">   15605 </span><span class="lineNoCov">          0 :                 case '0':</span>
<span class="lineNum">   15606 </span><span class="lineNoCov">          0 :                         if (!ast_test_flag(vmu, VM_OPERATOR) || (!canceleddtmf &amp;&amp; !outsidecaller)) {</span>
<span class="lineNum">   15607 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-sorry&quot;);</span>
<span class="lineNum">   15608 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">   15609 </span>            :                         }
<span class="lineNum">   15610 </span><span class="lineNoCov">          0 :                         if (msg_exists || recorded) {</span>
<span class="lineNum">   15611 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-saveoper&quot;);</span>
<span class="lineNum">   15612 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   15613 </span><span class="lineNoCov">          0 :                                         cmd = ast_waitfordigit(chan, 3000);</span>
<span class="lineNum">   15614 </span><span class="lineNoCov">          0 :                                 if (cmd == '1') {</span>
<span class="lineNum">   15615 </span><span class="lineNoCov">          0 :                                         ast_filerename(tempfile, recordfile, NULL);</span>
<span class="lineNum">   15616 </span><span class="lineNoCov">          0 :                                         ast_play_and_wait(chan, &quot;vm-msgsaved&quot;);</span>
<span class="lineNum">   15617 </span><span class="lineNoCov">          0 :                                         cmd = '0';</span>
<span class="lineNum">   15618 </span><span class="lineNoCov">          0 :                                 } else if (cmd == '4') {</span>
<span class="lineNum">   15619 </span><span class="lineNoCov">          0 :                                         if (flag) {</span>
<span class="lineNum">   15620 </span><span class="lineNoCov">          0 :                                                 ast_play_and_wait(chan, &quot;vm-marked-urgent&quot;);</span>
<span class="lineNum">   15621 </span><span class="lineNoCov">          0 :                                                 strcpy(flag, &quot;Urgent&quot;);</span>
<span class="lineNum">   15622 </span>            :                                         }
<span class="lineNum">   15623 </span><span class="lineNoCov">          0 :                                         ast_play_and_wait(chan, &quot;vm-msgsaved&quot;);</span>
<span class="lineNum">   15624 </span><span class="lineNoCov">          0 :                                         cmd = '0';</span>
<span class="lineNum">   15625 </span>            :                                 } else {
<span class="lineNum">   15626 </span><span class="lineNoCov">          0 :                                         ast_play_and_wait(chan, &quot;vm-deleted&quot;);</span>
<span class="lineNum">   15627 </span><span class="lineNoCov">          0 :                                         DELETE(tempfile, -1, tempfile, vmu);</span>
<span class="lineNum">   15628 </span>            :                                         DISPOSE(tempfile, -1);
<span class="lineNum">   15629 </span><span class="lineNoCov">          0 :                                         cmd = '0';</span>
<span class="lineNum">   15630 </span>            :                                 }
<span class="lineNum">   15631 </span>            :                         }
<span class="lineNum">   15632 </span><span class="lineNoCov">          0 :                         return cmd;</span>
<span class="lineNum">   15633 </span><span class="lineCov">         21 :                 default:</span>
<span class="lineNum">   15634 </span>            :                         /* If the caller is an ouside caller and the review option is enabled or it's forward intro
<span class="lineNum">   15635 </span>            :                            allow them to review the message, but let the owner of the box review
<span class="lineNum">   15636 </span>            :                            their OGM's */
<span class="lineNum">   15637 </span><span class="lineCov">         21 :                         if (outsidecaller &amp;&amp; !ast_test_flag(vmu, VM_REVIEW) &amp;&amp; !forwardintro)</span>
<span class="lineNum">   15638 </span><span class="lineCov">         11 :                                 return cmd;</span>
<span class="lineNum">   15639 </span><span class="lineCov">         10 :                         if (msg_exists) {</span>
<span class="lineNum">   15640 </span><span class="lineCov">         10 :                                 cmd = ast_play_and_wait(chan, &quot;vm-review&quot;);</span>
<span class="lineNum">   15641 </span><span class="lineCov">         10 :                                 if (!cmd &amp;&amp; outsidecaller) {</span>
<span class="lineNum">   15642 </span><span class="lineNoCov">          0 :                                         if ((flag &amp;&amp; ast_strlen_zero(flag)) || (!ast_strlen_zero(flag) &amp;&amp; strcmp(flag, &quot;Urgent&quot;))) {</span>
<span class="lineNum">   15643 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-review-urgent&quot;);</span>
<span class="lineNum">   15644 </span><span class="lineNoCov">          0 :                                         } else if (flag) {</span>
<span class="lineNum">   15645 </span><span class="lineNoCov">          0 :                                                 cmd = ast_play_and_wait(chan, &quot;vm-review-nonurgent&quot;);</span>
<span class="lineNum">   15646 </span>            :                                         }
<span class="lineNum">   15647 </span>            :                                 }
<span class="lineNum">   15648 </span>            :                         } else {
<span class="lineNum">   15649 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-torerecord&quot;);</span>
<span class="lineNum">   15650 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   15651 </span><span class="lineNoCov">          0 :                                         cmd = ast_waitfordigit(chan, 600);</span>
<span class="lineNum">   15652 </span>            :                         }
<span class="lineNum">   15653 </span>            : 
<span class="lineNum">   15654 </span><span class="lineCov">         10 :                         if (!cmd &amp;&amp; outsidecaller &amp;&amp; ast_test_flag(vmu, VM_OPERATOR)) {</span>
<span class="lineNum">   15655 </span><span class="lineNoCov">          0 :                                 cmd = ast_play_and_wait(chan, &quot;vm-reachoper&quot;);</span>
<span class="lineNum">   15656 </span><span class="lineNoCov">          0 :                                 if (!cmd)</span>
<span class="lineNum">   15657 </span><span class="lineNoCov">          0 :                                         cmd = ast_waitfordigit(chan, 600);</span>
<span class="lineNum">   15658 </span>            :                         }
<span class="lineNum">   15659 </span>            : #if 0
<span class="lineNum">   15660 </span>            :                         if (!cmd)
<span class="lineNum">   15661 </span>            :                                 cmd = ast_play_and_wait(chan, &quot;vm-tocancelmsg&quot;);
<span class="lineNum">   15662 </span>            : #endif
<span class="lineNum">   15663 </span><span class="lineCov">         10 :                         if (!cmd)</span>
<span class="lineNum">   15664 </span><span class="lineNoCov">          0 :                                 cmd = ast_waitfordigit(chan, 6000);</span>
<span class="lineNum">   15665 </span><span class="lineCov">         10 :                         if (!cmd) {</span>
<span class="lineNum">   15666 </span><span class="lineNoCov">          0 :                                 attempts++;</span>
<span class="lineNum">   15667 </span>            :                         }
<span class="lineNum">   15668 </span><span class="lineCov">         10 :                         if (attempts &gt; max_attempts) {</span>
<span class="lineNum">   15669 </span><span class="lineNoCov">          0 :                                 cmd = 't';</span>
<span class="lineNum">   15670 </span>            :                         }
<span class="lineNum">   15671 </span>            :                 }
<span class="lineNum">   15672 </span>            :         }
<span class="lineNum">   15673 </span><span class="lineNoCov">          0 :         if (!outsidecaller &amp;&amp; (cmd == -1 || cmd == 't')) {</span>
<span class="lineNum">   15674 </span>            :                 /* Hang up or timeout, so delete the recording. */
<span class="lineNum">   15675 </span><span class="lineNoCov">          0 :                 ast_filedelete(tempfile, NULL);</span>
<span class="lineNum">   15676 </span>            :         }
<span class="lineNum">   15677 </span>            : 
<span class="lineNum">   15678 </span><span class="lineNoCov">          0 :         if (cmd != 't' &amp;&amp; outsidecaller)</span>
<span class="lineNum">   15679 </span><span class="lineNoCov">          0 :                 ast_play_and_wait(chan, &quot;vm-goodbye&quot;);</span>
<span class="lineNum">   15680 </span>            : 
<span class="lineNum">   15681 </span><span class="lineNoCov">          0 :         return cmd;</span>
<a name="15682"><span class="lineNum">   15682 </span>            : }</a>
<span class="lineNum">   15683 </span>            : 
<span class="lineNum">   15684 </span><span class="lineCov">         69 : static struct ast_vm_msg_snapshot *vm_msg_snapshot_alloc(void)</span>
<span class="lineNum">   15685 </span>            : {
<span class="lineNum">   15686 </span>            :         struct ast_vm_msg_snapshot *msg_snapshot;
<span class="lineNum">   15687 </span>            : 
<span class="lineNum">   15688 </span><span class="lineCov">         69 :         if (!(msg_snapshot = ast_calloc(1, sizeof(*msg_snapshot)))) {</span>
<span class="lineNum">   15689 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   15690 </span>            :         }
<span class="lineNum">   15691 </span>            : 
<span class="lineNum">   15692 </span><span class="lineCov">         69 :         if (ast_string_field_init(msg_snapshot, 512)) {</span>
<span class="lineNum">   15693 </span><span class="lineNoCov">          0 :                 ast_free(msg_snapshot);</span>
<span class="lineNum">   15694 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   15695 </span>            :         }
<span class="lineNum">   15696 </span>            : 
<span class="lineNum">   15697 </span><span class="lineCov">         69 :         return msg_snapshot;</span>
<a name="15698"><span class="lineNum">   15698 </span>            : }</a>
<span class="lineNum">   15699 </span>            : 
<span class="lineNum">   15700 </span><span class="lineCov">         69 : static struct ast_vm_msg_snapshot *vm_msg_snapshot_destroy(struct ast_vm_msg_snapshot *msg_snapshot)</span>
<span class="lineNum">   15701 </span>            : {
<span class="lineNum">   15702 </span><span class="lineCov">         69 :         ast_string_field_free_memory(msg_snapshot);</span>
<span class="lineNum">   15703 </span><span class="lineCov">         69 :         ast_free(msg_snapshot);</span>
<span class="lineNum">   15704 </span>            : 
<span class="lineNum">   15705 </span><span class="lineCov">         69 :         return NULL;</span>
<span class="lineNum">   15706 </span>            : }
<span class="lineNum">   15707 </span>            : 
<a name="15708"><span class="lineNum">   15708 </span>            : #ifdef TEST_FRAMEWORK</a>
<span class="lineNum">   15709 </span>            : 
<span class="lineNum">   15710 </span><span class="lineCov">         20 : static int vm_test_destroy_user(const char *context, const char *mailbox)</span>
<span class="lineNum">   15711 </span>            : {
<span class="lineNum">   15712 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   15713 </span>            : 
<span class="lineNum">   15714 </span><span class="lineCov">         20 :         AST_LIST_LOCK(&amp;users);</span>
<span class="lineNum">   15715 </span><span class="lineCov">         60 :         AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;users, vmu, list) {</span>
<span class="lineNum">   15716 </span><span class="lineCov">         60 :                 if (!strcmp(context, vmu-&gt;context)</span>
<span class="lineNum">   15717 </span><span class="lineCov">         20 :                         &amp;&amp; !strcmp(mailbox, vmu-&gt;mailbox)) {</span>
<span class="lineNum">   15718 </span><span class="lineCov">         20 :                         AST_LIST_REMOVE_CURRENT(list);</span>
<span class="lineNum">   15719 </span><span class="lineCov">         20 :                         ast_free(vmu);</span>
<span class="lineNum">   15720 </span><span class="lineCov">         20 :                         break;</span>
<span class="lineNum">   15721 </span>            :                 }
<span class="lineNum">   15722 </span>            :         }
<span class="lineNum">   15723 </span>            :         AST_LIST_TRAVERSE_SAFE_END
<span class="lineNum">   15724 </span><span class="lineCov">         20 :         AST_LIST_UNLOCK(&amp;users);</span>
<span class="lineNum">   15725 </span><span class="lineCov">         20 :         return 0;</span>
<a name="15726"><span class="lineNum">   15726 </span>            : }</a>
<span class="lineNum">   15727 </span>            : 
<span class="lineNum">   15728 </span><span class="lineCov">         20 : static int vm_test_create_user(const char *context, const char *mailbox)</span>
<span class="lineNum">   15729 </span>            : {
<span class="lineNum">   15730 </span>            :         struct ast_vm_user *vmu;
<span class="lineNum">   15731 </span>            : 
<span class="lineNum">   15732 </span><span class="lineCov">         20 :         if (!(vmu = find_or_create(context, mailbox))) {</span>
<span class="lineNum">   15733 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">   15734 </span>            :         }
<span class="lineNum">   15735 </span><span class="lineCov">         20 :         populate_defaults(vmu);</span>
<span class="lineNum">   15736 </span><span class="lineCov">         20 :         return 0;</span>
<span class="lineNum">   15737 </span>            : }
<span class="lineNum">   15738 </span>            : 
<span class="lineNum">   15739 </span>            : #endif
<span class="lineNum">   15740 </span>            : 
<span class="lineNum">   15741 </span>            : /*!
<span class="lineNum">   15742 </span>            :  * \brief Create and store off all the msgs in an open mailbox
<span class="lineNum">   15743 </span>            :  *
<span class="lineNum">   15744 </span>            :  * \note TODO XXX This function should work properly for all
<span class="lineNum">   15745 </span>            :  *       voicemail storage options, but is far more expensive for
<span class="lineNum">   15746 </span>            :  *       ODBC at the moment.  This is because the RETRIEVE macro
<span class="lineNum">   15747 </span>            :  *       not only pulls out the message's meta data file from the
<span class="lineNum">   15748 </span>            :  *       database, but also the actual audio for each message, temporarily
<span class="lineNum">   15749 </span>            :  *       writing it to the file system.  This is an area that needs
<a name="15750"><span class="lineNum">   15750 </span>            :  *       to be made more efficient.</a>
<span class="lineNum">   15751 </span>            :  */
<span class="lineNum">   15752 </span><span class="lineCov">         37 : static int vm_msg_snapshot_create(struct ast_vm_user *vmu,</span>
<span class="lineNum">   15753 </span>            :         struct vm_state *vms,
<span class="lineNum">   15754 </span>            :         struct ast_vm_mailbox_snapshot *mailbox_snapshot,
<span class="lineNum">   15755 </span>            :         int snapshot_index,
<span class="lineNum">   15756 </span>            :         int mailbox_index,
<span class="lineNum">   15757 </span>            :         int descending,
<span class="lineNum">   15758 </span>            :         enum ast_vm_snapshot_sort_val sort_val)
<span class="lineNum">   15759 </span>            : {
<span class="lineNum">   15760 </span>            :         struct ast_vm_msg_snapshot *msg_snapshot;
<span class="lineNum">   15761 </span>            :         struct ast_vm_msg_snapshot *msg_snapshot_tmp;
<span class="lineNum">   15762 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">   15763 </span><span class="lineCov">         37 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">   15764 </span>            :         char filename[PATH_MAX];
<span class="lineNum">   15765 </span>            :         const char *value;
<span class="lineNum">   15766 </span>            : 
<span class="lineNum">   15767 </span><span class="lineCov">        106 :         for (vms-&gt;curmsg = 0; vms-&gt;curmsg &lt;= vms-&gt;lastmsg; vms-&gt;curmsg++) {</span>
<span class="lineNum">   15768 </span><span class="lineCov">         69 :                 int inserted = 0;</span>
<span class="lineNum">   15769 </span>            :                 /* Find the msg */
<span class="lineNum">   15770 </span><span class="lineCov">         69 :                 make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">   15771 </span><span class="lineCov">         69 :                 snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, vms-&gt;fn);</span>
<span class="lineNum">   15772 </span>            :                 RETRIEVE(vms-&gt;curdir, vms-&gt;curmsg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   15773 </span><span class="lineCov">         69 :                 msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">   15774 </span><span class="lineCov">         69 :                 if (!msg_cfg || msg_cfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   15775 </span>            :                         DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   15776 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">   15777 </span>            :                 }
<span class="lineNum">   15778 </span>            : 
<span class="lineNum">   15779 </span>            :                 /* Create the snapshot object */
<span class="lineNum">   15780 </span><span class="lineCov">         69 :                 if (!(msg_snapshot = vm_msg_snapshot_alloc())) {</span>
<span class="lineNum">   15781 </span><span class="lineNoCov">          0 :                         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15782 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">   15783 </span>            :                 }
<span class="lineNum">   15784 </span>            : 
<span class="lineNum">   15785 </span>            :                 /* Fill in the snapshot object */
<span class="lineNum">   15786 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;msg_id&quot;))) {</span>
<span class="lineNum">   15787 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, msg_id, value);</span>
<span class="lineNum">   15788 </span>            :                 } else {
<span class="lineNum">   15789 </span>            :                         /* Message snapshots *really* should have a
<span class="lineNum">   15790 </span>            :                          * message ID. Add one to the message config
<span class="lineNum">   15791 </span>            :                          * if it does not already exist
<span class="lineNum">   15792 </span>            :                          */
<span class="lineNum">   15793 </span>            :                         char id[MSG_ID_LEN];
<span class="lineNum">   15794 </span><span class="lineNoCov">          0 :                         if (!(add_message_id(msg_cfg, vms-&gt;curdir, vms-&gt;curmsg,</span>
<span class="lineNum">   15795 </span>            :                                                         filename, id, sizeof(id), vmu, mailbox_index))) {
<span class="lineNum">   15796 </span><span class="lineNoCov">          0 :                                 ast_string_field_set(msg_snapshot, msg_id, id);</span>
<span class="lineNum">   15797 </span>            :                         } else {
<span class="lineNum">   15798 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;Unable to create a message ID for message %s/%d\n&quot;, vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">   15799 </span>            :                         }
<span class="lineNum">   15800 </span>            :                 }
<span class="lineNum">   15801 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerid&quot;))) {</span>
<span class="lineNum">   15802 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, callerid, value);</span>
<span class="lineNum">   15803 </span>            :                 }
<span class="lineNum">   15804 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;callerchan&quot;))) {</span>
<span class="lineNum">   15805 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, callerchan, value);</span>
<span class="lineNum">   15806 </span>            :                 }
<span class="lineNum">   15807 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;exten&quot;))) {</span>
<span class="lineNum">   15808 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, exten, value);</span>
<span class="lineNum">   15809 </span>            :                 }
<span class="lineNum">   15810 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origdate&quot;))) {</span>
<span class="lineNum">   15811 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, origdate, value);</span>
<span class="lineNum">   15812 </span>            :                 }
<span class="lineNum">   15813 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;origtime&quot;))) {</span>
<span class="lineNum">   15814 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, origtime, value);</span>
<span class="lineNum">   15815 </span>            :                 }
<span class="lineNum">   15816 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;))) {</span>
<span class="lineNum">   15817 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, duration, value);</span>
<span class="lineNum">   15818 </span>            :                 }
<span class="lineNum">   15819 </span><span class="lineCov">         69 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;flag&quot;))) {</span>
<span class="lineNum">   15820 </span><span class="lineCov">         69 :                         ast_string_field_set(msg_snapshot, flag, value);</span>
<span class="lineNum">   15821 </span>            :                 }
<span class="lineNum">   15822 </span><span class="lineCov">         69 :                 msg_snapshot-&gt;msg_number = vms-&gt;curmsg;</span>
<span class="lineNum">   15823 </span><span class="lineCov">         69 :                 ast_string_field_set(msg_snapshot, folder_name, mailbox_folders[mailbox_index]);</span>
<span class="lineNum">   15824 </span>            : 
<span class="lineNum">   15825 </span>            :                 /* store msg snapshot in mailbox snapshot */
<span class="lineNum">   15826 </span><span class="lineCov">         69 :                 switch (sort_val) {</span>
<span class="lineNum">   15827 </span><span class="lineCov">         14 :                 default:</span>
<span class="lineNum">   15828 </span>            :                 case AST_VM_SNAPSHOT_SORT_BY_ID:
<span class="lineNum">   15829 </span><span class="lineCov">         14 :                         if (descending) {</span>
<span class="lineNum">   15830 </span><span class="lineCov">          2 :                                 AST_LIST_INSERT_HEAD(&amp;mailbox_snapshot-&gt;snapshots[snapshot_index], msg_snapshot, msg);</span>
<span class="lineNum">   15831 </span>            :                         } else {
<span class="lineNum">   15832 </span><span class="lineCov">         12 :                                 AST_LIST_INSERT_TAIL(&amp;mailbox_snapshot-&gt;snapshots[snapshot_index], msg_snapshot, msg);</span>
<span class="lineNum">   15833 </span>            :                         }
<span class="lineNum">   15834 </span><span class="lineCov">         14 :                         inserted = 1;</span>
<span class="lineNum">   15835 </span><span class="lineCov">         14 :                         break;</span>
<span class="lineNum">   15836 </span><span class="lineCov">         55 :                 case AST_VM_SNAPSHOT_SORT_BY_TIME:</span>
<span class="lineNum">   15837 </span><span class="lineCov">         62 :                         AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;mailbox_snapshot-&gt;snapshots[snapshot_index], msg_snapshot_tmp, msg) {</span>
<span class="lineNum">   15838 </span><span class="lineCov">         31 :                                 int val = strcmp(msg_snapshot-&gt;origtime, msg_snapshot_tmp-&gt;origtime);</span>
<span class="lineNum">   15839 </span><span class="lineCov">         31 :                                 if (descending &amp;&amp; val &gt;= 0) {</span>
<span class="lineNum">   15840 </span><span class="lineNoCov">          0 :                                         AST_LIST_INSERT_BEFORE_CURRENT(msg_snapshot, msg);</span>
<span class="lineNum">   15841 </span><span class="lineNoCov">          0 :                                         inserted = 1;</span>
<span class="lineNum">   15842 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">   15843 </span><span class="lineCov">         31 :                                 } else if (!descending &amp;&amp; val &lt;= 0) {</span>
<span class="lineNum">   15844 </span><span class="lineCov">         24 :                                         AST_LIST_INSERT_BEFORE_CURRENT(msg_snapshot, msg);</span>
<span class="lineNum">   15845 </span><span class="lineCov">         24 :                                         inserted = 1;</span>
<span class="lineNum">   15846 </span><span class="lineCov">         24 :                                         break;</span>
<span class="lineNum">   15847 </span>            :                                 }
<span class="lineNum">   15848 </span>            :                         }
<span class="lineNum">   15849 </span>            :                         AST_LIST_TRAVERSE_SAFE_END;
<span class="lineNum">   15850 </span><span class="lineCov">         55 :                         break;</span>
<span class="lineNum">   15851 </span>            :                 }
<span class="lineNum">   15852 </span>            : 
<span class="lineNum">   15853 </span><span class="lineCov">         69 :                 if (!inserted) {</span>
<span class="lineNum">   15854 </span><span class="lineCov">         31 :                         AST_LIST_INSERT_TAIL(&amp;mailbox_snapshot-&gt;snapshots[snapshot_index], msg_snapshot, msg);</span>
<span class="lineNum">   15855 </span>            :                 }
<span class="lineNum">   15856 </span>            : 
<span class="lineNum">   15857 </span><span class="lineCov">         69 :                 mailbox_snapshot-&gt;total_msg_num++;</span>
<span class="lineNum">   15858 </span>            : 
<span class="lineNum">   15859 </span>            :                 /* cleanup configs and msg */
<span class="lineNum">   15860 </span><span class="lineCov">         69 :                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   15861 </span>            :                 DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   15862 </span>            :         }
<span class="lineNum">   15863 </span>            : 
<span class="lineNum">   15864 </span><span class="lineCov">         37 :         return 0;</span>
<a name="15865"><span class="lineNum">   15865 </span>            : }</a>
<span class="lineNum">   15866 </span>            : 
<span class="lineNum">   15867 </span><span class="lineCov">         73 : static struct ast_vm_mailbox_snapshot *vm_mailbox_snapshot_create(const char *mailbox,</span>
<span class="lineNum">   15868 </span>            :         const char *context,
<span class="lineNum">   15869 </span>            :         const char *folder,
<span class="lineNum">   15870 </span>            :         int descending,
<span class="lineNum">   15871 </span>            :         enum ast_vm_snapshot_sort_val sort_val,
<span class="lineNum">   15872 </span>            :         int combine_INBOX_and_OLD)
<span class="lineNum">   15873 </span>            : {
<span class="lineNum">   15874 </span>            :         struct ast_vm_mailbox_snapshot *mailbox_snapshot;
<span class="lineNum">   15875 </span>            :         struct vm_state vms;
<span class="lineNum">   15876 </span><span class="lineCov">         73 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   15877 </span>            :         int res;
<span class="lineNum">   15878 </span>            :         int i;
<span class="lineNum">   15879 </span><span class="lineCov">         73 :         int this_index_only = -1;</span>
<span class="lineNum">   15880 </span><span class="lineCov">         73 :         int open = 0;</span>
<span class="lineNum">   15881 </span><span class="lineCov">         73 :         int inbox_index = get_folder_by_name(&quot;INBOX&quot;);</span>
<span class="lineNum">   15882 </span><span class="lineCov">         73 :         int old_index = get_folder_by_name(&quot;Old&quot;);</span>
<span class="lineNum">   15883 </span><span class="lineCov">         73 :         int urgent_index = get_folder_by_name(&quot;Urgent&quot;);</span>
<span class="lineNum">   15884 </span>            : 
<span class="lineNum">   15885 </span><span class="lineCov">         73 :         if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">   15886 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot create a mailbox snapshot since no mailbox was specified\n&quot;);</span>
<span class="lineNum">   15887 </span><span class="lineCov">          1 :                 return NULL;</span>
<span class="lineNum">   15888 </span>            :         }
<span class="lineNum">   15889 </span>            : 
<span class="lineNum">   15890 </span><span class="lineCov">         72 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   15891 </span>            : 
<span class="lineNum">   15892 </span><span class="lineCov">         72 :         if (!(ast_strlen_zero(folder))) {</span>
<span class="lineNum">   15893 </span>            :                 /* find the folder index */
<span class="lineNum">   15894 </span><span class="lineCov">         54 :                 for (i = 0; i &lt; ARRAY_LEN(mailbox_folders); i++) {</span>
<span class="lineNum">   15895 </span><span class="lineCov">         53 :                         if (!strcasecmp(mailbox_folders[i], folder)) {</span>
<span class="lineNum">   15896 </span><span class="lineCov">         28 :                                 this_index_only = i;</span>
<span class="lineNum">   15897 </span><span class="lineCov">         28 :                                 break;</span>
<span class="lineNum">   15898 </span>            :                         }
<span class="lineNum">   15899 </span>            :                 }
<span class="lineNum">   15900 </span><span class="lineCov">         29 :                 if (this_index_only == -1) {</span>
<span class="lineNum">   15901 </span>            :                         /* Folder was specified and it did not match any folder in our list */
<span class="lineNum">   15902 </span><span class="lineCov">          1 :                         return NULL;</span>
<span class="lineNum">   15903 </span>            :                 }
<span class="lineNum">   15904 </span>            :         }
<span class="lineNum">   15905 </span>            : 
<span class="lineNum">   15906 </span><span class="lineCov">         71 :         if (!(vmu = find_user(&amp;vmus, context, mailbox))) {</span>
<span class="lineNum">   15907 </span><span class="lineCov">          2 :                 ast_log(AST_LOG_WARNING, &quot;Failed to create mailbox snapshot for unknown voicemail user %s@%s\n&quot;, mailbox, context);</span>
<span class="lineNum">   15908 </span><span class="lineCov">          2 :                 return NULL;</span>
<span class="lineNum">   15909 </span>            :         }
<span class="lineNum">   15910 </span>            : 
<span class="lineNum">   15911 </span><span class="lineCov">         69 :         if (!(mailbox_snapshot = ast_calloc(1, sizeof(*mailbox_snapshot)))) {</span>
<span class="lineNum">   15912 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Failed to allocate memory for mailbox snapshot\n&quot;);</span>
<span class="lineNum">   15913 </span><span class="lineNoCov">          0 :                 free_user(vmu);</span>
<span class="lineNum">   15914 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   15915 </span>            :         }
<span class="lineNum">   15916 </span>            : 
<span class="lineNum">   15917 </span><span class="lineCov">         69 :         if (!(mailbox_snapshot-&gt;snapshots = ast_calloc(ARRAY_LEN(mailbox_folders), sizeof(*mailbox_snapshot-&gt;snapshots)))) {</span>
<span class="lineNum">   15918 </span><span class="lineNoCov">          0 :                 ast_free(mailbox_snapshot);</span>
<span class="lineNum">   15919 </span><span class="lineNoCov">          0 :                 free_user(vmu);</span>
<span class="lineNum">   15920 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">   15921 </span>            :         }
<span class="lineNum">   15922 </span>            : 
<span class="lineNum">   15923 </span><span class="lineCov">         69 :         mailbox_snapshot-&gt;folders = ARRAY_LEN(mailbox_folders);</span>
<span class="lineNum">   15924 </span>            : 
<span class="lineNum">   15925 </span><span class="lineCov">        897 :         for (i = 0; i &lt; mailbox_snapshot-&gt;folders; i++) {</span>
<span class="lineNum">   15926 </span><span class="lineCov">        828 :                 int msg_folder_index = i;</span>
<span class="lineNum">   15927 </span>            : 
<span class="lineNum">   15928 </span>            :                 /* We want this message in the snapshot if any of the following:
<span class="lineNum">   15929 </span>            :                  *   No folder was specified.
<span class="lineNum">   15930 </span>            :                  *   The specified folder matches the current folder.
<span class="lineNum">   15931 </span>            :                  *   The specified folder is INBOX AND we were asked to combine messages AND the current folder is either Old or Urgent.
<span class="lineNum">   15932 </span>            :                  */
<span class="lineNum">   15933 </span><span class="lineCov">        828 :                 if (!(this_index_only == -1 || this_index_only == i || (this_index_only == inbox_index &amp;&amp; combine_INBOX_and_OLD &amp;&amp; (i == old_index || i == urgent_index)))) {</span>
<span class="lineNum">   15934 </span><span class="lineCov">        278 :                         continue;</span>
<span class="lineNum">   15935 </span>            :                 }
<span class="lineNum">   15936 </span>            : 
<span class="lineNum">   15937 </span>            :                 /* Make sure that Old or Urgent messages are marked as being in INBOX. */
<span class="lineNum">   15938 </span><span class="lineCov">        550 :                 if (combine_INBOX_and_OLD &amp;&amp; (i == old_index || i == urgent_index)) {</span>
<span class="lineNum">   15939 </span><span class="lineCov">          8 :                         msg_folder_index = inbox_index;</span>
<span class="lineNum">   15940 </span>            :                 }
<span class="lineNum">   15941 </span>            : 
<span class="lineNum">   15942 </span><span class="lineCov">        550 :                 memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   15943 </span><span class="lineCov">        550 :                 ast_copy_string(vms.username, mailbox, sizeof(vms.username));</span>
<span class="lineNum">   15944 </span><span class="lineCov">        550 :                 vms.lastmsg = -1;</span>
<span class="lineNum">   15945 </span><span class="lineCov">        550 :                 open = 0;</span>
<span class="lineNum">   15946 </span>            : 
<span class="lineNum">   15947 </span>            :                 /* open the mailbox state */
<span class="lineNum">   15948 </span><span class="lineCov">        550 :                 if ((res = open_mailbox(&amp;vms, vmu, i)) &lt; 0) {</span>
<span class="lineNum">   15949 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   15950 </span><span class="lineNoCov">          0 :                         goto snapshot_cleanup;</span>
<span class="lineNum">   15951 </span>            :                 }
<span class="lineNum">   15952 </span><span class="lineCov">        550 :                 open = 1;</span>
<span class="lineNum">   15953 </span>            : 
<span class="lineNum">   15954 </span>            :                 /* Iterate through each msg, storing off info */
<span class="lineNum">   15955 </span><span class="lineCov">        550 :                 if (vms.lastmsg != -1) {</span>
<span class="lineNum">   15956 </span><span class="lineCov">         37 :                         if ((vm_msg_snapshot_create(vmu, &amp;vms, mailbox_snapshot, msg_folder_index, i, descending, sort_val))) {</span>
<span class="lineNum">   15957 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_WARNING, &quot;Failed to create msg snapshots for %s@%s\n&quot;, mailbox, context);</span>
<span class="lineNum">   15958 </span><span class="lineNoCov">          0 :                                 goto snapshot_cleanup;</span>
<span class="lineNum">   15959 </span>            :                         }
<span class="lineNum">   15960 </span>            :                 }
<span class="lineNum">   15961 </span>            : 
<span class="lineNum">   15962 </span>            :                 /* close mailbox */
<span class="lineNum">   15963 </span><span class="lineCov">        550 :                 if ((res = close_mailbox(&amp;vms, vmu) == ERROR_LOCK_PATH)) {</span>
<span class="lineNum">   15964 </span><span class="lineNoCov">          0 :                         goto snapshot_cleanup;</span>
<span class="lineNum">   15965 </span>            :                 }
<span class="lineNum">   15966 </span><span class="lineCov">        550 :                 open = 0;</span>
<span class="lineNum">   15967 </span>            :         }
<span class="lineNum">   15968 </span>            : 
<span class="lineNum">   15969 </span><span class="lineCov">         69 : snapshot_cleanup:</span>
<span class="lineNum">   15970 </span><span class="lineCov">         69 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   15971 </span><span class="lineNoCov">          0 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   15972 </span>            :         }
<span class="lineNum">   15973 </span>            : 
<span class="lineNum">   15974 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   15975 </span>            :         if (vmu) {
<span class="lineNum">   15976 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   15977 </span>            :         }
<span class="lineNum">   15978 </span>            : #endif
<span class="lineNum">   15979 </span>            : 
<span class="lineNum">   15980 </span><span class="lineCov">         69 :         free_user(vmu);</span>
<span class="lineNum">   15981 </span><span class="lineCov">         69 :         return mailbox_snapshot;</span>
<a name="15982"><span class="lineNum">   15982 </span>            : }</a>
<span class="lineNum">   15983 </span>            : 
<span class="lineNum">   15984 </span><span class="lineCov">         69 : static struct ast_vm_mailbox_snapshot *vm_mailbox_snapshot_destroy(struct ast_vm_mailbox_snapshot *mailbox_snapshot)</span>
<span class="lineNum">   15985 </span>            : {
<span class="lineNum">   15986 </span>            :         int i;
<span class="lineNum">   15987 </span>            :         struct ast_vm_msg_snapshot *msg_snapshot;
<span class="lineNum">   15988 </span>            : 
<span class="lineNum">   15989 </span><span class="lineCov">        897 :         for (i = 0; i &lt; mailbox_snapshot-&gt;folders; i++) {</span>
<span class="lineNum">   15990 </span><span class="lineCov">        897 :                 while ((msg_snapshot = AST_LIST_REMOVE_HEAD(&amp;mailbox_snapshot-&gt;snapshots[i], msg))) {</span>
<span class="lineNum">   15991 </span><span class="lineCov">         69 :                         msg_snapshot = vm_msg_snapshot_destroy(msg_snapshot);</span>
<span class="lineNum">   15992 </span>            :                 }
<span class="lineNum">   15993 </span>            :         }
<span class="lineNum">   15994 </span><span class="lineCov">         69 :         ast_free(mailbox_snapshot-&gt;snapshots);</span>
<span class="lineNum">   15995 </span><span class="lineCov">         69 :         ast_free(mailbox_snapshot);</span>
<span class="lineNum">   15996 </span><span class="lineCov">         69 :         return NULL;</span>
<span class="lineNum">   15997 </span>            : }
<span class="lineNum">   15998 </span>            : 
<span class="lineNum">   15999 </span>            : /*!
<span class="lineNum">   16000 </span>            :  * \brief common bounds checking and existence check for Voicemail API functions.
<span class="lineNum">   16001 </span>            :  *
<span class="lineNum">   16002 </span>            :  * \details
<span class="lineNum">   16003 </span>            :  * This is called by vm_msg_move, vm_msg_remove, and vm_msg_forward to
<span class="lineNum">   16004 </span>            :  * ensure that data passed in are valid. This ensures that given the
<span class="lineNum">   16005 </span>            :  * desired message IDs, they can be found.
<span class="lineNum">   16006 </span>            :  *
<span class="lineNum">   16007 </span>            :  * \param vms The voicemail state corresponding to an open mailbox
<span class="lineNum">   16008 </span>            :  * \param msg_ids An array of message identifiers
<span class="lineNum">   16009 </span>            :  * \param num_msgs The number of identifiers in msg_ids
<span class="lineNum">   16010 </span>            :  * \param msg_nums [out] The message indexes corresponding to the given
<span class="lineNum">   16011 </span>            :  * \param vmu
<span class="lineNum">   16012 </span>            :  * message IDs
<span class="lineNum">   16013 </span>            :  * \pre vms must have open_mailbox() called on it prior to this function.
<span class="lineNum">   16014 </span>            :  *
<span class="lineNum">   16015 </span>            :  * \retval -1 Failure
<a name="16016"><span class="lineNum">   16016 </span>            :  * \retval 0 Success</a>
<span class="lineNum">   16017 </span>            :  */
<span class="lineNum">   16018 </span><span class="lineCov">         29 : static int message_range_and_existence_check(struct vm_state *vms, const char *msg_ids [], size_t num_msgs, int *msg_nums, struct ast_vm_user *vmu)</span>
<span class="lineNum">   16019 </span>            : {
<span class="lineNum">   16020 </span>            :         int i;
<span class="lineNum">   16021 </span><span class="lineCov">         29 :         int res = 0;</span>
<span class="lineNum">   16022 </span><span class="lineCov">         55 :         for (i = 0; i &lt; num_msgs; ++i) {</span>
<span class="lineNum">   16023 </span><span class="lineCov">         35 :                 const char *msg_id = msg_ids[i];</span>
<span class="lineNum">   16024 </span><span class="lineCov">         35 :                 int found = 0;</span>
<span class="lineNum">   16025 </span><span class="lineCov">         51 :                 for (vms-&gt;curmsg = 0; vms-&gt;curmsg &lt;= vms-&gt;lastmsg; vms-&gt;curmsg++) {</span>
<span class="lineNum">   16026 </span>            :                         const char *other_msg_id;
<span class="lineNum">   16027 </span>            :                         char filename[PATH_MAX];
<span class="lineNum">   16028 </span>            :                         struct ast_config *msg_cfg;
<span class="lineNum">   16029 </span><span class="lineCov">         42 :                         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">   16030 </span>            : 
<span class="lineNum">   16031 </span><span class="lineCov">         42 :                         make_file(vms-&gt;fn, sizeof(vms-&gt;fn), vms-&gt;curdir, vms-&gt;curmsg);</span>
<span class="lineNum">   16032 </span><span class="lineCov">         42 :                         snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, vms-&gt;fn);</span>
<span class="lineNum">   16033 </span>            :                         RETRIEVE(vms-&gt;curdir, vms-&gt;curmsg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   16034 </span><span class="lineCov">         42 :                         msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">   16035 </span><span class="lineCov">         42 :                         if (!msg_cfg || msg_cfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   16036 </span>            :                                 DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   16037 </span><span class="lineNoCov">          0 :                                 res = -1;</span>
<span class="lineNum">   16038 </span><span class="lineNoCov">          0 :                                 goto done;</span>
<span class="lineNum">   16039 </span>            :                         }
<span class="lineNum">   16040 </span>            : 
<span class="lineNum">   16041 </span><span class="lineCov">         42 :                         other_msg_id = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;msg_id&quot;);</span>
<span class="lineNum">   16042 </span>            : 
<span class="lineNum">   16043 </span><span class="lineCov">         42 :                         if (!ast_strlen_zero(other_msg_id) &amp;&amp; !strcmp(other_msg_id, msg_id)) {</span>
<span class="lineNum">   16044 </span>            :                                 /* Message found. We can get out of this inner loop
<span class="lineNum">   16045 </span>            :                                  * and move on to the next message to find
<span class="lineNum">   16046 </span>            :                                  */
<span class="lineNum">   16047 </span><span class="lineCov">         26 :                                 found = 1;</span>
<span class="lineNum">   16048 </span><span class="lineCov">         26 :                                 msg_nums[i] = vms-&gt;curmsg;</span>
<span class="lineNum">   16049 </span><span class="lineCov">         26 :                                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   16050 </span>            :                                 DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   16051 </span><span class="lineCov">         26 :                                 break;</span>
<span class="lineNum">   16052 </span>            :                         }
<span class="lineNum">   16053 </span><span class="lineCov">         16 :                         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   16054 </span>            :                         DISPOSE(vms-&gt;curdir, vms-&gt;curmsg);
<span class="lineNum">   16055 </span>            :                 }
<span class="lineNum">   16056 </span><span class="lineCov">         35 :                 if (!found) {</span>
<span class="lineNum">   16057 </span>            :                         /* If we can't find one of the message IDs requested, then OH NO! */
<span class="lineNum">   16058 </span><span class="lineCov">          9 :                         res = -1;</span>
<span class="lineNum">   16059 </span><span class="lineCov">          9 :                         goto done;</span>
<span class="lineNum">   16060 </span>            :                 }
<span class="lineNum">   16061 </span>            :         }
<span class="lineNum">   16062 </span>            : 
<span class="lineNum">   16063 </span><span class="lineCov">         20 : done:</span>
<span class="lineNum">   16064 </span><span class="lineCov">         29 :         return res;</span>
<a name="16065"><span class="lineNum">   16065 </span>            : }</a>
<span class="lineNum">   16066 </span>            : 
<span class="lineNum">   16067 </span><span class="lineCov">         16 : static void notify_new_state(struct ast_vm_user *vmu)</span>
<span class="lineNum">   16068 </span>            : {
<span class="lineNum">   16069 </span><span class="lineCov">         16 :         int new = 0, old = 0, urgent = 0;</span>
<span class="lineNum">   16070 </span>            :         char ext_context[1024];
<span class="lineNum">   16071 </span>            : 
<span class="lineNum">   16072 </span><span class="lineCov">         16 :         snprintf(ext_context, sizeof(ext_context), &quot;%s@%s&quot;, vmu-&gt;mailbox, vmu-&gt;context);</span>
<span class="lineNum">   16073 </span><span class="lineCov">         16 :         run_externnotify(vmu-&gt;context, vmu-&gt;mailbox, NULL);</span>
<span class="lineNum">   16074 </span><span class="lineCov">         16 :         ast_app_inboxcount2(ext_context, &amp;urgent, &amp;new, &amp;old);</span>
<span class="lineNum">   16075 </span><span class="lineCov">         16 :         queue_mwi_event(NULL, ext_context, urgent, new, old);</span>
<a name="16076"><span class="lineNum">   16076 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">   16077 </span>            : 
<span class="lineNum">   16078 </span><span class="lineCov">         20 : static int vm_msg_forward(const char *from_mailbox,</span>
<span class="lineNum">   16079 </span>            :         const char *from_context,
<span class="lineNum">   16080 </span>            :         const char *from_folder,
<span class="lineNum">   16081 </span>            :         const char *to_mailbox,
<span class="lineNum">   16082 </span>            :         const char *to_context,
<span class="lineNum">   16083 </span>            :         const char *to_folder,
<span class="lineNum">   16084 </span>            :         size_t num_msgs,
<span class="lineNum">   16085 </span>            :         const char *msg_ids [],
<span class="lineNum">   16086 </span>            :         int delete_old)
<span class="lineNum">   16087 </span>            : {
<span class="lineNum">   16088 </span>            :         struct vm_state from_vms;
<span class="lineNum">   16089 </span><span class="lineCov">         20 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   16090 </span><span class="lineCov">         20 :         struct ast_vm_user *to_vmu = NULL, to_vmus;</span>
<span class="lineNum">   16091 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">   16092 </span><span class="lineCov">         20 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">   16093 </span>            :         char filename[PATH_MAX];
<span class="lineNum">   16094 </span>            :         int from_folder_index;
<span class="lineNum">   16095 </span><span class="lineCov">         20 :         int open = 0;</span>
<span class="lineNum">   16096 </span><span class="lineCov">         20 :         int res = 0;</span>
<span class="lineNum">   16097 </span>            :         int i;
<span class="lineNum">   16098 </span>            :         int *msg_nums;
<span class="lineNum">   16099 </span>            : 
<span class="lineNum">   16100 </span><span class="lineCov">         20 :         if (ast_strlen_zero(from_mailbox) || ast_strlen_zero(to_mailbox)) {</span>
<span class="lineNum">   16101 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Cannot forward message because either the from or to mailbox was not specified\n&quot;);</span>
<span class="lineNum">   16102 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16103 </span>            :         }
<span class="lineNum">   16104 </span>            : 
<span class="lineNum">   16105 </span><span class="lineCov">         18 :         if (!num_msgs) {</span>
<span class="lineNum">   16106 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Invalid number of messages specified to forward: %zu\n&quot;, num_msgs);</span>
<span class="lineNum">   16107 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16108 </span>            :         }
<span class="lineNum">   16109 </span>            : 
<span class="lineNum">   16110 </span><span class="lineCov">         17 :         if (ast_strlen_zero(from_folder) || ast_strlen_zero(to_folder)) {</span>
<span class="lineNum">   16111 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Cannot forward message because the from_folder or to_folder was not specified\n&quot;);</span>
<span class="lineNum">   16112 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16113 </span>            :         }
<span class="lineNum">   16114 </span>            : 
<span class="lineNum">   16115 </span><span class="lineCov">         15 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   16116 </span><span class="lineCov">         15 :         memset(&amp;to_vmus, 0, sizeof(to_vmus));</span>
<span class="lineNum">   16117 </span><span class="lineCov">         15 :         memset(&amp;from_vms, 0, sizeof(from_vms));</span>
<span class="lineNum">   16118 </span>            : 
<span class="lineNum">   16119 </span><span class="lineCov">         15 :         from_folder_index = get_folder_by_name(from_folder);</span>
<span class="lineNum">   16120 </span><span class="lineCov">         15 :         if (from_folder_index == -1) {</span>
<span class="lineNum">   16121 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16122 </span>            :         }
<span class="lineNum">   16123 </span>            : 
<span class="lineNum">   16124 </span><span class="lineCov">         14 :         if (get_folder_by_name(to_folder) == -1) {</span>
<span class="lineNum">   16125 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16126 </span>            :         }
<span class="lineNum">   16127 </span>            : 
<span class="lineNum">   16128 </span><span class="lineCov">         13 :         if (!(vmu = find_user(&amp;vmus, from_context, from_mailbox))) {</span>
<span class="lineNum">   16129 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Can't find voicemail user to forward from (%s@%s)\n&quot;, from_mailbox, from_context);</span>
<span class="lineNum">   16130 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16131 </span>            :         }
<span class="lineNum">   16132 </span>            : 
<span class="lineNum">   16133 </span><span class="lineCov">         11 :         if (!(to_vmu = find_user(&amp;to_vmus, to_context, to_mailbox))) {</span>
<span class="lineNum">   16134 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Can't find voicemail user to forward to (%s@%s)\n&quot;, to_mailbox, to_context);</span>
<span class="lineNum">   16135 </span><span class="lineCov">          2 :                 free_user(vmu);</span>
<span class="lineNum">   16136 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16137 </span>            :         }
<span class="lineNum">   16138 </span>            : 
<span class="lineNum">   16139 </span><span class="lineCov">          9 :         ast_copy_string(from_vms.username, from_mailbox, sizeof(from_vms.username));</span>
<span class="lineNum">   16140 </span><span class="lineCov">          9 :         from_vms.lastmsg = -1;</span>
<span class="lineNum">   16141 </span><span class="lineCov">          9 :         open = 0;</span>
<span class="lineNum">   16142 </span>            : 
<span class="lineNum">   16143 </span>            :         /* open the mailbox state */
<span class="lineNum">   16144 </span><span class="lineCov">          9 :         if ((res = open_mailbox(&amp;from_vms, vmu, from_folder_index)) &lt; 0) {</span>
<span class="lineNum">   16145 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, from_mailbox);</span>
<span class="lineNum">   16146 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16147 </span><span class="lineNoCov">          0 :                 goto vm_forward_cleanup;</span>
<span class="lineNum">   16148 </span>            :         }
<span class="lineNum">   16149 </span>            : 
<span class="lineNum">   16150 </span><span class="lineCov">          9 :         open = 1;</span>
<span class="lineNum">   16151 </span>            : 
<span class="lineNum">   16152 </span><span class="lineCov">          9 :         if ((from_vms.lastmsg + 1) &lt; num_msgs) {</span>
<span class="lineNum">   16153 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Folder %s has less than %zu messages\n&quot;, from_folder, num_msgs);</span>
<span class="lineNum">   16154 </span><span class="lineCov">          2 :                 res = -1;</span>
<span class="lineNum">   16155 </span><span class="lineCov">          2 :                 goto vm_forward_cleanup;</span>
<span class="lineNum">   16156 </span>            :         }
<span class="lineNum">   16157 </span>            : 
<span class="lineNum">   16158 </span><span class="lineCov">          7 :         msg_nums = ast_alloca(sizeof(int) * num_msgs);</span>
<span class="lineNum">   16159 </span>            : 
<span class="lineNum">   16160 </span><span class="lineCov">          7 :         if ((res = message_range_and_existence_check(&amp;from_vms, msg_ids, num_msgs, msg_nums, vmu) &lt; 0)) {</span>
<span class="lineNum">   16161 </span><span class="lineCov">          1 :                 goto vm_forward_cleanup;</span>
<span class="lineNum">   16162 </span>            :         }
<span class="lineNum">   16163 </span>            : 
<span class="lineNum">   16164 </span>            :         /* Now we actually forward the messages */
<span class="lineNum">   16165 </span><span class="lineCov">         14 :         for (i = 0; i &lt; num_msgs; i++) {</span>
<span class="lineNum">   16166 </span><span class="lineCov">          8 :                 int cur_msg = msg_nums[i];</span>
<span class="lineNum">   16167 </span><span class="lineCov">          8 :                 int duration = 0;</span>
<span class="lineNum">   16168 </span>            :                 const char *value;
<span class="lineNum">   16169 </span>            : 
<span class="lineNum">   16170 </span><span class="lineCov">          8 :                 make_file(from_vms.fn, sizeof(from_vms.fn), from_vms.curdir, cur_msg);</span>
<span class="lineNum">   16171 </span><span class="lineCov">          8 :                 snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, from_vms.fn);</span>
<span class="lineNum">   16172 </span>            :                 RETRIEVE(from_vms.curdir, cur_msg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   16173 </span><span class="lineCov">          8 :                 msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">   16174 </span>            :                 /* XXX This likely will not fail since we previously ensured that the
<span class="lineNum">   16175 </span>            :                  * message we are looking for exists. However, there still could be some
<span class="lineNum">   16176 </span>            :                  * circumstance where this fails, so atomicity is not guaranteed.
<span class="lineNum">   16177 </span>            :                  */
<span class="lineNum">   16178 </span><span class="lineCov">          8 :                 if (!msg_cfg || msg_cfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   16179 </span>            :                         DISPOSE(from_vms.curdir, cur_msg);
<span class="lineNum">   16180 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">   16181 </span>            :                 }
<span class="lineNum">   16182 </span><span class="lineCov">          8 :                 if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;))) {</span>
<span class="lineNum">   16183 </span><span class="lineCov">          8 :                         duration = atoi(value);</span>
<span class="lineNum">   16184 </span>            :                 }
<span class="lineNum">   16185 </span>            : 
<span class="lineNum">   16186 </span><span class="lineCov">          8 :                 copy_message(NULL, vmu, from_folder_index, cur_msg, duration, to_vmu, vmfmts, from_vms.curdir, &quot;&quot;, to_folder);</span>
<span class="lineNum">   16187 </span>            : 
<span class="lineNum">   16188 </span><span class="lineCov">          8 :                 if (delete_old) {</span>
<span class="lineNum">   16189 </span><span class="lineCov">          3 :                         from_vms.deleted[cur_msg] = 1;</span>
<span class="lineNum">   16190 </span>            :                 }
<span class="lineNum">   16191 </span><span class="lineCov">          8 :                 ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   16192 </span>            :                 DISPOSE(from_vms.curdir, cur_msg);
<span class="lineNum">   16193 </span>            :         }
<span class="lineNum">   16194 </span>            : 
<span class="lineNum">   16195 </span>            :         /* close mailbox */
<span class="lineNum">   16196 </span><span class="lineCov">          6 :         if ((res = close_mailbox(&amp;from_vms, vmu) == ERROR_LOCK_PATH)) {</span>
<span class="lineNum">   16197 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16198 </span><span class="lineNoCov">          0 :                 goto vm_forward_cleanup;</span>
<span class="lineNum">   16199 </span>            :         }
<span class="lineNum">   16200 </span><span class="lineCov">          6 :         open = 0;</span>
<span class="lineNum">   16201 </span>            : 
<span class="lineNum">   16202 </span><span class="lineCov">          9 : vm_forward_cleanup:</span>
<span class="lineNum">   16203 </span><span class="lineCov">          9 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   16204 </span><span class="lineCov">          3 :                 close_mailbox(&amp;from_vms, vmu);</span>
<span class="lineNum">   16205 </span>            :         }
<span class="lineNum">   16206 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   16207 </span>            :         if (vmu) {
<span class="lineNum">   16208 </span>            :                 vmstate_delete(&amp;from_vms);
<span class="lineNum">   16209 </span>            :         }
<span class="lineNum">   16210 </span>            : #endif
<span class="lineNum">   16211 </span>            : 
<span class="lineNum">   16212 </span><span class="lineCov">          9 :         if (!res) {</span>
<span class="lineNum">   16213 </span><span class="lineCov">          6 :                 notify_new_state(to_vmu);</span>
<span class="lineNum">   16214 </span>            :         }
<span class="lineNum">   16215 </span>            : 
<span class="lineNum">   16216 </span><span class="lineCov">          9 :         free_user(vmu);</span>
<span class="lineNum">   16217 </span><span class="lineCov">          9 :         free_user(to_vmu);</span>
<span class="lineNum">   16218 </span><span class="lineCov">          9 :         return res;</span>
<a name="16219"><span class="lineNum">   16219 </span>            : }</a>
<span class="lineNum">   16220 </span>            : 
<span class="lineNum">   16221 </span><span class="lineCov">         16 : static int vm_msg_move(const char *mailbox,</span>
<span class="lineNum">   16222 </span>            :         const char *context,
<span class="lineNum">   16223 </span>            :         size_t num_msgs,
<span class="lineNum">   16224 </span>            :         const char *oldfolder,
<span class="lineNum">   16225 </span>            :         const char *old_msg_ids [],
<span class="lineNum">   16226 </span>            :         const char *newfolder)
<span class="lineNum">   16227 </span>            : {
<span class="lineNum">   16228 </span>            :         struct vm_state vms;
<span class="lineNum">   16229 </span><span class="lineCov">         16 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   16230 </span>            :         int old_folder_index;
<span class="lineNum">   16231 </span>            :         int new_folder_index;
<span class="lineNum">   16232 </span><span class="lineCov">         16 :         int open = 0;</span>
<span class="lineNum">   16233 </span><span class="lineCov">         16 :         int res = 0;</span>
<span class="lineNum">   16234 </span>            :         int i;
<span class="lineNum">   16235 </span>            :         int *old_msg_nums;
<span class="lineNum">   16236 </span>            : 
<span class="lineNum">   16237 </span><span class="lineCov">         16 :         if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">   16238 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot move message because no mailbox was specified\n&quot;);</span>
<span class="lineNum">   16239 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16240 </span>            :         }
<span class="lineNum">   16241 </span>            : 
<span class="lineNum">   16242 </span><span class="lineCov">         15 :         if (!num_msgs) {</span>
<span class="lineNum">   16243 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Invalid number of messages specified to move: %zu\n&quot;, num_msgs);</span>
<span class="lineNum">   16244 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16245 </span>            :         }
<span class="lineNum">   16246 </span>            : 
<span class="lineNum">   16247 </span><span class="lineCov">         14 :         if (ast_strlen_zero(oldfolder) || ast_strlen_zero(newfolder)) {</span>
<span class="lineNum">   16248 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Cannot move message because either oldfolder or newfolder was not specified\n&quot;);</span>
<span class="lineNum">   16249 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16250 </span>            :         }
<span class="lineNum">   16251 </span>            : 
<span class="lineNum">   16252 </span><span class="lineCov">         12 :         old_folder_index = get_folder_by_name(oldfolder);</span>
<span class="lineNum">   16253 </span><span class="lineCov">         12 :         new_folder_index = get_folder_by_name(newfolder);</span>
<span class="lineNum">   16254 </span>            : 
<span class="lineNum">   16255 </span><span class="lineCov">         12 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   16256 </span><span class="lineCov">         12 :         memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   16257 </span>            : 
<span class="lineNum">   16258 </span><span class="lineCov">         12 :         if (old_folder_index == -1 || new_folder_index == -1) {</span>
<span class="lineNum">   16259 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16260 </span>            :         }
<span class="lineNum">   16261 </span>            : 
<span class="lineNum">   16262 </span><span class="lineCov">         10 :         if (!(vmu = find_user(&amp;vmus, context, mailbox))) {</span>
<span class="lineNum">   16263 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16264 </span>            :         }
<span class="lineNum">   16265 </span>            : 
<span class="lineNum">   16266 </span><span class="lineCov">          8 :         ast_copy_string(vms.username, mailbox, sizeof(vms.username));</span>
<span class="lineNum">   16267 </span><span class="lineCov">          8 :         vms.lastmsg = -1;</span>
<span class="lineNum">   16268 </span><span class="lineCov">          8 :         open = 0;</span>
<span class="lineNum">   16269 </span>            : 
<span class="lineNum">   16270 </span>            :         /* open the mailbox state */
<span class="lineNum">   16271 </span><span class="lineCov">          8 :         if ((res = open_mailbox(&amp;vms, vmu, old_folder_index)) &lt; 0) {</span>
<span class="lineNum">   16272 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   16273 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16274 </span><span class="lineNoCov">          0 :                 goto vm_move_cleanup;</span>
<span class="lineNum">   16275 </span>            :         }
<span class="lineNum">   16276 </span>            : 
<span class="lineNum">   16277 </span><span class="lineCov">          8 :         open = 1;</span>
<span class="lineNum">   16278 </span>            : 
<span class="lineNum">   16279 </span><span class="lineCov">          8 :         if ((vms.lastmsg + 1) &lt; num_msgs) {</span>
<span class="lineNum">   16280 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Folder %s has less than %zu messages\n&quot;, oldfolder, num_msgs);</span>
<span class="lineNum">   16281 </span><span class="lineCov">          2 :                 res = -1;</span>
<span class="lineNum">   16282 </span><span class="lineCov">          2 :                 goto vm_move_cleanup;</span>
<span class="lineNum">   16283 </span>            :         }
<span class="lineNum">   16284 </span>            : 
<span class="lineNum">   16285 </span><span class="lineCov">          6 :         old_msg_nums = ast_alloca(sizeof(int) * num_msgs);</span>
<span class="lineNum">   16286 </span>            : 
<span class="lineNum">   16287 </span><span class="lineCov">          6 :         if ((res = message_range_and_existence_check(&amp;vms, old_msg_ids, num_msgs, old_msg_nums, vmu)) &lt; 0) {</span>
<span class="lineNum">   16288 </span><span class="lineCov">          2 :                 goto vm_move_cleanup;</span>
<span class="lineNum">   16289 </span>            :         }
<span class="lineNum">   16290 </span>            : 
<span class="lineNum">   16291 </span>            :         /* Now actually move the message */
<span class="lineNum">   16292 </span><span class="lineCov">         10 :         for (i = 0; i &lt; num_msgs; ++i) {</span>
<span class="lineNum">   16293 </span><span class="lineCov">          6 :                 if (save_to_folder(vmu, &amp;vms, old_msg_nums[i], new_folder_index, NULL, 0)) {</span>
<span class="lineNum">   16294 </span><span class="lineNoCov">          0 :                         res = -1;</span>
<span class="lineNum">   16295 </span><span class="lineNoCov">          0 :                         goto vm_move_cleanup;</span>
<span class="lineNum">   16296 </span>            :                 }
<span class="lineNum">   16297 </span><span class="lineCov">          6 :                 vms.deleted[old_msg_nums[i]] = 1;</span>
<span class="lineNum">   16298 </span>            :         }
<span class="lineNum">   16299 </span>            : 
<span class="lineNum">   16300 </span>            :         /* close mailbox */
<span class="lineNum">   16301 </span><span class="lineCov">          4 :         if ((res = close_mailbox(&amp;vms, vmu) == ERROR_LOCK_PATH)) {</span>
<span class="lineNum">   16302 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16303 </span><span class="lineNoCov">          0 :                 goto vm_move_cleanup;</span>
<span class="lineNum">   16304 </span>            :         }
<span class="lineNum">   16305 </span><span class="lineCov">          4 :         open = 0;</span>
<span class="lineNum">   16306 </span>            : 
<span class="lineNum">   16307 </span><span class="lineCov">          8 : vm_move_cleanup:</span>
<span class="lineNum">   16308 </span><span class="lineCov">          8 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   16309 </span><span class="lineCov">          4 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   16310 </span>            :         }
<span class="lineNum">   16311 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   16312 </span>            :         if (vmu) {
<span class="lineNum">   16313 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   16314 </span>            :         }
<span class="lineNum">   16315 </span>            : #endif
<span class="lineNum">   16316 </span>            : 
<span class="lineNum">   16317 </span><span class="lineCov">          8 :         if (!res) {</span>
<span class="lineNum">   16318 </span><span class="lineCov">          4 :                 notify_new_state(vmu);</span>
<span class="lineNum">   16319 </span>            :         }
<span class="lineNum">   16320 </span>            : 
<span class="lineNum">   16321 </span><span class="lineCov">          8 :         free_user(vmu);</span>
<span class="lineNum">   16322 </span><span class="lineCov">          8 :         return res;</span>
<a name="16323"><span class="lineNum">   16323 </span>            : }</a>
<span class="lineNum">   16324 </span>            : 
<span class="lineNum">   16325 </span><span class="lineCov">         12 : static int vm_msg_remove(const char *mailbox,</span>
<span class="lineNum">   16326 </span>            :         const char *context,
<span class="lineNum">   16327 </span>            :         size_t num_msgs,
<span class="lineNum">   16328 </span>            :         const char *folder,
<span class="lineNum">   16329 </span>            :         const char *msgs[])
<span class="lineNum">   16330 </span>            : {
<span class="lineNum">   16331 </span>            :         struct vm_state vms;
<span class="lineNum">   16332 </span><span class="lineCov">         12 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   16333 </span>            :         int folder_index;
<span class="lineNum">   16334 </span><span class="lineCov">         12 :         int open = 0;</span>
<span class="lineNum">   16335 </span><span class="lineCov">         12 :         int res = 0;</span>
<span class="lineNum">   16336 </span>            :         int i;
<span class="lineNum">   16337 </span>            :         int *msg_nums;
<span class="lineNum">   16338 </span>            : 
<span class="lineNum">   16339 </span><span class="lineCov">         12 :         if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">   16340 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot remove message because no mailbox was specified\n&quot;);</span>
<span class="lineNum">   16341 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16342 </span>            :         }
<span class="lineNum">   16343 </span>            : 
<span class="lineNum">   16344 </span><span class="lineCov">         11 :         if (!num_msgs) {</span>
<span class="lineNum">   16345 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Invalid number of messages specified to remove: %zu\n&quot;, num_msgs);</span>
<span class="lineNum">   16346 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16347 </span>            :         }
<span class="lineNum">   16348 </span>            : 
<span class="lineNum">   16349 </span><span class="lineCov">         10 :         if (ast_strlen_zero(folder)) {</span>
<span class="lineNum">   16350 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot remove message because no folder was specified\n&quot;);</span>
<span class="lineNum">   16351 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16352 </span>            :         }
<span class="lineNum">   16353 </span>            : 
<span class="lineNum">   16354 </span><span class="lineCov">          9 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   16355 </span><span class="lineCov">          9 :         memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   16356 </span>            : 
<span class="lineNum">   16357 </span><span class="lineCov">          9 :         folder_index = get_folder_by_name(folder);</span>
<span class="lineNum">   16358 </span><span class="lineCov">          9 :         if (folder_index == -1) {</span>
<span class="lineNum">   16359 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Could not remove msgs from unknown folder %s\n&quot;, folder);</span>
<span class="lineNum">   16360 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16361 </span>            :         }
<span class="lineNum">   16362 </span>            : 
<span class="lineNum">   16363 </span><span class="lineCov">          8 :         if (!(vmu = find_user(&amp;vmus, context, mailbox))) {</span>
<span class="lineNum">   16364 </span><span class="lineCov">          2 :                 ast_log(LOG_WARNING, &quot;Can't find voicemail user to remove msg from (%s@%s)\n&quot;, mailbox, context);</span>
<span class="lineNum">   16365 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16366 </span>            :         }
<span class="lineNum">   16367 </span>            : 
<span class="lineNum">   16368 </span><span class="lineCov">          6 :         ast_copy_string(vms.username, mailbox, sizeof(vms.username));</span>
<span class="lineNum">   16369 </span><span class="lineCov">          6 :         vms.lastmsg = -1;</span>
<span class="lineNum">   16370 </span><span class="lineCov">          6 :         open = 0;</span>
<span class="lineNum">   16371 </span>            : 
<span class="lineNum">   16372 </span>            :         /* open the mailbox state */
<span class="lineNum">   16373 </span><span class="lineCov">          6 :         if ((res = open_mailbox(&amp;vms, vmu, folder_index)) &lt; 0) {</span>
<span class="lineNum">   16374 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   16375 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16376 </span><span class="lineNoCov">          0 :                 goto vm_remove_cleanup;</span>
<span class="lineNum">   16377 </span>            :         }
<span class="lineNum">   16378 </span>            : 
<span class="lineNum">   16379 </span><span class="lineCov">          6 :         open = 1;</span>
<span class="lineNum">   16380 </span>            : 
<span class="lineNum">   16381 </span><span class="lineCov">          6 :         if ((vms.lastmsg + 1) &lt; num_msgs) {</span>
<span class="lineNum">   16382 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Folder %s has less than %zu messages\n&quot;, folder, num_msgs);</span>
<span class="lineNum">   16383 </span><span class="lineCov">          1 :                 res = -1;</span>
<span class="lineNum">   16384 </span><span class="lineCov">          1 :                 goto vm_remove_cleanup;</span>
<span class="lineNum">   16385 </span>            :         }
<span class="lineNum">   16386 </span>            : 
<span class="lineNum">   16387 </span><span class="lineCov">          5 :         msg_nums = ast_alloca(sizeof(int) * num_msgs);</span>
<span class="lineNum">   16388 </span>            : 
<span class="lineNum">   16389 </span><span class="lineCov">          5 :         if ((res = message_range_and_existence_check(&amp;vms, msgs, num_msgs, msg_nums, vmu)) &lt; 0) {</span>
<span class="lineNum">   16390 </span><span class="lineCov">          2 :                 goto vm_remove_cleanup;</span>
<span class="lineNum">   16391 </span>            :         }
<span class="lineNum">   16392 </span>            : 
<span class="lineNum">   16393 </span><span class="lineCov">          7 :         for (i = 0; i &lt; num_msgs; i++) {</span>
<span class="lineNum">   16394 </span><span class="lineCov">          4 :                 vms.deleted[msg_nums[i]] = 1;</span>
<span class="lineNum">   16395 </span>            :         }
<span class="lineNum">   16396 </span>            : 
<span class="lineNum">   16397 </span>            :         /* close mailbox */
<span class="lineNum">   16398 </span><span class="lineCov">          3 :         if ((res = close_mailbox(&amp;vms, vmu) == ERROR_LOCK_PATH)) {</span>
<span class="lineNum">   16399 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16400 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_ERROR, &quot;Failed to close mailbox folder %s while removing msgs\n&quot;, folder);</span>
<span class="lineNum">   16401 </span><span class="lineNoCov">          0 :                 goto vm_remove_cleanup;</span>
<span class="lineNum">   16402 </span>            :         }
<span class="lineNum">   16403 </span><span class="lineCov">          3 :         open = 0;</span>
<span class="lineNum">   16404 </span>            : 
<span class="lineNum">   16405 </span><span class="lineCov">          6 : vm_remove_cleanup:</span>
<span class="lineNum">   16406 </span><span class="lineCov">          6 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   16407 </span><span class="lineCov">          3 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   16408 </span>            :         }
<span class="lineNum">   16409 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   16410 </span>            :         if (vmu) {
<span class="lineNum">   16411 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   16412 </span>            :         }
<span class="lineNum">   16413 </span>            : #endif
<span class="lineNum">   16414 </span>            : 
<span class="lineNum">   16415 </span><span class="lineCov">          6 :         if (!res) {</span>
<span class="lineNum">   16416 </span><span class="lineCov">          3 :                 notify_new_state(vmu);</span>
<span class="lineNum">   16417 </span>            :         }
<span class="lineNum">   16418 </span>            : 
<span class="lineNum">   16419 </span><span class="lineCov">          6 :         free_user(vmu);</span>
<span class="lineNum">   16420 </span><span class="lineCov">          6 :         return res;</span>
<a name="16421"><span class="lineNum">   16421 </span>            : }</a>
<span class="lineNum">   16422 </span>            : 
<span class="lineNum">   16423 </span><span class="lineCov">         10 : static int vm_msg_play(struct ast_channel *chan,</span>
<span class="lineNum">   16424 </span>            :         const char *mailbox,
<span class="lineNum">   16425 </span>            :         const char *context,
<span class="lineNum">   16426 </span>            :         const char *folder,
<span class="lineNum">   16427 </span>            :         const char *msg_id,
<span class="lineNum">   16428 </span>            :         ast_vm_msg_play_cb cb)
<span class="lineNum">   16429 </span>            : {
<span class="lineNum">   16430 </span>            :         struct vm_state vms;
<span class="lineNum">   16431 </span><span class="lineCov">         10 :         struct ast_vm_user *vmu = NULL, vmus;</span>
<span class="lineNum">   16432 </span><span class="lineCov">         10 :         int res = 0;</span>
<span class="lineNum">   16433 </span><span class="lineCov">         10 :         int open = 0;</span>
<span class="lineNum">   16434 </span>            :         int i;
<span class="lineNum">   16435 </span>            :         char filename[PATH_MAX];
<span class="lineNum">   16436 </span>            :         struct ast_config *msg_cfg;
<span class="lineNum">   16437 </span><span class="lineCov">         10 :         struct ast_flags config_flags = { CONFIG_FLAG_NOCACHE };</span>
<span class="lineNum">   16438 </span><span class="lineCov">         10 :         int duration = 0;</span>
<span class="lineNum">   16439 </span>            :         const char *value;
<span class="lineNum">   16440 </span>            : 
<span class="lineNum">   16441 </span><span class="lineCov">         10 :         if (ast_strlen_zero(mailbox)) {</span>
<span class="lineNum">   16442 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot play message because no mailbox was specified\n&quot;);</span>
<span class="lineNum">   16443 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16444 </span>            :         }
<span class="lineNum">   16445 </span>            : 
<span class="lineNum">   16446 </span><span class="lineCov">          9 :         if (ast_strlen_zero(folder)) {</span>
<span class="lineNum">   16447 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot play message because no folder was specified\n&quot;);</span>
<span class="lineNum">   16448 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16449 </span>            :         }
<span class="lineNum">   16450 </span>            : 
<span class="lineNum">   16451 </span><span class="lineCov">          8 :         if (ast_strlen_zero(msg_id)) {</span>
<span class="lineNum">   16452 </span><span class="lineCov">          1 :                 ast_log(LOG_WARNING, &quot;Cannot play message because no message number was specified\n&quot;);</span>
<span class="lineNum">   16453 </span><span class="lineCov">          1 :                 return -1;</span>
<span class="lineNum">   16454 </span>            :         }
<span class="lineNum">   16455 </span>            : 
<span class="lineNum">   16456 </span><span class="lineCov">          7 :         memset(&amp;vmus, 0, sizeof(vmus));</span>
<span class="lineNum">   16457 </span><span class="lineCov">          7 :         memset(&amp;vms, 0, sizeof(vms));</span>
<span class="lineNum">   16458 </span>            : 
<span class="lineNum">   16459 </span><span class="lineCov">          7 :         if (ast_strlen_zero(context)) {</span>
<span class="lineNum">   16460 </span><span class="lineCov">          1 :                 context = &quot;default&quot;;</span>
<span class="lineNum">   16461 </span>            :         }
<span class="lineNum">   16462 </span>            : 
<span class="lineNum">   16463 </span><span class="lineCov">          7 :         if (!(vmu = find_user(&amp;vmus, context, mailbox))) {</span>
<span class="lineNum">   16464 </span><span class="lineCov">          2 :                 return -1;</span>
<span class="lineNum">   16465 </span>            :         }
<span class="lineNum">   16466 </span>            : 
<span class="lineNum">   16467 </span><span class="lineCov">          5 :         i = get_folder_by_name(folder);</span>
<span class="lineNum">   16468 </span><span class="lineCov">          5 :         ast_copy_string(vms.username, mailbox, sizeof(vms.username));</span>
<span class="lineNum">   16469 </span><span class="lineCov">          5 :         vms.lastmsg = -1;</span>
<span class="lineNum">   16470 </span><span class="lineCov">          5 :         if ((res = open_mailbox(&amp;vms, vmu, i)) &lt; 0) {</span>
<span class="lineNum">   16471 </span><span class="lineNoCov">          0 :                 ast_log(LOG_WARNING, &quot;Could not open mailbox %s\n&quot;, mailbox);</span>
<span class="lineNum">   16472 </span><span class="lineNoCov">          0 :                 goto play2_msg_cleanup;</span>
<span class="lineNum">   16473 </span>            :         }
<span class="lineNum">   16474 </span><span class="lineCov">          5 :         open = 1;</span>
<span class="lineNum">   16475 </span>            : 
<span class="lineNum">   16476 </span><span class="lineCov">          5 :         if (message_range_and_existence_check(&amp;vms, &amp;msg_id, 1, &amp;vms.curmsg, vmu)) {</span>
<span class="lineNum">   16477 </span><span class="lineCov">          2 :                 res = -1;</span>
<span class="lineNum">   16478 </span><span class="lineCov">          2 :                 goto play2_msg_cleanup;</span>
<span class="lineNum">   16479 </span>            :         }
<span class="lineNum">   16480 </span>            : 
<span class="lineNum">   16481 </span>            :         /* Find the msg */
<span class="lineNum">   16482 </span><span class="lineCov">          3 :         make_file(vms.fn, sizeof(vms.fn), vms.curdir, vms.curmsg);</span>
<span class="lineNum">   16483 </span><span class="lineCov">          3 :         snprintf(filename, sizeof(filename), &quot;%s.txt&quot;, vms.fn);</span>
<span class="lineNum">   16484 </span>            :         RETRIEVE(vms.curdir, vms.curmsg, vmu-&gt;mailbox, vmu-&gt;context);
<span class="lineNum">   16485 </span>            : 
<span class="lineNum">   16486 </span><span class="lineCov">          3 :         msg_cfg = ast_config_load(filename, config_flags);</span>
<span class="lineNum">   16487 </span><span class="lineCov">          3 :         if (!msg_cfg || msg_cfg == CONFIG_STATUS_FILEINVALID) {</span>
<span class="lineNum">   16488 </span>            :                 DISPOSE(vms.curdir, vms.curmsg);
<span class="lineNum">   16489 </span><span class="lineNoCov">          0 :                 res = -1;</span>
<span class="lineNum">   16490 </span><span class="lineNoCov">          0 :                 goto play2_msg_cleanup;</span>
<span class="lineNum">   16491 </span>            :         }
<span class="lineNum">   16492 </span><span class="lineCov">          3 :         if ((value = ast_variable_retrieve(msg_cfg, &quot;message&quot;, &quot;duration&quot;))) {</span>
<span class="lineNum">   16493 </span><span class="lineCov">          3 :                 duration = atoi(value);</span>
<span class="lineNum">   16494 </span>            :         }
<span class="lineNum">   16495 </span><span class="lineCov">          3 :         ast_config_destroy(msg_cfg);</span>
<span class="lineNum">   16496 </span>            : 
<span class="lineNum">   16497 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   16498 </span>            :         /*IMAP storage stores any prepended message from a forward
<span class="lineNum">   16499 </span>            :          * as a separate file from the rest of the message
<span class="lineNum">   16500 </span>            :          */
<span class="lineNum">   16501 </span>            :         if (!ast_strlen_zero(vms.introfn) &amp;&amp; ast_fileexists(vms.introfn, NULL, NULL) &gt; 0) {
<span class="lineNum">   16502 </span>            :                 wait_file(chan, &amp;vms, vms.introfn);
<span class="lineNum">   16503 </span>            :         }
<span class="lineNum">   16504 </span>            : #endif
<span class="lineNum">   16505 </span><span class="lineCov">          3 :         if (cb) {</span>
<span class="lineNum">   16506 </span><span class="lineCov">          2 :                 cb(chan, vms.fn, duration);</span>
<span class="lineNum">   16507 </span><span class="lineCov">          1 :         } else if ((wait_file(chan, &amp;vms, vms.fn)) &lt; 0) {</span>
<span class="lineNum">   16508 </span><span class="lineNoCov">          0 :                 ast_log(AST_LOG_WARNING, &quot;Playback of message %s failed\n&quot;, vms.fn);</span>
<span class="lineNum">   16509 </span>            :         } else {
<span class="lineNum">   16510 </span><span class="lineCov">          1 :                 res = 0;</span>
<span class="lineNum">   16511 </span>            :         }
<span class="lineNum">   16512 </span>            : 
<span class="lineNum">   16513 </span><span class="lineCov">          3 :         vms.heard[vms.curmsg] = 1;</span>
<span class="lineNum">   16514 </span>            : 
<span class="lineNum">   16515 </span>            :         /* cleanup configs and msg */
<span class="lineNum">   16516 </span>            :         DISPOSE(vms.curdir, vms.curmsg);
<span class="lineNum">   16517 </span>            : 
<span class="lineNum">   16518 </span><span class="lineCov">          5 : play2_msg_cleanup:</span>
<span class="lineNum">   16519 </span><span class="lineCov">          5 :         if (vmu &amp;&amp; open) {</span>
<span class="lineNum">   16520 </span><span class="lineCov">          5 :                 close_mailbox(&amp;vms, vmu);</span>
<span class="lineNum">   16521 </span>            :         }
<span class="lineNum">   16522 </span>            : 
<span class="lineNum">   16523 </span>            : #ifdef IMAP_STORAGE
<span class="lineNum">   16524 </span>            :         if (vmu) {
<span class="lineNum">   16525 </span>            :                 vmstate_delete(&amp;vms);
<span class="lineNum">   16526 </span>            :         }
<span class="lineNum">   16527 </span>            : #endif
<span class="lineNum">   16528 </span>            : 
<span class="lineNum">   16529 </span><span class="lineCov">          5 :         if (!res) {</span>
<span class="lineNum">   16530 </span><span class="lineCov">          3 :                 notify_new_state(vmu);</span>
<span class="lineNum">   16531 </span>            :         }
<span class="lineNum">   16532 </span>            : 
<span class="lineNum">   16533 </span><span class="lineCov">          5 :         free_user(vmu);</span>
<span class="lineNum">   16534 </span><span class="lineCov">          5 :         return res;</span>
<span class="lineNum">   16535 </span>            : }
<span class="lineNum">   16536 </span>            : 
<span class="lineNum">   16537 </span>            : /* This is a workaround so that menuselect displays a proper description
<span class="lineNum">   16538 </span>            :  * AST_MODULE_INFO(, , &quot;Comedian Mail (Voicemail System)&quot;
<a name="16539"><span class="lineNum">   16539 </span>            :  */</a>
<span class="lineNum">   16540 </span>            : 
<span class="lineNum">   16541 </span><span class="lineCov">      15143 : AST_MODULE_INFO(ASTERISK_GPL_KEY, AST_MODFLAG_DEFAULT, tdesc,</span>
<span class="lineNum">   16542 </span>            :         .support_level = AST_MODULE_SUPPORT_CORE,
<span class="lineNum">   16543 </span>            :         .load = load_module,
<span class="lineNum">   16544 </span>            :         .unload = unload_module,
<span class="lineNum">   16545 </span>            :         .reload = reload,
<span class="lineNum">   16546 </span>            :         .optional_modules = &quot;res_adsi,res_smdi&quot;,
<span class="lineNum">   16547 </span>            : );
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
