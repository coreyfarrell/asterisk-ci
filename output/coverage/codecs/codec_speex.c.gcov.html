<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Asterisk GIT-16-9767e98486 - codecs/codec_speex.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">codecs</a> - codec_speex.c<span style="font-size: 80%;"> (source / <a href="codec_speex.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Asterisk GIT-16-9767e98486</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">185</td>
            <td class="headerCovTableEntry">276</td>
            <td class="headerCovTableEntryLo">67.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-07-22 22:16:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">17</td>
            <td class="headerCovTableEntry">21</td>
            <td class="headerCovTableEntryMed">81.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Asterisk -- An open source telephony toolkit.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Copyright (C) 1999 - 2005, Digium, Inc.
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * Mark Spencer &lt;markster@digium.com&gt;
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *
<span class="lineNum">       9 </span>            :  * See http://www.asterisk.org for more information about
<span class="lineNum">      10 </span>            :  * the Asterisk project. Please do not directly contact
<span class="lineNum">      11 </span>            :  * any of the maintainers of this project for assistance;
<span class="lineNum">      12 </span>            :  * the project provides a web site, mailing lists and IRC
<span class="lineNum">      13 </span>            :  * channels for your use.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  * This program is free software, distributed under the terms of
<span class="lineNum">      16 </span>            :  * the GNU General Public License Version 2. See the LICENSE file
<span class="lineNum">      17 </span>            :  * at the top of the source tree.
<span class="lineNum">      18 </span>            :  */
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : /*! \file
<span class="lineNum">      21 </span>            :  *
<span class="lineNum">      22 </span>            :  * \brief Translate between signed linear and Speex (Open Codec)
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  * \note This work was motivated by Jeremy McNamara
<span class="lineNum">      25 </span>            :  * hacked to be configurable by anthm and bkw 9/28/2004
<span class="lineNum">      26 </span>            :  *
<span class="lineNum">      27 </span>            :  * \ingroup codecs
<span class="lineNum">      28 </span>            :  *
<span class="lineNum">      29 </span>            :  * The Speex library - http://www.speex.org
<span class="lineNum">      30 </span>            :  *
<span class="lineNum">      31 </span>            :  */
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : /*** MODULEINFO
<span class="lineNum">      34 </span>            :         &lt;depend&gt;speex&lt;/depend&gt;
<span class="lineNum">      35 </span>            :         &lt;depend&gt;speex_preprocess&lt;/depend&gt;
<span class="lineNum">      36 </span>            :         &lt;use type=&quot;external&quot;&gt;speexdsp&lt;/use&gt;
<span class="lineNum">      37 </span>            :         &lt;support_level&gt;core&lt;/support_level&gt;
<span class="lineNum">      38 </span>            :  ***/
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : #include &quot;asterisk.h&quot;
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #include &lt;speex/speex.h&gt;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : /* We require a post 1.1.8 version of Speex to enable preprocessing
<span class="lineNum">      45 </span>            :  * and better type handling
<span class="lineNum">      46 </span>            :  */
<span class="lineNum">      47 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">      48 </span>            : #include &lt;speex/speex_preprocess.h&gt;
<span class="lineNum">      49 </span>            : #endif
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : #include &quot;asterisk/translate.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;asterisk/module.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;asterisk/config.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;asterisk/utils.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;asterisk/frame.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;asterisk/linkedlists.h&quot;
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : /* For struct ast_rtp_rtcp_report and struct ast_rtp_rtcp_report_block */
<span class="lineNum">      59 </span>            : #include &quot;asterisk/rtp_engine.h&quot;
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : /* codec variables */
<span class="lineNum">      62 </span>            : static int quality = 3;
<span class="lineNum">      63 </span>            : static int complexity = 2;
<span class="lineNum">      64 </span>            : static int enhancement = 0;
<span class="lineNum">      65 </span>            : static int vad = 0;
<span class="lineNum">      66 </span>            : static int vbr = 0;
<span class="lineNum">      67 </span>            : static float vbr_quality = 4;
<span class="lineNum">      68 </span>            : static int abr = 0;
<span class="lineNum">      69 </span>            : static int dtx = 0;     /* set to 1 to enable silence detection */
<span class="lineNum">      70 </span>            : static int exp_rtcp_fb = 0;     /* set to 1 to use experimental RTCP feedback for changing bitrate */
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : static int preproc = 0;
<span class="lineNum">      73 </span>            : static int pp_vad = 0;
<span class="lineNum">      74 </span>            : static int pp_agc = 0;
<span class="lineNum">      75 </span>            : static float pp_agc_level = 8000; /* XXX what is this 8000 ? */
<span class="lineNum">      76 </span>            : static int pp_denoise = 0;
<span class="lineNum">      77 </span>            : static int pp_dereverb = 0;
<span class="lineNum">      78 </span>            : static float pp_dereverb_decay = 0.4;
<span class="lineNum">      79 </span>            : static float pp_dereverb_level = 0.3;
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            : #define TYPE_SILENCE     0x2
<span class="lineNum">      82 </span>            : #define TYPE_HIGH        0x0
<span class="lineNum">      83 </span>            : #define TYPE_LOW         0x1
<span class="lineNum">      84 </span>            : #define TYPE_MASK        0x3
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : #define BUFFER_SAMPLES  8000
<span class="lineNum">      87 </span>            : #define SPEEX_SAMPLES   160
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : /* Sample frame data */
<span class="lineNum">      90 </span>            : #include &quot;asterisk/slin.h&quot;
<span class="lineNum">      91 </span>            : #include &quot;ex_speex.h&quot;
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : struct speex_coder_pvt {
<span class="lineNum">      94 </span>            :         void *speex;
<span class="lineNum">      95 </span>            :         SpeexBits bits;
<span class="lineNum">      96 </span>            :         int framesize;
<span class="lineNum">      97 </span>            :         int silent_state;
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            :         int fraction_lost;
<span class="lineNum">     100 </span>            :         int quality;
<span class="lineNum">     101 </span>            :         int default_quality;
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     104 </span>            :         SpeexPreprocessState *pp;
<span class="lineNum">     105 </span>            :         spx_int16_t buf[BUFFER_SAMPLES];
<span class="lineNum">     106 </span>            : #else
<span class="lineNum">     107 </span>            :         int16_t buf[BUFFER_SAMPLES];    /* input, waiting to be compressed */
<span class="lineNum">     108 </span>            : #endif
<a name="109"><span class="lineNum">     109 </span>            : };</a>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineCov">       2235 : static int speex_encoder_construct(struct ast_trans_pvt *pvt, const SpeexMode *profile, int sampling_rate)</span>
<span class="lineNum">     112 </span>            : {
<span class="lineNum">     113 </span><span class="lineCov">       2235 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">       2235 :         if (!(tmp-&gt;speex = speex_encoder_init(profile)))</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineCov">       2235 :         speex_bits_init(&amp;tmp-&gt;bits);</span>
<span class="lineNum">     119 </span><span class="lineCov">       2235 :         speex_bits_reset(&amp;tmp-&gt;bits);</span>
<span class="lineNum">     120 </span><span class="lineCov">       2235 :         speex_encoder_ctl(tmp-&gt;speex, SPEEX_GET_FRAME_SIZE, &amp;tmp-&gt;framesize);</span>
<span class="lineNum">     121 </span><span class="lineCov">       2235 :         speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_COMPLEXITY, &amp;complexity);</span>
<span class="lineNum">     122 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     123 </span><span class="lineCov">       2235 :         if (preproc) {</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :                 tmp-&gt;pp = speex_preprocess_state_init(tmp-&gt;framesize, sampling_rate);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_VAD, &amp;pp_vad);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_AGC, &amp;pp_agc);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_AGC_LEVEL, &amp;pp_agc_level);</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_DENOISE, &amp;pp_denoise);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_DEREVERB, &amp;pp_dereverb);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_DEREVERB_DECAY, &amp;pp_dereverb_decay);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                 speex_preprocess_ctl(tmp-&gt;pp, SPEEX_PREPROCESS_SET_DEREVERB_LEVEL, &amp;pp_dereverb_level);</span>
<span class="lineNum">     132 </span>            :         }
<span class="lineNum">     133 </span>            : #endif
<span class="lineNum">     134 </span><span class="lineCov">       2235 :         if (!abr &amp;&amp; !vbr) {</span>
<span class="lineNum">     135 </span><span class="lineCov">          6 :                 speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_QUALITY, &amp;quality);</span>
<span class="lineNum">     136 </span><span class="lineCov">          6 :                 if (vad)</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :                         speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_VAD, &amp;vad);</span>
<span class="lineNum">     138 </span>            :         }
<span class="lineNum">     139 </span><span class="lineCov">       2235 :         if (vbr) {</span>
<span class="lineNum">     140 </span><span class="lineCov">       2229 :                 speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_VBR, &amp;vbr);</span>
<span class="lineNum">     141 </span><span class="lineCov">       2229 :                 speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_VBR_QUALITY, &amp;vbr_quality);</span>
<span class="lineNum">     142 </span>            :         }
<span class="lineNum">     143 </span><span class="lineCov">       2235 :         if (abr)</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :                 speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_ABR, &amp;abr);</span>
<span class="lineNum">     145 </span><span class="lineCov">       2235 :         if (dtx)</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :                 speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_DTX, &amp;dtx);</span>
<span class="lineNum">     147 </span><span class="lineCov">       2235 :         tmp-&gt;silent_state = 0;</span>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineCov">       2235 :         tmp-&gt;fraction_lost = 0;</span>
<span class="lineNum">     150 </span><span class="lineCov">       2235 :         tmp-&gt;default_quality = vbr ? vbr_quality : quality;</span>
<span class="lineNum">     151 </span><span class="lineCov">       2235 :         tmp-&gt;quality = tmp-&gt;default_quality;</span>
<span class="lineNum">     152 </span><span class="lineCov">       2235 :         ast_debug(3, &quot;Default quality (%s): %d\n&quot;, vbr ? &quot;vbr&quot; : &quot;cbr&quot;, tmp-&gt;default_quality);</span>
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span><span class="lineCov">       2235 :         return 0;</span>
<a name="155"><span class="lineNum">     155 </span>            : }</a>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">       1118 : static int lintospeex_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     158 </span>            : {
<span class="lineNum">     159 </span><span class="lineCov">       1118 :         return speex_encoder_construct(pvt, &amp;speex_nb_mode, 8000);</span>
<a name="160"><span class="lineNum">     160 </span>            : }</a>
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineCov">       1117 : static int lin16tospeexwb_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     163 </span>            : {
<span class="lineNum">     164 </span><span class="lineCov">       1117 :         return speex_encoder_construct(pvt, &amp;speex_wb_mode, 16000);</span>
<a name="165"><span class="lineNum">     165 </span>            : }</a>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineNoCov">          0 : static int lin32tospeexuwb_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     168 </span>            : {
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :         return speex_encoder_construct(pvt, &amp;speex_uwb_mode, 32000);</span>
<a name="170"><span class="lineNum">     170 </span>            : }</a>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineCov">       2235 : static int speex_decoder_construct(struct ast_trans_pvt *pvt, const SpeexMode *profile)</span>
<span class="lineNum">     173 </span>            : {
<span class="lineNum">     174 </span><span class="lineCov">       2235 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineCov">       2235 :         if (!(tmp-&gt;speex = speex_decoder_init(profile)))</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">       2235 :         speex_bits_init(&amp;tmp-&gt;bits);</span>
<span class="lineNum">     180 </span><span class="lineCov">       2235 :         speex_decoder_ctl(tmp-&gt;speex, SPEEX_GET_FRAME_SIZE, &amp;tmp-&gt;framesize);</span>
<span class="lineNum">     181 </span><span class="lineCov">       2235 :         if (enhancement)</span>
<span class="lineNum">     182 </span><span class="lineCov">       2229 :                 speex_decoder_ctl(tmp-&gt;speex, SPEEX_SET_ENH, &amp;enhancement);</span>
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span><span class="lineCov">       2235 :         return 0;</span>
<a name="185"><span class="lineNum">     185 </span>            : }</a>
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span><span class="lineCov">       1118 : static int speextolin_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     188 </span>            : {
<span class="lineNum">     189 </span><span class="lineCov">       1118 :         return speex_decoder_construct(pvt, &amp;speex_nb_mode);</span>
<a name="190"><span class="lineNum">     190 </span>            : }</a>
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineCov">       1117 : static int speexwbtolin16_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     193 </span>            : {
<span class="lineNum">     194 </span><span class="lineCov">       1117 :         return speex_decoder_construct(pvt, &amp;speex_wb_mode);</span>
<a name="195"><span class="lineNum">     195 </span>            : }</a>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineNoCov">          0 : static int speexuwbtolin32_new(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     198 </span>            : {
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         return speex_decoder_construct(pvt, &amp;speex_uwb_mode);</span>
<span class="lineNum">     200 </span>            : }
<a name="201"><span class="lineNum">     201 </span>            : </a>
<span class="lineNum">     202 </span>            : /*! \brief convert and store into outbuf */
<span class="lineNum">     203 </span><span class="lineCov">     111700 : static int speextolin_framein(struct ast_trans_pvt *pvt, struct ast_frame *f)</span>
<span class="lineNum">     204 </span>            : {
<span class="lineNum">     205 </span><span class="lineCov">     111700 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            :         /* Assuming there's space left, decode into the current buffer at
<span class="lineNum">     208 </span>            :            the tail location.  Read in as many frames as there are */
<span class="lineNum">     209 </span>            :         int x;
<span class="lineNum">     210 </span>            :         int res;
<span class="lineNum">     211 </span><span class="lineCov">     111700 :         int16_t *dst = pvt-&gt;outbuf.i16;</span>
<span class="lineNum">     212 </span>            :         /* XXX fout is a temporary buffer, may have different types */
<span class="lineNum">     213 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     214 </span>            :         spx_int16_t fout[1024];
<span class="lineNum">     215 </span>            : #else
<span class="lineNum">     216 </span>            :         float fout[1024];
<span class="lineNum">     217 </span>            : #endif
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineCov">     111700 :         if (f-&gt;datalen == 0) {  /* Native PLC interpolation */</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 if (pvt-&gt;samples + tmp-&gt;framesize &gt; BUFFER_SAMPLES) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Out of buffer space\n&quot;);</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">     223 </span>            :                 }
<span class="lineNum">     224 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                 speex_decode_int(tmp-&gt;speex, NULL, dst + pvt-&gt;samples);</span>
<span class="lineNum">     226 </span>            : #else
<span class="lineNum">     227 </span>            :                 speex_decode(tmp-&gt;speex, NULL, fout);
<span class="lineNum">     228 </span>            :                 for (x=0;x&lt;tmp-&gt;framesize;x++) {
<span class="lineNum">     229 </span>            :                         dst[pvt-&gt;samples + x] = (int16_t)fout[x];
<span class="lineNum">     230 </span>            :                 }
<span class="lineNum">     231 </span>            : #endif
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                 pvt-&gt;samples += tmp-&gt;framesize;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                 pvt-&gt;datalen += 2 * tmp-&gt;framesize; /* 2 bytes/sample */</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     235 </span>            :         }
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span>            :         /* Read in bits */
<span class="lineNum">     238 </span><span class="lineCov">     111700 :         speex_bits_read_from(&amp;tmp-&gt;bits, f-&gt;data.ptr, f-&gt;datalen);</span>
<span class="lineNum">     239 </span>            :         for (;;) {
<span class="lineNum">     240 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     241 </span><span class="lineCov">     223400 :                 res = speex_decode_int(tmp-&gt;speex, &amp;tmp-&gt;bits, fout);</span>
<span class="lineNum">     242 </span>            : #else
<span class="lineNum">     243 </span>            :                 res = speex_decode(tmp-&gt;speex, &amp;tmp-&gt;bits, fout);
<span class="lineNum">     244 </span>            : #endif
<span class="lineNum">     245 </span><span class="lineCov">     223400 :                 if (res &lt; 0)</span>
<span class="lineNum">     246 </span><span class="lineCov">     111700 :                         break;</span>
<span class="lineNum">     247 </span><span class="lineCov">     111700 :                 if (pvt-&gt;samples + tmp-&gt;framesize &gt; BUFFER_SAMPLES) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                         ast_log(LOG_WARNING, &quot;Out of buffer space\n&quot;);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">     250 </span>            :                 }
<span class="lineNum">     251 </span><span class="lineCov">   26919700 :                 for (x = 0 ; x &lt; tmp-&gt;framesize; x++)</span>
<span class="lineNum">     252 </span><span class="lineCov">   26808000 :                         dst[pvt-&gt;samples + x] = (int16_t)fout[x];</span>
<span class="lineNum">     253 </span><span class="lineCov">     111700 :                 pvt-&gt;samples += tmp-&gt;framesize;</span>
<span class="lineNum">     254 </span><span class="lineCov">     111700 :                 pvt-&gt;datalen += 2 * tmp-&gt;framesize; /* 2 bytes/sample */</span>
<span class="lineNum">     255 </span>            :         }
<span class="lineNum">     256 </span><span class="lineCov">     111700 :         return 0;</span>
<span class="lineNum">     257 </span>            : }
<a name="258"><span class="lineNum">     258 </span>            : </a>
<span class="lineNum">     259 </span>            : /*! \brief store input frame in work buffer */
<span class="lineNum">     260 </span><span class="lineCov">     223400 : static int lintospeex_framein(struct ast_trans_pvt *pvt, struct ast_frame *f)</span>
<span class="lineNum">     261 </span>            : {
<span class="lineNum">     262 </span><span class="lineCov">     223400 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span>            :         /* XXX We should look at how old the rest of our stream is, and if it
<span class="lineNum">     265 </span>            :            is too old, then we should overwrite it entirely, otherwise we can
<span class="lineNum">     266 </span>            :            get artifacts of earlier talk that do not belong */
<span class="lineNum">     267 </span><span class="lineCov">     223400 :         memcpy(tmp-&gt;buf + pvt-&gt;samples, f-&gt;data.ptr, f-&gt;datalen);</span>
<span class="lineNum">     268 </span><span class="lineCov">     223400 :         pvt-&gt;samples += f-&gt;samples;</span>
<span class="lineNum">     269 </span><span class="lineCov">     223400 :         return 0;</span>
<span class="lineNum">     270 </span>            : }
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : /*! \brief convert work buffer and produce output frame */
<span class="lineNum">     273 </span><span class="lineCov">     335100 : static struct ast_frame *lintospeex_frameout(struct ast_trans_pvt *pvt)</span>
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span><span class="lineCov">     335100 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     276 </span><span class="lineCov">     335100 :         struct ast_frame *result = NULL;</span>
<span class="lineNum">     277 </span><span class="lineCov">     335100 :         struct ast_frame *last = NULL;</span>
<span class="lineNum">     278 </span><span class="lineCov">     335100 :         int samples = 0; /* output samples */</span>
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span><span class="lineCov">     446800 :         while (pvt-&gt;samples &gt;= tmp-&gt;framesize) {</span>
<span class="lineNum">     281 </span>            :                 struct ast_frame *current;
<span class="lineNum">     282 </span><span class="lineCov">     111700 :                 int is_speech = 1;</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineCov">     111700 :                 speex_bits_reset(&amp;tmp-&gt;bits);</span>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     287 </span>            :                 /* Preprocess audio */
<span class="lineNum">     288 </span><span class="lineCov">     111700 :                 if (preproc)</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :                         is_speech = speex_preprocess(tmp-&gt;pp, tmp-&gt;buf + samples, NULL);</span>
<span class="lineNum">     290 </span>            :                 /* Encode a frame of data */
<span class="lineNum">     291 </span><span class="lineCov">     111700 :                 if (is_speech) {</span>
<span class="lineNum">     292 </span>            :                         /* If DTX enabled speex_encode returns 0 during silence */
<span class="lineNum">     293 </span><span class="lineCov">     111700 :                         is_speech = speex_encode_int(tmp-&gt;speex, tmp-&gt;buf + samples, &amp;tmp-&gt;bits) || !dtx;</span>
<span class="lineNum">     294 </span>            :                 } else {
<span class="lineNum">     295 </span>            :                         /* 5 zeros interpreted by Speex as silence (submode 0) */
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                         speex_bits_pack(&amp;tmp-&gt;bits, 0, 5);</span>
<span class="lineNum">     297 </span>            :                 }
<span class="lineNum">     298 </span>            : #else
<span class="lineNum">     299 </span>            :                 {
<span class="lineNum">     300 </span>            :                         float fbuf[1024];
<span class="lineNum">     301 </span>            :                         int x;
<span class="lineNum">     302 </span>            :                         /* Convert to floating point */
<span class="lineNum">     303 </span>            :                         for (x = 0; x &lt; tmp-&gt;framesize; x++)
<span class="lineNum">     304 </span>            :                                 fbuf[x] = tmp-&gt;buf[samples + x];
<span class="lineNum">     305 </span>            :                         /* Encode a frame of data */
<span class="lineNum">     306 </span>            :                         is_speech = speex_encode(tmp-&gt;speex, fbuf, &amp;tmp-&gt;bits) || !dtx;
<span class="lineNum">     307 </span>            :                 }
<span class="lineNum">     308 </span>            : #endif
<span class="lineNum">     309 </span><span class="lineCov">     111700 :                 samples += tmp-&gt;framesize;</span>
<span class="lineNum">     310 </span><span class="lineCov">     111700 :                 pvt-&gt;samples -= tmp-&gt;framesize;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :                 /* Use AST_FRAME_CNG to signify the start of any silence period */
<span class="lineNum">     313 </span><span class="lineCov">     111700 :                 if (is_speech) {</span>
<span class="lineNum">     314 </span><span class="lineCov">     111700 :                         int datalen = 0; /* output bytes */</span>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineCov">     111700 :                         tmp-&gt;silent_state = 0;</span>
<span class="lineNum">     317 </span>            :                         /* Terminate bit stream */
<span class="lineNum">     318 </span><span class="lineCov">     111700 :                         speex_bits_pack(&amp;tmp-&gt;bits, 15, 5);</span>
<span class="lineNum">     319 </span><span class="lineCov">     111700 :                         datalen = speex_bits_write(&amp;tmp-&gt;bits, pvt-&gt;outbuf.c, pvt-&gt;t-&gt;buf_size);</span>
<span class="lineNum">     320 </span><span class="lineCov">     111700 :                         current = ast_trans_frameout(pvt, datalen, tmp-&gt;framesize);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :                 } else if (tmp-&gt;silent_state) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                         current = NULL;</span>
<span class="lineNum">     323 </span>            :                 } else {
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                         struct ast_frame frm = {</span>
<span class="lineNum">     325 </span>            :                                 .frametype = AST_FRAME_CNG,
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :                                 .src = pvt-&gt;t-&gt;name,</span>
<span class="lineNum">     327 </span>            :                         };
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :                         /*
<span class="lineNum">     330 </span>            :                          * XXX I don't think the AST_FRAME_CNG code has ever
<span class="lineNum">     331 </span>            :                          * really worked for speex.  There doesn't seem to be
<span class="lineNum">     332 </span>            :                          * any consumers of the frame type.  Everyone that
<span class="lineNum">     333 </span>            :                          * references the type seems to pass the frame on.
<span class="lineNum">     334 </span>            :                          */
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                         tmp-&gt;silent_state = 1;</span>
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span>            :                         /* XXX what now ? format etc... */
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                         current = ast_frisolate(&amp;frm);</span>
<span class="lineNum">     339 </span>            :                 }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineCov">     111700 :                 if (!current) {</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     343 </span><span class="lineCov">     111700 :                 } else if (last) {</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                         AST_LIST_NEXT(last, frame_list) = current;</span>
<span class="lineNum">     345 </span>            :                 } else {
<span class="lineNum">     346 </span><span class="lineCov">     111700 :                         result = current;</span>
<span class="lineNum">     347 </span>            :                 }
<span class="lineNum">     348 </span><span class="lineCov">     111700 :                 last = current;</span>
<span class="lineNum">     349 </span>            :         }
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span>            :         /* Move the data at the end of the buffer to the front */
<span class="lineNum">     352 </span><span class="lineCov">     335100 :         if (samples) {</span>
<span class="lineNum">     353 </span><span class="lineCov">     111700 :                 memmove(tmp-&gt;buf, tmp-&gt;buf + samples, pvt-&gt;samples * 2);</span>
<span class="lineNum">     354 </span>            :         }
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">     335100 :         return result;</span>
<span class="lineNum">     357 </span>            : }
<a name="358"><span class="lineNum">     358 </span>            : </a>
<span class="lineNum">     359 </span>            : /*! \brief handle incoming RTCP feedback and possibly edit encoder settings */
<span class="lineNum">     360 </span><span class="lineNoCov">          0 : static void lintospeex_feedback(struct ast_trans_pvt *pvt, struct ast_frame *feedback)</span>
<span class="lineNum">     361 </span>            : {
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :         struct speex_coder_pvt *tmp = pvt-&gt;pvt;</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span>            :         struct ast_rtp_rtcp_report *rtcp_report;
<span class="lineNum">     365 </span>            :         struct ast_rtp_rtcp_report_block *report_block;
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span>            :         int fraction_lost;
<span class="lineNum">     368 </span>            :         int percent;
<span class="lineNum">     369 </span>            :         int bitrate;
<span class="lineNum">     370 </span>            :         int q;
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         if(!exp_rtcp_fb)</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            :         /* We only accept feedback information in the form of SR and RR reports */
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         if (feedback-&gt;subclass.integer != AST_RTP_RTCP_SR &amp;&amp; feedback-&gt;subclass.integer != AST_RTP_RTCP_RR) {</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     378 </span>            :         }
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :         rtcp_report = (struct ast_rtp_rtcp_report *)feedback-&gt;data.ptr;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :         if (rtcp_report-&gt;reception_report_count == 0)</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         report_block = rtcp_report-&gt;report_block[0];</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :         fraction_lost = report_block-&gt;lost_count.fraction;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :         if (fraction_lost == tmp-&gt;fraction_lost)</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     387 </span>            :         /* Per RFC3550, fraction lost is defined to be the number of packets lost
<span class="lineNum">     388 </span>            :          * divided by the number of packets expected. Since it's a 8-bit value,
<span class="lineNum">     389 </span>            :          * and we want a percentage value, we multiply by 100 and divide by 256. */
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         percent = (fraction_lost*100)/256;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         bitrate = 0;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         q = -1;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :         ast_debug(3, &quot;Fraction lost changed: %d --&gt; %d percent loss\n&quot;, fraction_lost, percent);</span>
<span class="lineNum">     394 </span>            :         /* Handle change */
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         speex_encoder_ctl(tmp-&gt;speex, SPEEX_GET_BITRATE, &amp;bitrate);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         ast_debug(3, &quot;Current bitrate: %d\n&quot;, bitrate);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         ast_debug(3, &quot;Current quality: %d/%d\n&quot;, tmp-&gt;quality, tmp-&gt;default_quality);</span>
<span class="lineNum">     398 </span>            :         /* FIXME BADLY Very ugly example of how this could be handled: probably sucks */
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         if (percent &lt; 10) {</span>
<span class="lineNum">     400 </span>            :                 /* Not that bad, default quality is fine */
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                 q = tmp-&gt;default_quality;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         } else if (percent &lt; 20) {</span>
<span class="lineNum">     403 </span>            :                 /* Quite bad, let's go down a bit */
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                 q = tmp-&gt;default_quality-1;</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         } else if (percent &lt; 30) {</span>
<span class="lineNum">     406 </span>            :                 /* Very bad, let's go down even more */
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 q = tmp-&gt;default_quality-2;</span>
<span class="lineNum">     408 </span>            :         } else {
<span class="lineNum">     409 </span>            :                 /* Really bad, use the lowest quality possible */
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                 q = 0;</span>
<span class="lineNum">     411 </span>            :         }
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :         if (q &lt; 0)</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                 q = 0;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :         if (q != tmp-&gt;quality) {</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                 ast_debug(3, &quot;  -- Setting to %d\n&quot;, q);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 if (vbr) {</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                         float vbr_q = q;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                         speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_VBR_QUALITY, &amp;vbr_q);</span>
<span class="lineNum">     419 </span>            :                 } else {
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                         speex_encoder_ctl(tmp-&gt;speex, SPEEX_SET_QUALITY, &amp;q);</span>
<span class="lineNum">     421 </span>            :                 }
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                 tmp-&gt;quality = q;</span>
<span class="lineNum">     423 </span>            :         }
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         tmp-&gt;fraction_lost = fraction_lost;</span>
<a name="425"><span class="lineNum">     425 </span>            : }</a>
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span><span class="lineCov">       2235 : static void speextolin_destroy(struct ast_trans_pvt *arg)</span>
<span class="lineNum">     428 </span>            : {
<span class="lineNum">     429 </span><span class="lineCov">       2235 :         struct speex_coder_pvt *pvt = arg-&gt;pvt;</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">       2235 :         speex_decoder_destroy(pvt-&gt;speex);</span>
<span class="lineNum">     432 </span><span class="lineCov">       2235 :         speex_bits_destroy(&amp;pvt-&gt;bits);</span>
<a name="433"><span class="lineNum">     433 </span><span class="lineCov">       2235 : }</span></a>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineCov">       2235 : static void lintospeex_destroy(struct ast_trans_pvt *arg)</span>
<span class="lineNum">     436 </span>            : {
<span class="lineNum">     437 </span><span class="lineCov">       2235 :         struct speex_coder_pvt *pvt = arg-&gt;pvt;</span>
<span class="lineNum">     438 </span>            : #ifdef _SPEEX_TYPES_H
<span class="lineNum">     439 </span><span class="lineCov">       2235 :         if (preproc)</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                 speex_preprocess_state_destroy(pvt-&gt;pp);</span>
<span class="lineNum">     441 </span>            : #endif
<span class="lineNum">     442 </span><span class="lineCov">       2235 :         speex_encoder_destroy(pvt-&gt;speex);</span>
<span class="lineNum">     443 </span><span class="lineCov">       2235 :         speex_bits_destroy(&amp;pvt-&gt;bits);</span>
<span class="lineNum">     444 </span><span class="lineCov">       2235 : }</span>
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            : static struct ast_translator speextolin = {
<span class="lineNum">     447 </span>            :         .name = &quot;speextolin&quot;,
<span class="lineNum">     448 </span>            :         .src_codec = {
<span class="lineNum">     449 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     450 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     451 </span>            :                 .sample_rate = 8000,
<span class="lineNum">     452 </span>            :         },
<span class="lineNum">     453 </span>            :         .dst_codec = {
<span class="lineNum">     454 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     455 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     456 </span>            :                 .sample_rate = 8000,
<span class="lineNum">     457 </span>            :         },
<span class="lineNum">     458 </span>            :         .format = &quot;slin&quot;,
<span class="lineNum">     459 </span>            :         .newpvt = speextolin_new,
<span class="lineNum">     460 </span>            :         .framein = speextolin_framein,
<span class="lineNum">     461 </span>            :         .destroy = speextolin_destroy,
<span class="lineNum">     462 </span>            :         .sample = speex_sample,
<span class="lineNum">     463 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     464 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     465 </span>            :         .buf_size = BUFFER_SAMPLES * 2,
<span class="lineNum">     466 </span>            :         .native_plc = 1,
<span class="lineNum">     467 </span>            : };
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span>            : static struct ast_translator lintospeex = {
<span class="lineNum">     470 </span>            :         .name = &quot;lintospeex&quot;,
<span class="lineNum">     471 </span>            :         .src_codec = {
<span class="lineNum">     472 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     473 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     474 </span>            :                 .sample_rate = 8000,
<span class="lineNum">     475 </span>            :         },
<span class="lineNum">     476 </span>            :         .dst_codec = {
<span class="lineNum">     477 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     478 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     479 </span>            :                 .sample_rate = 8000,
<span class="lineNum">     480 </span>            :         },
<span class="lineNum">     481 </span>            :         .format = &quot;speex&quot;,
<span class="lineNum">     482 </span>            :         .newpvt = lintospeex_new,
<span class="lineNum">     483 </span>            :         .framein = lintospeex_framein,
<span class="lineNum">     484 </span>            :         .frameout = lintospeex_frameout,
<span class="lineNum">     485 </span>            :         .feedback = lintospeex_feedback,
<span class="lineNum">     486 </span>            :         .destroy = lintospeex_destroy,
<span class="lineNum">     487 </span>            :         .sample = slin8_sample,
<span class="lineNum">     488 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     489 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     490 </span>            :         .buf_size = BUFFER_SAMPLES * 2, /* XXX maybe a lot less ? */
<span class="lineNum">     491 </span>            : };
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            : static struct ast_translator speexwbtolin16 = {
<span class="lineNum">     494 </span>            :         .name = &quot;speexwbtolin16&quot;,
<span class="lineNum">     495 </span>            :         .src_codec = {
<span class="lineNum">     496 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     497 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     498 </span>            :                 .sample_rate = 16000,
<span class="lineNum">     499 </span>            :         },
<span class="lineNum">     500 </span>            :         .dst_codec = {
<span class="lineNum">     501 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     502 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     503 </span>            :                 .sample_rate = 16000,
<span class="lineNum">     504 </span>            :         },
<span class="lineNum">     505 </span>            :         .format = &quot;slin16&quot;,
<span class="lineNum">     506 </span>            :         .newpvt = speexwbtolin16_new,
<span class="lineNum">     507 </span>            :         .framein = speextolin_framein,
<span class="lineNum">     508 </span>            :         .destroy = speextolin_destroy,
<span class="lineNum">     509 </span>            :         .sample = speex16_sample,
<span class="lineNum">     510 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     511 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     512 </span>            :         .buf_size = BUFFER_SAMPLES * 2,
<span class="lineNum">     513 </span>            :         .native_plc = 1,
<span class="lineNum">     514 </span>            : };
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span>            : static struct ast_translator lin16tospeexwb = {
<span class="lineNum">     517 </span>            :         .name = &quot;lin16tospeexwb&quot;,
<span class="lineNum">     518 </span>            :         .src_codec = {
<span class="lineNum">     519 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     520 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     521 </span>            :                 .sample_rate = 16000,
<span class="lineNum">     522 </span>            :         },
<span class="lineNum">     523 </span>            :         .dst_codec = {
<span class="lineNum">     524 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     525 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     526 </span>            :                 .sample_rate = 16000,
<span class="lineNum">     527 </span>            :         },
<span class="lineNum">     528 </span>            :         .format = &quot;speex16&quot;,
<span class="lineNum">     529 </span>            :         .newpvt = lin16tospeexwb_new,
<span class="lineNum">     530 </span>            :         .framein = lintospeex_framein,
<span class="lineNum">     531 </span>            :         .frameout = lintospeex_frameout,
<span class="lineNum">     532 </span>            :         .feedback = lintospeex_feedback,
<span class="lineNum">     533 </span>            :         .destroy = lintospeex_destroy,
<span class="lineNum">     534 </span>            :         .sample = slin16_sample,
<span class="lineNum">     535 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     536 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     537 </span>            :         .buf_size = BUFFER_SAMPLES * 2, /* XXX maybe a lot less ? */
<span class="lineNum">     538 </span>            : };
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            : static struct ast_translator speexuwbtolin32 = {
<span class="lineNum">     541 </span>            :         .name = &quot;speexuwbtolin32&quot;,
<span class="lineNum">     542 </span>            :         .src_codec = {
<span class="lineNum">     543 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     544 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     545 </span>            :                 .sample_rate = 32000,
<span class="lineNum">     546 </span>            :         },
<span class="lineNum">     547 </span>            :         .dst_codec = {
<span class="lineNum">     548 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     549 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     550 </span>            :                 .sample_rate = 32000,
<span class="lineNum">     551 </span>            :         },
<span class="lineNum">     552 </span>            :         .format = &quot;slin32&quot;,
<span class="lineNum">     553 </span>            :         .newpvt = speexuwbtolin32_new,
<span class="lineNum">     554 </span>            :         .framein = speextolin_framein,
<span class="lineNum">     555 </span>            :         .destroy = speextolin_destroy,
<span class="lineNum">     556 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     557 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     558 </span>            :         .buf_size = BUFFER_SAMPLES * 2,
<span class="lineNum">     559 </span>            :         .native_plc = 1,
<span class="lineNum">     560 </span>            : };
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span>            : static struct ast_translator lin32tospeexuwb = {
<span class="lineNum">     563 </span>            :         .name = &quot;lin32tospeexuwb&quot;,
<span class="lineNum">     564 </span>            :         .src_codec = {
<span class="lineNum">     565 </span>            :                 .name = &quot;slin&quot;,
<span class="lineNum">     566 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     567 </span>            :                 .sample_rate = 32000,
<span class="lineNum">     568 </span>            :         },
<span class="lineNum">     569 </span>            :         .dst_codec = {
<span class="lineNum">     570 </span>            :                 .name = &quot;speex&quot;,
<span class="lineNum">     571 </span>            :                 .type = AST_MEDIA_TYPE_AUDIO,
<span class="lineNum">     572 </span>            :                 .sample_rate = 32000,
<span class="lineNum">     573 </span>            :         },
<span class="lineNum">     574 </span>            :         .format = &quot;speex32&quot;,
<span class="lineNum">     575 </span>            :         .newpvt = lin32tospeexuwb_new,
<span class="lineNum">     576 </span>            :         .framein = lintospeex_framein,
<span class="lineNum">     577 </span>            :         .frameout = lintospeex_frameout,
<span class="lineNum">     578 </span>            :         .feedback = lintospeex_feedback,
<span class="lineNum">     579 </span>            :         .destroy = lintospeex_destroy,
<span class="lineNum">     580 </span>            :         .desc_size = sizeof(struct speex_coder_pvt),
<span class="lineNum">     581 </span>            :         .buffer_samples = BUFFER_SAMPLES,
<span class="lineNum">     582 </span>            :         .buf_size = BUFFER_SAMPLES * 2, /* XXX maybe a lot less ? */
<a name="583"><span class="lineNum">     583 </span>            : };</a>
<span class="lineNum">     584 </span>            : 
<span class="lineNum">     585 </span><span class="lineCov">       1117 : static int parse_config(int reload)</span>
<span class="lineNum">     586 </span>            : {
<span class="lineNum">     587 </span><span class="lineCov">       1117 :         struct ast_flags config_flags = { reload ? CONFIG_FLAG_FILEUNCHANGED : 0 };</span>
<span class="lineNum">     588 </span><span class="lineCov">       1117 :         struct ast_config *cfg = ast_config_load(&quot;codecs.conf&quot;, config_flags);</span>
<span class="lineNum">     589 </span>            :         struct ast_variable *var;
<span class="lineNum">     590 </span>            :         int res;
<span class="lineNum">     591 </span>            :         float res_f;
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span><span class="lineCov">       1117 :         if (cfg == CONFIG_STATUS_FILEMISSING || cfg == CONFIG_STATUS_FILEUNCHANGED || cfg == CONFIG_STATUS_FILEINVALID)</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span><span class="lineCov">      20055 :         for (var = ast_variable_browse(cfg, &quot;speex&quot;); var; var = var-&gt;next) {</span>
<span class="lineNum">     597 </span><span class="lineCov">      18938 :                 if (!strcasecmp(var-&gt;name, &quot;quality&quot;)) {</span>
<span class="lineNum">     598 </span><span class="lineCov">       1114 :                         res = abs(atoi(var-&gt;value));</span>
<span class="lineNum">     599 </span><span class="lineCov">       1114 :                         if (res &gt; -1 &amp;&amp; res &lt; 11) {</span>
<span class="lineNum">     600 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting Quality to %d\n&quot;,res);</span>
<span class="lineNum">     601 </span><span class="lineCov">       1114 :                                 quality = res;</span>
<span class="lineNum">     602 </span>            :                         } else
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error Quality must be 0-10\n&quot;);</span>
<span class="lineNum">     604 </span><span class="lineCov">      17824 :                 } else if (!strcasecmp(var-&gt;name, &quot;complexity&quot;)) {</span>
<span class="lineNum">     605 </span><span class="lineCov">       1114 :                         res = abs(atoi(var-&gt;value));</span>
<span class="lineNum">     606 </span><span class="lineCov">       1114 :                         if (res &gt; -1 &amp;&amp; res &lt; 11) {</span>
<span class="lineNum">     607 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting Complexity to %d\n&quot;,res);</span>
<span class="lineNum">     608 </span><span class="lineCov">       1114 :                                 complexity = res;</span>
<span class="lineNum">     609 </span>            :                         } else
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! Complexity must be 0-10\n&quot;);</span>
<span class="lineNum">     611 </span><span class="lineCov">      16710 :                 } else if (!strcasecmp(var-&gt;name, &quot;vbr_quality&quot;)) {</span>
<span class="lineNum">     612 </span><span class="lineCov">       1114 :                         if (sscanf(var-&gt;value, &quot;%30f&quot;, &amp;res_f) == 1 &amp;&amp; res_f &gt;= 0 &amp;&amp; res_f &lt;= 10) {</span>
<span class="lineNum">     613 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting VBR Quality to %f\n&quot;,res_f);</span>
<span class="lineNum">     614 </span><span class="lineCov">       1114 :                                 vbr_quality = res_f;</span>
<span class="lineNum">     615 </span>            :                         } else
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! VBR Quality must be 0-10\n&quot;);</span>
<span class="lineNum">     617 </span><span class="lineCov">      15596 :                 } else if (!strcasecmp(var-&gt;name, &quot;abr_quality&quot;)) {</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                         ast_log(LOG_ERROR,&quot;Error! ABR Quality setting obsolete, set ABR to desired bitrate\n&quot;);</span>
<span class="lineNum">     619 </span><span class="lineCov">      15596 :                 } else if (!strcasecmp(var-&gt;name, &quot;enhancement&quot;)) {</span>
<span class="lineNum">     620 </span><span class="lineCov">       1114 :                         enhancement = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     621 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Perceptual Enhancement Mode. [%s]\n&quot;,enhancement ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     622 </span><span class="lineCov">      14482 :                 } else if (!strcasecmp(var-&gt;name, &quot;vbr&quot;)) {</span>
<span class="lineNum">     623 </span><span class="lineCov">       1114 :                         vbr = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     624 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: VBR Mode. [%s]\n&quot;,vbr ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     625 </span><span class="lineCov">      13368 :                 } else if (!strcasecmp(var-&gt;name, &quot;abr&quot;)) {</span>
<span class="lineNum">     626 </span><span class="lineCov">       1114 :                         res = abs(atoi(var-&gt;value));</span>
<span class="lineNum">     627 </span><span class="lineCov">       1114 :                         if (res &gt;= 0) {</span>
<span class="lineNum">     628 </span><span class="lineCov">       1114 :                                         if (res &gt; 0)</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                                         ast_verb(3, &quot;CODEC SPEEX: Setting ABR target bitrate to %d\n&quot;,res);</span>
<span class="lineNum">     630 </span>            :                                         else
<span class="lineNum">     631 </span><span class="lineCov">       1114 :                                         ast_verb(3, &quot;CODEC SPEEX: Disabling ABR\n&quot;);</span>
<span class="lineNum">     632 </span><span class="lineCov">       1114 :                                 abr = res;</span>
<span class="lineNum">     633 </span>            :                         } else
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! ABR target bitrate must be &gt;= 0\n&quot;);</span>
<span class="lineNum">     635 </span><span class="lineCov">      12254 :                 } else if (!strcasecmp(var-&gt;name, &quot;vad&quot;)) {</span>
<span class="lineNum">     636 </span><span class="lineCov">       1114 :                         vad = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     637 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: VAD Mode. [%s]\n&quot;,vad ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     638 </span><span class="lineCov">      11140 :                 } else if (!strcasecmp(var-&gt;name, &quot;dtx&quot;)) {</span>
<span class="lineNum">     639 </span><span class="lineCov">       1114 :                         dtx = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     640 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: DTX Mode. [%s]\n&quot;,dtx ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     641 </span><span class="lineCov">      10026 :                 } else if (!strcasecmp(var-&gt;name, &quot;preprocess&quot;)) {</span>
<span class="lineNum">     642 </span><span class="lineCov">       1114 :                         preproc = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     643 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Preprocessing. [%s]\n&quot;,preproc ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     644 </span><span class="lineCov">       8912 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_vad&quot;)) {</span>
<span class="lineNum">     645 </span><span class="lineCov">       1114 :                         pp_vad = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     646 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Preprocessor VAD. [%s]\n&quot;,pp_vad ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     647 </span><span class="lineCov">       7798 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_agc&quot;)) {</span>
<span class="lineNum">     648 </span><span class="lineCov">       1114 :                         pp_agc = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     649 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Preprocessor AGC. [%s]\n&quot;,pp_agc ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     650 </span><span class="lineCov">       6684 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_agc_level&quot;)) {</span>
<span class="lineNum">     651 </span><span class="lineCov">       1114 :                         if (sscanf(var-&gt;value, &quot;%30f&quot;, &amp;res_f) == 1 &amp;&amp; res_f &gt;= 0) {</span>
<span class="lineNum">     652 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting preprocessor AGC Level to %f\n&quot;,res_f);</span>
<span class="lineNum">     653 </span><span class="lineCov">       1114 :                                 pp_agc_level = res_f;</span>
<span class="lineNum">     654 </span>            :                         } else
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! Preprocessor AGC Level must be &gt;= 0\n&quot;);</span>
<span class="lineNum">     656 </span><span class="lineCov">       5570 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_denoise&quot;)) {</span>
<span class="lineNum">     657 </span><span class="lineCov">       1114 :                         pp_denoise = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     658 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Preprocessor Denoise. [%s]\n&quot;,pp_denoise ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     659 </span><span class="lineCov">       4456 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_dereverb&quot;)) {</span>
<span class="lineNum">     660 </span><span class="lineCov">       1114 :                         pp_dereverb = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     661 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Preprocessor Dereverb. [%s]\n&quot;,pp_dereverb ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     662 </span><span class="lineCov">       3342 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_dereverb_decay&quot;)) {</span>
<span class="lineNum">     663 </span><span class="lineCov">       1114 :                         if (sscanf(var-&gt;value, &quot;%30f&quot;, &amp;res_f) == 1 &amp;&amp; res_f &gt;= 0) {</span>
<span class="lineNum">     664 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting preprocessor Dereverb Decay to %f\n&quot;,res_f);</span>
<span class="lineNum">     665 </span><span class="lineCov">       1114 :                                 pp_dereverb_decay = res_f;</span>
<span class="lineNum">     666 </span>            :                         } else
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! Preprocessor Dereverb Decay must be &gt;= 0\n&quot;);</span>
<span class="lineNum">     668 </span><span class="lineCov">       2228 :                 } else if (!strcasecmp(var-&gt;name, &quot;pp_dereverb_level&quot;)) {</span>
<span class="lineNum">     669 </span><span class="lineCov">       1114 :                         if (sscanf(var-&gt;value, &quot;%30f&quot;, &amp;res_f) == 1 &amp;&amp; res_f &gt;= 0) {</span>
<span class="lineNum">     670 </span><span class="lineCov">       1114 :                                 ast_verb(3, &quot;CODEC SPEEX: Setting preprocessor Dereverb Level to %f\n&quot;,res_f);</span>
<span class="lineNum">     671 </span><span class="lineCov">       1114 :                                 pp_dereverb_level = res_f;</span>
<span class="lineNum">     672 </span>            :                         } else
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                                 ast_log(LOG_ERROR,&quot;Error! Preprocessor Dereverb Level must be &gt;= 0\n&quot;);</span>
<span class="lineNum">     674 </span><span class="lineCov">       1114 :                 } else if (!strcasecmp(var-&gt;name, &quot;experimental_rtcp_feedback&quot;)) {</span>
<span class="lineNum">     675 </span><span class="lineCov">       1114 :                         exp_rtcp_fb = ast_true(var-&gt;value) ? 1 : 0;</span>
<span class="lineNum">     676 </span><span class="lineCov">       1114 :                         ast_verb(3, &quot;CODEC SPEEX: Experimental RTCP Feedback. [%s]\n&quot;,exp_rtcp_fb ? &quot;on&quot; : &quot;off&quot;);</span>
<span class="lineNum">     677 </span>            :                 }
<span class="lineNum">     678 </span>            :         }
<span class="lineNum">     679 </span><span class="lineCov">       1117 :         ast_config_destroy(cfg);</span>
<span class="lineNum">     680 </span><span class="lineCov">       1117 :         return 0;</span>
<a name="681"><span class="lineNum">     681 </span>            : }</a>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineNoCov">          0 : static int reload(void)</span>
<span class="lineNum">     684 </span>            : {
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :         if (parse_config(1))</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :         return AST_MODULE_LOAD_SUCCESS;</span>
<a name="688"><span class="lineNum">     688 </span>            : }</a>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineCov">       1115 : static int unload_module(void)</span>
<span class="lineNum">     691 </span>            : {
<span class="lineNum">     692 </span><span class="lineCov">       1115 :         int res = 0;</span>
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;speextolin);</span>
<span class="lineNum">     695 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;lintospeex);</span>
<span class="lineNum">     696 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;speexwbtolin16);</span>
<span class="lineNum">     697 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;lin16tospeexwb);</span>
<span class="lineNum">     698 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;speexuwbtolin32);</span>
<span class="lineNum">     699 </span><span class="lineCov">       1115 :         res |= ast_unregister_translator(&amp;lin32tospeexuwb);</span>
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span><span class="lineCov">       1115 :         return res;</span>
<a name="703"><span class="lineNum">     703 </span>            : }</a>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">       1117 : static int load_module(void)</span>
<span class="lineNum">     706 </span>            : {
<span class="lineNum">     707 </span><span class="lineCov">       1117 :         int res = 0;</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineCov">       1117 :         if (parse_config(0))</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                 return AST_MODULE_LOAD_DECLINE;</span>
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;speextolin);</span>
<span class="lineNum">     713 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;lintospeex);</span>
<span class="lineNum">     714 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;speexwbtolin16);</span>
<span class="lineNum">     715 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;lin16tospeexwb);</span>
<span class="lineNum">     716 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;speexuwbtolin32);</span>
<span class="lineNum">     717 </span><span class="lineCov">       1117 :         res |= ast_register_translator(&amp;lin32tospeexuwb);</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineCov">       1117 :         if (res) {</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                 unload_module();</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">     722 </span>            :         }
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineCov">       1117 :         return res;</span>
<a name="725"><span class="lineNum">     725 </span>            : }</a>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineCov">       8936 : AST_MODULE_INFO(ASTERISK_GPL_KEY, AST_MODFLAG_DEFAULT, &quot;Speex Coder/Decoder&quot;,</span>
<span class="lineNum">     728 </span>            :         .support_level = AST_MODULE_SUPPORT_CORE,
<span class="lineNum">     729 </span>            :         .load = load_module,
<span class="lineNum">     730 </span>            :         .unload = unload_module,
<span class="lineNum">     731 </span>            :         .reload = reload,
<span class="lineNum">     732 </span>            : );
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
