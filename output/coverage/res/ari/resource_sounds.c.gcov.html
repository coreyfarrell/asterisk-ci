<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Asterisk GIT-16-9767e98486 - res/ari/resource_sounds.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">res/ari</a> - resource_sounds.c<span style="font-size: 80%;"> (source / <a href="resource_sounds.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Asterisk GIT-16-9767e98486</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">96</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-07-22 22:16:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Asterisk -- An open source telephony toolkit.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Copyright (C) 2012 - 2013, Digium, Inc.
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * David M. Lee, II &lt;dlee@digium.com&gt;
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  * See http://www.asterisk.org for more information about
<span class="lineNum">       9 </span>            :  * the Asterisk project. Please do not directly contact
<span class="lineNum">      10 </span>            :  * any of the maintainers of this project for assistance;
<span class="lineNum">      11 </span>            :  * the project provides a web site, mailing lists and IRC
<span class="lineNum">      12 </span>            :  * channels for your use.
<span class="lineNum">      13 </span>            :  *
<span class="lineNum">      14 </span>            :  * This program is free software, distributed under the terms of
<span class="lineNum">      15 </span>            :  * the GNU General Public License Version 2. See the LICENSE file
<span class="lineNum">      16 </span>            :  * at the top of the source tree.
<span class="lineNum">      17 </span>            :  */
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : /*! \file
<span class="lineNum">      20 </span>            :  *
<span class="lineNum">      21 </span>            :  * \brief /api-docs/sounds.{format} implementation- Sound resources
<span class="lineNum">      22 </span>            :  *
<span class="lineNum">      23 </span>            :  * \author David M. Lee, II &lt;dlee@digium.com&gt;
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &quot;asterisk.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;resource_sounds.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;asterisk/media_index.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;asterisk/sounds_index.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;asterisk/format.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;asterisk/format_cap.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;asterisk/json.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : /*! \brief arguments that are necessary for adding format/lang pairs */
<span class="lineNum">      36 </span>            : struct lang_format_info {
<span class="lineNum">      37 </span>            :         struct ast_json *format_list;   /*!&lt; The embedded array to which format/lang pairs should be added */
<span class="lineNum">      38 </span>            :         const char *filename;           /*!&lt; Name of the file for which to add format/lang pairs */
<span class="lineNum">      39 </span>            :         const char *format_filter;      /*!&lt; Format filter provided in the request */
<span class="lineNum">      40 </span>            : };
<a name="41"><span class="lineNum">      41 </span>            : </a>
<span class="lineNum">      42 </span>            : /*! \brief Add format/lang pairs to the array embedded in the sound object */
<span class="lineNum">      43 </span><span class="lineNoCov">          0 : static int add_format_information_cb(void *obj, void *arg, int flags)</span>
<span class="lineNum">      44 </span>            : {
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :         char *language = obj;</span>
<a name="46"><span class="lineNum">      46 </span><span class="lineNoCov">          0 :         struct lang_format_info *args = arg;</span></a>
<a name="47"><span class="lineNum">      47 </span>            :         int idx;</a>
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ast_format_cap *, cap, NULL, ao2_cleanup);</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ast_media_index *, sounds_index, ast_sounds_get_index(), ao2_cleanup);</span>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :         if (!sounds_index) {</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :                 return CMP_STOP;</span>
<span class="lineNum">      53 </span>            :         }
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :         cap = ast_media_get_format_cap(sounds_index, args-&gt;filename, language);</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :         if (!cap) {</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :                 return CMP_STOP;</span>
<span class="lineNum">      58 </span>            :         }
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :         for (idx = 0; idx &lt; ast_format_cap_count(cap); idx++) {</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :                 struct ast_format *format = ast_format_cap_get_format(cap, idx);</span>
<span class="lineNum">      62 </span>            :                 struct ast_json *lang_format_pair;
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :                 if (!ast_strlen_zero(args-&gt;format_filter)</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :                         &amp;&amp; strcmp(args-&gt;format_filter, ast_format_get_name(format))) {</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :                         ao2_ref(format, -1);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">      68 </span>            :                 }
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :                 lang_format_pair = ast_json_pack(&quot;{s: s, s: s}&quot;,</span>
<span class="lineNum">      71 </span>            :                         &quot;language&quot;, language,
<span class="lineNum">      72 </span>            :                         &quot;format&quot;, ast_format_get_name(format));
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :                 if (!lang_format_pair) {</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :                         ao2_ref(format, -1);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :                         return CMP_STOP;</span>
<span class="lineNum">      76 </span>            :                 }
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :                 ast_json_array_append(args-&gt;format_list, lang_format_pair);</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :                 ao2_ref(format, -1);</span>
<span class="lineNum">      80 </span>            :         }
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">      83 </span>            : }
<a name="84"><span class="lineNum">      84 </span>            : </a>
<span class="lineNum">      85 </span>            : /*! \brief Filter out all languages not matching the specified language */
<span class="lineNum">      86 </span><span class="lineNoCov">          0 : static int filter_langs_cb(void *obj, void *arg, int flags)</span>
<span class="lineNum">      87 </span>            : {
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :         char *lang_filter = arg;</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :         char *lang = obj;</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :         if (strcmp(lang, lang_filter)) {</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :                 return CMP_MATCH;</span>
<span class="lineNum">      92 </span>            :         }
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">      94 </span>            : }
<a name="95"><span class="lineNum">      95 </span>            : </a>
<span class="lineNum">      96 </span>            : /*! \brief Generate a Sound structure as documented in sounds.json for the specified filename */
<span class="lineNum">      97 </span><span class="lineNoCov">          0 : static struct ast_json *create_sound_blob(const char *filename,</span>
<a name="98"><span class="lineNum">      98 </span>            :         struct ast_ari_sounds_list_args *args)</a>
<a name="99"><span class="lineNum">      99 </span>            : {</a>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ast_json *, sound, NULL, ast_json_unref);</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ao2_container *, languages, NULL, ao2_cleanup);</span>
<span class="lineNum">     102 </span>            :         const char *description;
<a name="103"><span class="lineNum">     103 </span>            :         struct ast_json *format_lang_list;</a>
<span class="lineNum">     104 </span>            :         struct lang_format_info info;
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ast_media_index *, sounds_index, ast_sounds_get_index(), ao2_cleanup);</span>
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :         if (!sounds_index) {</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     109 </span>            :         }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :         description = ast_media_get_description(sounds_index, filename, &quot;en&quot;);</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :         if (ast_strlen_zero(description)) {</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :                 sound = ast_json_pack(&quot;{s: s, s: []}&quot;,</span>
<span class="lineNum">     114 </span>            :                         &quot;id&quot;, filename,
<span class="lineNum">     115 </span>            :                         &quot;formats&quot;);
<span class="lineNum">     116 </span>            :         } else {
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                 sound = ast_json_pack(&quot;{s: s, s: s, s: []}&quot;,</span>
<span class="lineNum">     118 </span>            :                         &quot;id&quot;, filename,
<span class="lineNum">     119 </span>            :                         &quot;text&quot;, description,
<span class="lineNum">     120 </span>            :                         &quot;formats&quot;);
<span class="lineNum">     121 </span>            :         }
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :         if (!sound) {</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     124 </span>            :         }
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :         format_lang_list = ast_json_object_get(sound, &quot;formats&quot;);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         if (!format_lang_list) {</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     129 </span>            :         }
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :         languages = ast_media_get_variants(sounds_index, filename);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         if (!languages || !ao2_container_count(languages)) {</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     134 </span>            :         }
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            :         /* filter requested languages */
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         if (args &amp;&amp; !ast_strlen_zero(args-&gt;lang)) {</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                 char *lang_filter = ast_strdupa(args-&gt;lang);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                 ao2_callback(languages, OBJ_NODATA | OBJ_MULTIPLE | OBJ_UNLINK, filter_langs_cb, lang_filter);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                 if (!languages || !ao2_container_count(languages)) {</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">     142 </span>            :                 }
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         info.filename = filename;</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :         info.format_list = format_lang_list;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :         info.format_filter = NULL;</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         if (args) {</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                 info.format_filter = args-&gt;format;</span>
<span class="lineNum">     150 </span>            :         }
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :         ao2_callback(languages, OBJ_NODATA, add_format_information_cb, &amp;info);</span>
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span>            :         /* no format/lang pairs for this sound so nothing to return */
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         if (!ast_json_array_size(format_lang_list)) {</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     156 </span>            :         }
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         return ast_json_ref(sound);</span>
<span class="lineNum">     159 </span>            : }
<a name="160"><span class="lineNum">     160 </span>            : </a>
<span class="lineNum">     161 </span>            : /*! \brief Generate a Sound structure and append it to the output blob */
<span class="lineNum">     162 </span><span class="lineNoCov">          0 : static int append_sound_cb(void *obj, void *arg, void *data, int flags)</span>
<span class="lineNum">     163 </span>            : {
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         struct ast_json *sounds_array = arg;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         char *filename = obj;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         struct ast_ari_sounds_list_args *args = data;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :         struct ast_json *sound_blob = create_sound_blob(filename, args);</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         if (!sound_blob) {</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     170 </span>            :         }
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :         ast_json_array_append(sounds_array, sound_blob);</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="174"><span class="lineNum">     174 </span>            : }</a>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineNoCov">          0 : void ast_ari_sounds_list(struct ast_variable *headers,</span>
<span class="lineNum">     177 </span>            :         struct ast_ari_sounds_list_args *args,
<a name="178"><span class="lineNum">     178 </span>            :         struct ast_ari_response *response)</a>
<span class="lineNum">     179 </span>            : {
<a name="180"><span class="lineNum">     180 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ao2_container *, sound_files, NULL, ao2_cleanup);</span></a>
<span class="lineNum">     181 </span>            :         struct ast_json *sounds_blob;
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         RAII_VAR(struct ast_media_index *, sounds_index, ast_sounds_get_index(), ao2_cleanup);</span>
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :         if (!sounds_index) {</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                 ast_ari_response_error(response, 500, &quot;Internal Error&quot;, &quot;Sounds index not available&quot;);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     187 </span>            :         }
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         sound_files = ast_media_get_media(sounds_index);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         if (!sound_files) {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                 ast_ari_response_error(response, 500, &quot;Internal Error&quot;, &quot;Allocation Error&quot;);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     193 </span>            :         }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         sounds_blob = ast_json_array_create();</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :         if (!sounds_blob) {</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                 ast_ari_response_error(response, 500, &quot;Internal Error&quot;, &quot;Allocation Error&quot;);</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     199 </span>            :         }
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         ao2_callback_data(sound_files, OBJ_NODATA, append_sound_cb, sounds_blob, args);</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         if (!ast_json_array_size(sounds_blob)) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                 ast_ari_response_error(response, 404, &quot;Not Found&quot;, &quot;No sounds found that matched the query&quot;);</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                 ast_json_unref(sounds_blob);</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     207 </span>            :         }
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :         ast_ari_response_ok(response, sounds_blob);</span>
<a name="210"><span class="lineNum">     210 </span>            : }</a>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 : void ast_ari_sounds_get(struct ast_variable *headers,</span>
<span class="lineNum">     213 </span>            :         struct ast_ari_sounds_get_args *args,
<span class="lineNum">     214 </span>            :         struct ast_ari_response *response)
<span class="lineNum">     215 </span>            : {
<span class="lineNum">     216 </span>            :         struct ast_json *sound_blob;
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :         sound_blob = create_sound_blob(args-&gt;sound_id, NULL);</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         if (!sound_blob) {</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 ast_ari_response_error(response, 404, &quot;Not Found&quot;, &quot;Sound not found&quot;);</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     222 </span>            :         }
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         ast_ari_response_ok(response, sound_blob);</span>
<span class="lineNum">     225 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
